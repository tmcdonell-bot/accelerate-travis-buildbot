<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE PatternGuards       #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Module      : Data.Array.Accelerate.LLVM.Native.Execute.Divide</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Copyright   : [2018..2019] The Accelerate Team</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- License     : BSD3</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Maintainer  : Trevor L. McDonell &lt;trevor.mcdonell@gmail.com&gt;</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Stability   : experimental</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- Portability : non-portable (GHC extensions)</span><span>
</span><a name="line-14"></a><span class="hs-comment">--</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Array.Accelerate.LLVM.Native.Execute.Divide</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>  </span><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#divideWork"><span class="hs-identifier hs-var">divideWork</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Array.Accelerate.Analysis.Match</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Array.Accelerate.Array.Sugar</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Bits</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Sequence</span><span>                                                </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Sequence</span><span>                                      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Seq</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Vector.Unboxed</span><span>                                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">U</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Vector.Unboxed.Mutable</span><span>                        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-comment">-- Divide the given multidimensional index range into a sequence of work pieces.</span><span>
</span><a name="line-33"></a><span class="hs-comment">-- Splits will be made on the outermost (left-most) index preferentially, so</span><span>
</span><a name="line-34"></a><span class="hs-comment">-- that spans are longest on the innermost dimension (because caches).</span><span>
</span><a name="line-35"></a><span class="hs-comment">--</span><span>
</span><a name="line-36"></a><span class="hs-comment">-- No dimension will be made smaller than the given minimum.</span><span>
</span><a name="line-37"></a><span class="hs-comment">--</span><span>
</span><a name="line-38"></a><span class="hs-comment">-- The number of subdivisions a hint (at most, it should generate a number of</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- pieces rounded up to the next power-of-two).</span><span>
</span><a name="line-40"></a><span class="hs-comment">--</span><span>
</span><a name="line-41"></a><span class="hs-comment">-- Full pieces will occur first in the resulting sequence, with smaller pieces</span><span>
</span><a name="line-42"></a><span class="hs-comment">-- at the end (suitable for work-stealing). Note that the pieces are not sorted</span><span>
</span><a name="line-43"></a><span class="hs-comment">-- according by size, and are ordered in the resulting sequence depending only</span><span>
</span><a name="line-44"></a><span class="hs-comment">-- on whether all dimensions are above the minimum threshold or not. The integer</span><span>
</span><a name="line-45"></a><span class="hs-comment">-- parameter to the apply action can be used to access the chunks linearly (for</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- example, this is useful when evaluating non-commutative operations).</span><span>
</span><a name="line-47"></a><span class="hs-comment">--</span><span>
</span><a name="line-48"></a><span class="hs-pragma">{-# SPECIALISE</span><span> </span><span class="hs-pragma">divideWork</span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">Int</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">Int</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">DIM0</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">DIM0</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">Int</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">DIM0</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">DIM0</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">a</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">Seq</span><span> </span><span class="hs-pragma">a</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-49"></a><span class="hs-pragma">{-# SPECIALISE</span><span> </span><span class="hs-pragma">divideWork</span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">Int</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">Int</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">DIM1</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">DIM1</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">Int</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">DIM1</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">DIM1</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">a</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">Seq</span><span> </span><span class="hs-pragma">a</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- {-# SPECIALISE divideWork :: Int -&gt; Int -&gt; DIM2 -&gt; DIM2 -&gt; (Int -&gt; DIM2 -&gt; DIM2 -&gt; a) -&gt; Seq a #-}</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- {-# SPECIALISE divideWork :: Int -&gt; Int -&gt; DIM3 -&gt; DIM3 -&gt; (Int -&gt; DIM3 -&gt; DIM3 -&gt; a) -&gt; Seq a #-}</span><span>
</span><a name="line-52"></a><span class="hs-identifier">divideWork</span><span>
</span><a name="line-53"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679193901"><a href="#local-6989586621679193901"><span class="hs-identifier">sh</span></a></a><span> </span><a name="local-6989586621679193902"><a href="#local-6989586621679193902"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Shape</span><span> </span><a href="#local-6989586621679193901"><span class="hs-identifier hs-type">sh</span></a><span>
</span><a name="line-54"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>                        </span><span class="hs-comment">-- #subdivisions (hint)</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>                        </span><span class="hs-comment">-- minimum size of a dimension (must be a power of two)</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679193901"><span class="hs-identifier hs-type">sh</span></a><span>                         </span><span class="hs-comment">-- start index (e.g. top-left)</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679193901"><span class="hs-identifier hs-type">sh</span></a><span>                         </span><span class="hs-comment">-- end index   (e.g. bottom-right)</span><span>
</span><a name="line-58"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679193901"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679193901"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679193902"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- action given start/end index range, and split number in the range [0..]</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><a href="#local-6989586621679193902"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-60"></a><a name="divideWork"><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#divideWork"><span class="hs-identifier">divideWork</span></a></a><span>
</span><a name="line-61"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Refl</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">matchShapeType</span><span> </span><span class="hs-glyph">@</span><span class="hs-identifier hs-type">DIM0</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679193901"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#divideWork0"><span class="hs-identifier hs-var">divideWork0</span></a><span>
</span><a name="line-62"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Refl</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">matchShapeType</span><span> </span><span class="hs-glyph">@</span><span class="hs-identifier hs-type">DIM1</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679193901"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#divideWork1"><span class="hs-identifier hs-var">divideWork1</span></a><span>
</span><a name="line-63"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                                     </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#divideWorkN"><span class="hs-identifier hs-var">divideWorkN</span></a><span>
</span><a name="line-64"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-comment">-- It is slightly faster to use lists instead of a Sequence here (though the</span><span>
</span><a name="line-66"></a><span>  </span><span class="hs-comment">-- difference is &lt;1us on 'divideWork empty (Z:.2000) nop 8 32'). However,</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-comment">-- later operations will benefit from more efficient append, etc.</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-identifier">divideWork0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIM0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIM0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIM0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIM0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679193900"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><a href="#local-6989586621679193900"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-70"></a><a name="divideWork0"><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#divideWork0"><span class="hs-identifier">divideWork0</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Z</span><span> </span><span class="hs-identifier hs-var">Z</span><span> </span><a name="local-6989586621679194166"><a href="#local-6989586621679194166"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Seq.singleton</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194166"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Z</span><span> </span><span class="hs-identifier hs-var">Z</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-identifier">divideWork1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIM1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIM1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIM1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIM1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679193899"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><a href="#local-6989586621679193899"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-73"></a><a name="divideWork1"><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#divideWork1"><span class="hs-identifier">divideWork1</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194167"><a href="#local-6989586621679194167"><span class="hs-identifier">pieces</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194168"><a href="#local-6989586621679194168"><span class="hs-identifier">minsize</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Z</span><span> </span><span class="hs-operator hs-var">:.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679194169"><a href="#local-6989586621679194169"><span class="hs-identifier">from</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Z</span><span> </span><span class="hs-operator hs-var">:.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679194170"><a href="#local-6989586621679194170"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679194171"><a href="#local-6989586621679194171"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-74"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-75"></a><span>      </span><a name="local-6989586621679194172"><a href="#local-6989586621679194172"><span class="hs-identifier">split</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194176"><a href="#local-6989586621679194176"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194177"><a href="#local-6989586621679194177"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194178"><a href="#local-6989586621679194178"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194179"><a href="#local-6989586621679194179"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194180"><a href="#local-6989586621679194180"><span class="hs-identifier">s</span></a></a><span>
</span><a name="line-76"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679194177"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679194176"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679194168"><span class="hs-identifier hs-var">minsize</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194178"><span class="hs-identifier hs-var">i</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194179"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194180"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">Seq.|&gt;</span><span> </span><a href="#local-6989586621679194173"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679194178"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679194176"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679194177"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194178"><span class="hs-identifier hs-var">i</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194179"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">Seq.|&gt;</span><span> </span><a href="#local-6989586621679194173"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679194178"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679194176"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679194177"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194180"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-79"></a><span>      </span><span class="hs-identifier">split</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194181"><a href="#local-6989586621679194181"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194182"><a href="#local-6989586621679194182"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194183"><a href="#local-6989586621679194183"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194184"><a href="#local-6989586621679194184"><span class="hs-identifier">i0</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194185"><a href="#local-6989586621679194185"><span class="hs-identifier">f0</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194186"><a href="#local-6989586621679194186"><span class="hs-identifier">s0</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-80"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#findSplitPoint1"><span class="hs-identifier hs-var">findSplitPoint1</span></a><span> </span><a href="#local-6989586621679194182"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679194183"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679194168"><span class="hs-identifier hs-var">minsize</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-81"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194184"><span class="hs-identifier hs-var">i0</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194185"><span class="hs-identifier hs-var">f0</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194186"><span class="hs-identifier hs-var">s0</span></a><span> </span><span class="hs-operator hs-var">Seq.|&gt;</span><span> </span><a href="#local-6989586621679194173"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679194184"><span class="hs-identifier hs-var">i0</span></a><span> </span><a href="#local-6989586621679194182"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679194183"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679194187"><a href="#local-6989586621679194187"><span class="hs-identifier">u'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679194188"><a href="#local-6989586621679194188"><span class="hs-identifier">v'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-83"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679194189"><a href="#local-6989586621679194189"><span class="hs-identifier">s'</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeShiftR</span><span> </span><a href="#local-6989586621679194181"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-84"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679194190"><a href="#local-6989586621679194190"><span class="hs-identifier">i1</span></a></a><span class="hs-special">,</span><a name="local-6989586621679194191"><a href="#local-6989586621679194191"><span class="hs-identifier">f1</span></a></a><span class="hs-special">,</span><a name="local-6989586621679194192"><a href="#local-6989586621679194192"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194172"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621679194189"><span class="hs-identifier hs-var">s'</span></a><span> </span><a href="#local-6989586621679194182"><span class="hs-identifier hs-var">u</span></a><span>  </span><a href="#local-6989586621679194188"><span class="hs-identifier hs-var">v'</span></a><span> </span><a href="#local-6989586621679194184"><span class="hs-identifier hs-var">i0</span></a><span> </span><a href="#local-6989586621679194185"><span class="hs-identifier hs-var">f0</span></a><span> </span><a href="#local-6989586621679194186"><span class="hs-identifier hs-var">s0</span></a><span>
</span><a name="line-85"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679194193"><a href="#local-6989586621679194193"><span class="hs-identifier">i2</span></a></a><span class="hs-special">,</span><a name="local-6989586621679194194"><a href="#local-6989586621679194194"><span class="hs-identifier">f2</span></a></a><span class="hs-special">,</span><a name="local-6989586621679194195"><a href="#local-6989586621679194195"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194172"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621679194189"><span class="hs-identifier hs-var">s'</span></a><span> </span><a href="#local-6989586621679194187"><span class="hs-identifier hs-var">u'</span></a><span> </span><a href="#local-6989586621679194183"><span class="hs-identifier hs-var">v</span></a><span>  </span><a href="#local-6989586621679194190"><span class="hs-identifier hs-var">i1</span></a><span> </span><a href="#local-6989586621679194191"><span class="hs-identifier hs-var">f1</span></a><span> </span><a href="#local-6989586621679194192"><span class="hs-identifier hs-var">s1</span></a><span>
</span><a name="line-86"></a><span>            </span><span class="hs-keyword">in</span><span>
</span><a name="line-87"></a><span>            </span><span class="hs-special">(</span><a href="#local-6989586621679194193"><span class="hs-identifier hs-var">i2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194194"><span class="hs-identifier hs-var">f2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194195"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span>      </span><a name="local-6989586621679194173"><a href="#local-6989586621679194173"><span class="hs-identifier">apply</span></a></a><span> </span><a name="local-6989586621679194196"><a href="#local-6989586621679194196"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679194197"><a href="#local-6989586621679194197"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621679194198"><a href="#local-6989586621679194198"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194171"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621679194196"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Z</span><span class="hs-operator hs-var">:.</span><a href="#local-6989586621679194197"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Z</span><span class="hs-operator hs-var">:.</span><a href="#local-6989586621679194198"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679194174"><a href="#local-6989586621679194174"><span class="hs-identifier">fs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679194175"><a href="#local-6989586621679194175"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194172"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621679194167"><span class="hs-identifier hs-var">pieces</span></a><span> </span><a href="#local-6989586621679194169"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621679194170"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Seq.empty</span><span> </span><span class="hs-identifier hs-var">Seq.empty</span><span>
</span><a name="line-91"></a><span>  </span><span class="hs-keyword">in</span><span>
</span><a name="line-92"></a><span>  </span><a href="#local-6989586621679194174"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-operator hs-var">Seq.&gt;&lt;</span><span> </span><a href="#local-6989586621679194175"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">findSplitPoint1</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-95"></a><span class="hs-identifier">findSplitPoint1</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-97"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-98"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><a name="findSplitPoint1"><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#findSplitPoint1"><span class="hs-identifier">findSplitPoint1</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194199"><a href="#local-6989586621679194199"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194200"><a href="#local-6989586621679194200"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194201"><a href="#local-6989586621679194201"><span class="hs-identifier">minsize</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-101"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679194202"><a href="#local-6989586621679194202"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194200"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679194199"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-102"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679194202"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679194201"><span class="hs-identifier hs-var">minsize</span></a><span>
</span><a name="line-103"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-keyword">else</span><span>
</span><a name="line-105"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679194203"><a href="#local-6989586621679194203"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeShiftR</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194202"><span class="hs-identifier hs-var">a</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-106"></a><span>          </span><a name="local-6989586621679194204"><a href="#local-6989586621679194204"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194201"><span class="hs-identifier hs-var">minsize</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-107"></a><span>          </span><a name="local-6989586621679194205"><a href="#local-6989586621679194205"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194203"><span class="hs-identifier hs-var">b</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679194204"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><span class="hs-identifier hs-var">complement</span><span> </span><a href="#local-6989586621679194204"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-108"></a><span>      </span><span class="hs-keyword">in</span><span>
</span><a name="line-109"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194205"><span class="hs-identifier hs-var">d</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679194199"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194200"><span class="hs-identifier hs-var">v</span></a><span class="hs-glyph">-</span><a href="#local-6989586621679194202"><span class="hs-identifier hs-var">a</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679194205"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-identifier">divideWorkN</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Shape</span><span> </span><a href="#local-6989586621679191986"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679191986"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679191986"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679191986"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679191986"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679191987"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Seq</span><span> </span><a href="#local-6989586621679191987"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-113"></a><a name="divideWorkN"><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#divideWorkN"><span class="hs-identifier">divideWorkN</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194206"><a href="#local-6989586621679194206"><span class="hs-identifier">pieces</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194207"><a href="#local-6989586621679194207"><span class="hs-identifier">minsize</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194208"><a href="#local-6989586621679194208"><span class="hs-identifier">from</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194209"><a href="#local-6989586621679194209"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621679194210"><a href="#local-6989586621679194210"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-114"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-115"></a><span>      </span><span class="hs-comment">-- Is it worth checking whether the piece is full? Doing so ensures that</span><span>
</span><a name="line-116"></a><span>      </span><span class="hs-comment">-- full pieces are assigned to threads first, with the non-full blocks</span><span>
</span><a name="line-117"></a><span>      </span><span class="hs-comment">-- being the ones at the end of the work queue to be stolen.</span><span>
</span><a name="line-118"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-119"></a><span>      </span><a name="local-6989586621679194211"><a href="#local-6989586621679194211"><span class="hs-identifier">split</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194215"><a href="#local-6989586621679194215"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194216"><a href="#local-6989586621679194216"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194217"><a href="#local-6989586621679194217"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194218"><a href="#local-6989586621679194218"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194219"><a href="#local-6989586621679194219"><span class="hs-identifier">s</span></a></a><span>
</span><a name="line-120"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">U.any</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679194207"><span class="hs-identifier hs-var">minsize</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">U.zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679194216"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679194215"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194217"><span class="hs-identifier hs-var">i</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194218"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194219"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">Seq.|&gt;</span><span> </span><a href="#local-6989586621679194212"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679194217"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679194215"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679194216"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194217"><span class="hs-identifier hs-var">i</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194218"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">Seq.|&gt;</span><span> </span><a href="#local-6989586621679194212"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679194217"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679194215"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679194216"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194219"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-123"></a><span>      </span><span class="hs-identifier">split</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194220"><a href="#local-6989586621679194220"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194221"><a href="#local-6989586621679194221"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194222"><a href="#local-6989586621679194222"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194223"><a href="#local-6989586621679194223"><span class="hs-identifier">i0</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194224"><a href="#local-6989586621679194224"><span class="hs-identifier">f0</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194225"><a href="#local-6989586621679194225"><span class="hs-identifier">s0</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-124"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#findSplitPointN"><span class="hs-identifier hs-var">findSplitPointN</span></a><span> </span><a href="#local-6989586621679194221"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679194222"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679194207"><span class="hs-identifier hs-var">minsize</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-125"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194223"><span class="hs-identifier hs-var">i0</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194224"><span class="hs-identifier hs-var">f0</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194225"><span class="hs-identifier hs-var">s0</span></a><span> </span><span class="hs-operator hs-var">Seq.|&gt;</span><span> </span><a href="#local-6989586621679194212"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679194223"><span class="hs-identifier hs-var">i0</span></a><span> </span><a href="#local-6989586621679194221"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679194222"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679194226"><a href="#local-6989586621679194226"><span class="hs-identifier">u'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679194227"><a href="#local-6989586621679194227"><span class="hs-identifier">v'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-127"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679194228"><a href="#local-6989586621679194228"><span class="hs-identifier">s'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeShiftR</span><span> </span><a href="#local-6989586621679194220"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-128"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679194229"><a href="#local-6989586621679194229"><span class="hs-identifier">i1</span></a></a><span class="hs-special">,</span><a name="local-6989586621679194230"><a href="#local-6989586621679194230"><span class="hs-identifier">f1</span></a></a><span class="hs-special">,</span><a name="local-6989586621679194231"><a href="#local-6989586621679194231"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194211"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621679194228"><span class="hs-identifier hs-var">s'</span></a><span> </span><a href="#local-6989586621679194221"><span class="hs-identifier hs-var">u</span></a><span>  </span><a href="#local-6989586621679194227"><span class="hs-identifier hs-var">v'</span></a><span> </span><a href="#local-6989586621679194223"><span class="hs-identifier hs-var">i0</span></a><span> </span><a href="#local-6989586621679194224"><span class="hs-identifier hs-var">f0</span></a><span> </span><a href="#local-6989586621679194225"><span class="hs-identifier hs-var">s0</span></a><span>
</span><a name="line-129"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679194232"><a href="#local-6989586621679194232"><span class="hs-identifier">i2</span></a></a><span class="hs-special">,</span><a name="local-6989586621679194233"><a href="#local-6989586621679194233"><span class="hs-identifier">f2</span></a></a><span class="hs-special">,</span><a name="local-6989586621679194234"><a href="#local-6989586621679194234"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194211"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621679194228"><span class="hs-identifier hs-var">s'</span></a><span> </span><a href="#local-6989586621679194226"><span class="hs-identifier hs-var">u'</span></a><span> </span><a href="#local-6989586621679194222"><span class="hs-identifier hs-var">v</span></a><span>  </span><a href="#local-6989586621679194229"><span class="hs-identifier hs-var">i1</span></a><span> </span><a href="#local-6989586621679194230"><span class="hs-identifier hs-var">f1</span></a><span> </span><a href="#local-6989586621679194231"><span class="hs-identifier hs-var">s1</span></a><span>
</span><a name="line-130"></a><span>            </span><span class="hs-keyword">in</span><span>
</span><a name="line-131"></a><span>            </span><span class="hs-special">(</span><a href="#local-6989586621679194232"><span class="hs-identifier hs-var">i2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194233"><span class="hs-identifier hs-var">f2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194234"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span>      </span><a name="local-6989586621679194212"><a href="#local-6989586621679194212"><span class="hs-identifier">apply</span></a></a><span> </span><a name="local-6989586621679194235"><a href="#local-6989586621679194235"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679194236"><a href="#local-6989586621679194236"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621679194237"><a href="#local-6989586621679194237"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194210"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621679194235"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#vecToShape"><span class="hs-identifier hs-var">vecToShape</span></a><span> </span><a href="#local-6989586621679194236"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#vecToShape"><span class="hs-identifier hs-var">vecToShape</span></a><span> </span><a href="#local-6989586621679194237"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679194213"><a href="#local-6989586621679194213"><span class="hs-identifier">fs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679194214"><a href="#local-6989586621679194214"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194211"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621679194206"><span class="hs-identifier hs-var">pieces</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#shapeToVec"><span class="hs-identifier hs-var">shapeToVec</span></a><span> </span><a href="#local-6989586621679194208"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#shapeToVec"><span class="hs-identifier hs-var">shapeToVec</span></a><span> </span><a href="#local-6989586621679194209"><span class="hs-identifier hs-var">to</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Seq.empty</span><span> </span><span class="hs-identifier hs-var">Seq.empty</span><span>
</span><a name="line-135"></a><span>  </span><span class="hs-keyword">in</span><span>
</span><a name="line-136"></a><span>  </span><a href="#local-6989586621679194213"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-operator hs-var">Seq.&gt;&lt;</span><span> </span><a href="#local-6989586621679194214"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-comment">-- Determine if and where to split the given index range. Returns new start and</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- end indices if found.</span><span>
</span><a name="line-141"></a><span class="hs-comment">--</span><span>
</span><a name="line-142"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">findSplitPointN</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-143"></a><span class="hs-identifier">findSplitPointN</span><span>
</span><a name="line-144"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">U.Vector</span><span> </span><span class="hs-identifier hs-type">Int</span><span>           </span><span class="hs-comment">-- start</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">U.Vector</span><span> </span><span class="hs-identifier hs-type">Int</span><span>           </span><span class="hs-comment">-- end</span><span>
</span><a name="line-146"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>                    </span><span class="hs-comment">-- minimum size of a dimension (must be power of 2)</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">U.Vector</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">U.Vector</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><a name="findSplitPointN"><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#findSplitPointN"><span class="hs-identifier">findSplitPointN</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194238"><a href="#local-6989586621679194238"><span class="hs-identifier">from</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194239"><a href="#local-6989586621679194239"><span class="hs-identifier">to</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679194240"><a href="#local-6989586621679194240"><span class="hs-identifier">minsize</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-149"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-150"></a><span>      </span><a name="local-6989586621679194241"><a href="#local-6989586621679194241"><span class="hs-identifier">mix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">U.ifoldr'</span><span> </span><a href="#local-6989586621679194242"><span class="hs-identifier hs-var">combine</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-151"></a><span>          </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">U.zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679194239"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621679194238"><span class="hs-identifier hs-var">from</span></a><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span>      </span><a name="local-6989586621679194242"><a href="#local-6989586621679194242"><span class="hs-identifier">combine</span></a></a><span> </span><a name="local-6989586621679194243"><a href="#local-6989586621679194243"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679194244"><a href="#local-6989586621679194244"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621679194245"><a href="#local-6989586621679194245"><span class="hs-identifier">old</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-154"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679194244"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679194240"><span class="hs-identifier hs-var">minsize</span></a><span>
</span><a name="line-155"></a><span>          </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679194245"><span class="hs-identifier hs-var">old</span></a><span>
</span><a name="line-156"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679194245"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-157"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194243"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><a href="#local-6989586621679194244"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679194246"><a href="#local-6989586621679194246"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679194244"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679194246"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-159"></a><span>                                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194243"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><a href="#local-6989586621679194244"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>                                 </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679194245"><span class="hs-identifier hs-var">old</span></a><span>
</span><a name="line-161"></a><span>  </span><span class="hs-keyword">in</span><span>
</span><a name="line-162"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679194241"><span class="hs-identifier hs-var">mix</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-164"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679194247"><a href="#local-6989586621679194247"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><a name="local-6989586621679194248"><a href="#local-6989586621679194248"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-165"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679194249"><a href="#local-6989586621679194249"><span class="hs-identifier">b</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeShiftR</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194248"><span class="hs-identifier hs-var">a</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span>    </span><span class="hs-comment">-- divide by 2 (rounded up)</span><span>
</span><a name="line-166"></a><span>          </span><a name="local-6989586621679194250"><a href="#local-6989586621679194250"><span class="hs-identifier">c</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194240"><span class="hs-identifier hs-var">minsize</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-167"></a><span>          </span><a name="local-6989586621679194251"><a href="#local-6989586621679194251"><span class="hs-identifier">d</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194249"><span class="hs-identifier hs-var">b</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679194250"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><span class="hs-identifier hs-var">complement</span><span> </span><a href="#local-6989586621679194250"><span class="hs-identifier hs-var">c</span></a><span>  </span><span class="hs-comment">-- round up to next multiple of chunk size</span><span>
</span><a name="line-168"></a><span>          </span><a name="local-6989586621679194252"><a href="#local-6989586621679194252"><span class="hs-identifier">e</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">U.unsafeIndex</span><span> </span><a href="#local-6989586621679194238"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621679194247"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-169"></a><span>          </span><a name="local-6989586621679194253"><a href="#local-6989586621679194253"><span class="hs-identifier">f</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">U.unsafeIndex</span><span> </span><a href="#local-6989586621679194239"><span class="hs-identifier hs-var">to</span></a><span>   </span><a href="#local-6989586621679194247"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-170"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-171"></a><span>          </span><a name="local-6989586621679194254"><a href="#local-6989586621679194254"><span class="hs-identifier">from'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">U.modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679194256"><a href="#local-6989586621679194256"><span class="hs-identifier">mv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">M.unsafeWrite</span><span> </span><a href="#local-6989586621679194256"><span class="hs-identifier hs-var">mv</span></a><span> </span><a href="#local-6989586621679194247"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194251"><span class="hs-identifier hs-var">d</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679194252"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><a href="#local-6989586621679194238"><span class="hs-identifier hs-var">from</span></a><span>
</span><a name="line-172"></a><span>          </span><a name="local-6989586621679194255"><a href="#local-6989586621679194255"><span class="hs-identifier">to'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">U.modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679194257"><a href="#local-6989586621679194257"><span class="hs-identifier">mv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">M.unsafeWrite</span><span> </span><a href="#local-6989586621679194257"><span class="hs-identifier hs-var">mv</span></a><span> </span><a href="#local-6989586621679194247"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194253"><span class="hs-identifier hs-var">f</span></a><span class="hs-glyph">-</span><a href="#local-6989586621679194248"><span class="hs-identifier hs-var">a</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679194251"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679194239"><span class="hs-identifier hs-var">to</span></a><span>
</span><a name="line-173"></a><span>      </span><span class="hs-keyword">in</span><span>
</span><a name="line-174"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679194254"><span class="hs-identifier hs-var">from'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679194255"><span class="hs-identifier hs-var">to'</span></a><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">vecToShape</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-177"></a><span class="hs-identifier">vecToShape</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Shape</span><span> </span><a href="#local-6989586621679191985"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">U.Vector</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679191985"><span class="hs-identifier hs-type">sh</span></a><span>
</span><a name="line-178"></a><a name="vecToShape"><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#vecToShape"><span class="hs-identifier">vecToShape</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToShape</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">U.toList</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">shapeToVec</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-181"></a><span class="hs-identifier">shapeToVec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679191984"><a href="#local-6989586621679191984"><span class="hs-identifier">sh</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Shape</span><span> </span><a href="#local-6989586621679191984"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679191984"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">U.Vector</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-182"></a><a name="shapeToVec"><a href="Data.Array.Accelerate.LLVM.Native.Execute.Divide.html#shapeToVec"><span class="hs-identifier">shapeToVec</span></a></a><span> </span><a name="local-6989586621679194258"><a href="#local-6989586621679194258"><span class="hs-identifier">sh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">U.fromListN</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rank</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679191984"><span class="hs-identifier hs-type">sh</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">shapeToList</span><span> </span><a href="#local-6989586621679194258"><span class="hs-identifier hs-var">sh</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a></pre></body></html>