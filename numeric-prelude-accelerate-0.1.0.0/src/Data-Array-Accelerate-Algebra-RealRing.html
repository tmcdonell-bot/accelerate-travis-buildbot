<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Data/Array/Accelerate/Algebra/RealRing.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts    #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE FlexibleInstances   #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE NoImplicitPrelude   #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-6"></a><span class='hs-comment'>-- |</span>
<a name="line-7"></a><span class='hs-comment'>-- Module      : Data.Array.Accelerate.Algebra.RealRing</span>
<a name="line-8"></a><span class='hs-comment'>-- Copyright   : [2016] Trevor L. McDonell</span>
<a name="line-9"></a><span class='hs-comment'>-- License     : BSD3</span>
<a name="line-10"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><span class='hs-comment'>-- Maintainer  : Trevor L. McDonell &lt;tmcdonell@cse.unsw.edu.au&gt;</span>
<a name="line-12"></a><span class='hs-comment'>-- Stability   : experimental</span>
<a name="line-13"></a><span class='hs-comment'>-- Portability : non-portable (GHC extensions)</span>
<a name="line-14"></a><span class='hs-comment'>--</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Algebra</span><span class='hs-varop'>.</span><span class='hs-conid'>RealRing</span> <span class='hs-layout'>(</span>
<a name="line-17"></a>
<a name="line-18"></a>  <span class='hs-keyword'>module</span> <span class='hs-conid'>RealRing</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Algebra</span><span class='hs-varop'>.</span><span class='hs-conid'>RealRing</span>                                             <span class='hs-keyword'>as</span> <span class='hs-conid'>RealRing</span> <span class='hs-layout'>(</span> <span class='hs-conid'>C</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Algebra</span><span class='hs-varop'>.</span><span class='hs-conid'>Additive</span>                       <span class='hs-keyword'>as</span> <span class='hs-conid'>Additive</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Algebra</span><span class='hs-varop'>.</span><span class='hs-conid'>ToInteger</span>                      <span class='hs-keyword'>as</span> <span class='hs-conid'>ToInteger</span>
<a name="line-25"></a><span class='hs-comment'>-- import Data.Array.Accelerate.Algebra.Ring                           as Ring</span>
<a name="line-26"></a><span class='hs-comment'>-- import Data.Array.Accelerate.Algebra.Absolute                       as Absolute</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span>                                        <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>*</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-comment'>-- import qualified Data.Array.Accelerate                              as A</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-comment'>-- import Prelude                                                      ( (.) )</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-comment'>-- import Data.Array.Accelerate                                        as A ( Exp, Elt, Ord, lift, (&gt;=*), (?) )</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-comment'>-- These are likely to fail as they depend on ToInteger.fromIntegral, which only</span>
<a name="line-36"></a><span class='hs-comment'>-- makes sense if GHC rewrite rules fire.</span>
<a name="line-37"></a><span class='hs-comment'>--</span>
<a name="line-38"></a><span class='hs-comment'>-- See [ToIntegral and rewrite rules].</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="instance%20RealRing.C%20(Exp%20Int)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>RealRing</span><span class='hs-varop'>.</span><span class='hs-conid'>C</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exp</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-41"></a>  <span class='hs-varid'>splitFraction</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>zero</span><span class='hs-layout'>)</span>
<a name="line-42"></a>  <span class='hs-varid'>fraction</span>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zero</span>
<a name="line-43"></a>  <span class='hs-varid'>floor</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span>
<a name="line-44"></a>  <span class='hs-varid'>ceiling</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span>
<a name="line-45"></a>  <span class='hs-varid'>round</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span>
<a name="line-46"></a>  <span class='hs-varid'>truncate</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="instance%20RealRing.C%20(Exp%20Float)%20--%20floor%20=%20A.floor%20--%20ceiling%20=%20A.ceiling%20--%20round%20=%20A.round%20--%20truncate%20=%20A.truncate%20instance%20RealRing.C%20(Exp%20Double)%20--%20div'%20n%20d%20=%20A.floor%20(n%20/%20d)%20--%20mod'%20n%20d%20=%20n%20-%20(fromIntegral%20f)%20*%20d%20--%20where%20--%20f%20::%20Exp%20Int64%20--%20f%20=%20div'%20n%20d%20--%20fastFraction%20::%20(Ord%20t,%20Ring.C%20(Exp%20t))%20=%3e%20Exp%20t%20-%3e%20Exp%20t%20--%20fastFraction%20x%20--%20=%20(minBound%20::%20Exp%20Int64)%20%3c=*%20x%20&&*%20x%20%3c=*%20(maxBound%20::%20Exp%20Int64)%20--%20?%20(%20n%20-%20A.toFloating%20f%20*%20d%20--%20,%20zero%20--%20error...%20--%20)%20--%20This%20is%20only%20valid%20when%20minBound%20%3c=%20x%20%3c=%20maxBound%20--%20fixFraction%20(x%20-%20trunc%20x)%20--%20fixFraction%20::%20(Ord%20t,%20Ring.C%20(Exp%20t))%20=%3e%20Exp%20t%20-%3e%20Exp%20t%20--%20fixFraction%20x%20=%20--%20x%20%3e=*%20zero%20?%20(%20x,%20x%20+%20one%20)%20--%20fastSplitFraction%20--%20::%20forall%20a%20b.%20(Ring.C%20(Exp%20b),%20Absolute.C%20(Exp%20a),%20Ord%20a,%20Elt%20a,%20Elt%20b)%20--%20=%3e%20(Exp%20a%20-%3e%20Exp%20Int)%20--%20-%3e%20(Exp%20Int%20-%3e%20Exp%20a)%20--%20-%3e%20Exp%20a%20--%20-%3e%20Exp%20(b,a)%20--%20fastSplitFraction%20trunc%20toFloat%20x%20=%20--%20let%20n%20=%20trunc%20x%20--%20f%20=%20x%20-%20toFloat%20n%20--%20i%20=%20fromIntegral%20n%20::%20Exp%20b%20--%20in%20--%20f%20%3e=*%20zero%20?%20(%20lift%20(i,%20f)%20::%20Exp%20(b,a)%20--%20,%20lift%20(i-one,%20f+one)%20::%20Exp%20(b,a)%20--%20)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>RealRing</span><span class='hs-varop'>.</span><span class='hs-conid'>C</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exp</span> <span class='hs-conid'>Float</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-comment'>--   floor           = A.floor</span>
<a name="line-50"></a><span class='hs-comment'>--   ceiling         = A.ceiling</span>
<a name="line-51"></a><span class='hs-comment'>--   round           = A.round</span>
<a name="line-52"></a><span class='hs-comment'>--   truncate        = A.truncate</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="instance%20RealRing.C%20(Exp%20Double)%20--%20div'%20n%20d%20=%20A.floor%20(n%20/%20d)%20--%20mod'%20n%20d%20=%20n%20-%20(fromIntegral%20f)%20*%20d%20--%20where%20--%20f%20::%20Exp%20Int64%20--%20f%20=%20div'%20n%20d%20--%20fastFraction%20::%20(Ord%20t,%20Ring.C%20(Exp%20t))%20=%3e%20Exp%20t%20-%3e%20Exp%20t%20--%20fastFraction%20x%20--%20=%20(minBound%20::%20Exp%20Int64)%20%3c=*%20x%20&&*%20x%20%3c=*%20(maxBound%20::%20Exp%20Int64)%20--%20?%20(%20n%20-%20A.toFloating%20f%20*%20d%20--%20,%20zero%20--%20error...%20--%20)%20--%20This%20is%20only%20valid%20when%20minBound%20%3c=%20x%20%3c=%20maxBound%20--%20fixFraction%20(x%20-%20trunc%20x)%20--%20fixFraction%20::%20(Ord%20t,%20Ring.C%20(Exp%20t))%20=%3e%20Exp%20t%20-%3e%20Exp%20t%20--%20fixFraction%20x%20=%20--%20x%20%3e=*%20zero%20?%20(%20x,%20x%20+%20one%20)%20--%20fastSplitFraction%20--%20::%20forall%20a%20b.%20(Ring.C%20(Exp%20b),%20Absolute.C%20(Exp%20a),%20Ord%20a,%20Elt%20a,%20Elt%20b)%20--%20=%3e%20(Exp%20a%20-%3e%20Exp%20Int)%20--%20-%3e%20(Exp%20Int%20-%3e%20Exp%20a)%20--%20-%3e%20Exp%20a%20--%20-%3e%20Exp%20(b,a)%20--%20fastSplitFraction%20trunc%20toFloat%20x%20=%20--%20let%20n%20=%20trunc%20x%20--%20f%20=%20x%20-%20toFloat%20n%20--%20i%20=%20fromIntegral%20n%20::%20Exp%20b%20--%20in%20--%20f%20%3e=*%20zero%20?%20(%20lift%20(i,%20f)%20::%20Exp%20(b,a)%20--%20,%20lift%20(i-one,%20f+one)%20::%20Exp%20(b,a)%20--%20)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>RealRing</span><span class='hs-varop'>.</span><span class='hs-conid'>C</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exp</span> <span class='hs-conid'>Double</span><span class='hs-layout'>)</span>
<a name="line-55"></a>
<a name="line-56"></a>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-comment'>-- div' n d = A.floor (n / d)</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-comment'>-- mod' n d = n - (fromIntegral f) * d</span>
<a name="line-61"></a><span class='hs-comment'>--   where</span>
<a name="line-62"></a><span class='hs-comment'>--       f :: Exp Int64</span>
<a name="line-63"></a><span class='hs-comment'>--       f = div' n d</span>
<a name="line-64"></a>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-comment'>-- fastFraction :: (Ord t, Ring.C (Exp t)) =&gt; Exp t -&gt; Exp t</span>
<a name="line-67"></a><span class='hs-comment'>-- fastFraction x</span>
<a name="line-68"></a><span class='hs-comment'>--   = (minBound :: Exp Int64) &lt;=* x &amp;&amp;* x &lt;=* (maxBound :: Exp Int64)</span>
<a name="line-69"></a><span class='hs-comment'>--   ? ( n - A.toFloating f * d</span>
<a name="line-70"></a><span class='hs-comment'>--     , zero -- error...</span>
<a name="line-71"></a><span class='hs-comment'>--     )</span>
<a name="line-72"></a>  <span class='hs-comment'>-- This is only valid when minBound &lt;= x &lt;= maxBound</span>
<a name="line-73"></a>  <span class='hs-comment'>-- fixFraction (x - trunc x)</span>
<a name="line-74"></a>
<a name="line-75"></a><span class='hs-comment'>-- fixFraction :: (Ord t, Ring.C (Exp t)) =&gt; Exp t -&gt; Exp t</span>
<a name="line-76"></a><span class='hs-comment'>-- fixFraction x =</span>
<a name="line-77"></a><span class='hs-comment'>--   x &gt;=* zero ? ( x, x + one )</span>
<a name="line-78"></a>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-comment'>-- fastSplitFraction</span>
<a name="line-81"></a><span class='hs-comment'>--     :: forall a b. (Ring.C (Exp b), Absolute.C (Exp a), Ord a, Elt a, Elt b)</span>
<a name="line-82"></a><span class='hs-comment'>--     =&gt; (Exp a -&gt; Exp Int)</span>
<a name="line-83"></a><span class='hs-comment'>--     -&gt; (Exp Int -&gt; Exp a)</span>
<a name="line-84"></a><span class='hs-comment'>--     -&gt; Exp a</span>
<a name="line-85"></a><span class='hs-comment'>--     -&gt; Exp (b,a)</span>
<a name="line-86"></a><span class='hs-comment'>-- fastSplitFraction trunc toFloat x =</span>
<a name="line-87"></a><span class='hs-comment'>--   let n = trunc x</span>
<a name="line-88"></a><span class='hs-comment'>--       f = x - toFloat n</span>
<a name="line-89"></a><span class='hs-comment'>--       i = fromIntegral n  :: Exp b</span>
<a name="line-90"></a><span class='hs-comment'>--   in</span>
<a name="line-91"></a><span class='hs-comment'>--   f &gt;=* zero ? ( lift (i,     f)     :: Exp (b,a)</span>
<a name="line-92"></a><span class='hs-comment'>--                , lift (i-one, f+one) :: Exp (b,a)</span>
<a name="line-93"></a><span class='hs-comment'>--                )</span>
<a name="line-94"></a>
</pre></body>
</html>
