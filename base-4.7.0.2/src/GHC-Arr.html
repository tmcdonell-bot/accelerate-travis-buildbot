<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Arr.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE Unsafe #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE NoImplicitPrelude, MagicHash, UnboxedTuples #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# OPTIONS_GHC -funbox-strict-fields #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# OPTIONS_HADDOCK hide #-}</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-7"></a><span class='hs-comment'>-- |</span>
<a name="line-8"></a><span class='hs-comment'>-- Module      :  GHC.Arr</span>
<a name="line-9"></a><span class='hs-comment'>-- Copyright   :  (c) The University of Glasgow, 1994-2000</span>
<a name="line-10"></a><span class='hs-comment'>-- License     :  see libraries/base/LICENSE</span>
<a name="line-11"></a><span class='hs-comment'>--</span>
<a name="line-12"></a><span class='hs-comment'>-- Maintainer  :  cvs-ghc@haskell.org</span>
<a name="line-13"></a><span class='hs-comment'>-- Stability   :  internal</span>
<a name="line-14"></a><span class='hs-comment'>-- Portability :  non-portable (GHC extensions)</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>-- GHC\'s array implementation.</span>
<a name="line-17"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Arr</span> <span class='hs-layout'>(</span>
<a name="line-21"></a>        <span class='hs-conid'>Ix</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Array</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>STArray</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-varid'>indexError</span><span class='hs-layout'>,</span> <span class='hs-varid'>hopelessIndexError</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>arrEleBottom</span><span class='hs-layout'>,</span> <span class='hs-varid'>array</span><span class='hs-layout'>,</span> <span class='hs-varid'>listArray</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>safeRangeSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>negRange</span><span class='hs-layout'>,</span> <span class='hs-varid'>safeIndex</span><span class='hs-layout'>,</span> <span class='hs-varid'>badSafeIndex</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>bounds</span><span class='hs-layout'>,</span> <span class='hs-varid'>numElements</span><span class='hs-layout'>,</span> <span class='hs-varid'>numElementsSTArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>indices</span><span class='hs-layout'>,</span> <span class='hs-varid'>elems</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>assocs</span><span class='hs-layout'>,</span> <span class='hs-varid'>accumArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>adjust</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>//</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>accum</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>amap</span><span class='hs-layout'>,</span> <span class='hs-varid'>ixmap</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-varid'>eqArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmpArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmpIntArray</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>newSTArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>boundsSTArray</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>readSTArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeSTArray</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>freezeSTArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>thawSTArray</span><span class='hs-layout'>,</span>
<a name="line-33"></a>
<a name="line-34"></a>        <span class='hs-comment'>-- * Unsafe operations</span>
<a name="line-35"></a>        <span class='hs-varid'>fill</span><span class='hs-layout'>,</span> <span class='hs-varid'>done</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>unsafeArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeArray'</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>lessSafeIndex</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeAt</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeReplace</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>unsafeAccumArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeAccumArray'</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeAccum</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>unsafeReadSTArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeWriteSTArray</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>unsafeFreezeSTArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeThawSTArray</span><span class='hs-layout'>,</span>
<a name="line-41"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Enum</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Num</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>ST</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Base</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Real</span><span class='hs-layout'>(</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Show</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-keyword'>infixl</span> <span class='hs-num'>9</span>  <span class='hs-varop'>!</span><span class='hs-layout'>,</span> <span class='hs-varop'>//</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-keyword'>default</span> <span class='hs-conid'>()</span>
</pre>\end{code}


%*********************************************************
%*                                                      *
\subsection{The @Ix@ class}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Ix"></a><span class='hs-comment'>-- | The 'Ix' class is used to map a contiguous subrange of values in</span>
<a name="line-2"></a><a name="Ix"></a><span class='hs-comment'>-- a type onto integers.  It is used primarily for array indexing</span>
<a name="line-3"></a><a name="Ix"></a><span class='hs-comment'>-- (see the array package).</span>
<a name="line-4"></a><a name="Ix"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><a name="Ix"></a><span class='hs-comment'>-- The first argument @(l,u)@ of each of these operations is a pair</span>
<a name="line-6"></a><a name="Ix"></a><span class='hs-comment'>-- specifying the lower and upper bounds of a contiguous subrange of values.</span>
<a name="line-7"></a><a name="Ix"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><a name="Ix"></a><span class='hs-comment'>-- An implementation is entitled to assume the following laws about these</span>
<a name="line-9"></a><a name="Ix"></a><span class='hs-comment'>-- operations:</span>
<a name="line-10"></a><a name="Ix"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><a name="Ix"></a><span class='hs-comment'>-- * @'inRange' (l,u) i == 'elem' i ('range' (l,u))@ @ @</span>
<a name="line-12"></a><a name="Ix"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><a name="Ix"></a><span class='hs-comment'>-- * @'range' (l,u) '!!' 'index' (l,u) i == i@, when @'inRange' (l,u) i@</span>
<a name="line-14"></a><a name="Ix"></a><span class='hs-comment'>--</span>
<a name="line-15"></a><a name="Ix"></a><span class='hs-comment'>-- * @'map' ('index' (l,u)) ('range' (l,u))) == [0..'rangeSize' (l,u)-1]@ @ @</span>
<a name="line-16"></a><a name="Ix"></a><span class='hs-comment'>--</span>
<a name="line-17"></a><a name="Ix"></a><span class='hs-comment'>-- * @'rangeSize' (l,u) == 'length' ('range' (l,u))@ @ @</span>
<a name="line-18"></a><a name="Ix"></a><span class='hs-comment'>--</span>
<a name="line-19"></a><a name="Ix"></a><span class='hs-comment'>-- Minimal complete instance: 'range', 'index' and 'inRange'.</span>
<a name="line-20"></a><a name="Ix"></a><span class='hs-comment'>--</span>
<a name="line-21"></a><a name="Ix"></a><span class='hs-keyword'>class</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-comment'>-- | The list of values in the subrange defined by a bounding pair.</span>
<a name="line-23"></a>    <span class='hs-varid'>range</span>               <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-24"></a>    <span class='hs-comment'>-- | The position of a subscript in the subrange.</span>
<a name="line-25"></a>    <span class='hs-varid'>index</span>               <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-26"></a>    <span class='hs-comment'>-- | Like 'index', but without checking that the value is in range.</span>
<a name="line-27"></a>    <span class='hs-varid'>unsafeIndex</span>         <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-28"></a>    <span class='hs-comment'>-- | Returns 'True' the given subscript lies in the range defined</span>
<a name="line-29"></a>    <span class='hs-comment'>-- the bounding pair.</span>
<a name="line-30"></a>    <span class='hs-varid'>inRange</span>             <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-31"></a>    <span class='hs-comment'>-- | The size of the subrange defined by a bounding pair.</span>
<a name="line-32"></a>    <span class='hs-varid'>rangeSize</span>           <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-33"></a>    <span class='hs-comment'>-- | like 'rangeSize', but without checking that the upper bound is</span>
<a name="line-34"></a>    <span class='hs-comment'>-- in range.</span>
<a name="line-35"></a>    <span class='hs-varid'>unsafeRangeSize</span>     <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-comment'>-- Must specify one of index, unsafeIndex</span>
<a name="line-38"></a>
<a name="line-39"></a>	<span class='hs-comment'>-- 'index' is typically over-ridden in instances, with essentially</span>
<a name="line-40"></a>	<span class='hs-comment'>-- the same code, but using indexError instead of hopelessIndexError</span>
<a name="line-41"></a>	<span class='hs-comment'>-- Reason: we have 'Show' at the instances</span>
<a name="line-42"></a>    <span class='hs-comment'>{-# INLINE index #-}</span>  <span class='hs-comment'>-- See Note [Inlining index]</span>
<a name="line-43"></a>    <span class='hs-varid'>index</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inRange</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span>
<a name="line-44"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hopelessIndexError</span>
<a name="line-45"></a>
<a name="line-46"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>index</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span>
<a name="line-47"></a>
<a name="line-48"></a>    <span class='hs-varid'>rangeSize</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-sel'>_l</span><span class='hs-layout'>,</span><span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inRange</span> <span class='hs-varid'>b</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>b</span> <span class='hs-varid'>h</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-49"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>        <span class='hs-comment'>-- This case is only here to</span>
<a name="line-50"></a>                                                <span class='hs-comment'>-- check for an empty range</span>
<a name="line-51"></a>        <span class='hs-comment'>-- NB: replacing (inRange b h) by (l &lt;= h) fails for</span>
<a name="line-52"></a>        <span class='hs-comment'>--     tuples.  E.g.  (1,2) &lt;= (2,1) but the range is empty</span>
<a name="line-53"></a>
<a name="line-54"></a>    <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-sel'>_l</span><span class='hs-layout'>,</span><span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>b</span> <span class='hs-varid'>h</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
</pre>\end{code}

Note that the following is NOT right
        rangeSize (l,h) | l <= h    = index b h + 1
                        | otherwise = 0

Because it might be the case that l<h, but the range
is nevertheless empty.  Consider
        ((1,2),(2,1))
Here l<h, but the second index ranges from 2..1 and
hence is empty

%*********************************************************
%*                                                      *
\subsection{Instances of @Ix@}
%*                                                      *
%*********************************************************

Note [Inlining index]
~~~~~~~~~~~~~~~~~~~~~
We inline the 'index' operation,

 * Partly because it generates much faster code
   (although bigger); see Trac #1216

 * Partly because it exposes the bounds checks to the simplifier which
   might help a big.

If you make a per-instance index method, you may consider inlining it.

Note [Double bounds-checking of index values]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When you index an array, a!x, there are two possible bounds checks we might make:

  (A) Check that (inRange (bounds a) x) holds.

      (A) is checked in the method for 'index'

  (B) Check that (index (bounds a) x) lies in the range 0..n,
      where n is the size of the underlying array

      (B) is checked in the top-level function (!), in safeIndex.

Of course it *should* be the case that (A) holds iff (B) holds, but that
is a property of the particular instances of index, bounds, and inRange,
so GHC cannot guarantee it.

 * If you do (A) and not (B), then you might get a seg-fault,
   by indexing at some bizarre location.  Trac #1610

 * If you do (B) but not (A), you may get no complaint when you index
   an array out of its semantic bounds.  Trac #2120

At various times we have had (A) and not (B), or (B) and not (A); both
led to complaints.  So now we implement *both* checks (Trac #2669).

For 1-d, 2-d, and 3-d arrays of Int we have specialised instances to avoid this.

Note [Out-of-bounds error messages]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The default method for 'index' generates hoplelessIndexError, because
Ix doesn't have Show as a superclass.  For particular base types we
can do better, so we override the default method for index.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- Abstract these errors from the relevant index functions so that</span>
<a name="line-2"></a><span class='hs-comment'>-- the guts of the function will be small enough to inline.</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="indexError"></a><span class='hs-comment'>{-# NOINLINE indexError #-}</span>
<a name="line-5"></a><span class='hs-definition'>indexError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-6"></a><span class='hs-definition'>indexError</span> <span class='hs-varid'>rng</span> <span class='hs-varid'>i</span> <span class='hs-varid'>tp</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-layout'>(</span><span class='hs-varid'>showString</span> <span class='hs-str'>"Ix{"</span> <span class='hs-varop'>.</span> <span class='hs-varid'>showString</span> <span class='hs-varid'>tp</span> <span class='hs-varop'>.</span> <span class='hs-varid'>showString</span> <span class='hs-str'>"}.index: Index "</span> <span class='hs-varop'>.</span>
<a name="line-8"></a>           <span class='hs-varid'>showParen</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>showsPrec</span> <span class='hs-num'>0</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span>
<a name="line-9"></a>           <span class='hs-varid'>showString</span> <span class='hs-str'>" out of range "</span> <span class='hs-varop'>$</span>
<a name="line-10"></a>           <span class='hs-varid'>showParen</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>showsPrec</span> <span class='hs-num'>0</span> <span class='hs-varid'>rng</span><span class='hs-layout'>)</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="hopelessIndexError"></a><span class='hs-definition'>hopelessIndexError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- Try to use 'indexError' instead!</span>
<a name="line-13"></a><span class='hs-definition'>hopelessIndexError</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Error in array index"</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-16"></a><span class='hs-keyword'>instance</span>  <span class='hs-conid'>Ix</span> <span class='hs-conid'>Char</span>  <span class='hs-keyword'>where</span>
<a name="line-17"></a>    <span class='hs-comment'>{-# INLINE range #-}</span>
<a name="line-18"></a>    <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-comment'>{-# INLINE unsafeIndex #-}</span>
<a name="line-21"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-sel'>_n</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>m</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-comment'>{-# INLINE index #-}</span>  <span class='hs-comment'>-- See Note [Out-of-bounds error messages]</span>
<a name="line-24"></a>                          <span class='hs-comment'>-- and Note [Inlining index]</span>
<a name="line-25"></a>    <span class='hs-varid'>index</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inRange</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span>
<a name="line-26"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>indexError</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-str'>"Char"</span>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>     <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>n</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-31"></a><span class='hs-keyword'>instance</span>  <span class='hs-conid'>Ix</span> <span class='hs-conid'>Int</span>  <span class='hs-keyword'>where</span>
<a name="line-32"></a>    <span class='hs-comment'>{-# INLINE range #-}</span>
<a name="line-33"></a>        <span class='hs-comment'>-- The INLINE stops the build in the RHS from getting inlined,</span>
<a name="line-34"></a>        <span class='hs-comment'>-- so that callers can fuse with the result of range</span>
<a name="line-35"></a>    <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-36"></a>
<a name="line-37"></a>    <span class='hs-comment'>{-# INLINE unsafeIndex #-}</span>
<a name="line-38"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-sel'>_n</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>m</span>
<a name="line-39"></a>
<a name="line-40"></a>    <span class='hs-comment'>{-# INLINE index #-}</span>  <span class='hs-comment'>-- See Note [Out-of-bounds error messages]</span>
<a name="line-41"></a>                          <span class='hs-comment'>-- and Note [Inlining index]</span>
<a name="line-42"></a>    <span class='hs-varid'>index</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inRange</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span>
<a name="line-43"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>indexError</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-str'>"Int"</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class='hs-comment'>{-# INLINE inRange #-}</span>
<a name="line-46"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isTrue</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span> <span class='hs-varop'>&lt;=#</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isTrue</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-varop'>&lt;=#</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ix</span> <span class='hs-conid'>Word</span> <span class='hs-keyword'>where</span>
<a name="line-49"></a>    <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-50"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-51"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>n</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-54"></a><span class='hs-keyword'>instance</span>  <span class='hs-conid'>Ix</span> <span class='hs-conid'>Integer</span>  <span class='hs-keyword'>where</span>
<a name="line-55"></a>    <span class='hs-comment'>{-# INLINE range #-}</span>
<a name="line-56"></a>    <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-57"></a>
<a name="line-58"></a>    <span class='hs-comment'>{-# INLINE unsafeIndex #-}</span>
<a name="line-59"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-sel'>_n</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromInteger</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a>    <span class='hs-comment'>{-# INLINE index #-}</span>  <span class='hs-comment'>-- See Note [Out-of-bounds error messages]</span>
<a name="line-62"></a>                          <span class='hs-comment'>-- and Note [Inlining index]</span>
<a name="line-63"></a>    <span class='hs-varid'>index</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inRange</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span>
<a name="line-64"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>indexError</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-str'>"Integer"</span>
<a name="line-65"></a>
<a name="line-66"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>     <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>n</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-69"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ix</span> <span class='hs-conid'>Bool</span> <span class='hs-keyword'>where</span> <span class='hs-comment'>-- as derived</span>
<a name="line-70"></a>    <span class='hs-comment'>{-# INLINE range #-}</span>
<a name="line-71"></a>    <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-72"></a>
<a name="line-73"></a>    <span class='hs-comment'>{-# INLINE unsafeIndex #-}</span>
<a name="line-74"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>l</span>
<a name="line-75"></a>
<a name="line-76"></a>    <span class='hs-comment'>{-# INLINE index #-}</span>  <span class='hs-comment'>-- See Note [Out-of-bounds error messages]</span>
<a name="line-77"></a>                          <span class='hs-comment'>-- and Note [Inlining index]</span>
<a name="line-78"></a>    <span class='hs-varid'>index</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inRange</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span>
<a name="line-79"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>indexError</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-str'>"Bool"</span>
<a name="line-80"></a>
<a name="line-81"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>u</span>
<a name="line-82"></a>
<a name="line-83"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-84"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ix</span> <span class='hs-conid'>Ordering</span> <span class='hs-keyword'>where</span> <span class='hs-comment'>-- as derived</span>
<a name="line-85"></a>    <span class='hs-comment'>{-# INLINE range #-}</span>
<a name="line-86"></a>    <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-87"></a>
<a name="line-88"></a>    <span class='hs-comment'>{-# INLINE unsafeIndex #-}</span>
<a name="line-89"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>l</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-comment'>{-# INLINE index #-}</span>  <span class='hs-comment'>-- See Note [Out-of-bounds error messages]</span>
<a name="line-92"></a>                          <span class='hs-comment'>-- and Note [Inlining index]</span>
<a name="line-93"></a>    <span class='hs-varid'>index</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inRange</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span>
<a name="line-94"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>indexError</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-str'>"Ordering"</span>
<a name="line-95"></a>
<a name="line-96"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varid'>u</span>
<a name="line-97"></a>
<a name="line-98"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-99"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ix</span> <span class='hs-conid'>()</span> <span class='hs-keyword'>where</span>
<a name="line-100"></a>    <span class='hs-comment'>{-# INLINE range #-}</span>
<a name="line-101"></a>    <span class='hs-varid'>range</span>   <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>()</span><span class='hs-keyglyph'>]</span>
<a name="line-102"></a>    <span class='hs-comment'>{-# INLINE unsafeIndex #-}</span>
<a name="line-103"></a>    <span class='hs-varid'>unsafeIndex</span>   <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-104"></a>    <span class='hs-comment'>{-# INLINE inRange #-}</span>
<a name="line-105"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class='hs-comment'>{-# INLINE index #-}</span>  <span class='hs-comment'>-- See Note [Inlining index]</span>
<a name="line-108"></a>    <span class='hs-varid'>index</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-111"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Ix</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span> <span class='hs-comment'>-- as derived</span>
<a name="line-112"></a>    <span class='hs-comment'>{-# SPECIALISE instance Ix (Int,Int) #-}</span>
<a name="line-113"></a>
<a name="line-114"></a>    <span class='hs-comment'>{-# INLINE range #-}</span>
<a name="line-115"></a>    <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-116"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>i2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-117"></a>
<a name="line-118"></a>    <span class='hs-comment'>{-# INLINE unsafeIndex #-}</span>
<a name="line-119"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-120"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-varid'>i1</span> <span class='hs-varop'>*</span> <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varid'>i2</span>
<a name="line-121"></a>
<a name="line-122"></a>    <span class='hs-comment'>{-# INLINE inRange #-}</span>
<a name="line-123"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-124"></a>      <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-varid'>i1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varid'>i2</span>
<a name="line-125"></a>
<a name="line-126"></a>    <span class='hs-comment'>-- Default method for index</span>
<a name="line-127"></a>
<a name="line-128"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-129"></a><span class='hs-keyword'>instance</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>a1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>a2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>a3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Ix</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span><span class='hs-layout'>,</span><span class='hs-varid'>a2</span><span class='hs-layout'>,</span><span class='hs-varid'>a3</span><span class='hs-layout'>)</span>  <span class='hs-keyword'>where</span>
<a name="line-130"></a>    <span class='hs-comment'>{-# SPECIALISE instance Ix (Int,Int,Int) #-}</span>
<a name="line-131"></a>
<a name="line-132"></a>    <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>l3</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-133"></a>        <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>,</span><span class='hs-varid'>i3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-134"></a>                      <span class='hs-varid'>i2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-135"></a>                      <span class='hs-varid'>i3</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-136"></a>
<a name="line-137"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>l3</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>,</span><span class='hs-varid'>i3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-138"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span> <span class='hs-varid'>i3</span> <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span>
<a name="line-139"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varid'>i2</span> <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span>
<a name="line-140"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-varid'>i1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-141"></a>
<a name="line-142"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>l3</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>,</span><span class='hs-varid'>i3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-143"></a>      <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-varid'>i1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varid'>i2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-144"></a>      <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span> <span class='hs-varid'>i3</span>
<a name="line-145"></a>
<a name="line-146"></a>    <span class='hs-comment'>-- Default method for index</span>
<a name="line-147"></a>
<a name="line-148"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-149"></a><span class='hs-keyword'>instance</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>a1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>a2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>a3</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>a4</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Ix</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span><span class='hs-layout'>,</span><span class='hs-varid'>a2</span><span class='hs-layout'>,</span><span class='hs-varid'>a3</span><span class='hs-layout'>,</span><span class='hs-varid'>a4</span><span class='hs-layout'>)</span>  <span class='hs-keyword'>where</span>
<a name="line-150"></a>    <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>l4</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-151"></a>      <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>,</span><span class='hs-varid'>i3</span><span class='hs-layout'>,</span><span class='hs-varid'>i4</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-152"></a>                       <span class='hs-varid'>i2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-153"></a>                       <span class='hs-varid'>i3</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-154"></a>                       <span class='hs-varid'>i4</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-155"></a>
<a name="line-156"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>l4</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>,</span><span class='hs-varid'>i3</span><span class='hs-layout'>,</span><span class='hs-varid'>i4</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-157"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span> <span class='hs-varid'>i4</span> <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span>
<a name="line-158"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span> <span class='hs-varid'>i3</span> <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span>
<a name="line-159"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varid'>i2</span> <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span>
<a name="line-160"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-varid'>i1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-161"></a>
<a name="line-162"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>l4</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>,</span><span class='hs-varid'>i3</span><span class='hs-layout'>,</span><span class='hs-varid'>i4</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-163"></a>      <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-varid'>i1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varid'>i2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-164"></a>      <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span> <span class='hs-varid'>i3</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span> <span class='hs-varid'>i4</span>
<a name="line-165"></a>
<a name="line-166"></a>    <span class='hs-comment'>-- Default method for index</span>
<a name="line-167"></a>
<a name="line-168"></a><span class='hs-keyword'>instance</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>a1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>a2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>a3</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>a4</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>a5</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Ix</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span><span class='hs-layout'>,</span><span class='hs-varid'>a2</span><span class='hs-layout'>,</span><span class='hs-varid'>a3</span><span class='hs-layout'>,</span><span class='hs-varid'>a4</span><span class='hs-layout'>,</span><span class='hs-varid'>a5</span><span class='hs-layout'>)</span>  <span class='hs-keyword'>where</span>
<a name="line-169"></a>    <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>l5</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>,</span><span class='hs-varid'>u5</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-170"></a>      <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>,</span><span class='hs-varid'>i3</span><span class='hs-layout'>,</span><span class='hs-varid'>i4</span><span class='hs-layout'>,</span><span class='hs-varid'>i5</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-171"></a>                          <span class='hs-varid'>i2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-172"></a>                          <span class='hs-varid'>i3</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-173"></a>                          <span class='hs-varid'>i4</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-174"></a>                          <span class='hs-varid'>i5</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l5</span><span class='hs-layout'>,</span><span class='hs-varid'>u5</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-175"></a>
<a name="line-176"></a>    <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>l5</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>,</span><span class='hs-varid'>u5</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>,</span><span class='hs-varid'>i3</span><span class='hs-layout'>,</span><span class='hs-varid'>i4</span><span class='hs-layout'>,</span><span class='hs-varid'>i5</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-177"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l5</span><span class='hs-layout'>,</span><span class='hs-varid'>u5</span><span class='hs-layout'>)</span> <span class='hs-varid'>i5</span> <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l5</span><span class='hs-layout'>,</span><span class='hs-varid'>u5</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span>
<a name="line-178"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span> <span class='hs-varid'>i4</span> <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span>
<a name="line-179"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span> <span class='hs-varid'>i3</span> <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span>
<a name="line-180"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varid'>i2</span> <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span>
<a name="line-181"></a>      <span class='hs-varid'>unsafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-varid'>i1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-182"></a>
<a name="line-183"></a>    <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>l5</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>u1</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>,</span><span class='hs-varid'>u5</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>i1</span><span class='hs-layout'>,</span><span class='hs-varid'>i2</span><span class='hs-layout'>,</span><span class='hs-varid'>i3</span><span class='hs-layout'>,</span><span class='hs-varid'>i4</span><span class='hs-layout'>,</span><span class='hs-varid'>i5</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-184"></a>      <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span><span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-varid'>i1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span><span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-varid'>i2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-185"></a>      <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l3</span><span class='hs-layout'>,</span><span class='hs-varid'>u3</span><span class='hs-layout'>)</span> <span class='hs-varid'>i3</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l4</span><span class='hs-layout'>,</span><span class='hs-varid'>u4</span><span class='hs-layout'>)</span> <span class='hs-varid'>i4</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-186"></a>      <span class='hs-varid'>inRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>l5</span><span class='hs-layout'>,</span><span class='hs-varid'>u5</span><span class='hs-layout'>)</span> <span class='hs-varid'>i5</span>
<a name="line-187"></a>
<a name="line-188"></a>    <span class='hs-comment'>-- Default method for index</span>
</pre>\end{code}

%*********************************************************
%*                                                      *
\subsection{The @Array@ types}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Array"></a><span class='hs-comment'>-- | The type of immutable non-strict (boxed) arrays</span>
<a name="line-2"></a><a name="Array"></a><span class='hs-comment'>-- with indices in @i@ and elements in @e@.</span>
<a name="line-3"></a><a name="Array"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-4"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Array</span> <span class='hs-varop'>!</span><span class='hs-varid'>i</span>         <span class='hs-comment'>-- the lower bound, l</span>
<a name="line-5"></a>                 <span class='hs-varop'>!</span><span class='hs-varid'>i</span>         <span class='hs-comment'>-- the upper bound, u</span>
<a name="line-6"></a>                 <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>       <span class='hs-comment'>-- a cache of (rangeSize (l,u))</span>
<a name="line-7"></a>                            <span class='hs-comment'>-- used to make sure an index is</span>
<a name="line-8"></a>                            <span class='hs-comment'>-- really in range</span>
<a name="line-9"></a>                 <span class='hs-layout'>(</span><span class='hs-conid'>Array</span><span class='hs-cpp'>#</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- The actual elements</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="STArray"></a><span class='hs-comment'>-- | Mutable, boxed, non-strict arrays in the 'ST' monad.  The type</span>
<a name="line-12"></a><a name="STArray"></a><span class='hs-comment'>-- arguments are as follows:</span>
<a name="line-13"></a><a name="STArray"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><a name="STArray"></a><span class='hs-comment'>--  * @s@: the state variable argument for the 'ST' type</span>
<a name="line-15"></a><a name="STArray"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><a name="STArray"></a><span class='hs-comment'>--  * @i@: the index type of the array (should be an instance of 'Ix')</span>
<a name="line-17"></a><a name="STArray"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><a name="STArray"></a><span class='hs-comment'>--  * @e@: the element type of the array.</span>
<a name="line-19"></a><a name="STArray"></a><span class='hs-comment'>--</span>
<a name="line-20"></a><a name="STArray"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-21"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>STArray</span> <span class='hs-varop'>!</span><span class='hs-varid'>i</span>                  <span class='hs-comment'>-- the lower bound, l</span>
<a name="line-22"></a>                   <span class='hs-varop'>!</span><span class='hs-varid'>i</span>                  <span class='hs-comment'>-- the upper bound, u</span>
<a name="line-23"></a>                   <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>                <span class='hs-comment'>-- a cache of (rangeSize (l,u))</span>
<a name="line-24"></a>                                       <span class='hs-comment'>-- used to make sure an index is</span>
<a name="line-25"></a>                                       <span class='hs-comment'>-- really in range</span>
<a name="line-26"></a>                   <span class='hs-layout'>(</span><span class='hs-conid'>MutableArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- The actual elements</span>
<a name="line-27"></a>        <span class='hs-comment'>-- No Ix context for STArray.  They are stupid,</span>
<a name="line-28"></a>        <span class='hs-comment'>-- and force an Ix context on the equality instance.</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-comment'>-- Just pointer equality on mutable arrays:</span>
<a name="line-31"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-32"></a>    <span class='hs-conid'>STArray</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arr1</span><span class='hs-cpp'>#</span> <span class='hs-varop'>==</span> <span class='hs-conid'>STArray</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arr2</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>=</span>
<a name="line-33"></a>        <span class='hs-varid'>isTrue</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-varid'>sameMutableArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>arr1</span><span class='hs-cpp'>#</span> <span class='hs-varid'>arr2</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
</pre>\end{code}


%*********************************************************
%*                                                      *
\subsection{Operations on immutable arrays}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="arrEleBottom"></a><span class='hs-comment'>{-# NOINLINE arrEleBottom #-}</span>
<a name="line-2"></a><span class='hs-definition'>arrEleBottom</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span>
<a name="line-3"></a><span class='hs-definition'>arrEleBottom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"(Array.!): undefined array element"</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="array"></a><span class='hs-comment'>-- | Construct an array with the specified bounds and containing values</span>
<a name="line-6"></a><span class='hs-comment'>-- for given indices within these bounds.</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- The array is undefined (i.e. bottom) if any index in the list is</span>
<a name="line-9"></a><span class='hs-comment'>-- out of bounds.  The Haskell 2010 Report further specifies that if any</span>
<a name="line-10"></a><span class='hs-comment'>-- two associations in the list have the same index, the value at that</span>
<a name="line-11"></a><span class='hs-comment'>-- index is undefined (i.e. bottom).  However in GHC's implementation,</span>
<a name="line-12"></a><span class='hs-comment'>-- the value at such an index is the value part of the last association</span>
<a name="line-13"></a><span class='hs-comment'>-- with that index in the list.</span>
<a name="line-14"></a><span class='hs-comment'>--</span>
<a name="line-15"></a><span class='hs-comment'>-- Because the indices must be checked for these errors, 'array' is</span>
<a name="line-16"></a><span class='hs-comment'>-- strict in the bounds argument and in the indices of the association</span>
<a name="line-17"></a><span class='hs-comment'>-- list, but non-strict in the values.  Thus, recurrences such as the</span>
<a name="line-18"></a><span class='hs-comment'>-- following are possible:</span>
<a name="line-19"></a><span class='hs-comment'>--</span>
<a name="line-20"></a><span class='hs-comment'>-- &gt; a = array (1,100) ((1,1) : [(i, i * a!(i-1)) | i &lt;- [2..100]])</span>
<a name="line-21"></a><span class='hs-comment'>--</span>
<a name="line-22"></a><span class='hs-comment'>-- Not every index within the bounds of the array need appear in the</span>
<a name="line-23"></a><span class='hs-comment'>-- association list, but the values associated with indices that do not</span>
<a name="line-24"></a><span class='hs-comment'>-- appear will be undefined (i.e. bottom).</span>
<a name="line-25"></a><span class='hs-comment'>--</span>
<a name="line-26"></a><span class='hs-comment'>-- If, in any dimension, the lower bound is greater than the upper bound,</span>
<a name="line-27"></a><span class='hs-comment'>-- then the array is legal, but empty.  Indexing an empty array always</span>
<a name="line-28"></a><span class='hs-comment'>-- gives an array-bounds error, but 'bounds' still yields the bounds</span>
<a name="line-29"></a><span class='hs-comment'>-- with which the array was constructed.</span>
<a name="line-30"></a><span class='hs-comment'>{-# INLINE array #-}</span>
<a name="line-31"></a><span class='hs-definition'>array</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span>
<a name="line-32"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- ^ a pair of /bounds/, each of the index type</span>
<a name="line-33"></a>                        <span class='hs-comment'>-- of the array.  These bounds are the lowest and</span>
<a name="line-34"></a>                        <span class='hs-comment'>-- highest indices in the array, in that order.</span>
<a name="line-35"></a>                        <span class='hs-comment'>-- For example, a one-origin vector of length</span>
<a name="line-36"></a>                        <span class='hs-comment'>-- '10' has bounds '(1,10)', and a one-origin '10'</span>
<a name="line-37"></a>                        <span class='hs-comment'>-- by '10' matrix has bounds '((1,1),(10,10))'.</span>
<a name="line-38"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- ^ a list of /associations/ of the form</span>
<a name="line-39"></a>                        <span class='hs-comment'>-- (/index/, /value/).  Typically, this list will</span>
<a name="line-40"></a>                        <span class='hs-comment'>-- be expressed as a comprehension.  An</span>
<a name="line-41"></a>                        <span class='hs-comment'>-- association '(i, x)' defines the value of</span>
<a name="line-42"></a>                        <span class='hs-comment'>-- the array at index 'i' to be 'x'.</span>
<a name="line-43"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-44"></a><span class='hs-definition'>array</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span>
<a name="line-45"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-46"></a>      <span class='hs-keyword'>in</span> <span class='hs-varid'>unsafeArray'</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-47"></a>                      <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>safeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ies</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="unsafeArray"></a><span class='hs-comment'>{-# INLINE unsafeArray #-}</span>
<a name="line-50"></a><span class='hs-definition'>unsafeArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-51"></a><span class='hs-definition'>unsafeArray</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ies</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeArray'</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>rangeSize</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="unsafeArray'"></a><span class='hs-comment'>{-# INLINE unsafeArray' #-}</span>
<a name="line-54"></a><span class='hs-definition'>unsafeArray'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-55"></a><span class='hs-definition'>unsafeArray'</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runST</span> <span class='hs-layout'>(</span><span class='hs-conid'>ST</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-56"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>newArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span> <span class='hs-varid'>arrEleBottom</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span>
<a name="line-57"></a>        <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-58"></a>            <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fill</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>done</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="fill"></a><span class='hs-comment'>{-# INLINE fill #-}</span>
<a name="line-61"></a><span class='hs-definition'>fill</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MutableArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>STRep</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>STRep</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span>
<a name="line-62"></a><span class='hs-comment'>-- NB: put the \s after the "=" so that 'fill'</span>
<a name="line-63"></a><span class='hs-comment'>--     inlines when applied to three args</span>
<a name="line-64"></a><span class='hs-definition'>fill</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>next</span>
<a name="line-65"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>writeArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>e</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span>
<a name="line-66"></a>             <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>next</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="done"></a><span class='hs-comment'>{-# INLINE done #-}</span>
<a name="line-69"></a><span class='hs-definition'>done</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MutableArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>STRep</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-comment'>-- See NB on 'fill'</span>
<a name="line-71"></a><span class='hs-definition'>done</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>unsafeFreezeArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span>
<a name="line-73"></a>              <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-74"></a>
<a name="line-75"></a><span class='hs-comment'>-- This is inefficient and I'm not sure why:</span>
<a name="line-76"></a><span class='hs-comment'>-- listArray (l,u) es = unsafeArray (l,u) (zip [0 .. rangeSize (l,u) - 1] es)</span>
<a name="line-77"></a><span class='hs-comment'>-- The code below is better. It still doesn't enable foldr/build</span>
<a name="line-78"></a><span class='hs-comment'>-- transformation on the list of elements; I guess it's impossible</span>
<a name="line-79"></a><span class='hs-comment'>-- using mechanisms currently available.</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="listArray"></a><span class='hs-comment'>-- | Construct an array from a pair of bounds and a list of values in</span>
<a name="line-82"></a><span class='hs-comment'>-- index order.</span>
<a name="line-83"></a><span class='hs-comment'>{-# INLINE listArray #-}</span>
<a name="line-84"></a><span class='hs-definition'>listArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>e</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-85"></a><span class='hs-definition'>listArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runST</span> <span class='hs-layout'>(</span><span class='hs-conid'>ST</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-86"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>safeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span>            <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-87"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>newArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span> <span class='hs-varid'>arrEleBottom</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span>  <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-88"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>fillFromList</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTrue</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varop'>==#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span>
<a name="line-89"></a>                               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-90"></a>            <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span>
<a name="line-91"></a>            <span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-varid'>ys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>writeArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>y</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s4</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-92"></a>                    <span class='hs-varid'>fillFromList</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varop'>+#</span> <span class='hs-num'>1</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>ys</span> <span class='hs-varid'>s4</span><span class='hs-cpp'>#</span> <span class='hs-layout'>}</span> <span class='hs-keyword'>in</span>
<a name="line-93"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>fillFromList</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>es</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span>         <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-94"></a>    <span class='hs-varid'>done</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="!"></a><span class='hs-comment'>-- | The value at the given index in an array.</span>
<a name="line-97"></a><span class='hs-comment'>{-# INLINE (!) #-}</span>
<a name="line-98"></a><span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span>
<a name="line-99"></a><a name="arr"></a><span class='hs-definition'>arr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeAt</span> <span class='hs-varid'>arr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>safeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>i</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="safeRangeSize"></a><span class='hs-comment'>{-# INLINE safeRangeSize #-}</span>
<a name="line-102"></a><span class='hs-definition'>safeRangeSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-103"></a><span class='hs-definition'>safeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-104"></a>                      <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>r</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>negRange</span>
<a name="line-105"></a>                                  <span class='hs-keyword'>else</span> <span class='hs-varid'>r</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="negRange"></a><span class='hs-comment'>-- Don't inline this error message everywhere!!</span>
<a name="line-108"></a><span class='hs-definition'>negRange</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>	  <span class='hs-comment'>-- Uninformative, but Ix does not provide Show</span>
<a name="line-109"></a><span class='hs-definition'>negRange</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Negative range size"</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="safeIndex"></a><span class='hs-comment'>{-# INLINE[1] safeIndex #-}</span>
<a name="line-112"></a><span class='hs-comment'>-- See Note [Double bounds-checking of index values]</span>
<a name="line-113"></a><span class='hs-comment'>-- Inline *after* (!) so the rules can fire</span>
<a name="line-114"></a><span class='hs-definition'>safeIndex</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-115"></a><span class='hs-definition'>safeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>i'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>index</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-116"></a>                      <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>i'</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i'</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-117"></a>                         <span class='hs-keyword'>then</span> <span class='hs-varid'>i'</span>
<a name="line-118"></a>                         <span class='hs-keyword'>else</span> <span class='hs-varid'>badSafeIndex</span> <span class='hs-varid'>i'</span> <span class='hs-varid'>n</span>
<a name="line-119"></a>
<a name="line-120"></a><span class='hs-comment'>-- See Note [Double bounds-checking of index values]</span>
<a name="line-121"></a><span class='hs-comment'>{-# RULES
<a name="line-122"></a>"safeIndex/I"       safeIndex = lessSafeIndex :: (Int,Int) -&gt; Int -&gt; Int -&gt; Int
<a name="line-123"></a>"safeIndex/(I,I)"   safeIndex = lessSafeIndex :: ((Int,Int),(Int,Int)) -&gt; Int -&gt; (Int,Int) -&gt; Int
<a name="line-124"></a>"safeIndex/(I,I,I)" safeIndex = lessSafeIndex :: ((Int,Int,Int),(Int,Int,Int)) -&gt; Int -&gt; (Int,Int,Int) -&gt; Int
<a name="line-125"></a>  #-}</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="lessSafeIndex"></a><span class='hs-definition'>lessSafeIndex</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-128"></a><span class='hs-comment'>-- See Note [Double bounds-checking of index values]</span>
<a name="line-129"></a><span class='hs-comment'>-- Do only (A), the semantic check</span>
<a name="line-130"></a><span class='hs-definition'>lessSafeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>index</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="badSafeIndex"></a><span class='hs-comment'>-- Don't inline this long error message everywhere!!</span>
<a name="line-133"></a><span class='hs-definition'>badSafeIndex</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-134"></a><span class='hs-definition'>badSafeIndex</span> <span class='hs-varid'>i'</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-layout'>(</span><span class='hs-str'>"Error in array index; "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>i'</span> <span class='hs-varop'>++</span>
<a name="line-135"></a>                        <span class='hs-str'>" not in range [0.."</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="unsafeAt"></a><span class='hs-comment'>{-# INLINE unsafeAt #-}</span>
<a name="line-138"></a><span class='hs-definition'>unsafeAt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span>
<a name="line-139"></a><span class='hs-definition'>unsafeAt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-140"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>indexArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>e</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span>
<a name="line-141"></a>
<a name="line-142"></a><a name="bounds"></a><span class='hs-comment'>-- | The bounds with which an array was constructed.</span>
<a name="line-143"></a><span class='hs-comment'>{-# INLINE bounds #-}</span>
<a name="line-144"></a><span class='hs-definition'>bounds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-145"></a><span class='hs-definition'>bounds</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-146"></a>
<a name="line-147"></a><a name="numElements"></a><span class='hs-comment'>-- | The number of elements in the array.</span>
<a name="line-148"></a><span class='hs-comment'>{-# INLINE numElements #-}</span>
<a name="line-149"></a><span class='hs-definition'>numElements</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-150"></a><span class='hs-definition'>numElements</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="indices"></a><span class='hs-comment'>-- | The list of indices of an array in ascending order.</span>
<a name="line-153"></a><span class='hs-comment'>{-# INLINE indices #-}</span>
<a name="line-154"></a><span class='hs-definition'>indices</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>i</span><span class='hs-keyglyph'>]</span>
<a name="line-155"></a><span class='hs-definition'>indices</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-156"></a>
<a name="line-157"></a><a name="elems"></a><span class='hs-comment'>-- | The list of elements of an array in index order.</span>
<a name="line-158"></a><span class='hs-comment'>{-# INLINE elems #-}</span>
<a name="line-159"></a><span class='hs-definition'>elems</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>e</span><span class='hs-keyglyph'>]</span>
<a name="line-160"></a><span class='hs-definition'>elems</span> <span class='hs-varid'>arr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-161"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>unsafeAt</span> <span class='hs-varid'>arr</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="assocs"></a><span class='hs-comment'>-- | The list of associations of an array in index order.</span>
<a name="line-164"></a><span class='hs-comment'>{-# INLINE assocs #-}</span>
<a name="line-165"></a><span class='hs-definition'>assocs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-166"></a><span class='hs-definition'>assocs</span> <span class='hs-varid'>arr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-167"></a>    <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>arr</span> <span class='hs-varop'>!</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="accumArray"></a><span class='hs-comment'>-- | The 'accumArray' function deals with repeated indices in the association</span>
<a name="line-170"></a><span class='hs-comment'>-- list using an /accumulating function/ which combines the values of</span>
<a name="line-171"></a><span class='hs-comment'>-- associations with the same index.</span>
<a name="line-172"></a><span class='hs-comment'>-- For example, given a list of values of some index type, @hist@</span>
<a name="line-173"></a><span class='hs-comment'>-- produces a histogram of the number of occurrences of each index within</span>
<a name="line-174"></a><span class='hs-comment'>-- a specified range:</span>
<a name="line-175"></a><span class='hs-comment'>--</span>
<a name="line-176"></a><span class='hs-comment'>-- &gt; hist :: (Ix a, Num b) =&gt; (a,a) -&gt; [a] -&gt; Array a b</span>
<a name="line-177"></a><span class='hs-comment'>-- &gt; hist bnds is = accumArray (+) 0 bnds [(i, 1) | i&lt;-is, inRange bnds i]</span>
<a name="line-178"></a><span class='hs-comment'>--</span>
<a name="line-179"></a><span class='hs-comment'>-- If the accumulating function is strict, then 'accumArray' is strict in</span>
<a name="line-180"></a><span class='hs-comment'>-- the values, as well as the indices, in the association list.  Thus,</span>
<a name="line-181"></a><span class='hs-comment'>-- unlike ordinary arrays built with 'array', accumulated arrays should</span>
<a name="line-182"></a><span class='hs-comment'>-- not in general be recursive.</span>
<a name="line-183"></a><span class='hs-comment'>{-# INLINE accumArray #-}</span>
<a name="line-184"></a><span class='hs-definition'>accumArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span>
<a name="line-185"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- ^ accumulating function</span>
<a name="line-186"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span>                    <span class='hs-comment'>-- ^ initial value</span>
<a name="line-187"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span>                <span class='hs-comment'>-- ^ bounds of the array</span>
<a name="line-188"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- ^ association list</span>
<a name="line-189"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-190"></a><span class='hs-definition'>accumArray</span> <span class='hs-varid'>f</span> <span class='hs-varid'>initial</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span> <span class='hs-keyglyph'>=</span>
<a name="line-191"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-192"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>unsafeAccumArray'</span> <span class='hs-varid'>f</span> <span class='hs-varid'>initial</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-193"></a>                         <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>safeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ies</span><span class='hs-keyglyph'>]</span>
<a name="line-194"></a>
<a name="line-195"></a><a name="unsafeAccumArray"></a><span class='hs-comment'>{-# INLINE unsafeAccumArray #-}</span>
<a name="line-196"></a><span class='hs-definition'>unsafeAccumArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-197"></a><span class='hs-definition'>unsafeAccumArray</span> <span class='hs-varid'>f</span> <span class='hs-varid'>initial</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ies</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeAccumArray'</span> <span class='hs-varid'>f</span> <span class='hs-varid'>initial</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>rangeSize</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span>
<a name="line-198"></a>
<a name="line-199"></a><a name="unsafeAccumArray'"></a><span class='hs-comment'>{-# INLINE unsafeAccumArray' #-}</span>
<a name="line-200"></a><span class='hs-definition'>unsafeAccumArray'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-201"></a><span class='hs-definition'>unsafeAccumArray'</span> <span class='hs-varid'>f</span> <span class='hs-varid'>initial</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runST</span> <span class='hs-layout'>(</span><span class='hs-conid'>ST</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-202"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>newArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span> <span class='hs-varid'>initial</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span>          <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-203"></a>    <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>adjust</span> <span class='hs-varid'>f</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>done</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-204"></a>
<a name="line-205"></a><a name="adjust"></a><span class='hs-comment'>{-# INLINE adjust #-}</span>
<a name="line-206"></a><span class='hs-definition'>adjust</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MutableArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>STRep</span> <span class='hs-varid'>s</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>STRep</span> <span class='hs-varid'>s</span> <span class='hs-varid'>b</span>
<a name="line-207"></a><span class='hs-comment'>-- See NB on 'fill'</span>
<a name="line-208"></a><span class='hs-definition'>adjust</span> <span class='hs-varid'>f</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>new</span><span class='hs-layout'>)</span> <span class='hs-varid'>next</span>
<a name="line-209"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>readArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span>
<a name="line-210"></a>        	<span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>old</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-211"></a>        	    <span class='hs-keyword'>case</span> <span class='hs-varid'>writeArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>old</span> <span class='hs-varid'>new</span><span class='hs-layout'>)</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span>
<a name="line-212"></a>        	        <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>next</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span>
<a name="line-213"></a>
<a name="line-214"></a><a name="//"></a><span class='hs-comment'>-- | Constructs an array identical to the first argument except that it has</span>
<a name="line-215"></a><span class='hs-comment'>-- been updated by the associations in the right argument.</span>
<a name="line-216"></a><span class='hs-comment'>-- For example, if @m@ is a 1-origin, @n@ by @n@ matrix, then</span>
<a name="line-217"></a><span class='hs-comment'>--</span>
<a name="line-218"></a><span class='hs-comment'>-- &gt; m//[((i,i), 0) | i &lt;- [1..n]]</span>
<a name="line-219"></a><span class='hs-comment'>--</span>
<a name="line-220"></a><span class='hs-comment'>-- is the same matrix, except with the diagonal zeroed.</span>
<a name="line-221"></a><span class='hs-comment'>--</span>
<a name="line-222"></a><span class='hs-comment'>-- Repeated indices in the association list are handled as for 'array':</span>
<a name="line-223"></a><span class='hs-comment'>-- Haskell 2010 specifies that the resulting array is undefined (i.e. bottom),</span>
<a name="line-224"></a><span class='hs-comment'>-- but GHC's implementation uses the last association for each index.</span>
<a name="line-225"></a><span class='hs-comment'>{-# INLINE (//) #-}</span>
<a name="line-226"></a><span class='hs-layout'>(</span><span class='hs-varop'>//</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-227"></a><span class='hs-definition'>arr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varop'>//</span> <span class='hs-varid'>ies</span> <span class='hs-keyglyph'>=</span>
<a name="line-228"></a>    <span class='hs-varid'>unsafeReplace</span> <span class='hs-varid'>arr</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>safeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ies</span><span class='hs-keyglyph'>]</span>
<a name="line-229"></a>
<a name="line-230"></a><a name="unsafeReplace"></a><span class='hs-comment'>{-# INLINE unsafeReplace #-}</span>
<a name="line-231"></a><span class='hs-definition'>unsafeReplace</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-232"></a><span class='hs-definition'>unsafeReplace</span> <span class='hs-varid'>arr</span> <span class='hs-varid'>ies</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runST</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-233"></a>    <span class='hs-conid'>STArray</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thawSTArray</span> <span class='hs-varid'>arr</span>
<a name="line-234"></a>    <span class='hs-conid'>ST</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fill</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>done</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="accum"></a><span class='hs-comment'>-- | @'accum' f@ takes an array and an association list and accumulates</span>
<a name="line-237"></a><span class='hs-comment'>-- pairs from the list into the array with the accumulating function @f@.</span>
<a name="line-238"></a><span class='hs-comment'>-- Thus 'accumArray' can be defined using 'accum':</span>
<a name="line-239"></a><span class='hs-comment'>--</span>
<a name="line-240"></a><span class='hs-comment'>-- &gt; accumArray f z b = accum f (array b [(i, z) | i &lt;- range b])</span>
<a name="line-241"></a><span class='hs-comment'>--</span>
<a name="line-242"></a><span class='hs-comment'>{-# INLINE accum #-}</span>
<a name="line-243"></a><span class='hs-definition'>accum</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-244"></a><span class='hs-definition'>accum</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span> <span class='hs-keyglyph'>=</span>
<a name="line-245"></a>    <span class='hs-varid'>unsafeAccum</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arr</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>safeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ies</span><span class='hs-keyglyph'>]</span>
<a name="line-246"></a>
<a name="line-247"></a><a name="unsafeAccum"></a><span class='hs-comment'>{-# INLINE unsafeAccum #-}</span>
<a name="line-248"></a><span class='hs-definition'>unsafeAccum</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-249"></a><span class='hs-definition'>unsafeAccum</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arr</span> <span class='hs-varid'>ies</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runST</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-250"></a>    <span class='hs-conid'>STArray</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thawSTArray</span> <span class='hs-varid'>arr</span>
<a name="line-251"></a>    <span class='hs-conid'>ST</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>adjust</span> <span class='hs-varid'>f</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>done</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-252"></a>
<a name="line-253"></a><a name="amap"></a><span class='hs-comment'>{-# INLINE amap #-}</span>
<a name="line-254"></a><span class='hs-definition'>amap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>b</span>
<a name="line-255"></a><span class='hs-definition'>amap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-256"></a>    <span class='hs-varid'>unsafeArray'</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeAt</span> <span class='hs-varid'>arr</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-257"></a>
<a name="line-258"></a><a name="ixmap"></a><span class='hs-comment'>-- | 'ixmap' allows for transformations on array indices.</span>
<a name="line-259"></a><span class='hs-comment'>-- It may be thought of as providing function composition on the right</span>
<a name="line-260"></a><span class='hs-comment'>-- with the mapping that the original array embodies.</span>
<a name="line-261"></a><span class='hs-comment'>--</span>
<a name="line-262"></a><span class='hs-comment'>-- A similar transformation of array values may be achieved using 'fmap'</span>
<a name="line-263"></a><span class='hs-comment'>-- from the 'Array' instance of the 'Functor' class.</span>
<a name="line-264"></a><span class='hs-comment'>{-# INLINE ixmap #-}</span>
<a name="line-265"></a><span class='hs-definition'>ixmap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>j</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span>
<a name="line-266"></a><span class='hs-definition'>ixmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arr</span> <span class='hs-keyglyph'>=</span>
<a name="line-267"></a>    <span class='hs-varid'>array</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>arr</span> <span class='hs-varop'>!</span> <span class='hs-varid'>f</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>range</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-268"></a>
<a name="line-269"></a><a name="eqArray"></a><span class='hs-comment'>{-# INLINE eqArray #-}</span>
<a name="line-270"></a><span class='hs-definition'>eqArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-271"></a><span class='hs-definition'>eqArray</span> <span class='hs-varid'>arr1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>u1</span> <span class='hs-varid'>n1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>arr2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l2</span> <span class='hs-varid'>u2</span> <span class='hs-varid'>n2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-272"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>n2</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>else</span>
<a name="line-273"></a>    <span class='hs-varid'>l1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>l2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>u1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>u2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-274"></a>    <span class='hs-varid'>and</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>unsafeAt</span> <span class='hs-varid'>arr1</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>unsafeAt</span> <span class='hs-varid'>arr2</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>n1</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-275"></a>
<a name="line-276"></a><a name="cmpArray"></a><span class='hs-comment'>{-# INLINE [1] cmpArray #-}</span>
<a name="line-277"></a><span class='hs-definition'>cmpArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-278"></a><span class='hs-definition'>cmpArray</span> <span class='hs-varid'>arr1</span> <span class='hs-varid'>arr2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>assocs</span> <span class='hs-varid'>arr1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>assocs</span> <span class='hs-varid'>arr2</span><span class='hs-layout'>)</span>
<a name="line-279"></a>
<a name="line-280"></a><a name="cmpIntArray"></a><span class='hs-comment'>{-# INLINE cmpIntArray #-}</span>
<a name="line-281"></a><span class='hs-definition'>cmpIntArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-conid'>Int</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-conid'>Int</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-282"></a><span class='hs-definition'>cmpIntArray</span> <span class='hs-varid'>arr1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>u1</span> <span class='hs-varid'>n1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>arr2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l2</span> <span class='hs-varid'>u2</span> <span class='hs-varid'>n2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-283"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span>
<a name="line-284"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>n2</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>EQ</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>LT</span>
<a name="line-285"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>n2</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>GT</span>
<a name="line-286"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>compare</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span> <span class='hs-keyword'>of</span>
<a name="line-287"></a>             <span class='hs-conid'>EQ</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>cmp</span> <span class='hs-layout'>(</span><span class='hs-varid'>compare</span> <span class='hs-varid'>u1</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span> <span class='hs-keyglyph'>..</span> <span class='hs-layout'>(</span><span class='hs-varid'>n1</span> <span class='hs-varop'>`min`</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-keyglyph'>]</span>
<a name="line-288"></a>             <span class='hs-varid'>other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>other</span>
<a name="line-289"></a>  <span class='hs-keyword'>where</span>
<a name="line-290"></a>    <span class='hs-varid'>cmp</span> <span class='hs-varid'>i</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeAt</span> <span class='hs-varid'>arr1</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeAt</span> <span class='hs-varid'>arr2</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-291"></a>        <span class='hs-conid'>EQ</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rest</span>
<a name="line-292"></a>        <span class='hs-varid'>other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>other</span>
<a name="line-293"></a>
<a name="line-294"></a><span class='hs-comment'>{-# RULES "cmpArray/Int" cmpArray = cmpIntArray #-}</span>
</pre>\end{code}


%*********************************************************
%*                                                      *
\subsection{Array instances}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Functor</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>    <span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>amap</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqArray</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Ord</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>compare</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpArray</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>showsPrec</span> <span class='hs-varid'>p</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span>
<a name="line-12"></a>        <span class='hs-varid'>showParen</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>appPrec</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-13"></a>        <span class='hs-varid'>showString</span> <span class='hs-str'>"array "</span> <span class='hs-varop'>.</span>
<a name="line-14"></a>        <span class='hs-varid'>showsPrec</span> <span class='hs-varid'>appPrec1</span> <span class='hs-layout'>(</span><span class='hs-varid'>bounds</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span>
<a name="line-15"></a>        <span class='hs-varid'>showChar</span> <span class='hs-chr'>' '</span> <span class='hs-varop'>.</span>
<a name="line-16"></a>        <span class='hs-varid'>showsPrec</span> <span class='hs-varid'>appPrec1</span> <span class='hs-layout'>(</span><span class='hs-varid'>assocs</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-17"></a>        <span class='hs-comment'>-- Precedence of 'array' is the precedence of application</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-comment'>-- The Read instance is in GHC.Read</span>
</pre>\end{code}


%*********************************************************
%*                                                      *
\subsection{Operations on mutable arrays}
%*                                                      *
%*********************************************************

Idle ADR question: What's the tradeoff here between flattening these
datatypes into @STArray ix ix (MutableArray# s elt)@ and using
it as is?  As I see it, the former uses slightly less heap and
provides faster access to the individual parts of the bounds while the
code used has the benefit of providing a ready-made @(lo, hi)@ pair as
required by many array-related functions.  Which wins? Is the
difference significant (probably not).

Idle AJG answer: When I looked at the outputted code (though it was 2
years ago) it seems like you often needed the tuple, and we build
it frequently. Now we've got the overloading specialiser things
might be different, though.

\begin{code}
<pre><a name="line-1"></a><a name="newSTArray"></a><span class='hs-comment'>{-# INLINE newSTArray #-}</span>
<a name="line-2"></a><span class='hs-definition'>newSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>newSTArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>initial</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ST</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-4"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>safeRangeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span>            <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-5"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>newArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span> <span class='hs-varid'>initial</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span>       <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-6"></a>    <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="boundsSTArray"></a><span class='hs-comment'>{-# INLINE boundsSTArray #-}</span>
<a name="line-9"></a><span class='hs-definition'>boundsSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-definition'>boundsSTArray</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="numElementsSTArray"></a><span class='hs-comment'>{-# INLINE numElementsSTArray #-}</span>
<a name="line-13"></a><span class='hs-definition'>numElementsSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-14"></a><span class='hs-definition'>numElementsSTArray</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="readSTArray"></a><span class='hs-comment'>{-# INLINE readSTArray #-}</span>
<a name="line-17"></a><span class='hs-definition'>readSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-varid'>e</span>
<a name="line-18"></a><span class='hs-definition'>readSTArray</span> <span class='hs-varid'>marr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span>
<a name="line-19"></a>    <span class='hs-varid'>unsafeReadSTArray</span> <span class='hs-varid'>marr</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="unsafeReadSTArray"></a><span class='hs-comment'>{-# INLINE unsafeReadSTArray #-}</span>
<a name="line-22"></a><span class='hs-definition'>unsafeReadSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-varid'>e</span>
<a name="line-23"></a><span class='hs-definition'>unsafeReadSTArray</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-24"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ST</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>readArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="writeSTArray"></a><span class='hs-comment'>{-# INLINE writeSTArray #-}</span>
<a name="line-27"></a><span class='hs-definition'>writeSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-conid'>()</span>
<a name="line-28"></a><span class='hs-definition'>writeSTArray</span> <span class='hs-varid'>marr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span>
<a name="line-29"></a>    <span class='hs-varid'>unsafeWriteSTArray</span> <span class='hs-varid'>marr</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="unsafeWriteSTArray"></a><span class='hs-comment'>{-# INLINE unsafeWriteSTArray #-}</span>
<a name="line-32"></a><span class='hs-definition'>unsafeWriteSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-conid'>()</span>
<a name="line-33"></a><span class='hs-definition'>unsafeWriteSTArray</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ST</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-34"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>writeArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>e</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span>
<a name="line-35"></a>        <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
</pre>\end{code}


%*********************************************************
%*                                                      *
\subsection{Moving between mutable and immutable}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="freezeSTArray"></a><span class='hs-definition'>freezeSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>freezeSTArray</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ST</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>newArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span> <span class='hs-varid'>arrEleBottom</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span>  <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>marr'</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-4"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>copy</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTrue</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varop'>==#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span>
<a name="line-5"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-6"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>readArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s4</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-7"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>writeArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr'</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>e</span> <span class='hs-varid'>s4</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s5</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-8"></a>            <span class='hs-varid'>copy</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varop'>+#</span> <span class='hs-num'>1</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>s5</span><span class='hs-cpp'>#</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span> <span class='hs-keyword'>in</span>
<a name="line-9"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>copy</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span>                    <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-10"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>unsafeFreezeArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr'</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span>  <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s4</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-11"></a>    <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s4</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="unsafeFreezeSTArray"></a><span class='hs-comment'>{-# INLINE unsafeFreezeSTArray #-}</span>
<a name="line-14"></a><span class='hs-definition'>unsafeFreezeSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-definition'>unsafeFreezeSTArray</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ST</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-16"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>unsafeFreezeArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span>   <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-17"></a>    <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="thawSTArray"></a><span class='hs-definition'>thawSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-definition'>thawSTArray</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ST</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-21"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>newArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span> <span class='hs-varid'>arrEleBottom</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span>  <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-22"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>copy</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTrue</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varop'>==#</span> <span class='hs-varid'>n</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span>
<a name="line-23"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-24"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>indexArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span>    <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>e</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-25"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>writeArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varid'>e</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s4</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-26"></a>            <span class='hs-varid'>copy</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-cpp'>#</span> <span class='hs-varop'>+#</span> <span class='hs-num'>1</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-varid'>s4</span><span class='hs-cpp'>#</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span> <span class='hs-keyword'>in</span>
<a name="line-27"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>copy</span> <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span>                    <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-28"></a>    <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s3</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="unsafeThawSTArray"></a><span class='hs-comment'>{-# INLINE unsafeThawSTArray #-}</span>
<a name="line-31"></a><span class='hs-definition'>unsafeThawSTArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ix</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Array</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-definition'>unsafeThawSTArray</span> <span class='hs-layout'>(</span><span class='hs-conid'>Array</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ST</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s1</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-33"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>unsafeThawArray</span><span class='hs-cpp'>#</span> <span class='hs-varid'>arr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s1</span><span class='hs-cpp'>#</span>      <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-34"></a>    <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>s2</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>l</span> <span class='hs-varid'>u</span> <span class='hs-varid'>n</span> <span class='hs-varid'>marr</span><span class='hs-cpp'>#</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}
</body>
</html>
