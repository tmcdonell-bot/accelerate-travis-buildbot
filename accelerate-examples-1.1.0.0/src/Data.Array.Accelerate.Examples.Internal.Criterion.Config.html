<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators   #-}</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Module:      : Data.Array.Accelerate.Examples.Internal.Criterion.Config</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Copyright    : [2014] Trevor L. McDonell</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- License      : BSD3</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Maintainer   : Trevor L. McDonell &lt;tmcdonell@cse.unsw.edu.au&gt;</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Stability    : experimental</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Portability  : non-portable (GHC extensions)</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Examples</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Criterion</span><span class="hs-operator">.</span><span class="hs-identifier">Config</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-comment">-- ** Criterion options</span><span>
</span><a name="line-16"></a><span>  </span><span class="hs-identifier hs-type">Config</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">defaultConfig</span><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>  </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Examples</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Criterion</span><span class="hs-operator">.</span><span class="hs-identifier">Config</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span>                                  </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Char</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Label</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Label</span><span class="hs-operator">.</span><span class="hs-identifier">Derive</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Category</span><span>                         </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Console</span><span class="hs-operator">.</span><span class="hs-identifier">GetOpt</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Printf</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">PrettyPrint</span><span class="hs-operator">.</span><span class="hs-identifier">ANSI</span><span class="hs-operator">.</span><span class="hs-identifier">Leijen</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Criterion</span><span class="hs-operator">.</span><span class="hs-identifier">Analysis</span><span>                       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">validateAccessors</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Criterion</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>                          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Config</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">measureKeys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">measureAccessors</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Criterion</span><span class="hs-operator">.</span><span class="hs-identifier">Main</span><span class="hs-operator">.</span><span class="hs-identifier">Options</span><span>                   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">defaultConfig</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLabelsNamed</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">[</span><span class="hs-char">''Config])


-- A GetOpt version of Criterion's command line options parser. It is
-- unfortunate that we need to do this to integrate with the other frameworks.
--
defaultOptions :: [OptDescr (Config -&gt; Config)]
defaultOptions =
  [ Option  [] [&quot;ci&quot;]
            (ReqArg (set confInterval . read) &quot;CI&quot;)
            (describe confInterval &quot;confidence interval&quot;)

  , Option  [] [&quot;no-gc&quot;]
            (NoArg (set forceGC False))
            &quot;do not collect garbage between iterations&quot;

  , Option  [] [&quot;time-limit&quot;]
            (ReqArg (set timeLimit . read) &quot;SECS&quot;)
            (describe timeLimit &quot;time limit to run a benchmark&quot;)

  , Option  [] [&quot;resamples&quot;]
            (ReqArg (set resamples . read) &quot;INT&quot;)
            (describe resamples &quot;number of bootstrap resamples to perform&quot;)

  , Option  [] [&quot;regress&quot;]
            (ReqArg (\v -&gt; modify regressions (regressParams v :)) &quot;RESP:PRED..&quot;)
            &quot;regressions to perform&quot;

  , Option  [] [&quot;raw&quot;]
            (OptArg (set rawDataFile) &quot;FILE&quot;)
            (describe rawDataFile &quot;file to write raw data to&quot;)

  , Option  [] [&quot;output&quot;]
            (OptArg (set reportFile) &quot;FILE&quot;)
            (describe reportFile &quot;file to write report to&quot;)

  , Option  [] [&quot;csv&quot;]
            (OptArg (set csvFile) &quot;FILE&quot;)
            (describe csvFile &quot;file to write CSV summary to&quot;)

  , Option  [] [&quot;junit&quot;]
            (OptArg (set junitFile) &quot;FILE&quot;)
            (describe junitFile &quot;file to write JUnit summary to&quot;)

  , Option  [] [&quot;verbosity&quot;]
            (ReqArg (set verbosity . toEnum . range (0,2) . read) &quot;LEVEL&quot;)
            (describe' fromEnum verbosity &quot;verbosity level&quot;)

  , Option  [] [&quot;template&quot;]
            (ReqArg (set template) &quot;FILE&quot;)
            (describe template &quot;template to use for report&quot;)
  ]
  where
    describe :: Show a =&gt; (Config :-&gt; a) -&gt; String -&gt; String
    describe = describe' id

    describe' :: Show a =&gt; (b -&gt; a) -&gt; (Config :-&gt; b) -&gt; String -&gt; String
    describe' p f msg
      = msg ++ &quot; (&quot; ++ show (p (get f defaultConfig)) ++ &quot;)&quot;

    range (n,m) x
      | n &lt;= x &amp;&amp; x &lt;= m = x
      | otherwise        = error $ printf &quot;%d is outside range (%d,%d)&quot; x n m

-- The following options are not part of the configuration structure, but will
-- be intercepted when calling 'defaultMainWith', and control the execution
-- mode. We include these extra options when generating the help text, but don't
-- include them when processing the 'Config' structure.
--
extraOptions :: [OptDescr (a -&gt; a)]
extraOptions =
  [ Option  [] [&quot;match&quot;]
            (ReqArg (flip const) &quot;MATCH&quot;)
            &quot;how to match benchmark names&quot;

  , Option  [] [&quot;only-run&quot;]
            (ReqArg (flip const) &quot;ITERS&quot;)
            &quot;run benchmarks, don't analyse&quot;

  , Option  [] [&quot;list&quot;]
            (NoArg id)
            &quot;list benchmarks&quot;

  , Option  [] [&quot;help&quot;]
            (NoArg id)
            &quot;Shows this help text&quot;
  ]


-- Check and parse the arguments to '--regress'. Copied from
-- Criterion.Main.Options
--
regressParams :: String -&gt; ([String], String)
regressParams m
  | null r      = error &quot;regression parameters: no responder specified&quot;
  | null ps     = error &quot;regression parameters: no predictors specified&quot;
  | otherwise   = validate `seq` ret
  where
    repl ','    = ' '
    repl c      = c

    tidy        = reverse . dropWhile isSpace . reverse . dropWhile isSpace
    (r,ps)      = break (==':') m

    ret         = (words . map repl . drop 1 $ ps, tidy r)
    validate    = either error id $ uncurry validateAccessors ret

-- Generate the help string to describe the possible arguments to '--regress'.
-- Copied from Criterion.Main.Options.
--
regressHelp :: String
regressHelp
  = show
  $ text &quot;Criterion regression metrics for use with --regress:&quot;
  &lt;$&gt; tabulate [(text n, text d) | (n,(_,d)) &lt;- map f measureKeys]
  where
    f k = (k, measureAccessors M.! k)


tabulate :: [(Doc,Doc)] -&gt; Doc
tabulate = tabulate' 24
  where
    tabulate' _    []    = empty
    tabulate' size table = vcat
        [ indent 2 (fillBreak size key &lt;+&gt; value) | (key, value) &lt;- table ]

</span></pre></body></html>