<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleInstances, NamedFieldPuns, CPP, ScopedTypeVariables, BangPatterns, MagicHash #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-- | Chase-Lev work stealing Deques</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- </span><span>
</span><a name="line-5"></a><span class="hs-comment">-- This implementation derives directly from the pseudocode in the 2005 SPAA paper:</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">--   http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.170.1097&amp;rep=rep1&amp;type=pdf</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- TODO: local topBound optimization.</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- TODO: Do the more optimized version of growCirc</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">Deque</span><span class="hs-operator">.</span><span class="hs-identifier">ChaseLev</span><span> </span><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>    </span><span class="hs-comment">-- The convention here is to directly provide the concrete</span><span>
</span><a name="line-14"></a><span>    </span><span class="hs-comment">-- operations as well as providing the class instances.</span><span>
</span><a name="line-15"></a><span>    </span><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier hs-type">ChaseLevDeque</span></a><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#newQ"><span class="hs-identifier hs-var">newQ</span></a><span class="hs-special">,</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#nullQ"><span class="hs-identifier hs-var">nullQ</span></a><span class="hs-special">,</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#pushL"><span class="hs-identifier hs-var">pushL</span></a><span class="hs-special">,</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#tryPopL"><span class="hs-identifier hs-var">tryPopL</span></a><span class="hs-special">,</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#tryPopR"><span class="hs-identifier hs-var">tryPopR</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>    </span><a href="Data.Concurrent.Deque.ChaseLev.html#approxSize"><span class="hs-identifier hs-var">approxSize</span></a><span class="hs-special">,</span><span> </span><span>
</span><a name="line-17"></a><span>    </span><a href="Data.Concurrent.Deque.ChaseLev.html#dbgInspectCLD"><span class="hs-identifier hs-var">dbgInspectCLD</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IORef</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">intersperse</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">Deque</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PC</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-comment">-- import Data.CAS (casIORef)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Mutable</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MV</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">V</span><span>
</span><a name="line-28"></a><span class="hs-comment">-- import Data.Vector.Unboxed.Mutable as V</span><span>
</span><a name="line-29"></a><span class="hs-comment">-- import Data.Vector</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Printf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">printf</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throw</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">evaluate</span><span class="hs-special">,</span><span class="hs-identifier hs-var">try</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">when</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">forM_</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Atomics</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">storeLoadBarrier</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">writeBarrier</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">loadLoadBarrier</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Atomics</span><span class="hs-operator">.</span><span class="hs-identifier">Counter</span><span>
</span><a name="line-36"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AtomicCounter</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newCounter</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">writeCounter</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">casCounter</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readCounterForCAS</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">peekCTicket</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-comment">-- Debugging:</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafePerformIO</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Printf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">printf</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Mem</span><span class="hs-operator">.</span><span class="hs-identifier">StableName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">makeStableName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hashStableName</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Exts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span class="hs-operator hs-var">#</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Prim</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reallyUnsafePtrEquality</span><span class="hs-operator hs-var">#</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unsafeCoerce</span><span class="hs-operator hs-var">#</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- Instances</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">PC</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">DequeClass</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier hs-type">ChaseLevDeque</span></a><span> </span><span class="hs-keyword">where</span><span> </span><span>
</span><a name="line-49"></a><span>  </span><a name="local-8214565720323784749"><span class="hs-identifier">newQ</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#newQ"><span class="hs-identifier hs-var">newQ</span></a><span>
</span><a name="line-50"></a><span>  </span><a name="local-8214565720323784748"><span class="hs-identifier">nullQ</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#nullQ"><span class="hs-identifier hs-var">nullQ</span></a><span>
</span><a name="line-51"></a><span>  </span><a name="local-8214565720323784747"><span class="hs-identifier">pushL</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#pushL"><span class="hs-identifier hs-var">pushL</span></a><span>
</span><a name="line-52"></a><span>  </span><a name="local-8214565720323784746"><span class="hs-identifier">tryPopR</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#tryPopR"><span class="hs-identifier hs-var">tryPopR</span></a><span>
</span><a name="line-53"></a><span>  </span><span class="hs-comment">-- | Popping the left end is the &quot;local&quot; side:</span><span>
</span><a name="line-54"></a><span>  </span><a name="local-8214565720323784745"><span class="hs-identifier">leftThreadSafe</span></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-55"></a><span>  </span><a name="local-8214565720323784744"><span class="hs-identifier">rightThreadSafe</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">PC</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">PopL</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier hs-type">ChaseLevDeque</span></a><span> </span><span class="hs-keyword">where</span><span> </span><span>
</span><a name="line-58"></a><span>  </span><a name="local-8214565720323784751"><span class="hs-identifier">tryPopL</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#tryPopL"><span class="hs-identifier hs-var">tryPopL</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- Type definition</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">data</span><span> </span><a name="ChaseLevDeque"><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier">ChaseLevDeque</span></a></a><span> </span><a name="local-6989586621679023479"><a href="#local-6989586621679023479"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CLD"><a href="Data.Concurrent.Deque.ChaseLev.html#CLD"><span class="hs-identifier">CLD</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-64"></a><span>    </span><a name="top"><a href="Data.Concurrent.Deque.ChaseLev.html#top"><span class="hs-identifier">top</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">AtomicCounter</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="bottom"><a href="Data.Concurrent.Deque.ChaseLev.html#bottom"><span class="hs-identifier">bottom</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">AtomicCounter</span><span>
</span><a name="line-66"></a><span>    </span><span class="hs-comment">-- This is a circular array:</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="activeArr"><a href="Data.Concurrent.Deque.ChaseLev.html#activeArr"><span class="hs-identifier">activeArr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MV</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IOVector</span><span> </span><a href="#local-6989586621679023479"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-identifier">dbgInspectCLD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="#local-6989586621679025358"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier hs-type">ChaseLevDeque</span></a><span> </span><a href="#local-6989586621679025358"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-71"></a><a name="dbgInspectCLD"><a href="Data.Concurrent.Deque.ChaseLev.html#dbgInspectCLD"><span class="hs-identifier">dbgInspectCLD</span></a></a><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#CLD"><span class="hs-identifier hs-var">CLD</span></a><span class="hs-special">{</span><a name="local-6989586621679026041"><a href="#local-6989586621679026041"><span class="hs-identifier">top</span></a></a><span class="hs-special">,</span><a name="local-6989586621679026042"><a href="#local-6989586621679026042"><span class="hs-identifier">bottom</span></a></a><span class="hs-special">,</span><a name="local-6989586621679026043"><a href="#local-6989586621679026043"><span class="hs-identifier">activeArr</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-72"></a><span>  </span><a name="local-6989586621679027153"><a href="#local-6989586621679027153"><span class="hs-identifier">tp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span> </span><a href="#local-6989586621679026041"><span class="hs-identifier hs-var">top</span></a><span>
</span><a name="line-73"></a><span>  </span><a name="local-6989586621679027154"><a href="#local-6989586621679027154"><span class="hs-identifier">bt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span> </span><a href="#local-6989586621679026042"><span class="hs-identifier hs-var">bottom</span></a><span>
</span><a name="line-74"></a><span>  </span><a name="local-6989586621679027155"><a href="#local-6989586621679027155"><span class="hs-identifier">vc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679026043"><span class="hs-identifier hs-var">activeArr</span></a><span>
</span><a name="line-75"></a><span>  </span><a name="local-6989586621679027156"><a href="#local-6989586621679027156"><span class="hs-identifier">elems</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">V</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">V</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">freeze</span><span> </span><a href="#local-6989586621679027155"><span class="hs-identifier hs-var">vc</span></a><span>
</span><a name="line-76"></a><span>  </span><a name="local-6989586621679027538"><a href="#local-6989586621679027538"><span class="hs-identifier">elems'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621679026044"><span class="hs-identifier hs-var">safePrint</span></a><span> </span><a href="#local-6989586621679027156"><span class="hs-identifier hs-var">elems</span></a><span>
</span><a name="line-77"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679027539"><a href="#local-6989586621679027539"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679027155"><span class="hs-identifier hs-var">vc</span></a><span>
</span><a name="line-78"></a><span>  </span><span class="hs-identifier hs-var">return</span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;  {DbgInspectCLD: top &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679027153"><span class="hs-identifier hs-var">tp</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;, bot &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679027154"><span class="hs-identifier hs-var">bt</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;, size &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679027539"><span class="hs-identifier hs-var">sz</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-79"></a><span>          </span><span class="hs-comment">-- show elems ++ &quot;\n&quot;++</span><span>
</span><a name="line-80"></a><span>          </span><span class="hs-string">&quot;   [ &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">intersperse</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><a href="#local-6989586621679027538"><span class="hs-identifier hs-var">elems'</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; ]\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-81"></a><span>          </span><span class="hs-string">&quot;  end_DbgInspectCLD}&quot;</span><span>
</span><a name="line-82"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-83"></a><span>   </span><span class="hs-comment">-- Print any thunk, even if it raises an exception.</span><span>
</span><a name="line-84"></a><span>   </span><span class="hs-identifier">safePrint</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="#local-6989586621679026045"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679026045"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-85"></a><span>   </span><a name="local-6989586621679026044"><a href="#local-6989586621679026044"><span class="hs-identifier">safePrint</span></a></a><span> </span><a name="local-6989586621679026046"><a href="#local-6989586621679026046"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-86"></a><span>     </span><a name="local-6989586621679026536"><a href="#local-6989586621679026536"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">try</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">evaluate</span><span> </span><a href="#local-6989586621679026046"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>     </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679026536"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-88"></a><span>       </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679027003"><a href="#local-6989586621679027003"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">::</span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isInfixOf</span><span> </span><span class="hs-string">&quot;uninitialised element&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679027003"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-string">&quot;&lt;uninit&gt;&quot;</span><span>
</span><a name="line-90"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;&lt;&quot;</span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679027003"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;&gt;&quot;</span><span>
</span><a name="line-91"></a><span>       </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679027152"><a href="#local-6989586621679027152"><span class="hs-identifier">val'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679027152"><span class="hs-identifier hs-var">val'</span></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>     </span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-96"></a><span class="hs-comment">-- Debugging mode.</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- define DEBUGCL</span><span>
</span><a name="line-98"></a><span class="hs-comment">--define FAKECAS</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-pragma">{-# INLINE rd #-}</span><span>
</span><a name="line-101"></a><span class="hs-pragma">{-# INLINE wr #-}</span><span>
</span><a name="line-102"></a><span class="hs-pragma">{-# INLINE nu #-}</span><span>
</span><a name="line-103"></a><span class="hs-pragma">{-# INLINE cpy #-}</span><span>
</span><a name="line-104"></a><span class="hs-pragma">{-# INLINE slc #-}</span><span>
</span><a name="line-105"></a><span class="hs-cpp">#ifndef DEBUGCL</span><span>
</span><a name="line-106"></a><a name="dbg"><a href="Data.Concurrent.Deque.ChaseLev.html#dbg"><span class="hs-identifier">dbg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-107"></a><a name="nu"><a href="Data.Concurrent.Deque.ChaseLev.html#nu"><span class="hs-identifier">nu</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeNew</span><span>
</span><a name="line-108"></a><a name="rd"><a href="Data.Concurrent.Deque.ChaseLev.html#rd"><span class="hs-identifier">rd</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeRead</span><span>
</span><a name="line-109"></a><a name="wr"><a href="Data.Concurrent.Deque.ChaseLev.html#wr"><span class="hs-identifier">wr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeWrite</span><span>
</span><a name="line-110"></a><a name="slc"><a href="Data.Concurrent.Deque.ChaseLev.html#slc"><span class="hs-identifier">slc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeSlice</span><span>
</span><a name="line-111"></a><a name="cpy"><a href="Data.Concurrent.Deque.ChaseLev.html#cpy"><span class="hs-identifier">cpy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeCopy</span><span>
</span><a name="line-112"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-113"></a><span class="hs-cpp">#warning &quot;Activating DEBUGCL!&quot;</span><span>
</span><a name="line-114"></a><span class="hs-identifier">dbg</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-115"></a><span class="hs-identifier">nu</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">MV</span><span class="hs-operator">.</span><span class="hs-identifier">new</span><span> </span><span>
</span><a name="line-116"></a><span class="hs-identifier">rd</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">MV</span><span class="hs-operator">.</span><span class="hs-identifier">read</span><span>
</span><a name="line-117"></a><span class="hs-identifier">slc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">MV</span><span class="hs-operator">.</span><span class="hs-identifier">slice</span><span>
</span><a name="line-118"></a><span class="hs-identifier">cpy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">MV</span><span class="hs-operator">.</span><span class="hs-identifier">copy</span><span>
</span><a name="line-119"></a><span class="hs-identifier">wr</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">MV</span><span class="hs-operator">.</span><span class="hs-identifier">write</span><span>
</span><a name="line-120"></a><span class="hs-comment">-- Temp, debugging: Our own bounds checking, better error:</span><span>
</span><a name="line-121"></a><span class="hs-comment">-- wr v i x = </span><span>
</span><a name="line-122"></a><span class="hs-comment">--   if i &gt;= MV.length v</span><span>
</span><a name="line-123"></a><span class="hs-comment">--   then error (printf &quot;ERROR: Out of bounds of top of vector index %d, vec length %d\n&quot; i (MV.length v))</span><span>
</span><a name="line-124"></a><span class="hs-comment">--   else MV.write v i x</span><span>
</span><a name="line-125"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-cpp">#ifdef DEBUGCL</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- This simply localizes exceptions better:</span><span>
</span><a name="line-130"></a><span class="hs-identifier">tryit</span><span> </span><span class="hs-identifier">msg</span><span> </span><span class="hs-identifier">action</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span class="hs-operator">.</span><span class="hs-identifier">catch</span><span> </span><span class="hs-identifier">action</span><span> </span><span>
</span><a name="line-131"></a><span>	                        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">e</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier">putStrLn</span><span class="hs-operator">$</span><span> </span><span class="hs-string">&quot;ERROR inside &quot;</span><span class="hs-operator">++</span><span class="hs-identifier">msg</span><span class="hs-operator">++</span><span class="hs-string">&quot; &quot;</span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">e</span><span> </span><span>
</span><a name="line-132"></a><span>                                          </span><span class="hs-identifier">throw</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">e</span><span class="hs-glyph">::</span><span class="hs-identifier">SomeException</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-134"></a><span class="hs-pragma">{-# INLINE tryit #-}</span><span>
</span><a name="line-135"></a><a name="tryit"><a href="Data.Concurrent.Deque.ChaseLev.html#tryit"><span class="hs-identifier">tryit</span></a></a><span> </span><a name="local-6989586621679028497"><a href="#local-6989586621679028497"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621679028498"><a href="#local-6989586621679028498"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679028498"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-136"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- Circular array routines:</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">-- TODO: make a &quot;grow&quot; that uses memcpy.</span><span>
</span><a name="line-145"></a><span class="hs-identifier">growCirc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MV</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IOVector</span><span> </span><a href="#local-6989586621679025357"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MV</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IOVector</span><span> </span><a href="#local-6989586621679025357"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><a name="growCirc"><a href="Data.Concurrent.Deque.ChaseLev.html#growCirc"><span class="hs-identifier">growCirc</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679028499"><a href="#local-6989586621679028499"><span class="hs-identifier">strt</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679028500"><a href="#local-6989586621679028500"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679028501"><a href="#local-6989586621679028501"><span class="hs-identifier">oldarr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span>
</span><a name="line-147"></a><span>  </span><span class="hs-comment">-- let len = MV.length oldarr</span><span>
</span><a name="line-148"></a><span>  </span><span class="hs-comment">--     strtmod = strt`mod` len </span><span>
</span><a name="line-149"></a><span>  </span><span class="hs-comment">--     endmod  = end `mod` len</span><span>
</span><a name="line-150"></a><span>  </span><span class="hs-comment">-- newarr &lt;- nu (len + len)</span><span>
</span><a name="line-151"></a><span>  </span><span class="hs-comment">-- if endmod &lt; strtmod then do</span><span>
</span><a name="line-152"></a><span>  </span><span class="hs-comment">--   let elems1 = len - strtmod</span><span>
</span><a name="line-153"></a><span>  </span><span class="hs-comment">--       elems2 = endmod</span><span>
</span><a name="line-154"></a><span>  </span><span class="hs-comment">--   BS.putStrLn$ BS.pack$ printf &quot;Copying segmented ... %d and %d&quot; elems1 elems2</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span>  </span><span class="hs-comment">--   -- Copy the upper then lower segments:</span><span>
</span><a name="line-157"></a><span>  </span><span class="hs-comment">--   copyOffset oldarr newarr   strtmod  0       elems1</span><span>
</span><a name="line-158"></a><span>  </span><span class="hs-comment">--   copyOffset oldarr newarr   0        elems1  elems2</span><span>
</span><a name="line-159"></a><span>  </span><span class="hs-comment">--  else do</span><span>
</span><a name="line-160"></a><span>  </span><span class="hs-comment">--   BS.putStrLn$ BS.pack$ printf &quot;Copying one seg into vec of size %d... size %d, strt %d, end %d, strtmod %d endmod %d&quot; (MV.length newarr) (end - strt) strt end strtmod endmod</span><span>
</span><a name="line-161"></a><span>  </span><span class="hs-comment">--   -- Copy a single segment:</span><span>
</span><a name="line-162"></a><span>  </span><span class="hs-comment">--   copyOffset oldarr newarr strtmod 0 (end - strt)</span><span>
</span><a name="line-163"></a><span>  </span><span class="hs-comment">-- return newarr</span><span>
</span><a name="line-164"></a><span>  </span><span class="hs-comment">----------------------------------------</span><span>
</span><a name="line-165"></a><span>  </span><span class="hs-comment">-- Easier version first:</span><span>
</span><a name="line-166"></a><span>  </span><span class="hs-comment">----------------------------------------  </span><span>
</span><a name="line-167"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679028502"><a href="#local-6989586621679028502"><span class="hs-identifier">len</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679028501"><span class="hs-identifier hs-var">oldarr</span></a><span>
</span><a name="line-168"></a><span>      </span><a name="local-6989586621679028503"><a href="#local-6989586621679028503"><span class="hs-identifier">elems</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679028500"><span class="hs-identifier hs-var">end</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679028499"><span class="hs-identifier hs-var">strt</span></a><span>
</span><a name="line-169"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#dbg"><span class="hs-identifier hs-var">dbg</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Grow to size &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028502"><span class="hs-identifier hs-var">len</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679028502"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;, copying over &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679028503"><span class="hs-identifier hs-var">elems</span></a><span>
</span><a name="line-170"></a><span>  </span><a name="local-6989586621679029275"><a href="#local-6989586621679029275"><span class="hs-identifier">newarr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#dbg"><span class="hs-identifier hs-var">dbg</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-171"></a><span>               </span><a href="Data.Concurrent.Deque.ChaseLev.html#nu"><span class="hs-identifier hs-var">nu</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028502"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679028502"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>            </span><span class="hs-keyword">else</span><span>  </span><span class="hs-comment">-- Better errors:</span><span>
</span><a name="line-173"></a><span>                </span><span class="hs-identifier hs-var">V</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">thaw</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">V</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">generate</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679028502"><span class="hs-identifier hs-var">len</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679028502"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679028756"><a href="#local-6989586621679028756"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot; uninitialized element at position &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679028756"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-174"></a><span>							    </span><span class="hs-operator">++</span><span class="hs-string">&quot; had only initialized &quot;</span><span class="hs-operator">++</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">elems</span><span class="hs-operator">++</span><span class="hs-string">&quot; elems: &quot;</span><span>
</span><a name="line-175"></a><span>							    </span><span class="hs-operator">++</span><span class="hs-identifier">show</span><span class="hs-special">(</span><span class="hs-identifier">strt</span><span class="hs-special">`</span><span class="hs-identifier">mod</span><span class="hs-special">`</span><span class="hs-special">(</span><span class="hs-identifier">len</span><span class="hs-operator">+</span><span class="hs-identifier">len</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier">end</span><span class="hs-special">`</span><span class="hs-identifier">mod</span><span class="hs-special">`</span><span class="hs-special">(</span><span class="hs-identifier">len</span><span class="hs-operator">+</span><span class="hs-identifier">len</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>  </span><span class="hs-comment">-- Strictly matches what's in the paper:</span><span>
</span><a name="line-177"></a><span>  </span><a href="Data.Concurrent.Deque.ChaseLev.html#for_"><span class="hs-identifier hs-var">for_</span></a><span> </span><a href="#local-6989586621679028499"><span class="hs-identifier hs-var">strt</span></a><span> </span><a href="#local-6989586621679028500"><span class="hs-identifier hs-var">end</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679029276"><a href="#local-6989586621679029276"><span class="hs-identifier">ind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><a name="line-178"></a><span>    </span><a name="local-6989586621679029277"><a href="#local-6989586621679029277"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#getCirc"><span class="hs-identifier hs-var">getCirc</span></a><span> </span><a href="#local-6989586621679028501"><span class="hs-identifier hs-var">oldarr</span></a><span> </span><a href="#local-6989586621679029276"><span class="hs-identifier hs-var">ind</span></a><span> </span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-identifier hs-var">evaluate</span><span> </span><a href="#local-6989586621679029277"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-180"></a><span>    </span><a href="Data.Concurrent.Deque.ChaseLev.html#putCirc"><span class="hs-identifier hs-var">putCirc</span></a><span> </span><a href="#local-6989586621679029275"><span class="hs-identifier hs-var">newarr</span></a><span> </span><a href="#local-6989586621679029276"><span class="hs-identifier hs-var">ind</span></a><span> </span><a href="#local-6989586621679029277"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-181"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621679029275"><span class="hs-identifier hs-var">newarr</span></a><span>
</span><a name="line-182"></a><span class="hs-pragma">{-# INLINE growCirc #-}</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">getCirc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MV</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IOVector</span><span> </span><a href="#local-6989586621679025356"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679025356"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-185"></a><a name="getCirc"><a href="Data.Concurrent.Deque.ChaseLev.html#getCirc"><span class="hs-identifier">getCirc</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679029278"><a href="#local-6989586621679029278"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679029279"><a href="#local-6989586621679029279"><span class="hs-identifier">ind</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#rd"><span class="hs-identifier hs-var">rd</span></a><span> </span><a href="#local-6989586621679029278"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679029279"><span class="hs-identifier hs-var">ind</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mod</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679029278"><span class="hs-identifier hs-var">arr</span></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span class="hs-pragma">{-# INLINE getCirc #-}</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-identifier">putCirc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MV</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IOVector</span><span> </span><a href="#local-6989586621679025355"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679025355"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><a name="putCirc"><a href="Data.Concurrent.Deque.ChaseLev.html#putCirc"><span class="hs-identifier">putCirc</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679029280"><a href="#local-6989586621679029280"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679029281"><a href="#local-6989586621679029281"><span class="hs-identifier">ind</span></a></a><span> </span><a name="local-6989586621679029282"><a href="#local-6989586621679029282"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#wr"><span class="hs-identifier hs-var">wr</span></a><span> </span><a href="#local-6989586621679029280"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679029281"><span class="hs-identifier hs-var">ind</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mod</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679029280"><span class="hs-identifier hs-var">arr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679029282"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-190"></a><span class="hs-pragma">{-# INLINE putCirc #-}</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">-- Use a potentially-optimized block-copy:</span><span>
</span><a name="line-193"></a><span class="hs-identifier">copyOffset</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MV</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IOVector</span><span> </span><a href="#local-6989586621679025354"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MV</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IOVector</span><span> </span><a href="#local-6989586621679025354"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-194"></a><a name="copyOffset"><a href="Data.Concurrent.Deque.ChaseLev.html#copyOffset"><span class="hs-identifier">copyOffset</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679029283"><a href="#local-6989586621679029283"><span class="hs-identifier">from</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679029284"><a href="#local-6989586621679029284"><span class="hs-identifier">to</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679029285"><a href="#local-6989586621679029285"><span class="hs-identifier">iFrom</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679029286"><a href="#local-6989586621679029286"><span class="hs-identifier">iTo</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679029287"><a href="#local-6989586621679029287"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-195"></a><span>  </span><a href="Data.Concurrent.Deque.ChaseLev.html#cpy"><span class="hs-identifier hs-var">cpy</span></a><span> </span><span class="hs-special">(</span><a href="Data.Concurrent.Deque.ChaseLev.html#slc"><span class="hs-identifier hs-var">slc</span></a><span> </span><a href="#local-6989586621679029286"><span class="hs-identifier hs-var">iTo</span></a><span> </span><a href="#local-6989586621679029287"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621679029284"><span class="hs-identifier hs-var">to</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>      </span><span class="hs-special">(</span><a href="Data.Concurrent.Deque.ChaseLev.html#slc"><span class="hs-identifier hs-var">slc</span></a><span> </span><a href="#local-6989586621679029285"><span class="hs-identifier hs-var">iFrom</span></a><span> </span><a href="#local-6989586621679029287"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621679029283"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span class="hs-pragma">{-# INLINE copyOffset #-}</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- Queue Operations</span><span>
</span><a name="line-202"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-identifier">newQ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier hs-type">ChaseLevDeque</span></a><span> </span><a href="#local-6989586621679025353"><span class="hs-identifier hs-type">elt</span></a><span class="hs-special">)</span><span>
</span><a name="line-205"></a><a name="newQ"><a href="Data.Concurrent.Deque.ChaseLev.html#newQ"><span class="hs-identifier">newQ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-206"></a><span>  </span><span class="hs-comment">-- Arbitrary Knob: We start as size 32 and double from there:</span><span>
</span><a name="line-207"></a><span>  </span><a name="local-6989586621679029288"><a href="#local-6989586621679029288"><span class="hs-identifier">v</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">new</span><span> </span><span class="hs-number">32</span><span> </span><span>
</span><a name="line-208"></a><span>  </span><a name="local-6989586621679029289"><a href="#local-6989586621679029289"><span class="hs-identifier">r1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newCounter</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-209"></a><span>  </span><a name="local-6989586621679029290"><a href="#local-6989586621679029290"><span class="hs-identifier">r2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newCounter</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-210"></a><span>  </span><a name="local-6989586621679029291"><a href="#local-6989586621679029291"><span class="hs-identifier">r3</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><a href="#local-6989586621679029288"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-211"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#CLD"><span class="hs-identifier hs-var">CLD</span></a><span> </span><a href="#local-6989586621679029289"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-6989586621679029290"><span class="hs-identifier hs-var">r2</span></a><span> </span><a href="#local-6989586621679029291"><span class="hs-identifier hs-var">r3</span></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-pragma">{-# INLINE newQ #-}</span><span>
</span><a name="line-214"></a><span class="hs-identifier">nullQ</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier hs-type">ChaseLevDeque</span></a><span> </span><a href="#local-6989586621679025352"><span class="hs-identifier hs-type">elt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-215"></a><a name="nullQ"><a href="Data.Concurrent.Deque.ChaseLev.html#nullQ"><span class="hs-identifier">nullQ</span></a></a><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#CLD"><span class="hs-identifier hs-var">CLD</span></a><span class="hs-special">{</span><a name="local-6989586621679029292"><a href="#local-6989586621679029292"><span class="hs-identifier">top</span></a></a><span class="hs-special">,</span><a name="local-6989586621679029293"><a href="#local-6989586621679029293"><span class="hs-identifier">bottom</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-216"></a><span>  </span><span class="hs-comment">-- This should get a LOWER bound on size at some point in logic time, right?</span><span>
</span><a name="line-217"></a><span>  </span><a name="local-6989586621679029294"><a href="#local-6989586621679029294"><span class="hs-identifier">b</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span> </span><a href="#local-6989586621679029293"><span class="hs-identifier hs-var">bottom</span></a><span>
</span><a name="line-218"></a><span>  </span><a name="local-6989586621679029295"><a href="#local-6989586621679029295"><span class="hs-identifier">t</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span> </span><a href="#local-6989586621679029292"><span class="hs-identifier hs-var">top</span></a><span>  </span><span>
</span><a name="line-219"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679029296"><a href="#local-6989586621679029296"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679029294"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679029295"><span class="hs-identifier hs-var">t</span></a><span>  </span><span>
</span><a name="line-220"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621679029296"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-pragma">{-# INLINE approxSize #-}</span><span>
</span><a name="line-223"></a><span class="hs-comment">-- | Return a lower bound on the size at some point in the recent past.</span><span>
</span><a name="line-224"></a><span class="hs-identifier">approxSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier hs-type">ChaseLevDeque</span></a><span> </span><a href="#local-6989586621679025351"><span class="hs-identifier hs-type">elt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-225"></a><a name="approxSize"><a href="Data.Concurrent.Deque.ChaseLev.html#approxSize"><span class="hs-identifier">approxSize</span></a></a><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#CLD"><span class="hs-identifier hs-var">CLD</span></a><span class="hs-special">{</span><a name="local-6989586621679033179"><a href="#local-6989586621679033179"><span class="hs-identifier">top</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033180"><a href="#local-6989586621679033180"><span class="hs-identifier">bottom</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-226"></a><span>  </span><a name="local-6989586621679033181"><a href="#local-6989586621679033181"><span class="hs-identifier">b</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span> </span><a href="#local-6989586621679033180"><span class="hs-identifier hs-var">bottom</span></a><span>
</span><a name="line-227"></a><span>  </span><a name="local-6989586621679033182"><a href="#local-6989586621679033182"><span class="hs-identifier">t</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span> </span><a href="#local-6989586621679033179"><span class="hs-identifier hs-var">top</span></a><span>  </span><span>
</span><a name="line-228"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621679033181"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679033182"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span class="hs-pragma">{-# INLINE pushL #-}</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- | For a work-stealing queue `pushL` is the ``local'' push.  Thus</span><span>
</span><a name="line-232"></a><span class="hs-comment">--   only a single thread should perform this operation.</span><span>
</span><a name="line-233"></a><span class="hs-identifier">pushL</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier hs-type">ChaseLevDeque</span></a><span> </span><a href="#local-6989586621679025350"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679025350"><span class="hs-identifier hs-type">a</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><a name="pushL"><a href="Data.Concurrent.Deque.ChaseLev.html#pushL"><span class="hs-identifier">pushL</span></a></a><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#CLD"><span class="hs-identifier hs-var">CLD</span></a><span class="hs-special">{</span><a name="local-6989586621679033183"><a href="#local-6989586621679033183"><span class="hs-identifier">top</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033184"><a href="#local-6989586621679033184"><span class="hs-identifier">bottom</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033185"><a href="#local-6989586621679033185"><span class="hs-identifier">activeArr</span></a></a><span class="hs-special">}</span><span> </span><a name="local-6989586621679033186"><a href="#local-6989586621679033186"><span class="hs-identifier">obj</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#tryit"><span class="hs-identifier hs-var">tryit</span></a><span> </span><span class="hs-string">&quot;pushL&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-235"></a><span>  </span><a name="local-6989586621679033187"><a href="#local-6989586621679033187"><span class="hs-identifier">b</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span> </span><a href="#local-6989586621679033184"><span class="hs-identifier hs-var">bottom</span></a><span>
</span><a name="line-236"></a><span>  </span><a name="local-6989586621679033188"><a href="#local-6989586621679033188"><span class="hs-identifier">t</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span> </span><a href="#local-6989586621679033183"><span class="hs-identifier hs-var">top</span></a><span>
</span><a name="line-237"></a><span>  </span><a name="local-6989586621679033189"><a href="#local-6989586621679033189"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679033185"><span class="hs-identifier hs-var">activeArr</span></a><span>
</span><a name="line-238"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679033190"><a href="#local-6989586621679033190"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679033189"><span class="hs-identifier hs-var">arr</span></a><span> </span><span>
</span><a name="line-239"></a><span>      </span><a name="local-6989586621679033191"><a href="#local-6989586621679033191"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679033187"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679033188"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-comment">--  when (dbg &amp;&amp; size &lt; 0) $ error$ &quot;pushL: INVARIANT BREAKAGE - bottom, top: &quot;++ show (b,t)</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span>  </span><a name="local-6989586621679033193"><a href="#local-6989586621679033193"><span class="hs-identifier">arr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033191"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679033190"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><a name="line-244"></a><span>            </span><a name="local-6989586621679033192"><a href="#local-6989586621679033192"><span class="hs-identifier">arr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#growCirc"><span class="hs-identifier hs-var">growCirc</span></a><span> </span><a href="#local-6989586621679033188"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679033187"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679033189"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-comment">-- Double in size, don't change b/t.</span><span>
</span><a name="line-245"></a><span>            </span><span class="hs-comment">-- Only a single thread will do this!:</span><span>
</span><a name="line-246"></a><span>	    </span><span class="hs-identifier">writeIORef</span><span> </span><span class="hs-identifier">activeArr</span><span> </span><a href="#local-6989586621679033185"><span class="hs-identifier hs-var">arr'</span></a><span>
</span><a name="line-247"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679033192"><span class="hs-identifier hs-var">arr'</span></a><span>
</span><a name="line-248"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679033189"><span class="hs-identifier hs-var">arr</span></a><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span>  </span><a href="Data.Concurrent.Deque.ChaseLev.html#putCirc"><span class="hs-identifier hs-var">putCirc</span></a><span> </span><a href="#local-6989586621679033193"><span class="hs-identifier hs-var">arr'</span></a><span> </span><a href="#local-6989586621679033187"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679033186"><span class="hs-identifier hs-var">obj</span></a><span>
</span><a name="line-251"></a><span>  </span><span class="hs-comment">{-
     KG: we need to put write barrier here since otherwise we might
     end with elem not added to q-&gt;elements, but q-&gt;bottom already
     modified (write reordering) and with stealWSDeque_ failing
     later when invoked from another thread since it thinks elem is
     there (in case there is just added element in the queue). This
     issue concretely hit me on ARMv7 multi-core CPUs
   -}</span><span>
</span><a name="line-259"></a><span>  </span><span class="hs-identifier hs-var">writeBarrier</span><span>
</span><a name="line-260"></a><span>  </span><span class="hs-identifier hs-var">writeCounter</span><span> </span><a href="#local-6989586621679033184"><span class="hs-identifier hs-var">bottom</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033187"><span class="hs-identifier hs-var">b</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-comment">-- {-# INLINE tryPopR #-}</span><span>
</span><a name="line-264"></a><span class="hs-comment">-- | This is the steal operation.  Multiple threads may concurrently</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- attempt steals from the same thread.</span><span>
</span><a name="line-266"></a><span class="hs-identifier">tryPopR</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier hs-type">ChaseLevDeque</span></a><span> </span><a href="#local-6989586621679025349"><span class="hs-identifier hs-type">elt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679025349"><span class="hs-identifier hs-type">elt</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><a name="tryPopR"><a href="Data.Concurrent.Deque.ChaseLev.html#tryPopR"><span class="hs-identifier">tryPopR</span></a></a><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#CLD"><span class="hs-identifier hs-var">CLD</span></a><span class="hs-special">{</span><a name="local-6989586621679033194"><a href="#local-6989586621679033194"><span class="hs-identifier">top</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033195"><a href="#local-6989586621679033195"><span class="hs-identifier">bottom</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033196"><a href="#local-6989586621679033196"><span class="hs-identifier">activeArr</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>  </span><a href="Data.Concurrent.Deque.ChaseLev.html#tryit"><span class="hs-identifier hs-var">tryit</span></a><span> </span><span class="hs-string">&quot;tryPopR&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-268"></a><span>  </span><span class="hs-comment">-- NB. these loads must be ordered, otherwise there is a race</span><span>
</span><a name="line-269"></a><span>  </span><span class="hs-comment">-- between steal and pop.  </span><span>
</span><a name="line-270"></a><span>  </span><a name="local-6989586621679033197"><a href="#local-6989586621679033197"><span class="hs-identifier">tt</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounterForCAS</span><span> </span><a href="#local-6989586621679033194"><span class="hs-identifier hs-var">top</span></a><span>
</span><a name="line-271"></a><span>  </span><span class="hs-identifier hs-var">loadLoadBarrier</span><span>
</span><a name="line-272"></a><span>  </span><a name="local-6989586621679033198"><a href="#local-6989586621679033198"><span class="hs-identifier">b</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span> </span><a href="#local-6989586621679033195"><span class="hs-identifier hs-var">bottom</span></a><span>
</span><a name="line-273"></a><span>  </span><a name="local-6989586621679033199"><a href="#local-6989586621679033199"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679033196"><span class="hs-identifier hs-var">activeArr</span></a><span>
</span><a name="line-274"></a><span> </span><span class="hs-comment">-- when (dbg &amp;&amp; b &lt; t) $ error$ &quot;tryPopR: INVARIANT BREAKAGE - bottom &lt; top: &quot;++ show (b,t)</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679033200"><a href="#local-6989586621679033200"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">peekCTicket</span><span> </span><a href="#local-6989586621679033197"><span class="hs-identifier hs-var">tt</span></a><span>
</span><a name="line-277"></a><span>      </span><a name="local-6989586621679033201"><a href="#local-6989586621679033201"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679033198"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679033200"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-278"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679033201"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><span>
</span><a name="line-279"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-280"></a><span>   </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><a name="line-281"></a><span>    </span><a name="local-6989586621679033202"><a href="#local-6989586621679033202"><span class="hs-identifier">obj</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#getCirc"><span class="hs-identifier hs-var">getCirc</span></a><span>  </span><a href="#local-6989586621679033199"><span class="hs-identifier hs-var">arr</span></a><span> </span><a href="#local-6989586621679033200"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-282"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679033203"><a href="#local-6989586621679033203"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">casCounter</span><span> </span><a href="#local-6989586621679033194"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-6989586621679033197"><span class="hs-identifier hs-var">tt</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033200"><span class="hs-identifier hs-var">t</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679033203"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span>
</span><a name="line-284"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679033202"><span class="hs-identifier hs-var">obj</span></a><span>
</span><a name="line-285"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span>
</span><a name="line-286"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-comment">-- Someone beat us, abort</span><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span class="hs-pragma">{-# INLINE tryPopL #-}</span><span>
</span><a name="line-289"></a><span class="hs-identifier">tryPopL</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#ChaseLevDeque"><span class="hs-identifier hs-type">ChaseLevDeque</span></a><span> </span><a href="#local-6989586621679025348"><span class="hs-identifier hs-type">elt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679025348"><span class="hs-identifier hs-type">elt</span></a><span class="hs-special">)</span><span>
</span><a name="line-290"></a><a name="tryPopL"><a href="Data.Concurrent.Deque.ChaseLev.html#tryPopL"><span class="hs-identifier">tryPopL</span></a></a><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#CLD"><span class="hs-identifier hs-var">CLD</span></a><span class="hs-special">{</span><a name="local-6989586621679033204"><a href="#local-6989586621679033204"><span class="hs-identifier">top</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033205"><a href="#local-6989586621679033205"><span class="hs-identifier">bottom</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033206"><a href="#local-6989586621679033206"><span class="hs-identifier">activeArr</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#tryit"><span class="hs-identifier hs-var">tryit</span></a><span> </span><span class="hs-string">&quot;tryPopL&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-291"></a><span>  </span><a name="local-6989586621679033207"><a href="#local-6989586621679033207"><span class="hs-identifier">b</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounter</span><span> </span><a href="#local-6989586621679033205"><span class="hs-identifier hs-var">bottom</span></a><span>
</span><a name="line-292"></a><span>  </span><a name="local-6989586621679033208"><a href="#local-6989586621679033208"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679033206"><span class="hs-identifier hs-var">activeArr</span></a><span>
</span><a name="line-293"></a><span>  </span><a name="local-6989586621679033209"><a href="#local-6989586621679033209"><span class="hs-identifier">b</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">evaluate</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033207"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>  </span><span class="hs-identifier hs-var">writeCounter</span><span> </span><a href="#local-6989586621679033205"><span class="hs-identifier hs-var">bottom</span></a><span> </span><a href="#local-6989586621679033209"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span>  </span><span class="hs-comment">-- very important that the following read of q-&gt;top does not occur</span><span>
</span><a name="line-297"></a><span>  </span><span class="hs-comment">-- before the earlier write to q-&gt;bottom.</span><span>
</span><a name="line-298"></a><span>  </span><span class="hs-identifier hs-var">storeLoadBarrier</span><span>
</span><a name="line-299"></a><span>  </span><span>
</span><a name="line-300"></a><span>  </span><a name="local-6989586621679033210"><a href="#local-6989586621679033210"><span class="hs-identifier">tt</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readCounterForCAS</span><span> </span><a href="#local-6989586621679033204"><span class="hs-identifier hs-var">top</span></a><span>
</span><a name="line-301"></a><span class="hs-comment">--  when (dbg &amp;&amp; b &lt; t) $ error$ &quot;tryPopL: INVARIANT BREAKAGE - bottom &lt; top: &quot;++ show (b,t)</span><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679033211"><a href="#local-6989586621679033211"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">peekCTicket</span><span> </span><a href="#local-6989586621679033210"><span class="hs-identifier hs-var">tt</span></a><span>
</span><a name="line-304"></a><span>      </span><a name="local-6989586621679033212"><a href="#local-6989586621679033212"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679033209"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679033211"><span class="hs-identifier hs-var">t</span></a><span> </span><span>
</span><a name="line-305"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679033212"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-306"></a><span>    </span><span class="hs-identifier hs-var">writeCounter</span><span> </span><a href="#local-6989586621679033205"><span class="hs-identifier hs-var">bottom</span></a><span> </span><a href="#local-6989586621679033211"><span class="hs-identifier hs-var">t</span></a><span> </span><span>
</span><a name="line-307"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-308"></a><span>   </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-309"></a><span>    </span><a name="local-6989586621679033213"><a href="#local-6989586621679033213"><span class="hs-identifier">obj</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Concurrent.Deque.ChaseLev.html#getCirc"><span class="hs-identifier hs-var">getCirc</span></a><span> </span><a href="#local-6989586621679033208"><span class="hs-identifier hs-var">arr</span></a><span> </span><a href="#local-6989586621679033209"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-310"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679033212"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-311"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679033213"><span class="hs-identifier hs-var">obj</span></a><span>
</span><a name="line-312"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-313"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679033214"><a href="#local-6989586621679033214"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033215"><a href="#local-6989586621679033215"><span class="hs-identifier">ol</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">casCounter</span><span> </span><a href="#local-6989586621679033204"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-6989586621679033210"><span class="hs-identifier hs-var">tt</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033211"><span class="hs-identifier hs-var">t</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>      </span><span class="hs-identifier hs-var">writeCounter</span><span> </span><a href="#local-6989586621679033205"><span class="hs-identifier hs-var">bottom</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033211"><span class="hs-identifier hs-var">t</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679033214"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679033213"><span class="hs-identifier hs-var">obj</span></a><span>
</span><a name="line-316"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-comment">------------------------------------------------------------</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-comment">-- My own forM for numeric ranges (not requiring deforestation optimizations).</span><span>
</span><a name="line-321"></a><span class="hs-comment">-- Inclusive start, exclusive end.</span><span>
</span><a name="line-322"></a><span class="hs-pragma">{-# INLINE for_ #-}</span><span>
</span><a name="line-323"></a><span class="hs-identifier">for_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679025347"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679025347"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679025347"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-324"></a><a name="for_"><a href="Data.Concurrent.Deque.ChaseLev.html#for_"><span class="hs-identifier">for_</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679033216"><a href="#local-6989586621679033216"><span class="hs-identifier">start</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679033217"><a href="#local-6989586621679033217"><span class="hs-identifier">end</span></a></a><span> </span><a name="local-6989586621679033218"><a href="#local-6989586621679033218"><span class="hs-identifier">_fn</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033216"><span class="hs-identifier hs-var">start</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679033217"><span class="hs-identifier hs-var">end</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;for_: start is greater than end&quot;</span><span>
</span><a name="line-325"></a><span class="hs-identifier">for_</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679033219"><a href="#local-6989586621679033219"><span class="hs-identifier">start</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679033220"><a href="#local-6989586621679033220"><span class="hs-identifier">end</span></a></a><span> </span><a name="local-6989586621679033221"><a href="#local-6989586621679033221"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679033222"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621679033219"><span class="hs-identifier hs-var">start</span></a><span>
</span><a name="line-326"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-327"></a><span>   </span><a name="local-6989586621679033222"><a href="#local-6989586621679033222"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679033223"><a href="#local-6989586621679033223"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033223"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679033220"><span class="hs-identifier hs-var">end</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>	   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier">fn</span><span> </span><span class="hs-identifier">i</span><span class="hs-special">;</span><span> </span><span class="hs-identifier">loop</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">i</span><a href="#local-6989586621679033222"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-329"></a></pre></body></html>