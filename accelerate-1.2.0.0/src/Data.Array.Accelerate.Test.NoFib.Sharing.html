<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds     #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Module      : Data.Array.Accelerate.Test.NoFib.Sharing</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Copyright   : [2009..2017] Trevor L. McDonell</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- License     : BSD3</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Maintainer  : Trevor L. McDonell &lt;tmcdonell@cse.unsw.edu.au&gt;</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Stability   : experimental</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- Portability : non-portable (GHC extensions)</span><span>
</span><a name="line-14"></a><span class="hs-comment">--</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Test</span><span class="hs-operator">.</span><span class="hs-identifier">NoFib</span><span class="hs-operator">.</span><span class="hs-identifier">Sharing</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>  </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_sharing"><span class="hs-identifier hs-var">test_sharing</span></a><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span></a><span>                                        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exp</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.Trafo.Sharing.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Trafo</span><span class="hs-operator">.</span><span class="hs-identifier">Sharing</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.Data.Bits.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bits</span></a><span>                              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">DeepSeq</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Test</span><span class="hs-operator">.</span><span class="hs-identifier">Tasty</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Test</span><span class="hs-operator">.</span><span class="hs-identifier">Tasty</span><span class="hs-operator">.</span><span class="hs-identifier">ExpectedFailure</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Test</span><span class="hs-operator">.</span><span class="hs-identifier">Tasty</span><span class="hs-operator">.</span><span class="hs-identifier">HUnit</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span>                                                      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">P</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exp</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-identifier">test_sharing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TestTree</span><span>
</span><a name="line-35"></a><a name="test_sharing"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_sharing"><span class="hs-identifier">test_sharing</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-identifier hs-var">testGroup</span><span> </span><span class="hs-string">&quot;sharing&quot;</span><span>
</span><a name="line-37"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">testCase</span><span>  </span><span class="hs-string">&quot;simple&quot;</span><span>                </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_simple"><span class="hs-identifier hs-var">test_simple</span></a><span>
</span><a name="line-38"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span>  </span><span class="hs-string">&quot;ordering&quot;</span><span>              </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_ordering"><span class="hs-identifier hs-var">test_ordering</span></a><span>
</span><a name="line-39"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span>  </span><span class="hs-string">&quot;sort&quot;</span><span>                  </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_sort"><span class="hs-identifier hs-var">test_sort</span></a><span>
</span><a name="line-40"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span>  </span><span class="hs-string">&quot;blowup&quot;</span><span>                </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_blowup"><span class="hs-identifier hs-var">test_blowup</span></a><span> </span><span class="hs-number">20</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span>  </span><span class="hs-string">&quot;bfs&quot;</span><span>                   </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_bfs"><span class="hs-identifier hs-var">test_bfs</span></a><span>
</span><a name="line-42"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testGroup</span><span> </span><span class="hs-string">&quot;same level&quot;</span><span>
</span><a name="line-43"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;1&quot;</span><span>                    </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_two_lets_same_level_1"><span class="hs-identifier hs-var">test_two_lets_same_level_1</span></a><span>
</span><a name="line-44"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;2&quot;</span><span>                    </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_two_lets_same_level_2"><span class="hs-identifier hs-var">test_two_lets_same_level_2</span></a><span>
</span><a name="line-45"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-46"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testGroup</span><span> </span><span class="hs-string">&quot;empty top&quot;</span><span>
</span><a name="line-47"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;1&quot;</span><span>                    </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_no_let_at_top_1"><span class="hs-identifier hs-var">test_no_let_at_top_1</span></a><span>
</span><a name="line-48"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;2&quot;</span><span>                    </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_no_let_at_top_2"><span class="hs-identifier hs-var">test_no_let_at_top_2</span></a><span>
</span><a name="line-49"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-50"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span>  </span><span class="hs-string">&quot;pipe&quot;</span><span>                  </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_pipe"><span class="hs-identifier hs-var">test_pipe</span></a><span>
</span><a name="line-51"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span>  </span><span class="hs-string">&quot;bound variables&quot;</span><span>       </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_bound_variables"><span class="hs-identifier hs-var">test_bound_variables</span></a><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span>  </span><span class="hs-string">&quot;big tuple&quot;</span><span>             </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482522"><span class="hs-identifier hs-var">sharingExp</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_big_tuple"><span class="hs-identifier hs-var">test_big_tuple</span></a><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testGroup</span><span> </span><span class="hs-string">&quot;iteration&quot;</span><span>
</span><a name="line-54"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;simple&quot;</span><span>               </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_iteration_simple"><span class="hs-identifier hs-var">test_iteration_simple</span></a><span>
</span><a name="line-55"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;outside&quot;</span><span>              </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_iteration_outside"><span class="hs-identifier hs-var">test_iteration_outside</span></a><span>
</span><a name="line-56"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;body and condition&quot;</span><span>   </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_iteration_body_condition"><span class="hs-identifier hs-var">test_iteration_body_condition</span></a><span>
</span><a name="line-57"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;awhile&quot;</span><span>               </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_awhile"><span class="hs-identifier hs-var">test_awhile</span></a><span>
</span><a name="line-58"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;iterate&quot;</span><span>              </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_iterate"><span class="hs-identifier hs-var">test_iterate</span></a><span>
</span><a name="line-59"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;nested&quot;</span><span>               </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482522"><span class="hs-identifier hs-var">sharingExp</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_nested_iteration"><span class="hs-identifier hs-var">test_nested_iteration</span></a><span>
</span><a name="line-60"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;unused&quot;</span><span>               </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482522"><span class="hs-identifier hs-var">sharingExp</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_unused_iteration"><span class="hs-identifier hs-var">test_unused_iteration</span></a><span>
</span><a name="line-61"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testGroup</span><span> </span><span class="hs-string">&quot;nested data-parallelism&quot;</span><span>
</span><a name="line-63"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">expectFail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">testCase</span><span> </span><span class="hs-string">&quot;mvm&quot;</span><span>     </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682482521"><span class="hs-identifier hs-var">sharingAcc</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_nested_data_praallelism"><span class="hs-identifier hs-var">test_nested_data_praallelism</span></a><span>
</span><a name="line-64"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-65"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-66"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-67"></a><span>    </span><span class="hs-identifier">sharingAcc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Arrays"><span class="hs-identifier hs-type">Arrays</span></a><span> </span><a href="#local-6989586621682482523"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><a href="#local-6989586621682482523"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Assertion</span><span>
</span><a name="line-68"></a><span>    </span><a name="local-6989586621682482521"><a href="#local-6989586621682482521"><span class="hs-identifier">sharingAcc</span></a></a><span> </span><a name="local-6989586621682482671"><a href="#local-6989586621682482671"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-69"></a><span>      </span><span class="hs-identifier hs-var">catch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rnf</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Trafo.Sharing.html#convertAcc"><span class="hs-identifier hs-var">convertAcc</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621682482671"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621682482672"><a href="#local-6989586621682482672"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">assertFailure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621682482672"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span>    </span><span class="hs-identifier">sharingExp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Elt"><span class="hs-identifier hs-type">Elt</span></a><span> </span><a href="#local-6989586621682482670"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><a href="#local-6989586621682482670"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Assertion</span><span>
</span><a name="line-73"></a><span>    </span><a name="local-6989586621682482522"><a href="#local-6989586621682482522"><span class="hs-identifier">sharingExp</span></a></a><span> </span><a name="local-6989586621682482673"><a href="#local-6989586621682482673"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-74"></a><span>      </span><span class="hs-identifier hs-var">catch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rnf</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Trafo.Sharing.html#convertExp"><span class="hs-identifier hs-var">convertExp</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621682482673"><span class="hs-identifier hs-var">exp</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621682482674"><a href="#local-6989586621682482674"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">assertFailure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621682482674"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-79"></a><span class="hs-comment">--</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- Some tests to make sure that sharing recovery is working.</span><span>
</span><a name="line-81"></a><span class="hs-comment">--</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-identifier">mkArray</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><a name="mkArray"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier">mkArray</span></a></a><span> </span><a name="local-6989586621682482675"><a href="#local-6989586621682482675"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#fromList"><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682482675"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-identifier">test_blowup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><a name="test_blowup"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_blowup"><span class="hs-identifier">test_blowup</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier hs-var">mkArray</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span class="hs-identifier">test_blowup</span><span> </span><a name="local-6989586621682482676"><a href="#local-6989586621682482676"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482677"><span class="hs-identifier hs-var">newArr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Lift.html#lift"><span class="hs-identifier hs-var">lift</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-glyph">::</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span>
</span><a name="line-89"></a><span>                             </span><a href="#local-6989586621682482677"><span class="hs-identifier hs-var">newArr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Lift.html#lift"><span class="hs-identifier hs-var">lift</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-glyph">::</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier hs-var">mkArray</span></a><span> </span><a href="#local-6989586621682482676"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-91"></a><span>    </span><a name="local-6989586621682482677"><a href="#local-6989586621682482677"><span class="hs-identifier">newArr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_blowup"><span class="hs-identifier hs-var">test_blowup</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682482676"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-identifier">idx</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span>
</span><a name="line-94"></a><a name="idx"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier">idx</span></a></a><span> </span><a name="local-6989586621682482678"><a href="#local-6989586621682482678"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Lift.html#lift"><span class="hs-identifier hs-var">lift</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><a href="#local-6989586621682482678"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-identifier">test_bfs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><a name="test_bfs"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_bfs"><span class="hs-identifier">test_bfs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482684"><a href="#local-6989586621682482684"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682482680"><span class="hs-identifier hs-var">map2</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span>  </span><span class="hs-special">(</span><a href="#local-6989586621682482679"><span class="hs-identifier hs-var">map1</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482684"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482681"><span class="hs-identifier hs-var">arr</span></a><span>
</span><a name="line-98"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-identifier">map1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>    </span><a name="local-6989586621682482679"><a href="#local-6989586621682482679"><span class="hs-identifier">map1</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482682"><a href="#local-6989586621682482682"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682482680"><span class="hs-identifier hs-var">map2</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482682"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482681"><span class="hs-identifier hs-var">arr</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span>    </span><span class="hs-identifier">map2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>    </span><a name="local-6989586621682482680"><a href="#local-6989586621682482680"><span class="hs-identifier">map2</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482683"><a href="#local-6989586621682482683"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482683"><span class="hs-identifier hs-var">z</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482681"><span class="hs-identifier hs-var">arr</span></a><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span>    </span><span class="hs-identifier">arr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>    </span><a name="local-6989586621682482681"><a href="#local-6989586621682482681"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier hs-var">mkArray</span></a><span> </span><span class="hs-number">666</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-identifier">test_two_lets_same_level_1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-109"></a><a name="test_two_lets_same_level_1"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_two_lets_same_level_1"><span class="hs-identifier">test_two_lets_same_level_1</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-110"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682482685"><a href="#local-6989586621682482685"><span class="hs-identifier">arr1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier hs-var">mkArray</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682482686"><a href="#local-6989586621682482686"><span class="hs-identifier">arr2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier hs-var">mkArray</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-112"></a><span>     </span><span class="hs-keyword">in</span><span>  </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482685"><span class="hs-identifier hs-var">arr1</span></a><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482685"><span class="hs-identifier hs-var">arr1</span></a><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482686"><span class="hs-identifier hs-var">arr2</span></a><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482686"><span class="hs-identifier hs-var">arr2</span></a><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier hs-var">mkArray</span></a><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-identifier">test_two_lets_same_level_2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><a name="test_two_lets_same_level_2"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_two_lets_same_level_2"><span class="hs-identifier">test_two_lets_same_level_2</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-116"></a><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682482687"><a href="#local-6989586621682482687"><span class="hs-identifier">arr2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier hs-var">mkArray</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-117"></a><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682482688"><a href="#local-6989586621682482688"><span class="hs-identifier">arr1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier hs-var">mkArray</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-118"></a><span>    </span><span class="hs-keyword">in</span><span>  </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482688"><span class="hs-identifier hs-var">arr1</span></a><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482688"><span class="hs-identifier hs-var">arr1</span></a><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482687"><span class="hs-identifier hs-var">arr2</span></a><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482687"><span class="hs-identifier hs-var">arr2</span></a><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier hs-var">mkArray</span></a><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-comment">-- These two programs test that lets can be introduced not just at the top of a AST</span><span>
</span><a name="line-122"></a><span class="hs-comment">-- but in intermediate nodes.</span><span>
</span><a name="line-123"></a><span class="hs-comment">--</span><span>
</span><a name="line-124"></a><span class="hs-identifier">test_no_let_at_top_1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-125"></a><a name="test_no_let_at_top_1"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_no_let_at_top_1"><span class="hs-identifier">test_no_let_at_top_1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482689"><a href="#local-6989586621682482689"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482689"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_bfs"><span class="hs-identifier hs-var">test_bfs</span></a><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-identifier">test_no_let_at_top_2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-128"></a><a name="test_no_let_at_top_2"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_no_let_at_top_2"><span class="hs-identifier">test_no_let_at_top_2</span></a></a><span>
</span><a name="line-129"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482690"><a href="#local-6989586621682482690"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482690"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482691"><a href="#local-6989586621682482691"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482691"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_bfs"><span class="hs-identifier hs-var">test_bfs</span></a><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-comment">--</span><span>
</span><a name="line-133"></a><span class="hs-comment">--</span><span>
</span><a name="line-134"></a><span class="hs-comment">--</span><span>
</span><a name="line-135"></a><span class="hs-identifier">test_simple</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><a name="test_simple"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_simple"><span class="hs-identifier">test_simple</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482694"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><a href="#local-6989586621682482693"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-137"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-138"></a><span>    </span><a name="local-6989586621682482692"><a href="#local-6989586621682482692"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#fromList"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-139"></a><span>    </span><a name="local-6989586621682482693"><a href="#local-6989586621682482693"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482692"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-140"></a><span>    </span><a name="local-6989586621682482694"><a href="#local-6989586621682482694"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#zip"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-6989586621682482693"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621682482692"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- sortKey is a real program that Ben Lever wrote. It has some pretty interesting</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- sharing going on.</span><span>
</span><a name="line-145"></a><span class="hs-comment">--</span><span>
</span><a name="line-146"></a><span class="hs-identifier">sortKey</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Elt"><span class="hs-identifier hs-type">Elt</span></a><span> </span><a href="#local-6989586621682482520"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><a href="#local-6989586621682482520"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- ^mapping function to produce key array from input array</span><span>
</span><a name="line-148"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><a href="#local-6989586621682482520"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><a href="#local-6989586621682482520"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-150"></a><a name="sortKey"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#sortKey"><span class="hs-identifier">sortKey</span></a></a><span> </span><a name="local-6989586621682482695"><a href="#local-6989586621682482695"><span class="hs-identifier">keyFun</span></a></a><span> </span><a name="local-6989586621682482696"><a href="#local-6989586621682482696"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">foldl</span><span> </span><a href="#local-6989586621682482697"><span class="hs-identifier hs-var">sortOneBit</span></a><span> </span><a href="#local-6989586621682482696"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">P</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Array.Accelerate.Lift.html#lift"><span class="hs-identifier hs-var">lift</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-number">31</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-152"></a><span>    </span><a name="local-6989586621682482697"><a href="#local-6989586621682482697"><span class="hs-identifier">sortOneBit</span></a></a><span> </span><a name="local-6989586621682482699"><a href="#local-6989586621682482699"><span class="hs-identifier">inArr</span></a></a><span> </span><a name="local-6989586621682482700"><a href="#local-6989586621682482700"><span class="hs-identifier">bitNum</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682482708"><span class="hs-identifier hs-var">outArr</span></a><span>
</span><a name="line-153"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-154"></a><span>        </span><a name="local-6989586621682482701"><a href="#local-6989586621682482701"><span class="hs-identifier">keys</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621682482695"><span class="hs-identifier hs-var">keyFun</span></a><span> </span><a href="#local-6989586621682482699"><span class="hs-identifier hs-var">inArr</span></a><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span>        </span><a name="local-6989586621682482702"><a href="#local-6989586621682482702"><span class="hs-identifier">bits</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482709"><a href="#local-6989586621682482709"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Data.Bits.html#testBit"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">testBit</span></a><span> </span><a href="#local-6989586621682482709"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621682482700"><span class="hs-identifier hs-var">bitNum</span></a><span class="hs-special">)</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#%3F"><span class="hs-operator hs-var">?</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482701"><span class="hs-identifier hs-var">keys</span></a><span>
</span><a name="line-157"></a><span>        </span><a name="local-6989586621682482703"><a href="#local-6989586621682482703"><span class="hs-identifier">bitsInv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482710"><a href="#local-6989586621682482710"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682482710"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="Data.Array.Accelerate.Classes.Eq.html#%3D%3D"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.==</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#%3F"><span class="hs-operator hs-var">?</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482702"><span class="hs-identifier hs-var">bits</span></a><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682482704"><a href="#local-6989586621682482704"><span class="hs-identifier">falses</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682482705"><a href="#local-6989586621682482705"><span class="hs-identifier">numZeroes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Lift.html#unlift"><span class="hs-identifier hs-var">unlift</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#scanl%27"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">scanl'</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621682482703"><span class="hs-identifier hs-var">bitsInv</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>        </span><a name="local-6989586621682482706"><a href="#local-6989586621682482706"><span class="hs-identifier">trues</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482711"><a href="#local-6989586621682482711"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Prelude.html#the"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">the</span></a><span> </span><a href="#local-6989586621682482705"><span class="hs-identifier hs-var">numZeroes</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Prelude.html#fst"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-6989586621682482711"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Prelude.html#snd"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="#local-6989586621682482711"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>                            </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#zip"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-6989586621682482698"><span class="hs-identifier hs-var">ixs</span></a><span> </span><a href="#local-6989586621682482704"><span class="hs-identifier hs-var">falses</span></a><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span>        </span><a name="local-6989586621682482707"><a href="#local-6989586621682482707"><span class="hs-identifier">dstIxs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482712"><a href="#local-6989586621682482712"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682482713"><a href="#local-6989586621682482713"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682482714"><a href="#local-6989586621682482714"><span class="hs-identifier">t</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682482715"><a href="#local-6989586621682482715"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Lift.html#unlift"><span class="hs-identifier hs-var">unlift</span></a><span> </span><a href="#local-6989586621682482712"><span class="hs-identifier hs-var">x</span></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682482713"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="Data.Array.Accelerate.Classes.Eq.html#%3D%3D"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.==</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Smart.html#constant"><span class="hs-identifier hs-var">constant</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-glyph">::</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#%3F"><span class="hs-operator hs-var">?</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682482715"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682482714"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>               </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#zip3"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zip3</span></a><span> </span><a href="#local-6989586621682482702"><span class="hs-identifier hs-var">bits</span></a><span> </span><a href="#local-6989586621682482706"><span class="hs-identifier hs-var">trues</span></a><span> </span><a href="#local-6989586621682482704"><span class="hs-identifier hs-var">falses</span></a><span>
</span><a name="line-165"></a><span>        </span><a name="local-6989586621682482708"><a href="#local-6989586621682482708"><span class="hs-identifier">outArr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#scatter"><span class="hs-identifier hs-var">scatter</span></a><span> </span><a href="#local-6989586621682482707"><span class="hs-identifier hs-var">dstIxs</span></a><span> </span><a href="#local-6989586621682482699"><span class="hs-identifier hs-var">inArr</span></a><span> </span><a href="#local-6989586621682482699"><span class="hs-identifier hs-var">inArr</span></a><span> </span><span class="hs-comment">-- just use input as default array</span><span>
</span><a name="line-166"></a><span>                                            </span><span class="hs-comment">--(we're writing over everything anyway)</span><span>
</span><a name="line-167"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-168"></a><span>    </span><a name="local-6989586621682482698"><a href="#local-6989586621682482698"><span class="hs-identifier">ixs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#enumeratedArray"><span class="hs-identifier hs-var">enumeratedArray</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#shape"><span class="hs-identifier hs-var">shape</span></a><span> </span><a href="#local-6989586621682482696"><span class="hs-identifier hs-var">arr</span></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">-- Create an array where each element is the value of its corresponding</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- row-major index.</span><span>
</span><a name="line-172"></a><span class="hs-comment">--</span><span>
</span><a name="line-173"></a><span class="hs-identifier">enumeratedArray</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-174"></a><a name="enumeratedArray"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#enumeratedArray"><span class="hs-identifier">enumeratedArray</span></a></a><span> </span><a name="local-6989586621682482716"><a href="#local-6989586621682482716"><span class="hs-identifier">sh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#generate"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">generate</span></a><span> </span><a href="#local-6989586621682482716"><span class="hs-identifier hs-var">sh</span></a><span> </span><a href="Data.Array.Accelerate.Prelude.html#unindex1"><span class="hs-identifier hs-var">unindex1</span></a><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-identifier">test_sort</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><a name="test_sort"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_sort"><span class="hs-identifier">test_sort</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#sortKey"><span class="hs-identifier hs-var">sortKey</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#fromList"><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">9</span><span class="hs-special">,</span><span class="hs-number">8</span><span class="hs-special">,</span><span class="hs-number">7</span><span class="hs-special">,</span><span class="hs-number">6</span><span class="hs-special">,</span><span class="hs-number">5</span><span class="hs-special">,</span><span class="hs-number">4</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">,</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">]</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-comment">-- map1 has children map3 and map2.</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- map2 has child map3.</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- Back when we still used a list for the NodeCounts data structure this mean that</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- you would be merging [1,3,2] with [2,3] which violated precondition of (+++).</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- This tests that the new algorithm works just fine on this.</span><span>
</span><a name="line-184"></a><span class="hs-comment">--</span><span>
</span><a name="line-185"></a><span class="hs-identifier">test_ordering</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM1"><span class="hs-identifier hs-type">DIM1</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-186"></a><a name="test_ordering"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_ordering"><span class="hs-identifier">test_ordering</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482717"><span class="hs-identifier hs-var">map1</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482718"><span class="hs-identifier hs-var">map2</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482720"><span class="hs-identifier hs-var">arr</span></a><span>
</span><a name="line-187"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-188"></a><span>    </span><a name="local-6989586621682482717"><a href="#local-6989586621682482717"><span class="hs-identifier">map1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482719"><span class="hs-identifier hs-var">map3</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482718"><span class="hs-identifier hs-var">map2</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482720"><span class="hs-identifier hs-var">arr</span></a><span>
</span><a name="line-189"></a><span>    </span><a name="local-6989586621682482718"><a href="#local-6989586621682482718"><span class="hs-identifier">map2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482719"><span class="hs-identifier hs-var">map3</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#idx"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482720"><span class="hs-identifier hs-var">arr</span></a><span>
</span><a name="line-190"></a><span>    </span><a name="local-6989586621682482719"><a href="#local-6989586621682482719"><span class="hs-identifier">map3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482720"><span class="hs-identifier hs-var">arr</span></a><span>
</span><a name="line-191"></a><span>    </span><a name="local-6989586621682482720"><a href="#local-6989586621682482720"><span class="hs-identifier">arr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#mkArray"><span class="hs-identifier hs-var">mkArray</span></a><span> </span><span class="hs-number">42</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span class="hs-comment">-- Tests array-valued lambdas in conjunction with sharing recovery.</span><span>
</span><a name="line-195"></a><span class="hs-comment">--</span><span>
</span><a name="line-196"></a><span class="hs-identifier">test_pipe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><a name="test_pipe"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_pipe"><span class="hs-identifier">test_pipe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682482723"><span class="hs-identifier hs-var">acc1</span></a><span> </span><a href="Data.Array.Accelerate.Language.html#%3E-%3E"><span class="hs-operator hs-var">&gt;-&gt;</span></a><span> </span><a href="#local-6989586621682482724"><span class="hs-identifier hs-var">acc2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482722"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-198"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-199"></a><span>    </span><span class="hs-identifier">z</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>    </span><a name="local-6989586621682482721"><a href="#local-6989586621682482721"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#unit"><span class="hs-identifier hs-var">unit</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>    </span><span class="hs-identifier">xs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>    </span><a name="local-6989586621682482722"><a href="#local-6989586621682482722"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#fromList"><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span>    </span><span class="hs-identifier">acc1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>    </span><a name="local-6989586621682482723"><a href="#local-6989586621682482723"><span class="hs-identifier">acc1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#the"><span class="hs-identifier hs-var">the</span></a><span> </span><a href="#local-6989586621682482721"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span>    </span><span class="hs-identifier">acc2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>    </span><a name="local-6989586621682482724"><a href="#local-6989586621682482724"><span class="hs-identifier">acc2</span></a></a><span> </span><a name="local-6989586621682482725"><a href="#local-6989586621682482725"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682482726"><a href="#local-6989586621682482726"><span class="hs-identifier">arr2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#fromList"><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">10</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-210"></a><span>               </span><span class="hs-keyword">in</span><span>  </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482726"><span class="hs-identifier hs-var">arr2</span></a><span class="hs-glyph">!</span><a href="Data.Array.Accelerate.Smart.html#constant"><span class="hs-identifier hs-var">constant</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-glyph">::</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Prelude.html#zip"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-6989586621682482725"><span class="hs-identifier hs-var">arr</span></a><span> </span><a href="#local-6989586621682482726"><span class="hs-identifier hs-var">arr2</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-comment">-- Test for bound variables</span><span>
</span><a name="line-214"></a><span class="hs-comment">--</span><span>
</span><a name="line-215"></a><span class="hs-identifier">test_bound_variables</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM2"><span class="hs-identifier hs-type">DIM2</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM2"><span class="hs-identifier hs-type">DIM2</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM2"><span class="hs-identifier hs-type">DIM2</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span class="hs-special">)</span><span>
</span><a name="line-216"></a><a name="test_bound_variables"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_bound_variables"><span class="hs-identifier">test_bound_variables</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Lift.html#lift"><span class="hs-identifier hs-var">lift</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682482729"><span class="hs-identifier hs-var">first</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682482730"><span class="hs-identifier hs-var">both</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682482731"><span class="hs-identifier hs-var">second</span></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-218"></a><span>    </span><span class="hs-identifier">is</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM2"><span class="hs-identifier hs-type">DIM2</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-219"></a><span>    </span><a name="local-6989586621682482727"><a href="#local-6989586621682482727"><span class="hs-identifier">is</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#fromList"><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>    </span><span class="hs-identifier">fs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM2"><span class="hs-identifier hs-type">DIM2</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-222"></a><span>    </span><a name="local-6989586621682482728"><a href="#local-6989586621682482728"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#fromList"><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span>    </span><span class="hs-comment">-- Ignoring the first parameter</span><span>
</span><a name="line-225"></a><span>    </span><a name="local-6989586621682482729"><a href="#local-6989586621682482729"><span class="hs-identifier">first</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#stencil2"><span class="hs-identifier hs-var">stencil2</span></a><span> </span><a href="#local-6989586621682482732"><span class="hs-identifier hs-var">centre</span></a><span> </span><a href="Data.Array.Accelerate.Language.html#clamp"><span class="hs-identifier hs-var">clamp</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><a href="#local-6989586621682482728"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span> </span><a href="Data.Array.Accelerate.Language.html#clamp"><span class="hs-identifier hs-var">clamp</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><a href="#local-6989586621682482727"><span class="hs-identifier hs-var">is</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-227"></a><span>        </span><span class="hs-identifier">centre</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Language.html#Stencil3x3"><span class="hs-identifier hs-type">Stencil3x3</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Language.html#Stencil3x3"><span class="hs-identifier hs-type">Stencil3x3</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-228"></a><span>        </span><a name="local-6989586621682482732"><a href="#local-6989586621682482732"><span class="hs-identifier">centre</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682482733"><a href="#local-6989586621682482733"><span class="hs-identifier">y</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682482733"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>    </span><span class="hs-comment">-- Using both</span><span>
</span><a name="line-231"></a><span>    </span><a name="local-6989586621682482730"><a href="#local-6989586621682482730"><span class="hs-identifier">both</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#stencil2"><span class="hs-identifier hs-var">stencil2</span></a><span> </span><a href="#local-6989586621682482734"><span class="hs-identifier hs-var">centre</span></a><span> </span><a href="Data.Array.Accelerate.Language.html#clamp"><span class="hs-identifier hs-var">clamp</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><a href="#local-6989586621682482728"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span> </span><a href="Data.Array.Accelerate.Language.html#clamp"><span class="hs-identifier hs-var">clamp</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><a href="#local-6989586621682482727"><span class="hs-identifier hs-var">is</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-233"></a><span>        </span><span class="hs-identifier">centre</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Language.html#Stencil3x3"><span class="hs-identifier hs-type">Stencil3x3</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Language.html#Stencil3x3"><span class="hs-identifier hs-type">Stencil3x3</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-234"></a><span>        </span><a name="local-6989586621682482734"><a href="#local-6989586621682482734"><span class="hs-identifier">centre</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682482735"><a href="#local-6989586621682482735"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682482736"><a href="#local-6989586621682482736"><span class="hs-identifier">y</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682482735"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="Data.Array.Accelerate.Classes.FromIntegral.html#fromIntegral"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621682482736"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span>    </span><span class="hs-comment">-- Not using the second parameter</span><span>
</span><a name="line-237"></a><span>    </span><a name="local-6989586621682482731"><a href="#local-6989586621682482731"><span class="hs-identifier">second</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#stencil2"><span class="hs-identifier hs-var">stencil2</span></a><span> </span><a href="#local-6989586621682482737"><span class="hs-identifier hs-var">centre</span></a><span> </span><a href="Data.Array.Accelerate.Language.html#clamp"><span class="hs-identifier hs-var">clamp</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><a href="#local-6989586621682482728"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span> </span><a href="Data.Array.Accelerate.Language.html#clamp"><span class="hs-identifier hs-var">clamp</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><a href="#local-6989586621682482727"><span class="hs-identifier hs-var">is</span></a><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-239"></a><span>        </span><span class="hs-identifier">centre</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Language.html#Stencil3x3"><span class="hs-identifier hs-type">Stencil3x3</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Language.html#Stencil3x3"><span class="hs-identifier hs-type">Stencil3x3</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-240"></a><span>        </span><a name="local-6989586621682482737"><a href="#local-6989586621682482737"><span class="hs-identifier">centre</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682482738"><a href="#local-6989586621682482738"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682482738"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-comment">-- Test for 8 and 9 tuples</span><span>
</span><a name="line-243"></a><span class="hs-comment">--</span><span>
</span><a name="line-244"></a><span class="hs-identifier">test_big_tuple</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-245"></a><a name="test_big_tuple"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_big_tuple"><span class="hs-identifier">test_big_tuple</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Lift.html#lift"><span class="hs-identifier hs-var">lift</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Smart.html#constant"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">constant</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Smart.html#constant"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">constant</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-comment">{--
-- Tests for sharing recovery of iteration
--
iteration :: Test
iteration = testGroup &quot;iteration&quot;
  [
    iter &quot;simple&quot;             test1
  , iter &quot;outside&quot;            test2
  , iter &quot;body and condition&quot; test3
  , iter &quot;awhile&quot;             awhile_test
  , iter &quot;iterate&quot;            iterate_test
  , iter &quot;nested&quot;             nested
  , iter &quot;unused&quot;             unused
  ]
  where
    iter :: Show a =&gt; TestName -&gt; a -&gt; Test
    iter name acc = testCase name (P.length (show acc) `seq` return ())
--}</span><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span class="hs-identifier">v1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span class="hs-special">)</span><span>
</span><a name="line-267"></a><a name="v1"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#v1"><span class="hs-identifier">v1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#fromList"><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-identifier">test_iteration_simple</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span class="hs-special">)</span><span>
</span><a name="line-270"></a><a name="test_iteration_simple"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_iteration_simple"><span class="hs-identifier">test_iteration_simple</span></a></a><span>
</span><a name="line-271"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#v1"><span class="hs-identifier hs-var">v1</span></a><span>
</span><a name="line-272"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682482739"><a href="#local-6989586621682482739"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Language.html#while"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">while</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Classes.Ord.html#%3C"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.&lt;</span></a><span> </span><a href="#local-6989586621682482739"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span class="hs-identifier">test_iteration_outside</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span class="hs-special">)</span><span>
</span><a name="line-275"></a><a name="test_iteration_outside"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_iteration_outside"><span class="hs-identifier">test_iteration_outside</span></a></a><span>
</span><a name="line-276"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#v1"><span class="hs-identifier hs-var">v1</span></a><span>
</span><a name="line-277"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682482740"><a href="#local-6989586621682482740"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682482741"><a href="#local-6989586621682482741"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span class="hs-operator hs-var">*</span><span class="hs-identifier hs-var">pi</span><span>
</span><a name="line-278"></a><span>          </span><span class="hs-keyword">in</span><span>  </span><a href="#local-6989586621682482741"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="Data.Array.Accelerate.Language.html#while"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">while</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Classes.Ord.html#%3C"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.&lt;</span></a><span> </span><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><a href="#local-6989586621682482741"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482740"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-identifier">test_iteration_body_condition</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span class="hs-special">)</span><span>
</span><a name="line-281"></a><a name="test_iteration_body_condition"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_iteration_body_condition"><span class="hs-identifier">test_iteration_body_condition</span></a></a><span>
</span><a name="line-282"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#v1"><span class="hs-identifier hs-var">v1</span></a><span>
</span><a name="line-283"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682482742"><a href="#local-6989586621682482742"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Language.html#while"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">while</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Classes.Ord.html#%3C"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.&lt;</span></a><span> </span><a href="#local-6989586621682482742"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><a href="#local-6989586621682482742"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span class="hs-identifier">test_awhile</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span class="hs-special">)</span><span>
</span><a name="line-286"></a><a name="test_awhile"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_awhile"><span class="hs-identifier">test_awhile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#awhile"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">awhile</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482743"><a href="#local-6989586621682482743"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Language.html#unit"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unit</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Prelude.html#the"><span class="hs-identifier hs-var">the</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Prelude.html#sum"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">sum</span></a><span> </span><a href="#local-6989586621682482743"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><a href="Data.Array.Accelerate.Classes.Ord.html#%3C"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.&lt;</span></a><span> </span><span class="hs-number">200</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#v1"><span class="hs-identifier hs-var">v1</span></a><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span class="hs-identifier">test_iterate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span class="hs-special">)</span><span>
</span><a name="line-289"></a><a name="test_iterate"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_iterate"><span class="hs-identifier">test_iterate</span></a></a><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Data.Array.Accelerate.Language.html#map"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#v1"><span class="hs-identifier hs-var">v1</span></a><span>
</span><a name="line-291"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682482744"><a href="#local-6989586621682482744"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682482745"><a href="#local-6989586621682482745"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span class="hs-operator hs-var">*</span><a href="#local-6989586621682482744"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-292"></a><span>          </span><span class="hs-keyword">in</span><span>  </span><a href="#local-6989586621682482745"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#iterate"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">iterate</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Smart.html#constant"><span class="hs-identifier hs-var">constant</span></a><span> </span><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482746"><a href="#local-6989586621682482746"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482745"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482746"><span class="hs-identifier hs-var">x'</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482744"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-identifier">test_for</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Elt"><span class="hs-identifier hs-type">Elt</span></a><span> </span><a href="#local-6989586621682482519"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><a href="#local-6989586621682482519"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><a href="#local-6989586621682482519"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><a href="#local-6989586621682482519"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><a href="#local-6989586621682482519"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-295"></a><a name="test_for"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_for"><span class="hs-identifier">test_for</span></a></a><span> </span><a name="local-6989586621682482747"><a href="#local-6989586621682482747"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682482748"><a href="#local-6989586621682482748"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682482749"><a href="#local-6989586621682482749"><span class="hs-identifier">seed</span></a></a><span>
</span><a name="line-296"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#snd"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">snd</span></a><span>
</span><a name="line-297"></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#iterate"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">iterate</span></a><span> </span><a href="#local-6989586621682482747"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482750"><a href="#local-6989586621682482750"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682482751"><a href="#local-6989586621682482751"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682482752"><a href="#local-6989586621682482752"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Lift.html#unlift"><span class="hs-identifier hs-var">unlift</span></a><span> </span><a href="#local-6989586621682482750"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-298"></a><span>                       </span><span class="hs-keyword">in</span><span>  </span><a href="Data.Array.Accelerate.Lift.html#lift"><span class="hs-identifier hs-var">lift</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682482751"><span class="hs-identifier hs-var">i</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682482748"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682482751"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621682482752"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>                </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Lift.html#lift"><span class="hs-identifier hs-var">lift</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Smart.html#constant"><span class="hs-identifier hs-var">constant</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682482749"><span class="hs-identifier hs-var">seed</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span class="hs-identifier">test_nested_iteration</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-302"></a><a name="test_nested_iteration"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_nested_iteration"><span class="hs-identifier">test_nested_iteration</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-303"></a><span>  </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_for"><span class="hs-identifier hs-var">test_for</span></a><span> </span><span class="hs-number">64</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482753"><a href="#local-6989586621682482753"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-304"></a><span>    </span><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_for"><span class="hs-identifier hs-var">test_for</span></a><span> </span><span class="hs-number">64</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482754"><a href="#local-6989586621682482754"><span class="hs-identifier">j</span></a></a><span> </span><a name="local-6989586621682482755"><a href="#local-6989586621682482755"><span class="hs-identifier">acc'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682482753"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482754"><span class="hs-identifier hs-var">j</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682482755"><span class="hs-identifier hs-var">acc'</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span class="hs-identifier">test_unused_iteration</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-307"></a><a name="test_unused_iteration"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_unused_iteration"><span class="hs-identifier">test_unused_iteration</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-308"></a><span>  </span><a href="Data.Array.Accelerate.Language.html#while"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">while</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Classes.Eq.html#%3D%3D"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.==</span></a><span> </span><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">-- This program contains nested data-parallelism and thus sharing recovery</span><span>
</span><a name="line-313"></a><span class="hs-comment">-- will fail.</span><span>
</span><a name="line-314"></a><span class="hs-comment">--</span><span>
</span><a name="line-315"></a><span class="hs-identifier">test_nested_data_praallelism</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><span class="hs-identifier hs-type">Float</span><span class="hs-special">)</span><span>
</span><a name="line-316"></a><a name="test_nested_data_praallelism"><a href="Data.Array.Accelerate.Test.NoFib.Sharing.html#test_nested_data_praallelism"><span class="hs-identifier">test_nested_data_praallelism</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-317"></a><span>  </span><a href="#local-6989586621682482758"><span class="hs-identifier hs-var">mvm</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#fromList"><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#use"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#fromList"><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-319"></a><span>    </span><span class="hs-identifier">dotp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Classes.Num.html#Num"><span class="hs-identifier hs-type">A</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Num</span></a><span> </span><a href="#local-6989586621682482759"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><a href="#local-6989586621682482759"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><a href="#local-6989586621682482759"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a><span> </span><a href="#local-6989586621682482759"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>    </span><a name="local-6989586621682482756"><a href="#local-6989586621682482756"><span class="hs-identifier">dotp</span></a></a><span> </span><a name="local-6989586621682482762"><a href="#local-6989586621682482762"><span class="hs-identifier">xs</span></a></a><span> </span><a name="local-6989586621682482763"><a href="#local-6989586621682482763"><span class="hs-identifier">ys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Language.html#fold"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fold</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.Language.html#zipWith"><span class="hs-identifier hs-var">A</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">*</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482762"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621682482763"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span>    </span><span class="hs-identifier">takeRow</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Elt"><span class="hs-identifier hs-type">Elt</span></a><span> </span><a href="#local-6989586621682482760"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM2"><span class="hs-identifier hs-type">DIM2</span></a><span> </span><a href="#local-6989586621682482760"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><a href="#local-6989586621682482760"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>    </span><a name="local-6989586621682482757"><a href="#local-6989586621682482757"><span class="hs-identifier">takeRow</span></a></a><span> </span><a name="local-6989586621682482764"><a href="#local-6989586621682482764"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682482765"><a href="#local-6989586621682482765"><span class="hs-identifier">mat</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-324"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span> </span><a name="local-6989586621682482766"><a href="#local-6989586621682482766"><span class="hs-identifier">cols</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Lift.html#unlift"><span class="hs-identifier hs-var">unlift</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#shape"><span class="hs-identifier hs-var">shape</span></a><span> </span><a href="#local-6989586621682482765"><span class="hs-identifier hs-var">mat</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-type">Z</span></a><span class="hs-operator">:.</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-operator">:.</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-325"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="Data.Array.Accelerate.Language.html#backpermute"><span class="hs-identifier hs-var">backpermute</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Prelude.html#index1"><span class="hs-identifier hs-var">index1</span></a><span> </span><a href="#local-6989586621682482766"><span class="hs-identifier hs-var">cols</span></a><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>                     </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482767"><a href="#local-6989586621682482767"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#index2"><span class="hs-identifier hs-var">index2</span></a><span> </span><a href="#local-6989586621682482764"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Prelude.html#unindex1"><span class="hs-identifier hs-var">unindex1</span></a><span> </span><a href="#local-6989586621682482767"><span class="hs-identifier hs-var">ix</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>                     </span><a href="#local-6989586621682482765"><span class="hs-identifier hs-var">mat</span></a><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span>    </span><span class="hs-identifier">mvm</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Classes.Num.html#Num"><span class="hs-identifier hs-type">A</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Num</span></a><span> </span><a href="#local-6989586621682482761"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Array"><span class="hs-identifier hs-type">Array</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#DIM2"><span class="hs-identifier hs-type">DIM2</span></a><span> </span><a href="#local-6989586621682482761"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><a href="#local-6989586621682482761"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Array.Sugar.html#Vector"><span class="hs-identifier hs-type">Vector</span></a><span> </span><a href="#local-6989586621682482761"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>    </span><a name="local-6989586621682482758"><a href="#local-6989586621682482758"><span class="hs-identifier">mvm</span></a></a><span> </span><a name="local-6989586621682482768"><a href="#local-6989586621682482768"><span class="hs-identifier">mat</span></a></a><span> </span><a name="local-6989586621682482769"><a href="#local-6989586621682482769"><span class="hs-identifier">vec</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-331"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-var">Z</span></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span> </span><a name="local-6989586621682482770"><a href="#local-6989586621682482770"><span class="hs-identifier">rows</span></a></a><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#%3A."><span class="hs-operator hs-var">:.</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.Lift.html#unlift"><span class="hs-identifier hs-var">unlift</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Language.html#shape"><span class="hs-identifier hs-var">shape</span></a><span> </span><a href="#local-6989586621682482768"><span class="hs-identifier hs-var">mat</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.Array.Sugar.html#Z"><span class="hs-identifier hs-type">Z</span></a><span> </span><span class="hs-operator">:.</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-operator">:.</span><span> </span><a href="Data.Array.Accelerate.Smart.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-332"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="Data.Array.Accelerate.Language.html#generate"><span class="hs-identifier hs-var">generate</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Prelude.html#index1"><span class="hs-identifier hs-var">index1</span></a><span> </span><a href="#local-6989586621682482770"><span class="hs-identifier hs-var">rows</span></a><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>                  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682482771"><a href="#local-6989586621682482771"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.Prelude.html#the"><span class="hs-identifier hs-var">the</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682482769"><span class="hs-identifier hs-var">vec</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621682482756"><span class="hs-identifier hs-var">dotp</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682482757"><span class="hs-identifier hs-var">takeRow</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.Prelude.html#unindex1"><span class="hs-identifier hs-var">unindex1</span></a><span> </span><a href="#local-6989586621682482771"><span class="hs-identifier hs-var">ix</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682482768"><span class="hs-identifier hs-var">mat</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a></pre></body></html>