<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                      #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ForeignFunctionInterface #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell          #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators            #-}</span><span>
</span><a name="line-5"></a><span class="hs-cpp">#ifdef ACCELERATE_DEBUG</span><span>
</span><a name="line-6"></a><span class="hs-cpp">#if __GLASGOW_HASKELL &gt;= 800</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-redundant-constraints #-}</span><span>
</span><a name="line-8"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-9"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-unused-binds   #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-unused-do-bind #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-unused-imports #-}</span><span>
</span><a name="line-13"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- Module      : Data.Array.Accelerate.Debug.Flags</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- Copyright   : [2008..2017] Manuel M T Chakravarty, Gabriele Keller</span><span>
</span><a name="line-17"></a><span class="hs-comment">--               [2009..2017] Trevor L. McDonell</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- License     : BSD3</span><span>
</span><a name="line-19"></a><span class="hs-comment">--</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- Maintainer  : Trevor L. McDonell &lt;tmcdonell@cse.unsw.edu.au&gt;</span><span>
</span><a name="line-21"></a><span class="hs-comment">-- Stability   : experimental</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- Portability : non-portable (GHC extensions)</span><span>
</span><a name="line-23"></a><span class="hs-comment">--</span><span>
</span><a name="line-24"></a><span class="hs-comment">-- Option parsing for debug flags</span><span>
</span><a name="line-25"></a><span class="hs-comment">--</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Debug</span><span class="hs-operator">.</span><span class="hs-identifier">Flags</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span>  </span><a href="Data.Array.Accelerate.Debug.Flags.html#Flags"><span class="hs-identifier hs-type">Flags</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#Mode"><span class="hs-identifier hs-type">Mode</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>  </span><a href="Data.Array.Accelerate.Debug.Flags.html#acc_sharing"><span class="hs-identifier hs-var">acc_sharing</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#exp_sharing"><span class="hs-identifier hs-var">exp_sharing</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#fusion"><span class="hs-identifier hs-var">fusion</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#simplify"><span class="hs-identifier hs-var">simplify</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#flush_cache"><span class="hs-identifier hs-var">flush_cache</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#fast_math"><span class="hs-identifier hs-var">fast_math</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#verbose"><span class="hs-identifier hs-var">verbose</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>  </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_phases"><span class="hs-identifier hs-var">dump_phases</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_sharing"><span class="hs-identifier hs-var">dump_sharing</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_simpl_stats"><span class="hs-identifier hs-var">dump_simpl_stats</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_simpl_iterations"><span class="hs-identifier hs-var">dump_simpl_iterations</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_vectorisation"><span class="hs-identifier hs-var">dump_vectorisation</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>  </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_dot"><span class="hs-identifier hs-var">dump_dot</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_simpl_dot"><span class="hs-identifier hs-var">dump_simpl_dot</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_gc"><span class="hs-identifier hs-var">dump_gc</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_gc_stats"><span class="hs-identifier hs-var">dump_gc_stats</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#debug_cc"><span class="hs-identifier hs-var">debug_cc</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_cc"><span class="hs-identifier hs-var">dump_cc</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_ld"><span class="hs-identifier hs-var">dump_ld</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_asm"><span class="hs-identifier hs-var">dump_asm</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>  </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_exec"><span class="hs-identifier hs-var">dump_exec</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#dump_sched"><span class="hs-identifier hs-var">dump_sched</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>  </span><a href="Data.Array.Accelerate.Debug.Flags.html#accInit"><span class="hs-identifier hs-var">accInit</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>  </span><a href="Data.Array.Accelerate.Debug.Flags.html#queryFlag"><span class="hs-identifier hs-var">queryFlag</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#setFlag"><span class="hs-identifier hs-var">setFlag</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#setFlags"><span class="hs-identifier hs-var">setFlags</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#clearFlag"><span class="hs-identifier hs-var">clearFlag</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#clearFlags"><span class="hs-identifier hs-var">clearFlags</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>  </span><a href="Data.Array.Accelerate.Debug.Flags.html#when"><span class="hs-identifier hs-var">when</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.Debug.Flags.html#unless"><span class="hs-identifier hs-var">unless</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IORef</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Label</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Label</span><span class="hs-operator">.</span><span class="hs-identifier">Derive</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Environment</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">PrettyPrint</span><span>                         </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Mode</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">when</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">C</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">Marshal</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">Ptr</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Foreign</span><span>                              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Encoding</span><span>                          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">getFileSystemEncoding</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Debug</span><span class="hs-operator">.</span><span class="hs-identifier">Trace</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-keyword">data</span><span> </span><a name="FlagSpec"><a href="Data.Array.Accelerate.Debug.Flags.html#FlagSpec"><span class="hs-identifier">FlagSpec</span></a></a><span> </span><a name="local-1627472816"><a href="#local-1627472816"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Option"><a href="Data.Array.Accelerate.Debug.Flags.html#Option"><span class="hs-identifier">Option</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>              </span><span class="hs-comment">-- external form</span><span>
</span><a name="line-61"></a><span>                            </span><a href="#local-1627472816"><span class="hs-identifier hs-type">flag</span></a><span>                </span><span class="hs-comment">-- internal form</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-comment">-- The runtime debug and control options supported by Accelerate. This is a bit</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- awkward, as we process both frontend as well as backend option flags, but</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- gives some control over error messages and overlapping options.</span><span>
</span><a name="line-66"></a><span class="hs-comment">--</span><span>
</span><a name="line-67"></a><span class="hs-keyword">data</span><span> </span><a name="Flags"><a href="Data.Array.Accelerate.Debug.Flags.html#Flags"><span class="hs-identifier">Flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Flags"><a href="Data.Array.Accelerate.Debug.Flags.html#Flags"><span class="hs-identifier">Flags</span></a></a><span>
</span><a name="line-68"></a><span>  </span><span class="hs-special">{</span><span>
</span><a name="line-69"></a><span>    </span><span class="hs-comment">-- Functionality and phase control</span><span>
</span><a name="line-70"></a><span>    </span><span class="hs-comment">-- -------------------------------</span><span>
</span><a name="line-71"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-comment">-- These are Maybe types because they will only override the backend</span><span>
</span><a name="line-73"></a><span>    </span><span class="hs-comment">-- options if the user specifies a value</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-75"></a><span>    </span><a name="_acc_sharing"><a href="Data.Array.Accelerate.Debug.Flags.html#_acc_sharing"><span class="hs-identifier">_acc_sharing</span></a></a><span>              </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- recover sharing of array computations</span><span>
</span><a name="line-76"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_exp_sharing"><a href="Data.Array.Accelerate.Debug.Flags.html#_exp_sharing"><span class="hs-identifier">_exp_sharing</span></a></a><span>              </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- recover sharing of scalar expressions</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_fusion"><a href="Data.Array.Accelerate.Debug.Flags.html#_fusion"><span class="hs-identifier">_fusion</span></a></a><span>                   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- fuse array expressions</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_simplify"><a href="Data.Array.Accelerate.Debug.Flags.html#_simplify"><span class="hs-identifier">_simplify</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- simplify scalar expressions</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-comment">-- , _unfolding_use_threshold  :: !(Maybe Int)         -- the magic cut-off figure for inlining</span><span>
</span><a name="line-80"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_flush_cache"><a href="Data.Array.Accelerate.Debug.Flags.html#_flush_cache"><span class="hs-identifier">_flush_cache</span></a></a><span>              </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- delete persistent compilation cache(s)</span><span>
</span><a name="line-81"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_fast_math"><a href="Data.Array.Accelerate.Debug.Flags.html#_fast_math"><span class="hs-identifier">_fast_math</span></a></a><span>                </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- use faster, less precise math library operations</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span>    </span><span class="hs-comment">-- Debug trace</span><span>
</span><a name="line-84"></a><span>    </span><span class="hs-comment">-- -----------</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_verbose"><a href="Data.Array.Accelerate.Debug.Flags.html#_verbose"><span class="hs-identifier">_verbose</span></a></a><span>                  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- be very chatty</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span>    </span><span class="hs-comment">-- optimisation and simplification</span><span>
</span><a name="line-88"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_phases"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_phases"><span class="hs-identifier">_dump_phases</span></a></a><span>              </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- print information about each phase of the compiler</span><span>
</span><a name="line-89"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_sharing"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_sharing"><span class="hs-identifier">_dump_sharing</span></a></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- sharing recovery phase</span><span>
</span><a name="line-90"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_simpl_stats"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_simpl_stats"><span class="hs-identifier">_dump_simpl_stats</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- statistics form fusion/simplification</span><span>
</span><a name="line-91"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_simpl_iterations"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_simpl_iterations"><span class="hs-identifier">_dump_simpl_iterations</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- output from each simplifier iteration</span><span>
</span><a name="line-92"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_vectorisation"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_vectorisation"><span class="hs-identifier">_dump_vectorisation</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- output from the vectoriser</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_dot"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_dot"><span class="hs-identifier">_dump_dot</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- generate dot output of the program</span><span>
</span><a name="line-94"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_simpl_dot"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_simpl_dot"><span class="hs-identifier">_dump_simpl_dot</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- generate simplified dot output</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span>    </span><span class="hs-comment">-- garbage collection</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_gc"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_gc"><span class="hs-identifier">_dump_gc</span></a></a><span>                  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- trace garbage collector</span><span>
</span><a name="line-98"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_gc_stats"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_gc_stats"><span class="hs-identifier">_dump_gc_stats</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- print final GC statistics</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-comment">-- code generation / compilation</span><span>
</span><a name="line-101"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_debug_cc"><a href="Data.Array.Accelerate.Debug.Flags.html#_debug_cc"><span class="hs-identifier">_debug_cc</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- compile with debug symbols</span><span>
</span><a name="line-102"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_cc"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_cc"><span class="hs-identifier">_dump_cc</span></a></a><span>                  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- trace code generation &amp; compilation</span><span>
</span><a name="line-103"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_ld"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_ld"><span class="hs-identifier">_dump_ld</span></a></a><span>                  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- trace runtime linker</span><span>
</span><a name="line-104"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_asm"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_asm"><span class="hs-identifier">_dump_asm</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- trace assembler</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span>    </span><span class="hs-comment">-- execution</span><span>
</span><a name="line-107"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_exec"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_exec"><span class="hs-identifier">_dump_exec</span></a></a><span>                </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- trace execution</span><span>
</span><a name="line-108"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_dump_sched"><a href="Data.Array.Accelerate.Debug.Flags.html#_dump_sched"><span class="hs-identifier">_dump_sched</span></a></a><span>               </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- trace scheduler</span><span>
</span><a name="line-109"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-comment">-- Generate labels with INLINE pragmas</span><span>
</span><a name="line-112"></a><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLabelsWith</span><span> </span><span class="hs-identifier hs-var">defaultNaming</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-char">''Flags)


allFlags :: [FlagSpec (Flags -&gt; Flags)]
allFlags
  =  map (enable  'd') dflags
  ++ map (enable  'f') fflags ++ map (disable 'f') fflags
  where
    enable  p (Option f go) = Option ('-':p:f)        (go True)
    disable p (Option f go) = Option ('-':p:&quot;no-&quot;++f) (go False)


-- These @-f\&lt;blah\&gt;@ phase control flags can be reversed with @-fno-\&lt;blah\&gt;@
--
fflags :: [FlagSpec (Bool -&gt; Flags -&gt; Flags)]
fflags =
  [ Option &quot;acc-sharing&quot;                (set' acc_sharing)
  , Option &quot;exp-sharing&quot;                (set' exp_sharing)
  , Option &quot;fusion&quot;                     (set' fusion)
  , Option &quot;simplify&quot;                   (set' simplify)
  , Option &quot;flush-cache&quot;                (set' flush_cache)
  , Option &quot;fast-math&quot;                  (set' fast_math)
  ]
  where
    set' f v = set f (Just v)

-- These debugging flags default to off and can be enable with @-d\&lt;blah\&gt;@
--
dflags :: [FlagSpec (Bool -&gt; Flags -&gt; Flags)]
dflags =
  [ Option &quot;verbose&quot;                    (set verbose)
  , Option &quot;dump-phases&quot;                (set dump_phases)
  , Option &quot;dump-sharing&quot;               (set dump_sharing)
  , Option &quot;dump-simpl-stats&quot;           (set dump_simpl_stats)
  , Option &quot;dump-simpl-iterations&quot;      (set dump_simpl_iterations)
  , Option &quot;dump-vectorisation&quot;         (set dump_vectorisation)
  , Option &quot;dump-dot&quot;                   (set dump_dot)
  , Option &quot;dump-simpl-dot&quot;             (set dump_simpl_dot)
  , Option &quot;dump-gc&quot;                    (set dump_gc)
  , Option &quot;dump-gc-stats&quot;              (set dump_gc_stats)
  , Option &quot;debug-cc&quot;                   (set debug_cc)
  , Option &quot;dump-cc&quot;                    (set dump_cc)
  , Option &quot;dump-ld&quot;                    (set dump_ld)
  , Option &quot;dump-asm&quot;                   (set dump_asm)
  , Option &quot;dump-exec&quot;                  (set dump_exec)
  , Option &quot;dump-sched&quot;                 (set dump_sched)
  ]


class DebugFlag a where
  def :: a

instance DebugFlag Bool where
  {-# INLINE def #-}
  def = False

instance DebugFlag (Maybe a) where
  {-# INLINE def #-}
  def = Nothing


-- | A bit of a hack to get the command line options processing out of the way.
--
-- We would like to have this automatically called once during program
-- initialisation, so that our command-line debug flags between +ACC .. [-ACC]
-- don't interfere with other programs.
--
-- Hacks beget hacks beget hacks...
--
accInit :: IO ()
#ifdef ACCELERATE_DEBUG
accInit = _flags `seq` return ()
#else
accInit = getUpdateArgs &gt;&gt; return ()
#endif

-- Initialise the debugging flags structure. This reads from both the command
-- line arguments as well as the environment variable &quot;ACCELERATE_FLAGS&quot;.
-- Where applicable, options on the command line take precedence.
--
-- This is only available when compiled with debugging mode, because trying to
-- access it at any other time is an error.
--
#ifdef ACCELERATE_DEBUG
initialiseFlags :: IO Flags
initialiseFlags = do
  argv  &lt;- getUpdateArgs
  env   &lt;- maybe [] words `fmap` lookupEnv &quot;ACCELERATE_FLAGS&quot;
  return $ parse (env ++ argv)
  where
    defaults            = Flags def def def def def def def def def def def def def def def def def def def def def def

    parse               = foldl parse1 defaults
    parse1 opts this    =
      case filter (\(Option flag _) -&gt; this `isPrefixOf` flag) allFlags of
        [Option _ go]   -&gt; go opts
        []              -&gt; trace unknown opts
        alts            -&gt; case find (\(Option flag _) -&gt; flag == this) alts of
                             Just (Option _ go) -&gt; go opts
                             Nothing            -&gt; trace (ambiguous alts) opts
      where
        unknown         = render $ text &quot;Unknown option:&quot; &lt;+&gt; quotes (text this)
        ambiguous alts  = render $
          vcat [ text &quot;Ambiguous option:&quot; &lt;+&gt; quotes (text this)
               , text &quot;&quot;
               , text &quot;Did you mean one of these?&quot;
               , nest 4 $ vcat (map (\(Option s _) -&gt; text s) alts)
               ]
#endif


-- If the command line arguments include a section &quot;+ACC ... [-ACC]&quot; then return
-- that section, and update the command line arguments to not include that part.
--
getUpdateArgs :: IO [String]
getUpdateArgs = do
  argv &lt;- getArgs
  --
  let (before, r1)      = span (/= &quot;+ACC&quot;) argv
      (flags,  r2)      = span (/= &quot;-ACC&quot;) $ dropWhile (== &quot;+ACC&quot;) r1
      after             = dropWhile (== &quot;-ACC&quot;) r2
  --
#ifdef ACCELERATE_DEBUG
  prog &lt;- getProgName
  setProgArgv (prog : before ++ after)
#else
  M.unless (null flags)
    $ error &quot;Data.Array.Accelerate: Debugging options are disabled. Reinstall package 'accelerate' with '-fdebug' to enable them.&quot;
#endif
  return flags


-- This is only defined in debug mode because to access it at any other time
-- should be an error.
--
#ifdef ACCELERATE_DEBUG
{-# NOINLINE _flags #-}
_flags :: IORef Flags
_flags = unsafePerformIO $ newIORef =&lt;&lt; initialiseFlags
#endif

{-# INLINE queryFlag #-}
queryFlag :: DebugFlag a =&gt; (Flags :-&gt; a) -&gt; IO a
#ifdef ACCELERATE_DEBUG
queryFlag f = get f `fmap` readIORef _flags
#else
queryFlag _ = return def
#endif


type Mode = Flags :-&gt; Bool

setFlag, clearFlag :: Mode -&gt; IO ()
setFlag f   = setFlags [f]
clearFlag f = clearFlags [f]

setFlags, clearFlags :: [Mode] -&gt; IO ()
#ifdef ACCELERATE_DEBUG
setFlags f   = modifyIORef _flags (\opt -&gt; foldr (flip set True)  opt f)
clearFlags f = modifyIORef _flags (\opt -&gt; foldr (flip set False) opt f)
#else
setFlags _   = return ()
clearFlags _ = return ()
#endif


-- | Conditional execution of a monadic debugging expression
--
{-# INLINEABLE when #-}
when :: MonadIO m =&gt; Mode -&gt; m () -&gt; m ()
when f s = do
  yes &lt;- liftIO $ queryFlag f
  M.when yes s

-- | The opposite of 'when'
--
{-# INLINEABLE unless #-}
unless :: MonadIO m =&gt; Mode -&gt; m () -&gt; m ()
unless f s = do
  yes &lt;- liftIO $ queryFlag f
  M.unless yes s


#ifdef ACCELERATE_DEBUG
-- Stolen from System.Environment
--
setProgArgv :: [String] -&gt; IO ()
setProgArgv argv = do
  enc &lt;- getFileSystemEncoding
  vs  &lt;- mapM (GHC.newCString enc) argv &gt;&gt;= newArray0 nullPtr
  c_setProgArgv (genericLength argv) vs

foreign import ccall unsafe &quot;setProgArgv&quot;
  c_setProgArgv  :: CInt -&gt; Ptr CString -&gt; IO ()
#endif

</span></pre></body></html>