<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcUnify.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a>Type subsumption and unification
<a name="line-7"></a>-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE CPP, MultiWayIf, TupleSections #-}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcUnify</span> <span class='hs-layout'>(</span>
<a name="line-12"></a>  <span class='hs-comment'>-- Full-blown subsumption</span>
<a name="line-13"></a>  <span class='hs-varid'>tcWrapResult</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcWrapResultO</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSkolemise</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSkolemiseET</span><span class='hs-layout'>,</span>
<a name="line-14"></a>  <span class='hs-varid'>tcSubTypeHR</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubTypeO</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubType_NC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubTypeDS</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubTypeDS_O</span><span class='hs-layout'>,</span>
<a name="line-15"></a>  <span class='hs-varid'>tcSubTypeDS_NC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubTypeDS_NC_O</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubTypeET</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubTypeET_NC</span><span class='hs-layout'>,</span>
<a name="line-16"></a>  <span class='hs-varid'>checkConstraints</span><span class='hs-layout'>,</span> <span class='hs-varid'>buildImplicationFor</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>  <span class='hs-comment'>-- Various unifications</span>
<a name="line-19"></a>  <span class='hs-varid'>unifyType_</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyType</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>noThing</span><span class='hs-layout'>,</span>
<a name="line-20"></a>  <span class='hs-varid'>uType</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyExpType</span><span class='hs-layout'>,</span>
<a name="line-21"></a>  <span class='hs-varid'>swapOverTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>canSolveByUnification</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-24"></a>  <span class='hs-comment'>-- Holes</span>
<a name="line-25"></a>  <span class='hs-varid'>tcInfer</span><span class='hs-layout'>,</span>
<a name="line-26"></a>  <span class='hs-varid'>matchExpectedListTy</span><span class='hs-layout'>,</span>
<a name="line-27"></a>  <span class='hs-varid'>matchExpectedPArrTy</span><span class='hs-layout'>,</span>
<a name="line-28"></a>  <span class='hs-varid'>matchExpectedTyConApp</span><span class='hs-layout'>,</span>
<a name="line-29"></a>  <span class='hs-varid'>matchExpectedAppTy</span><span class='hs-layout'>,</span>
<a name="line-30"></a>  <span class='hs-varid'>matchExpectedFunTys</span><span class='hs-layout'>,</span>
<a name="line-31"></a>  <span class='hs-varid'>matchActualFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchActualFunTysPart</span><span class='hs-layout'>,</span>
<a name="line-32"></a>  <span class='hs-varid'>matchExpectedFunKind</span><span class='hs-layout'>,</span>
<a name="line-33"></a>
<a name="line-34"></a>  <span class='hs-varid'>wrapFunResCoercion</span>
<a name="line-35"></a>
<a name="line-36"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCoRep</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isSystemName</span> <span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>   <span class='hs-layout'>(</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span> <span class='hs-layout'>(</span> <span class='hs-varid'>second</span> <span class='hs-layout'>)</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-comment'>{-
<a name="line-68"></a>************************************************************************
<a name="line-69"></a>*                                                                      *
<a name="line-70"></a>             matchExpected functions
<a name="line-71"></a>*                                                                      *
<a name="line-72"></a>************************************************************************
<a name="line-73"></a>
<a name="line-74"></a>Note [Herald for matchExpectedFunTys]
<a name="line-75"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-76"></a>The 'herald' always looks like:
<a name="line-77"></a>   "The equation(s) for 'f' have"
<a name="line-78"></a>   "The abstraction (\x.e) takes"
<a name="line-79"></a>   "The section (+ x) expects"
<a name="line-80"></a>   "The function 'f' is applied to"
<a name="line-81"></a>
<a name="line-82"></a>This is used to construct a message of form
<a name="line-83"></a>
<a name="line-84"></a>   The abstraction `\Just 1 -&gt; ...' takes two arguments
<a name="line-85"></a>   but its type `Maybe a -&gt; a' has only one
<a name="line-86"></a>
<a name="line-87"></a>   The equation(s) for `f' have two arguments
<a name="line-88"></a>   but its type `Maybe a -&gt; a' has only one
<a name="line-89"></a>
<a name="line-90"></a>   The section `(f 3)' requires 'f' to take two arguments
<a name="line-91"></a>   but its type `Int -&gt; Int' has only one
<a name="line-92"></a>
<a name="line-93"></a>   The function 'f' is applied to two arguments
<a name="line-94"></a>   but its type `Int -&gt; Int' has only one
<a name="line-95"></a>
<a name="line-96"></a>Note [matchExpectedFunTys]
<a name="line-97"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-98"></a>matchExpectedFunTys checks that a sigma has the form
<a name="line-99"></a>of an n-ary function.  It passes the decomposed type to the
<a name="line-100"></a>thing_inside, and returns a wrapper to coerce between the two types
<a name="line-101"></a>
<a name="line-102"></a>It's used wherever a language construct must have a functional type,
<a name="line-103"></a>namely:
<a name="line-104"></a>        A lambda expression
<a name="line-105"></a>        A function definition
<a name="line-106"></a>     An operator section
<a name="line-107"></a>
<a name="line-108"></a>This function must be written CPS'd because it needs to fill in the
<a name="line-109"></a>ExpTypes produced for arguments before it can fill in the ExpType
<a name="line-110"></a>passed in.
<a name="line-111"></a>
<a name="line-112"></a>-}</span>
<a name="line-113"></a>
<a name="line-114"></a><a name="matchExpectedFunTys"></a><span class='hs-comment'>-- Use this one when you have an "expected" type.</span>
<a name="line-115"></a><span class='hs-definition'>matchExpectedFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>   <span class='hs-comment'>-- See Note [Herald for matchExpectedFunTys]</span>
<a name="line-116"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-117"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>  <span class='hs-comment'>-- deeply skolemised</span>
<a name="line-118"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ExpSigmaType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-119"></a>                          <span class='hs-comment'>-- must fill in these ExpTypes here</span>
<a name="line-120"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span>
<a name="line-121"></a><span class='hs-comment'>-- If    matchExpectedFunTys n ty = (_, wrap)</span>
<a name="line-122"></a><span class='hs-comment'>-- then  wrap : (t1 -&gt; ... -&gt; tn -&gt; ty_r) "-&gt;" ty,</span>
<a name="line-123"></a><span class='hs-comment'>--   where [t1, ..., tn], ty_r are passed to the thing_inside</span>
<a name="line-124"></a><span class='hs-definition'>matchExpectedFunTys</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>of</span>
<a name="line-126"></a>      <span class='hs-conid'>Check</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>ty</span>
<a name="line-127"></a>      <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>orig_ty</span>
<a name="line-128"></a>  <span class='hs-keyword'>where</span>
<a name="line-129"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-num'>0</span> <span class='hs-varid'>ty</span>
<a name="line-130"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-131"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-132"></a>
<a name="line-133"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span>
<a name="line-134"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty'</span>
<a name="line-135"></a>
<a name="line-136"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-137"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPredTy</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-138"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap_res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>arg_ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-139"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-140"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>result</span>
<a name="line-141"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>mkWpFun</span> <span class='hs-varid'>idHsWrapper</span> <span class='hs-varid'>wrap_res</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-142"></a>
<a name="line-143"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-144"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-145"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-146"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-147"></a>               <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty'</span>
<a name="line-148"></a>               <span class='hs-conid'>Flexi</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-149"></a>
<a name="line-150"></a>       <span class='hs-comment'>-- In all other cases we bale out into ordinary unification</span>
<a name="line-151"></a>       <span class='hs-comment'>-- However unlike the meta-tyvar case, we are sure that the</span>
<a name="line-152"></a>       <span class='hs-comment'>-- number of arguments doesn't match arity of the original</span>
<a name="line-153"></a>       <span class='hs-comment'>-- type, so we can add a bit more context to the error message</span>
<a name="line-154"></a>       <span class='hs-comment'>-- (cf Trac #7869).</span>
<a name="line-155"></a>       <span class='hs-comment'>--</span>
<a name="line-156"></a>       <span class='hs-comment'>-- It is not always an error, because specialized type may have</span>
<a name="line-157"></a>       <span class='hs-comment'>-- different arity, for example:</span>
<a name="line-158"></a>       <span class='hs-comment'>--</span>
<a name="line-159"></a>       <span class='hs-comment'>-- &gt; f1 = f2 'a'</span>
<a name="line-160"></a>       <span class='hs-comment'>-- &gt; f2 :: Monad m =&gt; m Bool</span>
<a name="line-161"></a>       <span class='hs-comment'>-- &gt; f2 = undefined</span>
<a name="line-162"></a>       <span class='hs-comment'>--</span>
<a name="line-163"></a>       <span class='hs-comment'>-- But in that case we add specialized type into error context</span>
<a name="line-164"></a>       <span class='hs-comment'>-- anyway, because it may be useful. See also Trac #9605.</span>
<a name="line-165"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-varid'>mk_ctxt</span> <span class='hs-varop'>$</span>
<a name="line-166"></a>                          <span class='hs-varid'>defer</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-167"></a>
<a name="line-168"></a>    <span class='hs-comment'>------------</span>
<a name="line-169"></a>    <span class='hs-varid'>defer</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fun_ty</span>
<a name="line-170"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>more_arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replicateM</span> <span class='hs-varid'>n</span> <span class='hs-varid'>newOpenInferExpType</span>
<a name="line-171"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenInferExpType</span>
<a name="line-172"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>result</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>more_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-173"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>more_arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>readExpType</span> <span class='hs-varid'>more_arg_tys</span>
<a name="line-174"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readExpType</span> <span class='hs-varid'>res_ty</span>
<a name="line-175"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>unif_fun_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>more_arg_tys</span> <span class='hs-varid'>res_ty</span>
<a name="line-176"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubTypeDS</span> <span class='hs-conid'>GenSigCtxt</span> <span class='hs-varid'>noThing</span> <span class='hs-varid'>unif_fun_ty</span> <span class='hs-varid'>fun_ty</span>
<a name="line-177"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-178"></a>
<a name="line-179"></a>    <span class='hs-comment'>------------</span>
<a name="line-180"></a>    <span class='hs-varid'>mk_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>MsgDoc</span><span class='hs-layout'>)</span>
<a name="line-181"></a>    <span class='hs-varid'>mk_ctxt</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>orig_tc_ty</span>
<a name="line-182"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTys</span> <span class='hs-varid'>ty</span>
<a name="line-183"></a>                           <span class='hs-varid'>n_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span>
<a name="line-184"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>env''</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>orig_tc_ty</span>
<a name="line-185"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>env''</span>
<a name="line-186"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mk_fun_tys_msg</span> <span class='hs-varid'>orig_ty'</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n_actual</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>herald</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-187"></a>      <span class='hs-keyword'>where</span>
<a name="line-188"></a>        <span class='hs-varid'>orig_tc_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkingExpType</span> <span class='hs-str'>"matchExpectedFunTys"</span> <span class='hs-varid'>orig_ty</span>
<a name="line-189"></a>            <span class='hs-comment'>-- this is safe b/c we're called from "go"</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="matchActualFunTys"></a><span class='hs-comment'>-- Like 'matchExpectedFunTys', but used when you have an "actual" type,</span>
<a name="line-192"></a><span class='hs-comment'>-- for example in function application</span>
<a name="line-193"></a><span class='hs-definition'>matchActualFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-194"></a>                  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SDoc</span>   <span class='hs-comment'>-- See Note [Herald for matchExpectedFunTys]</span>
<a name="line-195"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-196"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>   <span class='hs-comment'>-- the thing with type TcSigmaType</span>
<a name="line-197"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-198"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-199"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span>
<a name="line-200"></a><span class='hs-comment'>-- If    matchActualFunTys n ty = (wrap, [t1,..,tn], ty_r)</span>
<a name="line-201"></a><span class='hs-comment'>-- then  wrap : ty "-&gt;" (t1 -&gt; ... -&gt; tn -&gt; ty_r)</span>
<a name="line-202"></a><span class='hs-definition'>matchActualFunTys</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>ct_orig</span> <span class='hs-varid'>mb_thing</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>ty</span>
<a name="line-203"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchActualFunTysPart</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>ct_orig</span> <span class='hs-varid'>mb_thing</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>arity</span>
<a name="line-204"></a>
<a name="line-205"></a><a name="matchActualFunTysPart"></a><span class='hs-comment'>-- | Variant of 'matchActualFunTys' that works when supplied only part</span>
<a name="line-206"></a><span class='hs-comment'>-- (that is, to the right of some arrows) of the full function type</span>
<a name="line-207"></a><span class='hs-definition'>matchActualFunTysPart</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-208"></a>                      <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-comment'>-- See Note [Herald for matchExpectedFunTys]</span>
<a name="line-209"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-210"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>  <span class='hs-comment'>-- the thing with type TcSigmaType</span>
<a name="line-211"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-212"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-213"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- reversed args. See (*) below.</span>
<a name="line-214"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>   <span class='hs-comment'>-- overall arity of the function, for errs</span>
<a name="line-215"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span>
<a name="line-216"></a><span class='hs-definition'>matchActualFunTysPart</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>ct_orig</span> <span class='hs-varid'>mb_thing</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>orig_ty</span>
<a name="line-217"></a>                      <span class='hs-varid'>orig_old_args</span> <span class='hs-varid'>full_arity</span>
<a name="line-218"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>orig_old_args</span> <span class='hs-varid'>orig_ty</span>
<a name="line-219"></a><span class='hs-comment'>-- Does not allocate unnecessary meta variables: if the input already is</span>
<a name="line-220"></a><span class='hs-comment'>-- a function, we just take it apart.  Not only is this efficient,</span>
<a name="line-221"></a><span class='hs-comment'>-- it's important for higher rank: the argument might be of form</span>
<a name="line-222"></a><span class='hs-comment'>--              (forall a. ty) -&gt; other</span>
<a name="line-223"></a><span class='hs-comment'>-- If allocated (fresh-meta-var1 -&gt; fresh-meta-var2) and unified, we'd</span>
<a name="line-224"></a><span class='hs-comment'>-- hide the forall inside a meta-variable</span>
<a name="line-225"></a>
<a name="line-226"></a><span class='hs-comment'>-- (*) Sometimes it's necessary to call matchActualFunTys with only part</span>
<a name="line-227"></a><span class='hs-comment'>-- (that is, to the right of some arrows) of the type of the function in</span>
<a name="line-228"></a><span class='hs-comment'>-- question. (See TcExpr.tcArgs.) This argument is the reversed list of</span>
<a name="line-229"></a><span class='hs-comment'>-- arguments already seen (that is, not part of the TcSigmaType passed</span>
<a name="line-230"></a><span class='hs-comment'>-- in elsewhere).</span>
<a name="line-231"></a>
<a name="line-232"></a>  <span class='hs-keyword'>where</span>
<a name="line-233"></a>    <span class='hs-comment'>-- This function has a bizarre mechanic: it accumulates arguments on</span>
<a name="line-234"></a>    <span class='hs-comment'>-- the way down and also builds an argument list on the way up. Why:</span>
<a name="line-235"></a>    <span class='hs-comment'>-- 1. The returns args list and the accumulated args list might be different.</span>
<a name="line-236"></a>    <span class='hs-comment'>--    The accumulated args include all the arg types for the function,</span>
<a name="line-237"></a>    <span class='hs-comment'>--    including those from before this function was called. The returned</span>
<a name="line-238"></a>    <span class='hs-comment'>--    list should include only those arguments produced by this call of</span>
<a name="line-239"></a>    <span class='hs-comment'>--    matchActualFunTys</span>
<a name="line-240"></a>    <span class='hs-comment'>--</span>
<a name="line-241"></a>    <span class='hs-comment'>-- 2. The HsWrapper can be built only on the way up. It seems (more)</span>
<a name="line-242"></a>    <span class='hs-comment'>--    bizarre to build the HsWrapper but not the arg_tys.</span>
<a name="line-243"></a>    <span class='hs-comment'>--</span>
<a name="line-244"></a>    <span class='hs-comment'>-- Refactoring is welcome.</span>
<a name="line-245"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span>
<a name="line-246"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- accumulator of arguments (reversed)</span>
<a name="line-247"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>   <span class='hs-comment'>-- the remainder of the type as we're processing</span>
<a name="line-248"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span>
<a name="line-249"></a>    <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-250"></a>
<a name="line-251"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>ty</span>
<a name="line-252"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-253"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topInstantiate</span> <span class='hs-varid'>ct_orig</span> <span class='hs-varid'>ty</span>
<a name="line-254"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>rho</span>
<a name="line-255"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap2</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-256"></a>      <span class='hs-keyword'>where</span>
<a name="line-257"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty</span>
<a name="line-258"></a>
<a name="line-259"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>ty</span>
<a name="line-260"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>ty'</span>
<a name="line-261"></a>
<a name="line-262"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-263"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPredTy</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-264"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_res</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-265"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkWpFun</span> <span class='hs-varid'>idHsWrapper</span> <span class='hs-varid'>wrap_res</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>ty_r</span>
<a name="line-266"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_r</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-267"></a>
<a name="line-268"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-269"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-270"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-271"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-272"></a>               <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>ty'</span>
<a name="line-273"></a>               <span class='hs-conid'>Flexi</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-274"></a>
<a name="line-275"></a>       <span class='hs-comment'>-- In all other cases we bale out into ordinary unification</span>
<a name="line-276"></a>       <span class='hs-comment'>-- However unlike the meta-tyvar case, we are sure that the</span>
<a name="line-277"></a>       <span class='hs-comment'>-- number of arguments doesn't match arity of the original</span>
<a name="line-278"></a>       <span class='hs-comment'>-- type, so we can add a bit more context to the error message</span>
<a name="line-279"></a>       <span class='hs-comment'>-- (cf Trac #7869).</span>
<a name="line-280"></a>       <span class='hs-comment'>--</span>
<a name="line-281"></a>       <span class='hs-comment'>-- It is not always an error, because specialized type may have</span>
<a name="line-282"></a>       <span class='hs-comment'>-- different arity, for example:</span>
<a name="line-283"></a>       <span class='hs-comment'>--</span>
<a name="line-284"></a>       <span class='hs-comment'>-- &gt; f1 = f2 'a'</span>
<a name="line-285"></a>       <span class='hs-comment'>-- &gt; f2 :: Monad m =&gt; m Bool</span>
<a name="line-286"></a>       <span class='hs-comment'>-- &gt; f2 = undefined</span>
<a name="line-287"></a>       <span class='hs-comment'>--</span>
<a name="line-288"></a>       <span class='hs-comment'>-- But in that case we add specialized type into error context</span>
<a name="line-289"></a>       <span class='hs-comment'>-- anyway, because it may be useful. See also Trac #9605.</span>
<a name="line-290"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-291"></a>                       <span class='hs-varid'>defer</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span>
<a name="line-292"></a>
<a name="line-293"></a>    <span class='hs-comment'>------------</span>
<a name="line-294"></a>    <span class='hs-varid'>defer</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fun_ty</span>
<a name="line-295"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replicateM</span> <span class='hs-varid'>n</span> <span class='hs-varid'>newOpenFlexiTyVarTy</span>
<a name="line-296"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenFlexiTyVarTy</span>
<a name="line-297"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>unif_fun_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span>
<a name="line-298"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>mb_thing</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>unif_fun_ty</span>
<a name="line-299"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpCastN</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-300"></a>
<a name="line-301"></a>    <span class='hs-comment'>------------</span>
<a name="line-302"></a>    <span class='hs-varid'>mk_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>MsgDoc</span><span class='hs-layout'>)</span>
<a name="line-303"></a>    <span class='hs-varid'>mk_ctxt</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>env</span>
<a name="line-304"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span>
<a name="line-305"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonked</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-306"></a>                   <span class='hs-comment'>-- zonking might change # of args</span>
<a name="line-307"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonked_args</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTys</span> <span class='hs-varid'>zonked</span>
<a name="line-308"></a>                 <span class='hs-varid'>n_actual</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>zonked_args</span>
<a name="line-309"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>unzonked</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>ty</span>
<a name="line-310"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>env2</span>
<a name="line-311"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>mk_fun_tys_msg</span> <span class='hs-varid'>unzonked</span> <span class='hs-varid'>zonked</span> <span class='hs-varid'>n_actual</span> <span class='hs-varid'>full_arity</span> <span class='hs-varid'>herald</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-312"></a>
<a name="line-313"></a><a name="mk_fun_tys_msg"></a><span class='hs-definition'>mk_fun_tys_msg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span>  <span class='hs-comment'>-- the full type passed in (unzonked)</span>
<a name="line-314"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>  <span class='hs-comment'>-- the full type passed in (zonked)</span>
<a name="line-315"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>   <span class='hs-comment'>-- the # of args found</span>
<a name="line-316"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>   <span class='hs-comment'>-- the # of args wanted</span>
<a name="line-317"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>    <span class='hs-comment'>-- overall herald</span>
<a name="line-318"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-319"></a><span class='hs-definition'>mk_fun_tys_msg</span> <span class='hs-varid'>full_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n_args</span> <span class='hs-varid'>full_arity</span> <span class='hs-varid'>herald</span>
<a name="line-320"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>herald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakNOf</span> <span class='hs-varid'>full_arity</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"argument"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>$$</span>
<a name="line-321"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>n_args</span> <span class='hs-varop'>==</span> <span class='hs-varid'>full_arity</span>
<a name="line-322"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"its type is"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-varid'>full_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-323"></a>           <span class='hs-varid'>comma</span> <span class='hs-varop'>$$</span>
<a name="line-324"></a>           <span class='hs-varid'>text</span> <span class='hs-str'>"it is specialized to"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-325"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"but its type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-326"></a>                <span class='hs-keyword'>if</span> <span class='hs-varid'>n_args</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"has none"</span>
<a name="line-327"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-str'>"has only"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakN</span> <span class='hs-varid'>n_args</span><span class='hs-keyglyph'>]</span>
<a name="line-328"></a>
<a name="line-329"></a><a name="matchExpectedListTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-330"></a><span class='hs-definition'>matchExpectedListTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-331"></a><span class='hs-comment'>-- Special case for lists</span>
<a name="line-332"></a><span class='hs-definition'>matchExpectedListTy</span> <span class='hs-varid'>exp_ty</span>
<a name="line-333"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>elt_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedTyConApp</span> <span class='hs-varid'>listTyCon</span> <span class='hs-varid'>exp_ty</span>
<a name="line-334"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-335"></a>
<a name="line-336"></a><a name="matchExpectedPArrTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-337"></a><span class='hs-definition'>matchExpectedPArrTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-338"></a><span class='hs-comment'>-- Special case for parrs</span>
<a name="line-339"></a><span class='hs-definition'>matchExpectedPArrTy</span> <span class='hs-varid'>exp_ty</span>
<a name="line-340"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>elt_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedTyConApp</span> <span class='hs-varid'>parrTyCon</span> <span class='hs-varid'>exp_ty</span>
<a name="line-341"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-342"></a>
<a name="line-343"></a><a name="matchExpectedTyConApp"></a><span class='hs-comment'>---------------------</span>
<a name="line-344"></a><span class='hs-definition'>matchExpectedTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>                <span class='hs-comment'>-- T :: forall kv1 ... kvm. k1 -&gt; ... -&gt; kn -&gt; *</span>
<a name="line-345"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>            <span class='hs-comment'>-- orig_ty</span>
<a name="line-346"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- T k1 k2 k3 a b c ~N orig_ty</span>
<a name="line-347"></a>                              <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Element types, k1 k2 k3 a b c</span>
<a name="line-348"></a>
<a name="line-349"></a><span class='hs-comment'>-- It's used for wired-in tycons, so we call checkWiredInTyCon</span>
<a name="line-350"></a><span class='hs-comment'>-- Precondition: never called with FunTyCon</span>
<a name="line-351"></a><span class='hs-comment'>-- Precondition: input type :: *</span>
<a name="line-352"></a><span class='hs-comment'>-- Postcondition: (T k1 k2 k3 a b c) is well-kinded</span>
<a name="line-353"></a>
<a name="line-354"></a><span class='hs-definition'>matchExpectedTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>orig_ty</span>
<a name="line-355"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_ty</span>
<a name="line-356"></a>  <span class='hs-keyword'>where</span>
<a name="line-357"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-358"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>
<a name="line-359"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-360"></a>
<a name="line-361"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-362"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tycon</span>  <span class='hs-comment'>-- Common case</span>
<a name="line-363"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-364"></a>
<a name="line-365"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-366"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-367"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-368"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-369"></a>                <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-370"></a>                <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>}</span>
<a name="line-371"></a>
<a name="line-372"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span>
<a name="line-373"></a>
<a name="line-374"></a>    <span class='hs-comment'>-- If the common case does not occur, instantiate a template</span>
<a name="line-375"></a>    <span class='hs-comment'>-- T k1 .. kn t1 .. tm, and unify with the original type</span>
<a name="line-376"></a>    <span class='hs-comment'>-- Doing it this way ensures that the types we return are</span>
<a name="line-377"></a>    <span class='hs-comment'>-- kind-compatible with T.  For example, suppose we have</span>
<a name="line-378"></a>    <span class='hs-comment'>--       matchExpectedTyConApp T (f Maybe)</span>
<a name="line-379"></a>    <span class='hs-comment'>-- where data T a = MkT a</span>
<a name="line-380"></a>    <span class='hs-comment'>-- Then we don't want to instantate T's data constructors with</span>
<a name="line-381"></a>    <span class='hs-comment'>--    (a::*) ~ Maybe</span>
<a name="line-382"></a>    <span class='hs-comment'>-- because that'll make types that are utterly ill-kinded.</span>
<a name="line-383"></a>    <span class='hs-comment'>-- This happened in Trac #7368</span>
<a name="line-384"></a>    <span class='hs-varid'>defer</span>
<a name="line-385"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-sel'>_subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstBinders</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-386"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>noThing</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_ty</span>
<a name="line-387"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-388"></a>
<a name="line-389"></a><a name="matchExpectedAppTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-390"></a><span class='hs-definition'>matchExpectedAppTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRhoType</span>                         <span class='hs-comment'>-- orig_ty</span>
<a name="line-391"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span>                   <span class='hs-comment'>-- m a ~N orig_ty</span>
<a name="line-392"></a>                           <span class='hs-layout'>(</span><span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Returns m, a</span>
<a name="line-393"></a><span class='hs-comment'>-- If the incoming type is a mutable type variable of kind k, then</span>
<a name="line-394"></a><span class='hs-comment'>-- matchExpectedAppTy returns a new type variable (m: * -&gt; k); note the *.</span>
<a name="line-395"></a>
<a name="line-396"></a><span class='hs-definition'>matchExpectedAppTy</span> <span class='hs-varid'>orig_ty</span>
<a name="line-397"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_ty</span>
<a name="line-398"></a>  <span class='hs-keyword'>where</span>
<a name="line-399"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-400"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-401"></a>
<a name="line-402"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-403"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-404"></a>
<a name="line-405"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-406"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-407"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-408"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-409"></a>               <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-410"></a>               <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>}</span>
<a name="line-411"></a>
<a name="line-412"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span>
<a name="line-413"></a>
<a name="line-414"></a>    <span class='hs-comment'>-- Defer splitting by generating an equality constraint</span>
<a name="line-415"></a>    <span class='hs-varid'>defer</span>
<a name="line-416"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>kind1</span>
<a name="line-417"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>kind2</span>
<a name="line-418"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>noThing</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_ty</span>
<a name="line-419"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-420"></a>
<a name="line-421"></a>    <span class='hs-varid'>orig_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>orig_ty</span>
<a name="line-422"></a>    <span class='hs-varid'>kind1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>orig_kind</span>
<a name="line-423"></a>    <span class='hs-varid'>kind2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftedTypeKind</span>    <span class='hs-comment'>-- m :: * -&gt; k</span>
<a name="line-424"></a>                              <span class='hs-comment'>-- arg type :: *</span>
<a name="line-425"></a>
<a name="line-426"></a><span class='hs-comment'>{-
<a name="line-427"></a>************************************************************************
<a name="line-428"></a>*                                                                      *
<a name="line-429"></a>                Subsumption checking
<a name="line-430"></a>*                                                                      *
<a name="line-431"></a>************************************************************************
<a name="line-432"></a>
<a name="line-433"></a>Note [Subsumption checking: tcSubType]
<a name="line-434"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-435"></a>All the tcSubType calls have the form
<a name="line-436"></a>                tcSubType actual_ty expected_ty
<a name="line-437"></a>which checks
<a name="line-438"></a>                actual_ty &lt;= expected_ty
<a name="line-439"></a>
<a name="line-440"></a>That is, that a value of type actual_ty is acceptable in
<a name="line-441"></a>a place expecting a value of type expected_ty.  I.e. that
<a name="line-442"></a>
<a name="line-443"></a>    actual ty   is more polymorphic than   expected_ty
<a name="line-444"></a>
<a name="line-445"></a>It returns a coercion function
<a name="line-446"></a>        co_fn :: actual_ty ~ expected_ty
<a name="line-447"></a>which takes an HsExpr of type actual_ty into one of type
<a name="line-448"></a>expected_ty.
<a name="line-449"></a>
<a name="line-450"></a>These functions do not actually check for subsumption. They check if
<a name="line-451"></a>expected_ty is an appropriate annotation to use for something of type
<a name="line-452"></a>actual_ty. This difference matters when thinking about visible type
<a name="line-453"></a>application. For example,
<a name="line-454"></a>
<a name="line-455"></a>   forall a. a -&gt; forall b. b -&gt; b
<a name="line-456"></a>      DOES NOT SUBSUME
<a name="line-457"></a>   forall a b. a -&gt; b -&gt; b
<a name="line-458"></a>
<a name="line-459"></a>because the type arguments appear in a different order. (Neither does
<a name="line-460"></a>it work the other way around.) BUT, these types are appropriate annotations
<a name="line-461"></a>for one another. Because the user directs annotations, it's OK if some
<a name="line-462"></a>arguments shuffle around -- after all, it's what the user wants.
<a name="line-463"></a>Bottom line: none of this changes with visible type application.
<a name="line-464"></a>
<a name="line-465"></a>There are a number of wrinkles (below).
<a name="line-466"></a>
<a name="line-467"></a>Notice that Wrinkle 1 and 2 both require eta-expansion, which technically
<a name="line-468"></a>may increase termination.  We just put up with this, in exchange for getting
<a name="line-469"></a>more predictable type inference.
<a name="line-470"></a>
<a name="line-471"></a>Wrinkle 1: Note [Deep skolemisation]
<a name="line-472"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-473"></a>We want   (forall a. Int -&gt; a -&gt; a)  &lt;=  (Int -&gt; forall a. a-&gt;a)
<a name="line-474"></a>(see section 4.6 of "Practical type inference for higher rank types")
<a name="line-475"></a>So we must deeply-skolemise the RHS before we instantiate the LHS.
<a name="line-476"></a>
<a name="line-477"></a>That is why tc_sub_type starts with a call to tcSkolemise (which does the
<a name="line-478"></a>deep skolemisation), and then calls the DS variant (which assumes
<a name="line-479"></a>that expected_ty is deeply skolemised)
<a name="line-480"></a>
<a name="line-481"></a>Wrinkle 2: Note [Co/contra-variance of subsumption checking]
<a name="line-482"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-483"></a>Consider  g :: (Int -&gt; Int) -&gt; Int
<a name="line-484"></a>  f1 :: (forall a. a -&gt; a) -&gt; Int
<a name="line-485"></a>  f1 = g
<a name="line-486"></a>
<a name="line-487"></a>  f2 :: (forall a. a -&gt; a) -&gt; Int
<a name="line-488"></a>  f2 x = g x
<a name="line-489"></a>f2 will typecheck, and it would be odd/fragile if f1 did not.
<a name="line-490"></a>But f1 will only typecheck if we have that
<a name="line-491"></a>    (Int-&gt;Int) -&gt; Int  &lt;=  (forall a. a-&gt;a) -&gt; Int
<a name="line-492"></a>And that is only true if we do the full co/contravariant thing
<a name="line-493"></a>in the subsumption check.  That happens in the FunTy case of
<a name="line-494"></a>tcSubTypeDS_NC_O, and is the sole reason for the WpFun form of
<a name="line-495"></a>HsWrapper.
<a name="line-496"></a>
<a name="line-497"></a>Another powerful reason for doing this co/contra stuff is visible
<a name="line-498"></a>in Trac #9569, involving instantiation of constraint variables,
<a name="line-499"></a>and again involving eta-expansion.
<a name="line-500"></a>
<a name="line-501"></a>Wrinkle 3: Note [Higher rank types]
<a name="line-502"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-503"></a>Consider tc150:
<a name="line-504"></a>  f y = \ (x::forall a. a-&gt;a). blah
<a name="line-505"></a>The following happens:
<a name="line-506"></a>* We will infer the type of the RHS, ie with a res_ty = alpha.
<a name="line-507"></a>* Then the lambda will split  alpha := beta -&gt; gamma.
<a name="line-508"></a>* And then we'll check tcSubType IsSwapped beta (forall a. a-&gt;a)
<a name="line-509"></a>
<a name="line-510"></a>So it's important that we unify beta := forall a. a-&gt;a, rather than
<a name="line-511"></a>skolemising the type.
<a name="line-512"></a>-}</span>
<a name="line-513"></a>
<a name="line-514"></a>
<a name="line-515"></a><a name="tcSubTypeHR"></a><span class='hs-comment'>-- | Call this variant when you are in a higher-rank situation and</span>
<a name="line-516"></a><span class='hs-comment'>-- you know the right-hand type is deeply skolemised.</span>
<a name="line-517"></a><span class='hs-definition'>tcSubTypeHR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-518"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>CtOrigin</span>    <span class='hs-comment'>-- ^ of the actual type</span>
<a name="line-519"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>     <span class='hs-comment'>-- ^ If present, it has type ty_actual</span>
<a name="line-520"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-521"></a><span class='hs-definition'>tcSubTypeHR</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSubTypeDS_NC_O</span> <span class='hs-varid'>orig</span> <span class='hs-conid'>GenSigCtxt</span>
<a name="line-522"></a>
<a name="line-523"></a><a name="tcSubType"></a><span class='hs-definition'>tcSubType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-524"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>  <span class='hs-comment'>-- ^ If present, it has type ty_actual</span>
<a name="line-525"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-526"></a><span class='hs-comment'>-- Checks that actual &lt;= expected</span>
<a name="line-527"></a><span class='hs-comment'>-- Returns HsWrapper :: actual ~ expected</span>
<a name="line-528"></a><span class='hs-definition'>tcSubType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>maybe_thing</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-529"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSubTypeO</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-530"></a>  <span class='hs-keyword'>where</span>
<a name="line-531"></a>    <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_actual</span>
<a name="line-532"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_expected</span>
<a name="line-533"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorThing</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>maybe_thing</span> <span class='hs-layout'>}</span>
<a name="line-534"></a>
<a name="line-535"></a>
<a name="line-536"></a><a name="tcSubTypeET"></a><span class='hs-comment'>-- | This is like 'tcSubType' but accepts an 'ExpType' as the /actual/ type.</span>
<a name="line-537"></a><span class='hs-comment'>-- You probably want this only when looking at patterns, never expressions.</span>
<a name="line-538"></a><span class='hs-definition'>tcSubTypeET</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-539"></a><span class='hs-definition'>tcSubTypeET</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-540"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uExpTypeX</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varid'>ty_actual</span>
<a name="line-541"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkWpCastN</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkTcSymCo</span><span class='hs-layout'>)</span>
<a name="line-542"></a>              <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ty_a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcSubTypeO</span> <span class='hs-varid'>orig</span> <span class='hs-conid'>GenSigCtxt</span> <span class='hs-varid'>ty_a</span>
<a name="line-543"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>ty_expected</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-544"></a>
<a name="line-545"></a><a name="tcSubTypeET_NC"></a><span class='hs-comment'>-- | This is like 'tcSubType' but accepts an 'ExpType' as the /actual/ type.</span>
<a name="line-546"></a><span class='hs-comment'>-- You probably want this only when looking at patterns, never expressions.</span>
<a name="line-547"></a><span class='hs-comment'>-- Does not add context.</span>
<a name="line-548"></a><span class='hs-definition'>tcSubTypeET_NC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-549"></a><span class='hs-definition'>tcSubTypeET_NC</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty_actual</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Infer</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty_expected</span>
<a name="line-550"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpCastN</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkTcSymCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>unifyExpType</span> <span class='hs-varid'>noThing</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varid'>ty_actual</span>
<a name="line-551"></a><span class='hs-definition'>tcSubTypeET_NC</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Check</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty_expected</span>
<a name="line-552"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_sub_type</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected'</span>
<a name="line-553"></a>  <span class='hs-keyword'>where</span>
<a name="line-554"></a>    <span class='hs-varid'>ty_expected'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>ty_expected</span>
<a name="line-555"></a>    <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_actual</span>
<a name="line-556"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_expected'</span>
<a name="line-557"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-558"></a>
<a name="line-559"></a><a name="tcSubTypeO"></a><span class='hs-definition'>tcSubTypeO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>      <span class='hs-comment'>-- ^ of the actual type</span>
<a name="line-560"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>  <span class='hs-comment'>-- ^ of the expected type</span>
<a name="line-561"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-562"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span>
<a name="line-563"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-564"></a><span class='hs-definition'>tcSubTypeO</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-565"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSubTypeCtxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varop'>$</span>
<a name="line-566"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSubType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprCtOrigin</span> <span class='hs-varid'>origin</span>
<a name="line-567"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span>
<a name="line-568"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span>
<a name="line-569"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-570"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_sub_type</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-571"></a>  <span class='hs-keyword'>where</span>
<a name="line-572"></a>    <span class='hs-varid'>eq_orig</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>origin</span>
<a name="line-573"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-574"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_actual</span>
<a name="line-575"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_expected</span>
<a name="line-576"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-577"></a>
<a name="line-578"></a><a name="tcSubTypeDS"></a><span class='hs-definition'>tcSubTypeDS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>  <span class='hs-comment'>-- ^ has type ty_actual</span>
<a name="line-579"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-580"></a><span class='hs-comment'>-- Just like tcSubType, but with the additional precondition that</span>
<a name="line-581"></a><span class='hs-comment'>-- ty_expected is deeply skolemised (hence "DS")</span>
<a name="line-582"></a><span class='hs-definition'>tcSubTypeDS</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>m_expr</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-583"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSubTypeCtxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varop'>$</span>
<a name="line-584"></a>    <span class='hs-varid'>tcSubTypeDS_NC</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>m_expr</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-585"></a>
<a name="line-586"></a><a name="tcSubTypeDS_O"></a><span class='hs-comment'>-- | Like 'tcSubTypeDS', but takes a 'CtOrigin' to use when instantiating</span>
<a name="line-587"></a><span class='hs-comment'>-- the "actual" type</span>
<a name="line-588"></a><span class='hs-definition'>tcSubTypeDS_O</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-589"></a>              <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-590"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>
<a name="line-591"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-592"></a><span class='hs-definition'>tcSubTypeDS_O</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>maybe_thing</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-593"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSubTypeCtxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varop'>$</span>
<a name="line-594"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSubTypeDS_O"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprCtOrigin</span> <span class='hs-varid'>orig</span>
<a name="line-595"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span>
<a name="line-596"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span>
<a name="line-597"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-598"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcSubTypeDS_NC_O</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>maybe_thing</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-599"></a>
<a name="line-600"></a><a name="addSubTypeCtxt"></a><span class='hs-definition'>addSubTypeCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-601"></a><span class='hs-definition'>addSubTypeCtxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varid'>thing_inside</span>
<a name="line-602"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRhoTy</span> <span class='hs-varid'>ty_actual</span>        <span class='hs-comment'>-- If there is no polymorphism involved, the</span>
<a name="line-603"></a> <span class='hs-layout'>,</span> <span class='hs-varid'>isRhoExpTy</span> <span class='hs-varid'>ty_expected</span>   <span class='hs-comment'>-- TypeEqOrigin stuff (added by the _NC functions)</span>
<a name="line-604"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thing_inside</span>             <span class='hs-comment'>-- gives enough context by itself</span>
<a name="line-605"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-606"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>thing_inside</span>
<a name="line-607"></a>  <span class='hs-keyword'>where</span>
<a name="line-608"></a>    <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>tidy_env</span>
<a name="line-609"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ty_actual</span>
<a name="line-610"></a>                   <span class='hs-comment'>-- might not be filled if we're debugging. ugh.</span>
<a name="line-611"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mb_ty_expected</span>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readExpType_maybe</span> <span class='hs-varid'>ty_expected</span>
<a name="line-612"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_expected</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ty_expected</span> <span class='hs-keyword'>of</span>
<a name="line-613"></a>                                          <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>second</span> <span class='hs-varid'>mkCheckExpType</span> <span class='hs-varop'>&lt;$&gt;</span>
<a name="line-614"></a>                                                     <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ty</span>
<a name="line-615"></a>                                          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_expected</span><span class='hs-layout'>)</span>
<a name="line-616"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ty_expected</span>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readExpType</span> <span class='hs-varid'>ty_expected</span>
<a name="line-617"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_expected</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ty_expected</span>
<a name="line-618"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"When checking that:"</span><span class='hs-layout'>)</span>
<a name="line-619"></a>                                 <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>)</span>
<a name="line-620"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"is more polymorphic than:"</span><span class='hs-layout'>)</span>
<a name="line-621"></a>                                         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-622"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-623"></a>
<a name="line-624"></a><span class='hs-comment'>---------------</span>
<a name="line-625"></a><span class='hs-comment'>-- The "_NC" variants do not add a typechecker-error context;</span>
<a name="line-626"></a><span class='hs-comment'>-- the caller is assumed to do that</span>
<a name="line-627"></a>
<a name="line-628"></a><a name="tcSubType_NC"></a><span class='hs-definition'>tcSubType_NC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-629"></a><span class='hs-definition'>tcSubType_NC</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-630"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSubType_NC"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-631"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_sub_type</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-632"></a>  <span class='hs-keyword'>where</span>
<a name="line-633"></a>    <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_actual</span>
<a name="line-634"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_expected</span>
<a name="line-635"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-636"></a>
<a name="line-637"></a><a name="tcSubTypeDS_NC"></a><span class='hs-definition'>tcSubTypeDS_NC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-638"></a>               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-639"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>  <span class='hs-comment'>-- ^ If present, this has type ty_actual</span>
<a name="line-640"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-641"></a><span class='hs-definition'>tcSubTypeDS_NC</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>maybe_thing</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-642"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSubTypeDS_NC"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-643"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcSubTypeDS_NC_O</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>maybe_thing</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-644"></a>  <span class='hs-keyword'>where</span>
<a name="line-645"></a>    <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_actual</span>
<a name="line-646"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_expected</span>
<a name="line-647"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorThing</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>maybe_thing</span> <span class='hs-layout'>}</span>
<a name="line-648"></a>
<a name="line-649"></a><a name="tcSubTypeDS_NC_O"></a><span class='hs-definition'>tcSubTypeDS_NC_O</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-650"></a>                 <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>CtOrigin</span>   <span class='hs-comment'>-- origin used for instantiation only</span>
<a name="line-651"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-652"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-653"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-654"></a><span class='hs-comment'>-- Just like tcSubType, but with the additional precondition that</span>
<a name="line-655"></a><span class='hs-comment'>-- ty_expected is deeply skolemised</span>
<a name="line-656"></a><span class='hs-definition'>tcSubTypeDS_NC_O</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>m_thing</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>et</span>
<a name="line-657"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uExpTypeX</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>et</span>
<a name="line-658"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkWpCastN</span><span class='hs-layout'>)</span>
<a name="line-659"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>tc_sub_type_ds</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>)</span>
<a name="line-660"></a>  <span class='hs-keyword'>where</span>
<a name="line-661"></a>    <span class='hs-varid'>eq_orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>et</span>
<a name="line-662"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorThing</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>m_thing</span> <span class='hs-layout'>}</span>
<a name="line-663"></a>
<a name="line-664"></a><a name="tc_sub_type"></a><span class='hs-comment'>---------------</span>
<a name="line-665"></a><span class='hs-definition'>tc_sub_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>   <span class='hs-comment'>-- origin used when calling uType</span>
<a name="line-666"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>   <span class='hs-comment'>-- origin used when instantiating</span>
<a name="line-667"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-668"></a><span class='hs-definition'>tc_sub_type</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>et</span>
<a name="line-669"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uExpTypeX</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>et</span>
<a name="line-670"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkWpCastN</span><span class='hs-layout'>)</span>
<a name="line-671"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>tc_sub_tc_type</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>)</span>
<a name="line-672"></a>
<a name="line-673"></a><a name="tc_sub_tc_type"></a><span class='hs-definition'>tc_sub_tc_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>   <span class='hs-comment'>-- used when calling uType</span>
<a name="line-674"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>   <span class='hs-comment'>-- used when instantiating</span>
<a name="line-675"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-676"></a><span class='hs-definition'>tc_sub_tc_type</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-677"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv_actual</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty_actual</span> <span class='hs-comment'>-- See Note [Higher rank types]</span>
<a name="line-678"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTcTyVar</span> <span class='hs-varid'>tv_actual</span>
<a name="line-679"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyword'>of</span>
<a name="line-680"></a>           <span class='hs-conid'>Filled</span> <span class='hs-varid'>ty_actual'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc_sub_tc_type</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>inst_orig</span>
<a name="line-681"></a>                                               <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual'</span> <span class='hs-varid'>ty_expected</span>
<a name="line-682"></a>
<a name="line-683"></a>             <span class='hs-comment'>-- It's tempting to see if tv_actual can unify with a polytype</span>
<a name="line-684"></a>             <span class='hs-comment'>-- and, if so, call uType; otherwise, skolemise first. But this</span>
<a name="line-685"></a>             <span class='hs-comment'>-- is wrong, because skolemising will bump the TcLevel and the</span>
<a name="line-686"></a>             <span class='hs-comment'>-- unification will fail anyway.</span>
<a name="line-687"></a>             <span class='hs-comment'>-- It's also tempting to call uUnfilledVar directly, but calling</span>
<a name="line-688"></a>             <span class='hs-comment'>-- uType seems safer in the presence of possible refactoring</span>
<a name="line-689"></a>             <span class='hs-comment'>-- later.</span>
<a name="line-690"></a>           <span class='hs-conid'>Unfilled</span> <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkWpCastN</span> <span class='hs-varop'>&lt;$&gt;</span>
<a name="line-691"></a>                                <span class='hs-varid'>uType</span> <span class='hs-varid'>eq_orig</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-692"></a>
<a name="line-693"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- See Note [Deep skolemisation]</span>
<a name="line-694"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_wrap</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSkolemise</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varop'>$</span>
<a name="line-695"></a>                                  <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sk_rho</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-696"></a>                                  <span class='hs-varid'>tc_sub_type_ds</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span>
<a name="line-697"></a>                                                 <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>sk_rho</span>
<a name="line-698"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>inner_wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-699"></a>
<a name="line-700"></a><a name="tc_sub_type_ds"></a><span class='hs-comment'>---------------</span>
<a name="line-701"></a><span class='hs-definition'>tc_sub_type_ds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>    <span class='hs-comment'>-- used when calling uType</span>
<a name="line-702"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>    <span class='hs-comment'>-- used when instantiating</span>
<a name="line-703"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-704"></a><span class='hs-comment'>-- Just like tcSubType, but with the additional precondition that</span>
<a name="line-705"></a><span class='hs-comment'>-- ty_expected is deeply skolemised</span>
<a name="line-706"></a><span class='hs-definition'>tc_sub_type_ds</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-707"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-708"></a>  <span class='hs-keyword'>where</span>
<a name="line-709"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty_a</span> <span class='hs-varid'>ty_e</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty_a'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty_a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty_a'</span> <span class='hs-varid'>ty_e</span>
<a name="line-710"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty_e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty_e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty_a</span>  <span class='hs-varid'>ty_e'</span>
<a name="line-711"></a>
<a name="line-712"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv_a</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty_e</span>
<a name="line-713"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTcTyVar</span> <span class='hs-varid'>tv_a</span>
<a name="line-714"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyword'>of</span>
<a name="line-715"></a>               <span class='hs-conid'>Filled</span> <span class='hs-varid'>ty_a'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-716"></a>                 <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSubTypeDS_NC_O following filled act meta-tyvar:"</span>
<a name="line-717"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_a</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"--&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_a'</span><span class='hs-layout'>)</span>
<a name="line-718"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>tc_sub_type_ds</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_a'</span> <span class='hs-varid'>ty_e</span> <span class='hs-layout'>}</span>
<a name="line-719"></a>               <span class='hs-conid'>Unfilled</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unify</span> <span class='hs-layout'>}</span>
<a name="line-720"></a>
<a name="line-721"></a>    <span class='hs-comment'>-- Historical note (Sept 16): there was a case here for</span>
<a name="line-722"></a>    <span class='hs-comment'>--    go ty_a (TyVarTy alpha)</span>
<a name="line-723"></a>    <span class='hs-comment'>-- which, in the impredicative case unified  alpha := ty_a</span>
<a name="line-724"></a>    <span class='hs-comment'>-- where th_a is a polytype.  Not only is this probably bogus (we</span>
<a name="line-725"></a>    <span class='hs-comment'>-- simply do not have decent story for imprdicative types), but it</span>
<a name="line-726"></a>    <span class='hs-comment'>-- caused Trac #12616 because (also bizarrely) 'deriving' code had</span>
<a name="line-727"></a>    <span class='hs-comment'>-- -XImpredicativeTypes on.  I deleted the entire case.</span>
<a name="line-728"></a>
<a name="line-729"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>act_arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>act_res</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>exp_arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_res</span><span class='hs-layout'>)</span>
<a name="line-730"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPredTy</span> <span class='hs-varid'>act_arg</span><span class='hs-layout'>)</span>
<a name="line-731"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPredTy</span> <span class='hs-varid'>exp_arg</span><span class='hs-layout'>)</span>
<a name="line-732"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- See Note [Co/contra-variance of subsumption checking]</span>
<a name="line-733"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_sub_type_ds</span> <span class='hs-varid'>eq_orig</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>act_res</span> <span class='hs-varid'>exp_res</span>
<a name="line-734"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>arg_wrap</span>
<a name="line-735"></a>               <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_sub_tc_type</span> <span class='hs-varid'>eq_orig</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenOrigin</span>
<a name="line-736"></a>                                          <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-conid'>GenSigCtxt</span>
<a name="line-737"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>exp_arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-738"></a>                                 <span class='hs-varid'>ctxt</span> <span class='hs-varid'>exp_arg</span> <span class='hs-varid'>act_arg</span>
<a name="line-739"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpFun</span> <span class='hs-varid'>arg_wrap</span> <span class='hs-varid'>res_wrap</span> <span class='hs-varid'>exp_arg</span> <span class='hs-varid'>exp_res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-740"></a>               <span class='hs-comment'>-- arg_wrap :: exp_arg ~ act_arg</span>
<a name="line-741"></a>               <span class='hs-comment'>-- res_wrap :: act-res ~ exp_res</span>
<a name="line-742"></a>
<a name="line-743"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty_a</span> <span class='hs-varid'>ty_e</span>
<a name="line-744"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty_a</span>
<a name="line-745"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-746"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>in_rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topInstantiate</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ty_a</span>
<a name="line-747"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>body_wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_sub_type_ds</span>
<a name="line-748"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>eq_orig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_rho</span>
<a name="line-749"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span>
<a name="line-750"></a>                                         <span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-751"></a>                            <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>in_rho</span> <span class='hs-varid'>ty_e</span>
<a name="line-752"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>body_wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>in_wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-753"></a>
<a name="line-754"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Revert to unification</span>
<a name="line-755"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_and_unify</span>
<a name="line-756"></a>         <span class='hs-comment'>-- It's still possible that ty_actual has nested foralls. Instantiate</span>
<a name="line-757"></a>         <span class='hs-comment'>-- these, as there's no way unification will succeed with them in.</span>
<a name="line-758"></a>         <span class='hs-comment'>-- See typecheck/should_compile/T11305 for an example of when this</span>
<a name="line-759"></a>         <span class='hs-comment'>-- is important. The problem is that we're checking something like</span>
<a name="line-760"></a>         <span class='hs-comment'>--  a -&gt; forall b. b -&gt; b     &lt;=   alpha beta gamma</span>
<a name="line-761"></a>         <span class='hs-comment'>-- where we end up with alpha := (-&gt;)</span>
<a name="line-762"></a>
<a name="line-763"></a>    <span class='hs-varid'>inst_and_unify</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplyInstantiate</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ty_actual</span>
<a name="line-764"></a>
<a name="line-765"></a>                           <span class='hs-comment'>-- if we haven't recurred through an arrow, then</span>
<a name="line-766"></a>                           <span class='hs-comment'>-- the eq_orig will list ty_actual. In this case,</span>
<a name="line-767"></a>                           <span class='hs-comment'>-- we want to update the origin to reflect the</span>
<a name="line-768"></a>                           <span class='hs-comment'>-- instantiation. If we *have* recurred through</span>
<a name="line-769"></a>                           <span class='hs-comment'>-- an arrow, it's better not to update.</span>
<a name="line-770"></a>                        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eq_orig'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>eq_orig</span> <span class='hs-keyword'>of</span>
<a name="line-771"></a>                                <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_ty_actual</span> <span class='hs-layout'>}</span>
<a name="line-772"></a>                                  <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>orig_ty_actual</span> <span class='hs-varop'>`tcEqType`</span> <span class='hs-varid'>ty_actual</span>
<a name="line-773"></a>                                  <span class='hs-layout'>,</span>  <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isIdHsWrapper</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-774"></a>                                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>eq_orig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rho_a</span> <span class='hs-layout'>}</span>
<a name="line-775"></a>                                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>eq_orig</span>
<a name="line-776"></a>
<a name="line-777"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>cow</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>eq_orig'</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>rho_a</span> <span class='hs-varid'>ty_expected</span>
<a name="line-778"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpCastN</span> <span class='hs-varid'>cow</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-779"></a>
<a name="line-780"></a>
<a name="line-781"></a>     <span class='hs-comment'>-- use versions without synonyms expanded</span>
<a name="line-782"></a>    <span class='hs-varid'>unify</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpCastN</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>eq_orig</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-783"></a>
<a name="line-784"></a><a name="tcWrapResult"></a><span class='hs-comment'>-----------------</span>
<a name="line-785"></a><span class='hs-comment'>-- needs both un-type-checked (for origins) and type-checked (for wrapping)</span>
<a name="line-786"></a><span class='hs-comment'>-- expressions</span>
<a name="line-787"></a><span class='hs-definition'>tcWrapResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>
<a name="line-788"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-789"></a><span class='hs-definition'>tcWrapResult</span> <span class='hs-varid'>rn_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcWrapResultO</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprCtOrigin</span> <span class='hs-varid'>rn_expr</span><span class='hs-layout'>)</span>
<a name="line-790"></a>
<a name="line-791"></a><a name="tcWrapResultO"></a><span class='hs-comment'>-- | Sometimes we don't have a @HsExpr Name@ to hand, and this is more</span>
<a name="line-792"></a><span class='hs-comment'>-- convenient.</span>
<a name="line-793"></a><span class='hs-definition'>tcWrapResultO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>
<a name="line-794"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-795"></a><span class='hs-definition'>tcWrapResultO</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>actual_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-796"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcWrapResult"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Actual:  "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>actual_ty</span>
<a name="line-797"></a>                                      <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Expected:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-798"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cow</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubTypeDS_NC_O</span> <span class='hs-varid'>orig</span> <span class='hs-conid'>GenSigCtxt</span>
<a name="line-799"></a>                                 <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>actual_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-800"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrap</span> <span class='hs-varid'>cow</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-801"></a>
<a name="line-802"></a><a name="wrapFunResCoercion"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-803"></a><span class='hs-definition'>wrapFunResCoercion</span>
<a name="line-804"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Type of args</span>
<a name="line-805"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>       <span class='hs-comment'>-- HsExpr a -&gt; HsExpr b</span>
<a name="line-806"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>   <span class='hs-comment'>-- HsExpr (arg_tys -&gt; a) -&gt; HsExpr (arg_tys -&gt; b)</span>
<a name="line-807"></a><span class='hs-definition'>wrapFunResCoercion</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>co_fn_res</span>
<a name="line-808"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIdHsWrapper</span> <span class='hs-varid'>co_fn_res</span>
<a name="line-809"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>idHsWrapper</span>
<a name="line-810"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>arg_tys</span>
<a name="line-811"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co_fn_res</span>
<a name="line-812"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-813"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>arg_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalIds</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"sub"</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-814"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpLams</span> <span class='hs-varid'>arg_ids</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>co_fn_res</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpEvVarApps</span> <span class='hs-varid'>arg_ids</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-815"></a>
<a name="line-816"></a><a name="tcInfer"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-817"></a><span class='hs-comment'>-- | Infer a type using a fresh ExpType</span>
<a name="line-818"></a><span class='hs-comment'>-- See also Note [ExpType] in TcMType</span>
<a name="line-819"></a><span class='hs-definition'>tcInfer</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-820"></a><span class='hs-definition'>tcInfer</span> <span class='hs-varid'>tc_check</span>
<a name="line-821"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenInferExpType</span>
<a name="line-822"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_check</span> <span class='hs-varid'>res_ty</span>
<a name="line-823"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readExpType</span> <span class='hs-varid'>res_ty</span>
<a name="line-824"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-825"></a>
<a name="line-826"></a><span class='hs-comment'>{-
<a name="line-827"></a>************************************************************************
<a name="line-828"></a>*                                                                      *
<a name="line-829"></a>\subsection{Generalisation}
<a name="line-830"></a>*                                                                      *
<a name="line-831"></a>************************************************************************
<a name="line-832"></a>-}</span>
<a name="line-833"></a>
<a name="line-834"></a><a name="tcSkolemise"></a><span class='hs-comment'>-- | Take an "expected type" and strip off quantifiers to expose the</span>
<a name="line-835"></a><span class='hs-comment'>-- type underneath, binding the new skolems for the @thing_inside@.</span>
<a name="line-836"></a><span class='hs-comment'>-- The returned 'HsWrapper' has type @specific_ty -&gt; expected_ty@.</span>
<a name="line-837"></a><span class='hs-definition'>tcSkolemise</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-838"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-839"></a>         <span class='hs-comment'>-- ^ These are only ever used for scoped type variables.</span>
<a name="line-840"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-841"></a>        <span class='hs-comment'>-- ^ The expression has type: spec_ty -&gt; expected_ty</span>
<a name="line-842"></a>
<a name="line-843"></a><span class='hs-definition'>tcSkolemise</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>expected_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-844"></a>   <span class='hs-comment'>-- We expect expected_ty to be a forall-type</span>
<a name="line-845"></a>   <span class='hs-comment'>-- If not, the call is a no-op</span>
<a name="line-846"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSkolemise"</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-847"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplySkolemise</span> <span class='hs-varid'>expected_ty</span>
<a name="line-848"></a>
<a name="line-849"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-850"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>$</span>
<a name="line-851"></a>              <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSkolemise"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>
<a name="line-852"></a>                <span class='hs-varid'>ppr</span> <span class='hs-varid'>lvl</span><span class='hs-layout'>,</span>
<a name="line-853"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"expected_ty"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expected_ty</span><span class='hs-layout'>,</span>
<a name="line-854"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"inst tyvars"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span>
<a name="line-855"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"given"</span>       <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span>
<a name="line-856"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"inst type"</span>   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rho'</span> <span class='hs-keyglyph'>]</span>
<a name="line-857"></a>
<a name="line-858"></a>        <span class='hs-comment'>-- Generally we must check that the "forall_tvs" havn't been constrained</span>
<a name="line-859"></a>        <span class='hs-comment'>-- The interesting bit here is that we must include the free variables</span>
<a name="line-860"></a>        <span class='hs-comment'>-- of the expected_ty.  Here's an example:</span>
<a name="line-861"></a>        <span class='hs-comment'>--       runST (newVar True)</span>
<a name="line-862"></a>        <span class='hs-comment'>-- Here, if we don't make a check, we'll get a type (ST s (MutVar s Bool))</span>
<a name="line-863"></a>        <span class='hs-comment'>-- for (newVar True), with s fresh.  Then we unify with the runST's arg type</span>
<a name="line-864"></a>        <span class='hs-comment'>-- forall s'. ST s' a. That unifies s' with s, and a with MutVar s Bool.</span>
<a name="line-865"></a>        <span class='hs-comment'>-- So now s' isn't unconstrained because it's linked to a.</span>
<a name="line-866"></a>        <span class='hs-comment'>--</span>
<a name="line-867"></a>        <span class='hs-comment'>-- However [Oct 10] now that the untouchables are a range of</span>
<a name="line-868"></a>        <span class='hs-comment'>-- TcTyVars, all this is handled automatically with no need for</span>
<a name="line-869"></a>        <span class='hs-comment'>-- extra faffing around</span>
<a name="line-870"></a>
<a name="line-871"></a>        <span class='hs-comment'>-- Use the *instantiated* type in the SkolemInfo</span>
<a name="line-872"></a>        <span class='hs-comment'>-- so that the names of displayed type variables line up</span>
<a name="line-873"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigSkol</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varop'>$</span>
<a name="line-874"></a>                                        <span class='hs-varid'>mkFunTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>varType</span> <span class='hs-varid'>given</span><span class='hs-layout'>)</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>)</span>
<a name="line-875"></a>
<a name="line-876"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>given</span> <span class='hs-varop'>$</span>
<a name="line-877"></a>                                <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>rho'</span>
<a name="line-878"></a>
<a name="line-879"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpLet</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-880"></a>          <span class='hs-comment'>-- The ev_binds returned by checkConstraints is very</span>
<a name="line-881"></a>          <span class='hs-comment'>-- often empty, in which case mkWpLet is a no-op</span>
<a name="line-882"></a>
<a name="line-883"></a><a name="tcSkolemiseET"></a><span class='hs-comment'>-- | Variant of 'tcSkolemise' that takes an ExpType</span>
<a name="line-884"></a><span class='hs-definition'>tcSkolemiseET</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span>
<a name="line-885"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-886"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-887"></a><span class='hs-definition'>tcSkolemiseET</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>et</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Infer</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-888"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>et</span>
<a name="line-889"></a><span class='hs-definition'>tcSkolemiseET</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Check</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-890"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSkolemise</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkCheckExpType</span>
<a name="line-891"></a>
<a name="line-892"></a><a name="checkConstraints"></a><span class='hs-definition'>checkConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-893"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- Skolems</span>
<a name="line-894"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- Given</span>
<a name="line-895"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span>
<a name="line-896"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-897"></a>
<a name="line-898"></a><span class='hs-definition'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>thing_inside</span>
<a name="line-899"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-900"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>buildImplication</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>thing_inside</span>
<a name="line-901"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitImplications</span> <span class='hs-varid'>implics</span>
<a name="line-902"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-903"></a>
<a name="line-904"></a><a name="buildImplication"></a><span class='hs-definition'>buildImplication</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-905"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- Skolems</span>
<a name="line-906"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- Given</span>
<a name="line-907"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span>
<a name="line-908"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-909"></a><span class='hs-definition'>buildImplication</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>thing_inside</span>
<a name="line-910"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-911"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>deferred_type_errors</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goptM</span> <span class='hs-conid'>Opt_DeferTypeErrors</span> <span class='hs-varop'>&lt;||&gt;</span>
<a name="line-912"></a>                                 <span class='hs-varid'>goptM</span> <span class='hs-conid'>Opt_DeferTypedHoles</span>
<a name="line-913"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>given</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>deferred_type_errors</span> <span class='hs-varop'>||</span>
<a name="line-914"></a>                                            <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTopTcLevel</span> <span class='hs-varid'>tc_lvl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-915"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-916"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-917"></a>      <span class='hs-comment'>-- Fast path.  We check every function argument with</span>
<a name="line-918"></a>      <span class='hs-comment'>-- tcPolyExpr, which uses tcSkolemise and hence checkConstraints.</span>
<a name="line-919"></a>      <span class='hs-comment'>-- But with the solver producing unlifted equalities, we need</span>
<a name="line-920"></a>      <span class='hs-comment'>-- to have an EvBindsVar for them when they might be deferred to</span>
<a name="line-921"></a>      <span class='hs-comment'>-- runtime. Otherwise, they end up as top-level unlifted bindings,</span>
<a name="line-922"></a>      <span class='hs-comment'>-- which are verboten. See also Note [Deferred errors for coercion holes]</span>
<a name="line-923"></a>      <span class='hs-comment'>-- in TcErrors.</span>
<a name="line-924"></a>         <span class='hs-keyword'>else</span>
<a name="line-925"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndCaptureConstraints</span> <span class='hs-varid'>thing_inside</span>
<a name="line-926"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>buildImplicationFor</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>wanted</span>
<a name="line-927"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-928"></a>
<a name="line-929"></a><a name="buildImplicationFor"></a><span class='hs-definition'>buildImplicationFor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-930"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-931"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>)</span>
<a name="line-932"></a><span class='hs-definition'>buildImplicationFor</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>wanted</span>
<a name="line-933"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanted</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>given</span>
<a name="line-934"></a>             <span class='hs-comment'>-- Optimisation : if there are no wanteds, and no givens</span>
<a name="line-935"></a>             <span class='hs-comment'>-- don't generate an implication at all.</span>
<a name="line-936"></a>             <span class='hs-comment'>-- Reason for the (null given): we don't want to lose</span>
<a name="line-937"></a>             <span class='hs-comment'>-- the "inaccessible alternative" error check</span>
<a name="line-938"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>)</span>
<a name="line-939"></a>
<a name="line-940"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-941"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-layout'>)</span>
<a name="line-942"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-layout'>)</span>
<a name="line-943"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTcEvBinds</span>
<a name="line-944"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-945"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tclvl</span>
<a name="line-946"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-947"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-948"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span>
<a name="line-949"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span>
<a name="line-950"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_status</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC_Unsolved</span>
<a name="line-951"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-952"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-953"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span>
<a name="line-954"></a>
<a name="line-955"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>implic</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>ev_binds_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-956"></a>
<a name="line-957"></a><span class='hs-comment'>{-
<a name="line-958"></a>************************************************************************
<a name="line-959"></a>*                                                                      *
<a name="line-960"></a>                Boxy unification
<a name="line-961"></a>*                                                                      *
<a name="line-962"></a>************************************************************************
<a name="line-963"></a>
<a name="line-964"></a>The exported functions are all defined as versions of some
<a name="line-965"></a>non-exported generic functions.
<a name="line-966"></a>-}</span>
<a name="line-967"></a>
<a name="line-968"></a><a name="unifyType_"></a><span class='hs-comment'>-- | Unify two types, discarding a resultant coercion. Any constraints</span>
<a name="line-969"></a><span class='hs-comment'>-- generated will still need to be solved, however.</span>
<a name="line-970"></a><span class='hs-definition'>unifyType_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>  <span class='hs-comment'>-- ^ If present, has type 'ty1'</span>
<a name="line-971"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-972"></a><span class='hs-definition'>unifyType_</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>void</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-973"></a>
<a name="line-974"></a><a name="unifyType"></a><span class='hs-definition'>unifyType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>   <span class='hs-comment'>-- ^ If present, has type 'ty1'</span>
<a name="line-975"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercionN</span>
<a name="line-976"></a><span class='hs-comment'>-- Actual and expected types</span>
<a name="line-977"></a><span class='hs-comment'>-- Returns a coercion : ty1 ~ ty2</span>
<a name="line-978"></a><span class='hs-definition'>unifyType</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-979"></a>  <span class='hs-keyword'>where</span>
<a name="line-980"></a>    <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>ty2</span>
<a name="line-981"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorThing</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>thing</span> <span class='hs-layout'>}</span>
<a name="line-982"></a>
<a name="line-983"></a><a name="unifyExpType"></a><span class='hs-comment'>-- | Variant of 'unifyType' that takes an 'ExpType' as its second type</span>
<a name="line-984"></a><span class='hs-definition'>unifyExpType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-985"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercionN</span>
<a name="line-986"></a><span class='hs-definition'>unifyExpType</span> <span class='hs-varid'>mb_thing</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-987"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uExpType</span> <span class='hs-varid'>ty_orig</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-988"></a>  <span class='hs-keyword'>where</span>
<a name="line-989"></a>    <span class='hs-varid'>ty_orig</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>
<a name="line-990"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span>
<a name="line-991"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorThing</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mb_thing</span> <span class='hs-layout'>}</span>
<a name="line-992"></a>
<a name="line-993"></a><a name="noThing"></a><span class='hs-comment'>-- | Use this instead of 'Nothing' when calling 'unifyType' without</span>
<a name="line-994"></a><span class='hs-comment'>-- a good "thing" (where the "thing" has the "actual" type passed in)</span>
<a name="line-995"></a><span class='hs-comment'>-- This has an 'Outputable' instance, avoiding amgiguity problems.</span>
<a name="line-996"></a><span class='hs-definition'>noThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-997"></a><span class='hs-definition'>noThing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-998"></a>
<a name="line-999"></a><a name="unifyKind"></a><span class='hs-definition'>unifyKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1000"></a><span class='hs-definition'>unifyKind</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-conid'>KindLevel</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1001"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>ty2</span>
<a name="line-1002"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorThing</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>thing</span> <span class='hs-layout'>}</span>
<a name="line-1003"></a>
<a name="line-1004"></a><a name="unifyPred"></a><span class='hs-comment'>---------------</span>
<a name="line-1005"></a><span class='hs-definition'>unifyPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercionN</span>
<a name="line-1006"></a><span class='hs-comment'>-- Actual and expected types</span>
<a name="line-1007"></a><span class='hs-definition'>unifyPred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>noThing</span>
<a name="line-1008"></a>
<a name="line-1009"></a><a name="unifyTheta"></a><span class='hs-comment'>---------------</span>
<a name="line-1010"></a><span class='hs-definition'>unifyTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercionN</span><span class='hs-keyglyph'>]</span>
<a name="line-1011"></a><span class='hs-comment'>-- Actual and expected types</span>
<a name="line-1012"></a><span class='hs-definition'>unifyTheta</span> <span class='hs-varid'>theta1</span> <span class='hs-varid'>theta2</span>
<a name="line-1013"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>equalLength</span> <span class='hs-varid'>theta1</span> <span class='hs-varid'>theta2</span><span class='hs-layout'>)</span>
<a name="line-1014"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Contexts differ in length"</span><span class='hs-layout'>,</span>
<a name="line-1015"></a>                         <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Use RelaxedPolyRec to allow this"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1016"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>unifyPred</span> <span class='hs-varid'>theta1</span> <span class='hs-varid'>theta2</span> <span class='hs-layout'>}</span>
<a name="line-1017"></a>
<a name="line-1018"></a><span class='hs-comment'>{-
<a name="line-1019"></a>%************************************************************************
<a name="line-1020"></a>%*                                                                      *
<a name="line-1021"></a>                 uType and friends
<a name="line-1022"></a>%*                                                                      *
<a name="line-1023"></a>%************************************************************************
<a name="line-1024"></a>
<a name="line-1025"></a>uType is the heart of the unifier.
<a name="line-1026"></a>-}</span>
<a name="line-1027"></a>
<a name="line-1028"></a><a name="uExpType"></a><span class='hs-definition'>uExpType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1029"></a><span class='hs-definition'>uExpType</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>et</span>
<a name="line-1030"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uExpTypeX</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>et</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-1031"></a>    <span class='hs-varid'>uType</span> <span class='hs-varid'>orig</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>ty1</span>
<a name="line-1032"></a>
<a name="line-1033"></a><a name="uExpTypeX"></a><span class='hs-comment'>-- | Tries to unify with an ExpType. If the ExpType is filled in, calls the first</span>
<a name="line-1034"></a><span class='hs-comment'>-- continuation with the produced coercion. Otherwise, calls the second</span>
<a name="line-1035"></a><span class='hs-comment'>-- continuation. This can happen either with a Check or with an untouchable</span>
<a name="line-1036"></a><span class='hs-comment'>-- ExpType that reverts to a tau-type. See Note [TcLevel of ExpType]</span>
<a name="line-1037"></a><span class='hs-definition'>uExpTypeX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpType</span>
<a name="line-1038"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Infer case, co :: TcType ~N ExpType</span>
<a name="line-1039"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- Check / untouchable case</span>
<a name="line-1040"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1041"></a><span class='hs-definition'>uExpTypeX</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>et</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Infer</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>ki</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>coercion_cont</span> <span class='hs-varid'>type_cont</span>
<a name="line-1042"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cur_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1043"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>cur_lvl</span> <span class='hs-varop'>`sameDepthAs`</span> <span class='hs-varid'>tc_lvl</span>
<a name="line-1044"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ki_co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>kind_orig</span> <span class='hs-conid'>KindLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ki</span>
<a name="line-1045"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>writeExpType</span> <span class='hs-varid'>et</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>ki_co</span><span class='hs-layout'>)</span>
<a name="line-1046"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>coercion_cont</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`mkTcCoherenceRightCo`</span> <span class='hs-varid'>ki_co</span> <span class='hs-layout'>}</span>
<a name="line-1047"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Preventing writing to untouchable ExpType"</span> <span class='hs-varid'>empty</span>
<a name="line-1048"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expTypeToType</span> <span class='hs-varid'>et</span> <span class='hs-comment'>-- See Note [TcLevel of ExpType]</span>
<a name="line-1049"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>type_cont</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-1050"></a>  <span class='hs-keyword'>where</span>
<a name="line-1051"></a>    <span class='hs-varid'>kind_orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>ty1</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>TypeLevel</span><span class='hs-layout'>)</span>
<a name="line-1052"></a><span class='hs-definition'>uExpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Check</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>type_cont</span>
<a name="line-1053"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>type_cont</span> <span class='hs-varid'>ty2</span>
<a name="line-1054"></a>
<a name="line-1055"></a><a name="uType"></a><span class='hs-comment'>------------</span>
<a name="line-1056"></a><span class='hs-definition'>uType</span><span class='hs-layout'>,</span> <span class='hs-varid'>uType_defer</span>
<a name="line-1057"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1058"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-1059"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- ty1 is the *actual* type</span>
<a name="line-1060"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- ty2 is the *expected* type</span>
<a name="line-1061"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>
<a name="line-1062"></a>
<a name="line-1063"></a><a name="uType_defer"></a><span class='hs-comment'>--------------</span>
<a name="line-1064"></a><span class='hs-comment'>-- It is always safe to defer unification to the main constraint solver</span>
<a name="line-1065"></a><span class='hs-comment'>-- See Note [Deferred unification]</span>
<a name="line-1066"></a><span class='hs-definition'>uType_defer</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1067"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hole</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newCoercionHole</span>
<a name="line-1068"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCtLocM</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>t_or_k</span><span class='hs-layout'>)</span>
<a name="line-1069"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitSimple</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varop'>$</span>
<a name="line-1070"></a>             <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span>
<a name="line-1071"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1072"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-1073"></a>
<a name="line-1074"></a>       <span class='hs-comment'>-- Error trace only</span>
<a name="line-1075"></a>       <span class='hs-comment'>-- NB. do *not* call mkErrInfo unless tracing is on, because</span>
<a name="line-1076"></a>       <span class='hs-comment'>-- it is hugely expensive (#5631)</span>
<a name="line-1077"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>whenDOptM</span> <span class='hs-conid'>Opt_D_dump_tc_trace</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1078"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getErrCtxt</span>
<a name="line-1079"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkErrInfo</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>ctxt</span>
<a name="line-1080"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"utype_defer"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hole</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span>
<a name="line-1081"></a>                                           <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCtOrigin</span> <span class='hs-varid'>origin</span><span class='hs-layout'>,</span> <span class='hs-varid'>doc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1082"></a>            <span class='hs-layout'>}</span>
<a name="line-1083"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHoleCo</span> <span class='hs-varid'>hole</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1084"></a>
<a name="line-1085"></a><span class='hs-comment'>--------------</span>
<a name="line-1086"></a><span class='hs-definition'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-varid'>orig_ty2</span>
<a name="line-1087"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1088"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"u_tys "</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-1089"></a>              <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tclvl"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span>
<a name="line-1090"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"~"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-1091"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>pprCtOrigin</span> <span class='hs-varid'>origin</span><span class='hs-keyglyph'>]</span>
<a name="line-1092"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-varid'>orig_ty2</span>
<a name="line-1093"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co</span>
<a name="line-1094"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"u_tys yields no coercion"</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-1095"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"u_tys yields coercion:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1096"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-1097"></a>  <span class='hs-keyword'>where</span>
<a name="line-1098"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>
<a name="line-1099"></a>        <span class='hs-comment'>-- The arguments to 'go' are always semantically identical</span>
<a name="line-1100"></a>        <span class='hs-comment'>-- to orig_ty{1,2} except for looking through type synonyms</span>
<a name="line-1101"></a>
<a name="line-1102"></a>        <span class='hs-comment'>-- Variables; go for uVar</span>
<a name="line-1103"></a>        <span class='hs-comment'>-- Note that we pass in *original* (before synonym expansion),</span>
<a name="line-1104"></a>        <span class='hs-comment'>-- so that type variables tend to get filled in with</span>
<a name="line-1105"></a>        <span class='hs-comment'>-- the most informative version of the type</span>
<a name="line-1106"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-1107"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTcTyVar</span> <span class='hs-varid'>tv1</span>
<a name="line-1108"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyword'>of</span>
<a name="line-1109"></a>               <span class='hs-conid'>Filled</span> <span class='hs-varid'>ty1</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"found filled tyvar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":-&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-1110"></a>                                  <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-1111"></a>               <span class='hs-conid'>Unfilled</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-conid'>NotSwapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-1112"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-1113"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTcTyVar</span> <span class='hs-varid'>tv2</span>
<a name="line-1114"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyword'>of</span>
<a name="line-1115"></a>               <span class='hs-conid'>Filled</span> <span class='hs-varid'>ty2</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"found filled tyvar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":-&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1116"></a>                                  <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-1117"></a>               <span class='hs-conid'>Unfilled</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-conid'>IsSwapped</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>}</span>
<a name="line-1118"></a>
<a name="line-1119"></a>      <span class='hs-comment'>-- See Note [Expanding synonyms during unification]</span>
<a name="line-1120"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1121"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>
<a name="line-1122"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty1</span>
<a name="line-1123"></a>
<a name="line-1124"></a>        <span class='hs-comment'>-- See Note [Expanding synonyms during unification]</span>
<a name="line-1125"></a>        <span class='hs-comment'>--</span>
<a name="line-1126"></a>        <span class='hs-comment'>-- Also NB that we recurse to 'go' so that we don't push a</span>
<a name="line-1127"></a>        <span class='hs-comment'>-- new item on the origin stack. As a result if we have</span>
<a name="line-1128"></a>        <span class='hs-comment'>--   type Foo = Int</span>
<a name="line-1129"></a>        <span class='hs-comment'>-- and we try to unify  Foo ~ Bool</span>
<a name="line-1130"></a>        <span class='hs-comment'>-- we'll end up saying "can't match Foo with Bool"</span>
<a name="line-1131"></a>        <span class='hs-comment'>-- rather than "can't match "Int with Bool".  See Trac #4535.</span>
<a name="line-1132"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1133"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2</span>
<a name="line-1134"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span>  <span class='hs-varid'>ty2'</span>
<a name="line-1135"></a>
<a name="line-1136"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2</span>
<a name="line-1137"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1138"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoherenceLeftCo</span> <span class='hs-varid'>co_tys</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1139"></a>
<a name="line-1140"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1141"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1142"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoherenceRightCo</span> <span class='hs-varid'>co_tys</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1143"></a>
<a name="line-1144"></a>        <span class='hs-comment'>-- Functions (or predicate functions) just check the two parts</span>
<a name="line-1145"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>fun1</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>fun2</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span>
<a name="line-1146"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>fun1</span> <span class='hs-varid'>fun2</span>
<a name="line-1147"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co_r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>arg1</span> <span class='hs-varid'>arg2</span>
<a name="line-1148"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co_l</span> <span class='hs-varid'>co_r</span> <span class='hs-layout'>}</span>
<a name="line-1149"></a>
<a name="line-1150"></a>        <span class='hs-comment'>-- Always defer if a type synonym family (type function)</span>
<a name="line-1151"></a>        <span class='hs-comment'>-- is involved.  (Data families behave rigidly.)</span>
<a name="line-1152"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-1153"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1154"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1155"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1156"></a>
<a name="line-1157"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-1158"></a>      <span class='hs-comment'>-- See Note [Mismatched type lists and application decomposition]</span>
<a name="line-1159"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys2</span>
<a name="line-1160"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isGenerativeTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc1</span> <span class='hs-layout'>)</span>
<a name="line-1161"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-1162"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>}</span>
<a name="line-1163"></a>
<a name="line-1164"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1165"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n</span>
<a name="line-1166"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty</span>
<a name="line-1167"></a>
<a name="line-1168"></a>        <span class='hs-comment'>-- See Note [Care with type applications]</span>
<a name="line-1169"></a>        <span class='hs-comment'>-- Do not decompose FunTy against App;</span>
<a name="line-1170"></a>        <span class='hs-comment'>-- it's often a type error, so leave it for the constraint solver</span>
<a name="line-1171"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-1172"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span>
<a name="line-1173"></a>
<a name="line-1174"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>ts2</span><span class='hs-layout'>)</span>
<a name="line-1175"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ts2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>ts2</span>
<a name="line-1176"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>mightBeUnsaturatedTyCon</span> <span class='hs-varid'>tc2</span> <span class='hs-layout'>)</span>
<a name="line-1177"></a>        <span class='hs-varid'>go_app</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>ts2'</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2'</span>
<a name="line-1178"></a>
<a name="line-1179"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>ts1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-1180"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ts1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>ts1</span>
<a name="line-1181"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>mightBeUnsaturatedTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-layout'>)</span>
<a name="line-1182"></a>        <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>ts1'</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1'</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span>
<a name="line-1183"></a>
<a name="line-1184"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1185"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionType</span> <span class='hs-varid'>co1</span>
<a name="line-1186"></a>                 <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionType</span> <span class='hs-varid'>co2</span>
<a name="line-1187"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>kco</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>orig_ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>origin</span>
<a name="line-1188"></a>                                        <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>t_or_k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1189"></a>                          <span class='hs-conid'>KindLevel</span>
<a name="line-1190"></a>                          <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1191"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkProofIrrelCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>kco</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-layout'>}</span>
<a name="line-1192"></a>
<a name="line-1193"></a>        <span class='hs-comment'>-- Anything else fails</span>
<a name="line-1194"></a>        <span class='hs-comment'>-- E.g. unifying for-all types, which is relative unusual</span>
<a name="line-1195"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1196"></a>
<a name="line-1197"></a>    <span class='hs-comment'>------------------</span>
<a name="line-1198"></a>    <span class='hs-varid'>defer</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>   <span class='hs-comment'>-- See Note [Check for equality before deferring]</span>
<a name="line-1199"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`tcEqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-1200"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType_defer</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1201"></a>
<a name="line-1202"></a>    <span class='hs-comment'>------------------</span>
<a name="line-1203"></a>    <span class='hs-varid'>go_app</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span>
<a name="line-1204"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>
<a name="line-1205"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co_t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1206"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co_s</span> <span class='hs-varid'>co_t</span> <span class='hs-layout'>}</span>
<a name="line-1207"></a>
<a name="line-1208"></a><span class='hs-comment'>{- Note [Check for equality before deferring]
<a name="line-1209"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1210"></a>Particularly in ambiguity checks we can get equalities like (ty ~ ty).
<a name="line-1211"></a>If ty involves a type function we may defer, which isn't very sensible.
<a name="line-1212"></a>An egregious example of this was in test T9872a, which has a type signature
<a name="line-1213"></a>       Proxy :: Proxy (Solutions Cubes)
<a name="line-1214"></a>Doing the ambiguity check on this signature generates the equality
<a name="line-1215"></a>   Solutions Cubes ~ Solutions Cubes
<a name="line-1216"></a>and currently the constraint solver normalises both sides at vast cost.
<a name="line-1217"></a>This little short-cut in 'defer' helps quite a bit.
<a name="line-1218"></a>
<a name="line-1219"></a>Note [Care with type applications]
<a name="line-1220"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1221"></a>Note: type applications need a bit of care!
<a name="line-1222"></a>They can match FunTy and TyConApp, so use splitAppTy_maybe
<a name="line-1223"></a>NB: we've already dealt with type variables and Notes,
<a name="line-1224"></a>so if one type is an App the other one jolly well better be too
<a name="line-1225"></a>
<a name="line-1226"></a>Note [Mismatched type lists and application decomposition]
<a name="line-1227"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1228"></a>When we find two TyConApps, you might think that the argument lists
<a name="line-1229"></a>are guaranteed equal length.  But they aren't. Consider matching
<a name="line-1230"></a>        w (T x) ~ Foo (T x y)
<a name="line-1231"></a>We do match (w ~ Foo) first, but in some circumstances we simply create
<a name="line-1232"></a>a deferred constraint; and then go ahead and match (T x ~ T x y).
<a name="line-1233"></a>This came up in Trac #3950.
<a name="line-1234"></a>
<a name="line-1235"></a>So either
<a name="line-1236"></a>   (a) either we must check for identical argument kinds
<a name="line-1237"></a>       when decomposing applications,
<a name="line-1238"></a>
<a name="line-1239"></a>   (b) or we must be prepared for ill-kinded unification sub-problems
<a name="line-1240"></a>
<a name="line-1241"></a>Currently we adopt (b) since it seems more robust -- no need to maintain
<a name="line-1242"></a>a global invariant.
<a name="line-1243"></a>
<a name="line-1244"></a>Note [Expanding synonyms during unification]
<a name="line-1245"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1246"></a>We expand synonyms during unification, but:
<a name="line-1247"></a> * We expand *after* the variable case so that we tend to unify
<a name="line-1248"></a>   variables with un-expanded type synonym. This just makes it
<a name="line-1249"></a>   more likely that the inferred types will mention type synonyms
<a name="line-1250"></a>   understandable to the user
<a name="line-1251"></a>
<a name="line-1252"></a> * We expand *before* the TyConApp case.  For example, if we have
<a name="line-1253"></a>      type Phantom a = Int
<a name="line-1254"></a>   and are unifying
<a name="line-1255"></a>      Phantom Int ~ Phantom Char
<a name="line-1256"></a>   it is *wrong* to unify Int and Char.
<a name="line-1257"></a>
<a name="line-1258"></a> * The problem case immediately above can happen only with arguments
<a name="line-1259"></a>   to the tycon. So we check for nullary tycons *before* expanding.
<a name="line-1260"></a>   This is particularly helpful when checking (* ~ *), because * is
<a name="line-1261"></a>   now a type synonym.
<a name="line-1262"></a>
<a name="line-1263"></a>Note [Deferred Unification]
<a name="line-1264"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1265"></a>We may encounter a unification ty1 ~ ty2 that cannot be performed syntactically,
<a name="line-1266"></a>and yet its consistency is undetermined. Previously, there was no way to still
<a name="line-1267"></a>make it consistent. So a mismatch error was issued.
<a name="line-1268"></a>
<a name="line-1269"></a>Now these unifications are deferred until constraint simplification, where type
<a name="line-1270"></a>family instances and given equations may (or may not) establish the consistency.
<a name="line-1271"></a>Deferred unifications are of the form
<a name="line-1272"></a>                F ... ~ ...
<a name="line-1273"></a>or              x ~ ...
<a name="line-1274"></a>where F is a type function and x is a type variable.
<a name="line-1275"></a>E.g.
<a name="line-1276"></a>        id :: x ~ y =&gt; x -&gt; y
<a name="line-1277"></a>        id e = e
<a name="line-1278"></a>
<a name="line-1279"></a>involves the unification x = y. It is deferred until we bring into account the
<a name="line-1280"></a>context x ~ y to establish that it holds.
<a name="line-1281"></a>
<a name="line-1282"></a>If available, we defer original types (rather than those where closed type
<a name="line-1283"></a>synonyms have already been expanded via tcCoreView).  This is, as usual, to
<a name="line-1284"></a>improve error messages.
<a name="line-1285"></a>
<a name="line-1286"></a>
<a name="line-1287"></a>************************************************************************
<a name="line-1288"></a>*                                                                      *
<a name="line-1289"></a>                 uVar and friends
<a name="line-1290"></a>*                                                                      *
<a name="line-1291"></a>************************************************************************
<a name="line-1292"></a>
<a name="line-1293"></a>@uVar@ is called when at least one of the types being unified is a
<a name="line-1294"></a>variable.  It does {\em not} assume that the variable is a fixed point
<a name="line-1295"></a>of the substitution; rather, notice that @uVar@ (defined below) nips
<a name="line-1296"></a>back into @uTys@ if it turns out that the variable is already bound.
<a name="line-1297"></a>-}</span>
<a name="line-1298"></a>
<a name="line-1299"></a><a name="uUnfilledVar"></a><span class='hs-comment'>----------</span>
<a name="line-1300"></a><span class='hs-definition'>uUnfilledVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1301"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-1302"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SwapFlag</span>
<a name="line-1303"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- Tyvar 1</span>
<a name="line-1304"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span>      <span class='hs-comment'>-- Type 2</span>
<a name="line-1305"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>
<a name="line-1306"></a><span class='hs-comment'>-- "Unfilled" means that the variable is definitely not a filled-in meta tyvar</span>
<a name="line-1307"></a><span class='hs-comment'>--            It might be a skolem, or untouchable, or meta</span>
<a name="line-1308"></a>
<a name="line-1309"></a><span class='hs-definition'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1310"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty2</span>
<a name="line-1311"></a>             <span class='hs-comment'>-- Zonk to expose things to the</span>
<a name="line-1312"></a>             <span class='hs-comment'>-- occurs check, and so that if ty2</span>
<a name="line-1313"></a>             <span class='hs-comment'>-- looks like a type variable then it</span>
<a name="line-1314"></a>             <span class='hs-comment'>-- /is/ a type variable</span>
<a name="line-1315"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>uUnfilledVar1</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-1316"></a>
<a name="line-1317"></a><a name="uUnfilledVar1"></a><span class='hs-comment'>----------</span>
<a name="line-1318"></a><span class='hs-definition'>uUnfilledVar1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1319"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-1320"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SwapFlag</span>
<a name="line-1321"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- Tyvar 1</span>
<a name="line-1322"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span>      <span class='hs-comment'>-- Type 2, zonked</span>
<a name="line-1323"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>
<a name="line-1324"></a><span class='hs-definition'>uUnfilledVar1</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1325"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-1326"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tv2</span>
<a name="line-1327"></a>
<a name="line-1328"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1329"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uUnfilledVar2</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1330"></a>
<a name="line-1331"></a>  <span class='hs-keyword'>where</span>
<a name="line-1332"></a>    <span class='hs-comment'>-- 'go' handles the case where both are</span>
<a name="line-1333"></a>    <span class='hs-comment'>-- tyvars so we might want to swap</span>
<a name="line-1334"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv2</span>  <span class='hs-comment'>-- Same type variable =&gt; no-op</span>
<a name="line-1335"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1336"></a>
<a name="line-1337"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>swapOverTyVars</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span>   <span class='hs-comment'>-- Distinct type variables</span>
<a name="line-1338"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uUnfilledVar2</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-layout'>(</span><span class='hs-varid'>flipSwap</span> <span class='hs-varid'>swapped</span><span class='hs-layout'>)</span>
<a name="line-1339"></a>                           <span class='hs-varid'>tv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-1340"></a>
<a name="line-1341"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1342"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uUnfilledVar2</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1343"></a>
<a name="line-1344"></a><a name="uUnfilledVar2"></a><span class='hs-comment'>----------</span>
<a name="line-1345"></a><span class='hs-definition'>uUnfilledVar2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1346"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-1347"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SwapFlag</span>
<a name="line-1348"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- Tyvar 1</span>
<a name="line-1349"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span>      <span class='hs-comment'>-- Type 2, zonked</span>
<a name="line-1350"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>
<a name="line-1351"></a><span class='hs-definition'>uUnfilledVar2</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1352"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1353"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cur_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1354"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cur_lvl</span> <span class='hs-layout'>}</span>
<a name="line-1355"></a>  <span class='hs-keyword'>where</span>
<a name="line-1356"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cur_lvl</span>
<a name="line-1357"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>canSolveByUnification</span> <span class='hs-varid'>cur_lvl</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1358"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>metaTyVarUpdateOK</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1359"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>kind_origin</span> <span class='hs-conid'>KindLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-1360"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>updateMeta</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2'</span> <span class='hs-varid'>co_k</span>
<a name="line-1361"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_sym</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1362"></a>
<a name="line-1363"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1364"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unSwap</span> <span class='hs-varid'>swapped</span> <span class='hs-layout'>(</span><span class='hs-varid'>uType_defer</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1365"></a>               <span class='hs-comment'>-- Occurs check or an untouchable: just defer</span>
<a name="line-1366"></a>               <span class='hs-comment'>-- NB: occurs check isn't necessarily fatal:</span>
<a name="line-1367"></a>               <span class='hs-comment'>--     eg tv1 occured in type family parameter</span>
<a name="line-1368"></a>
<a name="line-1369"></a>    <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span>
<a name="line-1370"></a>    <span class='hs-varid'>kind_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>t_or_k</span><span class='hs-layout'>)</span>
<a name="line-1371"></a>
<a name="line-1372"></a><a name="maybe_sym"></a><span class='hs-comment'>-- | apply sym iff swapped</span>
<a name="line-1373"></a><span class='hs-definition'>maybe_sym</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SwapFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1374"></a><span class='hs-definition'>maybe_sym</span> <span class='hs-conid'>IsSwapped</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span>
<a name="line-1375"></a><span class='hs-definition'>maybe_sym</span> <span class='hs-conid'>NotSwapped</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-1376"></a>
<a name="line-1377"></a><a name="metaTyVarUpdateOK"></a><span class='hs-comment'>----------------</span>
<a name="line-1378"></a><span class='hs-definition'>metaTyVarUpdateOK</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-1379"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>             <span class='hs-comment'>-- tv :: k1</span>
<a name="line-1380"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>              <span class='hs-comment'>-- ty :: k2</span>
<a name="line-1381"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span>        <span class='hs-comment'>-- possibly-expanded ty</span>
<a name="line-1382"></a><span class='hs-comment'>-- (metaTyFVarUpdateOK tv ty)</span>
<a name="line-1383"></a><span class='hs-comment'>-- We are about to update the meta-tyvar tv with ty.</span>
<a name="line-1384"></a><span class='hs-comment'>-- Check (a) that tv doesn't occur in ty (occurs check)</span>
<a name="line-1385"></a><span class='hs-comment'>--       (b) that ty does not have any foralls</span>
<a name="line-1386"></a><span class='hs-comment'>--           (in the impredicative case), or type functions</span>
<a name="line-1387"></a><span class='hs-comment'>--</span>
<a name="line-1388"></a><span class='hs-comment'>-- We have two possible outcomes:</span>
<a name="line-1389"></a><span class='hs-comment'>-- (1) Return the type to update the type variable with,</span>
<a name="line-1390"></a><span class='hs-comment'>--        [we know the update is ok]</span>
<a name="line-1391"></a><span class='hs-comment'>-- (2) Return Nothing,</span>
<a name="line-1392"></a><span class='hs-comment'>--        [the update might be dodgy]</span>
<a name="line-1393"></a><span class='hs-comment'>--</span>
<a name="line-1394"></a><span class='hs-comment'>-- Note that "Nothing" does not mean "definite error".  For example</span>
<a name="line-1395"></a><span class='hs-comment'>--   type family F a</span>
<a name="line-1396"></a><span class='hs-comment'>--   type instance F Int = Int</span>
<a name="line-1397"></a><span class='hs-comment'>-- consider</span>
<a name="line-1398"></a><span class='hs-comment'>--   a ~ F a</span>
<a name="line-1399"></a><span class='hs-comment'>-- This is perfectly reasonable, if we later get a ~ Int.  For now, though,</span>
<a name="line-1400"></a><span class='hs-comment'>-- we return Nothing, leaving it to the later constraint simplifier to</span>
<a name="line-1401"></a><span class='hs-comment'>-- sort matters out.</span>
<a name="line-1402"></a>
<a name="line-1403"></a><span class='hs-definition'>metaTyVarUpdateOK</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1404"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>defer_me</span> <span class='hs-varid'>impredicative</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1405"></a>      <span class='hs-conid'>OC_OK</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span>
<a name="line-1406"></a>      <span class='hs-conid'>OC_Forall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>  <span class='hs-comment'>-- forall or type function</span>
<a name="line-1407"></a>      <span class='hs-conid'>OC_Occurs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occCheckExpand</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1408"></a>  <span class='hs-keyword'>where</span>
<a name="line-1409"></a>    <span class='hs-varid'>details</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span>
<a name="line-1410"></a>    <span class='hs-varid'>impredicative</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canUnifyWithPolyType</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>details</span>
<a name="line-1411"></a>
<a name="line-1412"></a>    <span class='hs-varid'>defer_me</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- True &lt;=&gt; foralls are ok</span>
<a name="line-1413"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-1414"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccCheckResult</span> <span class='hs-conid'>()</span>
<a name="line-1415"></a>    <span class='hs-comment'>-- Checks for (a) occurrence of tv</span>
<a name="line-1416"></a>    <span class='hs-comment'>--            (b) type family applications</span>
<a name="line-1417"></a>    <span class='hs-comment'>--            (c) foralls if the Bool is false</span>
<a name="line-1418"></a>    <span class='hs-comment'>-- See Note [Prevent unification with type families]</span>
<a name="line-1419"></a>    <span class='hs-comment'>-- See Note [Refactoring hazard: checkTauTvUpdate]</span>
<a name="line-1420"></a>    <span class='hs-comment'>-- See Note [Checking for foralls] in TcType</span>
<a name="line-1421"></a>
<a name="line-1422"></a>    <span class='hs-varid'>defer_me</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-1423"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_Occurs</span>
<a name="line-1424"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer_me</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-1425"></a>    <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1426"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_Forall</span>   <span class='hs-comment'>-- We use OC_Forall to signal</span>
<a name="line-1427"></a>                                            <span class='hs-comment'>-- forall /or/ type function</span>
<a name="line-1428"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTauTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_Forall</span>
<a name="line-1429"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-conid'>OC_OK</span> <span class='hs-conid'>()</span>
<a name="line-1430"></a>
<a name="line-1431"></a>    <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tv'</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-1432"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>b</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_Forall</span>
<a name="line-1433"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_OK</span> <span class='hs-conid'>()</span>
<a name="line-1434"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>defer_me</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-varid'>t</span> <span class='hs-layout'>}</span>
<a name="line-1435"></a>
<a name="line-1436"></a>    <span class='hs-varid'>defer_me</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_OK</span> <span class='hs-conid'>()</span>
<a name="line-1437"></a>    <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-varid'>arg</span>
<a name="line-1438"></a>    <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-varid'>arg</span>
<a name="line-1439"></a>    <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer_me</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span>  <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>defer_me_co</span> <span class='hs-varid'>co</span>
<a name="line-1440"></a>    <span class='hs-varid'>defer_me</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer_me_co</span> <span class='hs-varid'>co</span>
<a name="line-1441"></a>
<a name="line-1442"></a>      <span class='hs-comment'>-- We don't really care if there are type families in a coercion,</span>
<a name="line-1443"></a>      <span class='hs-comment'>-- but we still can't have an occurs-check failure</span>
<a name="line-1444"></a>    <span class='hs-varid'>defer_me_co</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_Occurs</span>
<a name="line-1445"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_OK</span> <span class='hs-conid'>()</span>
<a name="line-1446"></a>
<a name="line-1447"></a><a name="swapOverTyVars"></a><span class='hs-definition'>swapOverTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1448"></a><span class='hs-comment'>-- See Note [Canonical orientation for tyvar/tyvar equality constraints]</span>
<a name="line-1449"></a><span class='hs-definition'>swapOverTyVars</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span>
<a name="line-1450"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>lvl1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>metaTyVarTcLevel_maybe</span> <span class='hs-varid'>tv1</span>
<a name="line-1451"></a>      <span class='hs-comment'>-- If tv1 is touchable, swap only if tv2 is also</span>
<a name="line-1452"></a>      <span class='hs-comment'>-- touchable and it's strictly better to update the latter</span>
<a name="line-1453"></a>      <span class='hs-comment'>-- But see Note [Avoid unnecessary swaps]</span>
<a name="line-1454"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>metaTyVarTcLevel_maybe</span> <span class='hs-varid'>tv2</span> <span class='hs-keyword'>of</span>
<a name="line-1455"></a>      <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1456"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>lvl2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>lvl2</span> <span class='hs-varop'>`strictlyDeeperThan`</span> <span class='hs-varid'>lvl1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1457"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>lvl1</span> <span class='hs-varop'>`strictlyDeeperThan`</span> <span class='hs-varid'>lvl2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1458"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nicer_to_update</span> <span class='hs-varid'>tv2</span>
<a name="line-1459"></a>
<a name="line-1460"></a>  <span class='hs-comment'>-- So tv1 is not a meta tyvar</span>
<a name="line-1461"></a>  <span class='hs-comment'>-- If only one is a meta tyvar, put it on the left</span>
<a name="line-1462"></a>  <span class='hs-comment'>-- This is not because it'll be solved; but because</span>
<a name="line-1463"></a>  <span class='hs-comment'>-- the floating step looks for meta tyvars on the left</span>
<a name="line-1464"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1465"></a>
<a name="line-1466"></a>  <span class='hs-comment'>-- So neither is a meta tyvar (including FlatMetaTv)</span>
<a name="line-1467"></a>
<a name="line-1468"></a>  <span class='hs-comment'>-- If only one is a flatten skolem, put it on the left</span>
<a name="line-1469"></a>  <span class='hs-comment'>-- See Note [Eliminate flat-skols]</span>
<a name="line-1470"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFlattenTyVar</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFlattenTyVar</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1471"></a>
<a name="line-1472"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1473"></a>
<a name="line-1474"></a>  <span class='hs-keyword'>where</span>
<a name="line-1475"></a>    <span class='hs-varid'>nicer_to_update</span> <span class='hs-varid'>tv2</span>
<a name="line-1476"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-layout'>(</span><span class='hs-varid'>isSigTyVar</span> <span class='hs-varid'>tv1</span>                 <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSigTyVar</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1477"></a>      <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSystemName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSystemName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1478"></a>
<a name="line-1479"></a><a name="canSolveByUnification"></a><span class='hs-comment'>-- @trySpontaneousSolve wi@ solves equalities where one side is a</span>
<a name="line-1480"></a><span class='hs-comment'>-- touchable unification variable.</span>
<a name="line-1481"></a><span class='hs-comment'>-- Returns True &lt;=&gt; spontaneous solve happened</span>
<a name="line-1482"></a><span class='hs-definition'>canSolveByUnification</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1483"></a><span class='hs-definition'>canSolveByUnification</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>xi</span>
<a name="line-1484"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTouchableMetaTyVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span>
<a name="line-1485"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>metaTyVarInfo</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1486"></a>      <span class='hs-conid'>SigTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>is_tyvar</span> <span class='hs-varid'>xi</span>
<a name="line-1487"></a>      <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1488"></a>
<a name="line-1489"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-comment'>-- Untouchable</span>
<a name="line-1490"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1491"></a>  <span class='hs-keyword'>where</span>
<a name="line-1492"></a>    <span class='hs-varid'>is_tyvar</span> <span class='hs-varid'>xi</span>
<a name="line-1493"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>xi</span> <span class='hs-keyword'>of</span>
<a name="line-1494"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1495"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1496"></a>                       <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span>
<a name="line-1497"></a>                                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-1498"></a>                                        <span class='hs-conid'>SigTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1499"></a>                                        <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1500"></a>                       <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1501"></a>                       <span class='hs-conid'>FlatSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1502"></a>                       <span class='hs-conid'>RuntimeUnk</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1503"></a>
<a name="line-1504"></a><span class='hs-comment'>{-
<a name="line-1505"></a>Note [Prevent unification with type families]
<a name="line-1506"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1507"></a>We prevent unification with type families because of an uneasy compromise.
<a name="line-1508"></a>It's perfectly sound to unify with type families, and it even improves the
<a name="line-1509"></a>error messages in the testsuite. It also modestly improves performance, at
<a name="line-1510"></a>least in some cases. But it's disastrous for test case perf/compiler/T3064.
<a name="line-1511"></a>Here is the problem: Suppose we have (F ty) where we also have [G] F ty ~ a.
<a name="line-1512"></a>What do we do? Do we reduce F? Or do we use the given? Hard to know what's
<a name="line-1513"></a>best. GHC reduces. This is a disaster for T3064, where the type's size
<a name="line-1514"></a>spirals out of control during reduction. (We're not helped by the fact that
<a name="line-1515"></a>the flattener re-flattens all the arguments every time around.) If we prevent
<a name="line-1516"></a>unification with type families, then the solver happens to use the equality
<a name="line-1517"></a>before expanding the type family.
<a name="line-1518"></a>
<a name="line-1519"></a>It would be lovely in the future to revisit this problem and remove this
<a name="line-1520"></a>extra, unnecessary check. But we retain it for now as it seems to work
<a name="line-1521"></a>better in practice.
<a name="line-1522"></a>
<a name="line-1523"></a>Note [Refactoring hazard: checkTauTvUpdate]
<a name="line-1524"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1525"></a>I (Richard E.) have a sad story about refactoring this code, retained here
<a name="line-1526"></a>to prevent others (or a future me!) from falling into the same traps.
<a name="line-1527"></a>
<a name="line-1528"></a>It all started with #11407, which was caused by the fact that the TyVarTy
<a name="line-1529"></a>case of defer_me didn't look in the kind. But it seemed reasonable to
<a name="line-1530"></a>simply remove the defer_me check instead.
<a name="line-1531"></a>
<a name="line-1532"></a>It referred to two Notes (since removed) that were out of date, and the
<a name="line-1533"></a>fast_check code in occurCheckExpand seemed to do just about the same thing as
<a name="line-1534"></a>defer_me. The one piece that defer_me did that wasn't repeated by
<a name="line-1535"></a>occurCheckExpand was the type-family check. (See Note [Prevent unification
<a name="line-1536"></a>with type families].) So I checked the result of occurCheckExpand for any
<a name="line-1537"></a>type family occurrences and deferred if there were any. This was done
<a name="line-1538"></a>in commit e9bf7bb5cc9fb3f87dd05111aa23da76b86a8967 .
<a name="line-1539"></a>
<a name="line-1540"></a>This approach turned out not to be performant, because the expanded
<a name="line-1541"></a>type was bigger than the original type, and tyConsOfType (needed to
<a name="line-1542"></a>see if there are any type family occurrences) looks through type
<a name="line-1543"></a>synonyms. So it then struck me that we could dispense with the
<a name="line-1544"></a>defer_me check entirely. This simplified the code nicely, and it cut
<a name="line-1545"></a>the allocations in T5030 by half. But, as documented in Note [Prevent
<a name="line-1546"></a>unification with type families], this destroyed performance in
<a name="line-1547"></a>T3064. Regardless, I missed this regression and the change was
<a name="line-1548"></a>committed as 3f5d1a13f112f34d992f6b74656d64d95a3f506d .
<a name="line-1549"></a>
<a name="line-1550"></a>Bottom lines:
<a name="line-1551"></a> * defer_me is back, but now fixed w.r.t. #11407.
<a name="line-1552"></a> * Tread carefully before you start to refactor here. There can be
<a name="line-1553"></a>   lots of hard-to-predict consequences.
<a name="line-1554"></a>
<a name="line-1555"></a>Note [Type synonyms and the occur check]
<a name="line-1556"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1557"></a>Generally speaking we try to update a variable with type synonyms not
<a name="line-1558"></a>expanded, which improves later error messages, unless looking
<a name="line-1559"></a>inside a type synonym may help resolve a spurious occurs check
<a name="line-1560"></a>error. Consider:
<a name="line-1561"></a>          type A a = ()
<a name="line-1562"></a>
<a name="line-1563"></a>          f :: (A a -&gt; a -&gt; ()) -&gt; ()
<a name="line-1564"></a>          f = \ _ -&gt; ()
<a name="line-1565"></a>
<a name="line-1566"></a>          x :: ()
<a name="line-1567"></a>          x = f (\ x p -&gt; p x)
<a name="line-1568"></a>
<a name="line-1569"></a>We will eventually get a constraint of the form t ~ A t. The ok function above will
<a name="line-1570"></a>properly expand the type (A t) to just (), which is ok to be unified with t. If we had
<a name="line-1571"></a>unified with the original type A t, we would lead the type checker into an infinite loop.
<a name="line-1572"></a>
<a name="line-1573"></a>Hence, if the occurs check fails for a type synonym application, then (and *only* then),
<a name="line-1574"></a>the ok function expands the synonym to detect opportunities for occurs check success using
<a name="line-1575"></a>the underlying definition of the type synonym.
<a name="line-1576"></a>
<a name="line-1577"></a>The same applies later on in the constraint interaction code; see TcInteract,
<a name="line-1578"></a>function @occ_check_ok@.
<a name="line-1579"></a>
<a name="line-1580"></a>Note [Non-TcTyVars in TcUnify]
<a name="line-1581"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1582"></a>Because the same code is now shared between unifying types and unifying
<a name="line-1583"></a>kinds, we sometimes will see proper TyVars floating around the unifier.
<a name="line-1584"></a>Example (from test case polykinds/PolyKinds12):
<a name="line-1585"></a>
<a name="line-1586"></a>    type family Apply (f :: k1 -&gt; k2) (x :: k1) :: k2
<a name="line-1587"></a>    type instance Apply g y = g y
<a name="line-1588"></a>
<a name="line-1589"></a>When checking the instance declaration, we first *kind-check* the LHS
<a name="line-1590"></a>and RHS, discovering that the instance really should be
<a name="line-1591"></a>
<a name="line-1592"></a>    type instance Apply k3 k4 (g :: k3 -&gt; k4) (y :: k3) = g y
<a name="line-1593"></a>
<a name="line-1594"></a>During this kind-checking, all the tyvars will be TcTyVars. Then, however,
<a name="line-1595"></a>as a second pass, we desugar the RHS (which is done in functions prefixed
<a name="line-1596"></a>with "tc" in TcTyClsDecls"). By this time, all the kind-vars are proper
<a name="line-1597"></a>TyVars, not TcTyVars, get some kind unification must happen.
<a name="line-1598"></a>
<a name="line-1599"></a>Thus, we always check if a TyVar is a TcTyVar before asking if it's a
<a name="line-1600"></a>meta-tyvar.
<a name="line-1601"></a>
<a name="line-1602"></a>This used to not be necessary for type-checking (that is, before * :: *)
<a name="line-1603"></a>because expressions get desugared via an algorithm separate from
<a name="line-1604"></a>type-checking (with wrappers, etc.). Types get desugared very differently,
<a name="line-1605"></a>causing this wibble in behavior seen here.
<a name="line-1606"></a>-}</span>
<a name="line-1607"></a>
<a name="line-1608"></a><a name="LookupTyVarResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LookupTyVarResult</span>  <span class='hs-comment'>-- The result of a lookupTcTyVar call</span>
<a name="line-1609"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unfilled</span> <span class='hs-conid'>TcTyVarDetails</span>     <span class='hs-comment'>-- SkolemTv or virgin MetaTv</span>
<a name="line-1610"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Filled</span>   <span class='hs-conid'>TcType</span>
<a name="line-1611"></a>
<a name="line-1612"></a><a name="lookupTcTyVar"></a><span class='hs-definition'>lookupTcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>LookupTyVarResult</span>
<a name="line-1613"></a><span class='hs-definition'>lookupTcTyVar</span> <span class='hs-varid'>tyvar</span>
<a name="line-1614"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>details</span>
<a name="line-1615"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>meta_details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-1616"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>meta_details</span> <span class='hs-keyword'>of</span>
<a name="line-1617"></a>           <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Filled</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1618"></a>           <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_touchable</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isTouchableTcM</span> <span class='hs-varid'>tyvar</span>
<a name="line-1619"></a>                             <span class='hs-comment'>-- Note [Unifying untouchables]</span>
<a name="line-1620"></a>                       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>is_touchable</span> <span class='hs-keyword'>then</span>
<a name="line-1621"></a>                            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unfilled</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span>
<a name="line-1622"></a>                         <span class='hs-keyword'>else</span>
<a name="line-1623"></a>                            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unfilled</span> <span class='hs-varid'>vanillaSkolemTv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1624"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1625"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unfilled</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span>
<a name="line-1626"></a>  <span class='hs-keyword'>where</span>
<a name="line-1627"></a>    <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tyvar</span>
<a name="line-1628"></a>
<a name="line-1629"></a><a name="updateMeta"></a><span class='hs-comment'>-- | Fill in a meta-tyvar</span>
<a name="line-1630"></a><span class='hs-definition'>updateMeta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span>            <span class='hs-comment'>-- ^ tv to fill in, tv :: k1</span>
<a name="line-1631"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>             <span class='hs-comment'>-- ^ ty2 :: k2</span>
<a name="line-1632"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>           <span class='hs-comment'>-- ^ kind_co :: k2 ~N k1</span>
<a name="line-1633"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- ^ :: tv ~N ty2 (= ty2 |&gt; kind_co ~N ty2)</span>
<a name="line-1634"></a><span class='hs-definition'>updateMeta</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>kind_co</span>
<a name="line-1635"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty2'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>kind_co</span>
<a name="line-1636"></a>             <span class='hs-varid'>ty2_refl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty2</span>
<a name="line-1637"></a>             <span class='hs-varid'>co</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoherenceLeftCo</span> <span class='hs-varid'>ty2_refl</span> <span class='hs-varid'>kind_co</span>
<a name="line-1638"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2'</span>
<a name="line-1639"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-1640"></a>
<a name="line-1641"></a><span class='hs-comment'>{-
<a name="line-1642"></a>Note [Unifying untouchables]
<a name="line-1643"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1644"></a>We treat an untouchable type variable as if it was a skolem.  That
<a name="line-1645"></a>ensures it won't unify with anything.  It's a slight had, because
<a name="line-1646"></a>we return a made-up TcTyVarDetails, but I think it works smoothly.
<a name="line-1647"></a>-}</span>
<a name="line-1648"></a>
<a name="line-1649"></a><a name="matchExpectedFunKind"></a><span class='hs-comment'>-- | Breaks apart a function kind into its pieces.</span>
<a name="line-1650"></a><span class='hs-definition'>matchExpectedFunKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span>           <span class='hs-comment'>-- ^ # of args remaining, only for errors</span>
<a name="line-1651"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>          <span class='hs-comment'>-- ^ type, only for errors</span>
<a name="line-1652"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>          <span class='hs-comment'>-- ^ function kind</span>
<a name="line-1653"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-1654"></a>                                  <span class='hs-comment'>-- ^ co :: old_kind ~ arg -&gt; res</span>
<a name="line-1655"></a><span class='hs-definition'>matchExpectedFunKind</span> <span class='hs-varid'>num_args_remaining</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-1656"></a>  <span class='hs-keyword'>where</span>
<a name="line-1657"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>k'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>k'</span>
<a name="line-1658"></a>
<a name="line-1659"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kvar</span><span class='hs-layout'>)</span>
<a name="line-1660"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>kvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kvar</span>
<a name="line-1661"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>maybe_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>kvar</span>
<a name="line-1662"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_kind</span> <span class='hs-keyword'>of</span>
<a name="line-1663"></a>                <span class='hs-conid'>Indirect</span> <span class='hs-varid'>fun_kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun_kind</span>
<a name="line-1664"></a>                <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span>             <span class='hs-varid'>defer</span> <span class='hs-varid'>k</span> <span class='hs-layout'>}</span>
<a name="line-1665"></a>
<a name="line-1666"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1667"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1668"></a>
<a name="line-1669"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>other</span>
<a name="line-1670"></a>
<a name="line-1671"></a>    <span class='hs-varid'>defer</span> <span class='hs-varid'>k</span>
<a name="line-1672"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1673"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1674"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>arg_kind</span> <span class='hs-varid'>res_kind</span>
<a name="line-1675"></a>                 <span class='hs-varid'>thing</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTypeErrorThingArgs</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>num_args_remaining</span>
<a name="line-1676"></a>                 <span class='hs-varid'>origin</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span>
<a name="line-1677"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>new_fun</span>
<a name="line-1678"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span>
<a name="line-1679"></a>                                        <span class='hs-layout'>}</span>
<a name="line-1680"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-conid'>KindLevel</span> <span class='hs-varid'>k</span> <span class='hs-varid'>new_fun</span>
<a name="line-1681"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1682"></a>      <span class='hs-keyword'>where</span>
</pre></body>
</html>
