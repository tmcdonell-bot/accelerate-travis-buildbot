<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>simplCore/FloatOut.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-3"></a>
<a name="line-4"></a>\section[FloatOut]{Float bindings outwards (towards the top level)}
<a name="line-5"></a>
<a name="line-6"></a>``Long-distance'' floating of bindings towards the top level.
<a name="line-7"></a>-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-10"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>FloatOut</span> <span class='hs-layout'>(</span> <span class='hs-varid'>floatOutwards</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkCore</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreArity</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>etaExpand</span> <span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreMonad</span>        <span class='hs-layout'>(</span> <span class='hs-conid'>FloatOutSwitches</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>               <span class='hs-layout'>(</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-varid'>idArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBottomingId</span> <span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>              <span class='hs-layout'>(</span> <span class='hs-conid'>Var</span> <span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SetLevels</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IntMap</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>M</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-comment'>{-
<a name="line-35"></a>        -----------------
<a name="line-36"></a>        Overall game plan
<a name="line-37"></a>        -----------------
<a name="line-38"></a>
<a name="line-39"></a>The Big Main Idea is:
<a name="line-40"></a>
<a name="line-41"></a>        To float out sub-expressions that can thereby get outside
<a name="line-42"></a>        a non-one-shot value lambda, and hence may be shared.
<a name="line-43"></a>
<a name="line-44"></a>
<a name="line-45"></a>To achieve this we may need to do two thing:
<a name="line-46"></a>
<a name="line-47"></a>   a) Let-bind the sub-expression:
<a name="line-48"></a>
<a name="line-49"></a>        f (g x)  ==&gt;  let lvl = f (g x) in lvl
<a name="line-50"></a>
<a name="line-51"></a>      Now we can float the binding for 'lvl'.
<a name="line-52"></a>
<a name="line-53"></a>   b) More than that, we may need to abstract wrt a type variable
<a name="line-54"></a>
<a name="line-55"></a>        \x -&gt; ... /\a -&gt; let v = ...a... in ....
<a name="line-56"></a>
<a name="line-57"></a>      Here the binding for v mentions 'a' but not 'x'.  So we
<a name="line-58"></a>      abstract wrt 'a', to give this binding for 'v':
<a name="line-59"></a>
<a name="line-60"></a>            vp = /\a -&gt; ...a...
<a name="line-61"></a>            v  = vp a
<a name="line-62"></a>
<a name="line-63"></a>      Now the binding for vp can float out unimpeded.
<a name="line-64"></a>      I can't remember why this case seemed important enough to
<a name="line-65"></a>      deal with, but I certainly found cases where important floats
<a name="line-66"></a>      didn't happen if we did not abstract wrt tyvars.
<a name="line-67"></a>
<a name="line-68"></a>With this in mind we can also achieve another goal: lambda lifting.
<a name="line-69"></a>We can make an arbitrary (function) binding float to top level by
<a name="line-70"></a>abstracting wrt *all* local variables, not just type variables, leaving
<a name="line-71"></a>a binding that can be floated right to top level.  Whether or not this
<a name="line-72"></a>happens is controlled by a flag.
<a name="line-73"></a>
<a name="line-74"></a>
<a name="line-75"></a>Random comments
<a name="line-76"></a>~~~~~~~~~~~~~~~
<a name="line-77"></a>
<a name="line-78"></a>At the moment we never float a binding out to between two adjacent
<a name="line-79"></a>lambdas.  For example:
<a name="line-80"></a>
<a name="line-81"></a>@
<a name="line-82"></a>        \x y -&gt; let t = x+x in ...
<a name="line-83"></a>===&gt;
<a name="line-84"></a>        \x -&gt; let t = x+x in \y -&gt; ...
<a name="line-85"></a>@
<a name="line-86"></a>Reason: this is less efficient in the case where the original lambda
<a name="line-87"></a>is never partially applied.
<a name="line-88"></a>
<a name="line-89"></a>But there's a case I've seen where this might not be true.  Consider:
<a name="line-90"></a>@
<a name="line-91"></a>elEm2 x ys
<a name="line-92"></a>  = elem' x ys
<a name="line-93"></a>  where
<a name="line-94"></a>    elem' _ []  = False
<a name="line-95"></a>    elem' x (y:ys)      = x==y || elem' x ys
<a name="line-96"></a>@
<a name="line-97"></a>It turns out that this generates a subexpression of the form
<a name="line-98"></a>@
<a name="line-99"></a>        \deq x ys -&gt; let eq = eqFromEqDict deq in ...
<a name="line-100"></a>@
<a name="line-101"></a>vwhich might usefully be separated to
<a name="line-102"></a>@
<a name="line-103"></a>        \deq -&gt; let eq = eqFromEqDict deq in \xy -&gt; ...
<a name="line-104"></a>@
<a name="line-105"></a>Well, maybe.  We don't do this at the moment.
<a name="line-106"></a>
<a name="line-107"></a>
<a name="line-108"></a>************************************************************************
<a name="line-109"></a>*                                                                      *
<a name="line-110"></a>\subsection[floatOutwards]{@floatOutwards@: let-floating interface function}
<a name="line-111"></a>*                                                                      *
<a name="line-112"></a>************************************************************************
<a name="line-113"></a>-}</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="floatOutwards"></a><span class='hs-definition'>floatOutwards</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatOutSwitches</span>
<a name="line-116"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span>
<a name="line-117"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-118"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-119"></a>
<a name="line-120"></a><span class='hs-definition'>floatOutwards</span> <span class='hs-varid'>float_sws</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>us</span> <span class='hs-varid'>pgm</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-122"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>annotated_w_levels</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setLevels</span> <span class='hs-varid'>float_sws</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>us</span> <span class='hs-layout'>;</span>
<a name="line-123"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>fss</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_s'</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>floatTopBind</span> <span class='hs-varid'>annotated_w_levels</span><span class='hs-layout'>)</span>
<a name="line-124"></a>            <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-125"></a>
<a name="line-126"></a>        <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_verbose_core2core</span> <span class='hs-str'>"Levels added:"</span>
<a name="line-127"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>annotated_w_levels</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-128"></a>
<a name="line-129"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tlets</span><span class='hs-layout'>,</span> <span class='hs-varid'>ntlets</span><span class='hs-layout'>,</span> <span class='hs-varid'>lams</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get_stats</span> <span class='hs-layout'>(</span><span class='hs-varid'>sum_stats</span> <span class='hs-varid'>fss</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>;</span>
<a name="line-130"></a>
<a name="line-131"></a>        <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_simpl_stats</span> <span class='hs-str'>"FloatOut stats:"</span>
<a name="line-132"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>hcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>int</span> <span class='hs-varid'>tlets</span><span class='hs-layout'>,</span>  <span class='hs-varid'>text</span> <span class='hs-str'>" Lets floated to top level; "</span><span class='hs-layout'>,</span>
<a name="line-133"></a>                        <span class='hs-varid'>int</span> <span class='hs-varid'>ntlets</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>" Lets floated elsewhere; from "</span><span class='hs-layout'>,</span>
<a name="line-134"></a>                        <span class='hs-varid'>int</span> <span class='hs-varid'>lams</span><span class='hs-layout'>,</span>   <span class='hs-varid'>text</span> <span class='hs-str'>" Lambda groups"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-135"></a>
<a name="line-136"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionManyBags</span> <span class='hs-varid'>binds_s'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-137"></a>    <span class='hs-layout'>}</span>
<a name="line-138"></a>
<a name="line-139"></a><a name="floatTopBind"></a><span class='hs-definition'>floatTopBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LevelledBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-140"></a><span class='hs-definition'>floatTopBind</span> <span class='hs-varid'>bind</span>
<a name="line-141"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBind</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-142"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>float_bag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flattenTopFloats</span> <span class='hs-varid'>floats</span>
<a name="line-143"></a>    <span class='hs-keyword'>in</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bind'</span> <span class='hs-keyword'>of</span>
<a name="line-144"></a>      <span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>addTopFloatPairs</span> <span class='hs-varid'>float_bag</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-145"></a>      <span class='hs-conid'>NonRec</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>float_bag</span> <span class='hs-varop'>`snocBag`</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-146"></a>
<a name="line-147"></a><span class='hs-comment'>{-
<a name="line-148"></a>************************************************************************
<a name="line-149"></a>*                                                                      *
<a name="line-150"></a>\subsection[FloatOut-Bind]{Floating in a binding (the business end)}
<a name="line-151"></a>*                                                                      *
<a name="line-152"></a>************************************************************************
<a name="line-153"></a>-}</span>
<a name="line-154"></a>
<a name="line-155"></a><a name="floatBind"></a><span class='hs-definition'>floatBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LevelledBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-156"></a><span class='hs-definition'>floatBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-varid'>var</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-158"></a>
<a name="line-159"></a>        <span class='hs-comment'>-- A tiresome hack:</span>
<a name="line-160"></a>        <span class='hs-comment'>-- see Note [Bottoming floats: eta expansion] in SetLevels</span>
<a name="line-161"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>rhs''</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isBottomingId</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaExpand</span> <span class='hs-layout'>(</span><span class='hs-varid'>idArity</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs'</span>
<a name="line-162"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs'</span>
<a name="line-163"></a>
<a name="line-164"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>var</span> <span class='hs-varid'>rhs''</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-165"></a>
<a name="line-166"></a><span class='hs-definition'>floatBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-167"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>floatList</span> <span class='hs-varid'>do_pair</span> <span class='hs-varid'>pairs</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_pairs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-168"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varid'>new_pairs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-169"></a>  <span class='hs-keyword'>where</span>
<a name="line-170"></a>    <span class='hs-varid'>do_pair</span> <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-varid'>name</span> <span class='hs-varid'>spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-171"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopLvl</span> <span class='hs-varid'>dest_lvl</span>  <span class='hs-comment'>-- See Note [floatBind for top level]</span>
<a name="line-172"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-173"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>addTopFloatPairs</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenTopFloats</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-174"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-comment'>-- Note [Floating out of Rec rhss]</span>
<a name="line-175"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-176"></a>        <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>partitionByLevel</span> <span class='hs-varid'>dest_lvl</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhs_floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>heres</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-177"></a>        <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitRecFloats</span> <span class='hs-varid'>heres</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>case_heres</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-178"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>installUnderLambdas</span> <span class='hs-varid'>case_heres</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-179"></a>      <span class='hs-keyword'>where</span>
<a name="line-180"></a>        <span class='hs-varid'>dest_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatSpecLevel</span> <span class='hs-varid'>spec</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="splitRecFloats"></a><span class='hs-definition'>splitRecFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span><span class='hs-layout'>)</span>
<a name="line-183"></a><span class='hs-comment'>-- The "tail" begins with a case</span>
<a name="line-184"></a><span class='hs-comment'>-- See Note [Floating out of Rec rhss]</span>
<a name="line-185"></a><span class='hs-definition'>splitRecFloats</span> <span class='hs-varid'>fs</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-187"></a>  <span class='hs-keyword'>where</span>
<a name="line-188"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>prs</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>fs</span>
<a name="line-189"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>prs</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs'</span><span class='hs-layout'>)</span>   <span class='hs-conop'>:</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>prs'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>fs</span>
<a name="line-190"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>prs</span> <span class='hs-varid'>fs</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="installUnderLambdas"></a><span class='hs-definition'>installUnderLambdas</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-193"></a><span class='hs-comment'>-- Note [Floating out of Rec rhss]</span>
<a name="line-194"></a><span class='hs-definition'>installUnderLambdas</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>e</span>
<a name="line-195"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>floats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span>
<a name="line-196"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span>
<a name="line-197"></a>  <span class='hs-keyword'>where</span>
<a name="line-198"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-199"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>e</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>install</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>e</span>
<a name="line-200"></a>
<a name="line-201"></a><a name="floatList"></a><span class='hs-comment'>---------------</span>
<a name="line-202"></a><span class='hs-definition'>floatList</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-203"></a><span class='hs-definition'>floatList</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-204"></a><span class='hs-definition'>floatList</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span>            <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs_a</span><span class='hs-layout'>,</span>  <span class='hs-varid'>binds_a</span><span class='hs-layout'>,</span>  <span class='hs-varid'>b</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span>
<a name="line-205"></a>                     <span class='hs-keyword'>case</span> <span class='hs-varid'>floatList</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs_as</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_as</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-206"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>fs_a</span> <span class='hs-varop'>`add_stats`</span> <span class='hs-varid'>fs_as</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_a</span> <span class='hs-varop'>`plusFloats`</span>  <span class='hs-varid'>binds_as</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-207"></a>
<a name="line-208"></a><span class='hs-comment'>{-
<a name="line-209"></a>Note [Floating out of Rec rhss]
<a name="line-210"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-211"></a>Consider   Rec { f&lt;1,0&gt; = \xy. body }
<a name="line-212"></a>From the body we may get some floats. The ones with level &lt;1,0&gt; must
<a name="line-213"></a>stay here, since they may mention f.  Ideally we'd like to make them
<a name="line-214"></a>part of the Rec block pairs -- but we can't if there are any
<a name="line-215"></a>FloatCases involved.
<a name="line-216"></a>
<a name="line-217"></a>Nor is it a good idea to dump them in the rhs, but outside the lambda
<a name="line-218"></a>    f = case x of I# y -&gt; \xy. body
<a name="line-219"></a>because now f's arity might get worse, which is Not Good. (And if
<a name="line-220"></a>there's an SCC around the RHS it might not get better again.
<a name="line-221"></a>See Trac #5342.)
<a name="line-222"></a>
<a name="line-223"></a>So, gruesomely, we split the floats into
<a name="line-224"></a> * the outer FloatLets, which can join the Rec, and
<a name="line-225"></a> * an inner batch starting in a FloatCase, which are then
<a name="line-226"></a>   pushed *inside* the lambdas.
<a name="line-227"></a>This loses full-laziness the rare situation where there is a
<a name="line-228"></a>FloatCase and a Rec interacting.
<a name="line-229"></a>
<a name="line-230"></a>Note [floatBind for top level]
<a name="line-231"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-232"></a>We may have a *nested* binding whose destination level is (FloatMe tOP_LEVEL), thus
<a name="line-233"></a>         letrec { foo &lt;0,0&gt; = .... (let bar&lt;0,0&gt; = .. in ..) .... }
<a name="line-234"></a>The binding for bar will be in the "tops" part of the floating binds,
<a name="line-235"></a>and thus not partioned by floatBody.
<a name="line-236"></a>
<a name="line-237"></a>We could perhaps get rid of the 'tops' component of the floating binds,
<a name="line-238"></a>but this case works just as well.
<a name="line-239"></a>
<a name="line-240"></a>
<a name="line-241"></a>************************************************************************
<a name="line-242"></a>
<a name="line-243"></a>\subsection[FloatOut-Expr]{Floating in expressions}
<a name="line-244"></a>*                                                                      *
<a name="line-245"></a>************************************************************************
<a name="line-246"></a>-}</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="floatBody"></a><span class='hs-definition'>floatBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Level</span>
<a name="line-249"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LevelledExpr</span>
<a name="line-250"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-251"></a>
<a name="line-252"></a><span class='hs-definition'>floatBody</span> <span class='hs-varid'>lvl</span> <span class='hs-varid'>arg</span>       <span class='hs-comment'>-- Used rec rhss, and case-alternative rhss</span>
<a name="line-253"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-254"></a>    <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>partitionByLevel</span> <span class='hs-varid'>lvl</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>heres</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-255"></a>        <span class='hs-comment'>-- Dump bindings are bound here</span>
<a name="line-256"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>install</span> <span class='hs-varid'>heres</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-257"></a>
<a name="line-258"></a><span class='hs-comment'>-----------------</span>
<a name="line-259"></a>
<a name="line-260"></a><span class='hs-comment'>{- Note [Floating past breakpoints]
<a name="line-261"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-262"></a>
<a name="line-263"></a>Notes from Peter Wortmann (re: #10052)
<a name="line-264"></a>
<a name="line-265"></a>"This case clearly means we're trying to float past a breakpoint..."
<a name="line-266"></a>
<a name="line-267"></a>Further:
<a name="line-268"></a>
<a name="line-269"></a>"Breakpoints as they currently exist are the only Tikish that is not
<a name="line-270"></a>scoped, counting, and not splittable.
<a name="line-271"></a>
<a name="line-272"></a>This means that we can't:
<a name="line-273"></a>  - Simply float code out of it, because the payload must still be covered (scoped)
<a name="line-274"></a>  - Copy the tick, because it would change entry counts (here: duplicate breakpoints)"
<a name="line-275"></a>
<a name="line-276"></a>While this seems like an odd case, it can apparently occur in real
<a name="line-277"></a>life: through the combination of optimizations + GHCi usage. For an
<a name="line-278"></a>example, see #10052 as mentioned above. So not only does the
<a name="line-279"></a>interpreter not like some compiler-generated things (like unboxed
<a name="line-280"></a>tuples), the compiler doesn't like interpreter-introduced things!
<a name="line-281"></a>
<a name="line-282"></a>Also see Note [GHCi and -O] in GHC.hs.
<a name="line-283"></a>-}</span>
<a name="line-284"></a>
<a name="line-285"></a><a name="floatExpr"></a><span class='hs-definition'>floatExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LevelledExpr</span>
<a name="line-286"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-287"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-288"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-289"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-290"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-291"></a>
<a name="line-292"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>e</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-293"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span>  <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fse</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats_e</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-294"></a>    <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span>  <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats_a</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-295"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fse</span> <span class='hs-varop'>`add_stats`</span> <span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats_e</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>floats_a</span><span class='hs-layout'>,</span> <span class='hs-conid'>App</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-296"></a>
<a name="line-297"></a><span class='hs-definition'>floatExpr</span> <span class='hs-varid'>lam</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>lam_spec</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-298"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs_w_lvls</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>lam</span>
<a name="line-299"></a>        <span class='hs-varid'>bndrs</span>                <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TB</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bndrs_w_lvls</span><span class='hs-keyglyph'>]</span>
<a name="line-300"></a>        <span class='hs-varid'>bndr_lvl</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatSpecLevel</span> <span class='hs-varid'>lam_spec</span>
<a name="line-301"></a>        <span class='hs-comment'>-- All the binders have the same level</span>
<a name="line-302"></a>        <span class='hs-comment'>-- See SetLevels.lvlLamBndrs</span>
<a name="line-303"></a>    <span class='hs-keyword'>in</span>
<a name="line-304"></a>    <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBody</span> <span class='hs-varid'>bndr_lvl</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-305"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>add_to_stats</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-306"></a>
<a name="line-307"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-308"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tickish</span> <span class='hs-varop'>`tickishScopesLike`</span> <span class='hs-conid'>SoftScope</span> <span class='hs-comment'>-- not scoped, can just float</span>
<a name="line-309"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>    <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-310"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-311"></a>
<a name="line-312"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickishCounts</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tickishCanSplit</span> <span class='hs-varid'>tickish</span>
<a name="line-313"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>    <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-314"></a>    <span class='hs-keyword'>let</span> <span class='hs-comment'>-- Annotate bindings floated outwards past an scc expression</span>
<a name="line-315"></a>        <span class='hs-comment'>-- with the cc.  We mark that cc as "duplicated", though.</span>
<a name="line-316"></a>        <span class='hs-varid'>annotated_defns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTick</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNoCount</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span> <span class='hs-varid'>floating_defns</span>
<a name="line-317"></a>    <span class='hs-keyword'>in</span>
<a name="line-318"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>annotated_defns</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-319"></a>
<a name="line-320"></a>  <span class='hs-comment'>-- Note [Floating past breakpoints]</span>
<a name="line-321"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-322"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"floatExpr tick"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span>
<a name="line-323"></a>
<a name="line-324"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-325"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-326"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cast</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-327"></a>
<a name="line-328"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-329"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bind_spec</span> <span class='hs-keyword'>of</span>
<a name="line-330"></a>      <span class='hs-conid'>FloatMe</span> <span class='hs-varid'>dest_lvl</span>
<a name="line-331"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBind</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsb</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-332"></a>           <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fse</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-333"></a>           <span class='hs-layout'>(</span> <span class='hs-varid'>add_stats</span> <span class='hs-varid'>fsb</span> <span class='hs-varid'>fse</span>
<a name="line-334"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>bind_floats</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>unitLetFloat</span> <span class='hs-varid'>dest_lvl</span> <span class='hs-varid'>bind'</span>
<a name="line-335"></a>                         <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>body_floats</span>
<a name="line-336"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-337"></a>
<a name="line-338"></a>      <span class='hs-conid'>StayPut</span> <span class='hs-varid'>bind_lvl</span>  <span class='hs-comment'>-- See Note [Avoiding unnecessary floating]</span>
<a name="line-339"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBind</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>          <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsb</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-340"></a>           <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBody</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fse</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-341"></a>           <span class='hs-layout'>(</span> <span class='hs-varid'>add_stats</span> <span class='hs-varid'>fsb</span> <span class='hs-varid'>fse</span>
<a name="line-342"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>bind_floats</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>body_floats</span>
<a name="line-343"></a>           <span class='hs-layout'>,</span> <span class='hs-conid'>Let</span> <span class='hs-varid'>bind'</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-344"></a>  <span class='hs-keyword'>where</span>
<a name="line-345"></a>    <span class='hs-varid'>bind_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bind</span> <span class='hs-keyword'>of</span>
<a name="line-346"></a>                 <span class='hs-conid'>NonRec</span> <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span>
<a name="line-347"></a>                 <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span>
<a name="line-348"></a>                 <span class='hs-conid'>Rec</span> <span class='hs-conid'>[]</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"floatExpr:rec"</span>
<a name="line-349"></a>
<a name="line-350"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-varid'>case_bndr</span> <span class='hs-varid'>case_spec</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-351"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>case_spec</span> <span class='hs-keyword'>of</span>
<a name="line-352"></a>      <span class='hs-conid'>FloatMe</span> <span class='hs-varid'>dest_lvl</span>  <span class='hs-comment'>-- Case expression moves</span>
<a name="line-353"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>alts</span>
<a name="line-354"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>scrut</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fse</span><span class='hs-layout'>,</span> <span class='hs-varid'>fde</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-355"></a>           <span class='hs-keyword'>case</span> <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>rhs</span>   <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsb</span><span class='hs-layout'>,</span> <span class='hs-varid'>fdb</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-356"></a>           <span class='hs-keyword'>let</span>
<a name="line-357"></a>             <span class='hs-varid'>float</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitCaseFloat</span> <span class='hs-varid'>dest_lvl</span> <span class='hs-varid'>scrut'</span>
<a name="line-358"></a>                          <span class='hs-varid'>case_bndr</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TB</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bndrs</span><span class='hs-keyglyph'>]</span>
<a name="line-359"></a>           <span class='hs-keyword'>in</span>
<a name="line-360"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>add_stats</span> <span class='hs-varid'>fse</span> <span class='hs-varid'>fsb</span><span class='hs-layout'>,</span> <span class='hs-varid'>fde</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>float</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>fdb</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-361"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-362"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Floating multi-case"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-363"></a>
<a name="line-364"></a>      <span class='hs-conid'>StayPut</span> <span class='hs-varid'>bind_lvl</span>  <span class='hs-comment'>-- Case expression stays put</span>
<a name="line-365"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>scrut</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fse</span><span class='hs-layout'>,</span> <span class='hs-varid'>fde</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-366"></a>           <span class='hs-keyword'>case</span> <span class='hs-varid'>floatList</span> <span class='hs-layout'>(</span><span class='hs-varid'>float_alt</span> <span class='hs-varid'>bind_lvl</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>fda</span><span class='hs-layout'>,</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span>
<a name="line-367"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>add_stats</span> <span class='hs-varid'>fse</span> <span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>fda</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>fde</span><span class='hs-layout'>,</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>case_bndr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>)</span>
<a name="line-368"></a>           <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-369"></a>  <span class='hs-keyword'>where</span>
<a name="line-370"></a>    <span class='hs-varid'>float_alt</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-371"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBody</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-372"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TB</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-373"></a>
<a name="line-374"></a><span class='hs-comment'>{-
<a name="line-375"></a>Note [Avoiding unnecessary floating]
<a name="line-376"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-377"></a>In general we want to avoid floating a let unnecessarily, because
<a name="line-378"></a>it might worsen strictness:
<a name="line-379"></a>    let
<a name="line-380"></a>       x = ...(let y = e in y+y)....
<a name="line-381"></a>Here y is demanded.  If we float it outside the lazy 'x=..' then
<a name="line-382"></a>we'd have to zap its demand info, and it may never be restored.
<a name="line-383"></a>
<a name="line-384"></a>So at a 'let' we leave the binding right where the are unless
<a name="line-385"></a>the binding will escape a value lambda, e.g.
<a name="line-386"></a>
<a name="line-387"></a>(\x -&gt; let y = fac 100 in y)
<a name="line-388"></a>
<a name="line-389"></a>That's what the partitionByMajorLevel does in the floatExpr (Let ...)
<a name="line-390"></a>case.
<a name="line-391"></a>
<a name="line-392"></a>Notice, though, that we must take care to drop any bindings
<a name="line-393"></a>from the body of the let that depend on the staying-put bindings.
<a name="line-394"></a>
<a name="line-395"></a>We used instead to do the partitionByMajorLevel on the RHS of an '=',
<a name="line-396"></a>in floatRhs.  But that was quite tiresome.  We needed to test for
<a name="line-397"></a>values or trival rhss, because (in particular) we don't want to insert
<a name="line-398"></a>new bindings between the "=" and the "\".  E.g.
<a name="line-399"></a>        f = \x -&gt; let &lt;bind&gt; in &lt;body&gt;
<a name="line-400"></a>We do not want
<a name="line-401"></a>        f = let &lt;bind&gt; in \x -&gt; &lt;body&gt;
<a name="line-402"></a>(a) The simplifier will immediately float it further out, so we may
<a name="line-403"></a>        as well do so right now; in general, keeping rhss as manifest
<a name="line-404"></a>        values is good
<a name="line-405"></a>(b) If a float-in pass follows immediately, it might add yet more
<a name="line-406"></a>        bindings just after the '='.  And some of them might (correctly)
<a name="line-407"></a>        be strict even though the 'let f' is lazy, because f, being a value,
<a name="line-408"></a>        gets its demand-info zapped by the simplifier.
<a name="line-409"></a>And even all that turned out to be very fragile, and broke
<a name="line-410"></a>altogether when profiling got in the way.
<a name="line-411"></a>
<a name="line-412"></a>So now we do the partition right at the (Let..) itself.
<a name="line-413"></a>
<a name="line-414"></a>************************************************************************
<a name="line-415"></a>*                                                                      *
<a name="line-416"></a>\subsection{Utility bits for floating stats}
<a name="line-417"></a>*                                                                      *
<a name="line-418"></a>************************************************************************
<a name="line-419"></a>
<a name="line-420"></a>I didn't implement this with unboxed numbers.  I don't want to be too
<a name="line-421"></a>strict in this stuff, as it is rarely turned on.  (WDP 95/09)
<a name="line-422"></a>-}</span>
<a name="line-423"></a>
<a name="line-424"></a><a name="FloatStats"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FloatStats</span>
<a name="line-425"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FlS</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- Number of top-floats * lambda groups they've been past</span>
<a name="line-426"></a>        <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- Number of non-top-floats * lambda groups they've been past</span>
<a name="line-427"></a>        <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- Number of lambda (groups) seen</span>
<a name="line-428"></a>
<a name="line-429"></a><a name="get_stats"></a><span class='hs-definition'>get_stats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatStats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-430"></a><span class='hs-definition'>get_stats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlS</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-431"></a>
<a name="line-432"></a><a name="zeroStats"></a><span class='hs-definition'>zeroStats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatStats</span>
<a name="line-433"></a><span class='hs-definition'>zeroStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FlS</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span>
<a name="line-434"></a>
<a name="line-435"></a><a name="sum_stats"></a><span class='hs-definition'>sum_stats</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FloatStats</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatStats</span>
<a name="line-436"></a><span class='hs-definition'>sum_stats</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add_stats</span> <span class='hs-varid'>zeroStats</span> <span class='hs-varid'>xs</span>
<a name="line-437"></a>
<a name="line-438"></a><a name="add_stats"></a><span class='hs-definition'>add_stats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatStats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatStats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatStats</span>
<a name="line-439"></a><span class='hs-definition'>add_stats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlS</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlS</span> <span class='hs-varid'>a2</span> <span class='hs-varid'>b2</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-440"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FlS</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>c1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-441"></a>
<a name="line-442"></a><a name="add_to_stats"></a><span class='hs-definition'>add_to_stats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatStats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatStats</span>
<a name="line-443"></a><span class='hs-definition'>add_to_stats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlS</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span>
<a name="line-444"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FlS</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>+</span> <span class='hs-varid'>lengthBag</span> <span class='hs-varid'>tops</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-varop'>+</span> <span class='hs-varid'>lengthBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenMajor</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-445"></a>
<a name="line-446"></a><span class='hs-comment'>{-
<a name="line-447"></a>************************************************************************
<a name="line-448"></a>*                                                                      *
<a name="line-449"></a>\subsection{Utility bits for floating}
<a name="line-450"></a>*                                                                      *
<a name="line-451"></a>************************************************************************
<a name="line-452"></a>
<a name="line-453"></a>Note [Representation of FloatBinds]
<a name="line-454"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-455"></a>The FloatBinds types is somewhat important.  We can get very large numbers
<a name="line-456"></a>of floating bindings, often all destined for the top level.  A typical example
<a name="line-457"></a>is     x = [4,2,5,2,5, .... ]
<a name="line-458"></a>Then we get lots of small expressions like (fromInteger 4), which all get
<a name="line-459"></a>lifted to top level.
<a name="line-460"></a>
<a name="line-461"></a>The trouble is that
<a name="line-462"></a>  (a) we partition these floating bindings *at every binding site*
<a name="line-463"></a>  (b) SetLevels introduces a new bindings site for every float
<a name="line-464"></a>So we had better not look at each binding at each binding site!
<a name="line-465"></a>
<a name="line-466"></a>That is why MajorEnv is represented as a finite map.
<a name="line-467"></a>
<a name="line-468"></a>We keep the bindings destined for the *top* level separate, because
<a name="line-469"></a>we float them out even if they don't escape a *value* lambda; see
<a name="line-470"></a>partitionByMajorLevel.
<a name="line-471"></a>-}</span>
<a name="line-472"></a>
<a name="line-473"></a><a name="FloatLet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FloatLet</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreBind</span>        <span class='hs-comment'>-- INVARIANT: a FloatLet is always lifted</span>
<a name="line-474"></a><a name="MajorEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MajorEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>IntMap</span> <span class='hs-conid'>MinorEnv</span>         <span class='hs-comment'>-- Keyed by major level</span>
<a name="line-475"></a><a name="MinorEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MinorEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>IntMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Keyed by minor level</span>
<a name="line-476"></a>
<a name="line-477"></a><a name="FloatBinds"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FloatBinds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatLet</span><span class='hs-layout'>)</span>           <span class='hs-comment'>-- Destined for top level</span>
<a name="line-478"></a>                      <span class='hs-varop'>!</span><span class='hs-conid'>MajorEnv</span>                 <span class='hs-comment'>-- Levels other than top</span>
<a name="line-479"></a>     <span class='hs-comment'>-- See Note [Representation of FloatBinds]</span>
<a name="line-480"></a>
<a name="line-481"></a><a name="instance%20Outputable%20FloatBinds"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyword'>where</span>
<a name="line-482"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>fbs</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-483"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"FB"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>braces</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-484"></a>           <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tops ="</span>     <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fbs</span>
<a name="line-485"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"non-tops ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>defs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-486"></a>
<a name="line-487"></a><a name="flattenTopFloats"></a><span class='hs-definition'>flattenTopFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>CoreBind</span>
<a name="line-488"></a><span class='hs-definition'>flattenTopFloats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-489"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenMajor</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>defs</span> <span class='hs-layout'>)</span>
<a name="line-490"></a>    <span class='hs-varid'>tops</span>
<a name="line-491"></a>
<a name="line-492"></a><a name="addTopFloatPairs"></a><span class='hs-definition'>addTopFloatPairs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>CoreBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-493"></a><span class='hs-definition'>addTopFloatPairs</span> <span class='hs-varid'>float_bag</span> <span class='hs-varid'>prs</span>
<a name="line-494"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>add</span> <span class='hs-varid'>prs</span> <span class='hs-varid'>float_bag</span>
<a name="line-495"></a>  <span class='hs-keyword'>where</span>
<a name="line-496"></a>    <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>prs</span>
<a name="line-497"></a>    <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs1</span><span class='hs-layout'>)</span>   <span class='hs-varid'>prs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prs2</span>
<a name="line-498"></a>
<a name="line-499"></a><a name="flattenMajor"></a><span class='hs-definition'>flattenMajor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MajorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span>
<a name="line-500"></a><span class='hs-definition'>flattenMajor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>fold</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionBags</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flattenMinor</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span>
<a name="line-501"></a>
<a name="line-502"></a><a name="flattenMinor"></a><span class='hs-definition'>flattenMinor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MinorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span>
<a name="line-503"></a><span class='hs-definition'>flattenMinor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>fold</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>emptyBag</span>
<a name="line-504"></a>
<a name="line-505"></a><a name="emptyFloats"></a><span class='hs-definition'>emptyFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatBinds</span>
<a name="line-506"></a><span class='hs-definition'>emptyFloats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-varid'>emptyBag</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-507"></a>
<a name="line-508"></a><a name="unitCaseFloat"></a><span class='hs-definition'>unitCaseFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Level</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span>
<a name="line-509"></a><span class='hs-definition'>unitCaseFloat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Level</span> <span class='hs-varid'>major</span> <span class='hs-varid'>minor</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>con</span> <span class='hs-varid'>bs</span>
<a name="line-510"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>major</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>minor</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>con</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-511"></a>
<a name="line-512"></a><a name="unitLetFloat"></a><span class='hs-definition'>unitLetFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Level</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatLet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span>
<a name="line-513"></a><span class='hs-definition'>unitLetFloat</span> <span class='hs-varid'>lvl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Level</span> <span class='hs-varid'>major</span> <span class='hs-varid'>minor</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-514"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopLvl</span> <span class='hs-varid'>lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-515"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>major</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>minor</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-516"></a>  <span class='hs-keyword'>where</span>
<a name="line-517"></a>    <span class='hs-varid'>floats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-518"></a>
<a name="line-519"></a><a name="plusFloats"></a><span class='hs-definition'>plusFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span>
<a name="line-520"></a><span class='hs-definition'>plusFloats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>l1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>
<a name="line-521"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span> <span class='hs-varop'>`plusMajor`</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>
<a name="line-522"></a>
<a name="line-523"></a><a name="plusMajor"></a><span class='hs-definition'>plusMajor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MajorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MajorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MajorEnv</span>
<a name="line-524"></a><span class='hs-definition'>plusMajor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>unionWith</span> <span class='hs-varid'>plusMinor</span>
<a name="line-525"></a>
<a name="line-526"></a><a name="plusMinor"></a><span class='hs-definition'>plusMinor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MinorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MinorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MinorEnv</span>
<a name="line-527"></a><span class='hs-definition'>plusMinor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>unionWith</span> <span class='hs-varid'>unionBags</span>
<a name="line-528"></a>
<a name="line-529"></a><a name="install"></a><span class='hs-definition'>install</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-530"></a><span class='hs-definition'>install</span> <span class='hs-varid'>defn_groups</span> <span class='hs-varid'>expr</span>
<a name="line-531"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>wrapFloat</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>defn_groups</span>
<a name="line-532"></a>
<a name="line-533"></a><a name="partitionByLevel"></a><span class='hs-definition'>partitionByLevel</span>
<a name="line-534"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Level</span>                <span class='hs-comment'>-- Partitioning level</span>
<a name="line-535"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span>           <span class='hs-comment'>-- Defns to be divided into 2 piles...</span>
<a name="line-536"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Defns  with level strictly &lt; partition level,</span>
<a name="line-537"></a>            <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- The rest</span>
<a name="line-538"></a>
<a name="line-539"></a><span class='hs-comment'>{-
<a name="line-540"></a>--       ---- partitionByMajorLevel ----
<a name="line-541"></a>-- Float it if we escape a value lambda,
<a name="line-542"></a>--     *or* if we get to the top level
<a name="line-543"></a>--     *or* if it's a case-float and its minor level is &lt; current
<a name="line-544"></a>--
<a name="line-545"></a>-- If we can get to the top level, say "yes" anyway. This means that
<a name="line-546"></a>--      x = f e
<a name="line-547"></a>-- transforms to
<a name="line-548"></a>--    lvl = e
<a name="line-549"></a>--    x = f lvl
<a name="line-550"></a>-- which is as it should be
<a name="line-551"></a>
<a name="line-552"></a>partitionByMajorLevel (Level major _) (FB tops defns)
<a name="line-553"></a>  = (FB tops outer, heres `unionBags` flattenMajor inner)
<a name="line-554"></a>  where
<a name="line-555"></a>    (outer, mb_heres, inner) = M.splitLookup major defns
<a name="line-556"></a>    heres = case mb_heres of
<a name="line-557"></a>               Nothing -&gt; emptyBag
<a name="line-558"></a>               Just h  -&gt; flattenMinor h
<a name="line-559"></a>-}</span>
<a name="line-560"></a>
<a name="line-561"></a><span class='hs-definition'>partitionByLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Level</span> <span class='hs-varid'>major</span> <span class='hs-varid'>minor</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>defns</span><span class='hs-layout'>)</span>
<a name="line-562"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-layout'>(</span><span class='hs-varid'>outer_maj</span> <span class='hs-varop'>`plusMajor`</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>major</span> <span class='hs-varid'>outer_min</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-563"></a>     <span class='hs-varid'>here_min</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>flattenMinor</span> <span class='hs-varid'>inner_min</span>
<a name="line-564"></a>              <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>flattenMajor</span> <span class='hs-varid'>inner_maj</span><span class='hs-layout'>)</span>
<a name="line-565"></a>
<a name="line-566"></a>  <span class='hs-keyword'>where</span>
<a name="line-567"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>outer_maj</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_here_maj</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_maj</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>splitLookup</span> <span class='hs-varid'>major</span> <span class='hs-varid'>defns</span>
<a name="line-568"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>outer_min</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_here_min</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_min</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_here_maj</span> <span class='hs-keyword'>of</span>
<a name="line-569"></a>                                            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-570"></a>                                            <span class='hs-conid'>Just</span> <span class='hs-varid'>min_defns</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>splitLookup</span> <span class='hs-varid'>minor</span> <span class='hs-varid'>min_defns</span>
<a name="line-571"></a>    <span class='hs-varid'>here_min</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_here_min</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyBag</span>
<a name="line-572"></a>
<a name="line-573"></a><a name="wrapTick"></a><span class='hs-definition'>wrapTick</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tickish</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span>
<a name="line-574"></a><span class='hs-definition'>wrapTick</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>defns</span><span class='hs-layout'>)</span>
<a name="line-575"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapBag</span> <span class='hs-varid'>wrap_bind</span> <span class='hs-varid'>tops</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>wrap_defns</span><span class='hs-layout'>)</span> <span class='hs-varid'>defns</span><span class='hs-layout'>)</span>
<a name="line-576"></a>  <span class='hs-keyword'>where</span>
<a name="line-577"></a>    <span class='hs-varid'>wrap_defns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBag</span> <span class='hs-varid'>wrap_one</span>
<a name="line-578"></a>
<a name="line-579"></a>    <span class='hs-varid'>wrap_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>binder</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_tick</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-580"></a>    <span class='hs-varid'>wrap_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapSnd</span> <span class='hs-varid'>maybe_tick</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-581"></a>
<a name="line-582"></a>    <span class='hs-varid'>wrap_one</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_bind</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-583"></a>    <span class='hs-varid'>wrap_one</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatCase</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_tick</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-varid'>bs</span>
<a name="line-584"></a>
<a name="line-585"></a>    <span class='hs-varid'>maybe_tick</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tickHNFArgs</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span>
<a name="line-586"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span>
<a name="line-587"></a>      <span class='hs-comment'>-- we don't need to wrap a tick around an HNF when we float it</span>
<a name="line-588"></a>      <span class='hs-comment'>-- outside a tick: that is an invariant of the tick semantics</span>
<a name="line-589"></a>      <span class='hs-comment'>-- Conversely, inlining of HNFs inside an SCC is allowed, and</span>
<a name="line-590"></a>      <span class='hs-comment'>-- indeed the HNF we're floating here might well be inlined back</span>
<a name="line-591"></a>      <span class='hs-comment'>-- again, and we don't want to end up with duplicate ticks.</span>
</pre></body>
</html>
