<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/TyCoRep.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1998
<a name="line-4"></a>\section[TyCoRep]{Type and Coercion - friends' interface}
<a name="line-5"></a>
<a name="line-6"></a>Note [The Type-related module hierarchy]
<a name="line-7"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-8"></a>  Class
<a name="line-9"></a>  CoAxiom
<a name="line-10"></a>  TyCon    imports Class, CoAxiom
<a name="line-11"></a>  TyCoRep  imports Class, CoAxiom, TyCon
<a name="line-12"></a>  TysPrim  imports TyCoRep ( including mkTyConTy )
<a name="line-13"></a>  Kind     imports TysPrim ( mainly for primitive kinds )
<a name="line-14"></a>  Type     imports Kind
<a name="line-15"></a>  Coercion imports Type
<a name="line-16"></a>-}</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-comment'>-- We expose the relevant stuff from this module via the Type module</span>
<a name="line-19"></a><span class='hs-comment'>{-# OPTIONS_HADDOCK hide #-}</span>
<a name="line-20"></a><span class='hs-comment'>{-# LANGUAGE CPP, DeriveDataTypeable, DeriveFunctor, DeriveFoldable,
<a name="line-21"></a>             DeriveTraversable, MultiWayIf #-}</span>
<a name="line-22"></a><span class='hs-comment'>{-# LANGUAGE ImplicitParams #-}</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TyCoRep</span> <span class='hs-layout'>(</span>
<a name="line-25"></a>        <span class='hs-conid'>TyThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-conid'>Type</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-conid'>TyBinder</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-conid'>TyLit</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-conid'>KindOrType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-conid'>PredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Synonyms</span>
<a name="line-31"></a>        <span class='hs-conid'>VisibilityFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-comment'>-- Coercions</span>
<a name="line-34"></a>        <span class='hs-conid'>Coercion</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>LeftOrRight</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-conid'>UnivCoProvenance</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionHole</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionR</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionP</span><span class='hs-layout'>,</span> <span class='hs-conid'>KindCoercion</span><span class='hs-layout'>,</span>
<a name="line-37"></a>
<a name="line-38"></a>        <span class='hs-comment'>-- Functions over types</span>
<a name="line-39"></a>        <span class='hs-varid'>mkTyConTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTys</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>mkFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTys</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>isLiftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnliftedTypeKind</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>isCoercionType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRuntimeRepTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRuntimeRepVar</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>isRuntimeRepKindedTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>dropRuntimeRepArgs</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>sameVis</span><span class='hs-layout'>,</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-comment'>-- Functions over binders</span>
<a name="line-47"></a>        <span class='hs-varid'>binderType</span><span class='hs-layout'>,</span> <span class='hs-varid'>delBinderVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isInvisibleBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>isVisibleBinder</span><span class='hs-layout'>,</span>
<a name="line-48"></a>        <span class='hs-varid'>isNamedBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>isAnonBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>delBinderVarFV</span><span class='hs-layout'>,</span>
<a name="line-49"></a>
<a name="line-50"></a>        <span class='hs-comment'>-- Functions over coercions</span>
<a name="line-51"></a>        <span class='hs-varid'>pickLR</span><span class='hs-layout'>,</span>
<a name="line-52"></a>
<a name="line-53"></a>        <span class='hs-comment'>-- Pretty-printing</span>
<a name="line-54"></a>        <span class='hs-varid'>pprType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTypeApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTvBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTvBndrs</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>pprTyThing</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyThingCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprSigmaType</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-varid'>pprTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprForAll</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprForAllImplicit</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprUserForAll</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-varid'>pprThetaArrowTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprClassPred</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-varid'>pprKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyLit</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-conid'>TyPrec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeParen</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTcAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTcAppTy</span><span class='hs-layout'>,</span>
<a name="line-60"></a>        <span class='hs-varid'>pprPrefixApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprArrowChain</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_type</span><span class='hs-layout'>,</span>
<a name="line-61"></a>        <span class='hs-varid'>pprDataCons</span><span class='hs-layout'>,</span>
<a name="line-62"></a>
<a name="line-63"></a>        <span class='hs-comment'>-- * Free variables</span>
<a name="line-64"></a>        <span class='hs-varid'>tyCoVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeDSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesDSet</span><span class='hs-layout'>,</span>
<a name="line-65"></a>        <span class='hs-varid'>tyCoFVsBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeList</span><span class='hs-layout'>,</span>
<a name="line-66"></a>        <span class='hs-varid'>tyCoFVsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesList</span><span class='hs-layout'>,</span>
<a name="line-67"></a>        <span class='hs-varid'>closeOverKindsDSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>closeOverKindsFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>closeOverKindsList</span><span class='hs-layout'>,</span>
<a name="line-68"></a>        <span class='hs-varid'>coVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-69"></a>        <span class='hs-varid'>coVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfCos</span><span class='hs-layout'>,</span>
<a name="line-70"></a>        <span class='hs-varid'>tyCoVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCos</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-varid'>tyCoVarsOfCoDSet</span><span class='hs-layout'>,</span>
<a name="line-72"></a>        <span class='hs-varid'>tyCoFVsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsOfCos</span><span class='hs-layout'>,</span>
<a name="line-73"></a>        <span class='hs-varid'>tyCoVarsOfCoList</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfProv</span><span class='hs-layout'>,</span>
<a name="line-74"></a>        <span class='hs-varid'>closeOverKinds</span><span class='hs-layout'>,</span>
<a name="line-75"></a>        <span class='hs-varid'>tyCoVarsOfTelescope</span><span class='hs-layout'>,</span>
<a name="line-76"></a>
<a name="line-77"></a>        <span class='hs-comment'>-- * Substitutions</span>
<a name="line-78"></a>        <span class='hs-conid'>TCvSubst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-79"></a>        <span class='hs-varid'>emptyTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeTCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-80"></a>        <span class='hs-varid'>emptyTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEmptyTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-81"></a>        <span class='hs-varid'>mkTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTvSubst</span><span class='hs-layout'>,</span>
<a name="line-82"></a>        <span class='hs-varid'>getTvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-83"></a>        <span class='hs-varid'>getCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTCvInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTCvSubstRangeFVs</span><span class='hs-layout'>,</span>
<a name="line-84"></a>        <span class='hs-varid'>isInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>notElemTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-85"></a>        <span class='hs-varid'>setTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-86"></a>        <span class='hs-varid'>extendTCvInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTCvInScopeList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTCvInScopeSet</span><span class='hs-layout'>,</span>
<a name="line-87"></a>        <span class='hs-varid'>extendTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-88"></a>        <span class='hs-varid'>extendCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCvSubstWithClone</span><span class='hs-layout'>,</span>
<a name="line-89"></a>        <span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstWithClone</span><span class='hs-layout'>,</span>
<a name="line-90"></a>        <span class='hs-varid'>extendTvSubstList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstAndInScope</span><span class='hs-layout'>,</span>
<a name="line-91"></a>        <span class='hs-varid'>extendTvSubstBinder</span><span class='hs-layout'>,</span>
<a name="line-92"></a>        <span class='hs-varid'>unionTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipTyEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipCoEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyCoInScopeSet</span><span class='hs-layout'>,</span>
<a name="line-93"></a>        <span class='hs-varid'>zipTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipCvSubst</span><span class='hs-layout'>,</span>
<a name="line-94"></a>        <span class='hs-varid'>zipTyBinderSubst</span><span class='hs-layout'>,</span>
<a name="line-95"></a>        <span class='hs-varid'>mkTvSubstPrs</span><span class='hs-layout'>,</span>
<a name="line-96"></a>
<a name="line-97"></a>        <span class='hs-varid'>substTyWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyWithCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysWithCoVars</span><span class='hs-layout'>,</span>
<a name="line-98"></a>        <span class='hs-varid'>substCoWith</span><span class='hs-layout'>,</span>
<a name="line-99"></a>        <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyAddInScope</span><span class='hs-layout'>,</span>
<a name="line-100"></a>        <span class='hs-varid'>substTyUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substThetaUnchecked</span><span class='hs-layout'>,</span>
<a name="line-101"></a>        <span class='hs-varid'>substTyWithBindersUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyWithUnchecked</span><span class='hs-layout'>,</span>
<a name="line-102"></a>        <span class='hs-varid'>substCoUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoWithUnchecked</span><span class='hs-layout'>,</span>
<a name="line-103"></a>        <span class='hs-varid'>substTyWithBinders</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyWithInScope</span><span class='hs-layout'>,</span>
<a name="line-104"></a>        <span class='hs-varid'>substTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTheta</span><span class='hs-layout'>,</span>
<a name="line-105"></a>        <span class='hs-varid'>lookupTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span>
<a name="line-106"></a>        <span class='hs-varid'>substCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupCoVar</span><span class='hs-layout'>,</span>
<a name="line-107"></a>        <span class='hs-varid'>substCoVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneTyVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-108"></a>        <span class='hs-varid'>substTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVars</span><span class='hs-layout'>,</span>
<a name="line-109"></a>        <span class='hs-varid'>substForAllCoBndr</span><span class='hs-layout'>,</span>
<a name="line-110"></a>        <span class='hs-varid'>substTyVarBndrCallback</span><span class='hs-layout'>,</span> <span class='hs-varid'>substForAllCoBndrCallback</span><span class='hs-layout'>,</span>
<a name="line-111"></a>        <span class='hs-varid'>substCoVarBndrCallback</span><span class='hs-layout'>,</span>
<a name="line-112"></a>
<a name="line-113"></a>        <span class='hs-comment'>-- * Tidying type related things up for printing</span>
<a name="line-114"></a>        <span class='hs-varid'>tidyType</span><span class='hs-layout'>,</span>      <span class='hs-varid'>tidyTypes</span><span class='hs-layout'>,</span>
<a name="line-115"></a>        <span class='hs-varid'>tidyOpenType</span><span class='hs-layout'>,</span>  <span class='hs-varid'>tidyOpenTypes</span><span class='hs-layout'>,</span>
<a name="line-116"></a>        <span class='hs-varid'>tidyOpenKind</span><span class='hs-layout'>,</span>
<a name="line-117"></a>        <span class='hs-varid'>tidyTyCoVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTyCoVarBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyFreeTyCoVars</span><span class='hs-layout'>,</span>
<a name="line-118"></a>        <span class='hs-varid'>tidyOpenTyCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyOpenTyCoVars</span><span class='hs-layout'>,</span>
<a name="line-119"></a>        <span class='hs-varid'>tidyTyVarOcc</span><span class='hs-layout'>,</span>
<a name="line-120"></a>        <span class='hs-varid'>tidyTopType</span><span class='hs-layout'>,</span>
<a name="line-121"></a>        <span class='hs-varid'>tidyKind</span><span class='hs-layout'>,</span>
<a name="line-122"></a>        <span class='hs-varid'>tidyCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyCos</span><span class='hs-layout'>,</span>
<a name="line-123"></a>        <span class='hs-varid'>tidyTyBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTyBinders</span>
<a name="line-124"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-125"></a>
<a name="line-126"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-127"></a>
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>DataCon</span><span class='hs-layout'>(</span> <span class='hs-varid'>dataConTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConFullSig</span>
<a name="line-129"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>dataConUnivTyBinders</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConExTyBinders</span>
<a name="line-130"></a>                              <span class='hs-layout'>,</span> <span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterEqSpec</span> <span class='hs-layout'>)</span>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>Type</span><span class='hs-layout'>(</span> <span class='hs-varid'>isPredTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCoercionTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTy</span>
<a name="line-132"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesWellScoped</span>
<a name="line-133"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>partitionInvisibles</span><span class='hs-layout'>,</span> <span class='hs-varid'>coreView</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeKind</span>
<a name="line-134"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>eqType</span> <span class='hs-layout'>)</span>
<a name="line-135"></a>   <span class='hs-comment'>-- Transitively pulls in a LOT of stuff, better to break the loop</span>
<a name="line-136"></a>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>Coercion</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>ConLike</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ConLike</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TysWiredIn</span> <span class='hs-layout'>(</span> <span class='hs-varid'>ptrRepLiftedTy</span> <span class='hs-layout'>)</span>
<a name="line-140"></a>
<a name="line-141"></a><span class='hs-comment'>-- friends:</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>)</span>
<a name="line-146"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FV</span>
<a name="line-151"></a>
<a name="line-152"></a><span class='hs-comment'>-- others</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Binary</span>
<a name="line-155"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span> <span class='hs-layout'>(</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-layout'>)</span>
<a name="line-158"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-160"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-162"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-163"></a>
<a name="line-164"></a><span class='hs-comment'>-- libraries</span>
<a name="line-165"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span> <span class='hs-layout'>)</span>
<a name="line-166"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-167"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- for CoercionHole</span>
<a name="line-168"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-169"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Stack</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span>
<a name="line-170"></a><span class='hs-cpp'>#endif</span>
<a name="line-171"></a>
<a name="line-172"></a><span class='hs-comment'>{-
<a name="line-173"></a>%************************************************************************
<a name="line-174"></a>%*                                                                      *
<a name="line-175"></a>\subsection{The data type}
<a name="line-176"></a>%*                                                                      *
<a name="line-177"></a>%************************************************************************
<a name="line-178"></a>-}</span>
<a name="line-179"></a>
<a name="line-180"></a><span class='hs-comment'>-- | The key representation of types within the compiler</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="Type"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-183"></a><a name="Type"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span>
<a name="line-184"></a><a name="Type"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Type</span>
<a name="line-185"></a>  <span class='hs-comment'>-- See Note [Non-trivial definitional equality]</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-conid'>Var</span> <span class='hs-comment'>-- ^ Vanilla type or kind variable (*never* a coercion variable)</span>
<a name="line-187"></a>
<a name="line-188"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppTy</span>         <span class='hs-comment'>-- See Note [AppTy rep]</span>
<a name="line-189"></a>        <span class='hs-conid'>Type</span>
<a name="line-190"></a>        <span class='hs-conid'>Type</span>            <span class='hs-comment'>-- ^ Type application to something other than a 'TyCon'. Parameters:</span>
<a name="line-191"></a>                        <span class='hs-comment'>--</span>
<a name="line-192"></a>                        <span class='hs-comment'>--  1) Function: must /not/ be a 'TyConApp',</span>
<a name="line-193"></a>                        <span class='hs-comment'>--     must be another 'AppTy', or 'TyVarTy'</span>
<a name="line-194"></a>                        <span class='hs-comment'>--</span>
<a name="line-195"></a>                        <span class='hs-comment'>--  2) Argument type</span>
<a name="line-196"></a>
<a name="line-197"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConApp</span>      <span class='hs-comment'>-- See Note [AppTy rep]</span>
<a name="line-198"></a>        <span class='hs-conid'>TyCon</span>
<a name="line-199"></a>        <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindOrType</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ Application of a 'TyCon', including newtypes /and/ synonyms.</span>
<a name="line-200"></a>                        <span class='hs-comment'>-- Invariant: saturated applications of 'FunTyCon' must</span>
<a name="line-201"></a>                        <span class='hs-comment'>-- use 'FunTy' and saturated synonyms must use their own</span>
<a name="line-202"></a>                        <span class='hs-comment'>-- constructors. However, /unsaturated/ 'FunTyCon's</span>
<a name="line-203"></a>                        <span class='hs-comment'>-- do appear as 'TyConApp's.</span>
<a name="line-204"></a>                        <span class='hs-comment'>-- Parameters:</span>
<a name="line-205"></a>                        <span class='hs-comment'>--</span>
<a name="line-206"></a>                        <span class='hs-comment'>-- 1) Type constructor being applied to.</span>
<a name="line-207"></a>                        <span class='hs-comment'>--</span>
<a name="line-208"></a>                        <span class='hs-comment'>-- 2) Type arguments. Might not have enough type arguments</span>
<a name="line-209"></a>                        <span class='hs-comment'>--    here to saturate the constructor.</span>
<a name="line-210"></a>                        <span class='hs-comment'>--    Even type synonyms are not necessarily saturated;</span>
<a name="line-211"></a>                        <span class='hs-comment'>--    for example unsaturated type synonyms</span>
<a name="line-212"></a>                        <span class='hs-comment'>--    can appear as the right hand side of a type synonym.</span>
<a name="line-213"></a>
<a name="line-214"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span>
<a name="line-215"></a>        <span class='hs-conid'>TyBinder</span>
<a name="line-216"></a>        <span class='hs-conid'>Type</span>            <span class='hs-comment'>-- ^ A Π type.</span>
<a name="line-217"></a>                        <span class='hs-comment'>-- This includes arrow types, constructed with</span>
<a name="line-218"></a>                        <span class='hs-comment'>-- @ForAllTy (Anon ...)@. See also Note [TyBinder].</span>
<a name="line-219"></a>
<a name="line-220"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LitTy</span> <span class='hs-conid'>TyLit</span>     <span class='hs-comment'>-- ^ Type literals are similar to type constructors.</span>
<a name="line-221"></a>
<a name="line-222"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CastTy</span>
<a name="line-223"></a>        <span class='hs-conid'>Type</span>
<a name="line-224"></a>        <span class='hs-conid'>KindCoercion</span>  <span class='hs-comment'>-- ^ A kind cast. The coercion is always nominal.</span>
<a name="line-225"></a>                      <span class='hs-comment'>-- INVARIANT: The cast is never refl.</span>
<a name="line-226"></a>                      <span class='hs-comment'>-- INVARIANT: The cast is "pushed down" as far as it</span>
<a name="line-227"></a>                      <span class='hs-comment'>-- can go. See Note [Pushing down casts]</span>
<a name="line-228"></a>
<a name="line-229"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoercionTy</span>
<a name="line-230"></a>        <span class='hs-conid'>Coercion</span>    <span class='hs-comment'>-- ^ Injection of a Coercion into a type</span>
<a name="line-231"></a>                    <span class='hs-comment'>-- This should only ever be used in the RHS of an AppTy,</span>
<a name="line-232"></a>                    <span class='hs-comment'>-- in the list of a TyConApp, when applying a promoted</span>
<a name="line-233"></a>                    <span class='hs-comment'>-- GADT data constructor</span>
<a name="line-234"></a>
<a name="line-235"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-236"></a>
<a name="line-237"></a>
<a name="line-238"></a><a name="TyLit"></a><span class='hs-comment'>-- NOTE:  Other parts of the code assume that type literals do not contain</span>
<a name="line-239"></a><a name="TyLit"></a><span class='hs-comment'>-- types or type variables.</span>
<a name="line-240"></a><a name="TyLit"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyLit</span>
<a name="line-241"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NumTyLit</span> <span class='hs-conid'>Integer</span>
<a name="line-242"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StrTyLit</span> <span class='hs-conid'>FastString</span>
<a name="line-243"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-244"></a>
<a name="line-245"></a><a name="TyBinder"></a><span class='hs-comment'>-- | A 'TyBinder' represents an argument to a function. TyBinders can be dependent</span>
<a name="line-246"></a><a name="TyBinder"></a><span class='hs-comment'>-- ('Named') or nondependent ('Anon'). They may also be visible or not.</span>
<a name="line-247"></a><a name="TyBinder"></a><span class='hs-comment'>-- See also Note [TyBinder]</span>
<a name="line-248"></a><a name="TyBinder"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyBinder</span>
<a name="line-249"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Named</span> <span class='hs-conid'>TyVar</span> <span class='hs-conid'>VisibilityFlag</span>  <span class='hs-comment'>-- Always a TyVar (not CoVar or Id)</span>
<a name="line-250"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Anon</span> <span class='hs-conid'>Type</span>   <span class='hs-comment'>-- Visibility is determined by the type (Constraint vs. *)</span>
<a name="line-251"></a>    <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>)</span>
<a name="line-252"></a>
<a name="line-253"></a><a name="VisibilityFlag"></a><span class='hs-comment'>-- | Is something required to appear in source Haskell ('Visible'),</span>
<a name="line-254"></a><a name="VisibilityFlag"></a><span class='hs-comment'>-- permitted by request ('Specified') (visible type application), or</span>
<a name="line-255"></a><a name="VisibilityFlag"></a><span class='hs-comment'>-- prohibited entirely from appearing in source Haskell ('Invisible')?</span>
<a name="line-256"></a><a name="VisibilityFlag"></a><span class='hs-comment'>-- Examples in Note [VisibilityFlag]</span>
<a name="line-257"></a><a name="VisibilityFlag"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>VisibilityFlag</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Visible</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Specified</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Invisible</span>
<a name="line-258"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>)</span>
<a name="line-259"></a>
<a name="line-260"></a><a name="sameVis"></a><span class='hs-comment'>-- | Do these denote the same level of visibility? Except that</span>
<a name="line-261"></a><span class='hs-comment'>-- 'Specified' and 'Invisible' are considered the same. Used</span>
<a name="line-262"></a><span class='hs-comment'>-- for printing.</span>
<a name="line-263"></a><span class='hs-definition'>sameVis</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VisibilityFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VisibilityFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-264"></a><span class='hs-definition'>sameVis</span> <span class='hs-conid'>Visible</span> <span class='hs-conid'>Visible</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-265"></a><span class='hs-definition'>sameVis</span> <span class='hs-conid'>Visible</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-266"></a><span class='hs-definition'>sameVis</span> <span class='hs-keyword'>_</span>       <span class='hs-conid'>Visible</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-267"></a><span class='hs-definition'>sameVis</span> <span class='hs-keyword'>_</span>       <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-268"></a>
<a name="line-269"></a><a name="instance%20Binary%20VisibilityFlag"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>VisibilityFlag</span> <span class='hs-keyword'>where</span>
<a name="line-270"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Visible</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-271"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Specified</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-272"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Invisible</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-273"></a>
<a name="line-274"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-275"></a>    <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-276"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-277"></a>      <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Visible</span>
<a name="line-278"></a>      <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Specified</span>
<a name="line-279"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Invisible</span>
<a name="line-280"></a>
<a name="line-281"></a><a name="KindOrType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>KindOrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span> <span class='hs-comment'>-- See Note [Arguments to type constructors]</span>
<a name="line-282"></a>
<a name="line-283"></a><a name="Kind"></a><span class='hs-comment'>-- | The key type representing kinds in the compiler.</span>
<a name="line-284"></a><a name="Kind"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>
<a name="line-285"></a>
<a name="line-286"></a><span class='hs-comment'>{-
<a name="line-287"></a>Note [TyBinder]
<a name="line-288"></a>~~~~~~~~~~~~~~~
<a name="line-289"></a>This represents the type of binders -- that is, the type of an argument
<a name="line-290"></a>to a Pi-type. GHC Core currently supports two different Pi-types:
<a name="line-291"></a>a non-dependent function, written with -&gt;, and a dependent compile-time-only
<a name="line-292"></a>polytype, written with forall. Both Pi-types classify terms/types that
<a name="line-293"></a>take an argument. In other words, if `x` is either a function or a polytype,
<a name="line-294"></a>`x arg` makes sense (for an appropriate `arg`). It is thus often convenient
<a name="line-295"></a>to group Pi-types together. This is ForAllTy.
<a name="line-296"></a>
<a name="line-297"></a>The two constructors for TyBinder sort out the two different possibilities.
<a name="line-298"></a>`Named` builds a polytype, while `Anon` builds an ordinary function.
<a name="line-299"></a>(ForAllTy (Anon arg) res used to be called FunTy arg res.)
<a name="line-300"></a>
<a name="line-301"></a>Note [The kind invariant]
<a name="line-302"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-303"></a>The kinds
<a name="line-304"></a>   #          UnliftedTypeKind
<a name="line-305"></a>   OpenKind   super-kind of *, #
<a name="line-306"></a>
<a name="line-307"></a>can never appear under an arrow or type constructor in a kind; they
<a name="line-308"></a>can only be at the top level of a kind.  It follows that primitive TyCons,
<a name="line-309"></a>which have a naughty pseudo-kind
<a name="line-310"></a>   State# :: * -&gt; #
<a name="line-311"></a>must always be saturated, so that we can never get a type whose kind
<a name="line-312"></a>has a UnliftedTypeKind or ArgTypeKind underneath an arrow.
<a name="line-313"></a>
<a name="line-314"></a>Nor can we abstract over a type variable with any of these kinds.
<a name="line-315"></a>
<a name="line-316"></a>    k :: = kk | # | ArgKind | (#) | OpenKind
<a name="line-317"></a>    kk :: = * | kk -&gt; kk | T kk1 ... kkn
<a name="line-318"></a>
<a name="line-319"></a>So a type variable can only be abstracted kk.
<a name="line-320"></a>
<a name="line-321"></a>Note [AppTy rep]
<a name="line-322"></a>~~~~~~~~~~~~~~~~
<a name="line-323"></a>Types of the form 'f a' must be of kind *, not #, so we are guaranteed
<a name="line-324"></a>that they are represented by pointers.  The reason is that f must have
<a name="line-325"></a>kind (kk -&gt; kk) and kk cannot be unlifted; see Note [The kind invariant]
<a name="line-326"></a>in TyCoRep.
<a name="line-327"></a>
<a name="line-328"></a>Note [Arguments to type constructors]
<a name="line-329"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-330"></a>Because of kind polymorphism, in addition to type application we now
<a name="line-331"></a>have kind instantiation. We reuse the same notations to do so.
<a name="line-332"></a>
<a name="line-333"></a>For example:
<a name="line-334"></a>
<a name="line-335"></a>  Just (* -&gt; *) Maybe
<a name="line-336"></a>  Right * Nat Zero
<a name="line-337"></a>
<a name="line-338"></a>are represented by:
<a name="line-339"></a>
<a name="line-340"></a>  TyConApp (PromotedDataCon Just) [* -&gt; *, Maybe]
<a name="line-341"></a>  TyConApp (PromotedDataCon Right) [*, Nat, (PromotedDataCon Zero)]
<a name="line-342"></a>
<a name="line-343"></a>Important note: Nat is used as a *kind* and not as a type. This can be
<a name="line-344"></a>confusing, since type-level Nat and kind-level Nat are identical. We
<a name="line-345"></a>use the kind of (PromotedDataCon Right) to know if its arguments are
<a name="line-346"></a>kinds or types.
<a name="line-347"></a>
<a name="line-348"></a>This kind instantiation only happens in TyConApp currently.
<a name="line-349"></a>
<a name="line-350"></a>Note [Pushing down casts]
<a name="line-351"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-352"></a>Suppose we have (a :: k1 -&gt; *), (b :: k1), and (co :: * ~ q).
<a name="line-353"></a>The type (a b |&gt; co) is `eqType` to ((a |&gt; co') b), where
<a name="line-354"></a>co' = (-&gt;) &lt;k1&gt; co. Thus, to make this visible to functions
<a name="line-355"></a>that inspect types, we always push down coercions, preferring
<a name="line-356"></a>the second form. Note that this also applies to TyConApps!
<a name="line-357"></a>
<a name="line-358"></a>Note [Non-trivial definitional equality]
<a name="line-359"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-360"></a>Is Int |&gt; &lt;*&gt; the same as Int? YES! In order to reduce headaches,
<a name="line-361"></a>we decide that any reflexive casts in types are just ignored. More
<a name="line-362"></a>generally, the `eqType` function, which defines Core's type equality
<a name="line-363"></a>relation, ignores casts and coercion arguments, as long as the
<a name="line-364"></a>two types have the same kind. This allows us to be a little sloppier
<a name="line-365"></a>in keeping track of coercions, which is a good thing. It also means
<a name="line-366"></a>that eqType does not depend on eqCoercion, which is also a good thing.
<a name="line-367"></a>
<a name="line-368"></a>Why is this sensible? That is, why is something different than α-equivalence
<a name="line-369"></a>appropriate for the implementation of eqType?
<a name="line-370"></a>
<a name="line-371"></a>Anything smaller than ~ and homogeneous is an appropriate definition for
<a name="line-372"></a>equality. The type safety of FC depends only on ~. Let's say η : τ ~ σ. Any
<a name="line-373"></a>expression of type τ can be transmuted to one of type σ at any point by
<a name="line-374"></a>casting. The same is true of types of type τ. So in some sense, τ and σ are
<a name="line-375"></a>interchangeable.
<a name="line-376"></a>
<a name="line-377"></a>But let's be more precise. If we examine the typing rules of FC (say, those in
<a name="line-378"></a><a href="http://www.cis.upenn.edu/~eir/papers/2015/equalities/equalities-extended.pdf)">http://www.cis.upenn.edu/~eir/papers/2015/equalities/equalities-extended.pdf)</a>
<a name="line-379"></a>there are several places where the same metavariable is used in two different
<a name="line-380"></a>premises to a rule. (For example, see Ty_App.) There is an implicit equality
<a name="line-381"></a>check here. What definition of equality should we use? By convention, we use
<a name="line-382"></a>α-equivalence. Take any rule with one (or more) of these implicit equality
<a name="line-383"></a>checks. Then there is an admissible rule that uses ~ instead of the implicit
<a name="line-384"></a>check, adding in casts as appropriate.
<a name="line-385"></a>
<a name="line-386"></a>The only problem here is that ~ is heterogeneous. To make the kinds work out
<a name="line-387"></a>in the admissible rule that uses ~, it is necessary to homogenize the
<a name="line-388"></a>coercions. That is, if we have η : (τ : κ1) ~ (σ : κ2), then we don't use η;
<a name="line-389"></a>we use η |&gt; kind η, which is homogeneous.
<a name="line-390"></a>
<a name="line-391"></a>The effect of this all is that eqType, the implementation of the implicit
<a name="line-392"></a>equality check, can use any homogeneous relation that is smaller than ~, as
<a name="line-393"></a>those rules must also be admissible.
<a name="line-394"></a>
<a name="line-395"></a>What would go wrong if we insisted on the casts matching? See the beginning of
<a name="line-396"></a>Section 8 in the unpublished paper above. Theoretically, nothing at all goes
<a name="line-397"></a>wrong. But in practical terms, getting the coercions right proved to be
<a name="line-398"></a>nightmarish. And types would explode: during kind-checking, we often produce
<a name="line-399"></a>reflexive kind coercions. When we try to cast by these, mkCastTy just discards
<a name="line-400"></a>them. But if we used an eqType that distinguished between Int and Int |&gt; &lt;*&gt;,
<a name="line-401"></a>then we couldn't discard -- the output of kind-checking would be enormous,
<a name="line-402"></a>and we would need enormous casts with lots of CoherenceCo's to straighten
<a name="line-403"></a>them out.
<a name="line-404"></a>
<a name="line-405"></a>Would anything go wrong if eqType respected type families? No, not at all. But
<a name="line-406"></a>that makes eqType rather hard to implement.
<a name="line-407"></a>
<a name="line-408"></a>Thus, the guideline for eqType is that it should be the largest
<a name="line-409"></a>easy-to-implement relation that is still smaller than ~ and homogeneous. The
<a name="line-410"></a>precise choice of relation is somewhat incidental, as long as the smart
<a name="line-411"></a>constructors and destructors in Type respect whatever relation is chosen.
<a name="line-412"></a>
<a name="line-413"></a>Another helpful principle with eqType is this:
<a name="line-414"></a>
<a name="line-415"></a> ** If (t1 eqType t2) then I can replace t1 by t2 anywhere. **
<a name="line-416"></a>
<a name="line-417"></a>This principle also tells us that eqType must relate only types with the
<a name="line-418"></a>same kinds.
<a name="line-419"></a>
<a name="line-420"></a>Note [VisibilityFlag]
<a name="line-421"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-422"></a>All named binders are equipped with a visibility flag, which says
<a name="line-423"></a>whether or not arguments for this binder should be visible (explicit)
<a name="line-424"></a>in source Haskell. Historically, all named binders (that is, polytype
<a name="line-425"></a>binders) have been Invisible. But now it's more complicated.
<a name="line-426"></a>
<a name="line-427"></a>Invisible:
<a name="line-428"></a> Argument does not ever appear in source Haskell. With visible type
<a name="line-429"></a> application, only GHC-generated polytypes have Invisible binders.
<a name="line-430"></a> This exactly corresponds to "generalized" variables from the
<a name="line-431"></a> Visible Type Applications paper (ESOP'16).
<a name="line-432"></a>
<a name="line-433"></a> Example: f x = x
<a name="line-434"></a> `f` will be inferred to have type `forall a. a -&gt; a`, where `a` is
<a name="line-435"></a> Invisible. Note that there is no type annotation for `f`.
<a name="line-436"></a>
<a name="line-437"></a> Printing: With -fprint-explicit-foralls, Invisible binders are written
<a name="line-438"></a> in braces. Otherwise, they are printed like Specified binders.
<a name="line-439"></a>
<a name="line-440"></a>Specified:
<a name="line-441"></a> The argument for this binder may appear in source Haskell only with
<a name="line-442"></a> visible type application. Otherwise, it is omitted.
<a name="line-443"></a>
<a name="line-444"></a> Example: id :: forall a. a -&gt; a
<a name="line-445"></a> `a` is a Specified binder, because you can say `id @Int` in source Haskell.
<a name="line-446"></a>
<a name="line-447"></a> Example: const :: a -&gt; b -&gt; a
<a name="line-448"></a> Both `a` and `b` are Specified binders, even though they are not bound
<a name="line-449"></a> by an explicit forall.
<a name="line-450"></a>
<a name="line-451"></a> Printing: a list of Specified binders are put between `forall` and `.`:
<a name="line-452"></a> const :: forall a b. a -&gt; b -&gt; a
<a name="line-453"></a>
<a name="line-454"></a>Visible:
<a name="line-455"></a> The argument must be given. Visible binders come up only with TypeInType.
<a name="line-456"></a>
<a name="line-457"></a> Example: data Proxy k (a :: k) = P
<a name="line-458"></a> The kind of Proxy is forall k -&gt; k -&gt; *, where k is a Visible binder.
<a name="line-459"></a>
<a name="line-460"></a> Printing: As in the example above, Visible binders are put between `forall`
<a name="line-461"></a> and `-&gt;`. This syntax is not parsed (yet), however.
<a name="line-462"></a>
<a name="line-463"></a>-------------------------------------
<a name="line-464"></a>                Note [PredTy]
<a name="line-465"></a>-}</span>
<a name="line-466"></a>
<a name="line-467"></a><a name="PredType"></a><span class='hs-comment'>-- | A type of the form @p@ of kind @Constraint@ represents a value whose type is</span>
<a name="line-468"></a><a name="PredType"></a><span class='hs-comment'>-- the Haskell predicate @p@, where a predicate is what occurs before</span>
<a name="line-469"></a><a name="PredType"></a><span class='hs-comment'>-- the @=&gt;@ in a Haskell type.</span>
<a name="line-470"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-471"></a><a name="PredType"></a><span class='hs-comment'>-- We use 'PredType' as documentation to mark those types that we guarantee to have</span>
<a name="line-472"></a><a name="PredType"></a><span class='hs-comment'>-- this kind.</span>
<a name="line-473"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-474"></a><a name="PredType"></a><span class='hs-comment'>-- It can be expanded into its representation, but:</span>
<a name="line-475"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-476"></a><a name="PredType"></a><span class='hs-comment'>-- * The type checker must treat it as opaque</span>
<a name="line-477"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-478"></a><a name="PredType"></a><span class='hs-comment'>-- * The rest of the compiler treats it as transparent</span>
<a name="line-479"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-480"></a><a name="PredType"></a><span class='hs-comment'>-- Consider these examples:</span>
<a name="line-481"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-482"></a><a name="PredType"></a><span class='hs-comment'>-- &gt; f :: (Eq a) =&gt; a -&gt; Int</span>
<a name="line-483"></a><a name="PredType"></a><span class='hs-comment'>-- &gt; g :: (?x :: Int -&gt; Int) =&gt; a -&gt; Int</span>
<a name="line-484"></a><a name="PredType"></a><span class='hs-comment'>-- &gt; h :: (r\l) =&gt; {r} =&gt; {l::Int | r}</span>
<a name="line-485"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-486"></a><a name="PredType"></a><span class='hs-comment'>-- Here the @Eq a@ and @?x :: Int -&gt; Int@ and @r\l@ are all called \"predicates\"</span>
<a name="line-487"></a><a name="PredType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>
<a name="line-488"></a>
<a name="line-489"></a><a name="ThetaType"></a><span class='hs-comment'>-- | A collection of 'PredType's</span>
<a name="line-490"></a><a name="ThetaType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-491"></a>
<a name="line-492"></a><span class='hs-comment'>{-
<a name="line-493"></a>(We don't support TREX records yet, but the setup is designed
<a name="line-494"></a>to expand to allow them.)
<a name="line-495"></a>
<a name="line-496"></a>A Haskell qualified type, such as that for f,g,h above, is
<a name="line-497"></a>represented using
<a name="line-498"></a>        * a FunTy for the double arrow
<a name="line-499"></a>        * with a type of kind Constraint as the function argument
<a name="line-500"></a>
<a name="line-501"></a>The predicate really does turn into a real extra argument to the
<a name="line-502"></a>function.  If the argument has type (p :: Constraint) then the predicate p is
<a name="line-503"></a>represented by evidence of type p.
<a name="line-504"></a>
<a name="line-505"></a>%************************************************************************
<a name="line-506"></a>%*                                                                      *
<a name="line-507"></a>            Simple constructors
<a name="line-508"></a>%*                                                                      *
<a name="line-509"></a>%************************************************************************
<a name="line-510"></a>
<a name="line-511"></a>These functions are here so that they can be used by TysPrim,
<a name="line-512"></a>which in turn is imported by Type
<a name="line-513"></a>-}</span>
<a name="line-514"></a>
<a name="line-515"></a><a name="mkTyVarTy"></a><span class='hs-comment'>-- named with "Only" to prevent naive use of mkTyVarTy</span>
<a name="line-516"></a><span class='hs-definition'>mkTyVarTy</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-517"></a><span class='hs-definition'>mkTyVarTy</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-518"></a>                  <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span>
<a name="line-519"></a>
<a name="line-520"></a><a name="mkTyVarTys"></a><span class='hs-definition'>mkTyVarTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-521"></a><span class='hs-definition'>mkTyVarTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-comment'>-- a common use of mkTyVarTy</span>
<a name="line-522"></a>
<a name="line-523"></a><span class='hs-keyword'>infixr</span> <span class='hs-num'>3</span> <span class='hs-varop'>`mkFunTy`</span>      <span class='hs-comment'>-- Associates to the right</span>
<a name="line-524"></a><a name="mkFunTy"></a><span class='hs-comment'>-- | Make an arrow type</span>
<a name="line-525"></a><span class='hs-definition'>mkFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-526"></a><span class='hs-definition'>mkFunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span>
<a name="line-527"></a>
<a name="line-528"></a><a name="mkFunTys"></a><span class='hs-comment'>-- | Make nested arrow types</span>
<a name="line-529"></a><span class='hs-definition'>mkFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-530"></a><span class='hs-definition'>mkFunTys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span>
<a name="line-531"></a>
<a name="line-532"></a><a name="mkForAllTys"></a><span class='hs-comment'>-- | Wraps foralls over the type using the provided 'TyVar's from left to right</span>
<a name="line-533"></a><span class='hs-definition'>mkForAllTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-534"></a><span class='hs-definition'>mkForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tyvars</span>
<a name="line-535"></a>
<a name="line-536"></a><a name="isCoercionType"></a><span class='hs-comment'>-- | Does this type classify a core (unlifted) Coercion?</span>
<a name="line-537"></a><span class='hs-comment'>-- At either role nominal or reprsentational</span>
<a name="line-538"></a><span class='hs-comment'>--    (t1 ~# t2) or (t1 ~R# t2)</span>
<a name="line-539"></a><span class='hs-definition'>isCoercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-540"></a><span class='hs-definition'>isCoercionType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-541"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span><span class='hs-layout'>)</span>
<a name="line-542"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>==</span> <span class='hs-num'>4</span>
<a name="line-543"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-544"></a><span class='hs-definition'>isCoercionType</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-545"></a>
<a name="line-546"></a><a name="binderType"></a><span class='hs-definition'>binderType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-547"></a><span class='hs-definition'>binderType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varType</span> <span class='hs-varid'>v</span>
<a name="line-548"></a><span class='hs-definition'>binderType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-549"></a>
<a name="line-550"></a><a name="delBinderVar"></a><span class='hs-comment'>-- | Remove the binder's variable from the set, if the binder has</span>
<a name="line-551"></a><span class='hs-comment'>-- a variable.</span>
<a name="line-552"></a><span class='hs-definition'>delBinderVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-553"></a><span class='hs-definition'>delBinderVar</span> <span class='hs-varid'>vars</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vars</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span>
<a name="line-554"></a><span class='hs-definition'>delBinderVar</span> <span class='hs-varid'>vars</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vars</span>
<a name="line-555"></a>
<a name="line-556"></a><a name="delBinderVarFV"></a><span class='hs-comment'>-- | Remove the binder's variable from the set, if the binder has</span>
<a name="line-557"></a><span class='hs-comment'>-- a variable.</span>
<a name="line-558"></a><span class='hs-definition'>delBinderVarFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-559"></a><span class='hs-definition'>delBinderVarFV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFV</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-560"></a><span class='hs-definition'>delBinderVarFV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-varid'>vars</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-561"></a>
<a name="line-562"></a><a name="isInvisibleBinder"></a><span class='hs-comment'>-- | Does this binder bind an invisible argument?</span>
<a name="line-563"></a><span class='hs-definition'>isInvisibleBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-564"></a><span class='hs-definition'>isInvisibleBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vis</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>Visible</span>
<a name="line-565"></a><span class='hs-definition'>isInvisibleBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>ty</span>
<a name="line-566"></a>
<a name="line-567"></a><a name="isVisibleBinder"></a><span class='hs-comment'>-- | Does this binder bind a visible argument?</span>
<a name="line-568"></a><span class='hs-definition'>isVisibleBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-569"></a><span class='hs-definition'>isVisibleBinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isInvisibleBinder</span>
<a name="line-570"></a>
<a name="line-571"></a><a name="isNamedBinder"></a><span class='hs-definition'>isNamedBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-572"></a><span class='hs-definition'>isNamedBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-573"></a><span class='hs-definition'>isNamedBinder</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-574"></a>
<a name="line-575"></a><a name="isAnonBinder"></a><span class='hs-definition'>isAnonBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-576"></a><span class='hs-definition'>isAnonBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-577"></a><span class='hs-definition'>isAnonBinder</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-578"></a>
<a name="line-579"></a><a name="mkTyConTy"></a><span class='hs-comment'>-- | Create the plain type constructor type which has been applied to no type arguments at all.</span>
<a name="line-580"></a><span class='hs-definition'>mkTyConTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-581"></a><span class='hs-definition'>mkTyConTy</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-conid'>[]</span>
<a name="line-582"></a>
<a name="line-583"></a><span class='hs-comment'>{-
<a name="line-584"></a>Some basic functions, put here to break loops eg with the pretty printer
<a name="line-585"></a>-}</span>
<a name="line-586"></a>
<a name="line-587"></a><a name="isLiftedTypeKind"></a><span class='hs-comment'>-- | This version considers Constraint to be distinct from *.</span>
<a name="line-588"></a><span class='hs-definition'>isLiftedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-589"></a><span class='hs-definition'>isLiftedTypeKind</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ki'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>ki'</span>
<a name="line-590"></a><span class='hs-definition'>isLiftedTypeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>ptr_rep</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-591"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>tc</span>      <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tYPETyConKey</span>
<a name="line-592"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ptr_rep</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>ptrRepLiftedDataConKey</span>
<a name="line-593"></a><span class='hs-definition'>isLiftedTypeKind</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-594"></a>
<a name="line-595"></a><a name="isUnliftedTypeKind"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-596"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ki'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnliftedTypeKind</span> <span class='hs-varid'>ki'</span>
<a name="line-597"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>ptr_rep</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-598"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span>       <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tYPETyConKey</span>
<a name="line-599"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ptr_rep</span>  <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>ptrRepLiftedDataConKey</span>
<a name="line-600"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-601"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-602"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tYPETyConKey</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-603"></a>      <span class='hs-comment'>-- all other possibilities are unlifted</span>
<a name="line-604"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-605"></a>
<a name="line-606"></a><a name="isRuntimeRepTy"></a><span class='hs-comment'>-- | Is this the type 'RuntimeRep'?</span>
<a name="line-607"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-608"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRuntimeRepTy</span> <span class='hs-varid'>ty'</span>
<a name="line-609"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>runtimeRepTyConKey</span>
<a name="line-610"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-611"></a>
<a name="line-612"></a><a name="isRuntimeRepKindedTy"></a><span class='hs-comment'>-- | Is this a type of kind RuntimeRep? (e.g. PtrRep)</span>
<a name="line-613"></a><span class='hs-definition'>isRuntimeRepKindedTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-614"></a><span class='hs-definition'>isRuntimeRepKindedTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRuntimeRepTy</span> <span class='hs-varop'>.</span> <span class='hs-varid'>typeKind</span>
<a name="line-615"></a>
<a name="line-616"></a><a name="isRuntimeRepVar"></a><span class='hs-comment'>-- | Is a tyvar of type 'RuntimeRep'?</span>
<a name="line-617"></a><span class='hs-definition'>isRuntimeRepVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-618"></a><span class='hs-definition'>isRuntimeRepVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRuntimeRepTy</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span>
<a name="line-619"></a>
<a name="line-620"></a><a name="dropRuntimeRepArgs"></a><span class='hs-comment'>-- | Drops prefix of RuntimeRep constructors in 'TyConApp's. Useful for e.g.</span>
<a name="line-621"></a><span class='hs-comment'>-- dropping 'PtrRep arguments of unboxed tuple TyCon applications:</span>
<a name="line-622"></a><span class='hs-comment'>--</span>
<a name="line-623"></a><span class='hs-comment'>--   dropRuntimeRepArgs [ 'PtrRepLifted, 'PtrRepUnlifted</span>
<a name="line-624"></a><span class='hs-comment'>--                      , String, Int# ] == [String, Int#]</span>
<a name="line-625"></a><span class='hs-comment'>--</span>
<a name="line-626"></a><span class='hs-definition'>dropRuntimeRepArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-627"></a><span class='hs-definition'>dropRuntimeRepArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropWhile</span> <span class='hs-varid'>isRuntimeRepKindedTy</span>
<a name="line-628"></a>
<a name="line-629"></a><span class='hs-comment'>{-
<a name="line-630"></a>%************************************************************************
<a name="line-631"></a>%*                                                                      *
<a name="line-632"></a>            Coercions
<a name="line-633"></a>%*                                                                      *
<a name="line-634"></a>%************************************************************************
<a name="line-635"></a>-}</span>
<a name="line-636"></a>
<a name="line-637"></a><span class='hs-comment'>-- | A 'Coercion' is concrete evidence of the equality/convertibility</span>
<a name="line-638"></a><span class='hs-comment'>-- of two types.</span>
<a name="line-639"></a>
<a name="line-640"></a><a name="Coercion"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-641"></a><a name="Coercion"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span>
<a name="line-642"></a><a name="Coercion"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Coercion</span>
<a name="line-643"></a>  <span class='hs-comment'>-- Each constructor has a "role signature", indicating the way roles are</span>
<a name="line-644"></a>  <span class='hs-comment'>-- propagated through coercions.</span>
<a name="line-645"></a>  <span class='hs-comment'>--    -  P, N, and R stand for coercions of the given role</span>
<a name="line-646"></a>  <span class='hs-comment'>--    -  e stands for a coercion of a specific unknown role</span>
<a name="line-647"></a>  <span class='hs-comment'>--           (think "role polymorphism")</span>
<a name="line-648"></a>  <span class='hs-comment'>--    -  "e" stands for an explicit role parameter indicating role e.</span>
<a name="line-649"></a>  <span class='hs-comment'>--    -   _ stands for a parameter that is not a Role or Coercion.</span>
<a name="line-650"></a>
<a name="line-651"></a>  <span class='hs-comment'>-- These ones mirror the shape of types</span>
<a name="line-652"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Refl :: "e" -&gt; _ -&gt; e</span>
<a name="line-653"></a>    <span class='hs-conid'>Refl</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Type</span>  <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-654"></a>          <span class='hs-comment'>-- Invariant: applications of (Refl T) to a bunch of identity coercions</span>
<a name="line-655"></a>          <span class='hs-comment'>--            always show up as Refl.</span>
<a name="line-656"></a>          <span class='hs-comment'>-- For example  (Refl T) (Refl a) (Refl b) shows up as (Refl (T a b)).</span>
<a name="line-657"></a>
<a name="line-658"></a>          <span class='hs-comment'>-- Applications of (Refl T) to some coercions, at least one of</span>
<a name="line-659"></a>          <span class='hs-comment'>-- which is NOT the identity, show up as TyConAppCo.</span>
<a name="line-660"></a>          <span class='hs-comment'>-- (They may not be fully saturated however.)</span>
<a name="line-661"></a>          <span class='hs-comment'>-- ConAppCo coercions (like all coercions other than Refl)</span>
<a name="line-662"></a>          <span class='hs-comment'>-- are NEVER the identity.</span>
<a name="line-663"></a>
<a name="line-664"></a>          <span class='hs-comment'>-- Use (Refl Representational _), not (SubCo (Refl Nominal _))</span>
<a name="line-665"></a>
<a name="line-666"></a>  <span class='hs-comment'>-- These ones simply lift the correspondingly-named</span>
<a name="line-667"></a>  <span class='hs-comment'>-- Type constructors into Coercions</span>
<a name="line-668"></a>
<a name="line-669"></a>  <span class='hs-comment'>-- TyConAppCo :: "e" -&gt; _ -&gt; ?? -&gt; e</span>
<a name="line-670"></a>  <span class='hs-comment'>-- See Note [TyConAppCo roles]</span>
<a name="line-671"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- lift TyConApp</span>
<a name="line-672"></a>               <span class='hs-comment'>-- The TyCon is never a synonym;</span>
<a name="line-673"></a>               <span class='hs-comment'>-- we expand synonyms eagerly</span>
<a name="line-674"></a>               <span class='hs-comment'>-- But it can be a type function</span>
<a name="line-675"></a>
<a name="line-676"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>CoercionN</span>             <span class='hs-comment'>-- lift AppTy</span>
<a name="line-677"></a>          <span class='hs-comment'>-- AppCo :: e -&gt; N -&gt; e</span>
<a name="line-678"></a>
<a name="line-679"></a>  <span class='hs-comment'>-- See Note [Forall coercions]</span>
<a name="line-680"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-conid'>TyVar</span> <span class='hs-conid'>KindCoercion</span> <span class='hs-conid'>Coercion</span>
<a name="line-681"></a>         <span class='hs-comment'>-- ForAllCo :: _ -&gt; N -&gt; e -&gt; e</span>
<a name="line-682"></a>
<a name="line-683"></a>  <span class='hs-comment'>-- These are special</span>
<a name="line-684"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-conid'>CoVar</span>      <span class='hs-comment'>-- :: _ -&gt; (N or R)</span>
<a name="line-685"></a>                       <span class='hs-comment'>-- result role depends on the tycon of the variable's type</span>
<a name="line-686"></a>
<a name="line-687"></a>    <span class='hs-comment'>-- AxiomInstCo :: e -&gt; _ -&gt; [N] -&gt; e</span>
<a name="line-688"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span><span class='hs-layout'>)</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-689"></a>     <span class='hs-comment'>-- See also [CoAxiom index]</span>
<a name="line-690"></a>     <span class='hs-comment'>-- The coercion arguments always *precisely* saturate</span>
<a name="line-691"></a>     <span class='hs-comment'>-- arity of (that branch of) the CoAxiom. If there are</span>
<a name="line-692"></a>     <span class='hs-comment'>-- any left over, we use AppCo.</span>
<a name="line-693"></a>     <span class='hs-comment'>-- See [Coercion axioms applied to coercions]</span>
<a name="line-694"></a>
<a name="line-695"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnivCo</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span>
<a name="line-696"></a>      <span class='hs-comment'>-- :: _ -&gt; "e" -&gt; _ -&gt; _ -&gt; e</span>
<a name="line-697"></a>
<a name="line-698"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SymCo</span> <span class='hs-conid'>Coercion</span>             <span class='hs-comment'>-- :: e -&gt; e</span>
<a name="line-699"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TransCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Coercion</span>  <span class='hs-comment'>-- :: e -&gt; e -&gt; e</span>
<a name="line-700"></a>
<a name="line-701"></a>    <span class='hs-comment'>-- The number coercions should match exactly the expectations</span>
<a name="line-702"></a>    <span class='hs-comment'>-- of the CoAxiomRule (i.e., the rule is fully saturated).</span>
<a name="line-703"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-704"></a>
<a name="line-705"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NthCo</span>  <span class='hs-conid'>Int</span>         <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- Zero-indexed; decomposes (T t0 ... tn)</span>
<a name="line-706"></a>    <span class='hs-comment'>-- :: _ -&gt; e -&gt; ?? (inverse of TyConAppCo, see Note [TyConAppCo roles])</span>
<a name="line-707"></a>    <span class='hs-comment'>-- Using NthCo on a ForAllCo gives an N coercion always</span>
<a name="line-708"></a>    <span class='hs-comment'>-- See Note [NthCo and newtypes]</span>
<a name="line-709"></a>
<a name="line-710"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LRCo</span>   <span class='hs-conid'>LeftOrRight</span> <span class='hs-conid'>CoercionN</span>     <span class='hs-comment'>-- Decomposes (t_left t_right)</span>
<a name="line-711"></a>    <span class='hs-comment'>-- :: _ -&gt; N -&gt; N</span>
<a name="line-712"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>CoercionN</span>
<a name="line-713"></a>    <span class='hs-comment'>-- :: e -&gt; N -&gt; e</span>
<a name="line-714"></a>    <span class='hs-comment'>-- See Note [InstCo roles]</span>
<a name="line-715"></a>
<a name="line-716"></a>  <span class='hs-comment'>-- Coherence applies a coercion to the left-hand type of another coercion</span>
<a name="line-717"></a>  <span class='hs-comment'>-- See Note [Coherence]</span>
<a name="line-718"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoherenceCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>KindCoercion</span>
<a name="line-719"></a>     <span class='hs-comment'>-- :: e -&gt; N -&gt; e</span>
<a name="line-720"></a>
<a name="line-721"></a>  <span class='hs-comment'>-- Extract a kind coercion from a (heterogeneous) type coercion</span>
<a name="line-722"></a>  <span class='hs-comment'>-- NB: all kind coercions are Nominal</span>
<a name="line-723"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>KindCo</span> <span class='hs-conid'>Coercion</span>
<a name="line-724"></a>     <span class='hs-comment'>-- :: e -&gt; N</span>
<a name="line-725"></a>
<a name="line-726"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SubCo</span> <span class='hs-conid'>CoercionN</span>                  <span class='hs-comment'>-- Turns a ~N into a ~R</span>
<a name="line-727"></a>    <span class='hs-comment'>-- :: N -&gt; R</span>
<a name="line-728"></a>
<a name="line-729"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-730"></a>
<a name="line-731"></a><a name="CoercionN"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- always nominal</span>
<a name="line-732"></a><a name="CoercionR"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CoercionR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- always representational</span>
<a name="line-733"></a><a name="CoercionP"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CoercionP</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- always phantom</span>
<a name="line-734"></a><a name="KindCoercion"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>KindCoercion</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionN</span>   <span class='hs-comment'>-- always nominal</span>
<a name="line-735"></a>
<a name="line-736"></a><a name="LeftOrRight"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-737"></a><a name="LeftOrRight"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span>
<a name="line-738"></a><a name="LeftOrRight"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CLeft</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CRight</span>
<a name="line-739"></a>                 <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-740"></a>
<a name="line-741"></a><a name="instance%20Binary%20LeftOrRight"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyword'>where</span>
<a name="line-742"></a>   <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>CLeft</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-743"></a>   <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>CRight</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-744"></a>
<a name="line-745"></a>   <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-746"></a>               <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-747"></a>                   <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>CLeft</span>
<a name="line-748"></a>                   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>CRight</span> <span class='hs-layout'>}</span>
<a name="line-749"></a>
<a name="line-750"></a><a name="pickLR"></a><span class='hs-definition'>pickLR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-751"></a><span class='hs-definition'>pickLR</span> <span class='hs-conid'>CLeft</span>  <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span>
<a name="line-752"></a><span class='hs-definition'>pickLR</span> <span class='hs-conid'>CRight</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-753"></a>
<a name="line-754"></a>
<a name="line-755"></a><span class='hs-comment'>{-
<a name="line-756"></a>Note [Refl invariant]
<a name="line-757"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-758"></a>Invariant 1:
<a name="line-759"></a>
<a name="line-760"></a>Coercions have the following invariant
<a name="line-761"></a>     Refl is always lifted as far as possible.
<a name="line-762"></a>
<a name="line-763"></a>You might think that a consequencs is:
<a name="line-764"></a>     Every identity coercions has Refl at the root
<a name="line-765"></a>
<a name="line-766"></a>But that's not quite true because of coercion variables.  Consider
<a name="line-767"></a>     g         where g :: Int~Int
<a name="line-768"></a>     Left h    where h :: Maybe Int ~ Maybe Int
<a name="line-769"></a>etc.  So the consequence is only true of coercions that
<a name="line-770"></a>have no coercion variables.
<a name="line-771"></a>
<a name="line-772"></a>Note [Coercion axioms applied to coercions]
<a name="line-773"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-774"></a>The reason coercion axioms can be applied to coercions and not just
<a name="line-775"></a>types is to allow for better optimization.  There are some cases where
<a name="line-776"></a>we need to be able to "push transitivity inside" an axiom in order to
<a name="line-777"></a>expose further opportunities for optimization.
<a name="line-778"></a>
<a name="line-779"></a>For example, suppose we have
<a name="line-780"></a>
<a name="line-781"></a>  C a : t[a] ~ F a
<a name="line-782"></a>  g   : b ~ c
<a name="line-783"></a>
<a name="line-784"></a>and we want to optimize
<a name="line-785"></a>
<a name="line-786"></a>  sym (C b) ; t[g] ; C c
<a name="line-787"></a>
<a name="line-788"></a>which has the kind
<a name="line-789"></a>
<a name="line-790"></a>  F b ~ F c
<a name="line-791"></a>
<a name="line-792"></a>(stopping through t[b] and t[c] along the way).
<a name="line-793"></a>
<a name="line-794"></a>We'd like to optimize this to just F g -- but how?  The key is
<a name="line-795"></a>that we need to allow axioms to be instantiated by *coercions*,
<a name="line-796"></a>not just by types.  Then we can (in certain cases) push
<a name="line-797"></a>transitivity inside the axiom instantiations, and then react
<a name="line-798"></a>opposite-polarity instantiations of the same axiom.  In this
<a name="line-799"></a>case, e.g., we match t[g] against the LHS of (C c)'s kind, to
<a name="line-800"></a>obtain the substitution  a |-&gt; g  (note this operation is sort
<a name="line-801"></a>of the dual of lifting!) and hence end up with
<a name="line-802"></a>
<a name="line-803"></a>  C g : t[b] ~ F c
<a name="line-804"></a>
<a name="line-805"></a>which indeed has the same kind as  t[g] ; C c.
<a name="line-806"></a>
<a name="line-807"></a>Now we have
<a name="line-808"></a>
<a name="line-809"></a>  sym (C b) ; C g
<a name="line-810"></a>
<a name="line-811"></a>which can be optimized to F g.
<a name="line-812"></a>
<a name="line-813"></a>Note [CoAxiom index]
<a name="line-814"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-815"></a>A CoAxiom has 1 or more branches. Each branch has contains a list
<a name="line-816"></a>of the free type variables in that branch, the LHS type patterns,
<a name="line-817"></a>and the RHS type for that branch. When we apply an axiom to a list
<a name="line-818"></a>of coercions, we must choose which branch of the axiom we wish to
<a name="line-819"></a>use, as the different branches may have different numbers of free
<a name="line-820"></a>type variables. (The number of type patterns is always the same
<a name="line-821"></a>among branches, but that doesn't quite concern us here.)
<a name="line-822"></a>
<a name="line-823"></a>The Int in the AxiomInstCo constructor is the 0-indexed number
<a name="line-824"></a>of the chosen branch.
<a name="line-825"></a>
<a name="line-826"></a>Note [Forall coercions]
<a name="line-827"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-828"></a>Constructing coercions between forall-types can be a bit tricky,
<a name="line-829"></a>because the kinds of the bound tyvars can be different.
<a name="line-830"></a>
<a name="line-831"></a>The typing rule is:
<a name="line-832"></a>
<a name="line-833"></a>
<a name="line-834"></a>  kind_co : k1 ~ k2
<a name="line-835"></a>  tv1:k1 |- co : t1 ~ t2
<a name="line-836"></a>  -------------------------------------------------------------------
<a name="line-837"></a>  ForAllCo tv1 kind_co co : all tv1:k1. t1  ~
<a name="line-838"></a>                            all tv1:k2. (t2[tv1 |-&gt; tv1 |&gt; sym kind_co])
<a name="line-839"></a>
<a name="line-840"></a>First, the TyVar stored in a ForAllCo is really an optimisation: this field
<a name="line-841"></a>should be a Name, as its kind is redundant. Thinking of the field as a Name
<a name="line-842"></a>is helpful in understanding what a ForAllCo means.
<a name="line-843"></a>
<a name="line-844"></a>The idea is that kind_co gives the two kinds of the tyvar. See how, in the
<a name="line-845"></a>conclusion, tv1 is assigned kind k1 on the left but kind k2 on the right.
<a name="line-846"></a>
<a name="line-847"></a>Of course, a type variable can't have different kinds at the same time. So,
<a name="line-848"></a>we arbitrarily prefer the first kind when using tv1 in the inner coercion
<a name="line-849"></a>co, which shows that t1 equals t2.
<a name="line-850"></a>
<a name="line-851"></a>The last wrinkle is that we need to fix the kinds in the conclusion. In
<a name="line-852"></a>t2, tv1 is assumed to have kind k1, but it has kind k2 in the conclusion of
<a name="line-853"></a>the rule. So we do a kind-fixing substitution, replacing (tv1:k1) with
<a name="line-854"></a>(tv1:k2) |&gt; sym kind_co. This substitution is slightly bizarre, because it
<a name="line-855"></a>mentions the same name with different kinds, but it *is* well-kinded, noting
<a name="line-856"></a>that `(tv1:k2) |&gt; sym kind_co` has kind k1.
<a name="line-857"></a>
<a name="line-858"></a>This all really would work storing just a Name in the ForAllCo. But we can't
<a name="line-859"></a>add Names to, e.g., VarSets, and there generally is just an impedence mismatch
<a name="line-860"></a>in a bunch of places. So we use tv1. When we need tv2, we can use
<a name="line-861"></a>setTyVarKind.
<a name="line-862"></a>
<a name="line-863"></a>Note [Coherence]
<a name="line-864"></a>~~~~~~~~~~~~~~~~
<a name="line-865"></a>The Coherence typing rule is thus:
<a name="line-866"></a>
<a name="line-867"></a>  g1 : s ~ t    s : k1    g2 : k1 ~ k2
<a name="line-868"></a>  ------------------------------------
<a name="line-869"></a>  CoherenceCo g1 g2 : (s |&gt; g2) ~ t
<a name="line-870"></a>
<a name="line-871"></a>While this looks (and is) unsymmetric, a combination of other coercion
<a name="line-872"></a>combinators can make the symmetric version.
<a name="line-873"></a>
<a name="line-874"></a>For role information, see Note [Roles and kind coercions].
<a name="line-875"></a>
<a name="line-876"></a>Note [Predicate coercions]
<a name="line-877"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-878"></a>Suppose we have
<a name="line-879"></a>   g :: a~b
<a name="line-880"></a>How can we coerce between types
<a name="line-881"></a>   ([c]~a) =&gt; [a] -&gt; c
<a name="line-882"></a>and
<a name="line-883"></a>   ([c]~b) =&gt; [b] -&gt; c
<a name="line-884"></a>where the equality predicate *itself* differs?
<a name="line-885"></a>
<a name="line-886"></a>Answer: we simply treat (~) as an ordinary type constructor, so these
<a name="line-887"></a>types really look like
<a name="line-888"></a>
<a name="line-889"></a>   ((~) [c] a) -&gt; [a] -&gt; c
<a name="line-890"></a>   ((~) [c] b) -&gt; [b] -&gt; c
<a name="line-891"></a>
<a name="line-892"></a>So the coercion between the two is obviously
<a name="line-893"></a>
<a name="line-894"></a>   ((~) [c] g) -&gt; [g] -&gt; c
<a name="line-895"></a>
<a name="line-896"></a>Another way to see this to say that we simply collapse predicates to
<a name="line-897"></a>their representation type (see Type.coreView and Type.predTypeRep).
<a name="line-898"></a>
<a name="line-899"></a>This collapse is done by mkPredCo; there is no PredCo constructor
<a name="line-900"></a>in Coercion.  This is important because we need Nth to work on
<a name="line-901"></a>predicates too:
<a name="line-902"></a>    Nth 1 ((~) [c] g) = g
<a name="line-903"></a>See Simplify.simplCoercionF, which generates such selections.
<a name="line-904"></a>
<a name="line-905"></a>Note [Roles]
<a name="line-906"></a>~~~~~~~~~~~~
<a name="line-907"></a>Roles are a solution to the GeneralizedNewtypeDeriving problem, articulated
<a name="line-908"></a>in Trac #1496. The full story is in docs/core-spec/core-spec.pdf. Also, see
<a name="line-909"></a><a href="http://ghc.haskell.org/trac/ghc/wiki/RolesImplementation">http://ghc.haskell.org/trac/ghc/wiki/RolesImplementation</a>
<a name="line-910"></a>
<a name="line-911"></a>Here is one way to phrase the problem:
<a name="line-912"></a>
<a name="line-913"></a>Given:
<a name="line-914"></a>newtype Age = MkAge Int
<a name="line-915"></a>type family F x
<a name="line-916"></a>type instance F Age = Bool
<a name="line-917"></a>type instance F Int = Char
<a name="line-918"></a>
<a name="line-919"></a>This compiles down to:
<a name="line-920"></a>axAge :: Age ~ Int
<a name="line-921"></a>axF1 :: F Age ~ Bool
<a name="line-922"></a>axF2 :: F Int ~ Char
<a name="line-923"></a>
<a name="line-924"></a>Then, we can make:
<a name="line-925"></a>(sym (axF1) ; F axAge ; axF2) :: Bool ~ Char
<a name="line-926"></a>
<a name="line-927"></a>Yikes!
<a name="line-928"></a>
<a name="line-929"></a>The solution is _roles_, as articulated in "Generative Type Abstraction and
<a name="line-930"></a>Type-level Computation" (POPL 2010), available at
<a name="line-931"></a><a href="http://www.seas.upenn.edu/~sweirich/papers/popl163af-weirich.pdf">http://www.seas.upenn.edu/~sweirich/papers/popl163af-weirich.pdf</a>
<a name="line-932"></a>
<a name="line-933"></a>The specification for roles has evolved somewhat since that paper. For the
<a name="line-934"></a>current full details, see the documentation in docs/core-spec. Here are some
<a name="line-935"></a>highlights.
<a name="line-936"></a>
<a name="line-937"></a>We label every equality with a notion of type equivalence, of which there are
<a name="line-938"></a>three options: Nominal, Representational, and Phantom. A ground type is
<a name="line-939"></a>nominally equivalent only with itself. A newtype (which is considered a ground
<a name="line-940"></a>type in Haskell) is representationally equivalent to its representation.
<a name="line-941"></a>Anything is "phantomly" equivalent to anything else. We use "N", "R", and "P"
<a name="line-942"></a>to denote the equivalences.
<a name="line-943"></a>
<a name="line-944"></a>The axioms above would be:
<a name="line-945"></a>axAge :: Age ~R Int
<a name="line-946"></a>axF1 :: F Age ~N Bool
<a name="line-947"></a>axF2 :: F Age ~N Char
<a name="line-948"></a>
<a name="line-949"></a>Then, because transitivity applies only to coercions proving the same notion
<a name="line-950"></a>of equivalence, the above construction is impossible.
<a name="line-951"></a>
<a name="line-952"></a>However, there is still an escape hatch: we know that any two types that are
<a name="line-953"></a>nominally equivalent are representationally equivalent as well. This is what
<a name="line-954"></a>the form SubCo proves -- it "demotes" a nominal equivalence into a
<a name="line-955"></a>representational equivalence. So, it would seem the following is possible:
<a name="line-956"></a>
<a name="line-957"></a>sub (sym axF1) ; F axAge ; sub axF2 :: Bool ~R Char   -- WRONG
<a name="line-958"></a>
<a name="line-959"></a>What saves us here is that the arguments to a type function F, lifted into a
<a name="line-960"></a>coercion, *must* prove nominal equivalence. So, (F axAge) is ill-formed, and
<a name="line-961"></a>we are safe.
<a name="line-962"></a>
<a name="line-963"></a>Roles are attached to parameters to TyCons. When lifting a TyCon into a
<a name="line-964"></a>coercion (through TyConAppCo), we need to ensure that the arguments to the
<a name="line-965"></a>TyCon respect their roles. For example:
<a name="line-966"></a>
<a name="line-967"></a>data T a b = MkT a (F b)
<a name="line-968"></a>
<a name="line-969"></a>If we know that a1 ~R a2, then we know (T a1 b) ~R (T a2 b). But, if we know
<a name="line-970"></a>that b1 ~R b2, we know nothing about (T a b1) and (T a b2)! This is because
<a name="line-971"></a>the type function F branches on b's *name*, not representation. So, we say
<a name="line-972"></a>that 'a' has role Representational and 'b' has role Nominal. The third role,
<a name="line-973"></a>Phantom, is for parameters not used in the type's definition. Given the
<a name="line-974"></a>following definition
<a name="line-975"></a>
<a name="line-976"></a>data Q a = MkQ Int
<a name="line-977"></a>
<a name="line-978"></a>the Phantom role allows us to say that (Q Bool) ~R (Q Char), because we
<a name="line-979"></a>can construct the coercion Bool ~P Char (using UnivCo).
<a name="line-980"></a>
<a name="line-981"></a>See the paper cited above for more examples and information.
<a name="line-982"></a>
<a name="line-983"></a>Note [TyConAppCo roles]
<a name="line-984"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-985"></a>The TyConAppCo constructor has a role parameter, indicating the role at
<a name="line-986"></a>which the coercion proves equality. The choice of this parameter affects
<a name="line-987"></a>the required roles of the arguments of the TyConAppCo. To help explain
<a name="line-988"></a>it, assume the following definition:
<a name="line-989"></a>
<a name="line-990"></a>  type instance F Int = Bool   -- Axiom axF : F Int ~N Bool
<a name="line-991"></a>  newtype Age = MkAge Int      -- Axiom axAge : Age ~R Int
<a name="line-992"></a>  data Foo a = MkFoo a         -- Role on Foo's parameter is Representational
<a name="line-993"></a>
<a name="line-994"></a>TyConAppCo Nominal Foo axF : Foo (F Int) ~N Foo Bool
<a name="line-995"></a>  For (TyConAppCo Nominal) all arguments must have role Nominal. Why?
<a name="line-996"></a>  So that Foo Age ~N Foo Int does *not* hold.
<a name="line-997"></a>
<a name="line-998"></a>TyConAppCo Representational Foo (SubCo axF) : Foo (F Int) ~R Foo Bool
<a name="line-999"></a>TyConAppCo Representational Foo axAge       : Foo Age     ~R Foo Int
<a name="line-1000"></a>  For (TyConAppCo Representational), all arguments must have the roles
<a name="line-1001"></a>  corresponding to the result of tyConRoles on the TyCon. This is the
<a name="line-1002"></a>  whole point of having roles on the TyCon to begin with. So, we can
<a name="line-1003"></a>  have Foo Age ~R Foo Int, if Foo's parameter has role R.
<a name="line-1004"></a>
<a name="line-1005"></a>  If a Representational TyConAppCo is over-saturated (which is otherwise fine),
<a name="line-1006"></a>  the spill-over arguments must all be at Nominal. This corresponds to the
<a name="line-1007"></a>  behavior for AppCo.
<a name="line-1008"></a>
<a name="line-1009"></a>TyConAppCo Phantom Foo (UnivCo Phantom Int Bool) : Foo Int ~P Foo Bool
<a name="line-1010"></a>  All arguments must have role Phantom. This one isn't strictly
<a name="line-1011"></a>  necessary for soundness, but this choice removes ambiguity.
<a name="line-1012"></a>
<a name="line-1013"></a>The rules here dictate the roles of the parameters to mkTyConAppCo
<a name="line-1014"></a>(should be checked by Lint).
<a name="line-1015"></a>
<a name="line-1016"></a>Note [NthCo and newtypes]
<a name="line-1017"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1018"></a>Suppose we have
<a name="line-1019"></a>
<a name="line-1020"></a>  newtype N a = MkN Int
<a name="line-1021"></a>  type role N representational
<a name="line-1022"></a>
<a name="line-1023"></a>This yields axiom
<a name="line-1024"></a>
<a name="line-1025"></a>  NTCo:N :: forall a. N a ~R Int
<a name="line-1026"></a>
<a name="line-1027"></a>We can then build
<a name="line-1028"></a>
<a name="line-1029"></a>  co :: forall a b. N a ~R N b
<a name="line-1030"></a>  co = NTCo:N a ; sym (NTCo:N b)
<a name="line-1031"></a>
<a name="line-1032"></a>for any `a` and `b`. Because of the role annotation on N, if we use
<a name="line-1033"></a>NthCo, we'll get out a representational coercion. That is:
<a name="line-1034"></a>
<a name="line-1035"></a>  NthCo 0 co :: forall a b. a ~R b
<a name="line-1036"></a>
<a name="line-1037"></a>Yikes! Clearly, this is terrible. The solution is simple: forbid
<a name="line-1038"></a>NthCo to be used on newtypes if the internal coercion is representational.
<a name="line-1039"></a>
<a name="line-1040"></a>This is not just some corner case discovered by a segfault somewhere;
<a name="line-1041"></a>it was discovered in the proof of soundness of roles and described
<a name="line-1042"></a>in the "Safe Coercions" paper (ICFP '14).
<a name="line-1043"></a>
<a name="line-1044"></a>Note [InstCo roles]
<a name="line-1045"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-1046"></a>Here is (essentially) the typing rule for InstCo:
<a name="line-1047"></a>
<a name="line-1048"></a>g :: (forall a. t1) ~r (forall a. t2)
<a name="line-1049"></a>w :: s1 ~N s2
<a name="line-1050"></a>------------------------------- InstCo
<a name="line-1051"></a>InstCo g w :: (t1 [a |-&gt; s1]) ~r (t2 [a |-&gt; s2])
<a name="line-1052"></a>
<a name="line-1053"></a>Note that the Coercion w *must* be nominal. This is necessary
<a name="line-1054"></a>because the variable a might be used in a "nominal position"
<a name="line-1055"></a>(that is, a place where role inference would require a nominal
<a name="line-1056"></a>role) in t1 or t2. If we allowed w to be representational, we
<a name="line-1057"></a>could get bogus equalities.
<a name="line-1058"></a>
<a name="line-1059"></a>A more nuanced treatment might be able to relax this condition
<a name="line-1060"></a>somewhat, by checking if t1 and/or t2 use their bound variables
<a name="line-1061"></a>in nominal ways. If not, having w be representational is OK.
<a name="line-1062"></a>
<a name="line-1063"></a>
<a name="line-1064"></a>%************************************************************************
<a name="line-1065"></a>%*                                                                      *
<a name="line-1066"></a>                UnivCoProvenance
<a name="line-1067"></a>%*                                                                      *
<a name="line-1068"></a>%************************************************************************
<a name="line-1069"></a>
<a name="line-1070"></a>A UnivCo is a coercion whose proof does not directly express its role
<a name="line-1071"></a>and kind (indeed for some UnivCos, like UnsafeCoerceProv, there /is/
<a name="line-1072"></a>no proof).
<a name="line-1073"></a>
<a name="line-1074"></a>The different kinds of UnivCo are described by UnivCoProvenance.  Really
<a name="line-1075"></a>each is entirely separate, but they all share the need to represent their
<a name="line-1076"></a>role and kind, which is done in the UnivCo constructor.
<a name="line-1077"></a>
<a name="line-1078"></a>-}</span>
<a name="line-1079"></a>
<a name="line-1080"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- | For simplicity, we have just one UnivCo that represents a coercion from</span>
<a name="line-1081"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- some type to some other type, with (in general) no restrictions on the</span>
<a name="line-1082"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- type. The UnivCoProvenance specifies more exactly what the coercion really</span>
<a name="line-1083"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- is and why a program should (or shouldn't!) trust the coercion.</span>
<a name="line-1084"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- It is reasonable to consider each constructor of 'UnivCoProvenance'</span>
<a name="line-1085"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- as a totally independent coercion form; their only commonality is</span>
<a name="line-1086"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- that they don't tell you what types they coercion between. (That info</span>
<a name="line-1087"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- is in the 'UnivCo' constructor of 'Coercion'.</span>
<a name="line-1088"></a><a name="UnivCoProvenance"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UnivCoProvenance</span>
<a name="line-1089"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnsafeCoerceProv</span>   <span class='hs-comment'>-- ^ From @unsafeCoerce#@. These are unsound.</span>
<a name="line-1090"></a>
<a name="line-1091"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-conid'>KindCoercion</span> <span class='hs-comment'>-- ^ See Note [Phantom coercions]. Only in Phantom</span>
<a name="line-1092"></a>                             <span class='hs-comment'>-- roled coercions</span>
<a name="line-1093"></a>
<a name="line-1094"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-conid'>KindCoercion</span>  <span class='hs-comment'>-- ^ From the fact that any two coercions are</span>
<a name="line-1095"></a>                                 <span class='hs-comment'>--   considered equivalent. See Note [ProofIrrelProv].</span>
<a name="line-1096"></a>                                 <span class='hs-comment'>-- Can be used in Nominal or Representational coercions</span>
<a name="line-1097"></a>
<a name="line-1098"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PluginProv</span> <span class='hs-conid'>String</span>  <span class='hs-comment'>-- ^ From a plugin, which asserts that this coercion</span>
<a name="line-1099"></a>                       <span class='hs-comment'>--   is sound. The string is for the use of the plugin.</span>
<a name="line-1100"></a>
<a name="line-1101"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HoleProv</span> <span class='hs-conid'>CoercionHole</span>  <span class='hs-comment'>-- ^ See Note [Coercion holes]</span>
<a name="line-1102"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-1103"></a>
<a name="line-1104"></a><a name="instance%20Outputable%20UnivCoProvenance"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyword'>where</span>
<a name="line-1105"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>UnsafeCoerceProv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(unsafeCoerce#)"</span>
<a name="line-1106"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(phantom)"</span>
<a name="line-1107"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(proof irrel.)"</span>
<a name="line-1108"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"plugin"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1109"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"hole"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span>
<a name="line-1110"></a>
<a name="line-1111"></a><a name="CoercionHole"></a><span class='hs-comment'>-- | A coercion to be filled in by the type-checker. See Note [Coercion holes]</span>
<a name="line-1112"></a><a name="CoercionHole"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CoercionHole</span>
<a name="line-1113"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-layout'>{</span> <span class='hs-varid'>chUnique</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span>   <span class='hs-comment'>-- ^ used only for debugging</span>
<a name="line-1114"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>chCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1115"></a>                 <span class='hs-layout'>}</span>
<a name="line-1116"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-1117"></a>
<a name="line-1118"></a><a name="instance%20Data.Data%20CoercionHole"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyword'>where</span>
<a name="line-1119"></a>  <span class='hs-comment'>-- don't traverse?</span>
<a name="line-1120"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abstractConstr</span> <span class='hs-str'>"CoercionHole"</span>
<a name="line-1121"></a>  <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-1122"></a>  <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"CoercionHole"</span>
<a name="line-1123"></a>
<a name="line-1124"></a><a name="instance%20Outputable%20CoercionHole"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyword'>where</span>
<a name="line-1125"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionHole</span> <span class='hs-varid'>u</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-1126"></a>
<a name="line-1127"></a>
<a name="line-1128"></a><span class='hs-comment'>{- Note [Phantom coercions]
<a name="line-1129"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1130"></a>Consider
<a name="line-1131"></a>     data T a = T1 | T2
<a name="line-1132"></a>Then we have
<a name="line-1133"></a>     T s ~R T t
<a name="line-1134"></a>for any old s,t. The witness for this is (TyConAppCo T Rep co),
<a name="line-1135"></a>where (co :: s ~P t) is a phantom coercion built with PhantomProv.
<a name="line-1136"></a>The role of the UnivCo is always Phantom.  The Coercion stored is the
<a name="line-1137"></a>(nominal) kind coercion between the types
<a name="line-1138"></a>   kind(s) ~N kind (t)
<a name="line-1139"></a>
<a name="line-1140"></a>Note [Coercion holes]
<a name="line-1141"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1142"></a>During typechecking, constraint solving for type classes works by
<a name="line-1143"></a>  - Generate an evidence Id,  d7 :: Num a
<a name="line-1144"></a>  - Wrap it in a Wanted constraint, [W] d7 :: Num a
<a name="line-1145"></a>  - Use the evidence Id where the evidence is needed
<a name="line-1146"></a>  - Solve the constraint later
<a name="line-1147"></a>  - When solved, add an enclosing let-binding  let d7 = .... in ....
<a name="line-1148"></a>    which actually binds d7 to the (Num a) evidence
<a name="line-1149"></a>
<a name="line-1150"></a>For equality constraints we use a different strategy.  See Note [The
<a name="line-1151"></a>equality types story] in TysPrim for background on equality constraints.
<a name="line-1152"></a>  - For boxed equality constraints, (t1 ~N t2) and (t1 ~R t2), it's just
<a name="line-1153"></a>    like type classes above. (Indeed, boxed equality constraints *are* classes.)
<a name="line-1154"></a>  - But for /unboxed/ equality constraints (t1 ~R# t2) and (t1 ~N# t2)
<a name="line-1155"></a>    we use a different plan
<a name="line-1156"></a>
<a name="line-1157"></a>For unboxed equalities:
<a name="line-1158"></a>  - Generate a CoercionHole, a mutable variable just like a unification
<a name="line-1159"></a>    variable
<a name="line-1160"></a>  - Wrap the CoercionHole in a Wanted constraint; see TcRnTypes.TcEvDest
<a name="line-1161"></a>  - Use the CoercionHole in a Coercion, via HoleProv
<a name="line-1162"></a>  - Solve the constraint later
<a name="line-1163"></a>  - When solved, fill in the CoercionHole by side effect, instead of
<a name="line-1164"></a>    doing the let-binding thing
<a name="line-1165"></a>
<a name="line-1166"></a>The main reason for all this is that there may be no good place to let-bind
<a name="line-1167"></a>the evidence for unboxed equalities:
<a name="line-1168"></a>  - We emit constraints for kind coercions, to be used
<a name="line-1169"></a>    to cast a type's kind. These coercions then must be used in types. Because
<a name="line-1170"></a>    they might appear in a top-level type, there is no place to bind these
<a name="line-1171"></a>   (unlifted) coercions in the usual way.
<a name="line-1172"></a>
<a name="line-1173"></a>  - A coercion for (forall a. t1) ~ forall a. t2) will look like
<a name="line-1174"></a>       forall a. (coercion for t1~t2)
<a name="line-1175"></a>    But the coercion for (t1~t2) may mention 'a', and we don't have let-bindings
<a name="line-1176"></a>    within coercions.  We could add them, but coercion holes are easier.
<a name="line-1177"></a>
<a name="line-1178"></a>Other notes about HoleCo:
<a name="line-1179"></a>
<a name="line-1180"></a> * INVARIANT: CoercionHole and HoleProv are used only during type checking,
<a name="line-1181"></a>   and should never appear in Core. Just like unification variables; a Type
<a name="line-1182"></a>   can contain a TcTyVar, but only during type checking. If, one day, we
<a name="line-1183"></a>   use type-level information to separate out forms that can appear during
<a name="line-1184"></a>   type-checking vs forms that can appear in core proper, holes in Core will
<a name="line-1185"></a>   be ruled out.
<a name="line-1186"></a>
<a name="line-1187"></a> * The Unique carried with a coercion hole is used solely for debugging.
<a name="line-1188"></a>
<a name="line-1189"></a> * Coercion holes can be compared for equality only like other coercions:
<a name="line-1190"></a>   only by looking at the types coerced.
<a name="line-1191"></a>
<a name="line-1192"></a> * We don't use holes for other evidence because other evidence wants to
<a name="line-1193"></a>   be /shared/. But coercions are entirely erased, so there's little
<a name="line-1194"></a>   benefit to sharing.
<a name="line-1195"></a>
<a name="line-1196"></a>Note [ProofIrrelProv]
<a name="line-1197"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-1198"></a>A ProofIrrelProv is a coercion between coercions. For example:
<a name="line-1199"></a>
<a name="line-1200"></a>  data G a where
<a name="line-1201"></a>    MkG :: G Bool
<a name="line-1202"></a>
<a name="line-1203"></a>In core, we get
<a name="line-1204"></a>
<a name="line-1205"></a>  G :: * -&gt; *
<a name="line-1206"></a>  MkG :: forall (a :: *). (a ~ Bool) -&gt; G a
<a name="line-1207"></a>
<a name="line-1208"></a>Now, consider 'MkG -- that is, MkG used in a type -- and suppose we want
<a name="line-1209"></a>a proof that ('MkG co1 a1) ~ ('MkG co2 a2). This will have to be
<a name="line-1210"></a>
<a name="line-1211"></a>  TyConAppCo Nominal MkG [co3, co4]
<a name="line-1212"></a>  where
<a name="line-1213"></a>    co3 :: co1 ~ co2
<a name="line-1214"></a>    co4 :: a1 ~ a2
<a name="line-1215"></a>
<a name="line-1216"></a>Note that
<a name="line-1217"></a>  co1 :: a1 ~ Bool
<a name="line-1218"></a>  co2 :: a2 ~ Bool
<a name="line-1219"></a>
<a name="line-1220"></a>Here,
<a name="line-1221"></a>  co3 = UnivCo (ProofIrrelProv co5) Nominal (CoercionTy co1) (CoercionTy co2)
<a name="line-1222"></a>  where
<a name="line-1223"></a>    co5 :: (a1 ~ Bool) ~ (a2 ~ Bool)
<a name="line-1224"></a>    co5 = TyConAppCo Nominal (~) [&lt;*&gt;, &lt;*&gt;, co4, &lt;Bool&gt;]
<a name="line-1225"></a>
<a name="line-1226"></a>
<a name="line-1227"></a>%************************************************************************
<a name="line-1228"></a>%*                                                                      *
<a name="line-1229"></a>                 Free variables of types and coercions
<a name="line-1230"></a>%*                                                                      *
<a name="line-1231"></a>%************************************************************************
<a name="line-1232"></a>-}</span>
<a name="line-1233"></a>
<a name="line-1234"></a><a name="tyCoVarsOfType"></a><span class='hs-comment'>-- | Returns free variables of a type, including kind variables as</span>
<a name="line-1235"></a><span class='hs-comment'>-- a non-deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-1236"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1237"></a><span class='hs-definition'>tyCoVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1238"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1239"></a><span class='hs-definition'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1240"></a>
<a name="line-1241"></a><a name="tyCoVarsOfTypeDSet"></a><span class='hs-comment'>-- | `tyVarsOfType` that returns free variables of a type in a deterministic</span>
<a name="line-1242"></a><span class='hs-comment'>-- set. For explanation of why using `VarSet` is not deterministic see</span>
<a name="line-1243"></a><span class='hs-comment'>-- Note [Deterministic FV] in FV.</span>
<a name="line-1244"></a><span class='hs-definition'>tyCoVarsOfTypeDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-1245"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1246"></a><span class='hs-definition'>tyCoVarsOfTypeDSet</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1247"></a>
<a name="line-1248"></a><a name="tyCoVarsOfTypeList"></a><span class='hs-comment'>-- | `tyVarsOfType` that returns free variables of a type in deterministic</span>
<a name="line-1249"></a><span class='hs-comment'>-- order. For explanation of why using `VarSet` is not deterministic see</span>
<a name="line-1250"></a><span class='hs-comment'>-- Note [Deterministic FV] in FV.</span>
<a name="line-1251"></a><span class='hs-definition'>tyCoVarsOfTypeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1252"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1253"></a><span class='hs-definition'>tyCoVarsOfTypeList</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1254"></a>
<a name="line-1255"></a><a name="tyCoFVsOfType"></a><span class='hs-comment'>-- | The worker for `tyVarsOfType` and `tyVarsOfTypeList`.</span>
<a name="line-1256"></a><span class='hs-comment'>-- The previous implementation used `unionVarSet` which is O(n+m) and can</span>
<a name="line-1257"></a><span class='hs-comment'>-- make the function quadratic.</span>
<a name="line-1258"></a><span class='hs-comment'>-- It's exported, so that it can be composed with</span>
<a name="line-1259"></a><span class='hs-comment'>-- other functions that compute free variables.</span>
<a name="line-1260"></a><span class='hs-comment'>-- See Note [FV naming conventions] in FV.</span>
<a name="line-1261"></a><span class='hs-comment'>--</span>
<a name="line-1262"></a><span class='hs-comment'>-- Eta-expanded because that makes it run faster (apparently)</span>
<a name="line-1263"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1264"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1265"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>        <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitFV</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1266"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>   <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1267"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1268"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>    <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1269"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsBndr</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1270"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1271"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1272"></a>
<a name="line-1273"></a><a name="tyCoFVsBndr"></a><span class='hs-definition'>tyCoFVsBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1274"></a><span class='hs-comment'>-- Free vars of (forall b. &lt;thing with fvs&gt;)</span>
<a name="line-1275"></a><span class='hs-definition'>tyCoFVsBndr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delBinderVarFV</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>fvs</span>
<a name="line-1276"></a>                           <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-1277"></a>
<a name="line-1278"></a><a name="tyCoVarsOfTypes"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-1279"></a><span class='hs-comment'>-- a non-deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-1280"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1281"></a><span class='hs-definition'>tyCoVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1282"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1283"></a><span class='hs-definition'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1284"></a>
<a name="line-1285"></a><a name="tyCoVarsOfTypesDSet"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-1286"></a><span class='hs-comment'>-- a deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-1287"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1288"></a><span class='hs-definition'>tyCoVarsOfTypesDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-1289"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1290"></a><span class='hs-definition'>tyCoVarsOfTypesDSet</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1291"></a>
<a name="line-1292"></a><a name="tyCoVarsOfTypesList"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-1293"></a><span class='hs-comment'>-- a deterministically ordered list. For type synonyms it does /not/ expand the</span>
<a name="line-1294"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1295"></a><span class='hs-definition'>tyCoVarsOfTypesList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1296"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1297"></a><span class='hs-definition'>tyCoVarsOfTypesList</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1298"></a>
<a name="line-1299"></a><a name="tyCoFVsOfTypes"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1300"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1301"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1302"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-conid'>[]</span>       <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1303"></a>
<a name="line-1304"></a><a name="tyCoVarsOfCo"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1305"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1306"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1307"></a>
<a name="line-1308"></a><a name="tyCoVarsOfCoDSet"></a><span class='hs-comment'>-- | Get a deterministic set of the vars free in a coercion</span>
<a name="line-1309"></a><span class='hs-definition'>tyCoVarsOfCoDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-1310"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1311"></a><span class='hs-definition'>tyCoVarsOfCoDSet</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1312"></a>
<a name="line-1313"></a><a name="tyCoVarsOfCoList"></a><span class='hs-definition'>tyCoVarsOfCoList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1314"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1315"></a><span class='hs-definition'>tyCoVarsOfCoList</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1316"></a>
<a name="line-1317"></a><a name="tyCoFVsOfCo"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1318"></a><span class='hs-comment'>-- Extracts type and coercion variables from a coercion</span>
<a name="line-1319"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1320"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>         <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1321"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1322"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1323"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1324"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1325"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>delFV</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>kind_co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1326"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1327"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitFV</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1328"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1329"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1330"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfProv</span> <span class='hs-varid'>p</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>t1</span>
<a name="line-1331"></a>                         <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1332"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1333"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1334"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1335"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1336"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1337"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1338"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1339"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1340"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cs</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1341"></a>
<a name="line-1342"></a><a name="tyCoVarsOfProv"></a><span class='hs-definition'>tyCoVarsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1343"></a><span class='hs-definition'>tyCoVarsOfProv</span> <span class='hs-varid'>prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfProv</span> <span class='hs-varid'>prov</span>
<a name="line-1344"></a>
<a name="line-1345"></a><a name="tyCoFVsOfProv"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1346"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1347"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1348"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1349"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1350"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1351"></a>
<a name="line-1352"></a><a name="tyCoVarsOfCos"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1353"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-1354"></a>
<a name="line-1355"></a><a name="tyCoFVsOfCos"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1356"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-conid'>[]</span>       <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1357"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1358"></a>
<a name="line-1359"></a><a name="coVarsOfType"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-1360"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1361"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1362"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1363"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>arg</span>
<a name="line-1364"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1365"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`delBinderVar`</span> <span class='hs-varid'>bndr</span>
<a name="line-1366"></a>    <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-1367"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1368"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1369"></a>
<a name="line-1370"></a><a name="coVarsOfTypes"></a><span class='hs-definition'>coVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1371"></a><span class='hs-definition'>coVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>tys</span>
<a name="line-1372"></a>
<a name="line-1373"></a><a name="coVarsOfCo"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-1374"></a><span class='hs-comment'>-- Extract *coercion* variables only.  Tiresome to repeat the code, but easy.</span>
<a name="line-1375"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1376"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>args</span>
<a name="line-1377"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>arg</span>
<a name="line-1378"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1379"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>kind_co</span>
<a name="line-1380"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1381"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>args</span>
<a name="line-1382"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfProv</span> <span class='hs-varid'>p</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-1383"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1384"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-1385"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1386"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1387"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>arg</span>
<a name="line-1388"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c1</span><span class='hs-layout'>,</span> <span class='hs-varid'>c2</span><span class='hs-keyglyph'>]</span>
<a name="line-1389"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1390"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1391"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>cs</span>
<a name="line-1392"></a>
<a name="line-1393"></a><a name="coVarsOfProv"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-1394"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1395"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1396"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1397"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1398"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1399"></a>
<a name="line-1400"></a><a name="coVarsOfCos"></a><span class='hs-definition'>coVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-1401"></a><span class='hs-definition'>coVarsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>cos</span>
<a name="line-1402"></a>
<a name="line-1403"></a><a name="closeOverKinds"></a><span class='hs-comment'>-- | Add the kind variables free in the kinds of the tyvars in the given set.</span>
<a name="line-1404"></a><span class='hs-comment'>-- Returns a non-deterministic set.</span>
<a name="line-1405"></a><span class='hs-definition'>closeOverKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-1406"></a><span class='hs-definition'>closeOverKinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>closeOverKindsFV</span> <span class='hs-varop'>.</span> <span class='hs-varid'>varSetElems</span>
<a name="line-1407"></a>
<a name="line-1408"></a><a name="closeOverKindsFV"></a><span class='hs-comment'>-- | Given a list of tyvars returns a deterministic FV computation that</span>
<a name="line-1409"></a><span class='hs-comment'>-- returns the given tyvars with the kind variables free in the kinds of the</span>
<a name="line-1410"></a><span class='hs-comment'>-- given tyvars.</span>
<a name="line-1411"></a><span class='hs-definition'>closeOverKindsFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1412"></a><span class='hs-definition'>closeOverKindsFV</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span>
<a name="line-1413"></a>  <span class='hs-varid'>mapUnionFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>mkFVs</span> <span class='hs-varid'>tvs</span>
<a name="line-1414"></a>
<a name="line-1415"></a><a name="closeOverKindsList"></a><span class='hs-comment'>-- | Add the kind variables free in the kinds of the tyvars in the given set.</span>
<a name="line-1416"></a><span class='hs-comment'>-- Returns a deterministically ordered list.</span>
<a name="line-1417"></a><span class='hs-definition'>closeOverKindsList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1418"></a><span class='hs-definition'>closeOverKindsList</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>closeOverKindsFV</span> <span class='hs-varid'>tvs</span>
<a name="line-1419"></a>
<a name="line-1420"></a><a name="closeOverKindsDSet"></a><span class='hs-comment'>-- | Add the kind variables free in the kinds of the tyvars in the given set.</span>
<a name="line-1421"></a><span class='hs-comment'>-- Returns a deterministic set.</span>
<a name="line-1422"></a><span class='hs-definition'>closeOverKindsDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyVarSet</span>
<a name="line-1423"></a><span class='hs-definition'>closeOverKindsDSet</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>closeOverKindsFV</span> <span class='hs-varop'>.</span> <span class='hs-varid'>dVarSetElems</span>
<a name="line-1424"></a>
<a name="line-1425"></a><a name="tyCoVarsOfTelescope"></a><span class='hs-comment'>-- | Gets the free vars of a telescope, scoped over a given free var set.</span>
<a name="line-1426"></a><span class='hs-definition'>tyCoVarsOfTelescope</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1427"></a><span class='hs-definition'>tyCoVarsOfTelescope</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs</span>
<a name="line-1428"></a><span class='hs-definition'>tyCoVarsOfTelescope</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTelescope</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>fvs</span>
<a name="line-1429"></a>                                 <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>v</span>
<a name="line-1430"></a>                                 <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1431"></a>
<a name="line-1432"></a><span class='hs-comment'>{-
<a name="line-1433"></a>%************************************************************************
<a name="line-1434"></a>%*                                                                      *
<a name="line-1435"></a>                        TyThing
<a name="line-1436"></a>%*                                                                      *
<a name="line-1437"></a>%************************************************************************
<a name="line-1438"></a>
<a name="line-1439"></a>Despite the fact that DataCon has to be imported via a hi-boot route,
<a name="line-1440"></a>this module seems the right place for TyThing, because it's needed for
<a name="line-1441"></a>funTyCon and all the types in TysPrim.
<a name="line-1442"></a>
<a name="line-1443"></a>Note [ATyCon for classes]
<a name="line-1444"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1445"></a>Both classes and type constructors are represented in the type environment
<a name="line-1446"></a>as ATyCon.  You can tell the difference, and get to the class, with
<a name="line-1447"></a>   isClassTyCon :: TyCon -&gt; Bool
<a name="line-1448"></a>   tyConClass_maybe :: TyCon -&gt; Maybe Class
<a name="line-1449"></a>The Class and its associated TyCon have the same Name.
<a name="line-1450"></a>-}</span>
<a name="line-1451"></a>
<a name="line-1452"></a><a name="TyThing"></a><span class='hs-comment'>-- | A global typecheckable-thing, essentially anything that has a name.</span>
<a name="line-1453"></a><a name="TyThing"></a><span class='hs-comment'>-- Not to be confused with a 'TcTyThing', which is also a typecheckable</span>
<a name="line-1454"></a><a name="TyThing"></a><span class='hs-comment'>-- thing but in the *local* context.  See 'TcEnv' for how to retrieve</span>
<a name="line-1455"></a><a name="TyThing"></a><span class='hs-comment'>-- a 'TyThing' given a 'Name'.</span>
<a name="line-1456"></a><a name="TyThing"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyThing</span>
<a name="line-1457"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnId</span>     <span class='hs-conid'>Id</span>
<a name="line-1458"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AConLike</span> <span class='hs-conid'>ConLike</span>
<a name="line-1459"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyCon</span>   <span class='hs-conid'>TyCon</span>       <span class='hs-comment'>-- TyCons and classes; see Note [ATyCon for classes]</span>
<a name="line-1460"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ACoAxiom</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span><span class='hs-layout'>)</span>
<a name="line-1461"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>)</span>
<a name="line-1462"></a>
<a name="line-1463"></a><a name="instance%20Outputable%20TyThing"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyword'>where</span>
<a name="line-1464"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyThing</span>
<a name="line-1465"></a>
<a name="line-1466"></a><a name="pprTyThing"></a><span class='hs-definition'>pprTyThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1467"></a><span class='hs-definition'>pprTyThing</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyThingCategory</span> <span class='hs-varid'>thing</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1468"></a>
<a name="line-1469"></a><a name="pprTyThingCategory"></a><span class='hs-definition'>pprTyThingCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1470"></a><span class='hs-definition'>pprTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1471"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isClassTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Class"</span>
<a name="line-1472"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type constructor"</span>
<a name="line-1473"></a><span class='hs-definition'>pprTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ACoAxiom</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Coercion axiom"</span>
<a name="line-1474"></a><span class='hs-definition'>pprTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span>   <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Identifier"</span>
<a name="line-1475"></a><span class='hs-definition'>pprTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Data constructor"</span>
<a name="line-1476"></a><span class='hs-definition'>pprTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Pattern synonym"</span>
<a name="line-1477"></a>
<a name="line-1478"></a>
<a name="line-1479"></a><a name="instance%20NamedThing%20TyThing"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NamedThing</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyword'>where</span>       <span class='hs-comment'>-- Can't put this with the type</span>
<a name="line-1480"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>id</span>    <span class='hs-comment'>-- decl, because the DataCon instance</span>
<a name="line-1481"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tc</span>    <span class='hs-comment'>-- isn't visible there</span>
<a name="line-1482"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ACoAxiom</span> <span class='hs-varid'>cc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>cc</span>
<a name="line-1483"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-varid'>cl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>cl</span>
<a name="line-1484"></a>
<a name="line-1485"></a><span class='hs-comment'>{-
<a name="line-1486"></a>%************************************************************************
<a name="line-1487"></a>%*                                                                      *
<a name="line-1488"></a>                        Substitutions
<a name="line-1489"></a>      Data type defined here to avoid unnecessary mutual recursion
<a name="line-1490"></a>%*                                                                      *
<a name="line-1491"></a>%************************************************************************
<a name="line-1492"></a>-}</span>
<a name="line-1493"></a>
<a name="line-1494"></a><a name="TCvSubst"></a><span class='hs-comment'>-- | Type &amp; coercion substitution</span>
<a name="line-1495"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-1496"></a><a name="TCvSubst"></a><span class='hs-comment'>-- #tcvsubst_invariant#</span>
<a name="line-1497"></a><a name="TCvSubst"></a><span class='hs-comment'>-- The following invariants must hold of a 'TCvSubst':</span>
<a name="line-1498"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-1499"></a><a name="TCvSubst"></a><span class='hs-comment'>-- 1. The in-scope set is needed /only/ to</span>
<a name="line-1500"></a><a name="TCvSubst"></a><span class='hs-comment'>-- guide the generation of fresh uniques</span>
<a name="line-1501"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-1502"></a><a name="TCvSubst"></a><span class='hs-comment'>-- 2. In particular, the /kind/ of the type variables in</span>
<a name="line-1503"></a><a name="TCvSubst"></a><span class='hs-comment'>-- the in-scope set is not relevant</span>
<a name="line-1504"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-1505"></a><a name="TCvSubst"></a><span class='hs-comment'>-- 3. The substitution is only applied ONCE! This is because</span>
<a name="line-1506"></a><a name="TCvSubst"></a><span class='hs-comment'>-- in general such application will not reach a fixed point.</span>
<a name="line-1507"></a><a name="TCvSubst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1508"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-comment'>-- The in-scope type and kind variables</span>
<a name="line-1509"></a>             <span class='hs-conid'>TvSubstEnv</span> <span class='hs-comment'>-- Substitutes both type and kind variables</span>
<a name="line-1510"></a>             <span class='hs-conid'>CvSubstEnv</span> <span class='hs-comment'>-- Substitutes coercion variables</span>
<a name="line-1511"></a>        <span class='hs-comment'>-- See Note [Apply Once]</span>
<a name="line-1512"></a>        <span class='hs-comment'>-- and Note [Extending the TvSubstEnv]</span>
<a name="line-1513"></a>        <span class='hs-comment'>-- and Note [Substituting types and coercions]</span>
<a name="line-1514"></a>        <span class='hs-comment'>-- and Note [The substitution invariant]</span>
<a name="line-1515"></a>
<a name="line-1516"></a><a name="TvSubstEnv"></a><span class='hs-comment'>-- | A substitution of 'Type's for 'TyVar's</span>
<a name="line-1517"></a><a name="TvSubstEnv"></a><span class='hs-comment'>--                 and 'Kind's for 'KindVar's</span>
<a name="line-1518"></a><a name="TvSubstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>Type</span>
<a name="line-1519"></a>        <span class='hs-comment'>-- A TvSubstEnv is used both inside a TCvSubst (with the apply-once</span>
<a name="line-1520"></a>        <span class='hs-comment'>-- invariant discussed in Note [Apply Once]), and also independently</span>
<a name="line-1521"></a>        <span class='hs-comment'>-- in the middle of matching, and unification (see Types.Unify)</span>
<a name="line-1522"></a>        <span class='hs-comment'>-- So you have to look at the context to know if it's idempotent or</span>
<a name="line-1523"></a>        <span class='hs-comment'>-- apply-once or whatever</span>
<a name="line-1524"></a>
<a name="line-1525"></a><a name="CvSubstEnv"></a><span class='hs-comment'>-- | A substitution of 'Coercion's for 'CoVar's</span>
<a name="line-1526"></a><a name="CvSubstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoVarEnv</span> <span class='hs-conid'>Coercion</span>
<a name="line-1527"></a>
<a name="line-1528"></a><span class='hs-comment'>{-
<a name="line-1529"></a>Note [Apply Once]
<a name="line-1530"></a>~~~~~~~~~~~~~~~~~
<a name="line-1531"></a>We use TCvSubsts to instantiate things, and we might instantiate
<a name="line-1532"></a>        forall a b. ty
<a name="line-1533"></a>\with the types
<a name="line-1534"></a>        [a, b], or [b, a].
<a name="line-1535"></a>So the substitution might go [a-&gt;b, b-&gt;a].  A similar situation arises in Core
<a name="line-1536"></a>when we find a beta redex like
<a name="line-1537"></a>        (/\ a /\ b -&gt; e) b a
<a name="line-1538"></a>Then we also end up with a substitution that permutes type variables. Other
<a name="line-1539"></a>variations happen to; for example [a -&gt; (a, b)].
<a name="line-1540"></a>
<a name="line-1541"></a>        ****************************************************
<a name="line-1542"></a>        *** So a TCvSubst must be applied precisely once ***
<a name="line-1543"></a>        ****************************************************
<a name="line-1544"></a>
<a name="line-1545"></a>A TCvSubst is not idempotent, but, unlike the non-idempotent substitution
<a name="line-1546"></a>we use during unifications, it must not be repeatedly applied.
<a name="line-1547"></a>
<a name="line-1548"></a>Note [Extending the TvSubstEnv]
<a name="line-1549"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1550"></a>See #tcvsubst_invariant# for the invariants that must hold.
<a name="line-1551"></a>
<a name="line-1552"></a>This invariant allows a short-cut when the subst envs are empty:
<a name="line-1553"></a>if the TvSubstEnv and CvSubstEnv are empty --- i.e. (isEmptyTCvSubst subst)
<a name="line-1554"></a>holds --- then (substTy subst ty) does nothing.
<a name="line-1555"></a>
<a name="line-1556"></a>For example, consider:
<a name="line-1557"></a>        (/\a. /\b:(a~Int). ...b..) Int
<a name="line-1558"></a>We substitute Int for 'a'.  The Unique of 'b' does not change, but
<a name="line-1559"></a>nevertheless we add 'b' to the TvSubstEnv, because b's kind does change
<a name="line-1560"></a>
<a name="line-1561"></a>This invariant has several crucial consequences:
<a name="line-1562"></a>
<a name="line-1563"></a>* In substTyVarBndr, we need extend the TvSubstEnv
<a name="line-1564"></a>        - if the unique has changed
<a name="line-1565"></a>        - or if the kind has changed
<a name="line-1566"></a>
<a name="line-1567"></a>* In substTyVar, we do not need to consult the in-scope set;
<a name="line-1568"></a>  the TvSubstEnv is enough
<a name="line-1569"></a>
<a name="line-1570"></a>* In substTy, substTheta, we can short-circuit when the TvSubstEnv is empty
<a name="line-1571"></a>
<a name="line-1572"></a>Note [Substituting types and coercions]
<a name="line-1573"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1574"></a>Types and coercions are mutually recursive, and either may have variables
<a name="line-1575"></a>"belonging" to the other. Thus, every time we wish to substitute in a
<a name="line-1576"></a>type, we may also need to substitute in a coercion, and vice versa.
<a name="line-1577"></a>However, the constructor used to create type variables is distinct from
<a name="line-1578"></a>that of coercion variables, so we carry two VarEnvs in a TCvSubst. Note
<a name="line-1579"></a>that it would be possible to use the CoercionTy constructor to combine
<a name="line-1580"></a>these environments, but that seems like a false economy.
<a name="line-1581"></a>
<a name="line-1582"></a>Note that the TvSubstEnv should *never* map a CoVar (built with the Id
<a name="line-1583"></a>constructor) and the CvSubstEnv should *never* map a TyVar. Furthermore,
<a name="line-1584"></a>the range of the TvSubstEnv should *never* include a type headed with
<a name="line-1585"></a>CoercionTy.
<a name="line-1586"></a>
<a name="line-1587"></a>Note [The substitution invariant]
<a name="line-1588"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1589"></a>When calling (substTy subst ty) it should be the case that
<a name="line-1590"></a>the in-scope set in the substitution is a superset of both:
<a name="line-1591"></a>
<a name="line-1592"></a>  * The free vars of the range of the substitution
<a name="line-1593"></a>  * The free vars of ty minus the domain of the substitution
<a name="line-1594"></a>
<a name="line-1595"></a>If we want to substitute [a -&gt; ty1, b -&gt; ty2] I used to
<a name="line-1596"></a>think it was enough to generate an in-scope set that includes
<a name="line-1597"></a>fv(ty1,ty2).  But that's not enough; we really should also take the
<a name="line-1598"></a>free vars of the type we are substituting into!  Example:
<a name="line-1599"></a>     (forall b. (a,b,x)) [a -&gt; List b]
<a name="line-1600"></a>Then if we use the in-scope set {b}, there is a danger we will rename
<a name="line-1601"></a>the forall'd variable to 'x' by mistake, getting this:
<a name="line-1602"></a>     (forall x. (List b, x, x))
<a name="line-1603"></a>
<a name="line-1604"></a>Breaking this invariant caused the bug from #11371.
<a name="line-1605"></a>-}</span>
<a name="line-1606"></a>
<a name="line-1607"></a><a name="emptyTvSubstEnv"></a><span class='hs-definition'>emptyTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-1608"></a><span class='hs-definition'>emptyTvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1609"></a>
<a name="line-1610"></a><a name="emptyCvSubstEnv"></a><span class='hs-definition'>emptyCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-1611"></a><span class='hs-definition'>emptyCvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1612"></a>
<a name="line-1613"></a><a name="composeTCvSubstEnv"></a><span class='hs-definition'>composeTCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-1614"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span>
<a name="line-1615"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span>
<a name="line-1616"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span>
<a name="line-1617"></a><span class='hs-comment'>-- ^ @(compose env1 env2)(x)@ is @env1(env2(x))@; i.e. apply @env2@ then @env1@.</span>
<a name="line-1618"></a><span class='hs-comment'>-- It assumes that both are idempotent.</span>
<a name="line-1619"></a><span class='hs-comment'>-- Typically, @env1@ is the refinement to a base substitution @env2@</span>
<a name="line-1620"></a><span class='hs-definition'>composeTCvSubstEnv</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-1621"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tenv1</span> <span class='hs-varop'>`plusVarEnv`</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv2</span>
<a name="line-1622"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cenv1</span> <span class='hs-varop'>`plusVarEnv`</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv2</span> <span class='hs-layout'>)</span>
<a name="line-1623"></a>        <span class='hs-comment'>-- First apply env1 to the range of env2</span>
<a name="line-1624"></a>        <span class='hs-comment'>-- Then combine the two, making sure that env1 loses if</span>
<a name="line-1625"></a>        <span class='hs-comment'>-- both bind the same variable; that's why env1 is the</span>
<a name="line-1626"></a>        <span class='hs-comment'>--  *left* argument to plusVarEnv, because the right arg wins</span>
<a name="line-1627"></a>  <span class='hs-keyword'>where</span>
<a name="line-1628"></a>    <span class='hs-varid'>subst1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv1</span> <span class='hs-varid'>cenv1</span>
<a name="line-1629"></a>
<a name="line-1630"></a><a name="composeTCvSubst"></a><span class='hs-comment'>-- | Composes two substitutions, applying the second one provided first,</span>
<a name="line-1631"></a><span class='hs-comment'>-- like in function composition.</span>
<a name="line-1632"></a><span class='hs-definition'>composeTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1633"></a><span class='hs-definition'>composeTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is1</span> <span class='hs-varid'>tenv1</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is2</span> <span class='hs-varid'>tenv2</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-1634"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is3</span> <span class='hs-varid'>tenv3</span> <span class='hs-varid'>cenv3</span>
<a name="line-1635"></a>  <span class='hs-keyword'>where</span>
<a name="line-1636"></a>    <span class='hs-varid'>is3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is1</span> <span class='hs-varop'>`unionInScope`</span> <span class='hs-varid'>is2</span>
<a name="line-1637"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tenv3</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>composeTCvSubstEnv</span> <span class='hs-varid'>is3</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-1638"></a>
<a name="line-1639"></a><a name="emptyTCvSubst"></a><span class='hs-definition'>emptyTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1640"></a><span class='hs-definition'>emptyTCvSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-1641"></a>
<a name="line-1642"></a><a name="mkEmptyTCvSubst"></a><span class='hs-definition'>mkEmptyTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1643"></a><span class='hs-definition'>mkEmptyTCvSubst</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-1644"></a>
<a name="line-1645"></a><a name="isEmptyTCvSubst"></a><span class='hs-definition'>isEmptyTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1646"></a>         <span class='hs-comment'>-- See Note [Extending the TvSubstEnv]</span>
<a name="line-1647"></a><span class='hs-definition'>isEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>cenv</span>
<a name="line-1648"></a>
<a name="line-1649"></a><a name="mkTCvSubst"></a><span class='hs-definition'>mkTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1650"></a><span class='hs-definition'>mkTCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1651"></a>
<a name="line-1652"></a><a name="mkTvSubst"></a><span class='hs-definition'>mkTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1653"></a><span class='hs-comment'>-- ^ Mkae a TCvSubst with specified tyvar subst and empty covar subst</span>
<a name="line-1654"></a><span class='hs-definition'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-1655"></a>
<a name="line-1656"></a><a name="getTvSubstEnv"></a><span class='hs-definition'>getTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-1657"></a><span class='hs-definition'>getTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-1658"></a>
<a name="line-1659"></a><a name="getCvSubstEnv"></a><span class='hs-definition'>getCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-1660"></a><span class='hs-definition'>getCvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-1661"></a>
<a name="line-1662"></a><a name="getTCvInScope"></a><span class='hs-definition'>getTCvInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-1663"></a><span class='hs-definition'>getTCvInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_scope</span>
<a name="line-1664"></a>
<a name="line-1665"></a><a name="getTCvSubstRangeFVs"></a><span class='hs-comment'>-- | Returns the free variables of the types in the range of a substitution as</span>
<a name="line-1666"></a><span class='hs-comment'>-- a non-deterministic set.</span>
<a name="line-1667"></a><span class='hs-definition'>getTCvSubstRangeFVs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-1668"></a><span class='hs-definition'>getTCvSubstRangeFVs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-1669"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionVarSet</span> <span class='hs-varid'>tenvFVs</span> <span class='hs-varid'>cenvFVs</span>
<a name="line-1670"></a>  <span class='hs-keyword'>where</span>
<a name="line-1671"></a>    <span class='hs-varid'>tenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>tenv</span>
<a name="line-1672"></a>    <span class='hs-varid'>cenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCos</span>   <span class='hs-varop'>$</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>cenv</span>
<a name="line-1673"></a>
<a name="line-1674"></a><a name="isInScope"></a><span class='hs-definition'>isInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1675"></a><span class='hs-definition'>isInScope</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemInScopeSet`</span> <span class='hs-varid'>in_scope</span>
<a name="line-1676"></a>
<a name="line-1677"></a><a name="notElemTCvSubst"></a><span class='hs-definition'>notElemTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1678"></a><span class='hs-definition'>notElemTCvSubst</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-1679"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span>
<a name="line-1680"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span>
<a name="line-1681"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1682"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-1683"></a>
<a name="line-1684"></a><a name="setTvSubstEnv"></a><span class='hs-definition'>setTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1685"></a><span class='hs-definition'>setTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1686"></a>
<a name="line-1687"></a><a name="setCvSubstEnv"></a><span class='hs-definition'>setCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1688"></a><span class='hs-definition'>setCvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1689"></a>
<a name="line-1690"></a><a name="zapTCvSubst"></a><span class='hs-definition'>zapTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1691"></a><span class='hs-definition'>zapTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1692"></a>
<a name="line-1693"></a><a name="extendTCvInScope"></a><span class='hs-definition'>extendTCvInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1694"></a><span class='hs-definition'>extendTCvInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>var</span>
<a name="line-1695"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1696"></a>
<a name="line-1697"></a><a name="extendTCvInScopeList"></a><span class='hs-definition'>extendTCvInScopeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1698"></a><span class='hs-definition'>extendTCvInScopeList</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span>
<a name="line-1699"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetList</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1700"></a>
<a name="line-1701"></a><a name="extendTCvInScopeSet"></a><span class='hs-definition'>extendTCvInScopeSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1702"></a><span class='hs-definition'>extendTCvInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span>
<a name="line-1703"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1704"></a>
<a name="line-1705"></a><a name="extendTCvSubst"></a><span class='hs-definition'>extendTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1706"></a><span class='hs-definition'>extendTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span>
<a name="line-1707"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span>
<a name="line-1708"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span>
<a name="line-1709"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-1710"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span>
<a name="line-1711"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1712"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"extendTCvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"|-&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1713"></a>
<a name="line-1714"></a><a name="extendTvSubst"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1715"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1716"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span>
<a name="line-1717"></a>
<a name="line-1718"></a><a name="extendTvSubstWithClone"></a><span class='hs-definition'>extendTvSubstWithClone</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1719"></a><span class='hs-comment'>-- Adds a new tv -&gt; tv mapping, /and/ extends the in-scope set</span>
<a name="line-1720"></a><span class='hs-definition'>extendTvSubstWithClone</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>tv'</span>
<a name="line-1721"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>new_in_scope</span><span class='hs-layout'>)</span>
<a name="line-1722"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1723"></a>             <span class='hs-varid'>cenv</span>
<a name="line-1724"></a>  <span class='hs-keyword'>where</span>
<a name="line-1725"></a>    <span class='hs-varid'>new_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>tv'</span>
<a name="line-1726"></a>
<a name="line-1727"></a><a name="extendCvSubst"></a><span class='hs-definition'>extendCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1728"></a><span class='hs-definition'>extendCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span>
<a name="line-1729"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1730"></a>
<a name="line-1731"></a><a name="extendCvSubstWithClone"></a><span class='hs-definition'>extendCvSubstWithClone</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1732"></a><span class='hs-definition'>extendCvSubstWithClone</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>cv'</span>
<a name="line-1733"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>new_in_scope</span><span class='hs-layout'>)</span>
<a name="line-1734"></a>             <span class='hs-varid'>tenv</span>
<a name="line-1735"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>cv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1736"></a>  <span class='hs-keyword'>where</span>
<a name="line-1737"></a>    <span class='hs-varid'>new_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv'</span><span class='hs-layout'>)</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>cv'</span>
<a name="line-1738"></a>
<a name="line-1739"></a><a name="extendTvSubstAndInScope"></a><span class='hs-definition'>extendTvSubstAndInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1740"></a><span class='hs-comment'>-- Also extends the in-scope set</span>
<a name="line-1741"></a><span class='hs-definition'>extendTvSubstAndInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1742"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1743"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1744"></a>             <span class='hs-varid'>cenv</span>
<a name="line-1745"></a>
<a name="line-1746"></a><a name="extendTvSubstList"></a><span class='hs-definition'>extendTvSubstList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1747"></a><span class='hs-definition'>extendTvSubstList</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1748"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl2</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1749"></a>
<a name="line-1750"></a><a name="extendTvSubstBinder"></a><span class='hs-definition'>extendTvSubstBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1751"></a><span class='hs-definition'>extendTvSubstBinder</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-1752"></a><span class='hs-definition'>extendTvSubstBinder</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1753"></a>
<a name="line-1754"></a><a name="unionTCvSubst"></a><span class='hs-definition'>unionTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1755"></a><span class='hs-comment'>-- Works when the ranges are disjoint</span>
<a name="line-1756"></a><span class='hs-definition'>unionTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope1</span> <span class='hs-varid'>tenv1</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope2</span> <span class='hs-varid'>tenv2</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-1757"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span> <span class='hs-varop'>`intersectsVarEnv`</span> <span class='hs-varid'>tenv2</span><span class='hs-layout'>)</span>
<a name="line-1758"></a>         <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>cenv1</span> <span class='hs-varop'>`intersectsVarEnv`</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1759"></a>    <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope1</span> <span class='hs-varop'>`unionInScope`</span> <span class='hs-varid'>in_scope2</span><span class='hs-layout'>)</span>
<a name="line-1760"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span>     <span class='hs-varop'>`plusVarEnv`</span>   <span class='hs-varid'>tenv2</span><span class='hs-layout'>)</span>
<a name="line-1761"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>cenv1</span>     <span class='hs-varop'>`plusVarEnv`</span>   <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-1762"></a>
<a name="line-1763"></a><span class='hs-comment'>-- mkTvSubstPrs and zipTvSubst generate the in-scope set from</span>
<a name="line-1764"></a><span class='hs-comment'>-- the types given; but it's just a thunk so with a bit of luck</span>
<a name="line-1765"></a><span class='hs-comment'>-- it'll never be evaluated</span>
<a name="line-1766"></a>
<a name="line-1767"></a><a name="mkTyCoInScopeSet"></a><span class='hs-comment'>-- | Generates an in-scope set from the free variables in a list of types</span>
<a name="line-1768"></a><span class='hs-comment'>-- and a list of coercions</span>
<a name="line-1769"></a><span class='hs-definition'>mkTyCoInScopeSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-1770"></a><span class='hs-definition'>mkTyCoInScopeSet</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-1771"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1772"></a>
<a name="line-1773"></a><a name="zipTvSubst"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TCvSubst' from the types in the incoming</span>
<a name="line-1774"></a><span class='hs-comment'>-- environment. No CoVars, please!</span>
<a name="line-1775"></a><span class='hs-definition'>zipTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1776"></a><span class='hs-definition'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1777"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span>
<a name="line-1778"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-1779"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"zipTvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTCvSubst</span>
<a name="line-1780"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1781"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span>
<a name="line-1782"></a>  <span class='hs-keyword'>where</span>
<a name="line-1783"></a>    <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTyEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1784"></a>
<a name="line-1785"></a><a name="zipCvSubst"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TCvSubst' from the types in the incoming</span>
<a name="line-1786"></a><span class='hs-comment'>-- environment.  No TyVars, please!</span>
<a name="line-1787"></a><span class='hs-definition'>zipCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1788"></a><span class='hs-definition'>zipCvSubst</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span>
<a name="line-1789"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span>
<a name="line-1790"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cvs</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos</span>
<a name="line-1791"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"zipCvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTCvSubst</span>
<a name="line-1792"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1793"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>cenv</span>
<a name="line-1794"></a>  <span class='hs-keyword'>where</span>
<a name="line-1795"></a>    <span class='hs-varid'>cenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipCoEnv</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span>
<a name="line-1796"></a>
<a name="line-1797"></a><a name="zipTyBinderSubst"></a><span class='hs-comment'>-- | Create a TCvSubst combining the binders and types provided.</span>
<a name="line-1798"></a><span class='hs-comment'>-- NB: It is specifically OK if the lists are of different lengths.</span>
<a name="line-1799"></a><span class='hs-definition'>zipTyBinderSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1800"></a><span class='hs-definition'>zipTyBinderSubst</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>tys</span>
<a name="line-1801"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tenv</span>
<a name="line-1802"></a>  <span class='hs-keyword'>where</span>
<a name="line-1803"></a>    <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1804"></a>    <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>]</span>
<a name="line-1805"></a>
<a name="line-1806"></a><a name="mkTvSubstPrs"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TCvSubst' from the types in the</span>
<a name="line-1807"></a><span class='hs-comment'>-- incoming environment. No CoVars, please!</span>
<a name="line-1808"></a><span class='hs-definition'>mkTvSubstPrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1809"></a><span class='hs-definition'>mkTvSubstPrs</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span>
<a name="line-1810"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>onlyTyVarsAndNoCoercionTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"prs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prs</span> <span class='hs-layout'>)</span>
<a name="line-1811"></a>    <span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span>
<a name="line-1812"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>prs</span>
<a name="line-1813"></a>        <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>prs</span>
<a name="line-1814"></a>        <span class='hs-varid'>onlyTyVarsAndNoCoercionTy</span> <span class='hs-keyglyph'>=</span>
<a name="line-1815"></a>          <span class='hs-varid'>and</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCoercionTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1816"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>]</span>
<a name="line-1817"></a>
<a name="line-1818"></a><a name="zipTyEnv"></a><span class='hs-definition'>zipTyEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-1819"></a><span class='hs-definition'>zipTyEnv</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span>
<a name="line-1820"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isCoercionTy</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1821"></a>    <span class='hs-varid'>mkVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"zipTyEnv"</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1822"></a>        <span class='hs-comment'>-- There used to be a special case for when</span>
<a name="line-1823"></a>        <span class='hs-comment'>--      ty == TyVarTy tv</span>
<a name="line-1824"></a>        <span class='hs-comment'>-- (a not-uncommon case) in which case the substitution was dropped.</span>
<a name="line-1825"></a>        <span class='hs-comment'>-- But the type-tidier changes the print-name of a type variable without</span>
<a name="line-1826"></a>        <span class='hs-comment'>-- changing the unique, and that led to a bug.   Why?  Pre-tidying, we had</span>
<a name="line-1827"></a>        <span class='hs-comment'>-- a type {Foo t}, where Foo is a one-method class.  So Foo is really a newtype.</span>
<a name="line-1828"></a>        <span class='hs-comment'>-- And it happened that t was the type variable of the class.  Post-tiding,</span>
<a name="line-1829"></a>        <span class='hs-comment'>-- it got turned into {Foo t2}.  The ext-core printer expanded this using</span>
<a name="line-1830"></a>        <span class='hs-comment'>-- sourceTypeRep, but that said "Oh, t == t2" because they have the same unique,</span>
<a name="line-1831"></a>        <span class='hs-comment'>-- and so generated a rep type mentioning t not t2.</span>
<a name="line-1832"></a>        <span class='hs-comment'>--</span>
<a name="line-1833"></a>        <span class='hs-comment'>-- Simplest fix is to nuke the "optimisation"</span>
<a name="line-1834"></a>
<a name="line-1835"></a><a name="zipCoEnv"></a><span class='hs-definition'>zipCoEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-1836"></a><span class='hs-definition'>zipCoEnv</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"zipCoEnv"</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1837"></a>
<a name="line-1838"></a><a name="instance%20Outputable%20TCvSubst"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>where</span>
<a name="line-1839"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>ins</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-1840"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span><span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TCvSubst"</span><span class='hs-layout'>,</span>
<a name="line-1841"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In scope:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1842"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Type env:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1843"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Co env:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1844"></a>
<a name="line-1845"></a><span class='hs-comment'>{-
<a name="line-1846"></a>%************************************************************************
<a name="line-1847"></a>%*                                                                      *
<a name="line-1848"></a>                Performing type or kind substitutions
<a name="line-1849"></a>%*                                                                      *
<a name="line-1850"></a>%************************************************************************
<a name="line-1851"></a>
<a name="line-1852"></a>Note [Sym and ForAllCo]
<a name="line-1853"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1854"></a>In OptCoercion, we try to push "sym" out to the leaves of a coercion. But,
<a name="line-1855"></a>how do we push sym into a ForAllCo? It's a little ugly.
<a name="line-1856"></a>
<a name="line-1857"></a>Here is the typing rule:
<a name="line-1858"></a>
<a name="line-1859"></a>h : k1 ~# k2
<a name="line-1860"></a>(tv : k1) |- g : ty1 ~# ty2
<a name="line-1861"></a>----------------------------
<a name="line-1862"></a>ForAllCo tv h g : (ForAllTy (tv : k1) ty1) ~#
<a name="line-1863"></a>                  (ForAllTy (tv : k2) (ty2[tv |-&gt; tv |&gt; sym h]))
<a name="line-1864"></a>
<a name="line-1865"></a>Here is what we want:
<a name="line-1866"></a>
<a name="line-1867"></a>ForAllCo tv h' g' : (ForAllTy (tv : k2) (ty2[tv |-&gt; tv |&gt; sym h])) ~#
<a name="line-1868"></a>                    (ForAllTy (tv : k1) ty1)
<a name="line-1869"></a>
<a name="line-1870"></a>
<a name="line-1871"></a>Because the kinds of the type variables to the right of the colon are the kinds
<a name="line-1872"></a>coerced by h', we know (h' : k2 ~# k1). Thus, (h' = sym h).
<a name="line-1873"></a>
<a name="line-1874"></a>Now, we can rewrite ty1 to be (ty1[tv |-&gt; tv |&gt; sym h' |&gt; h']). We thus want
<a name="line-1875"></a>
<a name="line-1876"></a>ForAllCo tv h' g' :
<a name="line-1877"></a>  (ForAllTy (tv : k2) (ty2[tv |-&gt; tv |&gt; h'])) ~#
<a name="line-1878"></a>  (ForAllTy (tv : k1) (ty1[tv |-&gt; tv |&gt; h'][tv |-&gt; tv |&gt; sym h']))
<a name="line-1879"></a>
<a name="line-1880"></a>We thus see that we want
<a name="line-1881"></a>
<a name="line-1882"></a>g' : ty2[tv |-&gt; tv |&gt; h'] ~# ty1[tv |-&gt; tv |&gt; h']
<a name="line-1883"></a>
<a name="line-1884"></a>and thus g' = sym (g[tv |-&gt; tv |&gt; h']).
<a name="line-1885"></a>
<a name="line-1886"></a>Putting it all together, we get this:
<a name="line-1887"></a>
<a name="line-1888"></a>sym (ForAllCo tv h g)
<a name="line-1889"></a>==&gt;
<a name="line-1890"></a>ForAllCo tv (sym h) (sym g[tv |-&gt; tv |&gt; sym h])
<a name="line-1891"></a>
<a name="line-1892"></a>-}</span>
<a name="line-1893"></a>
<a name="line-1894"></a><a name="substTyWith"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'</span>
<a name="line-1895"></a><span class='hs-definition'>substTyWith</span> <span class='hs-keyglyph'>::</span>
<a name="line-1896"></a><span class='hs-comment'>-- CallStack wasn't present in GHC 7.10.1, disable callstacks in stage 1</span>
<a name="line-1897"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-1898"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>?</span><span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-1899"></a><span class='hs-cpp'>#endif</span>
<a name="line-1900"></a>    <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1901"></a><span class='hs-comment'>-- Works only if the domain of the substitution is a</span>
<a name="line-1902"></a><span class='hs-comment'>-- superset of the type being substituted into</span>
<a name="line-1903"></a><span class='hs-definition'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1904"></a>                      <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1905"></a>
<a name="line-1906"></a><a name="substTyWithUnchecked"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'. Disables sanity checks.</span>
<a name="line-1907"></a><span class='hs-comment'>-- The problems that the sanity checks in substTy catch are described in</span>
<a name="line-1908"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-1909"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTyUnchecked to</span>
<a name="line-1910"></a><span class='hs-comment'>-- substTy and remove this function. Please don't use in new code.</span>
<a name="line-1911"></a><span class='hs-definition'>substTyWithUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1912"></a><span class='hs-definition'>substTyWithUnchecked</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1913"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1914"></a>    <span class='hs-varid'>substTyUnchecked</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1915"></a>
<a name="line-1916"></a><a name="substTyWithInScope"></a><span class='hs-comment'>-- | Substitute tyvars within a type using a known 'InScopeSet'.</span>
<a name="line-1917"></a><span class='hs-comment'>-- Pre-condition: the 'in_scope' set should satisfy Note [The substitution</span>
<a name="line-1918"></a><span class='hs-comment'>-- invariant]; specifically it should include the free vars of 'tys',</span>
<a name="line-1919"></a><span class='hs-comment'>-- and of 'ty' minus the domain of the subst.</span>
<a name="line-1920"></a><span class='hs-definition'>substTyWithInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1921"></a><span class='hs-definition'>substTyWithInScope</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-1922"></a>  <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1923"></a>  <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1924"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTyEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1925"></a>
<a name="line-1926"></a><a name="substCoWith"></a><span class='hs-comment'>-- | Coercion substitution, see 'zipTvSubst'</span>
<a name="line-1927"></a><span class='hs-definition'>substCoWith</span> <span class='hs-keyglyph'>::</span>
<a name="line-1928"></a><span class='hs-comment'>-- CallStack wasn't present in GHC 7.10.1, disable callstacks in stage 1</span>
<a name="line-1929"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-1930"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>?</span><span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-1931"></a><span class='hs-cpp'>#endif</span>
<a name="line-1932"></a>    <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1933"></a><span class='hs-definition'>substCoWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1934"></a>                      <span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1935"></a>
<a name="line-1936"></a><a name="substCoWithUnchecked"></a><span class='hs-comment'>-- | Coercion substitution, see 'zipTvSubst'. Disables sanity checks.</span>
<a name="line-1937"></a><span class='hs-comment'>-- The problems that the sanity checks in substCo catch are described in</span>
<a name="line-1938"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-1939"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substCoUnchecked to</span>
<a name="line-1940"></a><span class='hs-comment'>-- substCo and remove this function. Please don't use in new code.</span>
<a name="line-1941"></a><span class='hs-definition'>substCoWithUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1942"></a><span class='hs-definition'>substCoWithUnchecked</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1943"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1944"></a>    <span class='hs-varid'>substCoUnchecked</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1945"></a>
<a name="line-1946"></a>
<a name="line-1947"></a>
<a name="line-1948"></a><a name="substTyWithCoVars"></a><span class='hs-comment'>-- | Substitute covars within a type</span>
<a name="line-1949"></a><span class='hs-definition'>substTyWithCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1950"></a><span class='hs-definition'>substTyWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipCvSubst</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1951"></a>
<a name="line-1952"></a><a name="substTysWith"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'</span>
<a name="line-1953"></a><span class='hs-definition'>substTysWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1954"></a><span class='hs-definition'>substTysWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1955"></a>                       <span class='hs-varid'>substTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1956"></a>
<a name="line-1957"></a><a name="substTysWithCoVars"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'</span>
<a name="line-1958"></a><span class='hs-definition'>substTysWithCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1959"></a><span class='hs-definition'>substTysWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>)</span>
<a name="line-1960"></a>                             <span class='hs-varid'>substTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipCvSubst</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1961"></a>
<a name="line-1962"></a><a name="substTyWithBinders"></a><span class='hs-comment'>-- | Type substitution using 'Binder's. Anonymous binders</span>
<a name="line-1963"></a><span class='hs-comment'>-- simply ignore their matching type.</span>
<a name="line-1964"></a><span class='hs-definition'>substTyWithBinders</span> <span class='hs-keyglyph'>::</span>
<a name="line-1965"></a><span class='hs-comment'>-- CallStack wasn't present in GHC 7.10.1, disable callstacks in stage 1</span>
<a name="line-1966"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-1967"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>?</span><span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-1968"></a><span class='hs-cpp'>#endif</span>
<a name="line-1969"></a>    <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1970"></a><span class='hs-definition'>substTyWithBinders</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1971"></a>                               <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTyBinderSubst</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1972"></a>
<a name="line-1973"></a><a name="substTyWithBindersUnchecked"></a><span class='hs-comment'>-- | Type substitution using 'Binder's disabling the sanity checks.</span>
<a name="line-1974"></a><span class='hs-comment'>-- Anonymous binders simply ignore their matching type.</span>
<a name="line-1975"></a><span class='hs-comment'>-- The problems that the sanity checks in substTy catch are described in</span>
<a name="line-1976"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-1977"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTyUnchecked to</span>
<a name="line-1978"></a><span class='hs-comment'>-- substTy and remove this function. Please don't use in new code.</span>
<a name="line-1979"></a><span class='hs-definition'>substTyWithBindersUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1980"></a><span class='hs-definition'>substTyWithBindersUnchecked</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>tys</span>
<a name="line-1981"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1982"></a>    <span class='hs-varid'>substTyUnchecked</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTyBinderSubst</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1983"></a>
<a name="line-1984"></a><a name="substTyAddInScope"></a><span class='hs-comment'>-- | Substitute within a 'Type' after adding the free variables of the type</span>
<a name="line-1985"></a><span class='hs-comment'>-- to the in-scope set. This is useful for the case when the free variables</span>
<a name="line-1986"></a><span class='hs-comment'>-- aren't already in the in-scope set or easily available.</span>
<a name="line-1987"></a><span class='hs-comment'>-- See also Note [The substitution invariant].</span>
<a name="line-1988"></a><span class='hs-definition'>substTyAddInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1989"></a><span class='hs-definition'>substTyAddInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-1990"></a>  <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvInScopeSet</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1991"></a>
<a name="line-1992"></a><a name="isValidTCvSubst"></a><span class='hs-comment'>-- | When calling `substTy` it should be the case that the in-scope set in</span>
<a name="line-1993"></a><span class='hs-comment'>-- the substitution is a superset of the free vars of the range of the</span>
<a name="line-1994"></a><span class='hs-comment'>-- substitution.</span>
<a name="line-1995"></a><span class='hs-comment'>-- See also Note [The substitution invariant].</span>
<a name="line-1996"></a><span class='hs-definition'>isValidTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1997"></a><span class='hs-definition'>isValidTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1998"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>tenvFVs</span> <span class='hs-varop'>`varSetInScope`</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-1999"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>cenvFVs</span> <span class='hs-varop'>`varSetInScope`</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span>
<a name="line-2000"></a>  <span class='hs-keyword'>where</span>
<a name="line-2001"></a>  <span class='hs-varid'>tenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>tenv</span>
<a name="line-2002"></a>  <span class='hs-varid'>cenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varop'>$</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>cenv</span>
<a name="line-2003"></a>
<a name="line-2004"></a><a name="checkValidSubst"></a><span class='hs-comment'>-- | This checks if the substitution satisfies the invariant from</span>
<a name="line-2005"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2006"></a><span class='hs-definition'>checkValidSubst</span> <span class='hs-keyglyph'>::</span>
<a name="line-2007"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-2008"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>?</span><span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-2009"></a><span class='hs-cpp'>#endif</span>
<a name="line-2010"></a>    <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-2011"></a><span class='hs-definition'>checkValidSubst</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>a</span>
<a name="line-2012"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isValidTCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>,</span>
<a name="line-2013"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"in_scope"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$$</span>
<a name="line-2014"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>$$</span>
<a name="line-2015"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tenvFVs"</span>
<a name="line-2016"></a>               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-2017"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span> <span class='hs-varop'>$$</span>
<a name="line-2018"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cenvFVs"</span>
<a name="line-2019"></a>               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varop'>$</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-2020"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tys"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>$$</span>
<a name="line-2021"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cos"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>)</span>
<a name="line-2022"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tysCosFVsInScope</span><span class='hs-layout'>,</span>
<a name="line-2023"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"in_scope"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$$</span>
<a name="line-2024"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>$$</span>
<a name="line-2025"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span> <span class='hs-varop'>$$</span>
<a name="line-2026"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tys"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>$$</span>
<a name="line-2027"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cos"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>$$</span>
<a name="line-2028"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"needInScope"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>needInScope</span> <span class='hs-layout'>)</span>
<a name="line-2029"></a>    <span class='hs-varid'>a</span>
<a name="line-2030"></a>  <span class='hs-keyword'>where</span>
<a name="line-2031"></a>  <span class='hs-varid'>substDomain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varEnvKeys</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>++</span> <span class='hs-varid'>varEnvKeys</span> <span class='hs-varid'>cenv</span>
<a name="line-2032"></a>  <span class='hs-varid'>needInScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2033"></a>                  <span class='hs-varop'>`delListFromUFM_Directly`</span> <span class='hs-varid'>substDomain</span>
<a name="line-2034"></a>  <span class='hs-varid'>tysCosFVsInScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needInScope</span> <span class='hs-varop'>`varSetInScope`</span> <span class='hs-varid'>in_scope</span>
<a name="line-2035"></a>
<a name="line-2036"></a>
<a name="line-2037"></a><a name="substTy"></a><span class='hs-comment'>-- | Substitute within a 'Type'</span>
<a name="line-2038"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-2039"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2040"></a><span class='hs-definition'>substTy</span> <span class='hs-keyglyph'>::</span>
<a name="line-2041"></a><span class='hs-comment'>-- CallStack wasn't present in GHC 7.10.1, disable callstacks in stage 1</span>
<a name="line-2042"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-2043"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>?</span><span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-2044"></a><span class='hs-cpp'>#endif</span>
<a name="line-2045"></a>    <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2046"></a><span class='hs-definition'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-2047"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-2048"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-2049"></a>
<a name="line-2050"></a><a name="substTyUnchecked"></a><span class='hs-comment'>-- | Substitute within a 'Type' disabling the sanity checks.</span>
<a name="line-2051"></a><span class='hs-comment'>-- The problems that the sanity checks in substTy catch are described in</span>
<a name="line-2052"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2053"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTyUnchecked to</span>
<a name="line-2054"></a><span class='hs-comment'>-- substTy and remove this function. Please don't use in new code.</span>
<a name="line-2055"></a><span class='hs-definition'>substTyUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2056"></a><span class='hs-definition'>substTyUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-2057"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-2058"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-2059"></a>
<a name="line-2060"></a><a name="substTys"></a><span class='hs-comment'>-- | Substitute within several 'Type's</span>
<a name="line-2061"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-2062"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2063"></a><span class='hs-definition'>substTys</span> <span class='hs-keyglyph'>::</span>
<a name="line-2064"></a><span class='hs-comment'>-- CallStack wasn't present in GHC 7.10.1, disable callstacks in stage 1</span>
<a name="line-2065"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-2066"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>?</span><span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-2067"></a><span class='hs-cpp'>#endif</span>
<a name="line-2068"></a>    <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2069"></a><span class='hs-definition'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span>
<a name="line-2070"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-2071"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2072"></a>
<a name="line-2073"></a><a name="substTysUnchecked"></a><span class='hs-comment'>-- | Substitute within several 'Type's disabling the sanity checks.</span>
<a name="line-2074"></a><span class='hs-comment'>-- The problems that the sanity checks in substTys catch are described in</span>
<a name="line-2075"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2076"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTysUnchecked to</span>
<a name="line-2077"></a><span class='hs-comment'>-- substTys and remove this function. Please don't use in new code.</span>
<a name="line-2078"></a><span class='hs-definition'>substTysUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2079"></a><span class='hs-definition'>substTysUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span>
<a name="line-2080"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-2081"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2082"></a>
<a name="line-2083"></a><a name="substTheta"></a><span class='hs-comment'>-- | Substitute within a 'ThetaType'</span>
<a name="line-2084"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-2085"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2086"></a><span class='hs-definition'>substTheta</span> <span class='hs-keyglyph'>::</span>
<a name="line-2087"></a><span class='hs-comment'>-- CallStack wasn't present in GHC 7.10.1, disable callstacks in stage 1</span>
<a name="line-2088"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-2089"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>?</span><span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-2090"></a><span class='hs-cpp'>#endif</span>
<a name="line-2091"></a>    <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-2092"></a><span class='hs-definition'>substTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span>
<a name="line-2093"></a>
<a name="line-2094"></a><a name="substThetaUnchecked"></a><span class='hs-comment'>-- | Substitute within a 'ThetaType' disabling the sanity checks.</span>
<a name="line-2095"></a><span class='hs-comment'>-- The problems that the sanity checks in substTys catch are described in</span>
<a name="line-2096"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2097"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substThetaUnchecked to</span>
<a name="line-2098"></a><span class='hs-comment'>-- substTheta and remove this function. Please don't use in new code.</span>
<a name="line-2099"></a><span class='hs-definition'>substThetaUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-2100"></a><span class='hs-definition'>substThetaUnchecked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTysUnchecked</span>
<a name="line-2101"></a>
<a name="line-2102"></a>
<a name="line-2103"></a><a name="subst_ty"></a><span class='hs-definition'>subst_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2104"></a><span class='hs-comment'>-- subst_ty is the main workhorse for type substitution</span>
<a name="line-2105"></a><span class='hs-comment'>--</span>
<a name="line-2106"></a><span class='hs-comment'>-- Note that the in_scope set is poked only if we hit a forall</span>
<a name="line-2107"></a><span class='hs-comment'>-- so it may often never be fully computed</span>
<a name="line-2108"></a><span class='hs-definition'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-2109"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-2110"></a>  <span class='hs-keyword'>where</span>
<a name="line-2111"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-2112"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-2113"></a>                <span class='hs-comment'>-- The mkAppTy smart constructor is important</span>
<a name="line-2114"></a>                <span class='hs-comment'>-- we might be replacing (a Int), represented with App</span>
<a name="line-2115"></a>                <span class='hs-comment'>-- by [Int], represented with TyConApp</span>
<a name="line-2116"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-2117"></a>                           <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-2118"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-2119"></a>                         <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-2120"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2121"></a>                         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substTyVarBndrUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-2122"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2123"></a>                               <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span>
<a name="line-2124"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2125"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>n</span>
<a name="line-2126"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2127"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2128"></a>
<a name="line-2129"></a><a name="substTyVar"></a><span class='hs-definition'>substTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2130"></a><span class='hs-definition'>substTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-2131"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-2132"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-2133"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span>
<a name="line-2134"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span>
<a name="line-2135"></a>
<a name="line-2136"></a><a name="substTyVars"></a><span class='hs-definition'>substTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2137"></a><span class='hs-definition'>substTyVars</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varop'>$</span> <span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span>
<a name="line-2138"></a>
<a name="line-2139"></a><a name="lookupTyVar"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-2140"></a>        <span class='hs-comment'>-- See Note [Extending the TCvSubst]</span>
<a name="line-2141"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-2142"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-2143"></a>    <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span>
<a name="line-2144"></a>
<a name="line-2145"></a><a name="substCo"></a><span class='hs-comment'>-- | Substitute within a 'Coercion'</span>
<a name="line-2146"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-2147"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2148"></a><span class='hs-definition'>substCo</span> <span class='hs-keyglyph'>::</span>
<a name="line-2149"></a><span class='hs-comment'>-- CallStack wasn't present in GHC 7.10.1, disable callstacks in stage 1</span>
<a name="line-2150"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-2151"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>?</span><span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-2152"></a><span class='hs-cpp'>#endif</span>
<a name="line-2153"></a>    <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2154"></a><span class='hs-definition'>substCo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-2155"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-2156"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-2157"></a>
<a name="line-2158"></a><a name="substCoUnchecked"></a><span class='hs-comment'>-- | Substitute within a 'Coercion' disabling sanity checks.</span>
<a name="line-2159"></a><span class='hs-comment'>-- The problems that the sanity checks in substCo catch are described in</span>
<a name="line-2160"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2161"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substCoUnchecked to</span>
<a name="line-2162"></a><span class='hs-comment'>-- substCo and remove this function. Please don't use in new code.</span>
<a name="line-2163"></a><span class='hs-definition'>substCoUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2164"></a><span class='hs-definition'>substCoUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-2165"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-2166"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-2167"></a>
<a name="line-2168"></a><a name="substCos"></a><span class='hs-comment'>-- | Substitute within several 'Coercion's</span>
<a name="line-2169"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-2170"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2171"></a><span class='hs-definition'>substCos</span> <span class='hs-keyglyph'>::</span>
<a name="line-2172"></a><span class='hs-comment'>-- CallStack wasn't present in GHC 7.10.1, disable callstacks in stage 1</span>
<a name="line-2173"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-2174"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>?</span><span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-2175"></a><span class='hs-cpp'>#endif</span>
<a name="line-2176"></a>    <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-2177"></a><span class='hs-definition'>substCos</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cos</span>
<a name="line-2178"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cos</span>
<a name="line-2179"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-2180"></a>
<a name="line-2181"></a><a name="subst_co"></a><span class='hs-definition'>subst_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2182"></a><span class='hs-definition'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-2183"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2184"></a>  <span class='hs-keyword'>where</span>
<a name="line-2185"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2186"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span>
<a name="line-2187"></a>
<a name="line-2188"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2189"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty</span>
<a name="line-2190"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>args</span>
<a name="line-2191"></a>                               <span class='hs-keyword'>in</span>  <span class='hs-varid'>args'</span> <span class='hs-varop'>`seqList`</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args'</span>
<a name="line-2192"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-2193"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2194"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substForAllCoBndrUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind_co'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2195"></a>          <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>mkForAllCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>kind_co'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-2196"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span>
<a name="line-2197"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-2198"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>mkUnivCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span>
<a name="line-2199"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-2200"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2201"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTransCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-2202"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>d</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2203"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2204"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInstCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-2205"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoherenceCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-2206"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2207"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2208"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>c</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cs1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cs</span>
<a name="line-2209"></a>                                <span class='hs-keyword'>in</span> <span class='hs-varid'>cs1</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>c</span> <span class='hs-varid'>cs1</span>
<a name="line-2210"></a>
<a name="line-2211"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-conid'>UnsafeCoerceProv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnsafeCoerceProv</span>
<a name="line-2212"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span>
<a name="line-2213"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span>
<a name="line-2214"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-2215"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-2216"></a>      <span class='hs-comment'>-- NB: this last case is a little suspicious, but we need it. Originally,</span>
<a name="line-2217"></a>      <span class='hs-comment'>-- there was a panic here, but it triggered from deeplySkolemise. Because</span>
<a name="line-2218"></a>      <span class='hs-comment'>-- we only skolemise tyvars that are manually bound, this operation makes</span>
<a name="line-2219"></a>      <span class='hs-comment'>-- sense, even over a coercion with holes.</span>
<a name="line-2220"></a>
<a name="line-2221"></a><a name="substForAllCoBndr"></a><span class='hs-definition'>substForAllCoBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-2222"></a><span class='hs-definition'>substForAllCoBndr</span> <span class='hs-varid'>subst</span>
<a name="line-2223"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoBndrCallback</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-2224"></a>
<a name="line-2225"></a><a name="substForAllCoBndrUnchecked"></a><span class='hs-comment'>-- | Like 'substForAllCoBndr', but disables sanity checks.</span>
<a name="line-2226"></a><span class='hs-comment'>-- The problems that the sanity checks in substCo catch are described in</span>
<a name="line-2227"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2228"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substCoUnchecked to</span>
<a name="line-2229"></a><span class='hs-comment'>-- substCo and remove this function. Please don't use in new code.</span>
<a name="line-2230"></a><span class='hs-definition'>substForAllCoBndrUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-2231"></a><span class='hs-definition'>substForAllCoBndrUnchecked</span> <span class='hs-varid'>subst</span>
<a name="line-2232"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoBndrCallback</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCoUnchecked</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-2233"></a>
<a name="line-2234"></a><a name="substForAllCoBndrCallback"></a><span class='hs-comment'>-- See Note [Sym and ForAllCo]</span>
<a name="line-2235"></a><span class='hs-definition'>substForAllCoBndrCallback</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- apply sym to binder?</span>
<a name="line-2236"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- transformation to kind co</span>
<a name="line-2237"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2238"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-2239"></a><span class='hs-definition'>substForAllCoBndrCallback</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-2240"></a>                          <span class='hs-varid'>old_var</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-2241"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>cenv</span>
<a name="line-2242"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_kind_co</span> <span class='hs-layout'>)</span>
<a name="line-2243"></a>  <span class='hs-keyword'>where</span>
<a name="line-2244"></a>    <span class='hs-varid'>new_env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>sym</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span>
<a name="line-2245"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sym</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>$</span>
<a name="line-2246"></a>                            <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>`CastTy`</span> <span class='hs-varid'>new_kind_co</span>
<a name="line-2247"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-2248"></a>
<a name="line-2249"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>old_kind_co</span><span class='hs-layout'>)</span>
<a name="line-2250"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span>
<a name="line-2251"></a>
<a name="line-2252"></a>    <span class='hs-varid'>new_kind_co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-2253"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sco</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-2254"></a>
<a name="line-2255"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>new_ki1</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>new_kind_co</span>
<a name="line-2256"></a>
<a name="line-2257"></a>    <span class='hs-varid'>new_var</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>new_ki1</span><span class='hs-layout'>)</span>
<a name="line-2258"></a>
<a name="line-2259"></a><a name="substCoVar"></a><span class='hs-definition'>substCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2260"></a><span class='hs-definition'>substCoVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2261"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>cv</span> <span class='hs-keyword'>of</span>
<a name="line-2262"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co</span>
<a name="line-2263"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-2264"></a>
<a name="line-2265"></a><a name="substCoVars"></a><span class='hs-definition'>substCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-2266"></a><span class='hs-definition'>substCoVars</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cvs</span>
<a name="line-2267"></a>
<a name="line-2268"></a><a name="lookupCoVar"></a><span class='hs-definition'>lookupCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-2269"></a><span class='hs-definition'>lookupCoVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>v</span>
<a name="line-2270"></a>
<a name="line-2271"></a><a name="substTyVarBndr"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-keyglyph'>::</span>
<a name="line-2272"></a><span class='hs-comment'>-- CallStack wasn't present in GHC 7.10.1, disable callstacks in stage 1</span>
<a name="line-2273"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-2274"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>?</span><span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-2275"></a><span class='hs-cpp'>#endif</span>
<a name="line-2276"></a>    <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2277"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndrCallback</span> <span class='hs-varid'>substTy</span>
<a name="line-2278"></a>
<a name="line-2279"></a><a name="substTyVarBndrUnchecked"></a><span class='hs-comment'>-- | Like 'substTyVarBndr' but disables sanity checks.</span>
<a name="line-2280"></a><span class='hs-comment'>-- The problems that the sanity checks in substTy catch are described in</span>
<a name="line-2281"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2282"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTyUnchecked to</span>
<a name="line-2283"></a><span class='hs-comment'>-- substTy and remove this function. Please don't use in new code.</span>
<a name="line-2284"></a><span class='hs-definition'>substTyVarBndrUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2285"></a><span class='hs-definition'>substTyVarBndrUnchecked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndrCallback</span> <span class='hs-varid'>substTyUnchecked</span>
<a name="line-2286"></a>
<a name="line-2287"></a><a name="substTyVarBndrCallback"></a><span class='hs-comment'>-- | Substitute a tyvar in a binding position, returning an</span>
<a name="line-2288"></a><span class='hs-comment'>-- extended subst and a new tyvar.</span>
<a name="line-2289"></a><span class='hs-definition'>substTyVarBndrCallback</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ the subst function</span>
<a name="line-2290"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2291"></a><span class='hs-definition'>substTyVarBndrCallback</span> <span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-2292"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-sel'>_no_capture</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTvBndr</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprTvBndr</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>)</span>
<a name="line-2293"></a>    <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-2294"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-2295"></a>  <span class='hs-keyword'>where</span>
<a name="line-2296"></a>    <span class='hs-varid'>new_env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span>
<a name="line-2297"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-2298"></a>
<a name="line-2299"></a>    <span class='hs-sel'>_no_capture</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2300"></a>    <span class='hs-comment'>-- Assertion check that we are not capturing something in the substitution</span>
<a name="line-2301"></a>
<a name="line-2302"></a>    <span class='hs-varid'>old_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>old_var</span>
<a name="line-2303"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- verify that kind is closed</span>
<a name="line-2304"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span>
<a name="line-2305"></a>        <span class='hs-comment'>-- no_change means that the new_var is identical in</span>
<a name="line-2306"></a>        <span class='hs-comment'>-- all respects to the old_var (same unique, same kind)</span>
<a name="line-2307"></a>        <span class='hs-comment'>-- See Note [Extending the TCvSubst]</span>
<a name="line-2308"></a>        <span class='hs-comment'>--</span>
<a name="line-2309"></a>        <span class='hs-comment'>-- In that case we don't need to extend the substitution</span>
<a name="line-2310"></a>        <span class='hs-comment'>-- to map old to new.  But instead we must zap any</span>
<a name="line-2311"></a>        <span class='hs-comment'>-- current substitution for the variable. For example:</span>
<a name="line-2312"></a>        <span class='hs-comment'>--      (\x.e) with id_subst = [x |-&gt; e']</span>
<a name="line-2313"></a>        <span class='hs-comment'>-- Here we must simply zap the substitution for x</span>
<a name="line-2314"></a>
<a name="line-2315"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>old_var</span>
<a name="line-2316"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$</span>
<a name="line-2317"></a>                          <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span>
<a name="line-2318"></a>        <span class='hs-comment'>-- The uniqAway part makes sure the new variable is not already in scope</span>
<a name="line-2319"></a>
<a name="line-2320"></a><a name="substCoVarBndr"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>)</span>
<a name="line-2321"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVarBndrCallback</span> <span class='hs-conid'>False</span> <span class='hs-varid'>substTy</span>
<a name="line-2322"></a>
<a name="line-2323"></a><a name="substCoVarBndrCallback"></a><span class='hs-definition'>substCoVarBndrCallback</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- apply "sym" to the covar?</span>
<a name="line-2324"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-2325"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>)</span>
<a name="line-2326"></a><span class='hs-definition'>substCoVarBndrCallback</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>subst_fun</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-2327"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-2328"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>new_cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-2329"></a>  <span class='hs-keyword'>where</span>
<a name="line-2330"></a>    <span class='hs-comment'>-- When we substitute (co :: t1 ~ t2) we may get the identity (co :: t ~ t)</span>
<a name="line-2331"></a>    <span class='hs-comment'>-- In that case, mkCoVarCo will return a ReflCoercion, and</span>
<a name="line-2332"></a>    <span class='hs-comment'>-- we want to substitute that (not new_var) for old_var</span>
<a name="line-2333"></a>    <span class='hs-varid'>new_co</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>sym</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>new_var</span>
<a name="line-2334"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2335"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isReflCo</span> <span class='hs-varid'>new_co</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>no_kind_change</span>
<a name="line-2336"></a>
<a name="line-2337"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span>
<a name="line-2338"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>new_co</span>
<a name="line-2339"></a>
<a name="line-2340"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>subst_old_var</span>
<a name="line-2341"></a>    <span class='hs-varid'>subst_old_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varName</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_var_type</span>
<a name="line-2342"></a>
<a name="line-2343"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarKindsTypesRole</span> <span class='hs-varid'>old_var</span>
<a name="line-2344"></a>    <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_fun</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t1</span>
<a name="line-2345"></a>    <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_fun</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t2</span>
<a name="line-2346"></a>    <span class='hs-varid'>new_var_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoercionType</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>sym</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>t2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1'</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2347"></a>                  <span class='hs-comment'>-- It's important to do the substitution for coercions,</span>
<a name="line-2348"></a>                  <span class='hs-comment'>-- because they can have free type variables</span>
<a name="line-2349"></a>
<a name="line-2350"></a><a name="cloneTyVarBndr"></a><span class='hs-definition'>cloneTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2351"></a><span class='hs-definition'>cloneTyVarBndr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>uniq</span>
<a name="line-2352"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- I think it's only called on TyVars</span>
<a name="line-2353"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-2354"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-2355"></a>  <span class='hs-keyword'>where</span>
<a name="line-2356"></a>    <span class='hs-varid'>old_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-2357"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- verify that kind is closed</span>
<a name="line-2358"></a>
<a name="line-2359"></a>    <span class='hs-varid'>tv1</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span>
<a name="line-2360"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span>
<a name="line-2361"></a>
<a name="line-2362"></a>    <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarUnique</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>uniq</span>
<a name="line-2363"></a>
<a name="line-2364"></a><a name="cloneTyVarBndrs"></a><span class='hs-definition'>cloneTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2365"></a><span class='hs-definition'>cloneTyVarBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span>     <span class='hs-sel'>_usupply</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-2366"></a><span class='hs-definition'>cloneTyVarBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span>  <span class='hs-varid'>usupply</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst''</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2367"></a>  <span class='hs-keyword'>where</span>
<a name="line-2368"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-layout'>,</span> <span class='hs-varid'>usupply'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeUniqFromSupply</span> <span class='hs-varid'>usupply</span>
<a name="line-2369"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span> <span class='hs-layout'>,</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cloneTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t</span> <span class='hs-varid'>uniq</span>
<a name="line-2370"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst''</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cloneTyVarBndrs</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>usupply'</span>
<a name="line-2371"></a>
<a name="line-2372"></a><span class='hs-comment'>{-
<a name="line-2373"></a>%************************************************************************
<a name="line-2374"></a>%*                                                                      *
<a name="line-2375"></a>                   Pretty-printing types
<a name="line-2376"></a>
<a name="line-2377"></a>       Defined very early because of debug printing in assertions
<a name="line-2378"></a>%*                                                                      *
<a name="line-2379"></a>%************************************************************************
<a name="line-2380"></a>
<a name="line-2381"></a>@pprType@ is the standard @Type@ printer; the overloaded @ppr@ function is
<a name="line-2382"></a>defined to use this.  @pprParendType@ is the same, except it puts
<a name="line-2383"></a>parens around the type, except for the atomic cases.  @pprParendType@
<a name="line-2384"></a>works just by setting the initial context precedence very high.
<a name="line-2385"></a>
<a name="line-2386"></a>Note [Precedence in types]
<a name="line-2387"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2388"></a>We don't keep the fixity of type operators in the operator. So the pretty printer
<a name="line-2389"></a>operates the following precedene structre:
<a name="line-2390"></a>   Type constructor application   binds more tightly than
<a name="line-2391"></a>   Operator applications          which bind more tightly than
<a name="line-2392"></a>   Function arrow
<a name="line-2393"></a>
<a name="line-2394"></a>So we might see  a :+: T b -&gt; c
<a name="line-2395"></a>meaning          (a :+: (T b)) -&gt; c
<a name="line-2396"></a>
<a name="line-2397"></a>Maybe operator applications should bind a bit less tightly?
<a name="line-2398"></a>
<a name="line-2399"></a>Anyway, that's the current story, and it is used consistently for Type and HsType
<a name="line-2400"></a>-}</span>
<a name="line-2401"></a>
<a name="line-2402"></a><a name="TyPrec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyPrec</span>   <span class='hs-comment'>-- See Note [Prededence in types]</span>
<a name="line-2403"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TopPrec</span>         <span class='hs-comment'>-- No parens</span>
<a name="line-2404"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunPrec</span>         <span class='hs-comment'>-- Function args; no parens for tycon apps</span>
<a name="line-2405"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyOpPrec</span>        <span class='hs-comment'>-- Infix operator</span>
<a name="line-2406"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConPrec</span>       <span class='hs-comment'>-- Tycon args; no parens for atomic</span>
<a name="line-2407"></a>  <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-layout'>)</span>
<a name="line-2408"></a>
<a name="line-2409"></a><a name="maybeParen"></a><span class='hs-definition'>maybeParen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2410"></a><span class='hs-definition'>maybeParen</span> <span class='hs-varid'>ctxt_prec</span> <span class='hs-varid'>inner_prec</span> <span class='hs-varid'>pretty</span>
<a name="line-2411"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ctxt_prec</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>inner_prec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pretty</span>
<a name="line-2412"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>pretty</span>
<a name="line-2413"></a>
<a name="line-2414"></a><span class='hs-comment'>------------------</span>
<a name="line-2415"></a>
<a name="line-2416"></a><span class='hs-comment'>{-
<a name="line-2417"></a>Note [Defaulting RuntimeRep variables]
<a name="line-2418"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2419"></a>
<a name="line-2420"></a>RuntimeRep variables are considered by many (most?) users to be little more than
<a name="line-2421"></a>syntactic noise. When the notion was introduced there was a signficant and
<a name="line-2422"></a>understandable push-back from those with pedagogy in mind, which argued that
<a name="line-2423"></a>RuntimeRep variables would throw a wrench into nearly any teach approach since
<a name="line-2424"></a>they appear in even the lowly ($) function's type,
<a name="line-2425"></a>
<a name="line-2426"></a>    ($) :: forall (w :: RuntimeRep) a (b :: TYPE w). (a -&gt; b) -&gt; a -&gt; b
<a name="line-2427"></a>
<a name="line-2428"></a>which is significantly less readable than its non RuntimeRep-polymorphic type of
<a name="line-2429"></a>
<a name="line-2430"></a>    ($) :: (a -&gt; b) -&gt; a -&gt; b
<a name="line-2431"></a>
<a name="line-2432"></a>Moreover, unboxed types don't appear all that often in run-of-the-mill Haskell
<a name="line-2433"></a>programs, so it makes little sense to make all users pay this syntactic
<a name="line-2434"></a>overhead.
<a name="line-2435"></a>
<a name="line-2436"></a>For this reason it was decided that we would hide RuntimeRep variables for now
<a name="line-2437"></a>(see #11549). We do this by defaulting all type variables of kind RuntimeRep to
<a name="line-2438"></a>PtrLiftedRep. This is done in a pass right before pretty-printing
<a name="line-2439"></a>(defaultRuntimeRepVars, controlled by -fprint-explicit-runtime-reps)
<a name="line-2440"></a>-}</span>
<a name="line-2441"></a>
<a name="line-2442"></a><a name="defaultRuntimeRepVars"></a><span class='hs-comment'>-- | Default 'RuntimeRep' variables to 'LiftedPtr'. e.g.</span>
<a name="line-2443"></a><span class='hs-comment'>--</span>
<a name="line-2444"></a><span class='hs-comment'>-- @</span>
<a name="line-2445"></a><span class='hs-comment'>-- ($) :: forall (r :: GHC.Types.RuntimeRep) a (b :: TYPE r).</span>
<a name="line-2446"></a><span class='hs-comment'>--        (a -&gt; b) -&gt; a -&gt; b</span>
<a name="line-2447"></a><span class='hs-comment'>-- @</span>
<a name="line-2448"></a><span class='hs-comment'>--</span>
<a name="line-2449"></a><span class='hs-comment'>-- turns in to,</span>
<a name="line-2450"></a><span class='hs-comment'>--</span>
<a name="line-2451"></a><span class='hs-comment'>-- @ ($) :: forall a (b :: *). (a -&gt; b) -&gt; a -&gt; b @</span>
<a name="line-2452"></a><span class='hs-comment'>--</span>
<a name="line-2453"></a><span class='hs-comment'>-- We do this to prevent RuntimeRep variables from incurring a significant</span>
<a name="line-2454"></a><span class='hs-comment'>-- syntactic overhead in otherwise simple type signatures (e.g. ($)). See</span>
<a name="line-2455"></a><span class='hs-comment'>-- Note [Defaulting RuntimeRep variables] and #11549 for further discussion.</span>
<a name="line-2456"></a><span class='hs-comment'>--</span>
<a name="line-2457"></a><span class='hs-definition'>defaultRuntimeRepVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2458"></a><span class='hs-definition'>defaultRuntimeRepVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultRuntimeRepVars'</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-2459"></a>
<a name="line-2460"></a><a name="defaultRuntimeRepVars'"></a><span class='hs-definition'>defaultRuntimeRepVars'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span>  <span class='hs-comment'>-- ^ the binders which we should default</span>
<a name="line-2461"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2462"></a><span class='hs-comment'>-- TODO: Eventually we should just eliminate the Type pretty-printer</span>
<a name="line-2463"></a><span class='hs-comment'>-- entirely and simply use IfaceType; this task is tracked as #11660.</span>
<a name="line-2464"></a><span class='hs-definition'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>var</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2465"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRuntimeRepVar</span> <span class='hs-varid'>var</span>                        <span class='hs-keyglyph'>=</span>
<a name="line-2466"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>subs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>subs</span> <span class='hs-varid'>var</span>
<a name="line-2467"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs'</span> <span class='hs-varid'>ty</span>
<a name="line-2468"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                  <span class='hs-keyglyph'>=</span>
<a name="line-2469"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>var'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>var</span> <span class='hs-layout'>{</span> <span class='hs-varid'>varType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2470"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>var'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2471"></a>
<a name="line-2472"></a><span class='hs-definition'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2473"></a>    <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varop'>$</span> <span class='hs-varid'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-2474"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2475"></a>
<a name="line-2476"></a><span class='hs-definition'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-2477"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>var</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>subs</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptrRepLiftedTy</span>
<a name="line-2478"></a>
<a name="line-2479"></a><span class='hs-definition'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2480"></a>    <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-2481"></a>
<a name="line-2482"></a><span class='hs-definition'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span>
<a name="line-2483"></a>    <span class='hs-varid'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`AppTy`</span> <span class='hs-varid'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-varid'>y</span>
<a name="line-2484"></a>
<a name="line-2485"></a><span class='hs-definition'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span>
<a name="line-2486"></a>    <span class='hs-conid'>CastTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultRuntimeRepVars'</span> <span class='hs-varid'>subs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-2487"></a>
<a name="line-2488"></a><span class='hs-definition'>defaultRuntimeRepVars'</span> <span class='hs-keyword'>_</span>    <span class='hs-varid'>other</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other</span>
<a name="line-2489"></a>
<a name="line-2490"></a><a name="eliminateRuntimeRep"></a><span class='hs-definition'>eliminateRuntimeRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2491"></a><span class='hs-definition'>eliminateRuntimeRep</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2492"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintExplicitRuntimeReps</span> <span class='hs-varid'>dflags</span>
<a name="line-2493"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ty</span>
<a name="line-2494"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultRuntimeRepVars</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2495"></a>
<a name="line-2496"></a><a name="pprType"></a><span class='hs-definition'>pprType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2497"></a><span class='hs-definition'>pprType</span>       <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eliminateRuntimeRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2498"></a><a name="pprParendType"></a><span class='hs-definition'>pprParendType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eliminateRuntimeRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TyConPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2499"></a>
<a name="line-2500"></a><a name="pprTyLit"></a><span class='hs-definition'>pprTyLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2501"></a><span class='hs-definition'>pprTyLit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_tylit</span> <span class='hs-conid'>TopPrec</span>
<a name="line-2502"></a>
<a name="line-2503"></a><a name="pprKind"></a><span class='hs-definition'>pprKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2504"></a><span class='hs-definition'>pprKind</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprType</span>
<a name="line-2505"></a><a name="pprParendKind"></a><span class='hs-definition'>pprParendKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendType</span>
<a name="line-2506"></a>
<a name="line-2507"></a><a name="pprClassPred"></a><span class='hs-comment'>------------</span>
<a name="line-2508"></a><span class='hs-definition'>pprClassPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2509"></a><span class='hs-definition'>pprClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTypeApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2510"></a>
<a name="line-2511"></a><a name="pprTheta"></a><span class='hs-comment'>------------</span>
<a name="line-2512"></a><span class='hs-definition'>pprTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2513"></a><span class='hs-definition'>pprTheta</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pred</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>pred</span>     <span class='hs-comment'>-- I'm in two minds about this</span>
<a name="line-2514"></a><span class='hs-definition'>pprTheta</span> <span class='hs-varid'>theta</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2515"></a>
<a name="line-2516"></a><a name="pprThetaArrowTy"></a><span class='hs-definition'>pprThetaArrowTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2517"></a><span class='hs-definition'>pprThetaArrowTy</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-2518"></a><span class='hs-definition'>pprThetaArrowTy</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pred</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TyOpPrec</span> <span class='hs-varid'>pred</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>darrow</span>
<a name="line-2519"></a>                         <span class='hs-comment'>-- TyOpPrec:  Num a     =&gt; a -&gt; a  does not need parens</span>
<a name="line-2520"></a>                         <span class='hs-comment'>--      bug   (a :~: b) =&gt; a -&gt; b  currently does</span>
<a name="line-2521"></a>                         <span class='hs-comment'>-- Trac # 9658</span>
<a name="line-2522"></a><span class='hs-definition'>pprThetaArrowTy</span> <span class='hs-varid'>preds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>preds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2523"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>darrow</span>
<a name="line-2524"></a>    <span class='hs-comment'>-- Notice 'fsep' here rather that 'sep', so that</span>
<a name="line-2525"></a>    <span class='hs-comment'>-- type contexts don't get displayed in a giant column</span>
<a name="line-2526"></a>    <span class='hs-comment'>-- Rather than</span>
<a name="line-2527"></a>    <span class='hs-comment'>--  instance (Eq a,</span>
<a name="line-2528"></a>    <span class='hs-comment'>--            Eq b,</span>
<a name="line-2529"></a>    <span class='hs-comment'>--            Eq c,</span>
<a name="line-2530"></a>    <span class='hs-comment'>--            Eq d,</span>
<a name="line-2531"></a>    <span class='hs-comment'>--            Eq e,</span>
<a name="line-2532"></a>    <span class='hs-comment'>--            Eq f,</span>
<a name="line-2533"></a>    <span class='hs-comment'>--            Eq g,</span>
<a name="line-2534"></a>    <span class='hs-comment'>--            Eq h,</span>
<a name="line-2535"></a>    <span class='hs-comment'>--            Eq i,</span>
<a name="line-2536"></a>    <span class='hs-comment'>--            Eq j,</span>
<a name="line-2537"></a>    <span class='hs-comment'>--            Eq k,</span>
<a name="line-2538"></a>    <span class='hs-comment'>--            Eq l) =&gt;</span>
<a name="line-2539"></a>    <span class='hs-comment'>--           Eq (a, b, c, d, e, f, g, h, i, j, k, l)</span>
<a name="line-2540"></a>    <span class='hs-comment'>-- we get</span>
<a name="line-2541"></a>    <span class='hs-comment'>--</span>
<a name="line-2542"></a>    <span class='hs-comment'>--  instance (Eq a, Eq b, Eq c, Eq d, Eq e, Eq f, Eq g, Eq h, Eq i,</span>
<a name="line-2543"></a>    <span class='hs-comment'>--            Eq j, Eq k, Eq l) =&gt;</span>
<a name="line-2544"></a>    <span class='hs-comment'>--           Eq (a, b, c, d, e, f, g, h, i, j, k, l)</span>
<a name="line-2545"></a>
<a name="line-2546"></a><a name="instance%20Outputable%20Type"></a><span class='hs-comment'>------------------</span>
<a name="line-2547"></a><a name="instance%20Outputable%20Type"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Type</span> <span class='hs-keyword'>where</span>
<a name="line-2548"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span>
<a name="line-2549"></a>
<a name="line-2550"></a><a name="instance%20Outputable%20TyLit"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyword'>where</span>
<a name="line-2551"></a>   <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyLit</span>
<a name="line-2552"></a>
<a name="line-2553"></a><span class='hs-comment'>------------------</span>
<a name="line-2554"></a>        <span class='hs-comment'>-- OK, here's the main printer</span>
<a name="line-2555"></a>
<a name="line-2556"></a><a name="ppr_type"></a><span class='hs-definition'>ppr_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2557"></a><span class='hs-definition'>ppr_type</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_tvar</span> <span class='hs-varid'>tv</span>
<a name="line-2558"></a>
<a name="line-2559"></a><span class='hs-definition'>ppr_type</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyTcApp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2560"></a><span class='hs-definition'>ppr_type</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_tylit</span> <span class='hs-varid'>p</span> <span class='hs-varid'>l</span>
<a name="line-2561"></a><span class='hs-definition'>ppr_type</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_forall_type</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty</span>
<a name="line-2562"></a>
<a name="line-2563"></a><span class='hs-definition'>ppr_type</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-2564"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_print_coercions</span>
<a name="line-2565"></a>      <span class='hs-varid'>ppr_app_ty</span>
<a name="line-2566"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>split_app_tys</span> <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-2567"></a>          <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>head</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr_type</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_app_tys</span> <span class='hs-varid'>head</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2568"></a>          <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr_app_ty</span><span class='hs-layout'>)</span>
<a name="line-2569"></a>  <span class='hs-keyword'>where</span>
<a name="line-2570"></a>    <span class='hs-varid'>ppr_app_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varop'>$</span>
<a name="line-2571"></a>                 <span class='hs-varid'>ppr_type</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>t2</span>
<a name="line-2572"></a>
<a name="line-2573"></a>    <span class='hs-varid'>split_app_tys</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split_app_tys</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2574"></a>    <span class='hs-varid'>split_app_tys</span> <span class='hs-varid'>head</span>            <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2575"></a>
<a name="line-2576"></a>    <span class='hs-varid'>mk_app_tys</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-2577"></a>    <span class='hs-varid'>mk_app_tys</span> <span class='hs-varid'>ty1</span>                <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>tys2</span>
<a name="line-2578"></a>
<a name="line-2579"></a><span class='hs-definition'>ppr_type</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2580"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_print_coercions</span>
<a name="line-2581"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"|&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2582"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>ppr_type</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2583"></a>
<a name="line-2584"></a><span class='hs-definition'>ppr_type</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2585"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_print_coercions</span>
<a name="line-2586"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2587"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"&lt;&gt;"</span><span class='hs-layout'>)</span>
<a name="line-2588"></a>
<a name="line-2589"></a><a name="ppr_forall_type"></a><span class='hs-definition'>ppr_forall_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2590"></a><span class='hs-definition'>ppr_forall_type</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty</span>
<a name="line-2591"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-2592"></a>    <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2593"></a>    <span class='hs-varid'>ppr_sigma_type</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ty</span>
<a name="line-2594"></a>    <span class='hs-comment'>-- True &lt;=&gt; we always print the foralls on *nested* quantifiers</span>
<a name="line-2595"></a>    <span class='hs-comment'>-- Opt_PrintExplicitForalls only affects top-level quantifiers</span>
<a name="line-2596"></a>
<a name="line-2597"></a><a name="ppr_tvar"></a><span class='hs-definition'>ppr_tvar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2598"></a><span class='hs-definition'>ppr_tvar</span> <span class='hs-varid'>tv</span>  <span class='hs-comment'>-- Note [Infix type variables]</span>
<a name="line-2599"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parenSymOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2600"></a>
<a name="line-2601"></a><a name="ppr_tylit"></a><span class='hs-definition'>ppr_tylit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2602"></a><span class='hs-definition'>ppr_tylit</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tl</span> <span class='hs-keyglyph'>=</span>
<a name="line-2603"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>tl</span> <span class='hs-keyword'>of</span>
<a name="line-2604"></a>    <span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>integer</span> <span class='hs-varid'>n</span>
<a name="line-2605"></a>    <span class='hs-conid'>StrTyLit</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-2606"></a>
<a name="line-2607"></a><a name="if_print_coercions"></a><span class='hs-definition'>if_print_coercions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>  <span class='hs-comment'>-- if printing coercions</span>
<a name="line-2608"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>  <span class='hs-comment'>-- otherwise</span>
<a name="line-2609"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2610"></a><span class='hs-definition'>if_print_coercions</span> <span class='hs-varid'>yes</span> <span class='hs-varid'>no</span>
<a name="line-2611"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2612"></a>    <span class='hs-varid'>getPprStyle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>style</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2613"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintExplicitCoercions</span> <span class='hs-varid'>dflags</span>
<a name="line-2614"></a>         <span class='hs-varop'>||</span> <span class='hs-varid'>dumpStyle</span> <span class='hs-varid'>style</span> <span class='hs-varop'>||</span> <span class='hs-varid'>debugStyle</span> <span class='hs-varid'>style</span>
<a name="line-2615"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>yes</span>
<a name="line-2616"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>no</span>
<a name="line-2617"></a>
<a name="line-2618"></a><a name="ppr_sigma_type"></a><span class='hs-comment'>-------------------</span>
<a name="line-2619"></a><span class='hs-definition'>ppr_sigma_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-2620"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- ^ True &lt;=&gt; Show the foralls unconditionally</span>
<a name="line-2621"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2622"></a><span class='hs-comment'>-- Suppose we have (forall a. Show a =&gt; forall b. a -&gt; b). When we're not</span>
<a name="line-2623"></a><span class='hs-comment'>-- printing foralls, we want to drop both the (forall a) and the (forall b).</span>
<a name="line-2624"></a><span class='hs-comment'>-- This logic does so.</span>
<a name="line-2625"></a><span class='hs-definition'>ppr_sigma_type</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>False</span> <span class='hs-varid'>orig_ty</span>
<a name="line-2626"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintExplicitForalls</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-2627"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>binderType</span><span class='hs-layout'>)</span> <span class='hs-varid'>named</span>
<a name="line-2628"></a>      <span class='hs-comment'>-- See Note [When to print foralls]</span>
<a name="line-2629"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprThetaArrowTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>binderType</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-2630"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pprArrowChain</span> <span class='hs-conid'>TopPrec</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_fun_tail</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2631"></a>  <span class='hs-keyword'>where</span>
<a name="line-2632"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>invis_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>orig_ty</span>
<a name="line-2633"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>named</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isNamedBinder</span> <span class='hs-varid'>invis_bndrs</span>
<a name="line-2634"></a>
<a name="line-2635"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>acc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isInvisibleBinder</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2636"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>ty</span>                                          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2637"></a>
<a name="line-2638"></a><span class='hs-definition'>ppr_sigma_type</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>
<a name="line-2639"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprForAll</span> <span class='hs-varid'>bndrs</span>
<a name="line-2640"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pprThetaArrowTy</span> <span class='hs-varid'>ctxt</span>
<a name="line-2641"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pprArrowChain</span> <span class='hs-conid'>TopPrec</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_fun_tail</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2642"></a>  <span class='hs-keyword'>where</span>
<a name="line-2643"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split1</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ty</span>
<a name="line-2644"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split2</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>rho</span>
<a name="line-2645"></a>
<a name="line-2646"></a>    <span class='hs-varid'>split1</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>bndr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split1</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-conop'>:</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2647"></a>    <span class='hs-varid'>split1</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>ty</span>                            <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2648"></a>
<a name="line-2649"></a>    <span class='hs-varid'>split2</span> <span class='hs-varid'>ps</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-2650"></a>    <span class='hs-varid'>split2</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>ty</span>                                       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>ps</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2651"></a>
<a name="line-2652"></a>    <span class='hs-comment'>-- We don't want to lose synonyms, so we mustn't use splitFunTys here.</span>
<a name="line-2653"></a><a name="ppr_fun_tail"></a><span class='hs-definition'>ppr_fun_tail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-2654"></a><span class='hs-definition'>ppr_fun_tail</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-2655"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPredTy</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_type</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>ty1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ppr_fun_tail</span> <span class='hs-varid'>ty2</span>
<a name="line-2656"></a><span class='hs-definition'>ppr_fun_tail</span> <span class='hs-varid'>other_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>other_ty</span><span class='hs-keyglyph'>]</span>
<a name="line-2657"></a>
<a name="line-2658"></a><a name="pprSigmaType"></a><span class='hs-definition'>pprSigmaType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2659"></a><span class='hs-comment'>-- Prints a top-level type for the user; in particular</span>
<a name="line-2660"></a><span class='hs-comment'>-- top-level foralls are omitted unless you use -fprint-explicit-foralls</span>
<a name="line-2661"></a><span class='hs-definition'>pprSigmaType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2662"></a>    <span class='hs-varid'>eliminateRuntimeRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_sigma_type</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2663"></a>
<a name="line-2664"></a><a name="pprUserForAll"></a><span class='hs-definition'>pprUserForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2665"></a><span class='hs-comment'>-- Print a user-level forall; see Note [When to print foralls]</span>
<a name="line-2666"></a><span class='hs-definition'>pprUserForAll</span> <span class='hs-varid'>bndrs</span>
<a name="line-2667"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2668"></a>    <span class='hs-varid'>ppWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-varid'>bndr_has_kind_var</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>||</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintExplicitForalls</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2669"></a>    <span class='hs-varid'>pprForAll</span> <span class='hs-varid'>bndrs</span>
<a name="line-2670"></a>  <span class='hs-keyword'>where</span>
<a name="line-2671"></a>    <span class='hs-varid'>bndr_has_kind_var</span> <span class='hs-varid'>bndr</span>
<a name="line-2672"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2673"></a>
<a name="line-2674"></a><a name="pprForAllImplicit"></a><span class='hs-definition'>pprForAllImplicit</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2675"></a><span class='hs-definition'>pprForAllImplicit</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprForAll</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-conid'>Named</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-conid'>Specified</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2676"></a>
<a name="line-2677"></a><a name="pprForAll"></a><span class='hs-comment'>-- | Render the "forall ... ." or "forall ... -&gt;" bit of a type.</span>
<a name="line-2678"></a><span class='hs-comment'>-- Do not pass in anonymous binders!</span>
<a name="line-2679"></a><span class='hs-definition'>pprForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2680"></a><span class='hs-definition'>pprForAll</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-2681"></a><span class='hs-definition'>pprForAll</span> <span class='hs-varid'>bndrs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vis</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-2682"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_separator</span> <span class='hs-layout'>(</span><span class='hs-varid'>forAllLit</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprForAll</span> <span class='hs-varid'>bndrs'</span>
<a name="line-2683"></a>  <span class='hs-keyword'>where</span>
<a name="line-2684"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_tv_bndrs</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>vis</span>
<a name="line-2685"></a>
<a name="line-2686"></a>    <span class='hs-varid'>add_separator</span> <span class='hs-varid'>stuff</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>vis</span> <span class='hs-keyword'>of</span>
<a name="line-2687"></a>                            <span class='hs-conid'>Visible</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>stuff</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>arrow</span>
<a name="line-2688"></a>                            <span class='hs-sel'>_inv</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>stuff</span> <span class='hs-varop'>&lt;&gt;</span>  <span class='hs-varid'>dot</span>
<a name="line-2689"></a><span class='hs-definition'>pprForAll</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"pprForAll: anonymous binder"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-2690"></a>
<a name="line-2691"></a><a name="pprTvBndrs"></a><span class='hs-definition'>pprTvBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2692"></a><span class='hs-definition'>pprTvBndrs</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprTvBndr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2693"></a>
<a name="line-2694"></a><a name="ppr_tv_bndrs"></a><span class='hs-comment'>-- | Render the ... in @(forall ... .)@ or @(forall ... -&gt;)@.</span>
<a name="line-2695"></a><span class='hs-comment'>-- Returns both the list of not-yet-rendered binders and the doc.</span>
<a name="line-2696"></a><span class='hs-comment'>-- No anonymous binders here!</span>
<a name="line-2697"></a><span class='hs-definition'>ppr_tv_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-2698"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VisibilityFlag</span>  <span class='hs-comment'>-- ^ visibility of the first binder in the list</span>
<a name="line-2699"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-2700"></a><span class='hs-definition'>ppr_tv_bndrs</span> <span class='hs-varid'>all_bndrs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>vis1</span>
<a name="line-2701"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>vis</span> <span class='hs-varop'>`sameVis`</span> <span class='hs-varid'>vis1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_tv_bndrs</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>vis1</span>
<a name="line-2702"></a>                             <span class='hs-varid'>pp_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2703"></a>                                     <span class='hs-keyword'>if</span> <span class='hs-conid'>Invisible</span> <span class='hs-varop'>==</span> <span class='hs-varid'>vis</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-2704"></a>                                        <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintExplicitForalls</span> <span class='hs-varid'>dflags</span>
<a name="line-2705"></a>                                     <span class='hs-keyword'>then</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTvBndrNoParens</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2706"></a>                                     <span class='hs-keyword'>else</span> <span class='hs-varid'>pprTvBndr</span> <span class='hs-varid'>tv</span>
<a name="line-2707"></a>                         <span class='hs-keyword'>in</span>
<a name="line-2708"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-2709"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>all_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-2710"></a><span class='hs-definition'>ppr_tv_bndrs</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-2711"></a><span class='hs-definition'>ppr_tv_bndrs</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ppr_tv_bndrs: anonymous binder"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-2712"></a>
<a name="line-2713"></a><a name="pprTvBndr"></a><span class='hs-definition'>pprTvBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2714"></a><span class='hs-definition'>pprTvBndr</span> <span class='hs-varid'>tv</span>
<a name="line-2715"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_tvar</span> <span class='hs-varid'>tv</span>
<a name="line-2716"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_tvar</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprKind</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-2717"></a>             <span class='hs-keyword'>where</span>
<a name="line-2718"></a>               <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-2719"></a>
<a name="line-2720"></a><a name="pprTvBndrNoParens"></a><span class='hs-definition'>pprTvBndrNoParens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2721"></a><span class='hs-definition'>pprTvBndrNoParens</span> <span class='hs-varid'>tv</span>
<a name="line-2722"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_tvar</span> <span class='hs-varid'>tv</span>
<a name="line-2723"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_tvar</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprKind</span> <span class='hs-varid'>kind</span>
<a name="line-2724"></a>             <span class='hs-keyword'>where</span>
<a name="line-2725"></a>               <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-2726"></a>
<a name="line-2727"></a><a name="instance%20Outputable%20TyBinder"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyword'>where</span>
<a name="line-2728"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Visible</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-2729"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Specified</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'@'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-2730"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Invisible</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-2731"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[anon]"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-2732"></a>
<a name="line-2733"></a><a name="instance%20Outputable%20VisibilityFlag"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>VisibilityFlag</span> <span class='hs-keyword'>where</span>
<a name="line-2734"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Visible</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[vis]"</span>
<a name="line-2735"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Specified</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[spec]"</span>
<a name="line-2736"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Invisible</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[invis]"</span>
<a name="line-2737"></a>
<a name="line-2738"></a><a name="instance%20Outputable%20Coercion"></a><span class='hs-comment'>-----------------</span>
<a name="line-2739"></a><a name="instance%20Outputable%20Coercion"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyword'>where</span> <span class='hs-comment'>-- defined here to avoid orphans</span>
<a name="line-2740"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCo</span>
<a name="line-2741"></a><a name="instance%20Outputable%20LeftOrRight"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyword'>where</span>
<a name="line-2742"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CLeft</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Left"</span>
<a name="line-2743"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CRight</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Right"</span>
<a name="line-2744"></a>
<a name="line-2745"></a><span class='hs-comment'>{-
<a name="line-2746"></a>Note [When to print foralls]
<a name="line-2747"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2748"></a>Mostly we want to print top-level foralls when (and only when) the user specifies
<a name="line-2749"></a>-fprint-explicit-foralls.  But when kind polymorphism is at work, that suppresses
<a name="line-2750"></a>too much information; see Trac #9018.
<a name="line-2751"></a>
<a name="line-2752"></a>So I'm trying out this rule: print explicit foralls if
<a name="line-2753"></a>  a) User specifies -fprint-explicit-foralls, or
<a name="line-2754"></a>  b) Any of the quantified type variables has a kind
<a name="line-2755"></a>     that mentions a kind variable
<a name="line-2756"></a>
<a name="line-2757"></a>This catches common situations, such as a type siguature
<a name="line-2758"></a>     f :: m a
<a name="line-2759"></a>which means
<a name="line-2760"></a>      f :: forall k. forall (m :: k-&gt;*) (a :: k). m a
<a name="line-2761"></a>We really want to see both the "forall k" and the kind signatures
<a name="line-2762"></a>on m and a.  The latter comes from pprTvBndr.
<a name="line-2763"></a>
<a name="line-2764"></a>Note [Infix type variables]
<a name="line-2765"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2766"></a>With TypeOperators you can say
<a name="line-2767"></a>
<a name="line-2768"></a>   f :: (a ~&gt; b) -&gt; b
<a name="line-2769"></a>
<a name="line-2770"></a>and the (~&gt;) is considered a type variable.  However, the type
<a name="line-2771"></a>pretty-printer in this module will just see (a ~&gt; b) as
<a name="line-2772"></a>
<a name="line-2773"></a>   App (App (TyVarTy "~&gt;") (TyVarTy "a")) (TyVarTy "b")
<a name="line-2774"></a>
<a name="line-2775"></a>So it'll print the type in prefix form.  To avoid confusion we must
<a name="line-2776"></a>remember to parenthesise the operator, thus
<a name="line-2777"></a>
<a name="line-2778"></a>   (~&gt;) a b -&gt; b
<a name="line-2779"></a>
<a name="line-2780"></a>See Trac #2766.
<a name="line-2781"></a>-}</span>
<a name="line-2782"></a>
<a name="line-2783"></a><a name="pprDataCons"></a><span class='hs-definition'>pprDataCons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2784"></a><span class='hs-definition'>pprDataCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sepWithVBars</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>pprDataConWithArgs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyConDataCons</span>
<a name="line-2785"></a>  <span class='hs-keyword'>where</span>
<a name="line-2786"></a>    <span class='hs-varid'>sepWithVBars</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-2787"></a>    <span class='hs-varid'>sepWithVBars</span> <span class='hs-varid'>docs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-layout'>(</span><span class='hs-varid'>space</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>vbar</span><span class='hs-layout'>)</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span>
<a name="line-2788"></a>
<a name="line-2789"></a><a name="pprDataConWithArgs"></a><span class='hs-definition'>pprDataConWithArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2790"></a><span class='hs-definition'>pprDataConWithArgs</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>forAllDoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>thetaDoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>argsDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-2791"></a>  <span class='hs-keyword'>where</span>
<a name="line-2792"></a>    <span class='hs-layout'>(</span><span class='hs-sel'>_univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-sel'>_ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>dc</span>
<a name="line-2793"></a>    <span class='hs-varid'>univ_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConUnivTyBinders</span> <span class='hs-varid'>dc</span>
<a name="line-2794"></a>    <span class='hs-varid'>ex_bndrs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConExTyBinders</span> <span class='hs-varid'>dc</span>
<a name="line-2795"></a>    <span class='hs-varid'>forAllDoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprUserForAll</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterEqSpec</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varid'>univ_bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ex_bndrs</span><span class='hs-layout'>)</span>
<a name="line-2796"></a>    <span class='hs-varid'>thetaDoc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprThetaArrowTy</span> <span class='hs-varid'>theta</span>
<a name="line-2797"></a>    <span class='hs-varid'>argsDoc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-2798"></a>
<a name="line-2799"></a>
<a name="line-2800"></a><a name="pprTypeApp"></a><span class='hs-definition'>pprTypeApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2801"></a><span class='hs-definition'>pprTypeApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyTcApp</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2802"></a>        <span class='hs-comment'>-- We have to use ppr on the TyCon (not its name)</span>
<a name="line-2803"></a>        <span class='hs-comment'>-- so that we get promotion quotes in the right place</span>
<a name="line-2804"></a>
<a name="line-2805"></a><a name="pprTyTcApp"></a><span class='hs-definition'>pprTyTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2806"></a><span class='hs-comment'>-- Used for types only; so that we can make a</span>
<a name="line-2807"></a><span class='hs-comment'>-- special case for type-level lists</span>
<a name="line-2808"></a><span class='hs-definition'>pprTyTcApp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2809"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>ipClassKey</span>
<a name="line-2810"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span>
<a name="line-2811"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-2812"></a>    <span class='hs-varid'>char</span> <span class='hs-chr'>'?'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ftext</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"::"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>ty</span>
<a name="line-2813"></a>
<a name="line-2814"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>consDataConKey</span>
<a name="line-2815"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-sel'>_kind</span><span class='hs-layout'>,</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span>
<a name="line-2816"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2817"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintExplicitKinds</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ppr_deflt</span>
<a name="line-2818"></a>                                          <span class='hs-keyword'>else</span> <span class='hs-varid'>pprTyList</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2819"></a>
<a name="line-2820"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>opt_PprStyle_Debug</span>
<a name="line-2821"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>errorMessageTypeErrorFamKey</span>
<a name="line-2822"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(TypeError ...)"</span>   <span class='hs-comment'>-- Suppress detail unles you _really_ want to see</span>
<a name="line-2823"></a>
<a name="line-2824"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tYPETyConKey</span>
<a name="line-2825"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>ptr_rep</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span>
<a name="line-2826"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ptr_rep</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>ptrRepLiftedDataConKey</span>
<a name="line-2827"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unicodeSyntax</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>'★'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>'*'</span><span class='hs-layout'>)</span>
<a name="line-2828"></a>
<a name="line-2829"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tYPETyConKey</span>
<a name="line-2830"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>ptr_rep</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span>
<a name="line-2831"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ptr_rep</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>ptrRepUnliftedDataConKey</span>
<a name="line-2832"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'#'</span>
<a name="line-2833"></a>
<a name="line-2834"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2835"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_deflt</span>
<a name="line-2836"></a>  <span class='hs-keyword'>where</span>
<a name="line-2837"></a>    <span class='hs-varid'>ppr_deflt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTcAppTy</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ppr_type</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2838"></a>
<a name="line-2839"></a><a name="pprTcAppTy"></a><span class='hs-definition'>pprTcAppTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2840"></a><span class='hs-definition'>pprTcAppTy</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2841"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>style</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprTcApp</span> <span class='hs-varid'>style</span> <span class='hs-varid'>id</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2842"></a>
<a name="line-2843"></a><a name="pprTcAppCo"></a><span class='hs-definition'>pprTcAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-2844"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2845"></a><span class='hs-definition'>pprTcAppCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-2846"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>style</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2847"></a>    <span class='hs-varid'>pprTcApp</span> <span class='hs-varid'>style</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coercionKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-2848"></a>
<a name="line-2849"></a><a name="pprTcApp"></a><span class='hs-definition'>pprTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PprStyle</span>
<a name="line-2850"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2851"></a><span class='hs-comment'>-- Used for both types and coercions, hence polymorphism</span>
<a name="line-2852"></a><span class='hs-definition'>pprTcApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-2853"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>listTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPromotionQuote</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span>   <span class='hs-layout'>(</span><span class='hs-varid'>pp</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2854"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>parrTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPromotionQuote</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>paBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2855"></a>
<a name="line-2856"></a><span class='hs-definition'>pprTcApp</span> <span class='hs-varid'>style</span> <span class='hs-varid'>to_type</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2857"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>debugStyle</span> <span class='hs-varid'>style</span><span class='hs-layout'>)</span>
<a name="line-2858"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>sort</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConTuple_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-2859"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-2860"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-2861"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>num_to_drop</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sort</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>UnboxedTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>2</span>
<a name="line-2862"></a>                                   <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-2863"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTupleApp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>sort</span> <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>num_to_drop</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2864"></a>
<a name="line-2865"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>debugStyle</span> <span class='hs-varid'>style</span><span class='hs-layout'>)</span>
<a name="line-2866"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isPromotedDataCon_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-2867"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dc_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>dc</span>
<a name="line-2868"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConTuple_maybe</span> <span class='hs-varid'>dc_tc</span>
<a name="line-2869"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>dc_tc</span>    <span class='hs-comment'>-- E.g. 3 for (,,) k1 k2 k3 t1 t2 t3</span>
<a name="line-2870"></a>        <span class='hs-varid'>ty_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>drop</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>tys</span>    <span class='hs-comment'>-- Drop the kind args</span>
<a name="line-2871"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ty_args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>arity</span>        <span class='hs-comment'>-- Result is saturated</span>
<a name="line-2872"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPromotionQuote</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-2873"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tupleParens</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp</span> <span class='hs-conid'>TopPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span>
<a name="line-2874"></a>
<a name="line-2875"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2876"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2877"></a>    <span class='hs-varid'>pprTcApp_help</span> <span class='hs-varid'>to_type</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>style</span>
<a name="line-2878"></a>  <span class='hs-keyword'>where</span>
<a name="line-2879"></a>
<a name="line-2880"></a><a name="pprTupleApp"></a><span class='hs-definition'>pprTupleApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-2881"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2882"></a><span class='hs-comment'>-- Print a saturated tuple</span>
<a name="line-2883"></a><span class='hs-definition'>pprTupleApp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>sort</span> <span class='hs-varid'>tys</span>
<a name="line-2884"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tys</span>
<a name="line-2885"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sort</span>
<a name="line-2886"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(%%)"</span>
<a name="line-2887"></a>                          <span class='hs-keyword'>else</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-2888"></a>                               <span class='hs-varid'>text</span> <span class='hs-str'>"() :: Constraint"</span>
<a name="line-2889"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2890"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPromotionQuote</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-2891"></a>    <span class='hs-varid'>tupleParens</span> <span class='hs-varid'>sort</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp</span> <span class='hs-conid'>TopPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2892"></a>
<a name="line-2893"></a><a name="pprTcApp_help"></a><span class='hs-definition'>pprTcApp_help</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-2894"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PprStyle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2895"></a><span class='hs-comment'>-- This one has accss to the DynFlags</span>
<a name="line-2896"></a><span class='hs-definition'>pprTcApp_help</span> <span class='hs-varid'>to_type</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>style</span>
<a name="line-2897"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSymOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Print prefix</span>
<a name="line-2898"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp</span> <span class='hs-conid'>TyConPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys_wo_kinds</span><span class='hs-layout'>)</span>
<a name="line-2899"></a>
<a name="line-2900"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_saturated_equality</span>
<a name="line-2901"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>print_equality</span> <span class='hs-varid'>args</span>
<a name="line-2902"></a>
<a name="line-2903"></a>  <span class='hs-comment'>-- So we have an operator symbol of some kind</span>
<a name="line-2904"></a>
<a name="line-2905"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys_wo_kinds</span>  <span class='hs-comment'>-- Infix, two arguments;</span>
<a name="line-2906"></a>                               <span class='hs-comment'>-- we know nothing of precedence though</span>
<a name="line-2907"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprInfixApp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>pp_tc</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2908"></a>
<a name="line-2909"></a>  <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>tc_name</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>starKindTyConKey</span>
<a name="line-2910"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>tc_name</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>unicodeStarKindTyConKey</span>
<a name="line-2911"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>tc_name</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>unliftedTypeKindTyConKey</span>
<a name="line-2912"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_tc</span>   <span class='hs-comment'>-- Do not wrap *, # in parens</span>
<a name="line-2913"></a>
<a name="line-2914"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Unsaturated operator</span>
<a name="line-2915"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp</span> <span class='hs-conid'>TyConPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys_wo_kinds</span><span class='hs-layout'>)</span>
<a name="line-2916"></a>  <span class='hs-keyword'>where</span>
<a name="line-2917"></a>    <span class='hs-varid'>tc_name</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span>
<a name="line-2918"></a>    <span class='hs-varid'>pp_tc</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span>
<a name="line-2919"></a>    <span class='hs-varid'>tys_wo_kinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>suppressInvisibles</span> <span class='hs-varid'>to_type</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2920"></a>
<a name="line-2921"></a>    <span class='hs-varid'>mb_saturated_equality</span>
<a name="line-2922"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hetero_eq_tc</span>
<a name="line-2923"></a>      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span>
<a name="line-2924"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-2925"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>homo_eq_tc</span>
<a name="line-2926"></a>      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span>  <span class='hs-comment'>-- we must have (~)</span>
<a name="line-2927"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-2928"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2929"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2930"></a>
<a name="line-2931"></a>    <span class='hs-varid'>homo_eq_tc</span>   <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span>             <span class='hs-comment'>-- ~</span>
<a name="line-2932"></a>    <span class='hs-varid'>hetero_eq_tc</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span>         <span class='hs-comment'>-- ~#</span>
<a name="line-2933"></a>                 <span class='hs-varop'>||</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span>     <span class='hs-comment'>-- ~R#</span>
<a name="line-2934"></a>                 <span class='hs-varop'>||</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>heqTyConKey</span>            <span class='hs-comment'>-- ~~</span>
<a name="line-2935"></a>
<a name="line-2936"></a>      <span class='hs-comment'>-- This is all a bit ad-hoc, trying to print out the best representation</span>
<a name="line-2937"></a>      <span class='hs-comment'>-- of equalities. If you see a better design, go for it.</span>
<a name="line-2938"></a>
<a name="line-2939"></a>    <span class='hs-varid'>print_equality</span> <span class='hs-layout'>(</span><span class='hs-varid'>ki1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-2940"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>print_eqs</span>
<a name="line-2941"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_infix_eq</span> <span class='hs-varid'>pp_tc</span>
<a name="line-2942"></a>
<a name="line-2943"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hetero_eq_tc</span>
<a name="line-2944"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>print_kinds</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>to_type</span> <span class='hs-varid'>ki1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>to_type</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>)</span>
<a name="line-2945"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_infix_eq</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span>
<a name="line-2946"></a>                       <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"~~"</span>
<a name="line-2947"></a>                       <span class='hs-keyword'>else</span> <span class='hs-varid'>pp_tc</span>
<a name="line-2948"></a>
<a name="line-2949"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2950"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span>
<a name="line-2951"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Coercible"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pp</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>ty1</span>
<a name="line-2952"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>pp</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2953"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pp</span> <span class='hs-conid'>TyOpPrec</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"~"</span><span class='hs-layout'>,</span> <span class='hs-varid'>pp</span> <span class='hs-conid'>TyOpPrec</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-2954"></a>
<a name="line-2955"></a>      <span class='hs-keyword'>where</span>
<a name="line-2956"></a>        <span class='hs-varid'>ppr_infix_eq</span> <span class='hs-varid'>eq_op</span>
<a name="line-2957"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp</span> <span class='hs-conid'>TyOpPrec</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp</span> <span class='hs-conid'>TyOpPrec</span> <span class='hs-varid'>ki1</span><span class='hs-layout'>)</span>
<a name="line-2958"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>eq_op</span>
<a name="line-2959"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp</span> <span class='hs-conid'>TyOpPrec</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp</span> <span class='hs-conid'>TyOpPrec</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2960"></a>
<a name="line-2961"></a>    <span class='hs-varid'>print_kinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintExplicitKinds</span> <span class='hs-varid'>dflags</span>
<a name="line-2962"></a>    <span class='hs-varid'>print_eqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintEqualityRelations</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span>
<a name="line-2963"></a>                  <span class='hs-varid'>dumpStyle</span> <span class='hs-varid'>style</span> <span class='hs-varop'>||</span>
<a name="line-2964"></a>                  <span class='hs-varid'>debugStyle</span> <span class='hs-varid'>style</span>
<a name="line-2965"></a>
<a name="line-2966"></a><a name="suppressInvisibles"></a><span class='hs-comment'>------------------</span>
<a name="line-2967"></a><span class='hs-comment'>-- | Given a 'TyCon',and the args to which it is applied,</span>
<a name="line-2968"></a><span class='hs-comment'>-- suppress the args that are implicit</span>
<a name="line-2969"></a><span class='hs-definition'>suppressInvisibles</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-2970"></a><span class='hs-definition'>suppressInvisibles</span> <span class='hs-varid'>to_type</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xs</span>
<a name="line-2971"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintExplicitKinds</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xs</span>
<a name="line-2972"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>partitionInvisibles</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>to_type</span> <span class='hs-varid'>xs</span>
<a name="line-2973"></a>
<a name="line-2974"></a><a name="pprTyList"></a><span class='hs-comment'>----------------</span>
<a name="line-2975"></a><span class='hs-definition'>pprTyList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2976"></a><span class='hs-comment'>-- Given a type-level list (t1 ': t2), see if we can print</span>
<a name="line-2977"></a><span class='hs-comment'>-- it in list notation [t1, ...].</span>
<a name="line-2978"></a><span class='hs-definition'>pprTyList</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2979"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>gather</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>of</span>
<a name="line-2980"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'\''</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span>
<a name="line-2981"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2982"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-2983"></a>                            <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_type</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-2984"></a>                               <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_type</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tl</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2985"></a>  <span class='hs-keyword'>where</span>
<a name="line-2986"></a>    <span class='hs-varid'>gather</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-2987"></a>     <span class='hs-comment'>-- (gather ty) = (tys, Nothing) means ty is a list [t1, .., tn]</span>
<a name="line-2988"></a>     <span class='hs-comment'>--             = (tys, Just tl) means ty is of form t1:t2:...tn:tl</span>
<a name="line-2989"></a>    <span class='hs-varid'>gather</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2990"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>consDataConKey</span>
<a name="line-2991"></a>      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-sel'>_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span>
<a name="line-2992"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>tl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gather</span> <span class='hs-varid'>ty2</span>
<a name="line-2993"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>tl</span><span class='hs-layout'>)</span>
<a name="line-2994"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>nilDataConKey</span>
<a name="line-2995"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-2996"></a>    <span class='hs-varid'>gather</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2997"></a>
<a name="line-2998"></a><a name="pprInfixApp"></a><span class='hs-comment'>----------------</span>
<a name="line-2999"></a><span class='hs-definition'>pprInfixApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3000"></a><span class='hs-definition'>pprInfixApp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>pp_tc</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3001"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TyOpPrec</span> <span class='hs-varop'>$</span>
<a name="line-3002"></a>    <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pp</span> <span class='hs-conid'>TyOpPrec</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprInfixVar</span> <span class='hs-conid'>True</span> <span class='hs-varid'>pp_tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp</span> <span class='hs-conid'>TyOpPrec</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-3003"></a>
<a name="line-3004"></a><a name="pprPrefixApp"></a><span class='hs-definition'>pprPrefixApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3005"></a><span class='hs-definition'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pp_fun</span> <span class='hs-varid'>pp_tys</span>
<a name="line-3006"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>pp_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_fun</span>
<a name="line-3007"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varop'>$</span>
<a name="line-3008"></a>                  <span class='hs-varid'>hang</span> <span class='hs-varid'>pp_fun</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-varid'>pp_tys</span><span class='hs-layout'>)</span>
<a name="line-3009"></a><a name="pprArrowChain"></a><span class='hs-comment'>----------------</span>
<a name="line-3010"></a><span class='hs-definition'>pprArrowChain</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3011"></a><span class='hs-comment'>-- pprArrowChain p [a,b,c]  generates   a -&gt; b -&gt; c</span>
<a name="line-3012"></a><span class='hs-definition'>pprArrowChain</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-3013"></a><span class='hs-definition'>pprArrowChain</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-3014"></a>                             <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>arrow</span> <span class='hs-varop'>&lt;+&gt;</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3015"></a>
<a name="line-3016"></a><span class='hs-comment'>{-
<a name="line-3017"></a>%************************************************************************
<a name="line-3018"></a>%*                                                                      *
<a name="line-3019"></a>\subsection{TidyType}
<a name="line-3020"></a>%*                                                                      *
<a name="line-3021"></a>%************************************************************************
<a name="line-3022"></a>-}</span>
<a name="line-3023"></a>
<a name="line-3024"></a><a name="tidyTyCoVarBndrs"></a><span class='hs-comment'>-- | This tidies up a type for printing in an error message, or in</span>
<a name="line-3025"></a><span class='hs-comment'>-- an interface file.</span>
<a name="line-3026"></a><span class='hs-comment'>--</span>
<a name="line-3027"></a><span class='hs-comment'>-- It doesn't change the uniques at all, just the print names.</span>
<a name="line-3028"></a><span class='hs-definition'>tidyTyCoVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3029"></a><span class='hs-definition'>tidyTyCoVarBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyTyCoVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tvs</span>
<a name="line-3030"></a>
<a name="line-3031"></a><a name="tidyTyCoVarBndr"></a><span class='hs-definition'>tidyTyCoVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span>
<a name="line-3032"></a><span class='hs-definition'>tidyTyCoVarBndr</span> <span class='hs-varid'>tidy_env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvar</span>
<a name="line-3033"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tidyOccName</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>occ1</span> <span class='hs-keyword'>of</span>
<a name="line-3034"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>tidy'</span><span class='hs-layout'>,</span> <span class='hs-varid'>occ'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tidy'</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar'</span><span class='hs-layout'>)</span>
<a name="line-3035"></a>        <span class='hs-keyword'>where</span>
<a name="line-3036"></a>          <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>tyvar'</span>
<a name="line-3037"></a>          <span class='hs-varid'>tyvar'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>setTyVarName</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>name'</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind'</span>
<a name="line-3038"></a>          <span class='hs-varid'>name'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyNameOcc</span> <span class='hs-varid'>name</span> <span class='hs-varid'>occ'</span>
<a name="line-3039"></a>          <span class='hs-varid'>kind'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyKind</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-3040"></a>  <span class='hs-keyword'>where</span>
<a name="line-3041"></a>    <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tyvar</span>
<a name="line-3042"></a>    <span class='hs-varid'>occ</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>name</span>
<a name="line-3043"></a>    <span class='hs-comment'>-- System Names are for unification variables;</span>
<a name="line-3044"></a>    <span class='hs-comment'>-- when we tidy them we give them a trailing "0" (or 1 etc)</span>
<a name="line-3045"></a>    <span class='hs-comment'>-- so that they don't take precedence for the un-modified name</span>
<a name="line-3046"></a>    <span class='hs-comment'>-- Plus, indicating a unification variable in this way is a</span>
<a name="line-3047"></a>    <span class='hs-comment'>-- helpful clue for users</span>
<a name="line-3048"></a>    <span class='hs-varid'>occ1</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSystemName</span> <span class='hs-varid'>name</span>
<a name="line-3049"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tyvar</span>
<a name="line-3050"></a>           <span class='hs-keyword'>then</span> <span class='hs-varid'>mkTyVarOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>occNameString</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>++</span> <span class='hs-str'>"0"</span><span class='hs-layout'>)</span>
<a name="line-3051"></a>           <span class='hs-keyword'>else</span> <span class='hs-varid'>mkVarOcc</span>   <span class='hs-layout'>(</span><span class='hs-varid'>occNameString</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>++</span> <span class='hs-str'>"0"</span><span class='hs-layout'>)</span>
<a name="line-3052"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ</span>
<a name="line-3053"></a>
<a name="line-3054"></a><a name="tidyTyBinder"></a><span class='hs-definition'>tidyTyBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyBinder</span><span class='hs-layout'>)</span>
<a name="line-3055"></a><span class='hs-definition'>tidyTyBinder</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-3056"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Named</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-3057"></a>  <span class='hs-keyword'>where</span>
<a name="line-3058"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyCoVarBndr</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>tv</span>
<a name="line-3059"></a><span class='hs-definition'>tidyTyBinder</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3060"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-conid'>Anon</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3061"></a>
<a name="line-3062"></a><a name="tidyTyBinders"></a><span class='hs-definition'>tidyTyBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3063"></a><span class='hs-definition'>tidyTyBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyTyBinder</span>
<a name="line-3064"></a>
<a name="line-3065"></a><a name="tidyFreeTyCoVars"></a><span class='hs-comment'>---------------</span>
<a name="line-3066"></a><span class='hs-definition'>tidyFreeTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-3067"></a><span class='hs-comment'>-- ^ Add the free 'TyVar's to the env in tidy form,</span>
<a name="line-3068"></a><span class='hs-comment'>-- so that we can tidy the type they are free in</span>
<a name="line-3069"></a><span class='hs-definition'>tidyFreeTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>full_occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvars</span>
<a name="line-3070"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyOpenTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>full_occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-3071"></a>
<a name="line-3072"></a>        <span class='hs-comment'>---------------</span>
<a name="line-3073"></a><a name="tidyOpenTyCoVars"></a><span class='hs-definition'>tidyOpenTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3074"></a><span class='hs-definition'>tidyOpenTyCoVars</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyOpenTyCoVar</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tyvars</span>
<a name="line-3075"></a>
<a name="line-3076"></a><a name="tidyOpenTyCoVar"></a><span class='hs-comment'>---------------</span>
<a name="line-3077"></a><span class='hs-definition'>tidyOpenTyCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span>
<a name="line-3078"></a><span class='hs-comment'>-- ^ Treat a new 'TyCoVar' as a binder, and give it a fresh tidy name</span>
<a name="line-3079"></a><span class='hs-comment'>-- using the environment if one has not already been allocated. See</span>
<a name="line-3080"></a><span class='hs-comment'>-- also 'tidyTyCoVarBndr'</span>
<a name="line-3081"></a><span class='hs-definition'>tidyOpenTyCoVar</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvar</span>
<a name="line-3082"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyword'>of</span>
<a name="line-3083"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>tyvar'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar'</span><span class='hs-layout'>)</span>              <span class='hs-comment'>-- Already substituted</span>
<a name="line-3084"></a>        <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3085"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyCoVars</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypeList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3086"></a>          <span class='hs-keyword'>in</span> <span class='hs-varid'>tidyTyCoVarBndr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>tyvar</span>  <span class='hs-comment'>-- Treat it as a binder</span>
<a name="line-3087"></a>
<a name="line-3088"></a><a name="tidyTyVarOcc"></a><span class='hs-comment'>---------------</span>
<a name="line-3089"></a><span class='hs-definition'>tidyTyVarOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-3090"></a><span class='hs-definition'>tidyTyVarOcc</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-3091"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-3092"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updateTyVarKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-3093"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tv'</span>
<a name="line-3094"></a>
<a name="line-3095"></a><a name="tidyTypes"></a><span class='hs-comment'>---------------</span>
<a name="line-3096"></a><span class='hs-definition'>tidyTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-3097"></a><span class='hs-definition'>tidyTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-3098"></a>
<a name="line-3099"></a><a name="tidyType"></a><span class='hs-comment'>---------------</span>
<a name="line-3100"></a><span class='hs-definition'>tidyType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3101"></a><span class='hs-definition'>tidyType</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span>
<a name="line-3102"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTyVarOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3103"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span>
<a name="line-3104"></a>                                    <span class='hs-keyword'>in</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-3105"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-3106"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-3107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-3108"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tvp</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>envp</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3110"></a>  <span class='hs-keyword'>where</span>
<a name="line-3111"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>envp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyCoVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-3112"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3113"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3114"></a>
<a name="line-3115"></a><a name="tidyOpenTypes"></a><span class='hs-comment'>---------------</span>
<a name="line-3116"></a><span class='hs-comment'>-- | Grabs the free type variables, tidies them</span>
<a name="line-3117"></a><span class='hs-comment'>-- and then uses 'tidyType' to work over the type itself</span>
<a name="line-3118"></a><span class='hs-definition'>tidyOpenTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3119"></a><span class='hs-definition'>tidyOpenTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span>
<a name="line-3120"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>trimmed_occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-3121"></a>  <span class='hs-keyword'>where</span>
<a name="line-3122"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTyCoVars</span> <span class='hs-varid'>env</span> <span class='hs-varop'>$</span>
<a name="line-3123"></a>                                <span class='hs-varid'>tyCoVarsOfTypesWellScoped</span> <span class='hs-varid'>tys</span>
<a name="line-3124"></a>    <span class='hs-varid'>trimmed_occ_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initTidyOccEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span>
<a name="line-3125"></a>      <span class='hs-comment'>-- The idea here was that we restrict the new TidyEnv to the</span>
<a name="line-3126"></a>      <span class='hs-comment'>-- _free_ vars of the types, so that we don't gratuitously rename</span>
<a name="line-3127"></a>      <span class='hs-comment'>-- the _bound_ variables of the types.</span>
<a name="line-3128"></a>
<a name="line-3129"></a><a name="tidyOpenType"></a><span class='hs-comment'>---------------</span>
<a name="line-3130"></a><span class='hs-definition'>tidyOpenType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-3131"></a><span class='hs-definition'>tidyOpenType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTypes</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>in</span>
<a name="line-3132"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-3133"></a>
<a name="line-3134"></a><a name="tidyTopType"></a><span class='hs-comment'>---------------</span>
<a name="line-3135"></a><span class='hs-comment'>-- | Calls 'tidyType' on a top-level type (i.e. with an empty tidying environment)</span>
<a name="line-3136"></a><span class='hs-definition'>tidyTopType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3137"></a><span class='hs-definition'>tidyTopType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>ty</span>
<a name="line-3138"></a>
<a name="line-3139"></a><a name="tidyOpenKind"></a><span class='hs-comment'>---------------</span>
<a name="line-3140"></a><span class='hs-definition'>tidyOpenKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-3141"></a><span class='hs-definition'>tidyOpenKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span>
<a name="line-3142"></a>
<a name="line-3143"></a><a name="tidyKind"></a><span class='hs-definition'>tidyKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-3144"></a><span class='hs-definition'>tidyKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span>
<a name="line-3145"></a>
<a name="line-3146"></a><a name="tidyCo"></a><span class='hs-comment'>----------------</span>
<a name="line-3147"></a><span class='hs-definition'>tidyCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-3148"></a><span class='hs-definition'>tidyCo</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-3149"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3150"></a>  <span class='hs-keyword'>where</span>
<a name="line-3151"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3152"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-3153"></a>                               <span class='hs-keyword'>in</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-3154"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-3155"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>h</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tvp</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>envp</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3156"></a>                               <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>envp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyCoVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-3157"></a>            <span class='hs-comment'>-- the case above duplicates a bit of work in tidying h and the kind</span>
<a name="line-3158"></a>            <span class='hs-comment'>-- of tv. But the alternative is to use coercionKind, which seems worse.</span>
<a name="line-3159"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span> <span class='hs-keyword'>of</span>
<a name="line-3160"></a>                                 <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-3161"></a>                                 <span class='hs-conid'>Just</span> <span class='hs-varid'>cv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv'</span>
<a name="line-3162"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-3163"></a>                               <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span>
<a name="line-3164"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span>
<a name="line-3165"></a>                                <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t2</span>
<a name="line-3166"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3167"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-3168"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3169"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3170"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-3171"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-3172"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3173"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3174"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cos1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-3175"></a>                               <span class='hs-keyword'>in</span> <span class='hs-varid'>cos1</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cos1</span>
<a name="line-3176"></a>
<a name="line-3177"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnsafeCoerceProv</span>
<a name="line-3178"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3179"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3180"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-3181"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-3182"></a>
<a name="line-3183"></a><a name="tidyCos"></a><span class='hs-definition'>tidyCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-3184"></a><span class='hs-definition'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
</pre></body>
</html>
