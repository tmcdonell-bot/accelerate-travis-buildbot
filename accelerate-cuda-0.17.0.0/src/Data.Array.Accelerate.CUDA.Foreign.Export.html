<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns             #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE CPP                      #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances        #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE ForeignFunctionInterface #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE GADTs                    #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE ImpredicativeTypes       #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE QuasiQuotes              #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes               #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables      #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell          #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies             #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns             #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-name-shadowing #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans        #-}</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- Module      : Data.Array.Accelerate.CUDA.Foreign.Export</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- Copyright   : [2013..2014] Manuel M T Chakravarty, Gabriele Keller, Trevor L. McDonell, Robert Clifton-Everest</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- License     : BSD3</span><span>
</span><a name="line-19"></a><span class="hs-comment">--</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- Maintainer  : Robert Clifton-Everest &lt;robertce@cse.unsw.edu.au&gt;</span><span>
</span><a name="line-21"></a><span class="hs-comment">-- Stability   : experimental</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- Portability : non-portable (GHC extensions)</span><span>
</span><a name="line-23"></a><span class="hs-comment">--</span><span>
</span><a name="line-24"></a><span class="hs-comment">-- This module is intended to allow the calling of Accelerate functions from</span><span>
</span><a name="line-25"></a><span class="hs-comment">-- within CUDA C/C++code. See the nbody/visualizer example in the accelerate-examples</span><span>
</span><a name="line-26"></a><span class="hs-comment">-- package to see how it is used.</span><span>
</span><a name="line-27"></a><span class="hs-comment">--</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">Export</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-comment">-- ** Functions callable from foreign code</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-comment">-- In order to call these from from C, see the corresponding C function signature.</span><span>
</span><a name="line-33"></a><span>  </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#accelerateCreate"><span class="hs-identifier hs-var">accelerateCreate</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#accelerateDestroy"><span class="hs-identifier hs-var">accelerateDestroy</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#freeOutput"><span class="hs-identifier hs-var">freeOutput</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#freeProgram"><span class="hs-identifier hs-var">freeProgram</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>  </span><span class="hs-comment">-- ** Exporting</span><span>
</span><a name="line-36"></a><span>  </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#exportAfun"><span class="hs-identifier hs-var">exportAfun</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#buildExported"><span class="hs-identifier hs-var">buildExported</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-comment">-- ** Types</span><span>
</span><a name="line-39"></a><span>  </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#InputArray"><span class="hs-identifier hs-type">InputArray</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#OutputArray"><span class="hs-identifier hs-type">OutputArray</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ShapeBuffer"><span class="hs-identifier hs-type">ShapeBuffer</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#DevicePtrBuffer"><span class="hs-identifier hs-type">DevicePtrBuffer</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Functor</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span>                              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">StablePtr</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">C</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">Ptr</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">Storable</span><span>                                 </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Storable</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">Marshal</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span>                            </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">peekArray</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pokeArray</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mallocArray</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">Marshal</span><span class="hs-operator">.</span><span class="hs-identifier">Alloc</span><span>                            </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">free</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span>                              </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">Driver</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CUDA</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span>                                          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">P</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-comment">-- friends</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Smart</span><span>                      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Acc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Data</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.CUDA.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span></a><span>                       </span><span class="hs-special">(</span><span> </span><a href="Data.Array.Accelerate.CUDA.html#run1With"><span class="hs-identifier hs-var">run1With</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.CUDA.Array.Sugar.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Sugar</span></a><span>           </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">shape</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">size</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.CUDA.Array.Data.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Data</span></a><span>            </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="Data.Array.Accelerate.CUDA.Array.Data.html#pokeArray"><span class="hs-identifier hs-var">pokeArray</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Array.Data.html#peekArray"><span class="hs-identifier hs-var">peekArray</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Array.Data.html#mallocArray"><span class="hs-identifier hs-var">mallocArray</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.CUDA.State.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">State</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.CUDA.Context.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span></a><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-comment">-- |A handle foreign code can use to call accelerate functions.</span><span>
</span><a name="line-68"></a><span class="hs-keyword">type</span><span> </span><a name="AccHandle"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#AccHandle"><span class="hs-identifier">AccHandle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-comment">-- |A foreign buffer that represents a shape as an array of ints.</span><span>
</span><a name="line-71"></a><span class="hs-keyword">type</span><span> </span><a name="ShapeBuffer"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ShapeBuffer"><span class="hs-identifier">ShapeBuffer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">-- |A buffer of device pointers</span><span>
</span><a name="line-74"></a><span class="hs-keyword">type</span><span> </span><a name="DevicePtrBuffer"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#DevicePtrBuffer"><span class="hs-identifier">DevicePtrBuffer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">WordPtr</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-comment">-- |The input required from foreign code.</span><span>
</span><a name="line-77"></a><span class="hs-keyword">type</span><span> </span><a name="InputArray"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#InputArray"><span class="hs-identifier">InputArray</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ShapeBuffer"><span class="hs-identifier hs-type">ShapeBuffer</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#DevicePtrBuffer"><span class="hs-identifier hs-type">DevicePtrBuffer</span></a><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span class="hs-comment">-- |A result array from an accelerate program.</span><span>
</span><a name="line-80"></a><span class="hs-keyword">type</span><span> </span><a name="OutputArray"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#OutputArray"><span class="hs-identifier">OutputArray</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ShapeBuffer"><span class="hs-identifier hs-type">ShapeBuffer</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#DevicePtrBuffer"><span class="hs-identifier hs-type">DevicePtrBuffer</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#EArray"><span class="hs-identifier hs-type">EArray</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-comment">-- |Foreign exportable representation of a CUDA device</span><span>
</span><a name="line-83"></a><span class="hs-keyword">type</span><span> </span><a name="Device"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Device"><span class="hs-identifier">Device</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-comment">-- |Foreign representation of a CUDA context.</span><span>
</span><a name="line-86"></a><span class="hs-keyword">type</span><span> </span><a name="ForeignContext"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ForeignContext"><span class="hs-identifier">ForeignContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-comment">-- We need to capture the Arrays constraint</span><span>
</span><a name="line-89"></a><span class="hs-keyword">data</span><span> </span><a name="Afun"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier">Afun</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-90"></a><span>  </span><a name="Afun"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier">Afun</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Arrays</span><span> </span><a href="#local-1628678232"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Arrays</span><span> </span><a href="#local-1628678233"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628678232"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628678233"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628678232"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-comment">{- dummy -}</span><span>
</span><a name="line-93"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628678233"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-comment">{- dummy -}</span><span>
</span><a name="line-94"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier hs-type">Afun</span></a><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-keyword">data</span><span> </span><a name="EArray"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#EArray"><span class="hs-identifier">EArray</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-97"></a><span>  </span><a name="EArray"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#EArray"><span class="hs-identifier">EArray</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Shape</span><span> </span><a href="#local-1628678230"><span class="hs-identifier hs-type">sh</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Elt</span><span> </span><a href="#local-1628678231"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Array</span><span> </span><a href="#local-1628678230"><span class="hs-identifier hs-type">sh</span></a><span> </span><a href="#local-1628678231"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#EArray"><span class="hs-identifier hs-type">EArray</span></a><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-comment">-- We need to export these</span><span>
</span><a name="line-100"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-identifier">export</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">accelerateCreate</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Device"><span class="hs-identifier hs-type">Device</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ForeignContext"><span class="hs-identifier hs-type">ForeignContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#AccHandle"><span class="hs-identifier hs-type">AccHandle</span></a><span>
</span><a name="line-101"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-identifier">export</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">accelerateDestroy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#AccHandle"><span class="hs-identifier hs-type">AccHandle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-identifier">export</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">runProgram</span><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#AccHandle"><span class="hs-identifier hs-type">AccHandle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier hs-type">Afun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#InputArray"><span class="hs-identifier hs-type">InputArray</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#OutputArray"><span class="hs-identifier hs-type">OutputArray</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-identifier">export</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">freeOutput</span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#OutputArray"><span class="hs-identifier hs-type">OutputArray</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-identifier">export</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">freeProgram</span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="#local-1628678357"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Storable</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#InputArray"><span class="hs-identifier hs-type">InputArray</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-107"></a><span>  </span><a name="local-1912610305"><span class="hs-identifier">sizeOf</span></a><span> </span><span class="hs-special">(</span><a name="local-1628678345"><a href="#local-1628678345"><span class="hs-identifier">sh</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678346"><a href="#local-1628678346"><span class="hs-identifier">ptrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678345"><span class="hs-identifier hs-var">sh</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678346"><span class="hs-identifier hs-var">ptrs</span></a><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>  </span><a name="local-1912610304"><span class="hs-identifier">alignment</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>  </span><a name="local-1912610299"><span class="hs-identifier">peek</span></a><span> </span><a name="local-1628678347"><a href="#local-1628678347"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-112"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678348"><a href="#local-1628678348"><span class="hs-identifier">p_sh</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-1628678347"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ShapeBuffer"><span class="hs-identifier hs-type">ShapeBuffer</span></a><span>
</span><a name="line-113"></a><span>    </span><a name="local-1628678349"><a href="#local-1628678349"><span class="hs-identifier">sh</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">peek</span><span> </span><a href="#local-1628678348"><span class="hs-identifier hs-var">p_sh</span></a><span>
</span><a name="line-114"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678350"><a href="#local-1628678350"><span class="hs-identifier">p_ptrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-1628678348"><span class="hs-identifier hs-var">p_sh</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#DevicePtrBuffer"><span class="hs-identifier hs-type">DevicePtrBuffer</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678349"><span class="hs-identifier hs-var">sh</span></a><span>
</span><a name="line-115"></a><span>    </span><a name="local-1628678351"><a href="#local-1628678351"><span class="hs-identifier">ptrs</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">peek</span><span> </span><a href="#local-1628678350"><span class="hs-identifier hs-var">p_ptrs</span></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-1628678349"><span class="hs-identifier hs-var">sh</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628678351"><span class="hs-identifier hs-var">ptrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span>  </span><a name="local-1912610298"><span class="hs-identifier">poke</span></a><span> </span><a name="local-1628678352"><a href="#local-1628678352"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1628678353"><a href="#local-1628678353"><span class="hs-identifier">sh</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678354"><a href="#local-1628678354"><span class="hs-identifier">ptrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-119"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678355"><a href="#local-1628678355"><span class="hs-identifier">p_sh</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-1628678352"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ShapeBuffer"><span class="hs-identifier hs-type">ShapeBuffer</span></a><span>
</span><a name="line-120"></a><span>        </span><a name="local-1628678356"><a href="#local-1628678356"><span class="hs-identifier">p_ptrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-1628678355"><span class="hs-identifier hs-var">p_sh</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#DevicePtrBuffer"><span class="hs-identifier hs-type">DevicePtrBuffer</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678353"><span class="hs-identifier hs-var">sh</span></a><span>
</span><a name="line-121"></a><span>    </span><span class="hs-identifier hs-var">poke</span><span> </span><a href="#local-1628678355"><span class="hs-identifier hs-var">p_sh</span></a><span> </span><a href="#local-1628678353"><span class="hs-identifier hs-var">sh</span></a><span>
</span><a name="line-122"></a><span>    </span><span class="hs-identifier hs-var">poke</span><span> </span><a href="#local-1628678356"><span class="hs-identifier hs-var">p_ptrs</span></a><span> </span><a href="#local-1628678354"><span class="hs-identifier hs-var">ptrs</span></a><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Storable</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#OutputArray"><span class="hs-identifier hs-type">OutputArray</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-125"></a><span>  </span><a name="local-1912610305"><span class="hs-identifier">sizeOf</span></a><span> </span><span class="hs-special">(</span><a name="local-1628678326"><a href="#local-1628678326"><span class="hs-identifier">sh</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678327"><a href="#local-1628678327"><span class="hs-identifier">ptrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678328"><a href="#local-1628678328"><span class="hs-identifier">sa</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678326"><span class="hs-identifier hs-var">sh</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678327"><span class="hs-identifier hs-var">ptrs</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678328"><span class="hs-identifier hs-var">sa</span></a><span>
</span><a name="line-126"></a><span>  </span><a name="local-1912610304"><span class="hs-identifier">alignment</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-127"></a><span>  </span><a name="local-1912610299"><span class="hs-identifier">peek</span></a><span> </span><a name="local-1628678329"><a href="#local-1628678329"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678330"><a href="#local-1628678330"><span class="hs-identifier">p_sh</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-1628678329"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ShapeBuffer"><span class="hs-identifier hs-type">ShapeBuffer</span></a><span>
</span><a name="line-129"></a><span>    </span><a name="local-1628678331"><a href="#local-1628678331"><span class="hs-identifier">sh</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">peek</span><span> </span><a href="#local-1628678330"><span class="hs-identifier hs-var">p_sh</span></a><span>
</span><a name="line-130"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678332"><a href="#local-1628678332"><span class="hs-identifier">p_ptrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-1628678330"><span class="hs-identifier hs-var">p_sh</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#DevicePtrBuffer"><span class="hs-identifier hs-type">DevicePtrBuffer</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678331"><span class="hs-identifier hs-var">sh</span></a><span>
</span><a name="line-131"></a><span>    </span><a name="local-1628678333"><a href="#local-1628678333"><span class="hs-identifier">ptrs</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">peek</span><span> </span><a href="#local-1628678332"><span class="hs-identifier hs-var">p_ptrs</span></a><span>
</span><a name="line-132"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678334"><a href="#local-1628678334"><span class="hs-identifier">p_sa</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-1628678332"><span class="hs-identifier hs-var">p_ptrs</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="#local-1628678335"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678333"><span class="hs-identifier hs-var">ptrs</span></a><span>
</span><a name="line-133"></a><span>    </span><a name="local-1628678336"><a href="#local-1628678336"><span class="hs-identifier">sa</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">peek</span><span> </span><a href="#local-1628678334"><span class="hs-identifier hs-var">p_sa</span></a><span>
</span><a name="line-134"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-1628678331"><span class="hs-identifier hs-var">sh</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628678333"><span class="hs-identifier hs-var">ptrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628678336"><span class="hs-identifier hs-var">sa</span></a><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span>  </span><a name="local-1912610298"><span class="hs-identifier">poke</span></a><span> </span><a name="local-1628678337"><a href="#local-1628678337"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1628678338"><a href="#local-1628678338"><span class="hs-identifier">sh</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678339"><a href="#local-1628678339"><span class="hs-identifier">ptrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678340"><a href="#local-1628678340"><span class="hs-identifier">sa</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678341"><a href="#local-1628678341"><span class="hs-identifier">p_sh</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-1628678337"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ShapeBuffer"><span class="hs-identifier hs-type">ShapeBuffer</span></a><span>
</span><a name="line-137"></a><span>        </span><a name="local-1628678342"><a href="#local-1628678342"><span class="hs-identifier">p_ptrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-1628678341"><span class="hs-identifier hs-var">p_sh</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#DevicePtrBuffer"><span class="hs-identifier hs-type">DevicePtrBuffer</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678338"><span class="hs-identifier hs-var">sh</span></a><span>
</span><a name="line-138"></a><span>        </span><a name="local-1628678343"><a href="#local-1628678343"><span class="hs-identifier">p_sa</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-1628678342"><span class="hs-identifier hs-var">p_ptrs</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="#local-1628678344"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678339"><span class="hs-identifier hs-var">ptrs</span></a><span>
</span><a name="line-139"></a><span>    </span><span class="hs-identifier hs-var">poke</span><span> </span><a href="#local-1628678341"><span class="hs-identifier hs-var">p_sh</span></a><span> </span><a href="#local-1628678338"><span class="hs-identifier hs-var">sh</span></a><span>
</span><a name="line-140"></a><span>    </span><span class="hs-identifier hs-var">poke</span><span> </span><a href="#local-1628678342"><span class="hs-identifier hs-var">p_ptrs</span></a><span> </span><a href="#local-1628678339"><span class="hs-identifier hs-var">ptrs</span></a><span>
</span><a name="line-141"></a><span>    </span><span class="hs-identifier hs-var">poke</span><span> </span><a href="#local-1628678343"><span class="hs-identifier hs-var">p_sa</span></a><span> </span><a href="#local-1628678340"><span class="hs-identifier hs-var">sa</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- |Create an Accelerate handle given a device and a cuda context.</span><span>
</span><a name="line-144"></a><span class="hs-comment">--</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- @AccHandle accelerateCreate(int device, CUcontext ctx);@</span><span>
</span><a name="line-146"></a><span class="hs-identifier">accelerateCreate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Device"><span class="hs-identifier hs-type">Device</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ForeignContext"><span class="hs-identifier hs-type">ForeignContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#AccHandle"><span class="hs-identifier hs-type">AccHandle</span></a><span>
</span><a name="line-147"></a><a name="accelerateCreate"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#accelerateCreate"><span class="hs-identifier">accelerateCreate</span></a></a><span> </span><a name="local-1628678240"><a href="#local-1628678240"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-1628678241"><a href="#local-1628678241"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.Context.html#fromDeviceContext"><span class="hs-identifier hs-var">fromDeviceContext</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CUDA</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Device</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">CInt</span><span> </span><a href="#local-1628678240"><span class="hs-identifier hs-var">dev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CUDA</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Context</span><span> </span><a href="#local-1628678241"><span class="hs-identifier hs-var">ctx</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">newStablePtr</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-comment">-- |Releases all resources used by the accelerate library.</span><span>
</span><a name="line-150"></a><span class="hs-comment">--</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- @void accelerateDestroy(AccHandle hndl);@</span><span>
</span><a name="line-152"></a><span class="hs-identifier">accelerateDestroy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#AccHandle"><span class="hs-identifier hs-type">AccHandle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><a name="accelerateDestroy"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#accelerateDestroy"><span class="hs-identifier">accelerateDestroy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">freeStablePtr</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-comment">-- |Function callable from foreign code to 'free' a OutputArray returned after executing</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- an Accelerate computation.</span><span>
</span><a name="line-157"></a><span class="hs-comment">--</span><span>
</span><a name="line-158"></a><span class="hs-comment">-- Once freed, the device pointers associated with an array are no longer valid.</span><span>
</span><a name="line-159"></a><span class="hs-comment">--</span><span>
</span><a name="line-160"></a><span class="hs-comment">-- @void freeOutput(OutputArray arr);@</span><span>
</span><a name="line-161"></a><span class="hs-identifier">freeOutput</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#OutputArray"><span class="hs-identifier hs-type">OutputArray</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><a name="freeOutput"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#freeOutput"><span class="hs-identifier">freeOutput</span></a></a><span> </span><a name="local-1628678242"><a href="#local-1628678242"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-163"></a><span>  </span><span class="hs-special">(</span><a name="local-1628678243"><a href="#local-1628678243"><span class="hs-identifier">sh</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678244"><a href="#local-1628678244"><span class="hs-identifier">dptrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678245"><a href="#local-1628678245"><span class="hs-identifier">sa</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">peek</span><span> </span><a href="#local-1628678242"><span class="hs-identifier hs-var">o</span></a><span>
</span><a name="line-164"></a><span>  </span><span class="hs-identifier hs-var">free</span><span> </span><a href="#local-1628678243"><span class="hs-identifier hs-var">sh</span></a><span>
</span><a name="line-165"></a><span>  </span><span class="hs-identifier hs-var">free</span><span> </span><a href="#local-1628678244"><span class="hs-identifier hs-var">dptrs</span></a><span>
</span><a name="line-166"></a><span>  </span><span class="hs-identifier hs-var">freeStablePtr</span><span> </span><a href="#local-1628678245"><span class="hs-identifier hs-var">sa</span></a><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-comment">-- |Free a compiled accelerate program.</span><span>
</span><a name="line-169"></a><span class="hs-comment">--</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- @void freeProgram(Program prg);@</span><span>
</span><a name="line-171"></a><span class="hs-identifier">freeProgram</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="#local-1628678239"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-172"></a><a name="freeProgram"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#freeProgram"><span class="hs-identifier">freeProgram</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">freeStablePtr</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-comment">-- |Execute the given accelerate program with @is@ as the input and @os@ as the output.</span><span>
</span><a name="line-175"></a><span class="hs-comment">--</span><span>
</span><a name="line-176"></a><span class="hs-comment">-- @void runProgram(AccHandle hndl, AccProgram p, InputArray* is, OutputArray* os);@</span><span>
</span><a name="line-177"></a><span class="hs-identifier">runProgram</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#AccHandle"><span class="hs-identifier hs-type">AccHandle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier hs-type">Afun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#InputArray"><span class="hs-identifier hs-type">InputArray</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#OutputArray"><span class="hs-identifier hs-type">OutputArray</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><a name="runProgram"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#runProgram"><span class="hs-identifier">runProgram</span></a></a><span> </span><a name="local-1628678246"><a href="#local-1628678246"><span class="hs-identifier">hndl</span></a></a><span> </span><a name="local-1628678247"><a href="#local-1628678247"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-1628678248"><a href="#local-1628678248"><span class="hs-identifier">input</span></a></a><span> </span><a name="local-1628678249"><a href="#local-1628678249"><span class="hs-identifier">output</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-179"></a><span>  </span><a name="local-1628678295"><a href="#local-1628678295"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">deRefStablePtr</span><span> </span><a href="#local-1628678246"><span class="hs-identifier hs-var">hndl</span></a><span>
</span><a name="line-180"></a><span>  </span><a name="local-1628678296"><a href="#local-1628678296"><span class="hs-identifier">af</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">deRefStablePtr</span><span> </span><a href="#local-1628678247"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-181"></a><span>  </span><a href="#local-1628678250"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-1628678295"><span class="hs-identifier hs-var">ctx</span></a><span> </span><a href="#local-1628678296"><span class="hs-identifier hs-var">af</span></a><span>
</span><a name="line-182"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-identifier">run</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier hs-type">Afun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>    </span><a name="local-1628678250"><a href="#local-1628678250"><span class="hs-identifier">run</span></a></a><span> </span><a name="local-1628678255"><a href="#local-1628678255"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier hs-var">Afun</span></a><span> </span><a name="local-1628678256"><a href="#local-1628678256"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628678257"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628678258"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-185"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Array.Accelerate.CUDA.State.html#evalCUDA"><span class="hs-identifier hs-var">evalCUDA</span></a><span> </span><a href="#local-1628678255"><span class="hs-identifier hs-var">ctx</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-special">(</span><a name="local-1628678259"><a href="#local-1628678259"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628678251"><span class="hs-identifier hs-var">marshalIn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">arrays</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628678257"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1628678248"><span class="hs-identifier hs-var">input</span></a><span>
</span><a name="line-187"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-1628678260"><a href="#local-1628678260"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628678256"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toArr</span><span> </span><a href="#local-1628678259"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>        </span><a href="#local-1628678252"><span class="hs-identifier hs-var">marshalOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">arrays</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628678258"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromArr</span><span> </span><a href="#local-1628678260"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628678249"><span class="hs-identifier hs-var">output</span></a><span>
</span><a name="line-189"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span>    </span><span class="hs-identifier">marshalIn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ArraysR</span><span> </span><a href="#local-1628678253"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#InputArray"><span class="hs-identifier hs-type">InputArray</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.State.html#CIO"><span class="hs-identifier hs-type">CIO</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628678253"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#InputArray"><span class="hs-identifier hs-type">InputArray</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>    </span><a name="local-1628678251"><a href="#local-1628678251"><span class="hs-identifier">marshalIn</span></a></a><span> </span><span class="hs-identifier hs-var">ArraysRunit</span><span>  </span><a name="local-1628678261"><a href="#local-1628678261"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-1628678261"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-identifier">marshalIn</span><span> </span><span class="hs-identifier hs-var">ArraysRarray</span><span> </span><a name="local-1628678262"><a href="#local-1628678262"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-194"></a><span>      </span><span class="hs-special">(</span><a name="local-1628678263"><a href="#local-1628678263"><span class="hs-identifier">sh</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678264"><a href="#local-1628678264"><span class="hs-identifier">ptrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">peek</span><span> </span><a href="#local-1628678262"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>      </span><a name="local-1628678265"><a href="#local-1628678265"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#arrayFromForeignData"><span class="hs-identifier hs-var">arrayFromForeignData</span></a><span> </span><a href="#local-1628678264"><span class="hs-identifier hs-var">ptrs</span></a><span> </span><a href="#local-1628678263"><span class="hs-identifier hs-var">sh</span></a><span>
</span><a name="line-196"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678266"><a href="#local-1628678266"><span class="hs-identifier">ptr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusPtr</span><span> </span><a href="#local-1628678262"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sizeOf</span><span> </span><span class="hs-special">(</span><a href="#local-1628678263"><span class="hs-identifier hs-var">sh</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628678264"><span class="hs-identifier hs-var">ptrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-1628678265"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628678266"><span class="hs-identifier hs-var">ptr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>    </span><span class="hs-identifier">marshalIn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArraysRpair</span><span> </span><a name="local-1628678267"><a href="#local-1628678267"><span class="hs-identifier">aR1</span></a></a><span> </span><a name="local-1628678268"><a href="#local-1628678268"><span class="hs-identifier">aR2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628678269"><a href="#local-1628678269"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-199"></a><span>      </span><span class="hs-special">(</span><a name="local-1628678270"><a href="#local-1628678270"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678271"><a href="#local-1628678271"><span class="hs-identifier">ptr'</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628678251"><span class="hs-identifier hs-var">marshalIn</span></a><span> </span><a href="#local-1628678267"><span class="hs-identifier hs-var">aR1</span></a><span> </span><a href="#local-1628678269"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-200"></a><span>      </span><span class="hs-special">(</span><a name="local-1628678272"><a href="#local-1628678272"><span class="hs-identifier">y</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628678273"><a href="#local-1628678273"><span class="hs-identifier">ptr''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628678251"><span class="hs-identifier hs-var">marshalIn</span></a><span> </span><a href="#local-1628678268"><span class="hs-identifier hs-var">aR2</span></a><span> </span><a href="#local-1628678271"><span class="hs-identifier hs-var">ptr'</span></a><span>
</span><a name="line-201"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-1628678270"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-1628678272"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-1628678273"><span class="hs-identifier hs-var">ptr''</span></a><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>    </span><span class="hs-identifier">marshalOut</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ArraysR</span><span> </span><a href="#local-1628678254"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628678254"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#OutputArray"><span class="hs-identifier hs-type">OutputArray</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.State.html#CIO"><span class="hs-identifier hs-type">CIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#OutputArray"><span class="hs-identifier hs-type">OutputArray</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>    </span><a name="local-1628678252"><a href="#local-1628678252"><span class="hs-identifier">marshalOut</span></a></a><span> </span><span class="hs-identifier hs-var">ArraysRunit</span><span>  </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a name="local-1628678274"><a href="#local-1628678274"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-1628678274"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-205"></a><span>    </span><span class="hs-identifier">marshalOut</span><span> </span><span class="hs-identifier hs-var">ArraysRarray</span><span> </span><a name="local-1628678275"><a href="#local-1628678275"><span class="hs-identifier">a</span></a></a><span>  </span><a name="local-1628678276"><a href="#local-1628678276"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-206"></a><span>      </span><a name="local-1628678288"><a href="#local-1628678288"><span class="hs-identifier">oarr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628678277"><span class="hs-identifier hs-var">mkOutput</span></a><span> </span><a href="#local-1628678275"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-207"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">poke</span><span> </span><a href="#local-1628678276"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-1628678288"><span class="hs-identifier hs-var">oarr</span></a><span>
</span><a name="line-208"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">plusPtr</span><span> </span><a href="#local-1628678276"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sizeOf</span><span> </span><a href="#local-1628678288"><span class="hs-identifier hs-var">oarr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-identifier">mkOutput</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1628678278"><a href="#local-1628678278"><span class="hs-identifier">sh</span></a></a><span> </span><a name="local-1628678279"><a href="#local-1628678279"><span class="hs-identifier">e</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Shape</span><span> </span><a href="#local-1628678278"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Array</span><span> </span><a href="#local-1628678278"><span class="hs-identifier hs-type">sh</span></a><span> </span><a href="#local-1628678279"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.State.html#CIO"><span class="hs-identifier hs-type">CIO</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#OutputArray"><span class="hs-identifier hs-type">OutputArray</span></a><span>
</span><a name="line-211"></a><span>        </span><a name="local-1628678277"><a href="#local-1628678277"><span class="hs-identifier">mkOutput</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Array</span><span> </span><a name="local-1628678280"><a href="#local-1628678280"><span class="hs-identifier">sh</span></a></a><span> </span><a name="local-1628678281"><a href="#local-1628678281"><span class="hs-identifier">adata</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-212"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678282"><a href="#local-1628678282"><span class="hs-identifier">sh'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">shapeToList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toElt</span><span> </span><a href="#local-1628678280"><span class="hs-identifier hs-var">sh</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628678278"><span class="hs-identifier hs-type">sh</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>          </span><a name="local-1628678283"><a href="#local-1628678283"><span class="hs-identifier">shbuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mallocArray</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">P</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1628678282"><span class="hs-identifier hs-var">sh'</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pokeArray</span><span> </span><a href="#local-1628678283"><span class="hs-identifier hs-var">shbuf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-1628678282"><span class="hs-identifier hs-var">sh'</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span>          </span><a href="Data.Array.Accelerate.CUDA.Array.Data.html#withDevicePtrs"><span class="hs-identifier hs-var">withDevicePtrs</span></a><span> </span><a href="#local-1628678281"><span class="hs-identifier hs-var">adata</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1628678284"><a href="#local-1628678284"><span class="hs-identifier">dptrs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-217"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678285"><a href="#local-1628678285"><span class="hs-identifier">wptrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.Array.Data.html#devicePtrsToWordPtrs"><span class="hs-identifier hs-var">devicePtrsToWordPtrs</span></a><span> </span><a href="#local-1628678281"><span class="hs-identifier hs-var">adata</span></a><span> </span><a href="#local-1628678284"><span class="hs-identifier hs-var">dptrs</span></a><span>
</span><a name="line-218"></a><span>            </span><a name="local-1628678286"><a href="#local-1628678286"><span class="hs-identifier">pbuf</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mallocArray</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">P</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1628678285"><span class="hs-identifier hs-var">wptrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pokeArray</span><span> </span><a href="#local-1628678286"><span class="hs-identifier hs-var">pbuf</span></a><span> </span><a href="#local-1628678285"><span class="hs-identifier hs-var">wptrs</span></a><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>            </span><a name="local-1628678287"><a href="#local-1628678287"><span class="hs-identifier">sa</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newStablePtr</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#EArray"><span class="hs-identifier hs-var">EArray</span></a><span> </span><a href="#local-1628678275"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-1628678283"><span class="hs-identifier hs-var">shbuf</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628678286"><span class="hs-identifier hs-var">pbuf</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628678287"><span class="hs-identifier hs-var">sa</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span>    </span><span class="hs-identifier">marshalOut</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArraysRpair</span><span> </span><a name="local-1628678289"><a href="#local-1628678289"><span class="hs-identifier">aR1</span></a></a><span> </span><a name="local-1628678290"><a href="#local-1628678290"><span class="hs-identifier">aR2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1628678291"><a href="#local-1628678291"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><a name="local-1628678292"><a href="#local-1628678292"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628678293"><a href="#local-1628678293"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-225"></a><span>      </span><a name="local-1628678294"><a href="#local-1628678294"><span class="hs-identifier">ptr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628678252"><span class="hs-identifier hs-var">marshalOut</span></a><span> </span><a href="#local-1628678289"><span class="hs-identifier hs-var">aR1</span></a><span> </span><a href="#local-1628678291"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-1628678293"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-226"></a><span>      </span><a href="#local-1628678252"><span class="hs-identifier hs-var">marshalOut</span></a><span> </span><a href="#local-1628678290"><span class="hs-identifier hs-var">aR2</span></a><span> </span><a href="#local-1628678292"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-1628678294"><span class="hs-identifier hs-var">ptr'</span></a><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-comment">-- |Given the 'Name' of an Accelerate function (a function of type ''Acc a -&gt; Acc b'') generate a</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- a function callable from foreign code with the second argument specifying it's name.</span><span>
</span><a name="line-231"></a><span class="hs-identifier">exportAfun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-232"></a><a name="exportAfun"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#exportAfun"><span class="hs-identifier">exportAfun</span></a></a><span> </span><a name="local-1628678297"><a href="#local-1628678297"><span class="hs-identifier">fname</span></a></a><span> </span><a name="local-1628678298"><a href="#local-1628678298"><span class="hs-identifier">ename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-233"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &lt;= 710</span><span>
</span><a name="line-234"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier">VarI</span><span> </span><span class="hs-identifier">n</span><span> </span><span class="hs-identifier">ty</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">reify</span><span> </span><span class="hs-identifier">fname</span><span>
</span><a name="line-235"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-236"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarI</span><span> </span><a name="local-1628678299"><a href="#local-1628678299"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628678300"><a href="#local-1628678300"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reify</span><span> </span><a href="#local-1628678297"><span class="hs-identifier hs-var">fname</span></a><span>
</span><a name="line-237"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span>  </span><span class="hs-comment">-- Generate initialisation function</span><span>
</span><a name="line-240"></a><span>  </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#genCompileFun"><span class="hs-identifier hs-var">genCompileFun</span></a><span> </span><a href="#local-1628678299"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1628678298"><span class="hs-identifier hs-var">ename</span></a><span> </span><a href="#local-1628678300"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-identifier">genCompileFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-243"></a><a name="genCompileFun"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#genCompileFun"><span class="hs-identifier">genCompileFun</span></a></a><span> </span><a name="local-1628678301"><a href="#local-1628678301"><span class="hs-identifier">fname</span></a></a><span> </span><a name="local-1628678302"><a href="#local-1628678302"><span class="hs-identifier">ename</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppT</span><span> </span><span class="hs-identifier hs-var">ArrowT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppT</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppT</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">[</span><a href="#local-1628678307"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628678305"><span class="hs-identifier hs-var">dec</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628678308"><span class="hs-identifier hs-var">expt</span></a><span class="hs-special">]</span><span>
</span><a name="line-245"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-246"></a><span>    </span><a name="local-1628678303"><a href="#local-1628678303"><span class="hs-identifier">initName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkName</span><span> </span><a href="#local-1628678302"><span class="hs-identifier hs-var">ename</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span>    </span><a name="local-1628678304"><a href="#local-1628678304"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-glyph">|</span><span> </span><span class="hs-glyph">\</span><a name="local-1628678310"><a href="#local-1628678310"><span class="hs-identifier">hndl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#buildExported"><span class="hs-identifier hs-var">buildExported</span></a><span> </span><a href="#local-1628678310"><span class="hs-identifier hs-var">hndl</span></a><span> </span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-1628678301"><span class="hs-identifier hs-var">fname</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-249"></a><span>    </span><a name="local-1628678305"><a href="#local-1628678305"><span class="hs-identifier">dec</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FunD</span><span> </span><a href="#local-1628678303"><span class="hs-identifier hs-var">initName</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-1628678306"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-250"></a><span>    </span><a name="local-1628678306"><a href="#local-1628678306"><span class="hs-identifier">cls</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Clause</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NormalB</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-1628678304"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-251"></a><span>    </span><a name="local-1628678307"><a href="#local-1628678307"><span class="hs-identifier">sig</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SigD</span><span> </span><a href="#local-1628678303"><span class="hs-identifier hs-var">initName</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-1628678309"><span class="hs-identifier hs-var">ety</span></a><span>
</span><a name="line-252"></a><span>    </span><a name="local-1628678308"><a href="#local-1628678308"><span class="hs-identifier">expt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ForeignD</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExportF</span><span> </span><span class="hs-identifier hs-var">cCall</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-1628678303"><span class="hs-identifier hs-var">initName</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628678303"><span class="hs-identifier hs-var">initName</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-1628678309"><span class="hs-identifier hs-var">ety</span></a><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span>    </span><a name="local-1628678309"><a href="#local-1628678309"><span class="hs-identifier">ety</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">t</span><span class="hs-glyph">|</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#AccHandle"><span class="hs-identifier hs-type">AccHandle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier hs-type">Afun</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-255"></a><span class="hs-identifier">genCompileFun</span><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-identifier">_</span><span>     </span><span class="hs-identifier">_</span><span>
</span><a name="line-256"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Invalid accelerate function&quot;</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-comment">-- |Given a handle and an Accelerate function, generate an exportable version.</span><span>
</span><a name="line-259"></a><span class="hs-identifier">buildExported</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1628678237"><a href="#local-1628678237"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-1628678238"><a href="#local-1628678238"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Arrays</span><span> </span><a href="#local-1628678237"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Arrays</span><span> </span><a href="#local-1628678238"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#AccHandle"><span class="hs-identifier hs-type">AccHandle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Acc</span><span> </span><a href="#local-1628678237"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Acc</span><span> </span><a href="#local-1628678238"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier hs-type">Afun</span></a><span class="hs-special">)</span><span>
</span><a name="line-260"></a><a name="buildExported"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#buildExported"><span class="hs-identifier">buildExported</span></a></a><span> </span><a name="local-1628678312"><a href="#local-1628678312"><span class="hs-identifier">hndl</span></a></a><span> </span><a name="local-1628678313"><a href="#local-1628678313"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628678314"><span class="hs-identifier hs-var">ef</span></a><span>
</span><a name="line-261"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-262"></a><span>    </span><span class="hs-identifier">ef</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StablePtr</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier hs-type">Afun</span></a><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>    </span><a name="local-1628678314"><a href="#local-1628678314"><span class="hs-identifier">ef</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-264"></a><span>      </span><a name="local-1628678315"><a href="#local-1628678315"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">deRefStablePtr</span><span> </span><a href="#local-1628678312"><span class="hs-identifier hs-var">hndl</span></a><span>
</span><a name="line-265"></a><span>      </span><span class="hs-identifier hs-var">newStablePtr</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#Afun"><span class="hs-identifier hs-var">Afun</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.html#run1With"><span class="hs-identifier hs-var">run1With</span></a><span> </span><a href="#local-1628678315"><span class="hs-identifier hs-var">ctx</span></a><span> </span><a href="#local-1628678313"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628678237"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628678238"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span class="hs-comment">-- Utility functions</span><span>
</span><a name="line-268"></a><span class="hs-comment">-- ------------------</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-identifier">arrayFromForeignData</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1628678235"><a href="#local-1628678235"><span class="hs-identifier">sh</span></a></a><span> </span><a name="local-1628678236"><a href="#local-1628678236"><span class="hs-identifier">e</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Shape</span><span> </span><a href="#local-1628678235"><span class="hs-identifier hs-type">sh</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Elt</span><span> </span><a href="#local-1628678236"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#DevicePtrBuffer"><span class="hs-identifier hs-type">DevicePtrBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#ShapeBuffer"><span class="hs-identifier hs-type">ShapeBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.State.html#CIO"><span class="hs-identifier hs-type">CIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Array</span><span> </span><a href="#local-1628678235"><span class="hs-identifier hs-type">sh</span></a><span> </span><a href="#local-1628678236"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-271"></a><a name="arrayFromForeignData"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#arrayFromForeignData"><span class="hs-identifier">arrayFromForeignData</span></a></a><span> </span><a name="local-1628678316"><a href="#local-1628678316"><span class="hs-identifier">ptrs</span></a></a><span> </span><a name="local-1628678317"><a href="#local-1628678317"><span class="hs-identifier">shape</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-272"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678318"><a href="#local-1628678318"><span class="hs-identifier">d</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">rank</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ignore</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628678235"><span class="hs-identifier hs-type">sh</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Using ignore as using dim requires a non-dummy argument</span><span>
</span><a name="line-273"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678319"><a href="#local-1628678319"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#eltSize"><span class="hs-identifier hs-var">eltSize</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eltType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628678236"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>   </span><a name="local-1628678320"><a href="#local-1628678320"><span class="hs-identifier">lst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">peekArray</span><span> </span><a href="#local-1628678318"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-1628678317"><span class="hs-identifier hs-var">shape</span></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678321"><a href="#local-1628678321"><span class="hs-identifier">sh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToShape</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-1628678320"><span class="hs-identifier hs-var">lst</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628678235"><span class="hs-identifier hs-type">sh</span></a><span>
</span><a name="line-276"></a><span>   </span><a name="local-1628678322"><a href="#local-1628678322"><span class="hs-identifier">plst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">peekArray</span><span> </span><a href="#local-1628678319"><span class="hs-identifier hs-var">sz</span></a><span> </span><a href="#local-1628678316"><span class="hs-identifier hs-var">ptrs</span></a><span>
</span><a name="line-277"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-1628678323"><a href="#local-1628678323"><span class="hs-identifier">ptrs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.Array.Data.html#devicePtrsFromList"><span class="hs-identifier hs-var">devicePtrsFromList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">arrayElt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ArrayEltR</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">EltRepr</span><span> </span><a href="#local-1628678236"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1628678322"><span class="hs-identifier hs-var">plst</span></a><span>
</span><a name="line-278"></a><span>   </span><a href="Data.Array.Accelerate.CUDA.Array.Data.html#useDevicePtrs"><span class="hs-identifier hs-var">useDevicePtrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromElt</span><span> </span><a href="#local-1628678321"><span class="hs-identifier hs-var">sh</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628678323"><span class="hs-identifier hs-var">ptrs'</span></a><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-identifier">eltSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TupleType</span><span> </span><a href="#local-1628678234"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-281"></a><a name="eltSize"><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#eltSize"><span class="hs-identifier">eltSize</span></a></a><span> </span><span class="hs-identifier hs-var">UnitTuple</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-282"></a><span class="hs-identifier">eltSize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SingleTuple</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-283"></a><span class="hs-identifier">eltSize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PairTuple</span><span>   </span><a name="local-1628678324"><a href="#local-1628678324"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-1628678325"><a href="#local-1628678325"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#eltSize"><span class="hs-identifier hs-var">eltSize</span></a><span> </span><a href="#local-1628678324"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="Data.Array.Accelerate.CUDA.Foreign.Export.html#eltSize"><span class="hs-identifier hs-var">eltSize</span></a><span> </span><a href="#local-1628678325"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a></pre></body></html>