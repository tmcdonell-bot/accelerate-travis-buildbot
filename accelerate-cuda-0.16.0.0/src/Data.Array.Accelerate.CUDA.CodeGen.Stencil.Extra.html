<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ImpredicativeTypes  #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE QuasiQuotes         #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell     #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns        #-}</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Module      : Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Copyright   : [2008..2014] Manuel M T Chakravarty, Gabriele Keller</span><span>
</span><a name="line-9"></a><span class="hs-comment">--               [2009..2014] Trevor L. McDonell</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- License     : BSD3</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Maintainer  : Trevor L. McDonell &lt;tmcdonell@cse.unsw.edu.au&gt;</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- Stability   : experimental</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- Portability : non-portable (GHC extensions)</span><span>
</span><a name="line-15"></a><span class="hs-comment">--</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">CodeGen</span><span class="hs-operator">.</span><span class="hs-identifier">Stencil</span><span class="hs-operator">.</span><span class="hs-identifier">Extra</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>  </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#stencilAccess"><span class="hs-identifier hs-var">stencilAccess</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span>  </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cinRange"><span class="hs-identifier hs-var">cinRange</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cclamp"><span class="hs-identifier hs-var">cclamp</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cmirror"><span class="hs-identifier hs-var">cmirror</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cwrap"><span class="hs-identifier hs-var">cwrap</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#insideRegion"><span class="hs-identifier hs-var">insideRegion</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#borderRegion"><span class="hs-identifier hs-var">borderRegion</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-comment">-- standard library</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span>                                          </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">and</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zipWith3</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>                                        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">transpose</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-comment">-- language-c</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">C</span><span class="hs-operator">.</span><span class="hs-identifier">Quote</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">C</span><span class="hs-operator">.</span><span class="hs-identifier">Syntax</span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">C</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-comment">-- friends</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span><span>                      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">internalError</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span>                       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Boundary</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Sugar</span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Array</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Shape</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Elt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">shapeToList</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Analysis</span><span class="hs-operator">.</span><span class="hs-identifier">Shape</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">Analysis</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.CUDA.AST.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">AST</span></a><span>                   </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">stencil</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stencilAccess</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">CodeGen</span><span class="hs-operator">.</span><span class="hs-identifier">Base</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Type.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">CodeGen</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span></a><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">-- Stencil Access</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- --------------</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-comment">-- Generate declarations for reading in a stencil pattern surrounding a given</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- focal point.</span><span>
</span><a name="line-52"></a><span class="hs-comment">--</span><span>
</span><a name="line-53"></a><span class="hs-identifier">stencilAccess</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1627859160"><a href="#local-1627859160"><span class="hs-identifier">aenv</span></a></a><span> </span><a name="local-1627859161"><a href="#local-1627859161"><span class="hs-identifier">sh</span></a></a><span> </span><a name="local-1627859162"><a href="#local-1627859162"><span class="hs-identifier">e</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Shape</span><span> </span><a href="#local-1627859161"><span class="hs-identifier hs-type">sh</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Elt</span><span> </span><a href="#local-1627859162"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DeviceProperties</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                             </span><span class="hs-comment">-- can we use linear indexing?</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                             </span><span class="hs-comment">-- do we need to do bounds checking?</span><span>
</span><a name="line-58"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>                             </span><span class="hs-comment">-- array group name</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>                             </span><span class="hs-comment">-- group name for array shape (hax!)</span><span>
</span><a name="line-60"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>                             </span><span class="hs-comment">-- seed name for temporary variables</span><span>
</span><a name="line-61"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>                             </span><span class="hs-comment">-- linear index at the focus</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859161"><span class="hs-identifier hs-type">sh</span></a><span class="hs-special">]</span><span>                             </span><span class="hs-comment">-- list of offset indices</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Boundary</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUExp"><span class="hs-identifier hs-type">CUExp</span></a><span> </span><a href="#local-1627859160"><span class="hs-identifier hs-type">aenv</span></a><span> </span><a href="#local-1627859162"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- stencil boundary condition</span><span>
</span><a name="line-64"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Eliminate"><span class="hs-identifier hs-type">Eliminate</span></a><span> </span><a href="#local-1627859162"><span class="hs-identifier hs-type">e</span></a><span>                      </span><span class="hs-comment">-- dead code elimination flags</span><span>
</span><a name="line-65"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Definition</span><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- kernel texture reference definitions</span><span>
</span><a name="line-66"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Param</span><span class="hs-special">]</span><span>                      </span><span class="hs-comment">-- kernel function arguments</span><span>
</span><a name="line-67"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Instantiate1"><span class="hs-identifier hs-type">Instantiate1</span></a><span> </span><a href="#local-1627859161"><span class="hs-identifier hs-type">sh</span></a><span> </span><a href="#local-1627859162"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-special">)</span><span>            </span><span class="hs-comment">-- access stencil at given multidimensional index</span><span>
</span><a name="line-68"></a><a name="stencilAccess"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#stencilAccess"><span class="hs-identifier">stencilAccess</span></a></a><span> </span><a name="local-1627859163"><a href="#local-1627859163"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-1627859164"><a href="#local-1627859164"><span class="hs-identifier">doLinearIndexing</span></a></a><span> </span><a name="local-1627859165"><a href="#local-1627859165"><span class="hs-identifier">doBoundsChecks</span></a></a><span> </span><a name="local-1627859166"><a href="#local-1627859166"><span class="hs-identifier">grp</span></a></a><span> </span><a name="local-1627859167"><a href="#local-1627859167"><span class="hs-identifier">sh</span></a></a><span> </span><a name="local-1627859168"><a href="#local-1627859168"><span class="hs-identifier">tmp</span></a></a><span> </span><a name="local-1627859169"><a href="#local-1627859169"><span class="hs-identifier">centroid</span></a></a><span> </span><a name="local-1627859170"><a href="#local-1627859170"><span class="hs-identifier">positions</span></a></a><span> </span><a name="local-1627859171"><a href="#local-1627859171"><span class="hs-identifier">boundary</span></a></a><span> </span><a name="local-1627859172"><a href="#local-1627859172"><span class="hs-identifier">dce</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-69"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="#local-1627859173"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627859174"><span class="hs-identifier hs-var">params</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627859178"><span class="hs-identifier hs-var">stencil</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-71"></a><span>    </span><span class="hs-special">(</span><a name="local-1627859173"><a href="#local-1627859173"><span class="hs-identifier">decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627859174"><a href="#local-1627859174"><span class="hs-identifier">params</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627859175"><a href="#local-1627859175"><span class="hs-identifier">getIn</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#readStencil"><span class="hs-identifier hs-var">readStencil</span></a><span> </span><a href="#local-1627859163"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627859166"><span class="hs-identifier hs-var">grp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Array</span><span> </span><a href="#local-1627859161"><span class="hs-identifier hs-type">sh</span></a><span> </span><a href="#local-1627859162"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627859176"><a href="#local-1627859176"><span class="hs-identifier">shIn</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#readStencil"><span class="hs-identifier hs-var">readStencil</span></a><span> </span><a href="#local-1627859163"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627859167"><span class="hs-identifier hs-var">sh</span></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Array</span><span> </span><a href="#local-1627859161"><span class="hs-identifier hs-type">sh</span></a><span> </span><a href="#local-1627859162"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>    </span><a name="local-1627859177"><a href="#local-1627859177"><span class="hs-identifier">getInAt</span></a></a><span> </span><a name="local-1627859181"><a href="#local-1627859181"><span class="hs-identifier">ix</span></a></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#fresh"><span class="hs-identifier hs-var">fresh</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-1627859182"><a href="#local-1627859182"><span class="hs-identifier">j</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-75"></a><span>                                  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier">citem</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">ty</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">cint</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">id</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">j</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">ix</span><span class="hs-special">;</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627859175"><span class="hs-identifier hs-var">getIn</span></a><span> </span><a href="#local-1627859182"><span class="hs-identifier hs-var">j</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span>    </span><span class="hs-comment">-- Generate the entire stencil, reading elements from those positions of the</span><span>
</span><a name="line-78"></a><span>    </span><span class="hs-comment">-- pattern that are used and eliminating reads from those that are not.</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-80"></a><span>    </span><a name="local-1627859178"><a href="#local-1627859178"><span class="hs-identifier">stencil</span></a></a><span> </span><a name="local-1627859192"><a href="#local-1627859192"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#withNameGen"><span class="hs-identifier hs-var">withNameGen</span></a><span> </span><a href="#local-1627859168"><span class="hs-identifier hs-var">tmp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-81"></a><span>      </span><span class="hs-special">(</span><a name="local-1627859193"><a href="#local-1627859193"><span class="hs-identifier">envs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627859194"><a href="#local-1627859194"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><span class="hs-special">(</span><a href="#local-1627859179"><span class="hs-identifier hs-var">access</span></a><span> </span><a href="#local-1627859192"><span class="hs-identifier hs-var">ix</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">shapeToList</span><span class="hs-special">)</span><span> </span><a href="#local-1627859170"><span class="hs-identifier hs-var">positions</span></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1627859195"><a href="#local-1627859195"><span class="hs-identifier">envs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627859196"><a href="#local-1627859196"><span class="hs-identifier">xs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span>
</span><a name="line-84"></a><span>                       </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#eliminate"><span class="hs-identifier hs-var">eliminate</span></a><span>
</span><a name="line-85"></a><span>                       </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><a href="#local-1627859193"><span class="hs-identifier hs-var">envs</span></a><span>               </span><span class="hs-comment">-- our version of zipwith that checks lengths</span><span>
</span><a name="line-86"></a><span>                       </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#unconcat"><span class="hs-identifier hs-var">unconcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1627859194"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>                       </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627859172"><span class="hs-identifier hs-var">dce</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-1627859194"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-1627859195"><span class="hs-identifier hs-var">envs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-1627859196"><span class="hs-identifier hs-var">xs'</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span>    </span><span class="hs-comment">-- Read the stencil component at the given offset (second argument). This</span><span>
</span><a name="line-92"></a><span>    </span><span class="hs-comment">-- may generate additional environment terms, such as for the index</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-comment">-- calculations.</span><span>
</span><a name="line-94"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-95"></a><span>    </span><span class="hs-identifier">access</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Rvalue"><span class="hs-identifier hs-type">Rvalue</span></a><span> </span><a href="#local-1627859180"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859180"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#Gen"><span class="hs-identifier hs-type">Gen</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">BlockItem</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>    </span><a name="local-1627859179"><a href="#local-1627859179"><span class="hs-identifier">access</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#rvalue"><span class="hs-identifier hs-var">rvalue</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-1627859197"><a href="#local-1627859197"><span class="hs-identifier">ix</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627859198"><a href="#local-1627859198"><span class="hs-identifier">dx</span></a></a><span>
</span><a name="line-97"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627859165"><span class="hs-identifier hs-var">doBoundsChecks</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627859202"><span class="hs-identifier hs-var">safeAccess</span></a><span>
</span><a name="line-98"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627859201"><span class="hs-identifier hs-var">unsafeAccess</span></a><span>
</span><a name="line-99"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-100"></a><span>        </span><a name="local-1627859199"><a href="#local-1627859199"><span class="hs-identifier">focus</span></a></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><a href="#local-1627859198"><span class="hs-identifier hs-var">dx</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span>        </span><span class="hs-comment">-- The current stencil position into the array, as a multidimensional index</span><span>
</span><a name="line-103"></a><span>        </span><a name="local-1627859200"><a href="#local-1627859200"><span class="hs-identifier">cursor</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627859199"><span class="hs-identifier hs-var">focus</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627859197"><span class="hs-identifier hs-var">ix</span></a><span>
</span><a name="line-104"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627859205"><a href="#local-1627859205"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-1627859206"><a href="#local-1627859206"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">cexp</span><span class="hs-glyph">|</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">i</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">int</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">d</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-1627859197"><span class="hs-identifier hs-var">ix</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-1627859198"><span class="hs-identifier hs-var">dx</span></a><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span>        </span><span class="hs-comment">-- Read the array position without any bounds checks</span><span>
</span><a name="line-107"></a><span>        </span><a name="local-1627859201"><a href="#local-1627859201"><span class="hs-identifier">unsafeAccess</span></a></a><span>
</span><a name="line-108"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627859164"><span class="hs-identifier hs-var">doLinearIndexing</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627859199"><span class="hs-identifier hs-var">focus</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627859175"><span class="hs-identifier hs-var">getIn</span></a><span> </span><a href="#local-1627859169"><span class="hs-identifier hs-var">centroid</span></a><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627859177"><span class="hs-identifier hs-var">getInAt</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#ctoIndex"><span class="hs-identifier hs-var">ctoIndex</span></a><span> </span><a href="#local-1627859176"><span class="hs-identifier hs-var">shIn</span></a><span> </span><a href="#local-1627859200"><span class="hs-identifier hs-var">cursor</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>        </span><span class="hs-comment">-- Read the array, applying appropriate bounds checks</span><span>
</span><a name="line-112"></a><span>        </span><a name="local-1627859202"><a href="#local-1627859202"><span class="hs-identifier">safeAccess</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627859171"><span class="hs-identifier hs-var">boundary</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-113"></a><span>          </span><span class="hs-identifier hs-var">Clamp</span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627859203"><span class="hs-identifier hs-var">bounded</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cclamp"><span class="hs-identifier hs-var">cclamp</span></a><span>
</span><a name="line-114"></a><span>          </span><span class="hs-identifier hs-var">Mirror</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627859203"><span class="hs-identifier hs-var">bounded</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cmirror"><span class="hs-identifier hs-var">cmirror</span></a><span>
</span><a name="line-115"></a><span>          </span><span class="hs-identifier hs-var">Wrap</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627859203"><span class="hs-identifier hs-var">bounded</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cwrap"><span class="hs-identifier hs-var">cwrap</span></a><span>
</span><a name="line-116"></a><span>          </span><span class="hs-identifier hs-var">Constant</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUExp"><span class="hs-identifier hs-var">CUExp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1627859211"><a href="#local-1627859211"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627859204"><span class="hs-identifier hs-var">inrange</span></a><span> </span><a href="#local-1627859211"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span>        </span><a name="local-1627859203"><a href="#local-1627859203"><span class="hs-identifier">bounded</span></a></a><span> </span><a name="local-1627859212"><a href="#local-1627859212"><span class="hs-identifier">f</span></a></a><span>
</span><a name="line-119"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627859199"><span class="hs-identifier hs-var">focus</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627859201"><span class="hs-identifier hs-var">unsafeAccess</span></a><span>
</span><a name="line-120"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627859177"><span class="hs-identifier hs-var">getInAt</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#ctoIndex"><span class="hs-identifier hs-var">ctoIndex</span></a><span> </span><a href="#local-1627859176"><span class="hs-identifier hs-var">shIn</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627859212"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627859176"><span class="hs-identifier hs-var">shIn</span></a><span> </span><a href="#local-1627859200"><span class="hs-identifier hs-var">cursor</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span>        </span><a name="local-1627859204"><a href="#local-1627859204"><span class="hs-identifier">inrange</span></a></a><span> </span><a name="local-1627859213"><a href="#local-1627859213"><span class="hs-identifier">cs</span></a></a><span>
</span><a name="line-123"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627859199"><span class="hs-identifier hs-var">focus</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627859201"><span class="hs-identifier hs-var">unsafeAccess</span></a><span>
</span><a name="line-124"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-125"></a><span>              </span><span class="hs-special">(</span><a name="local-1627859214"><a href="#local-1627859214"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627859201"><span class="hs-identifier hs-var">unsafeAccess</span></a><span>
</span><a name="line-126"></a><span>              </span><a name="local-1627859216"><a href="#local-1627859216"><span class="hs-identifier">p</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#fresh"><span class="hs-identifier hs-var">fresh</span></a><span>
</span><a name="line-127"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">citem</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">id</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">p</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-special">(</span><span class="hs-identifier hs-var">cinRange</span><span> </span><span class="hs-identifier hs-var">shIn</span><span> </span><span class="hs-identifier hs-var">cursor</span><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627859214"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-128"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627859221"><a href="#local-1627859221"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-1627859222"><a href="#local-1627859222"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">cexp</span><span class="hs-glyph">|</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">id</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">p</span><span> </span><span class="hs-operator hs-var">?</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">a</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">c</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-1627859213"><span class="hs-identifier hs-var">cs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">-- Filter unused components of the stencil. Environment bindings are shared</span><span>
</span><a name="line-132"></a><span class="hs-comment">-- between tuple components of each cursor position, so filter these out only if</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- all elements of that position are unused.</span><span>
</span><a name="line-134"></a><span class="hs-comment">--</span><span>
</span><a name="line-135"></a><span class="hs-identifier">eliminate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-1627859158"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><a href="#local-1627859159"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-1627859158"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><a href="#local-1627859159"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-136"></a><a name="eliminate"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#eliminate"><span class="hs-identifier">eliminate</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-137"></a><span class="hs-identifier">eliminate</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1627859227"><a href="#local-1627859227"><span class="hs-identifier">e</span></a></a><span class="hs-special">,</span><a name="local-1627859228"><a href="#local-1627859228"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-1627859229"><a href="#local-1627859229"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627859232"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627859231"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#eliminate"><span class="hs-identifier hs-var">eliminate</span></a><span> </span><a href="#local-1627859229"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-139"></a><span>    </span><span class="hs-special">(</span><a name="local-1627859230"><a href="#local-1627859230"><span class="hs-identifier">flags</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627859231"><a href="#local-1627859231"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-1627859228"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-140"></a><span>    </span><a name="local-1627859232"><a href="#local-1627859232"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">or</span><span> </span><a href="#local-1627859230"><span class="hs-identifier hs-var">flags</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627859227"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-141"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">-- A simple fresh name supply</span><span>
</span><a name="line-145"></a><span class="hs-comment">--</span><span>
</span><a name="line-146"></a><span class="hs-keyword">type</span><span> </span><a name="Gen"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#Gen"><span class="hs-identifier">Gen</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">State</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span class="hs-identifier">withNameGen</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#Gen"><span class="hs-identifier hs-type">Gen</span></a><span> </span><a href="#local-1627859157"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627859157"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-149"></a><a name="withNameGen"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#withNameGen"><span class="hs-identifier">withNameGen</span></a></a><span> </span><a name="local-1627859233"><a href="#local-1627859233"><span class="hs-identifier">base</span></a></a><span> </span><a name="local-1627859234"><a href="#local-1627859234"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evalState</span><span> </span><a href="#local-1627859234"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627859233"><span class="hs-identifier hs-var">base</span></a><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-identifier">fresh</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#Gen"><span class="hs-identifier hs-type">Gen</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-152"></a><a name="fresh"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#fresh"><span class="hs-identifier">fresh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">state</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1627859235"><a href="#local-1627859235"><span class="hs-identifier">base</span></a></a><span class="hs-special">,</span><a name="local-1627859236"><a href="#local-1627859236"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627859235"><span class="hs-identifier hs-var">base</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-1627859236"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-1627859235"><span class="hs-identifier hs-var">base</span></a><span class="hs-special">,</span><a href="#local-1627859236"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-comment">-- Boundary conditions</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- -------------------</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-comment">-- Test whether the given multidimensional index lies in the inside region of</span><span>
</span><a name="line-159"></a><span class="hs-comment">-- the stencil.</span><span>
</span><a name="line-160"></a><span class="hs-comment">--</span><span>
</span><a name="line-161"></a><span class="hs-identifier">insideRegion</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- The shape of the array</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span>                    </span><span class="hs-comment">-- The width of the stencil in each direction</span><span>
</span><a name="line-164"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- The index in question</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-166"></a><a name="insideRegion"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#insideRegion"><span class="hs-identifier">insideRegion</span></a></a><span> </span><a name="local-1627859237"><a href="#local-1627859237"><span class="hs-identifier">shape</span></a></a><span> </span><a name="local-1627859238"><a href="#local-1627859238"><span class="hs-identifier">border</span></a></a><span> </span><a name="local-1627859239"><a href="#local-1627859239"><span class="hs-identifier">index</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl1</span><span> </span><a href="#local-1627859241"><span class="hs-identifier hs-var">and</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith3"><span class="hs-identifier hs-var">zipWith3</span></a><span> </span><a href="#local-1627859240"><span class="hs-identifier hs-var">inside</span></a><span> </span><a href="#local-1627859237"><span class="hs-identifier hs-var">shape</span></a><span> </span><a href="#local-1627859238"><span class="hs-identifier hs-var">border</span></a><span> </span><a href="#local-1627859239"><span class="hs-identifier hs-var">index</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-168"></a><span>    </span><a name="local-1627859240"><a href="#local-1627859240"><span class="hs-identifier">inside</span></a></a><span> </span><a name="local-1627859242"><a href="#local-1627859242"><span class="hs-identifier">sz</span></a></a><span> </span><a name="local-1627859243"><a href="#local-1627859243"><span class="hs-identifier">dx</span></a></a><span> </span><a name="local-1627859244"><a href="#local-1627859244"><span class="hs-identifier">i</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">cexp</span><span class="hs-glyph">|</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">i</span><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">int</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">dx</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">i</span><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">sz</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">int</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">dx</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-169"></a><span>    </span><a name="local-1627859241"><a href="#local-1627859241"><span class="hs-identifier">and</span></a></a><span> </span><a name="local-1627859249"><a href="#local-1627859249"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1627859250"><a href="#local-1627859250"><span class="hs-identifier">y</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">cexp</span><span class="hs-glyph">|</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">x</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">y</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-comment">-- Given a list of stencil offset positions, calculate the size of the border</span><span>
</span><a name="line-173"></a><span class="hs-comment">-- region along each dimension.</span><span>
</span><a name="line-174"></a><span class="hs-comment">--</span><span>
</span><a name="line-175"></a><span class="hs-comment">-- Note that this does not consider any positions of the stencil that are not</span><span>
</span><a name="line-176"></a><span class="hs-comment">-- actually used. We assume the user is sensible and uses the minimally sized</span><span>
</span><a name="line-177"></a><span class="hs-comment">-- stencil for their application, but this can still be problematic for</span><span>
</span><a name="line-178"></a><span class="hs-comment">-- non-symmetric stencils. For example, a large stencil that uses elements from</span><span>
</span><a name="line-179"></a><span class="hs-comment">-- only one quadrant.</span><span>
</span><a name="line-180"></a><span class="hs-comment">--</span><span>
</span><a name="line-181"></a><span class="hs-identifier">borderRegion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Shape</span><span> </span><a href="#local-1627859156"><span class="hs-identifier hs-type">sh</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859156"><span class="hs-identifier hs-type">sh</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span>
</span><a name="line-182"></a><a name="borderRegion"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#borderRegion"><span class="hs-identifier">borderRegion</span></a></a><span>
</span><a name="line-183"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span>
</span><a name="line-184"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">maximum</span><span>
</span><a name="line-185"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">transpose</span><span>
</span><a name="line-186"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">shapeToList</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-comment">-- Test whether an index lies within the boundaries of a shape (first argument)</span><span>
</span><a name="line-190"></a><span class="hs-comment">--</span><span>
</span><a name="line-191"></a><span class="hs-identifier">cinRange</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-192"></a><a name="cinRange"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cinRange"><span class="hs-identifier">cinRange</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">internalError</span><span> </span><span class="hs-string">&quot;inRange&quot;</span><span> </span><span class="hs-string">&quot;singleton index&quot;</span><span>
</span><a name="line-193"></a><span class="hs-identifier">cinRange</span><span> </span><a name="local-1627859264"><a href="#local-1627859264"><span class="hs-identifier">shape</span></a></a><span> </span><a name="local-1627859265"><a href="#local-1627859265"><span class="hs-identifier">index</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl1</span><span> </span><a href="#local-1627859267"><span class="hs-identifier hs-var">and</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><a href="#local-1627859266"><span class="hs-identifier hs-var">inside</span></a><span> </span><a href="#local-1627859264"><span class="hs-identifier hs-var">shape</span></a><span> </span><a href="#local-1627859265"><span class="hs-identifier hs-var">index</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-195"></a><span>    </span><a name="local-1627859266"><a href="#local-1627859266"><span class="hs-identifier">inside</span></a></a><span> </span><a name="local-1627859268"><a href="#local-1627859268"><span class="hs-identifier">sz</span></a></a><span> </span><a name="local-1627859269"><a href="#local-1627859269"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">cexp</span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">ty</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">cint</span><span> </span><span class="hs-identifier hs-var">_i</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">i</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">_i</span><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">_i</span><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">sz</span><span class="hs-special">;</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-196"></a><span>    </span><a name="local-1627859267"><a href="#local-1627859267"><span class="hs-identifier">and</span></a></a><span> </span><a name="local-1627859279"><a href="#local-1627859279"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1627859280"><a href="#local-1627859280"><span class="hs-identifier">y</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">cexp</span><span class="hs-glyph">|</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">x</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">y</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-comment">-- Clamp an index to the boundary of the shape (first argument)</span><span>
</span><a name="line-199"></a><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span class="hs-identifier">cclamp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-201"></a><a name="cclamp"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cclamp"><span class="hs-identifier">cclamp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><a href="#local-1627859285"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-202"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-203"></a><span>    </span><a name="local-1627859285"><a href="#local-1627859285"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627859286"><a href="#local-1627859286"><span class="hs-identifier">sz</span></a></a><span> </span><a name="local-1627859287"><a href="#local-1627859287"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">cexp</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">max</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">ty</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">cint</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">min</span><span class="hs-special">(</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">i</span><span class="hs-special">,</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">sz</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-comment">-- Indices out of bounds of the shape are mirrored back in range. Assumes that</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- the array is at least as large as the stencil.</span><span>
</span><a name="line-207"></a><span class="hs-comment">--</span><span>
</span><a name="line-208"></a><span class="hs-identifier">cmirror</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-209"></a><a name="cmirror"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cmirror"><span class="hs-identifier">cmirror</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><a href="#local-1627859292"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-210"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-211"></a><span>    </span><a name="local-1627859292"><a href="#local-1627859292"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627859293"><a href="#local-1627859293"><span class="hs-identifier">sz</span></a></a><span> </span><a name="local-1627859294"><a href="#local-1627859294"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">cexp</span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">ty</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">cint</span><span> </span><span class="hs-identifier hs-var">_i</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">i</span><span class="hs-special">;</span><span>
</span><a name="line-212"></a><span>                       </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">ty</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">cint</span><span> </span><span class="hs-identifier hs-var">_sz</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">sz</span><span class="hs-special">;</span><span>
</span><a name="line-213"></a><span>                      </span><span class="hs-identifier hs-var">_i</span><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span>    </span><span class="hs-operator hs-var">?</span><span> </span><span class="hs-glyph">-</span><span class="hs-identifier hs-var">_i</span><span>
</span><a name="line-214"></a><span>                    </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">_i</span><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier hs-var">_sz</span><span> </span><span class="hs-operator hs-var">?</span><span>  </span><span class="hs-identifier hs-var">_sz</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">_i</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">_sz</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>                    </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">_i</span><span class="hs-special">;</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-comment">-- Indices out of bounds are wrapped to the opposite edge of the shape</span><span>
</span><a name="line-218"></a><span class="hs-comment">--</span><span>
</span><a name="line-219"></a><span class="hs-identifier">cwrap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>
</span><a name="line-220"></a><a name="cwrap"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#cwrap"><span class="hs-identifier">cwrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><a href="#local-1627859309"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-221"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-222"></a><span>    </span><a name="local-1627859309"><a href="#local-1627859309"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627859310"><a href="#local-1627859310"><span class="hs-identifier">sz</span></a></a><span> </span><a name="local-1627859311"><a href="#local-1627859311"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">cexp</span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">ty</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">cint</span><span> </span><span class="hs-identifier hs-var">_i</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">i</span><span class="hs-special">;</span><span>
</span><a name="line-223"></a><span>                       </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">ty</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">cint</span><span> </span><span class="hs-identifier hs-var">_sz</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">sz</span><span class="hs-special">;</span><span>
</span><a name="line-224"></a><span>                    </span><span class="hs-identifier hs-var">_i</span><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span>    </span><span class="hs-operator hs-var">?</span><span> </span><span class="hs-identifier hs-var">_sz</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">_i</span><span>
</span><a name="line-225"></a><span>                  </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">_i</span><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier hs-var">_sz</span><span> </span><span class="hs-operator hs-var">?</span><span> </span><span class="hs-identifier hs-var">_i</span><span>  </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">_sz</span><span>
</span><a name="line-226"></a><span>                  </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">_i</span><span class="hs-special">;</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-comment">-- Kernel parameters</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- -----------------</span><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-comment">-- Generate kernel parameters for input arrays. This is similar to 'readArray',</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- but we force compute 1.x devices to read through the texture cache as well.</span><span>
</span><a name="line-234"></a><span class="hs-comment">--</span><span>
</span><a name="line-235"></a><span class="hs-identifier">readStencil</span><span>
</span><a name="line-236"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1627859153"><a href="#local-1627859153"><span class="hs-identifier">sh</span></a></a><span> </span><a name="local-1627859154"><a href="#local-1627859154"><span class="hs-identifier">e</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Shape</span><span> </span><a href="#local-1627859153"><span class="hs-identifier hs-type">sh</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Elt</span><span> </span><a href="#local-1627859154"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DeviceProperties</span><span>
</span><a name="line-238"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>                                     </span><span class="hs-comment">-- group names</span><span>
</span><a name="line-239"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Array</span><span> </span><a href="#local-1627859153"><span class="hs-identifier hs-type">sh</span></a><span> </span><a href="#local-1627859154"><span class="hs-identifier hs-type">e</span></a><span>                               </span><span class="hs-comment">-- dummy to fix the types</span><span>
</span><a name="line-240"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Definition</span><span class="hs-special">]</span><span>                         </span><span class="hs-comment">-- global definitions for stencils read via texture references (compute &lt; 2.0)</span><span>
</span><a name="line-241"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Param</span><span class="hs-special">]</span><span>                              </span><span class="hs-comment">-- function arguments for stencils read as arrays (compute &gt;= 2.0)</span><span>
</span><a name="line-242"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>                                </span><span class="hs-comment">-- shape of the array</span><span>
</span><a name="line-243"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1627859155"><a href="#local-1627859155"><span class="hs-identifier">x</span></a></a><span class="hs-operator">.</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#Rvalue"><span class="hs-identifier hs-type">Rvalue</span></a><span> </span><a href="#local-1627859155"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-1627859155"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">C</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- read elements from a linear index</span><span>
</span><a name="line-244"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-245"></a><a name="readStencil"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#readStencil"><span class="hs-identifier">readStencil</span></a></a><span> </span><a name="local-1627859326"><a href="#local-1627859326"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-1627859327"><a href="#local-1627859327"><span class="hs-identifier">grp</span></a></a><span> </span><a name="local-1627859328"><a href="#local-1627859328"><span class="hs-identifier">dummy</span></a></a><span>
</span><a name="line-246"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1627859329"><a href="#local-1627859329"><span class="hs-identifier">sh</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627859330"><a href="#local-1627859330"><span class="hs-identifier">arrs</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#namesOfArray"><span class="hs-identifier hs-var">namesOfArray</span></a><span> </span><a href="#local-1627859327"><span class="hs-identifier hs-var">grp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1627859154"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>        </span><span class="hs-special">(</span><a name="local-1627859331"><a href="#local-1627859331"><span class="hs-identifier">decl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627859332"><a href="#local-1627859332"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">computeCapability</span><span> </span><a href="#local-1627859326"><span class="hs-identifier hs-var">dev</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier hs-var">Compute</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#arrayAsTex"><span class="hs-identifier hs-var">arrayAsTex</span></a><span> </span><a href="#local-1627859328"><span class="hs-identifier hs-var">dummy</span></a><span> </span><a href="#local-1627859327"><span class="hs-identifier hs-var">grp</span></a><span>
</span><a name="line-249"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#arrayAsArg"><span class="hs-identifier hs-var">arrayAsArg</span></a><span> </span><a href="#local-1627859328"><span class="hs-identifier hs-var">dummy</span></a><span> </span><a href="#local-1627859327"><span class="hs-identifier hs-var">grp</span></a><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span>        </span><a name="local-1627859333"><a href="#local-1627859333"><span class="hs-identifier">dim</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expDim</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><a href="#local-1627859336"><span class="hs-identifier hs-type">aenv</span></a><span> </span><a href="#local-1627859153"><span class="hs-identifier hs-type">sh</span></a><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>        </span><a name="local-1627859334"><a href="#local-1627859334"><span class="hs-identifier">sh'</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#cshape"><span class="hs-identifier hs-var">cshape</span></a><span> </span><a href="#local-1627859333"><span class="hs-identifier hs-var">dim</span></a><span> </span><a href="#local-1627859329"><span class="hs-identifier hs-var">sh</span></a><span>
</span><a name="line-253"></a><span>        </span><a name="local-1627859335"><a href="#local-1627859335"><span class="hs-identifier">fetch</span></a></a><span> </span><a name="local-1627859337"><a href="#local-1627859337"><span class="hs-identifier">ix</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627859338"><a href="#local-1627859338"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627859339"><a href="#local-1627859339"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#indexArray"><span class="hs-identifier hs-var">indexArray</span></a><span> </span><a href="#local-1627859326"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627859338"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#cvar"><span class="hs-identifier hs-var">cvar</span></a><span> </span><a href="#local-1627859339"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#rvalue"><span class="hs-identifier hs-var">rvalue</span></a><span> </span><a href="#local-1627859337"><span class="hs-identifier hs-var">ix</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Type.html#eltType"><span class="hs-identifier hs-var">eltType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1627859154"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1627859330"><span class="hs-identifier hs-var">arrs</span></a><span>
</span><a name="line-254"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-255"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="#local-1627859331"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627859332"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627859334"><span class="hs-identifier hs-var">sh'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627859335"><span class="hs-identifier hs-var">fetch</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-comment">-- Prelude'</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- --------</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-comment">-- A version of 'zipWith' that requires the lists to be equal length</span><span>
</span><a name="line-262"></a><span class="hs-comment">--</span><span>
</span><a name="line-263"></a><span class="hs-identifier">zipWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-1627859150"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627859151"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627859152"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859150"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859151"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859152"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">]</span><span>
</span><a name="line-264"></a><a name="zipWith"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith"><span class="hs-identifier">zipWith</span></a></a><span> </span><a name="local-1627859340"><a href="#local-1627859340"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627859341"><a href="#local-1627859341"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-1627859342"><a href="#local-1627859342"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1627859343"><a href="#local-1627859343"><span class="hs-identifier">y</span></a></a><span class="hs-glyph">:</span><a name="local-1627859344"><a href="#local-1627859344"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627859340"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627859341"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-1627859343"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><a href="#local-1627859340"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627859342"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-1627859344"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-265"></a><span class="hs-identifier">zipWith</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-266"></a><span class="hs-identifier">zipWith</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">internalError</span><span> </span><span class="hs-string">&quot;zipWith&quot;</span><span> </span><span class="hs-string">&quot;argument mismatch&quot;</span><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span class="hs-identifier">zipWith3</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-1627859146"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627859147"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627859148"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627859149"><span class="hs-identifier hs-type">d</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859146"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859147"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859148"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859149"><span class="hs-identifier hs-type">d</span></a><span class="hs-special">]</span><span>
</span><a name="line-269"></a><a name="zipWith3"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith3"><span class="hs-identifier">zipWith3</span></a></a><span> </span><a name="local-1627859354"><a href="#local-1627859354"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627859355"><a href="#local-1627859355"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-1627859356"><a href="#local-1627859356"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1627859357"><a href="#local-1627859357"><span class="hs-identifier">y</span></a></a><span class="hs-glyph">:</span><a name="local-1627859358"><a href="#local-1627859358"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1627859359"><a href="#local-1627859359"><span class="hs-identifier">z</span></a></a><span class="hs-glyph">:</span><a name="local-1627859360"><a href="#local-1627859360"><span class="hs-identifier">zs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627859354"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627859355"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-1627859357"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-1627859359"><span class="hs-identifier hs-var">z</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#zipWith3"><span class="hs-identifier hs-var">zipWith3</span></a><span> </span><a href="#local-1627859354"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627859356"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-1627859358"><span class="hs-identifier hs-var">ys</span></a><span> </span><a href="#local-1627859360"><span class="hs-identifier hs-var">zs</span></a><span>
</span><a name="line-270"></a><span class="hs-identifier">zipWith3</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-271"></a><span class="hs-identifier">zipWith3</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">internalError</span><span> </span><span class="hs-string">&quot;zipWith3&quot;</span><span> </span><span class="hs-string">&quot;argument mismatch&quot;</span><span>
</span><a name="line-272"></a><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span class="hs-comment">-- Split a list into segments of given length</span><span>
</span><a name="line-275"></a><span class="hs-comment">--</span><span>
</span><a name="line-276"></a><span class="hs-identifier">unconcat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627859145"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="#local-1627859145"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-277"></a><a name="unconcat"><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#unconcat"><span class="hs-identifier">unconcat</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-278"></a><span class="hs-identifier">unconcat</span><span> </span><span class="hs-special">(</span><a name="local-1627859370"><a href="#local-1627859370"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">:</span><a name="local-1627859371"><a href="#local-1627859371"><span class="hs-identifier">ns</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627859372"><a href="#local-1627859372"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1627859373"><a href="#local-1627859373"><span class="hs-identifier">h</span></a></a><span class="hs-special">,</span><a name="local-1627859374"><a href="#local-1627859374"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-1627859370"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627859372"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-1627859373"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Stencil.Extra.html#unconcat"><span class="hs-identifier hs-var">unconcat</span></a><span> </span><a href="#local-1627859371"><span class="hs-identifier hs-var">ns</span></a><span> </span><a href="#local-1627859374"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a></pre></body></html>