<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE UnboxedTuples #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE MagicHash #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- | An abstract interface to a concurrent unique symbol generator.</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Unlike @Data.Unique@ from @base@ the values are not a member of 'Ord'. However, there is no global bottleneck.</span><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">Unique</span><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Unique.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Hashable</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Prim</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-comment">-- | Unique identifiers are created by creating heap objects in kind # that</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- can be compared for value equality and then hashing them using their initial allocation</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- address.</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-comment">-- TODO: If, due to a small heap size we find we have high collision rate on initial allocation location</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- we might consider upgrading this initial hash with something fast and volatile, e.g. rdtsc</span><span>
</span><a name="line-23"></a><span class="hs-keyword">data</span><span> </span><a name="Unique"><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier">Unique</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Unique"><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier">Unique</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MutableByteArray</span><span class="hs-operator hs-type">#</span><span> </span><span class="hs-identifier hs-type">RealWorld</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-26"></a><span class="hs-cpp">#if MIN_VERSION_base(4,7,0)</span><span>
</span><a name="line-27"></a><span>  </span><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier hs-var">Unique</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679027843"><a href="#local-6989586621679027843"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-3458764513820541095"><span class="hs-operator">==</span></a><span> </span><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier hs-var">Unique</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679027844"><a href="#local-6989586621679027844"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isTrue</span><span class="hs-operator hs-var">#</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sameMutableByteArray</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679027843"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679027844"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-identifier">Unique</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">Unique</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">q</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sameMutableByteArray</span><span class="hs-operator">#</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">q</span><span>
</span><a name="line-30"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Hashable</span><span> </span><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-33"></a><span>  </span><a name="local-8214565720323792980"><span class="hs-identifier">hash</span></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier hs-var">Unique</span></a><span> </span><a name="local-6989586621679027840"><a href="#local-6989586621679027840"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679027840"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-34"></a><span>  </span><a name="local-8214565720323792981"><span class="hs-identifier">hashWithSalt</span></a><span> </span><a name="local-6989586621679027841"><a href="#local-6989586621679027841"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier hs-var">Unique</span></a><span> </span><a name="local-6989586621679027842"><a href="#local-6989586621679027842"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hashWithSalt</span><span> </span><a href="#local-6989586621679027841"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621679027842"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-comment">-- | Allocate a new 'Unique' value. The value returned will not compare equal to any other value of type 'Unique' returned by previous calls to 'newUnique'. There is no limit on the number of times 'newUnique' may be called.</span><span>
</span><a name="line-37"></a><span class="hs-identifier">newUnique</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span>
</span><a name="line-38"></a><a name="newUnique"><a href="Control.Concurrent.Unique.html#newUnique"><span class="hs-identifier">newUnique</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679027845"><a href="#local-6989586621679027845"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">newByteArray</span><span class="hs-operator hs-var">#</span><span> </span><span class="hs-number">0</span><span class="hs-operator">#</span><span> </span><a href="#local-6989586621679027845"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-39"></a><span>  </span><span class="hs-special">(</span><span class="hs-operator">#</span><span> </span><a name="local-6989586621679027846"><a href="#local-6989586621679027846"><span class="hs-identifier">s'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679027847"><a href="#local-6989586621679027847"><span class="hs-identifier">ba</span></a></a><span> </span><span class="hs-operator">#</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-operator">#</span><span> </span><a href="#local-6989586621679027846"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Unique.html#Unique"><span class="hs-identifier hs-var">Unique</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span class="hs-operator hs-var">#</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addr2Int</span><span class="hs-operator hs-var">#</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeCoerce</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679027847"><span class="hs-identifier hs-var">ba</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679027847"><span class="hs-identifier hs-var">ba</span></a><span> </span><span class="hs-operator">#</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a></pre></body></html>