<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                 #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE ImpredicativeTypes  #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE PatternGuards       #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE QuasiQuotes         #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Module      : Data.Array.Accelerate.CUDA.CodeGen.PrefixSum</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Copyright   : [2008..2014] Manuel M T Chakravarty, Gabriele Keller</span><span>
</span><a name="line-10"></a><span class="hs-comment">--               [2009..2014] Trevor L. McDonell</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- License     : BSD3</span><span>
</span><a name="line-12"></a><span class="hs-comment">--</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- Maintainer  : Trevor L. McDonell &lt;tmcdonell@cse.unsw.edu.au&gt;</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- Stability   : experimental</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- Portability : non-portable (GHC extensions)</span><span>
</span><a name="line-16"></a><span class="hs-comment">--</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">module</span><span>  </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">CodeGen</span><span class="hs-operator">.</span><span class="hs-identifier">PrefixSum</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-comment">-- skeletons</span><span>
</span><a name="line-21"></a><span>  </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanl"><span class="hs-identifier hs-var">mkScanl</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanl1"><span class="hs-identifier hs-var">mkScanl1</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanl%27"><span class="hs-identifier hs-var">mkScanl'</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>  </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanr"><span class="hs-identifier hs-var">mkScanr</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanr1"><span class="hs-identifier hs-var">mkScanr1</span></a><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanr%27"><span class="hs-identifier hs-var">mkScanr'</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">Analysis</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">C</span><span class="hs-operator">.</span><span class="hs-identifier">Quote</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">C</span><span class="hs-operator">.</span><span class="hs-identifier">Syntax</span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">C</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Sugar</span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Vector</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Scalar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Elt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DIM1</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.CUDA.AST.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">AST</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Accelerate</span><span class="hs-operator">.</span><span class="hs-identifier">CUDA</span><span class="hs-operator">.</span><span class="hs-identifier">CodeGen</span><span class="hs-operator">.</span><span class="hs-identifier">Base</span></a><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-comment">-- Wrappers</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- --------</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-identifier">mkScanl</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mkScanr</span><span>
</span><a name="line-40"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Elt</span><span> </span><a href="#local-1627734428"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-41"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DeviceProperties</span><span>
</span><a name="line-42"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.AST.html#Gamma"><span class="hs-identifier hs-type">Gamma</span></a><span> </span><a href="#local-1627734429"><span class="hs-identifier hs-type">aenv</span></a><span>
</span><a name="line-43"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUFun2"><span class="hs-identifier hs-type">CUFun2</span></a><span> </span><a href="#local-1627734429"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627734428"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627734428"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627734428"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUExp"><span class="hs-identifier hs-type">CUExp</span></a><span> </span><a href="#local-1627734429"><span class="hs-identifier hs-type">aenv</span></a><span> </span><a href="#local-1627734428"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-45"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUDelayedAcc"><span class="hs-identifier hs-type">CUDelayedAcc</span></a><span> </span><a href="#local-1627734429"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-identifier hs-type">DIM1</span><span> </span><a href="#local-1627734428"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-46"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUTranslSkel"><span class="hs-identifier hs-type">CUTranslSkel</span></a><span> </span><a href="#local-1627734429"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Vector</span><span> </span><a href="#local-1627734428"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-47"></a><a name="mkScanl"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanl"><span class="hs-identifier">mkScanl</span></a></a><span> </span><a name="local-1627734430"><a href="#local-1627734430"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-1627734431"><a href="#local-1627734431"><span class="hs-identifier">aenv</span></a></a><span> </span><a name="local-1627734432"><a href="#local-1627734432"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627734433"><a href="#local-1627734433"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-1627734434"><a href="#local-1627734434"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-special">[</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScan"><span class="hs-identifier hs-var">mkScan</span></a><span>    </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a href="#local-1627734430"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734431"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734432"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627734433"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627734434"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-49"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanUp1"><span class="hs-identifier hs-var">mkScanUp1</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a href="#local-1627734430"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734431"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734432"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627734434"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-50"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanUp2"><span class="hs-identifier hs-var">mkScanUp2</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a href="#local-1627734430"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734431"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734432"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627734433"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><a name="mkScanr"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanr"><span class="hs-identifier">mkScanr</span></a></a><span> </span><a name="local-1627734435"><a href="#local-1627734435"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-1627734436"><a href="#local-1627734436"><span class="hs-identifier">aenv</span></a></a><span> </span><a name="local-1627734437"><a href="#local-1627734437"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627734438"><a href="#local-1627734438"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-1627734439"><a href="#local-1627734439"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-53"></a><span>  </span><span class="hs-special">[</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScan"><span class="hs-identifier hs-var">mkScan</span></a><span>    </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#R"><span class="hs-identifier hs-var">R</span></a><span> </span><a href="#local-1627734435"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734436"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734437"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627734438"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627734439"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-54"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanUp1"><span class="hs-identifier hs-var">mkScanUp1</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#R"><span class="hs-identifier hs-var">R</span></a><span> </span><a href="#local-1627734435"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734436"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734437"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627734439"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-55"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanUp2"><span class="hs-identifier hs-var">mkScanUp2</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#R"><span class="hs-identifier hs-var">R</span></a><span> </span><a href="#local-1627734435"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734436"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734437"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627734438"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-identifier">mkScanl1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mkScanr1</span><span>
</span><a name="line-58"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Elt</span><span> </span><a href="#local-1627734426"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-59"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DeviceProperties</span><span>
</span><a name="line-60"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.AST.html#Gamma"><span class="hs-identifier hs-type">Gamma</span></a><span> </span><a href="#local-1627734427"><span class="hs-identifier hs-type">aenv</span></a><span>
</span><a name="line-61"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUFun2"><span class="hs-identifier hs-type">CUFun2</span></a><span> </span><a href="#local-1627734427"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627734426"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627734426"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627734426"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUDelayedAcc"><span class="hs-identifier hs-type">CUDelayedAcc</span></a><span> </span><a href="#local-1627734427"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-identifier hs-type">DIM1</span><span> </span><a href="#local-1627734426"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-63"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUTranslSkel"><span class="hs-identifier hs-type">CUTranslSkel</span></a><span> </span><a href="#local-1627734427"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Vector</span><span> </span><a href="#local-1627734426"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-64"></a><a name="mkScanl1"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanl1"><span class="hs-identifier">mkScanl1</span></a></a><span> </span><a name="local-1627734440"><a href="#local-1627734440"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-1627734441"><a href="#local-1627734441"><span class="hs-identifier">aenv</span></a></a><span> </span><a name="local-1627734442"><a href="#local-1627734442"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627734443"><a href="#local-1627734443"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-special">[</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScan"><span class="hs-identifier hs-var">mkScan</span></a><span>    </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a href="#local-1627734440"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734441"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734442"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-1627734443"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-66"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanUp1"><span class="hs-identifier hs-var">mkScanUp1</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a href="#local-1627734440"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734441"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734442"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627734443"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-67"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanUp2"><span class="hs-identifier hs-var">mkScanUp2</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a href="#local-1627734440"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734441"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734442"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><a name="mkScanr1"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanr1"><span class="hs-identifier">mkScanr1</span></a></a><span> </span><a name="local-1627734444"><a href="#local-1627734444"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-1627734445"><a href="#local-1627734445"><span class="hs-identifier">aenv</span></a></a><span> </span><a name="local-1627734446"><a href="#local-1627734446"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627734447"><a href="#local-1627734447"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-70"></a><span>  </span><span class="hs-special">[</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScan"><span class="hs-identifier hs-var">mkScan</span></a><span>    </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#R"><span class="hs-identifier hs-var">R</span></a><span> </span><a href="#local-1627734444"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734445"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734446"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-1627734447"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanUp1"><span class="hs-identifier hs-var">mkScanUp1</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#R"><span class="hs-identifier hs-var">R</span></a><span> </span><a href="#local-1627734444"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734445"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734446"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627734447"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-72"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanUp2"><span class="hs-identifier hs-var">mkScanUp2</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#R"><span class="hs-identifier hs-var">R</span></a><span> </span><a href="#local-1627734444"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734445"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734446"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-identifier">mkScanl'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mkScanr'</span><span>
</span><a name="line-75"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Elt</span><span> </span><a href="#local-1627734424"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-76"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DeviceProperties</span><span>
</span><a name="line-77"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.AST.html#Gamma"><span class="hs-identifier hs-type">Gamma</span></a><span> </span><a href="#local-1627734425"><span class="hs-identifier hs-type">aenv</span></a><span>
</span><a name="line-78"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUFun2"><span class="hs-identifier hs-type">CUFun2</span></a><span> </span><a href="#local-1627734425"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627734424"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627734424"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627734424"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUExp"><span class="hs-identifier hs-type">CUExp</span></a><span> </span><a href="#local-1627734425"><span class="hs-identifier hs-type">aenv</span></a><span> </span><a href="#local-1627734424"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-80"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUDelayedAcc"><span class="hs-identifier hs-type">CUDelayedAcc</span></a><span> </span><a href="#local-1627734425"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-identifier hs-type">DIM1</span><span> </span><a href="#local-1627734424"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-81"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUTranslSkel"><span class="hs-identifier hs-type">CUTranslSkel</span></a><span> </span><a href="#local-1627734425"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Vector</span><span> </span><a href="#local-1627734424"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Scalar</span><span> </span><a href="#local-1627734424"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-82"></a><a name="mkScanl%27"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanl%27"><span class="hs-identifier">mkScanl'</span></a></a><span> </span><a name="local-1627734448"><a href="#local-1627734448"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-1627734449"><a href="#local-1627734449"><span class="hs-identifier">aenv</span></a></a><span> </span><a name="local-1627734450"><a href="#local-1627734450"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627734451"><a href="#local-1627734451"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#cast"><span class="hs-identifier hs-var">cast</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanl"><span class="hs-identifier hs-var">mkScanl</span></a><span> </span><a href="#local-1627734448"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734449"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734450"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627734451"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-83"></a><a name="mkScanr%27"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanr%27"><span class="hs-identifier">mkScanr'</span></a></a><span> </span><a name="local-1627734452"><a href="#local-1627734452"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-1627734453"><a href="#local-1627734453"><span class="hs-identifier">aenv</span></a></a><span> </span><a name="local-1627734454"><a href="#local-1627734454"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627734455"><a href="#local-1627734455"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#cast"><span class="hs-identifier hs-var">cast</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScanr"><span class="hs-identifier hs-var">mkScanr</span></a><span> </span><a href="#local-1627734452"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-1627734453"><span class="hs-identifier hs-var">aenv</span></a><span> </span><a href="#local-1627734454"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627734455"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-identifier">cast</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUTranslSkel"><span class="hs-identifier hs-type">CUTranslSkel</span></a><span> </span><a href="#local-1627734421"><span class="hs-identifier hs-type">aenv</span></a><span> </span><a href="#local-1627734422"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUTranslSkel"><span class="hs-identifier hs-type">CUTranslSkel</span></a><span> </span><a href="#local-1627734421"><span class="hs-identifier hs-type">aenv</span></a><span> </span><a href="#local-1627734423"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-86"></a><a name="cast"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#cast"><span class="hs-identifier">cast</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUTranslSkel"><span class="hs-identifier hs-var">CUTranslSkel</span></a><span> </span><a name="local-1627734456"><a href="#local-1627734456"><span class="hs-identifier">entry</span></a></a><span> </span><a name="local-1627734457"><a href="#local-1627734457"><span class="hs-identifier">code</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUTranslSkel"><span class="hs-identifier hs-var">CUTranslSkel</span></a><span> </span><a href="#local-1627734456"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-1627734457"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-comment">-- Core implementation</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- -------------------</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-keyword">data</span><span> </span><a name="Direction"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#Direction"><span class="hs-identifier">Direction</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="L"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#L"><span class="hs-identifier">L</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="R"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#R"><span class="hs-identifier">R</span></a></a><span>
</span><a name="line-93"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Eq</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#Direction"><span class="hs-identifier hs-type">Direction</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-96"></a><span>  </span><a name="local-1912611642"><span class="hs-identifier">show</span></a><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;l&quot;</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-identifier">show</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#R"><span class="hs-identifier hs-var">R</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;r&quot;</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-comment">-- [OVERVIEW]</span><span>
</span><a name="line-101"></a><span class="hs-comment">--</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- Data.List-style exclusive scan, with the additional restriction that the</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- first argument needs to be an /associative/ function to enable efficient</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- parallel implementation. The initial value may be arbitrary.</span><span>
</span><a name="line-105"></a><span class="hs-comment">--</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- scanl :: Elt a</span><span>
</span><a name="line-107"></a><span class="hs-comment">--       =&gt; (Exp a -&gt; Exp a -&gt; Exp a)</span><span>
</span><a name="line-108"></a><span class="hs-comment">--       -&gt; Exp a</span><span>
</span><a name="line-109"></a><span class="hs-comment">--       -&gt; Acc (Vector a)</span><span>
</span><a name="line-110"></a><span class="hs-comment">--       -&gt; Acc (Vector a)</span><span>
</span><a name="line-111"></a><span class="hs-comment">--</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- &gt; scanl (+) 10 (use xs)</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- &gt;   where</span><span>
</span><a name="line-114"></a><span class="hs-comment">-- &gt;     xs = fromList (Z:.10) (cycle [1])</span><span>
</span><a name="line-115"></a><span class="hs-comment">-- &gt;</span><span>
</span><a name="line-116"></a><span class="hs-comment">-- &gt; ==&gt; Array (Z:.11) [10,11,12,13,14,15,16,17,18,19,20]</span><span>
</span><a name="line-117"></a><span class="hs-comment">--</span><span>
</span><a name="line-118"></a><span class="hs-comment">-- Data.List-style inclusive scan without an initial value</span><span>
</span><a name="line-119"></a><span class="hs-comment">--</span><span>
</span><a name="line-120"></a><span class="hs-comment">-- scanl1 :: Elt a</span><span>
</span><a name="line-121"></a><span class="hs-comment">--        =&gt; (Exp a -&gt; Exp a -&gt; Exp a)</span><span>
</span><a name="line-122"></a><span class="hs-comment">--        -&gt; Acc (Vector a)</span><span>
</span><a name="line-123"></a><span class="hs-comment">--        -&gt; Acc (Vector a)</span><span>
</span><a name="line-124"></a><span class="hs-comment">--</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- &gt; scanl1 (+) (use xs)</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- &gt;   where</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- &gt;     xs = fromList (Z:.10) (cycle [1])</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- &gt;</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- &gt; ==&gt; Array (Z:.10) [1,2,3,4,5,6,7,8,9,10]</span><span>
</span><a name="line-130"></a><span class="hs-comment">--</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- Variant of 'scanl' where the final result is returned separately.</span><span>
</span><a name="line-132"></a><span class="hs-comment">--</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- scanl' :: Elt a</span><span>
</span><a name="line-134"></a><span class="hs-comment">--        =&gt; (Exp a -&gt; Exp a -&gt; Exp a)</span><span>
</span><a name="line-135"></a><span class="hs-comment">--        -&gt; Exp a</span><span>
</span><a name="line-136"></a><span class="hs-comment">--        -&gt; Acc (Vector a)</span><span>
</span><a name="line-137"></a><span class="hs-comment">--        -&gt; (Acc (Vector a), Acc (Scalar a))</span><span>
</span><a name="line-138"></a><span class="hs-comment">--</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- Denotationally, we have:</span><span>
</span><a name="line-140"></a><span class="hs-comment">--</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- &gt; scanl' f z xs = (init res, last res)</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- &gt;   where</span><span>
</span><a name="line-143"></a><span class="hs-comment">-- &gt;     res = scanl f z xs</span><span>
</span><a name="line-144"></a><span class="hs-comment">--</span><span>
</span><a name="line-145"></a><span class="hs-comment">--</span><span>
</span><a name="line-146"></a><span class="hs-comment">-- [IMPLEMENTATION]</span><span>
</span><a name="line-147"></a><span class="hs-comment">--</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- This code handles all the above cases, in both left and right-handed</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- variants. This is the _downsweep_ phase to a multi-block scan procedure.</span><span>
</span><a name="line-150"></a><span class="hs-comment">-- We require a work distribution such that there is a _single_ thread block for</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- each interval. For multi-block scans, we have an array of interval sums that</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- are used to determine the carry-in value from the previous interval. Note</span><span>
</span><a name="line-153"></a><span class="hs-comment">-- that 'argBlk' will not be accessed by a single-block scan, so may be null.</span><span>
</span><a name="line-154"></a><span class="hs-comment">--</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- We require some pointer manipulation from the calling code in order to</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- support all types of scans:</span><span>
</span><a name="line-157"></a><span class="hs-comment">--</span><span>
</span><a name="line-158"></a><span class="hs-comment">--   * scanl          : argSum should point to the last position of argOut</span><span>
</span><a name="line-159"></a><span class="hs-comment">--   * scanr          : argSum should be the start of argOut, argOut should be incremented by one</span><span>
</span><a name="line-160"></a><span class="hs-comment">--   * scanl1, scanr1 : no change (argSum is required, even though it will not be used Haskell-side)</span><span>
</span><a name="line-161"></a><span class="hs-comment">--   * scanl', scanr' : no change</span><span>
</span><a name="line-162"></a><span class="hs-comment">--</span><span>
</span><a name="line-163"></a><span class="hs-identifier">mkScan</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1627734419"><a href="#local-1627734419"><span class="hs-identifier">aenv</span></a></a><span> </span><a name="local-1627734420"><a href="#local-1627734420"><span class="hs-identifier">e</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Elt</span><span> </span><a href="#local-1627734420"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-164"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#Direction"><span class="hs-identifier hs-type">Direction</span></a><span>
</span><a name="line-165"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DeviceProperties</span><span>
</span><a name="line-166"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.AST.html#Gamma"><span class="hs-identifier hs-type">Gamma</span></a><span> </span><a href="#local-1627734419"><span class="hs-identifier hs-type">aenv</span></a><span>
</span><a name="line-167"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUFun2"><span class="hs-identifier hs-type">CUFun2</span></a><span> </span><a href="#local-1627734419"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627734420"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627734420"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627734420"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUExp"><span class="hs-identifier hs-type">CUExp</span></a><span> </span><a href="#local-1627734419"><span class="hs-identifier hs-type">aenv</span></a><span> </span><a href="#local-1627734420"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUDelayedAcc"><span class="hs-identifier hs-type">CUDelayedAcc</span></a><span> </span><a href="#local-1627734419"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-identifier hs-type">DIM1</span><span> </span><a href="#local-1627734420"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-170"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUTranslSkel"><span class="hs-identifier hs-type">CUTranslSkel</span></a><span> </span><a href="#local-1627734419"><span class="hs-identifier hs-type">aenv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Vector</span><span> </span><a href="#local-1627734420"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-171"></a><a name="mkScan"><a href="Data.Array.Accelerate.CUDA.CodeGen.PrefixSum.html#mkScan"><span class="hs-identifier">mkScan</span></a></a><span> </span><a name="local-1627734458"><a href="#local-1627734458"><span class="hs-identifier">dir</span></a></a><span> </span><a name="local-1627734459"><a href="#local-1627734459"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-1627734460"><a href="#local-1627734460"><span class="hs-identifier">aenv</span></a></a><span> </span><a name="local-1627734461"><a href="#local-1627734461"><span class="hs-identifier">fun</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUFun2"><span class="hs-identifier hs-var">CUFun2</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627734462"><a href="#local-1627734462"><span class="hs-identifier">combine</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627734463"><a href="#local-1627734463"><span class="hs-identifier">mseed</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUDelayed"><span class="hs-identifier hs-var">CUDelayed</span></a><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUExp"><span class="hs-identifier hs-var">CUExp</span></a><span> </span><a name="local-1627734464"><a href="#local-1627734464"><span class="hs-identifier">shIn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUFun1"><span class="hs-identifier hs-var">CUFun1</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627734465"><a href="#local-1627734465"><span class="hs-identifier">get</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-172"></a><span>  </span><a href="Data.Array.Accelerate.CUDA.CodeGen.Base.html#CUTranslSkel"><span class="hs-identifier hs-var">CUTranslSkel</span></a><span> </span><a href="#local-1627734466"><span class="hs-identifier hs-var">scan</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier">cunit</span><span class="hs-glyph">|</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span>    </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">esc</span><span class="hs-glyph">:</span><span class="hs-special">(</span><span class="hs-string">&quot;#include &lt;accelerate_cuda.h&gt;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">edecls</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">texIn</span><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span>    </span><span class="hs-identifier hs-var">extern</span><span> </span><span class="hs-string">&quot;C&quot;</span><span> </span><span class="hs-identifier hs-var">__global__</span><span> </span><span class="hs-identifier hs-var">void</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">id</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">scan</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-special">(</span><span>
</span><a name="line-180"></a><span>        </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">params</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">argIn</span><span class="hs-special">,</span><span>
</span><a name="line-181"></a><span>        </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">params</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">argOut</span><span class="hs-special">,</span><span>
</span><a name="line-182"></a><span>        </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">params</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">argBlk</span><span class="hs-special">,</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">params</span><span class="hs-glyph">:</span><span class="hs-special">(</span><span class="hs-identifier hs-var">tail</span><span> </span><span class="hs-identifier hs-var">argSum</span><span class="hs-special">)</span><span>           </span><span class="hs-operator hs-var">//</span><span> </span><span class="hs-identifier hs-var">just</span><span> </span><span class="hs-identifier hs-var">the</span><span> </span><span class="hs-identifier hs-var">pointers</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">no</span><span> </span><span class="hs-identifier hs-var">shape</span><span> </span><span class="hs-identifier hs-var">information</span><span>
</span><a name="line-184"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-special">{</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">decls</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">smem</span><span>
</span><a name="line-187"></a><span>        </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">decls</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">declt</span><span>
</span><a name="line-188"></a><span>        </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">decls</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">declx</span><span>
</span><a name="line-189"></a><span>        </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">decls</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">decly</span><span>
</span><a name="line-190"></a><span>        </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">decls</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">declz</span><span>
</span><a name="line-191"></a><span>        </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">items</span><span class="hs-glyph">:</span><span class="hs-special">(</span><span class="hs-identifier hs-var">sh</span><span> </span><span class="hs-operator hs-var">.=.</span><span> </span><span class="hs-identifier hs-var">shIn</span><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span>        </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-identifier hs-var">shapeSize</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">exp</span><span class="hs-glyph">:</span><span class="hs-special">(</span><span class="hs-identifier hs-var">csize</span><span> </span><span class="hs-identifier hs-var">sh</span><span class="hs-special">)</span><span class="hs-special">;</span><span>
</span><a name="line-194"></a><span>        </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-identifier hs-var">intervalSize</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">shapeSize</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">gridDim</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">x</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/</span><span> </span><span class="hs-identifier hs-var">gridDim</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">x</span><span class="hs-special">;</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>        </span><span class="hs-operator hs-var">/*</span><span>
</span><a name="line-197"></a><span>         </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">Read</span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">previous</span><span> </span><span class="hs-identifier hs-var">result</span><span> </span><span class="hs-identifier hs-var">partial</span><span> </span><span class="hs-identifier hs-var">sum</span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">We</span><span> </span><span class="hs-identifier hs-var">store</span><span> </span><span class="hs-identifier hs-var">the</span><span> </span><span class="hs-identifier hs-var">carry</span><span> </span><span class="hs-identifier hs-var">value</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-198"></a><span>         </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">temporary</span><span> </span><span class="hs-identifier hs-var">value</span><span> </span><span class="hs-char">'z'</span><span> </span><span class="hs-identifier hs-var">and</span><span> </span><span class="hs-identifier hs-var">read</span><span> </span><span class="hs-identifier hs-var">new</span><span> </span><span class="hs-identifier hs-var">values</span><span> </span><span class="hs-identifier hs-var">from</span><span> </span><span class="hs-identifier hs-var">the</span><span> </span><span class="hs-identifier hs-var">input</span><span> </span><span class="hs-identifier hs-var">array</span><span> </span><span class="hs-identifier hs-var">into</span><span>
</span><a name="line-199"></a><span>         </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-char">'x'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">since</span><span> </span><span class="hs-char">'scanBlock' will store its results into 'y' on completion.
         */
        int carryIn = 0;

        if ( threadIdx.x == 0 ) {
            $stm:initialise
        }

        const int start         = blockIdx.x * intervalSize;
        const int end           = min(start + intervalSize, shapeSize);
        const int numElements   = end - start;
              int seg;

        for ( seg = threadIdx.x
            ; seg &lt; numElements
            ; seg += blockDim.x )
        {
            const int ix = $exp:firstIndex;

            /*
             * Generate the next set of values
             */
            $items:(x .=. get ix)

            /*
             * Carry in the result from the privous segment
             */
            if ( $exp:carryIn ) {
                $items:(t .=. combine z x)
                $items:(x .=. t)
            }

            /*
             * Store our input into shared memory and perform a cooperative
             * inclusive left scan.
             */
            $items:(sdata &quot;threadIdx.x&quot; .=. x)
            __syncthreads();

            $items:(scanBlock dev fun x y t sdata Nothing)

            /*
             * Exclusive scans write the result of the previous thread to global
             * memory. The first thread must reinstate the carry-in value which
             * is the result of the last thread from the previous interval, or
             * the carry-in/seed value for multi-block scans.
             */
            if ( $exp:(cbool (isJust mseed)) ) {
                if ( threadIdx.x == 0 ) {
                    $items:(x .=. z)
                } else {
                    $items:(x .=. sdata &quot;threadIdx.x - 1&quot;)
                }
            }
            $items:(setOut &quot;ix&quot; .=. x)

            /*
             * Carry the final result of this block through the set 'z'. If this
             * is the final interval, this is the value to write out as the
             * reduction result
             */
            if ( threadIdx.x == 0 ) {
                const int last = min(numElements - seg, blockDim.x) - 1;
                $items:(z .=. sdata &quot;last&quot;)
            }
            $items:setCarry
        }

        /*
         * Finally, exclusive scans set the overall scan result (reduction value)
         */
        $items:setFinal
    }
  |]
  where
    scan                        = &quot;scan&quot; ++ show dir ++ maybe &quot;1&quot; (const []) mseed
    (texIn, argIn)              = environment dev aenv
    (argOut, _, setOut)         = writeArray &quot;Out&quot; (undefined :: Vector e)
    (argSum, _, totalSum)       = writeArray &quot;Sum&quot; (undefined :: Vector e)
    (argBlk, _, blkSum)         = writeArray &quot;Blk&quot; (undefined :: Vector e)
    (_, t, declt)               = locals &quot;t&quot; (undefined :: e)
    (_, x, declx)               = locals &quot;x&quot; (undefined :: e)
    (_, y, decly)               = locals &quot;y&quot; (undefined :: e)
    (_, z, declz)               = locals &quot;z&quot; (undefined :: e)
    (sh, _, _)                  = locals &quot;sh&quot; (undefined :: DIM1)
    (smem, sdata)               = shared (undefined :: e) &quot;sdata&quot; [cexp| blockDim.x |] Nothing
    ix                          = [cvar &quot;ix&quot;]
    setSum                      = totalSum &quot;0&quot;

    -- depending on whether we are inclusive/exclusive scans
    setCarry
      | isNothing mseed         = [[citem| carryIn = 1; |]]
      | otherwise               = []

    setFinal
      | isNothing mseed         = []
      | otherwise               = [[citem| if ( threadIdx.x == 0 &amp;&amp; blockIdx.x == $id:lastBlock ) {
                                               $items:(setSum .=. z)
                                           } |]]

    -- accessing neighbouring blocks
    firstBlock          = if dir == L then &quot;0&quot; else &quot;gridDim.x - 1&quot;
    lastBlock           = if dir == R then &quot;0&quot; else &quot;gridDim.x - 1&quot;
    prevBlock           = if dir == L then &quot;blockIdx.x - 1&quot; else &quot;blockIdx.x + 1&quot;

    firstIndex
      | dir == L        = [cexp| start + seg |]
      | otherwise       = [cexp| end - seg - 1 |]

    carryIn
      | isJust mseed    = [cexp| threadIdx.x == 0 |]
      | otherwise       = [cexp| threadIdx.x == 0 &amp;&amp; carryIn |]

    -- initialise the first thread with the results of the previous block sweep
    -- or exclusive scan element
    initialise
      | Just (CUExp seed) &lt;- mseed
      = [cstm|  if ( gridDim.x &gt; 1 ) {
                    $items:(z .=. blkSum &quot;blockIdx.x&quot;)
                } else {
                    $items:(z .=. seed)
                }
        |]

      | otherwise
      = [cstm|  if ( blockIdx.x != $id:firstBlock ) {
                    $items:(z .=. blkSum prevBlock)
                    carryIn = 1;
                }
        |]


-- This computes the _upsweep_ phase of a multi-block scan. This is much like a
-- regular inclusive scan, except that only the final value for each interval is
-- output, rather than the entire body of the scan. Indeed, if the combination
-- function were commutative, this is equivalent to a parallel tree reduction.
--
mkScanUp1
    :: forall aenv e. Elt e
    =&gt; Direction
    -&gt; DeviceProperties
    -&gt; Gamma aenv
    -&gt; CUFun2 aenv (e -&gt; e -&gt; e)
    -&gt; CUDelayedAcc aenv DIM1 e
    -&gt; CUTranslSkel aenv (Vector e)
mkScanUp1 dir dev aenv fun@(CUFun2 _ _ combine) (CUDelayed (CUExp shIn) _ (CUFun1 _ get)) =
  CUTranslSkel scan [cunit|

    $esc:(&quot;#include &lt;accelerate_cuda.h&gt;&quot;)
    $edecls:texIn

    extern &quot;C&quot; __global__ void
    $id:scan
    (
        $params:argIn,
        $params:argOut
    )
    {
        $decls:smem
        $decls:declt
        $decls:declx
        $decls:decly
        $items:(sh .=. shIn)

        const int shapeSize     = $exp:(csize sh);
        const int intervalSize  = (shapeSize + gridDim.x - 1) / gridDim.x;

        const int start         = blockIdx.x * intervalSize;
        const int end           = min(start + intervalSize, shapeSize);
        const int numElements   = end - start;
              int carryIn       = 0;
              int seg;

        for ( seg = threadIdx.x
            ; seg &lt; numElements
            ; seg += blockDim.x )
        {
            const int ix = $exp:firstIndex ;

            /*
             * Read in new values, combine with carry-in
             */
            $items:(x .=. get ix)

            if ( threadIdx.x == 0 &amp;&amp; carryIn ) {
                $items:(t .=. combine y x)
                $items:(x .=. t)
            }

            /*
             * Store in shared memory and cooperatively scan
             */
            $items:(sdata &quot;threadIdx.x&quot; .=. x)
            __syncthreads();

            $items:(scanBlock dev fun x y t sdata Nothing)

            /*
             * Store the final result of the block to be carried in
             */
            if ( threadIdx.x == 0 ) {
                const int last = min(numElements - seg, blockDim.x) - 1;
                $items:(y .=. sdata &quot;last&quot;)
            }
            carryIn = 1;
        }

        /*
         * Finally, the first thread writes the result of this interval
         */
        if ( threadIdx.x == 0 ) {
            $items:(setOut &quot;blockIdx.x&quot; .=. y)
        }
    }
  |]
  where
    scan                        = &quot;scan&quot; ++ show dir ++ &quot;Up&quot;
    (texIn, argIn)              = environment dev aenv
    (argOut, _, setOut)         = writeArray &quot;Out&quot; (undefined :: Vector e)
    (_, x, declx)               = locals &quot;x&quot; (undefined :: e)
    (_, y, decly)               = locals &quot;y&quot; (undefined :: e)
    (_, t, declt)               = locals &quot;t&quot; (undefined :: e)
    (sh, _, _)                  = locals &quot;sh&quot; (undefined :: DIM1)
    (smem, sdata)               = shared (undefined :: e) &quot;sdata&quot; [cexp| blockDim.x |] Nothing
    ix                          = [cvar &quot;ix&quot;]

    firstIndex
      | dir == L                = [cexp| start + seg |]
      | otherwise               = [cexp| end - seg - 1 |]


-- Second step of the upsweep phase: scan the interval sums to produce carry-in
-- values for each block of the final downsweep step
--
mkScanUp2
    :: forall aenv e. Elt e
    =&gt; Direction
    -&gt; DeviceProperties
    -&gt; Gamma aenv
    -&gt; CUFun2 aenv (e -&gt; e -&gt; e)
    -&gt; Maybe (CUExp aenv e)
    -&gt; CUTranslSkel aenv (Vector e)
mkScanUp2 dir dev aenv f z
  = let (_, _, get) = readArray &quot;Blk&quot; (undefined :: Vector e)
    in  mkScan dir dev aenv f z get


-- Block scans
-- ===========

scanBlock
    :: forall aenv e. Elt e
    =&gt; DeviceProperties
    -&gt; CUFun2 aenv (e -&gt; e -&gt; e)
    -&gt; [C.Exp] -&gt; [C.Exp] -&gt; [C.Exp]
    -&gt; (Name -&gt; [C.Exp])
    -&gt; Maybe C.Exp
    -&gt; [C.BlockItem]
scanBlock dev f x0 x1 x2 sdata mlim
  | shflOK dev (undefined :: e) = error &quot;shfl-scan&quot;
  | otherwise                   = scanBlockTree dev f x0 x1 x2 sdata mlim


-- Use a thread block to scan values in shared memory. Each thread must have
-- already stored its initial value into shared memory. The final result for
-- this thread will be stored in x0 as well as the appropriate place in shared
-- memory.
--
scanBlockTree
    :: forall aenv e. Elt e
    =&gt; DeviceProperties
    -&gt; CUFun2 aenv (e -&gt; e -&gt; e)
    -&gt; [C.Exp] -&gt; [C.Exp] -&gt; [C.Exp]    -- input variables x0 and x1, plus a temporary to store the intermediate value
    -&gt; (Name -&gt; [C.Exp])                -- index elements from shared memory
    -&gt; Maybe C.Exp                      -- partially full block bounds check?
    -&gt; [C.BlockItem]
scanBlockTree dev (CUFun2 _ _ f) x0 x1 x2 sdata mlim = map (scan . pow2) [ 0 .. maxThreads ]
  where
    pow2 :: Int -&gt; Int
    pow2 x      = 2 ^ x
    maxThreads  = floor (logBase 2 (fromIntegral $ maxThreadsPerBlock dev :: Double))

    inrange n
      | Just m &lt;- mlim  = [cexp| threadIdx.x &gt;= $int:n &amp;&amp; threadIdx.x &lt; $exp:m |]
      | otherwise       = [cexp| threadIdx.x &gt;= $int:n |]

    scan n = [citem|
      if ( blockDim.x &gt; $int:n ) {
          if ( $exp:(inrange n) ) {
              $items:(x1 .=. sdata (&quot;threadIdx.x - &quot; ++ show n))
              $items:(x2 .=. f x1 x0)
              $items:(x0 .=. x2)
          }
          __syncthreads();
          $items:(sdata &quot;threadIdx.x&quot; .=. x0)
          __syncthreads();
      }
      |]


-- Shuffle scan
-- ------------

shflOK :: Elt e =&gt; DeviceProperties -&gt; e -&gt; Bool
shflOK _dev _ = False
-- shflOk dev dummy
--   = computeCapability dev &gt;= Compute 3 0 &amp;&amp; all (`elem` [4,8]) (eltSizeOf dummy)

{--
scanWarpShfl
    :: forall aenv e. Elt e
    =&gt; DeviceProperties
    -&gt; CUFun2 aenv (e -&gt; e -&gt; e)
    -&gt; [C.Exp] -&gt; [C.Exp]               -- temporary variables x0 and x1
    -&gt; Maybe C.Exp                      -- partially full block bounds check
    -&gt; C.Exp                            -- thread identified, usually lane or thread ID
    -&gt; C.Stm
scanWarpShfl _dev (CUFun2 f) x0 x1 mlim tid
  = [cstm|
      for ( int z = 1; z &lt;= warpSize; z *= 2 ) {
          $items:(x0 .=. shfl_up x1)

          if ( $exp:inrange ) {
              $items:(x1 .=. f x1 x0)
          }
      }
    |]
  where
    inrange
      | Just m &lt;- mlim  = [cexp| $exp:tid &gt;= z &amp;&amp; $exp:tid &lt; $exp:m |]
      | otherwise       = [cexp| $exp:tid &gt;= z |]

    sizeof      = eltSizeOf (undefined :: e)
    shfl_up     = zipWith (\s x -&gt; ccall (shfl s) [ x, cvar &quot;z&quot; ]) sizeof
      where
        shfl 4  = &quot;shfl_up32&quot;
        shfl 8  = &quot;shfl_up64&quot;
        shfl _  = INTERNAL_ERROR(error) &quot;shfl_up&quot; &quot;I only know about 32- and 64-bit types&quot;
--}

</span></pre></body></html>