<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Data/Array/Accelerate/LLVM/Native/Compile/Optimise.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- |</span>
<a name="line-2"></a><span class='hs-comment'>-- Module      : Data.Array.Accelerate.LLVM.Native.Compile.Optimise</span>
<a name="line-3"></a><span class='hs-comment'>-- Copyright   : [2014..2015] Trevor L. McDonell</span>
<a name="line-4"></a><span class='hs-comment'>--               [2014..2014] Vinod Grover (NVIDIA Corporation)</span>
<a name="line-5"></a><span class='hs-comment'>-- License     : BSD3</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>-- Maintainer  : Trevor L. McDonell &lt;tmcdonell@cse.unsw.edu.au&gt;</span>
<a name="line-8"></a><span class='hs-comment'>-- Stability   : experimental</span>
<a name="line-9"></a><span class='hs-comment'>-- Portability : non-portable (GHC extensions)</span>
<a name="line-10"></a><span class='hs-comment'>--</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>LLVM</span><span class='hs-varop'>.</span><span class='hs-conid'>Native</span><span class='hs-varop'>.</span><span class='hs-conid'>Compile</span><span class='hs-varop'>.</span><span class='hs-conid'>Optimise</span> <span class='hs-layout'>(</span>
<a name="line-13"></a>
<a name="line-14"></a>  <span class='hs-varid'>optimiseModule</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-comment'>-- llvm-general</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LLVM</span><span class='hs-varop'>.</span><span class='hs-conid'>General</span><span class='hs-varop'>.</span><span class='hs-conid'>AST</span><span class='hs-varop'>.</span><span class='hs-conid'>DataLayout</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LLVM</span><span class='hs-varop'>.</span><span class='hs-conid'>General</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LLVM</span><span class='hs-varop'>.</span><span class='hs-conid'>General</span><span class='hs-varop'>.</span><span class='hs-conid'>PassManager</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LLVM</span><span class='hs-varop'>.</span><span class='hs-conid'>General</span><span class='hs-varop'>.</span><span class='hs-conid'>Target</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-comment'>-- accelerate</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>LLVM</span><span class='hs-varop'>.</span><span class='hs-conid'>Native</span><span class='hs-varop'>.</span><span class='hs-conid'>Debug</span>        <span class='hs-keyword'>as</span> <span class='hs-conid'>Debug</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-comment'>-- standard library</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>Printf</span>
<a name="line-29"></a>
<a name="line-30"></a>
<a name="line-31"></a><a name="optimiseModule"></a><span class='hs-comment'>-- | Run the standard optimisations on the given module when targeting a</span>
<a name="line-32"></a><span class='hs-comment'>-- specific machine and data layout. Specifically, this will run the</span>
<a name="line-33"></a><span class='hs-comment'>-- optimisation passes such that LLVM has the necessary information to</span>
<a name="line-34"></a><span class='hs-comment'>-- automatically vectorise loops (whenever it deems beneficial to do so).</span>
<a name="line-35"></a><span class='hs-comment'>--</span>
<a name="line-36"></a><span class='hs-definition'>optimiseModule</span>
<a name="line-37"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DataLayout</span>
<a name="line-38"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TargetMachine</span>
<a name="line-39"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TargetLibraryInfo</span>
<a name="line-40"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-41"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-42"></a><span class='hs-definition'>optimiseModule</span> <span class='hs-varid'>datalayout</span> <span class='hs-varid'>machine</span> <span class='hs-varid'>libinfo</span> <span class='hs-varid'>mdl</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-43"></a>
<a name="line-44"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>p1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultCuratedPassSetSpec</span>
<a name="line-45"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>optLevel</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-num'>3</span>
<a name="line-46"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>dataLayout</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>datalayout</span>
<a name="line-47"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>targetMachine</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>machine</span>
<a name="line-48"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>targetLibraryInfo</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libinfo</span>
<a name="line-49"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>loopVectorize</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>True</span>
<a name="line-50"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>superwordLevelParallelismVectorize</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>True</span>
<a name="line-51"></a>            <span class='hs-layout'>}</span>
<a name="line-52"></a>  <span class='hs-varid'>b1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withPassManager</span> <span class='hs-varid'>p1</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runPassManager</span> <span class='hs-varid'>pm</span> <span class='hs-varid'>mdl</span>
<a name="line-53"></a>
<a name="line-54"></a>  <span class='hs-conid'>Debug</span><span class='hs-varop'>.</span><span class='hs-varid'>traceIO</span> <span class='hs-conid'>Debug</span><span class='hs-varop'>.</span><span class='hs-varid'>dump_cc</span> <span class='hs-varop'>$</span>
<a name="line-55"></a>    <span class='hs-varid'>printf</span> <span class='hs-str'>"llvm: optimisation did work? %s"</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>b1</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-comment'>{--
<a name="line-58"></a>-- The first gentle optimisation pass. I think this is usually done when loading
<a name="line-59"></a>-- the module?
<a name="line-60"></a>--
<a name="line-61"></a>-- This is the first section of output running 'opt -O3 -debug-pass=Arguments'
<a name="line-62"></a>--
<a name="line-63"></a>-- Pass Arguments:
<a name="line-64"></a>--  -datalayout -notti -basictti -x86tti -no-aa -tbaa -targetlibinfo -basicaa
<a name="line-65"></a>--  -preverify -domtree -verify -simplifycfg -domtree -sroa -early-cse
<a name="line-66"></a>--  -lower-expect
<a name="line-67"></a>--
<a name="line-68"></a>prepass :: [Pass]
<a name="line-69"></a>prepass =
<a name="line-70"></a>  [ SimplifyControlFlowGraph
<a name="line-71"></a>  , ScalarReplacementOfAggregates { requiresDominatorTree = True }
<a name="line-72"></a>  , EarlyCommonSubexpressionElimination
<a name="line-73"></a>  , LowerExpectIntrinsic
<a name="line-74"></a>  ]
<a name="line-75"></a>
<a name="line-76"></a>-- The main optimisation pipeline. This mostly matches the process of running
<a name="line-77"></a>-- 'opt -O3 -debug-pass=Arguments'. We are missing dead argument elimination and
<a name="line-78"></a>-- in particular, slp-vectorizer (super-word level parallelism).
<a name="line-79"></a>--
<a name="line-80"></a>-- Pass Arguments:
<a name="line-81"></a>--   -targetlibinfo -datalayout -notti -basictti -x86tti -no-aa -tbaa -basicaa
<a name="line-82"></a>--   -globalopt -ipsccp -deadargelim -instcombine -simplifycfg -basiccg -prune-eh
<a name="line-83"></a>--   -inline-cost -inline -functionattrs -argpromotion -sroa -domtree -early-cse
<a name="line-84"></a>--   -lazy-value-info -jump-threading -correlated-propagation -simplifycfg
<a name="line-85"></a>--   -instcombine -tailcallelim -simplifycfg -reassociate -domtree -loops
<a name="line-86"></a>--   -loop-simplify -lcssa -loop-rotate -licm -lcssa -loop-unswitch -instcombine
<a name="line-87"></a>--   -scalar-evolution -loop-simplify -lcssa -indvars -loop-idiom -loop-deletion
<a name="line-88"></a>--   -loop-unroll -memdep -gvn -memdep -memcpyopt -sccp -instcombine
<a name="line-89"></a>--   -lazy-value-info -jump-threading -correlated-propagation -domtree -memdep -dse
<a name="line-90"></a>--   -loops -scalar-evolution -slp-vectorizer -adce -simplifycfg -instcombine
<a name="line-91"></a>--   -barrier -domtree -loops -loop-simplify -lcssa -scalar-evolution
<a name="line-92"></a>--   -loop-simplify -lcssa -loop-vectorize -instcombine -simplifycfg
<a name="line-93"></a>--   -strip-dead-prototypes -globaldce -constmerge -preverify -domtree -verify
<a name="line-94"></a>--
<a name="line-95"></a>optpass :: [Pass]
<a name="line-96"></a>optpass =
<a name="line-97"></a>  [
<a name="line-98"></a>    InterproceduralSparseConditionalConstantPropagation                 -- ipsccp
<a name="line-99"></a>  , InstructionCombining
<a name="line-100"></a>  , SimplifyControlFlowGraph
<a name="line-101"></a>  , PruneExceptionHandling
<a name="line-102"></a>  , FunctionInlining { functionInliningThreshold = 275 }                -- -O2 =&gt; 275
<a name="line-103"></a>  , FunctionAttributes
<a name="line-104"></a>  , ArgumentPromotion                                                   -- not needed?
<a name="line-105"></a>  , ScalarReplacementOfAggregates { requiresDominatorTree = True }      -- false?
<a name="line-106"></a>  , EarlyCommonSubexpressionElimination
<a name="line-107"></a>  , JumpThreading
<a name="line-108"></a>  , CorrelatedValuePropagation
<a name="line-109"></a>  , SimplifyControlFlowGraph
<a name="line-110"></a>  , InstructionCombining
<a name="line-111"></a>  , TailCallElimination
<a name="line-112"></a>  , SimplifyControlFlowGraph
<a name="line-113"></a>  , Reassociate
<a name="line-114"></a>  , LoopRotate
<a name="line-115"></a>  , LoopInvariantCodeMotion
<a name="line-116"></a>  , LoopClosedSingleStaticAssignment
<a name="line-117"></a>  , LoopUnswitch { optimizeForSize = False }
<a name="line-118"></a>  , LoopInstructionSimplify
<a name="line-119"></a>  , InstructionCombining
<a name="line-120"></a>  , InductionVariableSimplify
<a name="line-121"></a>  , LoopIdiom
<a name="line-122"></a>  , LoopDeletion
<a name="line-123"></a>  , LoopUnroll { loopUnrollThreshold = Nothing
<a name="line-124"></a>               , count               = Nothing
<a name="line-125"></a>               , allowPartial        = Nothing }
<a name="line-126"></a>  , GlobalValueNumbering { noLoads = False }    -- True to add memory dependency analysis
<a name="line-127"></a>  , SparseConditionalConstantPropagation
<a name="line-128"></a>  , InstructionCombining
<a name="line-129"></a>  , JumpThreading
<a name="line-130"></a>  , CorrelatedValuePropagation
<a name="line-131"></a>  , DeadStoreElimination
<a name="line-132"></a>  , defaultVectorizeBasicBlocks                 -- instead of slp-vectorizer?
<a name="line-133"></a>  , AggressiveDeadCodeElimination
<a name="line-134"></a>  , SimplifyControlFlowGraph
<a name="line-135"></a>  , InstructionCombining
<a name="line-136"></a>  , LoopVectorize
<a name="line-137"></a>  , InstructionCombining
<a name="line-138"></a>  , SimplifyControlFlowGraph
<a name="line-139"></a>  , GlobalDeadCodeElimination
<a name="line-140"></a>  , ConstantMerge
<a name="line-141"></a>  ]
<a name="line-142"></a>--}</span>
<a name="line-143"></a>
</pre></body>
</html>
