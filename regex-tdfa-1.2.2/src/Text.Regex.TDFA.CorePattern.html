<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | The CorePattern module deconstructs the Pattern tree created by</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- ReadRegex.parseRegex and returns a simpler Q\/P tree with</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- annotations at each Q node.  This will be converted by the TNFA</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- module into a QNFA finite automata.</span><span>
</span><a name="line-5"></a><span class="hs-comment">--</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Of particular note, this Pattern to Q\/P conversion creates and</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- assigns all the internal Tags that will be used during the matching</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- process, and associates the captures groups with the tags that</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- represent their starting and ending locations and with their</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- immediate parent group.</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Each Maximize and Minimize tag is held as either a preTag or a</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- postTag by one and only one location in the Q\/P tree.  The Orbit</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- tags are each held by one and only one Star node.  Tags that stop a</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- Group are also held in perhaps numerous preReset lists.</span><span>
</span><a name="line-16"></a><span class="hs-comment">--</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- The additional nullQ::nullView field of Q records the potentially</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- complex information about what tests and tags must be used if the</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- pattern unQ::P matches 0 zero characters.  There can be redundancy</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- in nullView, which is eliminated by cleanNullView.</span><span>
</span><a name="line-21"></a><span class="hs-comment">--</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- Uses recursive do notation.</span><span>
</span><a name="line-23"></a><span class="hs-comment">--</span><span>
</span><a name="line-24"></a><span class="hs-comment">-- 2009 XXX TODO: we can avoid needing tags in the part of the pattern</span><span>
</span><a name="line-25"></a><span class="hs-comment">-- after the last capturing group (when right-associative).  This is</span><span>
</span><a name="line-26"></a><span class="hs-comment">-- flipped for left-associative where the front of the pattern before</span><span>
</span><a name="line-27"></a><span class="hs-comment">-- the first capturing group needs no tags.  The edge of these regions</span><span>
</span><a name="line-28"></a><span class="hs-comment">-- is subtle: both case needs a Maximize tag.  One ought to be able to</span><span>
</span><a name="line-29"></a><span class="hs-comment">-- check the Pattern: if the root is PConcat then a scan from the end</span><span>
</span><a name="line-30"></a><span class="hs-comment">-- (start) looking for the first with an embedded PGroup can be found</span><span>
</span><a name="line-31"></a><span class="hs-comment">-- and the PGroup free elements can be wrapped in some new PNOTAG</span><span>
</span><a name="line-32"></a><span class="hs-comment">-- semantic indicator.</span><span>
</span><a name="line-33"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Regex</span><span class="hs-operator">.</span><span class="hs-identifier">TDFA</span><span class="hs-operator">.</span><span class="hs-identifier">CorePattern</span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#P"><span class="hs-identifier hs-type">P</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#WhichTest"><span class="hs-identifier hs-type">WhichTest</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#Wanted"><span class="hs-identifier hs-type">Wanted</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>                                  </span><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#TestInfo"><span class="hs-identifier hs-type">TestInfo</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#OP"><span class="hs-identifier hs-type">OP</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-type">SetTestInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span>
</span><a name="line-35"></a><span>                                  </span><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#patternToQ"><span class="hs-identifier hs-var">patternToQ</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#cleanNullView"><span class="hs-identifier hs-var">cleanNullView</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#cannotAccept"><span class="hs-identifier hs-var">cannotAccept</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#mustAccept"><span class="hs-identifier hs-var">mustAccept</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">RWS</span><span> </span><span class="hs-comment">{- all -}</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">IArray</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Array</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier hs-var">accumArray</span><span class="hs-special">,</span><span class="hs-identifier hs-var">listArray</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-special">(</span><span class="hs-identifier hs-var">sort</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Data.IntMap.EnumMap2.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntMap</span><span class="hs-operator">.</span><span class="hs-identifier">EnumMap2</span></a><span class="hs-special">(</span><a href="Data.IntMap.EnumMap2.html#EnumMap"><span class="hs-identifier hs-type">EnumMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Data.IntMap.EnumMap2.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntMap</span><span class="hs-operator">.</span><span class="hs-identifier">EnumMap2</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span class="hs-special">(</span><a href="Data.IntMap.EnumMap2.html#singleton"><span class="hs-identifier hs-var">singleton</span></a><span class="hs-special">,</span><a href="Data.IntMap.EnumMap2.html#null"><span class="hs-identifier hs-var">null</span></a><span class="hs-special">,</span><a href="Data.IntMap.EnumMap2.html#assocs"><span class="hs-identifier hs-var">assocs</span></a><span class="hs-special">,</span><a href="Data.IntMap.EnumMap2.html#keysSet"><span class="hs-identifier hs-var">keysSet</span></a><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-comment">--import Data.Maybe(isNothing)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Data.IntSet.EnumSet2.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntSet</span><span class="hs-operator">.</span><span class="hs-identifier">EnumSet2</span></a><span class="hs-special">(</span><a href="Data.IntSet.EnumSet2.html#EnumSet"><span class="hs-identifier hs-type">EnumSet</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Data.IntSet.EnumSet2.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntSet</span><span class="hs-operator">.</span><span class="hs-identifier">EnumSet2</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span class="hs-special">(</span><a href="Data.IntSet.EnumSet2.html#singleton"><span class="hs-identifier hs-var">singleton</span></a><span class="hs-special">,</span><a href="Data.IntSet.EnumSet2.html#toList"><span class="hs-identifier hs-var">toList</span></a><span class="hs-special">,</span><a href="Data.IntSet.EnumSet2.html#isSubsetOf"><span class="hs-identifier hs-var">isSubsetOf</span></a><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Text.Regex.TDFA.Common.html"><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Regex</span><span class="hs-operator">.</span><span class="hs-identifier">TDFA</span><span class="hs-operator">.</span><span class="hs-identifier">Common</span></a><span> </span><span class="hs-comment">{- all -}</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="Text.Regex.TDFA.Pattern.html"><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Regex</span><span class="hs-operator">.</span><span class="hs-identifier">TDFA</span><span class="hs-operator">.</span><span class="hs-identifier">Pattern</span></a><span class="hs-special">(</span><a href="Text.Regex.TDFA.Pattern.html#Pattern"><span class="hs-identifier hs-type">Pattern</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><a href="Text.Regex.TDFA.Pattern.html#starTrans"><span class="hs-identifier hs-var">starTrans</span></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- import Debug.Trace</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">{- By Chris Kuklewicz, 2007. BSD License, see the LICENSE file. -}</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-comment">--err :: String -&gt; a</span><span>
</span><a name="line-53"></a><span class="hs-comment">--err = common_error &quot;Text.Regex.TDFA.CorePattern&quot;</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-comment">--debug :: (Show a) =&gt; a -&gt; b -&gt; b</span><span>
</span><a name="line-56"></a><span class="hs-comment">--debug _ = id</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-comment">-- Core Pattern Language</span><span>
</span><a name="line-59"></a><span class="hs-keyword">data</span><span> </span><a name="P"><a href="Text.Regex.TDFA.CorePattern.html#P"><span class="hs-identifier">P</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Empty"><a href="Text.Regex.TDFA.CorePattern.html#Empty"><span class="hs-identifier">Empty</span></a></a><span>                       </span><span class="hs-comment">-- Could be replaced by (Test Nothing)??</span><span>
</span><a name="line-60"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a name="Or"><a href="Text.Regex.TDFA.CorePattern.html#Or"><span class="hs-identifier">Or</span></a></a><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span class="hs-special">]</span><span>
</span><a name="line-61"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a name="Seq"><a href="Text.Regex.TDFA.CorePattern.html#Seq"><span class="hs-identifier">Seq</span></a></a><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span>
</span><a name="line-62"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a name="Star"><a href="Text.Regex.TDFA.CorePattern.html#Star"><span class="hs-identifier">Star</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="getOrbit"><a href="Text.Regex.TDFA.CorePattern.html#getOrbit"><span class="hs-identifier">getOrbit</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span> </span><span class="hs-comment">-- tag to prioritize the need to keep track of length of each pass though q</span><span>
</span><a name="line-63"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="resetOrbits"><a href="Text.Regex.TDFA.CorePattern.html#resetOrbits"><span class="hs-identifier">resetOrbits</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- child star's orbits to reset (ResetOrbitTask) at all depths</span><span>
</span><a name="line-64"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="firstNull"><a href="Text.Regex.TDFA.CorePattern.html#firstNull"><span class="hs-identifier">firstNull</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>     </span><span class="hs-comment">-- Usually True to mean the first pass may match 0 characters</span><span>
</span><a name="line-65"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="unStar"><a href="Text.Regex.TDFA.CorePattern.html#unStar"><span class="hs-identifier">unStar</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span class="hs-special">}</span><span>
</span><a name="line-66"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a name="Test"><a href="Text.Regex.TDFA.CorePattern.html#Test"><span class="hs-identifier">Test</span></a></a><span> </span><a href="Text.Regex.TDFA.CorePattern.html#TestInfo"><span class="hs-identifier hs-type">TestInfo</span></a><span>               </span><span class="hs-comment">-- Require the test to be true (merge with empty as (Test (Maybe TestInfo)) ??)</span><span>
</span><a name="line-67"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a name="OneChar"><a href="Text.Regex.TDFA.CorePattern.html#OneChar"><span class="hs-identifier">OneChar</span></a></a><span> </span><a href="Text.Regex.TDFA.Pattern.html#Pattern"><span class="hs-identifier hs-type">Pattern</span></a><span>             </span><span class="hs-comment">-- Bring the Pattern element that accepts a character</span><span>
</span><a name="line-68"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a name="NonEmpty"><a href="Text.Regex.TDFA.CorePattern.html#NonEmpty"><span class="hs-identifier">NonEmpty</span></a></a><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span>                  </span><span class="hs-comment">-- Don't let the Q pattern match nothing</span><span>
</span><a name="line-69"></a><span>         </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-comment">-- The diagnostics about the pattern.  Note that when unQ is 'Seq' the</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- the preTag and postTag are Nothing but the preReset might have tags</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- from PGroup injecting them.</span><span>
</span><a name="line-74"></a><span class="hs-keyword">data</span><span> </span><a name="Q"><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier">Q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Q"><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier">Q</span></a></a><span> </span><span class="hs-special">{</span><a name="nullQ"><a href="Text.Regex.TDFA.CorePattern.html#nullQ"><span class="hs-identifier">nullQ</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span>                  </span><span class="hs-comment">-- Ordered list of nullable views</span><span>
</span><a name="line-75"></a><span>           </span><span class="hs-special">,</span><a name="takes"><a href="Text.Regex.TDFA.CorePattern.html#takes"><span class="hs-identifier">takes</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Position"><span class="hs-identifier hs-type">Position</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Text.Regex.TDFA.Common.html#Position"><span class="hs-identifier hs-type">Position</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Range of number of accepted characters</span><span>
</span><a name="line-76"></a><span>           </span><span class="hs-special">,</span><a name="preReset"><a href="Text.Regex.TDFA.CorePattern.html#preReset"><span class="hs-identifier">preReset</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- Tags to &quot;reset&quot; (ResetGroupStopTask) (Only immediate children for efficiency)</span><span>
</span><a name="line-77"></a><span>           </span><span class="hs-special">,</span><a name="postSet"><a href="Text.Regex.TDFA.CorePattern.html#postSet"><span class="hs-identifier">postSet</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span>                   </span><span class="hs-comment">-- Tags to &quot;set&quot; (SetGroupStopTask)</span><span>
</span><a name="line-78"></a><span>           </span><span class="hs-special">,</span><a name="preTag"><a href="Text.Regex.TDFA.CorePattern.html#preTag"><span class="hs-identifier">preTag</span></a></a><span class="hs-special">,</span><a name="postTag"><a href="Text.Regex.TDFA.CorePattern.html#postTag"><span class="hs-identifier">postTag</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span>        </span><span class="hs-comment">-- Tags assigned around this pattern (TagTask)</span><span>
</span><a name="line-79"></a><span>           </span><span class="hs-special">,</span><a name="tagged"><a href="Text.Regex.TDFA.CorePattern.html#tagged"><span class="hs-identifier">tagged</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                     </span><span class="hs-comment">-- Whether this node should be tagged -- patternToQ use only</span><span>
</span><a name="line-80"></a><span>           </span><span class="hs-special">,</span><a name="childGroups"><a href="Text.Regex.TDFA.CorePattern.html#childGroups"><span class="hs-identifier">childGroups</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- Whether unQ has any PGroups -- patternToQ use only</span><span>
</span><a name="line-81"></a><span>           </span><span class="hs-special">,</span><a name="wants"><a href="Text.Regex.TDFA.CorePattern.html#wants"><span class="hs-identifier">wants</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Wanted"><span class="hs-identifier hs-type">Wanted</span></a><span>                    </span><span class="hs-comment">-- What kind of continuation is used by this pattern</span><span>
</span><a name="line-82"></a><span>           </span><span class="hs-special">,</span><a name="unQ"><a href="Text.Regex.TDFA.CorePattern.html#unQ"><span class="hs-identifier">unQ</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#P"><span class="hs-identifier hs-type">P</span></a><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-keyword">type</span><span> </span><a name="TestInfo"><a href="Text.Regex.TDFA.CorePattern.html#TestInfo"><span class="hs-identifier">TestInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#WhichTest"><span class="hs-identifier hs-type">WhichTest</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#DoPa"><span class="hs-identifier hs-type">DoPa</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-comment">-- This is newtype'd to allow control over class instances</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- This is a set of WhichTest where each test has associated pattern location information</span><span>
</span><a name="line-88"></a><span class="hs-keyword">newtype</span><span> </span><a name="SetTestInfo"><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier">SetTestInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SetTestInfo"><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier">SetTestInfo</span></a></a><span> </span><span class="hs-special">{</span><a name="getTests"><a href="Text.Regex.TDFA.CorePattern.html#getTests"><span class="hs-identifier">getTests</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.IntMap.EnumMap2.html#EnumMap"><span class="hs-identifier hs-type">EnumMap</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#WhichTest"><span class="hs-identifier hs-type">WhichTest</span></a><span> </span><span class="hs-special">(</span><a href="Data.IntSet.EnumSet2.html#EnumSet"><span class="hs-identifier hs-type">EnumSet</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#DoPa"><span class="hs-identifier hs-type">DoPa</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-type">SetTestInfo</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-91"></a><span>  </span><a name="local-3458764513820541483"><span class="hs-identifier">mempty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-var">SetTestInfo</span></a><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-92"></a><span>  </span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-var">SetTestInfo</span></a><span> </span><a name="local-6989586621679072690"><a href="#local-6989586621679072690"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">`</span><a name="local-3458764513820541484"><span class="hs-identifier">mappend</span></a><span class="hs-special">`</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-var">SetTestInfo</span></a><span> </span><a name="local-6989586621679072691"><a href="#local-6989586621679072691"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-var">SetTestInfo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072690"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679072691"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-type">SetTestInfo</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-95"></a><span>  </span><a name="local-8214565720323790231"><span class="hs-identifier">show</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-var">SetTestInfo</span></a><span> </span><a name="local-6989586621679072689"><a href="#local-6989586621679072689"><span class="hs-identifier">sti</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;SetTestInfo &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#mapSnd"><span class="hs-identifier hs-var">mapSnd</span></a><span> </span><span class="hs-special">(</span><a href="Data.IntSet.EnumSet2.html#toList"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.IntMap.EnumMap2.html#assocs"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">assocs</span></a><span> </span><a href="#local-6989586621679072689"><span class="hs-identifier hs-var">sti</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">-- There may be several distinct ways for a subtree to conditionally</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- (i.e. with a Test) or unconditionally accept 0 characters.  These</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- are in the list in order of preference, with most preferred listed</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- first.</span><span>
</span><a name="line-101"></a><span class="hs-keyword">type</span><span> </span><a name="NullView"><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier">NullView</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-type">SetTestInfo</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#TagList"><span class="hs-identifier hs-type">TagList</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Ordered list of null views, each is a set of tests and tags</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-comment">-- During the depth first traversal, children are told about tags by the parent.</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- They may change Apply to Advice and they may generate new tags.</span><span>
</span><a name="line-105"></a><span class="hs-keyword">data</span><span> </span><a name="HandleTag"><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier">HandleTag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NoTag"><a href="Text.Regex.TDFA.CorePattern.html#NoTag"><span class="hs-identifier">NoTag</span></a></a><span>             </span><span class="hs-comment">-- No tag at this boundary</span><span>
</span><a name="line-106"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="Advice"><a href="Text.Regex.TDFA.CorePattern.html#Advice"><span class="hs-identifier">Advice</span></a></a><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span>        </span><span class="hs-comment">-- tag at this boundary, applied at higher level in tree</span><span>
</span><a name="line-107"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="Apply"><a href="Text.Regex.TDFA.CorePattern.html#Apply"><span class="hs-identifier">Apply</span></a></a><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span>         </span><span class="hs-comment">-- tag at this boundary, may be applied at this node or passed to one child</span><span>
</span><a name="line-108"></a><span>                 </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- Nodes in the tree are labeled by the type kind of continuation they</span><span>
</span><a name="line-111"></a><span class="hs-comment">-- prefer to be passed when processing.  This makes it possible to</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- create a smaller number of QNFA states and avoid creating wasteful</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- QNFA states that won't be reachable in the final automata.</span><span>
</span><a name="line-114"></a><span class="hs-comment">--</span><span>
</span><a name="line-115"></a><span class="hs-comment">-- In practice WantsBoth is treated identically to WantsQNFA and</span><span>
</span><a name="line-116"></a><span class="hs-comment">-- WantsBoth could be removed.</span><span>
</span><a name="line-117"></a><span class="hs-keyword">data</span><span> </span><a name="Wanted"><a href="Text.Regex.TDFA.CorePattern.html#Wanted"><span class="hs-identifier">Wanted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="WantsQNFA"><a href="Text.Regex.TDFA.CorePattern.html#WantsQNFA"><span class="hs-identifier">WantsQNFA</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="WantsQT"><a href="Text.Regex.TDFA.CorePattern.html#WantsQT"><span class="hs-identifier">WantsQT</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="WantsBoth"><a href="Text.Regex.TDFA.CorePattern.html#WantsBoth"><span class="hs-identifier">WantsBoth</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="WantsEither"><a href="Text.Regex.TDFA.CorePattern.html#WantsEither"><span class="hs-identifier">WantsEither</span></a></a><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-120"></a><span>  </span><a name="local-8214565720323790231"><span class="hs-identifier">show</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#showQ"><span class="hs-identifier hs-var">showQ</span></a><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">showQ</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-123"></a><a name="showQ"><a href="Text.Regex.TDFA.CorePattern.html#showQ"><span class="hs-identifier">showQ</span></a></a><span> </span><a name="local-6989586621679072692"><a href="#local-6989586621679072692"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Q { nullQ = &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nullQ</span><span> </span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-124"></a><span>        </span><span class="hs-string">&quot;\n  , takes = &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">takes</span><span> </span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-125"></a><span>        </span><span class="hs-string">&quot;\n  , preReset = &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">preReset</span><span> </span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-126"></a><span>        </span><span class="hs-string">&quot;\n  , postSet = &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">postSet</span><span> </span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-127"></a><span>        </span><span class="hs-string">&quot;\n  , preTag = &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">preTag</span><span> </span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-128"></a><span>        </span><span class="hs-string">&quot;\n  , postTag = &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">postTag</span><span> </span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-string">&quot;\n  , tagged = &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tagged</span><span> </span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-130"></a><span>        </span><span class="hs-string">&quot;\n  , wants = &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">wants</span><span> </span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-131"></a><span>        </span><span class="hs-string">&quot;\n  , unQ = &quot;</span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679072693"><span class="hs-identifier hs-var">indent'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">unQ</span><span> </span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; }&quot;</span><span>
</span><a name="line-132"></a><span>   </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679072693"><a href="#local-6989586621679072693"><span class="hs-identifier">indent'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unlines</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679072695"><a href="#local-6989586621679072695"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679072695"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-133"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-134"></a><span>                                      </span><span class="hs-special">(</span><a name="local-6989586621679072696"><a href="#local-6989586621679072696"><span class="hs-identifier">h</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679072697"><a href="#local-6989586621679072697"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072696"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072694"><span class="hs-identifier hs-var">spaces</span></a><span> </span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679072697"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lines</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span>
</span><a name="line-135"></a><span>         </span><a name="local-6989586621679072694"><a href="#local-6989586621679072694"><span class="hs-identifier">spaces</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">replicate</span><span> </span><span class="hs-number">10</span><span> </span><span class="hs-char">' '</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-comment">-- Smart constructors for NullView</span><span>
</span><a name="line-138"></a><span class="hs-identifier">notNull</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span>
</span><a name="line-139"></a><a name="notNull"><a href="Text.Regex.TDFA.CorePattern.html#notNull"><span class="hs-identifier">notNull</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-comment">-- Shorthand for combining a preTag and a postTag</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- preTags :: Maybe Tag -&gt; Maybe Tag -&gt; TagList</span><span>
</span><a name="line-143"></a><span class="hs-comment">-- preTags a b = promote a `mappend` promote b</span><span>
</span><a name="line-144"></a><span class="hs-comment">--   where promote = maybe [] (\x -&gt; [(x,PreUpdate TagTask)])</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-identifier">promotePreTag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.Common.html#TagList"><span class="hs-identifier hs-type">TagList</span></a><span>
</span><a name="line-147"></a><a name="promotePreTag"><a href="Text.Regex.TDFA.CorePattern.html#promotePreTag"><span class="hs-identifier">promotePreTag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679072698"><a href="#local-6989586621679072698"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679072698"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#PreUpdate"><span class="hs-identifier hs-var">PreUpdate</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#TagTask"><span class="hs-identifier hs-var">TagTask</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-identifier">makeEmptyNullView</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span>
</span><a name="line-150"></a><a name="makeEmptyNullView"><a href="Text.Regex.TDFA.CorePattern.html#makeEmptyNullView"><span class="hs-identifier">makeEmptyNullView</span></a></a><span> </span><a name="local-6989586621679072699"><a href="#local-6989586621679072699"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679072700"><a href="#local-6989586621679072700"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">mempty</span><span class="hs-special">,</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#promotePreTag"><span class="hs-identifier hs-var">promotePreTag</span></a><span> </span><a href="#local-6989586621679072699"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#promotePreTag"><span class="hs-identifier hs-var">promotePreTag</span></a><span> </span><a href="#local-6989586621679072700"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-identifier">makeTestNullView</span><span> </span><span class="hs-glyph">::</span><span>  </span><a href="Text.Regex.TDFA.CorePattern.html#TestInfo"><span class="hs-identifier hs-type">TestInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span>
</span><a name="line-153"></a><a name="makeTestNullView"><a href="Text.Regex.TDFA.CorePattern.html#makeTestNullView"><span class="hs-identifier">makeTestNullView</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679072701"><a href="#local-6989586621679072701"><span class="hs-identifier">w</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072702"><a href="#local-6989586621679072702"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679072703"><a href="#local-6989586621679072703"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679072704"><a href="#local-6989586621679072704"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-var">SetTestInfo</span></a><span> </span><span class="hs-special">(</span><a href="Data.IntMap.EnumMap2.html#singleton"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span></a><span> </span><a href="#local-6989586621679072701"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-special">(</span><a href="Data.IntSet.EnumSet2.html#singleton"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span></a><span> </span><a href="#local-6989586621679072702"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#promotePreTag"><span class="hs-identifier hs-var">promotePreTag</span></a><span> </span><a href="#local-6989586621679072703"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#promotePreTag"><span class="hs-identifier hs-var">promotePreTag</span></a><span> </span><a href="#local-6989586621679072704"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-identifier">tagWrapNullView</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span>
</span><a name="line-156"></a><a name="tagWrapNullView"><a href="Text.Regex.TDFA.CorePattern.html#tagWrapNullView"><span class="hs-identifier">tagWrapNullView</span></a></a><span> </span><a name="local-6989586621679072705"><a href="#local-6989586621679072705"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679072706"><a href="#local-6989586621679072706"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679072707"><a href="#local-6989586621679072707"><span class="hs-identifier">oldNV</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-157"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#promotePreTag"><span class="hs-identifier hs-var">promotePreTag</span></a><span> </span><a href="#local-6989586621679072705"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#promotePreTag"><span class="hs-identifier hs-var">promotePreTag</span></a><span> </span><a href="#local-6989586621679072706"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-158"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072707"><span class="hs-identifier hs-var">oldNV</span></a><span>
</span><a name="line-159"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679072708"><a href="#local-6989586621679072708"><span class="hs-identifier">pre</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072709"><a href="#local-6989586621679072709"><span class="hs-identifier">post</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-160"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679072710"><a href="#local-6989586621679072710"><span class="hs-identifier">oldTests</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072711"><a href="#local-6989586621679072711"><span class="hs-identifier">oldTasks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072707"><span class="hs-identifier hs-var">oldNV</span></a><span>
</span><a name="line-161"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072710"><span class="hs-identifier hs-var">oldTests</span></a><span class="hs-special">,</span><a href="#local-6989586621679072708"><span class="hs-identifier hs-var">pre</span></a><span class="hs-operator hs-var">++</span><a href="#local-6989586621679072711"><span class="hs-identifier hs-var">oldTasks</span></a><span class="hs-operator hs-var">++</span><a href="#local-6989586621679072709"><span class="hs-identifier hs-var">post</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-comment">-- For PGroup, need to prepend reset tasks before others in nullView</span><span>
</span><a name="line-164"></a><span class="hs-identifier">addGroupResetsToNullView</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span>
</span><a name="line-165"></a><a name="addGroupResetsToNullView"><a href="Text.Regex.TDFA.CorePattern.html#addGroupResetsToNullView"><span class="hs-identifier">addGroupResetsToNullView</span></a></a><span> </span><a name="local-6989586621679072712"><a href="#local-6989586621679072712"><span class="hs-identifier">groupResets</span></a></a><span> </span><a name="local-6989586621679072713"><a href="#local-6989586621679072713"><span class="hs-identifier">groupSet</span></a></a><span> </span><a name="local-6989586621679072714"><a href="#local-6989586621679072714"><span class="hs-identifier">nv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072720"><span class="hs-identifier hs-var">test</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679072715"><span class="hs-identifier hs-var">prepend</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072716"><span class="hs-identifier hs-var">append</span></a><span> </span><a href="#local-6989586621679072721"><span class="hs-identifier hs-var">tags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679072720"><a href="#local-6989586621679072720"><span class="hs-identifier">test</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072721"><a href="#local-6989586621679072721"><span class="hs-identifier">tags</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072714"><span class="hs-identifier hs-var">nv</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-166"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679072715"><a href="#local-6989586621679072715"><span class="hs-identifier">prepend</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679072717"><a href="#local-6989586621679072717"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679072718"><a href="#local-6989586621679072718"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072717"><span class="hs-identifier hs-var">h</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span class="hs-operator hs-var">.</span><a href="#local-6989586621679072718"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679072719"><a href="#local-6989586621679072719"><span class="hs-identifier">tag</span></a></a><span class="hs-glyph">-&gt;</span><span class="hs-special">(</span><a href="#local-6989586621679072719"><span class="hs-identifier hs-var">tag</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#PreUpdate"><span class="hs-identifier hs-var">PreUpdate</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#ResetGroupStopTask"><span class="hs-identifier hs-var">ResetGroupStopTask</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679072712"><span class="hs-identifier hs-var">groupResets</span></a><span>
</span><a name="line-167"></a><span>        </span><a name="local-6989586621679072716"><a href="#local-6989586621679072716"><span class="hs-identifier">append</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679072713"><span class="hs-identifier hs-var">groupSet</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#PreUpdate"><span class="hs-identifier hs-var">PreUpdate</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#SetGroupStopTask"><span class="hs-identifier hs-var">SetGroupStopTask</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-comment">-- For PStar, need to put in the orbit TagTasks</span><span>
</span><a name="line-170"></a><span class="hs-identifier">orbitWrapNullView</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span>
</span><a name="line-171"></a><a name="orbitWrapNullView"><a href="Text.Regex.TDFA.CorePattern.html#orbitWrapNullView"><span class="hs-identifier">orbitWrapNullView</span></a></a><span> </span><a name="local-6989586621679072722"><a href="#local-6989586621679072722"><span class="hs-identifier">mOrbit</span></a></a><span> </span><a name="local-6989586621679072723"><a href="#local-6989586621679072723"><span class="hs-identifier">orbitResets</span></a></a><span> </span><a name="local-6989586621679072724"><a href="#local-6989586621679072724"><span class="hs-identifier">oldNV</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072722"><span class="hs-identifier hs-var">mOrbit</span></a><span class="hs-special">,</span><a href="#local-6989586621679072723"><span class="hs-identifier hs-var">orbitResets</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-173"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072724"><span class="hs-identifier hs-var">oldNV</span></a><span>
</span><a name="line-174"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679072729"><a href="#local-6989586621679072729"><span class="hs-identifier">oldTests</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072730"><a href="#local-6989586621679072730"><span class="hs-identifier">oldTasks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072724"><span class="hs-identifier hs-var">oldNV</span></a><span>
</span><a name="line-175"></a><span>                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072729"><span class="hs-identifier hs-var">oldTests</span></a><span class="hs-special">,</span><a href="#local-6989586621679072725"><span class="hs-identifier hs-var">prepend</span></a><span> </span><a href="#local-6989586621679072730"><span class="hs-identifier hs-var">oldTasks</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679072731"><a href="#local-6989586621679072731"><span class="hs-identifier">o</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679072732"><a href="#local-6989586621679072732"><span class="hs-identifier">oldTests</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072733"><a href="#local-6989586621679072733"><span class="hs-identifier">oldTasks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072724"><span class="hs-identifier hs-var">oldNV</span></a><span>
</span><a name="line-177"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072732"><span class="hs-identifier hs-var">oldTests</span></a><span class="hs-special">,</span><a href="#local-6989586621679072725"><span class="hs-identifier hs-var">prepend</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679072731"><span class="hs-identifier hs-var">o</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#PreUpdate"><span class="hs-identifier hs-var">PreUpdate</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#EnterOrbitTask"><span class="hs-identifier hs-var">EnterOrbitTask</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679072733"><span class="hs-identifier hs-var">oldTasks</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679072731"><span class="hs-identifier hs-var">o</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#PreUpdate"><span class="hs-identifier hs-var">PreUpdate</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#LeaveOrbitTask"><span class="hs-identifier hs-var">LeaveOrbitTask</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679072725"><a href="#local-6989586621679072725"><span class="hs-identifier">prepend</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679072726"><a href="#local-6989586621679072726"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679072727"><a href="#local-6989586621679072727"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072726"><span class="hs-identifier hs-var">h</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span class="hs-operator hs-var">.</span><a href="#local-6989586621679072727"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679072728"><a href="#local-6989586621679072728"><span class="hs-identifier">tag</span></a></a><span class="hs-glyph">-&gt;</span><span class="hs-special">(</span><a href="#local-6989586621679072728"><span class="hs-identifier hs-var">tag</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#PreUpdate"><span class="hs-identifier hs-var">PreUpdate</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#ResetOrbitTask"><span class="hs-identifier hs-var">ResetOrbitTask</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679072723"><span class="hs-identifier hs-var">orbitResets</span></a><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-comment">-- The NullViews are ordered, and later test sets that contain the</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- tests from any earlier entry will never be chosen.  This function</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- returns a list with these redundant elements removed.  Note that</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- the first unconditional entry in the list will be the last entry of</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- the returned list since the empty set is a subset of any other set.</span><span>
</span><a name="line-185"></a><span class="hs-identifier">cleanNullView</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span>
</span><a name="line-186"></a><a name="cleanNullView"><a href="Text.Regex.TDFA.CorePattern.html#cleanNullView"><span class="hs-identifier">cleanNullView</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-187"></a><span class="hs-identifier">cleanNullView</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679072734"><a href="#local-6989586621679072734"><span class="hs-identifier">first</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#SetTestInfo"><span class="hs-identifier hs-var">SetTestInfo</span></a><span> </span><a name="local-6989586621679072735"><a href="#local-6989586621679072735"><span class="hs-identifier">sti</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679072736"><a href="#local-6989586621679072736"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Data.IntMap.EnumMap2.html#null"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621679072735"><span class="hs-identifier hs-var">sti</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072734"><span class="hs-identifier hs-var">first</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- optimization</span><span>
</span><a name="line-188"></a><span>                                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-189"></a><span>  </span><a href="#local-6989586621679072734"><span class="hs-identifier hs-var">first</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#cleanNullView"><span class="hs-identifier hs-var">cleanNullView</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072737"><span class="hs-identifier hs-var">setTI</span></a><span> </span><span class="hs-special">`</span><a href="Data.IntSet.EnumSet2.html#isSubsetOf"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">isSubsetOf</span></a><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.IntMap.EnumMap2.html#keysSet"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keysSet</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getTests</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679072736"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679072737"><a href="#local-6989586621679072737"><span class="hs-identifier">setTI</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.IntMap.EnumMap2.html#keysSet"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keysSet</span></a><span> </span><a href="#local-6989586621679072735"><span class="hs-identifier hs-var">sti</span></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">-- Ordered Sequence of two NullViews: all ordered combinations of tests and tags.</span><span>
</span><a name="line-193"></a><span class="hs-comment">-- Order of &lt;- s1 and &lt;- s2 is deliberately chosen to maintain preference priority</span><span>
</span><a name="line-194"></a><span class="hs-identifier">mergeNullViews</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NullView"><span class="hs-identifier hs-type">NullView</span></a><span>
</span><a name="line-195"></a><a name="mergeNullViews"><a href="Text.Regex.TDFA.CorePattern.html#mergeNullViews"><span class="hs-identifier">mergeNullViews</span></a></a><span> </span><a name="local-6989586621679072738"><a href="#local-6989586621679072738"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621679072739"><a href="#local-6989586621679072739"><span class="hs-identifier">s2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#cleanNullView"><span class="hs-identifier hs-var">cleanNullView</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-196"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679072740"><a href="#local-6989586621679072740"><span class="hs-identifier">test1</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072741"><a href="#local-6989586621679072741"><span class="hs-identifier">tag1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072738"><span class="hs-identifier hs-var">s1</span></a><span>
</span><a name="line-197"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679072742"><a href="#local-6989586621679072742"><span class="hs-identifier">test2</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072743"><a href="#local-6989586621679072743"><span class="hs-identifier">tag2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072739"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-198"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mappend</span><span> </span><a href="#local-6989586621679072740"><span class="hs-identifier hs-var">test1</span></a><span> </span><a href="#local-6989586621679072742"><span class="hs-identifier hs-var">test2</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">mappend</span><span> </span><a href="#local-6989586621679072741"><span class="hs-identifier hs-var">tag1</span></a><span> </span><a href="#local-6989586621679072743"><span class="hs-identifier hs-var">tag2</span></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span class="hs-comment">-- mergeNullViews = cleanNullView $ liftM2 (mappend *** mappend)</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-comment">-- Concatenated two ranges of number of accepted characters</span><span>
</span><a name="line-202"></a><span class="hs-identifier">seqTake</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><a name="seqTake"><a href="Text.Regex.TDFA.CorePattern.html#seqTake"><span class="hs-identifier">seqTake</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679072744"><a href="#local-6989586621679072744"><span class="hs-identifier">x1</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072745"><a href="#local-6989586621679072745"><span class="hs-identifier">y1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679072746"><a href="#local-6989586621679072746"><span class="hs-identifier">x2</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072747"><a href="#local-6989586621679072747"><span class="hs-identifier">y2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072744"><span class="hs-identifier hs-var">x1</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621679072746"><span class="hs-identifier hs-var">x2</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">liftM2</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679072745"><span class="hs-identifier hs-var">y1</span></a><span> </span><a href="#local-6989586621679072747"><span class="hs-identifier hs-var">y2</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-comment">-- Parallel combination of list of ranges of number of accepted characters</span><span>
</span><a name="line-206"></a><span class="hs-identifier">orTakes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-207"></a><a name="orTakes"><a href="Text.Regex.TDFA.CorePattern.html#orTakes"><span class="hs-identifier">orTakes</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span class="hs-identifier">orTakes</span><span> </span><a name="local-6989586621679072748"><a href="#local-6989586621679072748"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679072749"><a href="#local-6989586621679072749"><span class="hs-identifier">xs</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072750"><a href="#local-6989586621679072750"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621679072748"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-209"></a><span>             </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">minimum</span><span> </span><a href="#local-6989586621679072749"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldl1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftM2</span><span> </span><span class="hs-identifier hs-var">max</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679072750"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-comment">-- Invariant: apply (toAdvice _ ) == mempty</span><span>
</span><a name="line-212"></a><span class="hs-identifier">apply</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span>
</span><a name="line-213"></a><a name="apply"><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier">apply</span></a></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><a name="local-6989586621679072751"><a href="#local-6989586621679072751"><span class="hs-identifier">tag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679072751"><span class="hs-identifier hs-var">tag</span></a><span>
</span><a name="line-214"></a><span class="hs-identifier">apply</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-215"></a><span class="hs-identifier">toAdvice</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span>
</span><a name="line-216"></a><a name="toAdvice"><a href="Text.Regex.TDFA.CorePattern.html#toAdvice"><span class="hs-identifier">toAdvice</span></a></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><a name="local-6989586621679072752"><a href="#local-6989586621679072752"><span class="hs-identifier">tag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Advice"><span class="hs-identifier hs-var">Advice</span></a><span> </span><a href="#local-6989586621679072752"><span class="hs-identifier hs-var">tag</span></a><span>
</span><a name="line-217"></a><span class="hs-identifier">toAdvice</span><span> </span><a name="local-6989586621679072753"><a href="#local-6989586621679072753"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072753"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-218"></a><span class="hs-identifier">noTag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-219"></a><a name="noTag"><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier">noTag</span></a></a><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NoTag"><span class="hs-identifier hs-var">NoTag</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-220"></a><span class="hs-identifier">noTag</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-221"></a><span class="hs-identifier">fromHandleTag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span>
</span><a name="line-222"></a><a name="fromHandleTag"><a href="Text.Regex.TDFA.CorePattern.html#fromHandleTag"><span class="hs-identifier">fromHandleTag</span></a></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><a name="local-6989586621679072754"><a href="#local-6989586621679072754"><span class="hs-identifier">tag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072754"><span class="hs-identifier hs-var">tag</span></a><span>
</span><a name="line-223"></a><span class="hs-identifier">fromHandleTag</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#Advice"><span class="hs-identifier hs-var">Advice</span></a><span> </span><a name="local-6989586621679072755"><a href="#local-6989586621679072755"><span class="hs-identifier">tag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072755"><span class="hs-identifier hs-var">tag</span></a><span>
</span><a name="line-224"></a><span class="hs-identifier">fromHandleTag</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;fromHandleTag&quot;</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-comment">-- Predicates on the range of number of accepted  characters</span><span>
</span><a name="line-227"></a><span class="hs-identifier">varies</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-228"></a><a name="varies"><a href="Text.Regex.TDFA.CorePattern.html#varies"><span class="hs-identifier">varies</span></a></a><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">takes</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-229"></a><span class="hs-identifier">varies</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">takes</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679072756"><a href="#local-6989586621679072756"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679072757"><a href="#local-6989586621679072757"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072756"><span class="hs-identifier hs-var">x</span></a><span class="hs-operator hs-var">/=</span><a href="#local-6989586621679072757"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-identifier">mustAccept</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-232"></a><a name="mustAccept"><a href="Text.Regex.TDFA.CorePattern.html#mustAccept"><span class="hs-identifier">mustAccept</span></a></a><span> </span><a name="local-6989586621679072758"><a href="#local-6989586621679072758"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-operator hs-var">/=</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">takes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679072758"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-identifier">canAccept</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-235"></a><a name="canAccept"><a href="Text.Regex.TDFA.CorePattern.html#canAccept"><span class="hs-identifier">canAccept</span></a></a><span> </span><a name="local-6989586621679072759"><a href="#local-6989586621679072759"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-operator hs-var">/=</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">takes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679072759"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-identifier">cannotAccept</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-238"></a><a name="cannotAccept"><a href="Text.Regex.TDFA.CorePattern.html#cannotAccept"><span class="hs-identifier">cannotAccept</span></a></a><span> </span><a name="local-6989586621679072760"><a href="#local-6989586621679072760"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">takes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679072760"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-comment">-- This converts then input Pattern to an analyzed Q structure with</span><span>
</span><a name="line-241"></a><span class="hs-comment">-- the tags assigned.</span><span>
</span><a name="line-242"></a><span class="hs-comment">--</span><span>
</span><a name="line-243"></a><span class="hs-comment">-- The analysis is filled in by a depth first search and the tags are</span><span>
</span><a name="line-244"></a><span class="hs-comment">-- created top down and passed to children.  Thus information flows up</span><span>
</span><a name="line-245"></a><span class="hs-comment">-- from the dfs of the children and simultaneously down in the form of</span><span>
</span><a name="line-246"></a><span class="hs-comment">-- pre and post HandleTag data.  This bidirectional flow is handled</span><span>
</span><a name="line-247"></a><span class="hs-comment">-- declaratively by using the MonadFix (i.e. mdo).</span><span>
</span><a name="line-248"></a><span class="hs-comment">-- </span><span>
</span><a name="line-249"></a><span class="hs-comment">-- Invariant: A tag should exist in Q in exactly one place (and will</span><span>
</span><a name="line-250"></a><span class="hs-comment">-- be in a preTag,postTag, or getOrbit field).  This is partly because</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- PGroup needs to know the tags are around precisely the expression</span><span>
</span><a name="line-252"></a><span class="hs-comment">-- that it wants to record.  If the same tag were in other branches</span><span>
</span><a name="line-253"></a><span class="hs-comment">-- then this would no longer be true.  The tag may or may not also</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- show up in one or more preReset list or resetOrbits list.</span><span>
</span><a name="line-255"></a><span class="hs-comment">--</span><span>
</span><a name="line-256"></a><span class="hs-comment">-- This invariant is enforced by each node either taking</span><span>
</span><a name="line-257"></a><span class="hs-comment">-- responsibility (apply) for a passed in / created tag or sending it</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- to exactly one child node.  Other child nodes need to receive it</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- via toAdvice.  Leaf nodes are forced to apply any passed tags.</span><span>
</span><a name="line-260"></a><span class="hs-comment">--</span><span>
</span><a name="line-261"></a><span class="hs-comment">-- There is a final &quot;qwin of Q {postTag=ISet.singleton 1}&quot; and an</span><span>
</span><a name="line-262"></a><span class="hs-comment">-- implied initial index tag of 0.</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- </span><span>
</span><a name="line-264"></a><span class="hs-comment">-- favoring pushing Apply into the child postTag makes PGroup happier</span><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span class="hs-keyword">type</span><span> </span><a name="PM"><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier">PM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">RWS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Text.Regex.TDFA.Common.html#GroupIndex"><span class="hs-identifier hs-type">GroupIndex</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#OP"><span class="hs-identifier hs-type">OP</span></a><span class="hs-special">]</span><span class="hs-glyph">-&gt;</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#OP"><span class="hs-identifier hs-type">OP</span></a><span class="hs-special">]</span><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-267"></a><span class="hs-keyword">type</span><span> </span><a name="HHQ"><a href="Text.Regex.TDFA.CorePattern.html#HHQ"><span class="hs-identifier">HHQ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span>  </span><span class="hs-comment">-- m1 : info about left boundaary / preTag</span><span>
</span><a name="line-268"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span>  </span><span class="hs-comment">-- m2 : info about right boundary / postTag</span><span>
</span><a name="line-269"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span class="hs-comment">-- There is no group 0 here, since it is always the whole match and has no parent of its own</span><span>
</span><a name="line-272"></a><span class="hs-identifier">makeGroupArray</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.Common.html#GroupIndex"><span class="hs-identifier hs-type">GroupIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Array</span><span> </span><a href="Text.Regex.TDFA.Common.html#GroupIndex"><span class="hs-identifier hs-type">GroupIndex</span></a><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-273"></a><a name="makeGroupArray"><a href="Text.Regex.TDFA.CorePattern.html#makeGroupArray"><span class="hs-identifier">makeGroupArray</span></a></a><span> </span><a name="local-6989586621679072761"><a href="#local-6989586621679072761"><span class="hs-identifier">maxGroupIndex</span></a></a><span> </span><a name="local-6989586621679072762"><a href="#local-6989586621679072762"><span class="hs-identifier">groups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">accumArray</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679072765"><a href="#local-6989586621679072765"><span class="hs-identifier">earlier</span></a></a><span> </span><a name="local-6989586621679072766"><a href="#local-6989586621679072766"><span class="hs-identifier">later</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072766"><span class="hs-identifier hs-var">later</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679072765"><span class="hs-identifier hs-var">earlier</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-special">,</span><a href="#local-6989586621679072761"><span class="hs-identifier hs-var">maxGroupIndex</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679072763"><span class="hs-identifier hs-var">filler</span></a><span>
</span><a name="line-274"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679072763"><a href="#local-6989586621679072763"><span class="hs-identifier">filler</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679072764"><a href="#local-6989586621679072764"><span class="hs-identifier">gi</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">thisIndex</span><span> </span><a href="#local-6989586621679072764"><span class="hs-identifier hs-var">gi</span></a><span class="hs-special">,</span><a href="#local-6989586621679072764"><span class="hs-identifier hs-var">gi</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679072762"><span class="hs-identifier hs-var">groups</span></a><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-identifier">fromRight</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-277"></a><a name="fromRight"><a href="Text.Regex.TDFA.CorePattern.html#fromRight"><span class="hs-identifier">fromRight</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-278"></a><span class="hs-identifier">fromRight</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679072767"><a href="#local-6989586621679072767"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679072768"><a href="#local-6989586621679072768"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072767"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="Text.Regex.TDFA.CorePattern.html#fromRight"><span class="hs-identifier hs-var">fromRight</span></a><span> </span><a href="#local-6989586621679072768"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-279"></a><span class="hs-identifier">fromRight</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679072769"><a href="#local-6989586621679072769"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#fromRight"><span class="hs-identifier hs-var">fromRight</span></a><span> </span><a href="#local-6989586621679072769"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-identifier">partitionEither</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-282"></a><a name="partitionEither"><a href="Text.Regex.TDFA.CorePattern.html#partitionEither"><span class="hs-identifier">partitionEither</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072770"><span class="hs-identifier hs-var">helper</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-283"></a><span>  </span><span class="hs-identifier">helper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span class="hs-glyph">-&gt;</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span class="hs-glyph">-&gt;</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>  </span><a name="local-6989586621679072770"><a href="#local-6989586621679072770"><span class="hs-identifier">helper</span></a></a><span> </span><a name="local-6989586621679072771"><a href="#local-6989586621679072771"><span class="hs-identifier">ls</span></a></a><span> </span><a name="local-6989586621679072772"><a href="#local-6989586621679072772"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072771"><span class="hs-identifier hs-var">ls</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><a href="#local-6989586621679072772"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>  </span><span class="hs-identifier">helper</span><span> </span><a name="local-6989586621679072773"><a href="#local-6989586621679072773"><span class="hs-identifier">ls</span></a></a><span> </span><a name="local-6989586621679072774"><a href="#local-6989586621679072774"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679072775"><a href="#local-6989586621679072775"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679072776"><a href="#local-6989586621679072776"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072770"><span class="hs-identifier hs-var">helper</span></a><span>  </span><a href="#local-6989586621679072773"><span class="hs-identifier hs-var">ls</span></a><span>      </span><span class="hs-special">(</span><a href="#local-6989586621679072774"><span class="hs-identifier hs-var">rs</span></a><span class="hs-operator hs-var">.</span><span class="hs-special">(</span><a href="#local-6989586621679072775"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679072776"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-286"></a><span>  </span><span class="hs-identifier">helper</span><span> </span><a name="local-6989586621679072777"><a href="#local-6989586621679072777"><span class="hs-identifier">ls</span></a></a><span> </span><a name="local-6989586621679072778"><a href="#local-6989586621679072778"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679072779"><a href="#local-6989586621679072779"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679072780"><a href="#local-6989586621679072780"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072770"><span class="hs-identifier hs-var">helper</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072777"><span class="hs-identifier hs-var">ls</span></a><span class="hs-operator hs-var">.</span><span class="hs-special">(</span><a href="#local-6989586621679072779"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679072778"><span class="hs-identifier hs-var">rs</span></a><span>       </span><a href="#local-6989586621679072780"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span class="hs-comment">-- Partial function: assumes starTrans has been run on the Pattern</span><span>
</span><a name="line-289"></a><span class="hs-comment">-- Note that the lazy dependency chain for this very zigzag:</span><span>
</span><a name="line-290"></a><span class="hs-comment">--   varies information is sent up the tree</span><span>
</span><a name="line-291"></a><span class="hs-comment">--   handle tags depend on that and sends m1 m2 down the tree</span><span>
</span><a name="line-292"></a><span class="hs-comment">--     makeGroup sends some tags to the writer (Right _)</span><span>
</span><a name="line-293"></a><span class="hs-comment">--     withParent listens to children send group info to writer</span><span>
</span><a name="line-294"></a><span class="hs-comment">--       and lazily looks resetGroupTags from aGroups, the result of all writer (Right _)</span><span>
</span><a name="line-295"></a><span class="hs-comment">--       preReset stores the resetGroupTags result of the lookup in the tree</span><span>
</span><a name="line-296"></a><span class="hs-comment">--     makeOrbit sends some tags to the writer (Left _)</span><span>
</span><a name="line-297"></a><span class="hs-comment">--     withOrbit listens to children send orbit info to writer for resetOrbitTags </span><span>
</span><a name="line-298"></a><span class="hs-comment">--   nullQ depends m1 m2 and resetOrbitTags and resetGroupTags and is sent up the tree</span><span>
</span><a name="line-299"></a><span class="hs-identifier">patternToQ</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.Common.html#CompOption"><span class="hs-identifier hs-type">CompOption</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Pattern.html#Pattern"><span class="hs-identifier hs-type">Pattern</span></a><span class="hs-special">,</span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#GroupIndex"><span class="hs-identifier hs-type">GroupIndex</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#DoPa"><span class="hs-identifier hs-type">DoPa</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-type">Q</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">Array</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#OP"><span class="hs-identifier hs-type">OP</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">Array</span><span> </span><a href="Text.Regex.TDFA.Common.html#GroupIndex"><span class="hs-identifier hs-type">GroupIndex</span></a><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-300"></a><a name="patternToQ"><a href="Text.Regex.TDFA.CorePattern.html#patternToQ"><span class="hs-identifier">patternToQ</span></a></a><span> </span><a name="local-6989586621679072781"><a href="#local-6989586621679072781"><span class="hs-identifier">compOpt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679072782"><a href="#local-6989586621679072782"><span class="hs-identifier">pOrig</span></a></a><span class="hs-special">,</span><span class="hs-special">(</span><a name="local-6989586621679072783"><a href="#local-6989586621679072783"><span class="hs-identifier">maxGroupIndex</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072784"><span class="hs-identifier hs-var">tnfa</span></a><span class="hs-special">,</span><a href="#local-6989586621679072788"><span class="hs-identifier hs-var">aTags</span></a><span class="hs-special">,</span><a href="#local-6989586621679072789"><span class="hs-identifier hs-var">aGroups</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679072784"><a href="#local-6989586621679072784"><span class="hs-identifier">tnfa</span></a></a><span class="hs-special">,</span><span class="hs-special">(</span><a name="local-6989586621679072785"><a href="#local-6989586621679072785"><span class="hs-identifier">tag_dlist</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072786"><a href="#local-6989586621679072786"><span class="hs-identifier">nextTag</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><a name="local-6989586621679072787"><a href="#local-6989586621679072787"><span class="hs-identifier">groups</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runRWS</span><span> </span><a href="#local-6989586621679072790"><span class="hs-identifier hs-var">monad</span></a><span> </span><a href="#local-6989586621679072791"><span class="hs-identifier hs-var">startReader</span></a><span> </span><a href="#local-6989586621679072792"><span class="hs-identifier hs-var">startState</span></a><span>
</span><a name="line-302"></a><span>  </span><a name="local-6989586621679072788"><a href="#local-6989586621679072788"><span class="hs-identifier">aTags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listArray</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-identifier hs-var">pred</span><span> </span><a href="#local-6989586621679072786"><span class="hs-identifier hs-var">nextTag</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072785"><span class="hs-identifier hs-var">tag_dlist</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>  </span><a name="local-6989586621679072789"><a href="#local-6989586621679072789"><span class="hs-identifier">aGroups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#makeGroupArray"><span class="hs-identifier hs-var">makeGroupArray</span></a><span> </span><a href="#local-6989586621679072783"><span class="hs-identifier hs-var">maxGroupIndex</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#fromRight"><span class="hs-identifier hs-var">fromRight</span></a><span> </span><a href="#local-6989586621679072787"><span class="hs-identifier hs-var">groups</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span>  </span><span class="hs-comment">-- implicitly inside a PGroup 0 converted into a GroupInfo 0 undefined 0 1</span><span>
</span><a name="line-306"></a><span>  </span><a name="local-6989586621679072790"><a href="#local-6989586621679072790"><span class="hs-identifier">monad</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072803"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Pattern.html#starTrans"><span class="hs-identifier hs-var">starTrans</span></a><span> </span><a href="#local-6989586621679072782"><span class="hs-identifier hs-var">pOrig</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#Advice"><span class="hs-identifier hs-var">Advice</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#Advice"><span class="hs-identifier hs-var">Advice</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>  </span><span class="hs-comment">-- startReader is accessed by getParentIndex and changed by nonCapture and withParent</span><span>
</span><a name="line-308"></a><span>  </span><span class="hs-identifier">startReader</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Text.Regex.TDFA.Common.html#GroupIndex"><span class="hs-identifier hs-type">GroupIndex</span></a><span>
</span><a name="line-309"></a><span>  </span><a name="local-6989586621679072791"><a href="#local-6989586621679072791"><span class="hs-identifier">startReader</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span>                           </span><span class="hs-comment">-- start inside group 0, capturing enabled</span><span>
</span><a name="line-310"></a><span>  </span><span class="hs-comment">-- The startState is only acted upon in the &quot;uniq&quot; command</span><span>
</span><a name="line-311"></a><span>  </span><span class="hs-comment">-- Tag 0 is Minimized and Tag 1 is maximized, next tag has value of 2</span><span>
</span><a name="line-312"></a><span>  </span><span class="hs-comment">-- This is regardless of right or left associativity</span><span>
</span><a name="line-313"></a><span>  </span><span class="hs-identifier">startState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#OP"><span class="hs-identifier hs-type">OP</span></a><span class="hs-special">]</span><span class="hs-glyph">-&gt;</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#OP"><span class="hs-identifier hs-type">OP</span></a><span class="hs-special">]</span><span class="hs-special">,</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>  </span><a name="local-6989586621679072792"><a href="#local-6989586621679072792"><span class="hs-identifier">startState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Minimize"><span class="hs-identifier hs-var">Minimize</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Maximize"><span class="hs-identifier hs-var">Maximize</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span>  </span><span class="hs-comment">-- uniq uses MonadState and always returns an &quot;Apply _&quot; tag</span><span>
</span><a name="line-317"></a><span>  </span><span class="hs-pragma">{-# INLINE uniq #-}</span><span>
</span><a name="line-318"></a><span>  </span><span class="hs-identifier">uniq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HandleTag"><span class="hs-identifier hs-type">HandleTag</span></a><span>
</span><a name="line-319"></a><span>  </span><a name="local-6989586621679072793"><a href="#local-6989586621679072793"><span class="hs-identifier">uniq</span></a></a><span> </span><a name="local-6989586621679072807"><a href="#local-6989586621679072807"><span class="hs-identifier">_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072795"><span class="hs-identifier hs-var">uniq'</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#Maximize"><span class="hs-identifier hs-var">Maximize</span></a><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span class="hs-comment">--  uniq _msg = do x &lt;- fmap Apply (uniq' Maximize)</span><span>
</span><a name="line-321"></a><span class="hs-comment">--                trace ('\n':msg ++ &quot; Maximize &quot;++show x) $ return x</span><span>
</span><a name="line-322"></a><span class="hs-comment">--                return x</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span>  </span><span class="hs-identifier">ignore</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span>
</span><a name="line-325"></a><span>  </span><a name="local-6989586621679072794"><a href="#local-6989586621679072794"><span class="hs-identifier">ignore</span></a></a><span> </span><a name="local-6989586621679072808"><a href="#local-6989586621679072808"><span class="hs-identifier">_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072795"><span class="hs-identifier hs-var">uniq'</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#Ignore"><span class="hs-identifier hs-var">Ignore</span></a><span>
</span><a name="line-326"></a><span class="hs-comment">--  ignore _msg = do x &lt;- uniq' Ignore</span><span>
</span><a name="line-327"></a><span class="hs-comment">--                  trace ('\n':msg ++ &quot; Ignore &quot;++show x) $ return x</span><span>
</span><a name="line-328"></a><span class="hs-comment">--                  return x</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>  </span><span class="hs-pragma">{-# NOINLINE uniq' #-}</span><span>
</span><a name="line-331"></a><span>  </span><span class="hs-identifier">uniq'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.Common.html#OP"><span class="hs-identifier hs-type">OP</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span>
</span><a name="line-332"></a><span>  </span><a name="local-6989586621679072795"><a href="#local-6989586621679072795"><span class="hs-identifier">uniq'</span></a></a><span> </span><a name="local-6989586621679072809"><a href="#local-6989586621679072809"><span class="hs-identifier">newOp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-333"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679072941"><a href="#local-6989586621679072941"><span class="hs-identifier">op</span></a></a><span class="hs-special">,</span><a name="local-6989586621679072942"><a href="#local-6989586621679072942"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>                </span><span class="hs-comment">-- generate the next tag with bias newOp</span><span>
</span><a name="line-334"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679072943"><a href="#local-6989586621679072943"><span class="hs-identifier">op'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679072941"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072809"><span class="hs-identifier hs-var">newOp</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>        </span><a name="local-6989586621679072944"><a href="#local-6989586621679072944"><span class="hs-identifier">s'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">succ</span><span> </span><a href="#local-6989586621679072942"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-336"></a><span>    </span><span class="hs-identifier hs-var">put</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072943"><span class="hs-identifier hs-var">op'</span></a><span class="hs-special">,</span><a href="#local-6989586621679072944"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679072942"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-338"></a><span>
</span><a name="line-339"></a><span>  </span><span class="hs-pragma">{-# INLINE makeOrbit #-}</span><span>
</span><a name="line-340"></a><span>  </span><span class="hs-comment">-- Specialize the monad operations and give more meaningful names</span><span>
</span><a name="line-341"></a><span>  </span><span class="hs-comment">-- makeOrbit uses MonadState(uniq) and MonadWriter(tell/Left)</span><span>
</span><a name="line-342"></a><span>  </span><span class="hs-identifier">makeOrbit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>  </span><a name="local-6989586621679072796"><a href="#local-6989586621679072796"><span class="hs-identifier">makeOrbit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679072945"><a href="#local-6989586621679072945"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072795"><span class="hs-identifier hs-var">uniq'</span></a><span> </span><a href="Text.Regex.TDFA.Common.html#Orbit"><span class="hs-identifier hs-var">Orbit</span></a><span>
</span><a name="line-344"></a><span class="hs-comment">--                 trace ('\n':&quot;PStar Orbit &quot;++show x) $ do</span><span>
</span><a name="line-345"></a><span>                 </span><span class="hs-identifier hs-var">tell</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679072945"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span>
</span><a name="line-346"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679072945"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span>  </span><span class="hs-pragma">{-# INLINE withOrbit #-}</span><span>
</span><a name="line-349"></a><span>  </span><span class="hs-comment">-- withOrbit uses MonadWriter(listens to makeOrbit/Left), collects</span><span>
</span><a name="line-350"></a><span>  </span><span class="hs-comment">-- children at all depths</span><span>
</span><a name="line-351"></a><span>  </span><span class="hs-identifier">withOrbit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><a href="#local-6989586621679072804"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072804"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>  </span><a name="local-6989586621679072797"><a href="#local-6989586621679072797"><span class="hs-identifier">withOrbit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listens</span><span> </span><a href="#local-6989586621679073067"><span class="hs-identifier hs-var">childStars</span></a><span>
</span><a name="line-353"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679073067"><a href="#local-6989586621679073067"><span class="hs-identifier">childStars</span></a></a><span> </span><a name="local-6989586621679073068"><a href="#local-6989586621679073068"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679073069"><a href="#local-6989586621679073069"><span class="hs-identifier">ts</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#partitionEither"><span class="hs-identifier hs-var">partitionEither</span></a><span> </span><a href="#local-6989586621679073068"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679073069"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>  </span><span class="hs-pragma">{-# INLINE makeGroup #-}</span><span>
</span><a name="line-356"></a><span>  </span><span class="hs-comment">-- makeGroup usesMonadWriter(tell/Right)</span><span>
</span><a name="line-357"></a><span>  </span><span class="hs-identifier">makeGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-type">GroupInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span>  </span><a name="local-6989586621679072798"><a href="#local-6989586621679072798"><span class="hs-identifier">makeGroup</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tell</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Right</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>  </span><span class="hs-pragma">{-# INLINE getParentIndex #-}</span><span>
</span><a name="line-361"></a><span>  </span><span class="hs-comment">-- getParentIndex uses MonadReader(ask)</span><span>
</span><a name="line-362"></a><span>  </span><span class="hs-identifier">getParentIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Text.Regex.TDFA.Common.html#GroupIndex"><span class="hs-identifier hs-type">GroupIndex</span></a><span class="hs-special">)</span><span>
</span><a name="line-363"></a><span>  </span><a name="local-6989586621679072799"><a href="#local-6989586621679072799"><span class="hs-identifier">getParentIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span>  </span><span class="hs-pragma">{-# INLINE nonCapture #-}</span><span>
</span><a name="line-366"></a><span>  </span><span class="hs-comment">-- nonCapture uses MonadReader(local) to suppress getParentIndex to return Nothing</span><span>
</span><a name="line-367"></a><span>  </span><span class="hs-identifier">nonCapture</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span>  </span><a href="#local-6989586621679072805"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><a href="#local-6989586621679072805"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-368"></a><span>  </span><a name="local-6989586621679072800"><a href="#local-6989586621679072800"><span class="hs-identifier">nonCapture</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span>  </span><span class="hs-comment">-- withParent uses MonadReader(local) to set getParentIndex to return (Just this)</span><span>
</span><a name="line-371"></a><span>  </span><span class="hs-comment">-- withParent uses MonadWriter(listens to makeGroup/Right) to return contained group indices (stopTag)</span><span>
</span><a name="line-372"></a><span>  </span><span class="hs-comment">-- withParent is only safe if getParentIndex has been checked to be not equal to Nothing (see PGroup below)</span><span>
</span><a name="line-373"></a><span>  </span><span class="hs-comment">-- Note use of laziness: the immediate children's group index is used to look up all copies of the </span><span>
</span><a name="line-374"></a><span>  </span><span class="hs-comment">-- group in aGroups, including copies that are not immediate children.</span><span>
</span><a name="line-375"></a><span>  </span><span class="hs-identifier">withParent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.Common.html#GroupIndex"><span class="hs-identifier hs-type">GroupIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><a href="#local-6989586621679072806"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#PM"><span class="hs-identifier hs-type">PM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072806"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#Tag"><span class="hs-identifier hs-type">Tag</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>  </span><a name="local-6989586621679072801"><a href="#local-6989586621679072801"><span class="hs-identifier">withParent</span></a></a><span> </span><a name="local-6989586621679073203"><a href="#local-6989586621679073203"><span class="hs-identifier">this</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679073203"><span class="hs-identifier hs-var">this</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">listens</span><span> </span><a href="#local-6989586621679073204"><span class="hs-identifier hs-var">childGroupInfo</span></a><span>
</span><a name="line-377"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679073204"><a href="#local-6989586621679073204"><span class="hs-identifier">childGroupInfo</span></a></a><span> </span><a name="local-6989586621679073205"><a href="#local-6989586621679073205"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-378"></a><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679073206"><a href="#local-6989586621679073206"><span class="hs-identifier">gs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#partitionEither"><span class="hs-identifier hs-var">partitionEither</span></a><span> </span><a href="#local-6989586621679073205"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-379"></a><span>                </span><span class="hs-identifier">children</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Common.html#GroupIndex"><span class="hs-identifier hs-type">GroupIndex</span></a><span class="hs-special">]</span><span>
</span><a name="line-380"></a><span>                </span><a name="local-6989586621679073207"><a href="#local-6989586621679073207"><span class="hs-identifier">children</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.Common.html#norep"><span class="hs-identifier hs-var">norep</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">sort</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">thisIndex</span><span>
</span><a name="line-381"></a><span>                           </span><span class="hs-comment">-- filter to get only immediate children (efficiency)</span><span>
</span><a name="line-382"></a><span>                           </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679073203"><span class="hs-identifier hs-var">this</span></a><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span class="hs-operator hs-var">.</span><span class="hs-identifier">parentIndex</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073206"><span class="hs-identifier hs-var">gs</span></a><span>
</span><a name="line-383"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flagTag</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072789"><span class="hs-identifier hs-var">aGroups</span></a><span class="hs-glyph">!</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073203"><span class="hs-identifier hs-var">this</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679073207"><span class="hs-identifier hs-var">children</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span>  </span><span class="hs-comment">-- combineConcat is a partial function: Must not pass in an empty list</span><span>
</span><a name="line-386"></a><span>  </span><span class="hs-comment">-- Policy choices:</span><span>
</span><a name="line-387"></a><span>  </span><span class="hs-comment">--  * pass tags to apply to children and have no preTag or postTag here (so none addded to nullQ)</span><span>
</span><a name="line-388"></a><span>  </span><span class="hs-comment">--  * middle 'mid' tag: give to left/front child as postTag so a Group there might claim it as a stopTag</span><span>
</span><a name="line-389"></a><span>  </span><span class="hs-comment">--  * if parent is Group then preReset will become non-empty</span><span>
</span><a name="line-390"></a><span>  </span><span class="hs-identifier">combineConcat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Text.Regex.TDFA.Pattern.html#Pattern"><span class="hs-identifier hs-type">Pattern</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HHQ"><span class="hs-identifier hs-type">HHQ</span></a><span>
</span><a name="line-391"></a><span>  </span><a name="local-6989586621679072802"><a href="#local-6989586621679072802"><span class="hs-identifier">combineConcat</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">rightAssoc</span><span> </span><a href="#local-6989586621679072781"><span class="hs-identifier hs-var">compOpt</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><a href="#local-6989586621679073209"><span class="hs-identifier hs-var">combineSeq</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679072803"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-392"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl1</span><span> </span><a href="#local-6989586621679073209"><span class="hs-identifier hs-var">combineSeq</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679072803"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-comment">-- libtre default</span><span>
</span><a name="line-393"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-pragma">{-# INLINE front'end #-}</span><span>
</span><a name="line-394"></a><span>          </span><a name="local-6989586621679073208"><a href="#local-6989586621679073208"><span class="hs-identifier">front'end</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">rightAssoc</span><span> </span><a href="#local-6989586621679072781"><span class="hs-identifier hs-var">compOpt</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM2</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftM2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>          </span><span class="hs-identifier">combineSeq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HHQ"><span class="hs-identifier hs-type">HHQ</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HHQ"><span class="hs-identifier hs-type">HHQ</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HHQ"><span class="hs-identifier hs-type">HHQ</span></a><span>
</span><a name="line-397"></a><span>          </span><a name="local-6989586621679073209"><a href="#local-6989586621679073209"><span class="hs-identifier">combineSeq</span></a></a><span> </span><a name="local-6989586621679073210"><a href="#local-6989586621679073210"><span class="hs-identifier">pFront</span></a></a><span> </span><a name="local-6989586621679073211"><a href="#local-6989586621679073211"><span class="hs-identifier">pEnd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679073212"><a href="#local-6989586621679073212"><span class="hs-identifier">m1</span></a></a><span> </span><a name="local-6989586621679073213"><a href="#local-6989586621679073213"><span class="hs-identifier">m2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">mdo</span><span>
</span><a name="line-398"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073214"><a href="#local-6989586621679073214"><span class="hs-identifier">bothVary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#varies"><span class="hs-identifier hs-var">varies</span></a><span> </span><a href="#local-6989586621679073218"><span class="hs-identifier hs-var">qFront</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#varies"><span class="hs-identifier hs-var">varies</span></a><span> </span><a href="#local-6989586621679073219"><span class="hs-identifier hs-var">qEnd</span></a><span>
</span><a name="line-399"></a><span>            </span><a name="local-6989586621679073215"><a href="#local-6989586621679073215"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier hs-var">noTag</span></a><span> </span><a href="#local-6989586621679073212"><span class="hs-identifier hs-var">m1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679073214"><span class="hs-identifier hs-var">bothVary</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072793"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-string">&quot;combineSeq start&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679073212"><span class="hs-identifier hs-var">m1</span></a><span>
</span><a name="line-400"></a><span>            </span><a name="local-6989586621679073216"><a href="#local-6989586621679073216"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier hs-var">noTag</span></a><span> </span><a href="#local-6989586621679073213"><span class="hs-identifier hs-var">m2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679073214"><span class="hs-identifier hs-var">bothVary</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072793"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-string">&quot;combineSeq stop&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679073213"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-401"></a><span>            </span><a name="local-6989586621679073217"><a href="#local-6989586621679073217"><span class="hs-identifier">mid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier hs-var">noTag</span></a><span> </span><a href="#local-6989586621679073215"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#canAccept"><span class="hs-identifier hs-var">canAccept</span></a><span> </span><a href="#local-6989586621679073218"><span class="hs-identifier hs-var">qFront</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier hs-var">noTag</span></a><span> </span><a href="#local-6989586621679073216"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="Text.Regex.TDFA.CorePattern.html#canAccept"><span class="hs-identifier hs-var">canAccept</span></a><span> </span><a href="#local-6989586621679073219"><span class="hs-identifier hs-var">qEnd</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-402"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#toAdvice"><span class="hs-identifier hs-var">toAdvice</span></a><span> </span><a href="#local-6989586621679073215"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#toAdvice"><span class="hs-identifier hs-var">toAdvice</span></a><span> </span><a href="#local-6989586621679073216"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-404"></a><span>                     </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">tagged</span><span> </span><a href="#local-6989586621679073218"><span class="hs-identifier hs-var">qFront</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">tagged</span><span> </span><a href="#local-6989586621679073219"><span class="hs-identifier hs-var">qEnd</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072793"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-string">&quot;combineSeq mid&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NoTag"><span class="hs-identifier hs-var">NoTag</span></a><span>
</span><a name="line-405"></a><span>      </span><span class="hs-comment">--      qFront &lt;- pFront a mid</span><span>
</span><a name="line-406"></a><span>      </span><span class="hs-comment">--      qEnd &lt;- pEnd (toAdvice mid) b</span><span>
</span><a name="line-407"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621679073218"><a href="#local-6989586621679073218"><span class="hs-identifier">qFront</span></a></a><span class="hs-special">,</span><a name="local-6989586621679073219"><a href="#local-6989586621679073219"><span class="hs-identifier">qEnd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073208"><span class="hs-identifier hs-var">front'end</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073210"><span class="hs-identifier hs-var">pFront</span></a><span> </span><a href="#local-6989586621679073215"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073217"><span class="hs-identifier hs-var">mid</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073211"><span class="hs-identifier hs-var">pEnd</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#toAdvice"><span class="hs-identifier hs-var">toAdvice</span></a><span> </span><a href="#local-6989586621679073217"><span class="hs-identifier hs-var">mid</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073216"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-408"></a><span>            </span><span class="hs-comment">-- XXX: Perhaps a &quot;produces&quot; should be created to compliment &quot;wants&quot;,</span><span>
</span><a name="line-409"></a><span>            </span><span class="hs-comment">-- then &quot;produces qEnd&quot; could be compared to &quot;wants qFront&quot;</span><span>
</span><a name="line-410"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073220"><a href="#local-6989586621679073220"><span class="hs-identifier">wanted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#WantsEither"><span class="hs-identifier hs-var">WantsEither</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">wants</span><span> </span><a href="#local-6989586621679073219"><span class="hs-identifier hs-var">qEnd</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">wants</span><span> </span><a href="#local-6989586621679073218"><span class="hs-identifier hs-var">qFront</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">wants</span><span> </span><a href="#local-6989586621679073219"><span class="hs-identifier hs-var">qEnd</span></a><span>
</span><a name="line-411"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nullQ</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#mergeNullViews"><span class="hs-identifier hs-var">mergeNullViews</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">nullQ</span><span> </span><a href="#local-6989586621679073218"><span class="hs-identifier hs-var">qFront</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nullQ</span><span> </span><a href="#local-6989586621679073219"><span class="hs-identifier hs-var">qEnd</span></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">takes</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#seqTake"><span class="hs-identifier hs-var">seqTake</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">takes</span><span> </span><a href="#local-6989586621679073218"><span class="hs-identifier hs-var">qFront</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">takes</span><span> </span><a href="#local-6989586621679073219"><span class="hs-identifier hs-var">qEnd</span></a><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">preReset</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">postSet</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">preTag</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">postTag</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-414"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tagged</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073214"><span class="hs-identifier hs-var">bothVary</span></a><span>
</span><a name="line-415"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><a href="#local-6989586621679073218"><span class="hs-identifier hs-var">qFront</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><a href="#local-6989586621679073219"><span class="hs-identifier hs-var">qEnd</span></a><span>
</span><a name="line-416"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wants</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073220"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-417"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">unQ</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Seq"><span class="hs-identifier hs-var">Seq</span></a><span> </span><a href="#local-6989586621679073218"><span class="hs-identifier hs-var">qFront</span></a><span> </span><a href="#local-6989586621679073219"><span class="hs-identifier hs-var">qEnd</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-418"></a><span>                                   </span><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Text.Regex.TDFA.Pattern.html#Pattern"><span class="hs-identifier hs-type">Pattern</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#HHQ"><span class="hs-identifier hs-type">HHQ</span></a><span>
</span><a name="line-420"></a><span>  </span><a name="local-6989586621679072803"><a href="#local-6989586621679072803"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679073221"><a href="#local-6989586621679073221"><span class="hs-identifier">pIn</span></a></a><span> </span><a name="local-6989586621679073222"><a href="#local-6989586621679073222"><span class="hs-identifier">m1</span></a></a><span> </span><a name="local-6989586621679073223"><a href="#local-6989586621679073223"><span class="hs-identifier">m2</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-421"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073224"><a href="#local-6989586621679073224"><span class="hs-identifier">die</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;patternToQ cannot handle &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679073221"><span class="hs-identifier hs-var">pIn</span></a><span>
</span><a name="line-422"></a><span>        </span><a name="local-6989586621679073225"><a href="#local-6989586621679073225"><span class="hs-identifier">nil</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">nullQ</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#makeEmptyNullView"><span class="hs-identifier hs-var">makeEmptyNullView</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-423"></a><span>                         </span><span class="hs-special">,</span><span class="hs-identifier">takes</span><span class="hs-glyph">=</span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>                         </span><span class="hs-special">,</span><span class="hs-identifier">preReset</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-identifier">postSet</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-identifier">preTag</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span class="hs-special">,</span><span class="hs-identifier">postTag</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-425"></a><span>                         </span><span class="hs-special">,</span><span class="hs-identifier">tagged</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier">childGroups</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier">wants</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#WantsEither"><span class="hs-identifier hs-var">WantsEither</span></a><span>
</span><a name="line-426"></a><span>                         </span><span class="hs-special">,</span><span class="hs-identifier">unQ</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span class="hs-special">}</span><span>
</span><a name="line-427"></a><span>        </span><a name="local-6989586621679073226"><a href="#local-6989586621679073226"><span class="hs-identifier">one</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">nullQ</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#notNull"><span class="hs-identifier hs-var">notNull</span></a><span>
</span><a name="line-428"></a><span>                         </span><span class="hs-special">,</span><span class="hs-identifier">takes</span><span class="hs-glyph">=</span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>                         </span><span class="hs-special">,</span><span class="hs-identifier">preReset</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-identifier">postSet</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-identifier">preTag</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span class="hs-special">,</span><span class="hs-identifier">postTag</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-430"></a><span>                         </span><span class="hs-special">,</span><span class="hs-identifier">tagged</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier">childGroups</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier">wants</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#WantsQNFA"><span class="hs-identifier hs-var">WantsQNFA</span></a><span>
</span><a name="line-431"></a><span>                         </span><span class="hs-special">,</span><span class="hs-identifier">unQ</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#OneChar"><span class="hs-identifier hs-var">OneChar</span></a><span> </span><a href="#local-6989586621679073221"><span class="hs-identifier hs-var">pIn</span></a><span class="hs-special">}</span><span>
</span><a name="line-432"></a><span>        </span><a name="local-6989586621679073227"><a href="#local-6989586621679073227"><span class="hs-identifier">test</span></a></a><span> </span><a name="local-6989586621679073229"><a href="#local-6989586621679073229"><span class="hs-identifier">myTest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">nullQ</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#makeTestNullView"><span class="hs-identifier hs-var">makeTestNullView</span></a><span> </span><a href="#local-6989586621679073229"><span class="hs-identifier hs-var">myTest</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-433"></a><span>                                 </span><span class="hs-special">,</span><span class="hs-identifier">takes</span><span class="hs-glyph">=</span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-434"></a><span>                                 </span><span class="hs-special">,</span><span class="hs-identifier">preReset</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-identifier">postSet</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-identifier">preTag</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span class="hs-special">,</span><span class="hs-identifier">postTag</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-435"></a><span>                                 </span><span class="hs-special">,</span><span class="hs-identifier">tagged</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier">childGroups</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier">wants</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#WantsQT"><span class="hs-identifier hs-var">WantsQT</span></a><span>
</span><a name="line-436"></a><span>                                 </span><span class="hs-special">,</span><span class="hs-identifier">unQ</span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#Test"><span class="hs-identifier hs-var">Test</span></a><span> </span><a href="#local-6989586621679073229"><span class="hs-identifier hs-var">myTest</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-437"></a><span>        </span><a name="local-6989586621679073228"><a href="#local-6989586621679073228"><span class="hs-identifier">xtra</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">newSyntax</span><span> </span><a href="#local-6989586621679072781"><span class="hs-identifier hs-var">compOpt</span></a><span>
</span><a name="line-438"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679073221"><span class="hs-identifier hs-var">pIn</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-439"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PEmpty"><span class="hs-identifier hs-var">PEmpty</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073225"><span class="hs-identifier hs-var">nil</span></a><span>
</span><a name="line-440"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#POr"><span class="hs-identifier hs-var">POr</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073225"><span class="hs-identifier hs-var">nil</span></a><span>
</span><a name="line-441"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#POr"><span class="hs-identifier hs-var">POr</span></a><span> </span><span class="hs-special">[</span><a name="local-6989586621679073230"><a href="#local-6989586621679073230"><span class="hs-identifier">branch</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072803"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073230"><span class="hs-identifier hs-var">branch</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-442"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#POr"><span class="hs-identifier hs-var">POr</span></a><span> </span><a name="local-6989586621679073231"><a href="#local-6989586621679073231"><span class="hs-identifier">branches</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">mdo</span><span>
</span><a name="line-443"></a><span>           </span><span class="hs-comment">-- 2009 : The PNonEmpty p as POr [PEmpty,p] takes no branch tracking tag.</span><span>
</span><a name="line-444"></a><span>           </span><span class="hs-comment">--        I claim this is because only accepting branches need tags,</span><span>
</span><a name="line-445"></a><span>           </span><span class="hs-comment">--        and the last accepting branch does not need a tag.</span><span>
</span><a name="line-446"></a><span>           </span><span class="hs-comment">--        Non-accepting possibilities can all commute to the front and</span><span>
</span><a name="line-447"></a><span>           </span><span class="hs-comment">--        become part of the nullQ.  The accepting bits then need prioritizing.</span><span>
</span><a name="line-448"></a><span>           </span><span class="hs-comment">--    Does the above require changes in POr handling in TNFA?  Yes.</span><span>
</span><a name="line-449"></a><span>           </span><span class="hs-comment">--    Have to always use nullQ instead of &quot;recapitulating&quot; it.</span><span>
</span><a name="line-450"></a><span>           </span><span class="hs-comment">--    Could also create a constant-writing tag instead of many index tags.</span><span>
</span><a name="line-451"></a><span>           </span><span class="hs-comment">-- Exasperation: This POr recursive mdo is very easy to make loop and lockup the program</span><span>
</span><a name="line-452"></a><span>           </span><span class="hs-comment">-- if needTags is False then there is no way to disambiguate branches so fewer tags are needed</span><span>
</span><a name="line-453"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073232"><a href="#local-6989586621679073232"><span class="hs-identifier">needUniqTags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><a href="#local-6989586621679073244"><span class="hs-identifier hs-var">ans</span></a><span>
</span><a name="line-454"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073233"><a href="#local-6989586621679073233"><span class="hs-identifier">needTags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#varies"><span class="hs-identifier hs-var">varies</span></a><span> </span><a href="#local-6989586621679073244"><span class="hs-identifier hs-var">ans</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><a href="#local-6989586621679073244"><span class="hs-identifier hs-var">ans</span></a><span> </span><span class="hs-comment">-- childGroups detects that &quot;abc|a(b)c&quot; needs tags</span><span>
</span><a name="line-455"></a><span>           </span><a name="local-6989586621679073234"><a href="#local-6989586621679073234"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier hs-var">noTag</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679073233"><span class="hs-identifier hs-var">needTags</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072793"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-string">&quot;POr start&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><span class="hs-comment">-- whole POr</span><span>
</span><a name="line-456"></a><span>           </span><a name="local-6989586621679073235"><a href="#local-6989586621679073235"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier hs-var">noTag</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679073233"><span class="hs-identifier hs-var">needTags</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072793"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-string">&quot;POr stop&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span> </span><span class="hs-comment">-- whole POr</span><span>
</span><a name="line-457"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073236"><a href="#local-6989586621679073236"><span class="hs-identifier">aAdvice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#toAdvice"><span class="hs-identifier hs-var">toAdvice</span></a><span> </span><a href="#local-6989586621679073234"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-comment">-- all branches share 'aAdvice'</span><span>
</span><a name="line-458"></a><span>               </span><a name="local-6989586621679073237"><a href="#local-6989586621679073237"><span class="hs-identifier">bAdvice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#toAdvice"><span class="hs-identifier hs-var">toAdvice</span></a><span> </span><a href="#local-6989586621679073235"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-comment">-- last branch gets 'bAdvice', others may get own tag</span><span>
</span><a name="line-459"></a><span>               </span><span class="hs-comment">-- Due to the recursive-do, it seems that I have to put the if needTags into the op'</span><span>
</span><a name="line-460"></a><span>               </span><a name="local-6989586621679073238"><a href="#local-6989586621679073238"><span class="hs-identifier">newUniq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679073232"><span class="hs-identifier hs-var">needUniqTags</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072793"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-string">&quot;POr branch&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679073237"><span class="hs-identifier hs-var">bAdvice</span></a><span>
</span><a name="line-461"></a><span class="hs-comment">--           trace (&quot;\nPOr sub &quot;++show aAdvice++&quot; &quot;++show bAdvice++&quot;needsTags is &quot;++show needTags) $ return ()</span><span>
</span><a name="line-462"></a><span>           </span><span class="hs-comment">-- The &quot;bs&quot; values are allocated in left-to-right order before the children in &quot;qs&quot;</span><span>
</span><a name="line-463"></a><span>           </span><span class="hs-comment">-- optimiztion: low priority for last branch is implicit, do not create separate tag here.</span><span>
</span><a name="line-464"></a><span>           </span><a name="local-6989586621679073239"><a href="#local-6989586621679073239"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">[</span><a href="#local-6989586621679073237"><span class="hs-identifier hs-var">bAdvice</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pred</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679073231"><span class="hs-identifier hs-var">branches</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073238"><span class="hs-identifier hs-var">newUniq</span></a><span> </span><span class="hs-comment">-- 2 &lt;= length ps</span><span>
</span><a name="line-465"></a><span>           </span><span class="hs-comment">-- create all the child branches in left-to-right order after the &quot;bs&quot;</span><span>
</span><a name="line-466"></a><span>           </span><a name="local-6989586621679073240"><a href="#local-6989586621679073240"><span class="hs-identifier">qs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679073231"><span class="hs-identifier hs-var">branches</span></a><span> </span><a href="#local-6989586621679073239"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679073245"><a href="#local-6989586621679073245"><span class="hs-identifier">branch</span></a></a><span class="hs-special">,</span><a name="local-6989586621679073246"><a href="#local-6989586621679073246"><span class="hs-identifier">bTag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-special">(</span><a href="#local-6989586621679072803"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073245"><span class="hs-identifier hs-var">branch</span></a><span> </span><a href="#local-6989586621679073236"><span class="hs-identifier hs-var">aAdvice</span></a><span> </span><a href="#local-6989586621679073246"><span class="hs-identifier hs-var">bTag</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-467"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073241"><a href="#local-6989586621679073241"><span class="hs-identifier">wqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">wants</span><span> </span><a href="#local-6989586621679073240"><span class="hs-identifier hs-var">qs</span></a><span>
</span><a name="line-468"></a><span>               </span><a name="local-6989586621679073242"><a href="#local-6989586621679073242"><span class="hs-identifier">wanted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#WantsBoth"><span class="hs-identifier hs-var">WantsBoth</span></a><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073241"><span class="hs-identifier hs-var">wqs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#WantsBoth"><span class="hs-identifier hs-var">WantsBoth</span></a><span>
</span><a name="line-469"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#WantsQNFA"><span class="hs-identifier hs-var">WantsQNFA</span></a><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073241"><span class="hs-identifier hs-var">wqs</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#WantsQT"><span class="hs-identifier hs-var">WantsQT</span></a><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073241"><span class="hs-identifier hs-var">wqs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-470"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#WantsBoth"><span class="hs-identifier hs-var">WantsBoth</span></a><span>
</span><a name="line-471"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#WantsQNFA"><span class="hs-identifier hs-var">WantsQNFA</span></a><span>
</span><a name="line-472"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#WantsQT"><span class="hs-identifier hs-var">WantsQT</span></a><span>
</span><a name="line-473"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#WantsEither"><span class="hs-identifier hs-var">WantsEither</span></a><span>
</span><a name="line-474"></a><span>               </span><a name="local-6989586621679073243"><a href="#local-6989586621679073243"><span class="hs-identifier">nullView</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#cleanNullView"><span class="hs-identifier hs-var">cleanNullView</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#tagWrapNullView"><span class="hs-identifier hs-var">tagWrapNullView</span></a><span> </span><a href="#local-6989586621679073234"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073235"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier">nullQ</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073240"><span class="hs-identifier hs-var">qs</span></a><span>
</span><a name="line-475"></a><span>               </span><span class="hs-comment">-- The nullView computed above takes the nullQ of the branches and combines them.  This</span><span>
</span><a name="line-476"></a><span>               </span><span class="hs-comment">-- assumes that the pre/post tags of the children are also part of the nullQ values.  So</span><span>
</span><a name="line-477"></a><span>               </span><span class="hs-comment">-- for consistency, POr must then add its own pre/post tags to its nullQ value.  Note that</span><span>
</span><a name="line-478"></a><span>               </span><span class="hs-comment">-- concatMap sets the left-to-right preference when choosing the null views.</span><span>
</span><a name="line-479"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073244"><a href="#local-6989586621679073244"><span class="hs-identifier">ans</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nullQ</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073243"><span class="hs-identifier hs-var">nullView</span></a><span>
</span><a name="line-480"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">takes</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#orTakes"><span class="hs-identifier hs-var">orTakes</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">takes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073240"><span class="hs-identifier hs-var">qs</span></a><span>
</span><a name="line-481"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">preReset</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">postSet</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-482"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">preTag</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679073234"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">postTag</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679073235"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-483"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tagged</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073233"><span class="hs-identifier hs-var">needTags</span></a><span>
</span><a name="line-484"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><a href="#local-6989586621679073240"><span class="hs-identifier hs-var">qs</span></a><span>
</span><a name="line-485"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wants</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073242"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-486"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">unQ</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Or"><span class="hs-identifier hs-var">Or</span></a><span> </span><a href="#local-6989586621679073240"><span class="hs-identifier hs-var">qs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-487"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679073244"><span class="hs-identifier hs-var">ans</span></a><span>
</span><a name="line-488"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PConcat"><span class="hs-identifier hs-var">PConcat</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073225"><span class="hs-identifier hs-var">nil</span></a><span> </span><span class="hs-comment">-- fatal to pass [] to combineConcat</span><span>
</span><a name="line-489"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PConcat"><span class="hs-identifier hs-var">PConcat</span></a><span> </span><a name="local-6989586621679073247"><a href="#local-6989586621679073247"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072802"><span class="hs-identifier hs-var">combineConcat</span></a><span> </span><a href="#local-6989586621679073247"><span class="hs-identifier hs-var">ps</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-490"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PStar"><span class="hs-identifier hs-var">PStar</span></a><span> </span><a name="local-6989586621679073248"><a href="#local-6989586621679073248"><span class="hs-identifier">mayFirstBeNull</span></a></a><span> </span><a name="local-6989586621679073249"><a href="#local-6989586621679073249"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">mdo</span><span>
</span><a name="line-491"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073250"><a href="#local-6989586621679073250"><span class="hs-identifier">accepts</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#canAccept"><span class="hs-identifier hs-var">canAccept</span></a><span> </span><a href="#local-6989586621679073256"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-492"></a><span>               </span><span class="hs-comment">-- if needsOrbit is False then there is no need to disambiguate captures on each orbit</span><span>
</span><a name="line-493"></a><span>               </span><span class="hs-comment">-- Both checks are useful because (varies q) of True does not imply (childGroups q) of True when under PNonCapture</span><span>
</span><a name="line-494"></a><span>               </span><a name="local-6989586621679073251"><a href="#local-6989586621679073251"><span class="hs-identifier">needsOrbit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#varies"><span class="hs-identifier hs-var">varies</span></a><span> </span><a href="#local-6989586621679073256"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><a href="#local-6989586621679073256"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-495"></a><span>               </span><span class="hs-comment">-- if needsOrbit then must check start/stop before the Orbit tag</span><span>
</span><a name="line-496"></a><span>               </span><span class="hs-comment">-- if accepts then must check start/stop of whole pattern</span><span>
</span><a name="line-497"></a><span>               </span><a name="local-6989586621679073252"><a href="#local-6989586621679073252"><span class="hs-identifier">needsTags</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073251"><span class="hs-identifier hs-var">needsOrbit</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679073250"><span class="hs-identifier hs-var">accepts</span></a><span>       </span><span class="hs-comment">-- important that needsOrbit implies needsTags</span><span>
</span><a name="line-498"></a><span>           </span><a name="local-6989586621679073253"><a href="#local-6989586621679073253"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier hs-var">noTag</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679073252"><span class="hs-identifier hs-var">needsTags</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072793"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-string">&quot;PStar start&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span>
</span><a name="line-499"></a><span>           </span><a name="local-6989586621679073254"><a href="#local-6989586621679073254"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier hs-var">noTag</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679073252"><span class="hs-identifier hs-var">needsTags</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072793"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-string">&quot;PStar stop&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-500"></a><span>           </span><a name="local-6989586621679073255"><a href="#local-6989586621679073255"><span class="hs-identifier">mOrbit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679073251"><span class="hs-identifier hs-var">needsOrbit</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072796"><span class="hs-identifier hs-var">makeOrbit</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-comment">-- any Orbit tag is created after the pre and post tags</span><span>
</span><a name="line-501"></a><span class="hs-comment">--           test1 &lt;- if tagged q then uniq &quot;not-TEST1&quot; Minimize else return NoTag</span><span>
</span><a name="line-502"></a><span class="hs-comment">-- XXX XXX 1.1.5 testing second NoTag replaced with (toAdvice b)</span><span>
</span><a name="line-503"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621679073256"><a href="#local-6989586621679073256"><span class="hs-identifier">q</span></a></a><span class="hs-special">,</span><a name="local-6989586621679073257"><a href="#local-6989586621679073257"><span class="hs-identifier">resetOrbitTags</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072797"><span class="hs-identifier hs-var">withOrbit</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072803"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073249"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="Text.Regex.TDFA.CorePattern.html#NoTag"><span class="hs-identifier hs-var">NoTag</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#toAdvice"><span class="hs-identifier hs-var">toAdvice</span></a><span> </span><a href="#local-6989586621679073254"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- all contained orbit tags get listened to (not including this one).</span><span>
</span><a name="line-504"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073258"><a href="#local-6989586621679073258"><span class="hs-identifier">nullView</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679073248"><span class="hs-identifier hs-var">mayFirstBeNull</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#cleanNullView"><span class="hs-identifier hs-var">cleanNullView</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073259"><span class="hs-identifier hs-var">childViews</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679073260"><span class="hs-identifier hs-var">skipView</span></a><span>
</span><a name="line-505"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073260"><span class="hs-identifier hs-var">skipView</span></a><span>
</span><a name="line-506"></a><span>                 </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679073259"><a href="#local-6989586621679073259"><span class="hs-identifier">childViews</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#tagWrapNullView"><span class="hs-identifier hs-var">tagWrapNullView</span></a><span> </span><a href="#local-6989586621679073253"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073254"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#orbitWrapNullView"><span class="hs-identifier hs-var">orbitWrapNullView</span></a><span> </span><a href="#local-6989586621679073255"><span class="hs-identifier hs-var">mOrbit</span></a><span> </span><a href="#local-6989586621679073257"><span class="hs-identifier hs-var">resetOrbitTags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">nullQ</span><span> </span><a href="#local-6989586621679073256"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-507"></a><span>                       </span><a name="local-6989586621679073260"><a href="#local-6989586621679073260"><span class="hs-identifier">skipView</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#makeEmptyNullView"><span class="hs-identifier hs-var">makeEmptyNullView</span></a><span> </span><a href="#local-6989586621679073253"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073254"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-508"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nullQ</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073258"><span class="hs-identifier hs-var">nullView</span></a><span>
</span><a name="line-509"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">takes</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679073250"><span class="hs-identifier hs-var">accepts</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">preReset</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">postSet</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-511"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">preTag</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679073253"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">postTag</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679073254"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-512"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tagged</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073252"><span class="hs-identifier hs-var">needsTags</span></a><span>
</span><a name="line-513"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><a href="#local-6989586621679073256"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-514"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wants</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#WantsQT"><span class="hs-identifier hs-var">WantsQT</span></a><span>
</span><a name="line-515"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">unQ</span><span> </span><span class="hs-glyph">=</span><a href="Text.Regex.TDFA.CorePattern.html#Star"><span class="hs-identifier hs-var">Star</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">getOrbit</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073255"><span class="hs-identifier hs-var">mOrbit</span></a><span>
</span><a name="line-516"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resetOrbits</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073257"><span class="hs-identifier hs-var">resetOrbitTags</span></a><span>
</span><a name="line-517"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">firstNull</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073248"><span class="hs-identifier hs-var">mayFirstBeNull</span></a><span>
</span><a name="line-518"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">unStar</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073256"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-519"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PCarat"><span class="hs-identifier hs-var">PCarat</span></a><span> </span><a name="local-6989586621679073261"><a href="#local-6989586621679073261"><span class="hs-identifier">dopa</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073227"><span class="hs-identifier hs-var">test</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Test_BOL"><span class="hs-identifier hs-var">Test_BOL</span></a><span class="hs-special">,</span><a href="#local-6989586621679073261"><span class="hs-identifier hs-var">dopa</span></a><span class="hs-special">)</span><span>
</span><a name="line-520"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PDollar"><span class="hs-identifier hs-var">PDollar</span></a><span> </span><a name="local-6989586621679073262"><a href="#local-6989586621679073262"><span class="hs-identifier">dopa</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073227"><span class="hs-identifier hs-var">test</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Test_EOL"><span class="hs-identifier hs-var">Test_EOL</span></a><span class="hs-special">,</span><a href="#local-6989586621679073262"><span class="hs-identifier hs-var">dopa</span></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PChar"><span class="hs-identifier hs-var">PChar</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073226"><span class="hs-identifier hs-var">one</span></a><span>
</span><a name="line-522"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PDot"><span class="hs-identifier hs-var">PDot</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073226"><span class="hs-identifier hs-var">one</span></a><span>
</span><a name="line-523"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PAny"><span class="hs-identifier hs-var">PAny</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073226"><span class="hs-identifier hs-var">one</span></a><span>
</span><a name="line-524"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PAnyNot"><span class="hs-identifier hs-var">PAnyNot</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073226"><span class="hs-identifier hs-var">one</span></a><span>
</span><a name="line-525"></a><span>         </span><span class="hs-comment">-- CompOption's newSyntax enables these escaped anchors</span><span>
</span><a name="line-526"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PEscape"><span class="hs-identifier hs-var">PEscape</span></a><span> </span><a name="local-6989586621679073263"><a href="#local-6989586621679073263"><span class="hs-identifier">dopa</span></a></a><span> </span><span class="hs-char">'`'</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679073228"><span class="hs-identifier hs-var">xtra</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073227"><span class="hs-identifier hs-var">test</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Test_BOB"><span class="hs-identifier hs-var">Test_BOB</span></a><span class="hs-special">,</span><a href="#local-6989586621679073263"><span class="hs-identifier hs-var">dopa</span></a><span class="hs-special">)</span><span>
</span><a name="line-527"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PEscape"><span class="hs-identifier hs-var">PEscape</span></a><span> </span><a name="local-6989586621679073264"><a href="#local-6989586621679073264"><span class="hs-identifier">dopa</span></a></a><span> </span><span class="hs-char">'\''</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679073228"><span class="hs-identifier hs-var">xtra</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073227"><span class="hs-identifier hs-var">test</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Test_EOB"><span class="hs-identifier hs-var">Test_EOB</span></a><span class="hs-special">,</span><a href="#local-6989586621679073264"><span class="hs-identifier hs-var">dopa</span></a><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PEscape"><span class="hs-identifier hs-var">PEscape</span></a><span> </span><a name="local-6989586621679073265"><a href="#local-6989586621679073265"><span class="hs-identifier">dopa</span></a></a><span> </span><span class="hs-char">'&lt;'</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679073228"><span class="hs-identifier hs-var">xtra</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073227"><span class="hs-identifier hs-var">test</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Test_BOW"><span class="hs-identifier hs-var">Test_BOW</span></a><span class="hs-special">,</span><a href="#local-6989586621679073265"><span class="hs-identifier hs-var">dopa</span></a><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PEscape"><span class="hs-identifier hs-var">PEscape</span></a><span> </span><a name="local-6989586621679073266"><a href="#local-6989586621679073266"><span class="hs-identifier">dopa</span></a></a><span> </span><span class="hs-char">'&gt;'</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679073228"><span class="hs-identifier hs-var">xtra</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073227"><span class="hs-identifier hs-var">test</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Test_EOW"><span class="hs-identifier hs-var">Test_EOW</span></a><span class="hs-special">,</span><a href="#local-6989586621679073266"><span class="hs-identifier hs-var">dopa</span></a><span class="hs-special">)</span><span>
</span><a name="line-530"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PEscape"><span class="hs-identifier hs-var">PEscape</span></a><span> </span><a name="local-6989586621679073267"><a href="#local-6989586621679073267"><span class="hs-identifier">dopa</span></a></a><span> </span><span class="hs-char">'b'</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679073228"><span class="hs-identifier hs-var">xtra</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073227"><span class="hs-identifier hs-var">test</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Test_EdgeWord"><span class="hs-identifier hs-var">Test_EdgeWord</span></a><span class="hs-special">,</span><a href="#local-6989586621679073267"><span class="hs-identifier hs-var">dopa</span></a><span class="hs-special">)</span><span>
</span><a name="line-531"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PEscape"><span class="hs-identifier hs-var">PEscape</span></a><span> </span><a name="local-6989586621679073268"><a href="#local-6989586621679073268"><span class="hs-identifier">dopa</span></a></a><span> </span><span class="hs-char">'B'</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679073228"><span class="hs-identifier hs-var">xtra</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073227"><span class="hs-identifier hs-var">test</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#Test_NotEdgeWord"><span class="hs-identifier hs-var">Test_NotEdgeWord</span></a><span class="hs-special">,</span><a href="#local-6989586621679073268"><span class="hs-identifier hs-var">dopa</span></a><span class="hs-special">)</span><span>
</span><a name="line-532"></a><span>         </span><span class="hs-comment">-- otherwise escape codes are just the escaped character</span><span>
</span><a name="line-533"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PEscape"><span class="hs-identifier hs-var">PEscape</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073226"><span class="hs-identifier hs-var">one</span></a><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span>         </span><span class="hs-comment">-- A PGroup node in the Pattern tree does not become a node</span><span>
</span><a name="line-536"></a><span>         </span><span class="hs-comment">-- in the Q/P tree. A PGroup can share and pass along a</span><span>
</span><a name="line-537"></a><span>         </span><span class="hs-comment">-- preTag (with Advice) with other branches, but will pass</span><span>
</span><a name="line-538"></a><span>         </span><span class="hs-comment">-- down an Apply postTag.</span><span>
</span><a name="line-539"></a><span>         </span><span class="hs-comment">--</span><span>
</span><a name="line-540"></a><span>         </span><span class="hs-comment">-- If the parent index is Nothing then this is part of a</span><span>
</span><a name="line-541"></a><span>         </span><span class="hs-comment">-- non-capturing subtree and ignored.  This is a lazy and</span><span>
</span><a name="line-542"></a><span>         </span><span class="hs-comment">-- efficient alternative to rebuidling the tree with PGroup</span><span>
</span><a name="line-543"></a><span>         </span><span class="hs-comment">-- Nothing replacing PGroup (Just _).</span><span>
</span><a name="line-544"></a><span>         </span><span class="hs-comment">--</span><span>
</span><a name="line-545"></a><span>         </span><span class="hs-comment">-- Guarded by the getParentIndex /= Nothing check is the</span><span>
</span><a name="line-546"></a><span>         </span><span class="hs-comment">-- withParent command.</span><span>
</span><a name="line-547"></a><span>         </span><span class="hs-comment">--</span><span>
</span><a name="line-548"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PGroup"><span class="hs-identifier hs-var">PGroup</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621679073269"><a href="#local-6989586621679073269"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072803"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073269"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-549"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PGroup"><span class="hs-identifier hs-var">PGroup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679073270"><a href="#local-6989586621679073270"><span class="hs-identifier">this</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679073271"><a href="#local-6989586621679073271"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-550"></a><span>           </span><a name="local-6989586621679073272"><a href="#local-6989586621679073272"><span class="hs-identifier">mParent</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072799"><span class="hs-identifier hs-var">getParentIndex</span></a><span>
</span><a name="line-551"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679073272"><span class="hs-identifier hs-var">mParent</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-552"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072803"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073271"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span> </span><span class="hs-comment">-- just like PGroup Nothing p</span><span>
</span><a name="line-553"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679073273"><a href="#local-6989586621679073273"><span class="hs-identifier">parent</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-554"></a><span>               </span><span class="hs-comment">-- 'a' may be Advice or Apply from parent or Apply created here</span><span>
</span><a name="line-555"></a><span>               </span><a name="local-6989586621679073274"><a href="#local-6989586621679073274"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier hs-var">noTag</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072793"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-string">&quot;PGroup start&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span>
</span><a name="line-556"></a><span>               </span><a name="local-6989586621679073275"><a href="#local-6989586621679073275"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#noTag"><span class="hs-identifier hs-var">noTag</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679072793"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-string">&quot;PGroup stop&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-557"></a><span>               </span><a name="local-6989586621679073276"><a href="#local-6989586621679073276"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072794"><span class="hs-identifier hs-var">ignore</span></a><span> </span><span class="hs-string">&quot;PGroup ignore&quot;</span><span>
</span><a name="line-558"></a><span class="hs-comment">{-
               -- 'b' may be Apply from parent or Apply created here
               b &lt;- if isNothing (apply m2) then uniq &quot;PGroup&quot; else return m2
-}</span><span>
</span><a name="line-562"></a><span>               </span><span class="hs-special">(</span><a name="local-6989586621679073277"><a href="#local-6989586621679073277"><span class="hs-identifier">q</span></a></a><span class="hs-special">,</span><a name="local-6989586621679073278"><a href="#local-6989586621679073278"><span class="hs-identifier">resetGroupTags</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679072801"><span class="hs-identifier hs-var">withParent</span></a><span> </span><a href="#local-6989586621679073270"><span class="hs-identifier hs-var">this</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072803"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073271"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679073274"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073275"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- all immediate child groups stop tags get listened to.</span><span>
</span><a name="line-563"></a><span>               </span><span class="hs-comment">-- 2009: makeGroup performs a tell, why after withParent? I am no longer sure.</span><span>
</span><a name="line-564"></a><span>               </span><a href="#local-6989586621679072798"><span class="hs-identifier hs-var">makeGroup</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.Common.html#GroupInfo"><span class="hs-identifier hs-var">GroupInfo</span></a><span> </span><a href="#local-6989586621679073270"><span class="hs-identifier hs-var">this</span></a><span> </span><a href="#local-6989586621679073273"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#fromHandleTag"><span class="hs-identifier hs-var">fromHandleTag</span></a><span> </span><a href="#local-6989586621679073274"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Text.Regex.TDFA.CorePattern.html#fromHandleTag"><span class="hs-identifier hs-var">fromHandleTag</span></a><span> </span><a href="#local-6989586621679073275"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073276"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span>
</span><a name="line-565"></a><span>               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073277"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nullQ</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Text.Regex.TDFA.CorePattern.html#addGroupResetsToNullView"><span class="hs-identifier hs-var">addGroupResetsToNullView</span></a><span> </span><a href="#local-6989586621679073278"><span class="hs-identifier hs-var">resetGroupTags</span></a><span> </span><a href="#local-6989586621679073276"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">nullQ</span><span> </span><a href="#local-6989586621679073277"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span>
</span><a name="line-566"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tagged</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-567"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">childGroups</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-568"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">preReset</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073278"><span class="hs-identifier hs-var">resetGroupTags</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">preReset</span><span> </span><a href="#local-6989586621679073277"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">postSet</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">postSet</span><span> </span><a href="#local-6989586621679073277"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679073276"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">]</span><span>
</span><a name="line-570"></a><span>                          </span><span class="hs-special">}</span><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span>         </span><span class="hs-comment">-- A PNonCapture node in the Pattern tree does not become a</span><span>
</span><a name="line-573"></a><span>         </span><span class="hs-comment">-- node in the Q/P tree.  It sets the parent to Nothing while</span><span>
</span><a name="line-574"></a><span>         </span><span class="hs-comment">-- processing the sub-tree.</span><span>
</span><a name="line-575"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PNonCapture"><span class="hs-identifier hs-var">PNonCapture</span></a><span> </span><a name="local-6989586621679073279"><a href="#local-6989586621679073279"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072800"><span class="hs-identifier hs-var">nonCapture</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072803"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073279"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679073222"><span class="hs-identifier hs-var">m1</span></a><span> </span><a href="#local-6989586621679073223"><span class="hs-identifier hs-var">m2</span></a><span class="hs-special">)</span><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span>         </span><span class="hs-comment">-- these are here for completeness of the case branches, currently starTrans replaces them all</span><span>
</span><a name="line-578"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PPlus"><span class="hs-identifier hs-var">PPlus</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073224"><span class="hs-identifier hs-var">die</span></a><span>
</span><a name="line-579"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PQuest"><span class="hs-identifier hs-var">PQuest</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073224"><span class="hs-identifier hs-var">die</span></a><span>
</span><a name="line-580"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PBound"><span class="hs-identifier hs-var">PBound</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073224"><span class="hs-identifier hs-var">die</span></a><span>
</span><a name="line-581"></a><span>         </span><span class="hs-comment">-- PNonEmpty is deprecated, and not produced in Pattern by starTrans anymore</span><span>
</span><a name="line-582"></a><span>         </span><a href="Text.Regex.TDFA.Pattern.html#PNonEmpty"><span class="hs-identifier hs-var">PNonEmpty</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073224"><span class="hs-identifier hs-var">die</span></a><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span class="hs-comment">{-
Similar to change in WinTags for QT/QNFA:
Change the NullView to use a tasktags instead of wintags since they are all PreUpdate

         -- PNonEmpty means the child pattern p can be skipped by
         -- bypassing the pattern.  This is only used in the case p
         -- can accept 0 and can accept more than zero characters
         -- (thus the assertions, enforcted by CorePattern.starTrans).
         -- The important thing about this case is intercept the
         -- &quot;accept 0&quot; possibility and replace with &quot;skip&quot;.
         PNonEmpty p -&gt; mdo
           let needsTags = canAccept q
           a &lt;- if noTag m1 &amp;&amp; needsTags then uniq Minimize else return m1
           b &lt;- if noTag m2 &amp;&amp; needsTags then uniq Maximize else return m2
           q &lt;- go p (toAdvice a) (toAdvice b)
           when (not needsTags) (err $ &quot;PNonEmpty could not accept characters: &quot;++show (p,pOrig))
           when (mustAccept q) (err $ &quot;patternToQ : PNonEmpty provided with a *mustAccept* pattern: &quot;++show (p,pOrig))
           return $ Q { nullQ = emptyNull (preTags (apply a) (apply b)) -- The meaning of NonEmpty
                      , takes = (0,snd (takes q))                       -- like Or, drop lower bound to 0
                      , preReset = []
                      , preTag = apply a, postTag = apply b             -- own the closing tag so it will not end a PGroup
                      , tagged = needsTags
                      , childGroups = childGroups q
                      , wants = wants q  -- the test case is &quot;x&quot; =~ &quot;(.|$){1,3}&quot;
                      , unQ = NonEmpty q }

-}</span><span>
</span><a name="line-611"></a><span class="hs-comment">{-
emptyNull :: TagList -&gt; NullView
emptyNull tags = (mempty, tags) : []

testNull :: TestInfo -&gt; TagList -&gt; NullView
testNull (w,d) tags = (SetTestInfo (Map.singleton w (Set.singleton d)), tags) : []

-- Prepend tags to nullView
addTagsToNullView :: TagList -&gt; NullView -&gt; NullView
addTagsToNullView [] oldNV = oldNV
addTagsToNullView tags oldNV= do
  (oldTest,oldTags) &lt;- oldNV
  return (oldTest,tags `mappend` oldTags)

-}</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span class="hs-comment">-- xxx todo</span><span>
</span><a name="line-629"></a><span class="hs-comment">-- </span><span>
</span><a name="line-630"></a><span class="hs-comment">-- see of PNonEmpty -&gt; NonEmpty -&gt; TNFA is really smarter than POr about tags</span><span>
</span><a name="line-631"></a></pre></body></html>