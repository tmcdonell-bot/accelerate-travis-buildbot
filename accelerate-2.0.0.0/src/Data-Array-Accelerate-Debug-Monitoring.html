<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Data/Array/Accelerate/Debug/Monitoring.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns      #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE CPP               #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE OverloadedStrings #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE RecordWildCards   #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# OPTIONS_HADDOCK hide #-}</span>
<a name="line-6"></a><span class='hs-comment'>-- |</span>
<a name="line-7"></a><span class='hs-comment'>-- Module      : Data.Array.Accelerate.Debug.Monitoring</span>
<a name="line-8"></a><span class='hs-comment'>-- Copyright   : [2016] Manuel M T Chakravarty, Gabriele Keller, Trevor L. McDonell</span>
<a name="line-9"></a><span class='hs-comment'>-- License     : BSD3</span>
<a name="line-10"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><span class='hs-comment'>-- Maintainer  : Manuel M T Chakravarty &lt;chak@cse.unsw.edu.au&gt;</span>
<a name="line-12"></a><span class='hs-comment'>-- Stability   : experimental</span>
<a name="line-13"></a><span class='hs-comment'>-- Portability : non-portable (GHC extensions)</span>
<a name="line-14"></a><span class='hs-comment'>--</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Debug</span><span class='hs-varop'>.</span><span class='hs-conid'>Monitoring</span> <span class='hs-layout'>(</span>
<a name="line-17"></a>
<a name="line-18"></a>  <span class='hs-varid'>initAccMetrics</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>  <span class='hs-conid'>Processor</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-21"></a>  <span class='hs-varid'>withProcessor</span><span class='hs-layout'>,</span> <span class='hs-varid'>addProcessorTime</span><span class='hs-layout'>,</span>
<a name="line-22"></a>  <span class='hs-varid'>didAllocateBytes</span><span class='hs-layout'>,</span>
<a name="line-23"></a>  <span class='hs-varid'>didEvictLRU</span><span class='hs-layout'>,</span>
<a name="line-24"></a>  <span class='hs-varid'>didMajorGC</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-cpp'>#ifdef ACCELERATE_MONITORING</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Atomic</span>                                                  <span class='hs-layout'>(</span> <span class='hs-conid'>Atomic</span> <span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Atomic</span>                                        <span class='hs-keyword'>as</span> <span class='hs-conid'>Atomic</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Metrics</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Metrics</span><span class='hs-varop'>.</span><span class='hs-conid'>Counter</span>                                       <span class='hs-layout'>(</span> <span class='hs-conid'>Counter</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Metrics</span><span class='hs-varop'>.</span><span class='hs-conid'>Gauge</span>                                         <span class='hs-layout'>(</span> <span class='hs-conid'>Gauge</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Metrics</span><span class='hs-varop'>.</span><span class='hs-conid'>Counter</span>                             <span class='hs-keyword'>as</span> <span class='hs-conid'>Counter</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Metrics</span><span class='hs-varop'>.</span><span class='hs-conid'>Gauge</span>                               <span class='hs-keyword'>as</span> <span class='hs-conid'>Gauge</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span>                                                    <span class='hs-layout'>(</span> <span class='hs-conid'>Text</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Time</span><span class='hs-varop'>.</span><span class='hs-conid'>Clock</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Unsafe</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>HashMap</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span>                                <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-44"></a><span class='hs-cpp'>#endif</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Int</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span>
<a name="line-48"></a>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-comment'>-- | Initialise and return the Accelerate monitoring store. To enable monitoring</span>
<a name="line-51"></a><span class='hs-comment'>-- of your application:</span>
<a name="line-52"></a><span class='hs-comment'>--</span>
<a name="line-53"></a><span class='hs-comment'>-- &gt; import Data.Array.Accelerate.Debug</span>
<a name="line-54"></a><span class='hs-comment'>-- &gt;</span>
<a name="line-55"></a><span class='hs-comment'>-- &gt; import System.Metrics</span>
<a name="line-56"></a><span class='hs-comment'>-- &gt; import System.Remote.Monitoring</span>
<a name="line-57"></a><span class='hs-comment'>-- &gt;</span>
<a name="line-58"></a><span class='hs-comment'>-- &gt; main :: IO ()</span>
<a name="line-59"></a><span class='hs-comment'>-- &gt; main = do</span>
<a name="line-60"></a><span class='hs-comment'>-- &gt;   store  &lt;- initAccMetrics</span>
<a name="line-61"></a><span class='hs-comment'>-- &gt;   registerGcMetrics store      -- optional</span>
<a name="line-62"></a><span class='hs-comment'>-- &gt;</span>
<a name="line-63"></a><span class='hs-comment'>-- &gt;   server &lt;- forkServerWith store "localhost" 8000</span>
<a name="line-64"></a><span class='hs-comment'>-- &gt;</span>
<a name="line-65"></a><span class='hs-comment'>-- &gt;   ...</span>
<a name="line-66"></a><span class='hs-comment'>--</span>
<a name="line-67"></a><span class='hs-cpp'>#ifndef ACCELERATE_MONITORING</span>
<a name="line-68"></a><a name="initAccMetrics"></a><span class='hs-definition'>initAccMetrics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-69"></a><span class='hs-definition'>initAccMetrics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Data.Array.Accelerate: Monitoring is disabled. Reinstall package 'accelerate' with '-fekg' to enable it."</span>
<a name="line-70"></a><span class='hs-cpp'>#else</span>
<a name="line-71"></a><span class='hs-definition'>initAccMetrics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Store</span>
<a name="line-72"></a><span class='hs-definition'>initAccMetrics</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-73"></a>  <span class='hs-varid'>store</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newStore</span>
<a name="line-74"></a>
<a name="line-75"></a>  <span class='hs-varid'>registerRate</span>    <span class='hs-str'>"acc.load.llvm_native"</span>            <span class='hs-layout'>(</span><span class='hs-varid'>calculateProcessorLoad</span> <span class='hs-sel'>_active_ns_llvm_native</span><span class='hs-layout'>)</span> <span class='hs-varid'>store</span>
<a name="line-76"></a>  <span class='hs-varid'>registerRate</span>    <span class='hs-str'>"acc.load.llvm_ptx"</span>               <span class='hs-layout'>(</span><span class='hs-varid'>calculateProcessorLoad</span> <span class='hs-sel'>_active_ns_llvm_ptx</span><span class='hs-layout'>)</span>    <span class='hs-varid'>store</span>
<a name="line-77"></a>  <span class='hs-varid'>registerRate</span>    <span class='hs-str'>"acc.load.cuda"</span>                   <span class='hs-layout'>(</span><span class='hs-varid'>calculateProcessorLoad</span> <span class='hs-sel'>_active_ns_cuda</span><span class='hs-layout'>)</span>        <span class='hs-varid'>store</span>
<a name="line-78"></a>  <span class='hs-varid'>registerCounter</span> <span class='hs-str'>"acc.gc.bytes_allocated"</span>          <span class='hs-layout'>(</span><span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>read</span> <span class='hs-sel'>_bytesAllocated</span><span class='hs-layout'>)</span>                  <span class='hs-varid'>store</span>
<a name="line-79"></a>  <span class='hs-varid'>registerCounter</span> <span class='hs-str'>"acc.gc.bytes_copied_to_remote"</span>   <span class='hs-layout'>(</span><span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>read</span> <span class='hs-sel'>_bytesCopiedToRemote</span><span class='hs-layout'>)</span>             <span class='hs-varid'>store</span>
<a name="line-80"></a>  <span class='hs-varid'>registerCounter</span> <span class='hs-str'>"acc.gc.bytes_copied_from_remote"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>read</span> <span class='hs-sel'>_bytesCopiedFromRemote</span><span class='hs-layout'>)</span>           <span class='hs-varid'>store</span>
<a name="line-81"></a>  <span class='hs-varid'>registerGauge</span>   <span class='hs-str'>"acc.gc.current_bytes_active"</span>     <span class='hs-layout'>(</span><span class='hs-conid'>Gauge</span><span class='hs-varop'>.</span><span class='hs-varid'>read</span>   <span class='hs-sel'>_bytesActive</span><span class='hs-layout'>)</span>                     <span class='hs-varid'>store</span>
<a name="line-82"></a>  <span class='hs-varid'>registerGauge</span>   <span class='hs-str'>"acc.gc.current_bytes_nursery"</span>    <span class='hs-layout'>(</span><span class='hs-conid'>Gauge</span><span class='hs-varop'>.</span><span class='hs-varid'>read</span>   <span class='hs-sel'>_bytesNursery</span><span class='hs-layout'>)</span>                    <span class='hs-varid'>store</span>
<a name="line-83"></a>  <span class='hs-varid'>registerCounter</span> <span class='hs-str'>"acc.gc.num_gcs"</span>                  <span class='hs-layout'>(</span><span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>read</span> <span class='hs-sel'>_numMajorGC</span><span class='hs-layout'>)</span>                      <span class='hs-varid'>store</span>
<a name="line-84"></a>  <span class='hs-varid'>registerCounter</span> <span class='hs-str'>"acc.gc.num_lru_evict"</span>            <span class='hs-layout'>(</span><span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>read</span> <span class='hs-sel'>_numEvictions</span><span class='hs-layout'>)</span>                    <span class='hs-varid'>store</span>
<a name="line-85"></a>
<a name="line-86"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>store</span>
<a name="line-87"></a>
<a name="line-88"></a>
<a name="line-89"></a><a name="registerRate"></a><span class='hs-comment'>-- Abusing 'registerGroup' to perform the rate calculation on every wake-up.</span>
<a name="line-90"></a><span class='hs-comment'>--</span>
<a name="line-91"></a><span class='hs-definition'>registerRate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>EMAState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int64</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Store</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-92"></a><span class='hs-definition'>registerRate</span> <span class='hs-varid'>name</span> <span class='hs-varid'>sample</span> <span class='hs-varid'>store</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-93"></a>  <span class='hs-varid'>now</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-94"></a>  <span class='hs-varid'>st</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>ES</span> <span class='hs-varid'>now</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-95"></a>  <span class='hs-varid'>registerGroup</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>name</span> <span class='hs-conid'>Gauge</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>sample</span> <span class='hs-varid'>st</span><span class='hs-layout'>)</span> <span class='hs-varid'>store</span>
<a name="line-96"></a><span class='hs-cpp'>#endif</span>
<a name="line-97"></a>
<a name="line-98"></a>
<a name="line-99"></a><span class='hs-comment'>-- Recording metrics</span>
<a name="line-100"></a><span class='hs-comment'>-- -----------------</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="Processor"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Processor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Native</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PTX</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CUDA</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="withProcessor"></a><span class='hs-comment'>-- | Execute the given action and assign the elapsed wall-clock time as active</span>
<a name="line-105"></a><span class='hs-comment'>-- time for the given processing element.</span>
<a name="line-106"></a><span class='hs-comment'>--</span>
<a name="line-107"></a><span class='hs-comment'>{-# INLINE withProcessor #-}</span>
<a name="line-108"></a><span class='hs-definition'>withProcessor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Processor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-109"></a><span class='hs-cpp'>#ifndef ACCELERATE_MONITORING</span>
<a name="line-110"></a><span class='hs-definition'>withProcessor</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-111"></a><span class='hs-cpp'>#else</span>
<a name="line-112"></a><span class='hs-definition'>withProcessor</span> <span class='hs-conid'>Native</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withProcessor'</span> <span class='hs-sel'>_active_ns_llvm_native</span>
<a name="line-113"></a><span class='hs-definition'>withProcessor</span> <span class='hs-conid'>PTX</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withProcessor'</span> <span class='hs-sel'>_active_ns_llvm_ptx</span>
<a name="line-114"></a><span class='hs-definition'>withProcessor</span> <span class='hs-conid'>CUDA</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withProcessor'</span> <span class='hs-sel'>_active_ns_cuda</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="withProcessor'"></a><span class='hs-definition'>withProcessor'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Atomic</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-117"></a><span class='hs-definition'>withProcessor'</span> <span class='hs-varid'>var</span> <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-118"></a>  <span class='hs-varid'>wall0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-119"></a>  <span class='hs-varop'>!</span><span class='hs-varid'>r</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>action</span>
<a name="line-120"></a>  <span class='hs-varid'>wall1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-121"></a>  <span class='hs-varid'>addProcessorTime'</span> <span class='hs-varid'>var</span> <span class='hs-layout'>(</span><span class='hs-varid'>realToFrac</span> <span class='hs-layout'>(</span><span class='hs-varid'>diffUTCTime</span> <span class='hs-varid'>wall1</span> <span class='hs-varid'>wall0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-122"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-123"></a><span class='hs-cpp'>#endif</span>
<a name="line-124"></a>
<a name="line-125"></a><a name="addProcessorTime"></a><span class='hs-comment'>-- | Record the given number of seconds as active processing time for the given</span>
<a name="line-126"></a><span class='hs-comment'>-- processing element.</span>
<a name="line-127"></a><span class='hs-comment'>--</span>
<a name="line-128"></a><span class='hs-comment'>{-# INLINE addProcessorTime #-}</span>
<a name="line-129"></a><span class='hs-definition'>addProcessorTime</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Processor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Double</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-130"></a><span class='hs-cpp'>#ifndef ACCELERATE_MONITORING</span>
<a name="line-131"></a><span class='hs-definition'>addProcessorTime</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-132"></a><span class='hs-cpp'>#else</span>
<a name="line-133"></a><span class='hs-definition'>addProcessorTime</span> <span class='hs-conid'>Native</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addProcessorTime'</span> <span class='hs-sel'>_active_ns_llvm_native</span>
<a name="line-134"></a><span class='hs-definition'>addProcessorTime</span> <span class='hs-conid'>PTX</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addProcessorTime'</span> <span class='hs-sel'>_active_ns_llvm_ptx</span>
<a name="line-135"></a><span class='hs-definition'>addProcessorTime</span> <span class='hs-conid'>CUDA</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addProcessorTime'</span> <span class='hs-sel'>_active_ns_cuda</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="addProcessorTime'"></a><span class='hs-definition'>addProcessorTime'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Atomic</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Double</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-138"></a><span class='hs-definition'>addProcessorTime'</span> <span class='hs-varid'>var</span> <span class='hs-varid'>secs</span> <span class='hs-keyglyph'>=</span>
<a name="line-139"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ns</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>round</span> <span class='hs-layout'>(</span><span class='hs-varid'>secs</span> <span class='hs-varop'>*</span> <span class='hs-num'>1.0E9</span><span class='hs-layout'>)</span>
<a name="line-140"></a>  <span class='hs-keyword'>in</span>  <span class='hs-varid'>void</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Atomic</span><span class='hs-varop'>.</span><span class='hs-varid'>add</span> <span class='hs-varid'>var</span> <span class='hs-varid'>ns</span>
<a name="line-141"></a><span class='hs-cpp'>#endif</span>
<a name="line-142"></a>
<a name="line-143"></a>
<a name="line-144"></a><a name="didAllocateBytes"></a><span class='hs-definition'>didAllocateBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int64</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-145"></a><a name="didEvictLRU"></a><span class='hs-definition'>didEvictLRU</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-146"></a><a name="didMajorGC"></a><span class='hs-definition'>didMajorGC</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-147"></a>
<a name="line-148"></a><span class='hs-cpp'>#ifndef ACCELERATE_MONITORING</span>
<a name="line-149"></a><span class='hs-definition'>didAllocateBytes</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-150"></a><span class='hs-definition'>didEvictLRU</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-151"></a><span class='hs-definition'>didMajorGC</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-152"></a><span class='hs-cpp'>#else</span>
<a name="line-153"></a><span class='hs-definition'>didAllocateBytes</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-154"></a>  <span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>add</span> <span class='hs-sel'>_bytesAllocated</span> <span class='hs-varid'>n</span>
<a name="line-155"></a>  <span class='hs-conid'>Gauge</span><span class='hs-varop'>.</span><span class='hs-varid'>add</span>   <span class='hs-sel'>_bytesActive</span>    <span class='hs-varid'>n</span>
<a name="line-156"></a>
<a name="line-157"></a><span class='hs-definition'>didEvictLRU</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>inc</span> <span class='hs-sel'>_numEvictions</span>
<a name="line-158"></a>
<a name="line-159"></a><span class='hs-definition'>didMajorGC</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-160"></a>  <span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>inc</span> <span class='hs-sel'>_numMajorGC</span>
<a name="line-161"></a>  <span class='hs-conid'>Gauge</span><span class='hs-varop'>.</span><span class='hs-varid'>set</span>   <span class='hs-sel'>_bytesNursery</span> <span class='hs-num'>0</span>    <span class='hs-comment'>-- ???</span>
<a name="line-162"></a><span class='hs-cpp'>#endif</span>
<a name="line-163"></a>
<a name="line-164"></a>
<a name="line-165"></a><span class='hs-comment'>-- Implementation</span>
<a name="line-166"></a><span class='hs-comment'>-- --------------</span>
<a name="line-167"></a>
<a name="line-168"></a><span class='hs-cpp'>#ifdef ACCELERATE_MONITORING</span>
<a name="line-169"></a>
<a name="line-170"></a><a name="EMAState"></a><span class='hs-comment'>-- In order to calculate the processor load we need to remember the previous</span>
<a name="line-171"></a><a name="EMAState"></a><span class='hs-comment'>-- values. Storing this state in an IORef has a bit of extra overhead (as</span>
<a name="line-172"></a><a name="EMAState"></a><span class='hs-comment'>-- indirection) compared to the rest of the monitoring counters (which are</span>
<a name="line-173"></a><a name="EMAState"></a><span class='hs-comment'>-- unboxed values on the heap manipulated directly with atomic primops), but</span>
<a name="line-174"></a><a name="EMAState"></a><span class='hs-comment'>-- since 'calculateProcessorLoad' will only be called by the EKG monitor</span>
<a name="line-175"></a><a name="EMAState"></a><span class='hs-comment'>-- whenever it refreshes the value for display, rather than running continuously</span>
<a name="line-176"></a><a name="EMAState"></a><span class='hs-comment'>-- in the background, we should be okay.</span>
<a name="line-177"></a><a name="EMAState"></a><span class='hs-comment'>--</span>
<a name="line-178"></a><a name="EMAState"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EMAState</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ES</span>
<a name="line-179"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>old_time</span>  <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>UTCTime</span>
<a name="line-180"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>old_inst</span>  <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Double</span>
<a name="line-181"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>old_avg</span>   <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Double</span>
<a name="line-182"></a>  <span class='hs-layout'>}</span>
<a name="line-183"></a>
<a name="line-184"></a><a name="calculateProcessorLoad"></a><span class='hs-comment'>-- Estimate the load on the processor as a moving exponential average</span>
<a name="line-185"></a><span class='hs-comment'>--</span>
<a name="line-186"></a><span class='hs-definition'>calculateProcessorLoad</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Atomic</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>EMAState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int64</span>
<a name="line-187"></a><a name="!"></a><span class='hs-definition'>calculateProcessorLoad</span> <span class='hs-varop'>!</span><span class='hs-varid'>var</span> <span class='hs-varop'>!</span><span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-188"></a>  <span class='hs-conid'>ES</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>ref</span>
<a name="line-189"></a>  <span class='hs-varid'>time</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-190"></a>  <span class='hs-varid'>sample</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Atomic</span><span class='hs-varop'>.</span><span class='hs-varid'>and</span> <span class='hs-varid'>var</span> <span class='hs-num'>0</span>
<a name="line-191"></a>  <span class='hs-comment'>--</span>
<a name="line-192"></a>  <span class='hs-keyword'>let</span>
<a name="line-193"></a>      <span class='hs-varid'>active_ns</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>sample</span>
<a name="line-194"></a>      <span class='hs-varid'>elapsed_s</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realToFrac</span> <span class='hs-layout'>(</span><span class='hs-varid'>diffUTCTime</span> <span class='hs-varid'>time</span> <span class='hs-varid'>old_time</span><span class='hs-layout'>)</span>
<a name="line-195"></a>      <span class='hs-varid'>elapsed_ns</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>1.0E9</span> <span class='hs-varop'>*</span> <span class='hs-varid'>elapsed_s</span>
<a name="line-196"></a>      <span class='hs-comment'>--</span>
<a name="line-197"></a>      <span class='hs-varid'>load_inst</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>100</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>active_ns</span> <span class='hs-varop'>/</span> <span class='hs-varid'>elapsed_ns</span><span class='hs-layout'>)</span>                <span class='hs-comment'>-- instantaneous load</span>
<a name="line-198"></a>      <span class='hs-varid'>load_avg</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ema</span> <span class='hs-num'>0.2</span> <span class='hs-varid'>elapsed_s</span> <span class='hs-varid'>old_avg</span> <span class='hs-varid'>old_inst</span> <span class='hs-varid'>load_inst</span>  <span class='hs-comment'>-- moving average load</span>
<a name="line-199"></a>  <span class='hs-comment'>--</span>
<a name="line-200"></a>  <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>ES</span> <span class='hs-varid'>time</span> <span class='hs-varid'>load_inst</span> <span class='hs-varid'>load_avg</span><span class='hs-layout'>)</span>
<a name="line-201"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>round</span> <span class='hs-varid'>load_avg</span><span class='hs-layout'>)</span>
<a name="line-202"></a>
<a name="line-203"></a>
<a name="line-204"></a><span class='hs-comment'>{--
<a name="line-205"></a>-- Compute the current load on a processor as a percentage of time spent working
<a name="line-206"></a>-- over the elapsed time. This is meant to run continuously by a background
<a name="line-207"></a>-- thread, updating the gauge each time it wakes up.
<a name="line-208"></a>--
<a name="line-209"></a>monitorProcessorLoad :: Gauge -&gt; Atomic -&gt; UTCTime -&gt; Double -&gt; Double -&gt; IO ()
<a name="line-210"></a>monitorProcessorLoad !gauge !var !old_time !old_inst !old_avg = do
<a name="line-211"></a>  time   &lt;- getCurrentTime
<a name="line-212"></a>  sample &lt;- Atomic.and var 0
<a name="line-213"></a>
<a name="line-214"></a>  let
<a name="line-215"></a>      active_ns   = fromIntegral sample
<a name="line-216"></a>      elapsed_s   = realToFrac (diffUTCTime time old_time)
<a name="line-217"></a>      elapsed_ns  = 1.0E9 * elapsed_s
<a name="line-218"></a>
<a name="line-219"></a>      load_inst   = 100 * (active_ns / elapsed_ns)                -- instantaneous load
<a name="line-220"></a>      load_avg    = ema 0.2 elapsed_s old_avg old_inst load_inst  -- moving average load
<a name="line-221"></a>
<a name="line-222"></a>  -- Set what we thing the processor load over the previous interval should be
<a name="line-223"></a>  Gauge.set gauge (round load_avg)
<a name="line-224"></a>
<a name="line-225"></a>  -- Sleep for a bit, then do it all again
<a name="line-226"></a>  threadDelay 500000    -- 500 ms
<a name="line-227"></a>  monitorProcessorLoad gauge var time load_inst load_avg
<a name="line-228"></a>--}</span>
<a name="line-229"></a>
<a name="line-230"></a><a name="ema"></a><span class='hs-comment'>-- Exponential moving average for irregular time series</span>
<a name="line-231"></a><span class='hs-comment'>--</span>
<a name="line-232"></a><span class='hs-definition'>ema</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Double</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Double</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Double</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Double</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Double</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Double</span>
<a name="line-233"></a><span class='hs-definition'>ema</span> <span class='hs-varop'>!</span><span class='hs-varid'>alpha</span> <span class='hs-varop'>!</span><span class='hs-varid'>dt</span> <span class='hs-varop'>!</span><span class='hs-varid'>old_ema</span> <span class='hs-varop'>!</span><span class='hs-varid'>old_sample</span> <span class='hs-varop'>!</span><span class='hs-varid'>new_sample</span> <span class='hs-keyglyph'>=</span>
<a name="line-234"></a>  <span class='hs-keyword'>let</span>
<a name="line-235"></a>      <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dt</span> <span class='hs-varop'>/</span> <span class='hs-varid'>alpha</span>
<a name="line-236"></a>      <span class='hs-varid'>u</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span> <span class='hs-layout'>(</span> <span class='hs-comment'>-</span><span class='hs-varid'>a</span> <span class='hs-layout'>)</span>
<a name="line-237"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-num'>1</span> <span class='hs-comment'>-</span> <span class='hs-varid'>u</span> <span class='hs-layout'>)</span> <span class='hs-varop'>/</span> <span class='hs-varid'>a</span>
<a name="line-238"></a>  <span class='hs-keyword'>in</span>
<a name="line-239"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>u</span> <span class='hs-varop'>*</span> <span class='hs-varid'>old_ema</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-comment'>-</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>old_sample</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-comment'>-</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>new_sample</span><span class='hs-layout'>)</span>
<a name="line-240"></a>
<a name="line-241"></a>
<a name="line-242"></a><span class='hs-comment'>-- Monitoring variables</span>
<a name="line-243"></a><span class='hs-comment'>-- --------------------</span>
<a name="line-244"></a>
<a name="line-245"></a><span class='hs-comment'>-- Number of nanoseconds a backend has spent doing real work since the last</span>
<a name="line-246"></a><span class='hs-comment'>-- check. This is an integer amount because there are no built-in functions for</span>
<a name="line-247"></a><span class='hs-comment'>-- atomic memory access on double precision (as specified by the Intel docs).</span>
<a name="line-248"></a><span class='hs-comment'>--</span>
<a name="line-249"></a><span class='hs-comment'>{-# NOINLINE _active_ns_llvm_native #-}</span>
<a name="line-250"></a><span class='hs-sel'>_active_ns_llvm_native</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Atomic</span>
<a name="line-251"></a><span class='hs-sel'>_active_ns_llvm_native</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Atomic</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-252"></a>
<a name="line-253"></a><span class='hs-comment'>{-# NOINLINE _active_ns_llvm_ptx #-}</span>
<a name="line-254"></a><span class='hs-sel'>_active_ns_llvm_ptx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Atomic</span>
<a name="line-255"></a><span class='hs-sel'>_active_ns_llvm_ptx</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Atomic</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-256"></a>
<a name="line-257"></a><span class='hs-comment'>{-# NOINLINE _active_ns_cuda #-}</span>
<a name="line-258"></a><span class='hs-sel'>_active_ns_cuda</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Atomic</span>
<a name="line-259"></a><span class='hs-sel'>_active_ns_cuda</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Atomic</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-260"></a>
<a name="line-261"></a><span class='hs-comment'>-- Total number of bytes allocated in the remote address space (e.g. on the GPU)</span>
<a name="line-262"></a><span class='hs-comment'>--</span>
<a name="line-263"></a><span class='hs-comment'>{-# NOINLINE _bytesAllocated #-}</span>
<a name="line-264"></a><span class='hs-sel'>_bytesAllocated</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Counter</span>
<a name="line-265"></a><span class='hs-sel'>_bytesAllocated</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span>
<a name="line-266"></a>
<a name="line-267"></a><span class='hs-comment'>-- Total number of bytes copied from the host to the remote memory space</span>
<a name="line-268"></a><span class='hs-comment'>--</span>
<a name="line-269"></a><span class='hs-comment'>{-# NOINLINE _bytesCopiedToRemote #-}</span>
<a name="line-270"></a><span class='hs-sel'>_bytesCopiedToRemote</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Counter</span>
<a name="line-271"></a><span class='hs-sel'>_bytesCopiedToRemote</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span>
<a name="line-272"></a>
<a name="line-273"></a><span class='hs-comment'>-- Total number of bytes copied from the remote memory space back to the device</span>
<a name="line-274"></a><span class='hs-comment'>--</span>
<a name="line-275"></a><span class='hs-comment'>{-# NOINLINE _bytesCopiedFromRemote #-}</span>
<a name="line-276"></a><span class='hs-sel'>_bytesCopiedFromRemote</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Counter</span>
<a name="line-277"></a><span class='hs-sel'>_bytesCopiedFromRemote</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span>
<a name="line-278"></a>
<a name="line-279"></a><span class='hs-comment'>-- Current working remote memory size</span>
<a name="line-280"></a><span class='hs-comment'>--</span>
<a name="line-281"></a><span class='hs-comment'>{-# NOINLINE _bytesActive #-}</span>
<a name="line-282"></a><span class='hs-sel'>_bytesActive</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Gauge</span>
<a name="line-283"></a><span class='hs-sel'>_bytesActive</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-conid'>Gauge</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span>
<a name="line-284"></a>
<a name="line-285"></a><span class='hs-comment'>-- Current size of the nursery</span>
<a name="line-286"></a><span class='hs-comment'>--</span>
<a name="line-287"></a><span class='hs-comment'>{-# NOINLINE _bytesNursery #-}</span>
<a name="line-288"></a><span class='hs-sel'>_bytesNursery</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Gauge</span>
<a name="line-289"></a><span class='hs-sel'>_bytesNursery</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-conid'>Gauge</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span>
<a name="line-290"></a>
<a name="line-291"></a><span class='hs-comment'>-- Number of times the nursery was flushed</span>
<a name="line-292"></a><span class='hs-comment'>--</span>
<a name="line-293"></a><span class='hs-comment'>{-# NOINLINE _numMajorGC #-}</span>
<a name="line-294"></a><span class='hs-sel'>_numMajorGC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Counter</span>
<a name="line-295"></a><span class='hs-sel'>_numMajorGC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span>
<a name="line-296"></a>
<a name="line-297"></a><span class='hs-comment'>-- number of LRU eviction events</span>
<a name="line-298"></a><span class='hs-comment'>--</span>
<a name="line-299"></a><span class='hs-comment'>{-# NOINLINE _numEvictions #-}</span>
<a name="line-300"></a><span class='hs-sel'>_numEvictions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Counter</span>
<a name="line-301"></a><span class='hs-sel'>_numEvictions</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-conid'>Counter</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span>
<a name="line-302"></a>
<a name="line-303"></a><span class='hs-cpp'>#endif</span>
<a name="line-304"></a>
</pre></body>
</html>
