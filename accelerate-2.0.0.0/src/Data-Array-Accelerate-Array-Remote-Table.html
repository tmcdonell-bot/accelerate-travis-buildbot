<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Data/Array/Accelerate/Array/Remote/Table.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns               #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE CPP                        #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE ConstraintKinds            #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE GADTs                      #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE MagicHash                  #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE PatternGuards              #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE RankNTypes                 #-}</span>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables        #-}</span>
<a name="line-10"></a><span class='hs-comment'>{-# LANGUAGE TemplateHaskell            #-}</span>
<a name="line-11"></a><span class='hs-comment'>{-# LANGUAGE UnboxedTuples              #-}</span>
<a name="line-12"></a><span class='hs-comment'>{-# LANGUAGE ViewPatterns               #-}</span>
<a name="line-13"></a><span class='hs-comment'>{-# OPTIONS_HADDOCK hide #-}</span>
<a name="line-14"></a><span class='hs-comment'>-- |</span>
<a name="line-15"></a><span class='hs-comment'>-- Module      : Data.Array.Accelerate.Array.Remote.Table</span>
<a name="line-16"></a><span class='hs-comment'>-- Copyright   : [2008..2016] Manuel M T Chakravarty, Gabriele Keller</span>
<a name="line-17"></a><span class='hs-comment'>--               [2009..2016] Trevor L. McDonell</span>
<a name="line-18"></a><span class='hs-comment'>-- License     : BSD3</span>
<a name="line-19"></a><span class='hs-comment'>--</span>
<a name="line-20"></a><span class='hs-comment'>-- Maintainer  : Robert Clifton-Everest &lt;tmcdonell@cse.unsw.edu.au&gt;</span>
<a name="line-21"></a><span class='hs-comment'>-- Stability   : experimental</span>
<a name="line-22"></a><span class='hs-comment'>-- Portability : non-portable (GHC extensions)</span>
<a name="line-23"></a><span class='hs-comment'>--</span>
<a name="line-24"></a><span class='hs-comment'>-- Accelerate backends often need to copy arrays to a remote memory before they</span>
<a name="line-25"></a><span class='hs-comment'>-- can be used in computation. This module provides an automated method for</span>
<a name="line-26"></a><span class='hs-comment'>-- doing so. Keeping track of arrays in a `MemoryTable` ensures that any memory</span>
<a name="line-27"></a><span class='hs-comment'>-- allocated for them will be freed when GHC's garbage collector collects the</span>
<a name="line-28"></a><span class='hs-comment'>-- host array.</span>
<a name="line-29"></a><span class='hs-comment'>--</span>
<a name="line-30"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Remote</span><span class='hs-varop'>.</span><span class='hs-conid'>Table</span> <span class='hs-layout'>(</span>
<a name="line-31"></a>
<a name="line-32"></a>  <span class='hs-comment'>-- Tables for host/device memory associations</span>
<a name="line-33"></a>  <span class='hs-conid'>MemoryTable</span><span class='hs-layout'>,</span> <span class='hs-varid'>new</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookup</span><span class='hs-layout'>,</span> <span class='hs-varid'>malloc</span><span class='hs-layout'>,</span> <span class='hs-varid'>free</span><span class='hs-layout'>,</span> <span class='hs-varid'>freeStable</span><span class='hs-layout'>,</span> <span class='hs-varid'>insertUnmanaged</span><span class='hs-layout'>,</span> <span class='hs-varid'>reclaim</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>  <span class='hs-comment'>-- Internals</span>
<a name="line-36"></a>  <span class='hs-conid'>StableArray</span><span class='hs-layout'>,</span> <span class='hs-varid'>makeStableArray</span><span class='hs-layout'>,</span>
<a name="line-37"></a>  <span class='hs-varid'>makeWeakArrayData</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span>                                       <span class='hs-layout'>(</span> <span class='hs-varid'>yield</span> <span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span><span class='hs-varop'>.</span><span class='hs-conid'>MVar</span>                                  <span class='hs-layout'>(</span> <span class='hs-conid'>MVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>withMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWeakMVar</span> <span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span><span class='hs-varop'>.</span><span class='hs-conid'>Unique</span>                                <span class='hs-layout'>(</span> <span class='hs-conid'>Unique</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>                                   <span class='hs-layout'>(</span> <span class='hs-conid'>MonadIO</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Functor</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Hashable</span>                                            <span class='hs-layout'>(</span> <span class='hs-varid'>hash</span><span class='hs-layout'>,</span> <span class='hs-conid'>Hashable</span> <span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>                                               <span class='hs-layout'>(</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Proxy</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span>                                            <span class='hs-layout'>(</span> <span class='hs-conid'>Typeable</span><span class='hs-layout'>,</span> <span class='hs-varid'>gcast</span> <span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Word</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>Storable</span>                                         <span class='hs-layout'>(</span> <span class='hs-varid'>sizeOf</span> <span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Mem</span>                                               <span class='hs-layout'>(</span> <span class='hs-varid'>performGC</span> <span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Mem</span><span class='hs-varop'>.</span><span class='hs-conid'>Weak</span>                                          <span class='hs-layout'>(</span> <span class='hs-conid'>Weak</span><span class='hs-layout'>,</span> <span class='hs-varid'>deRefWeak</span> <span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span>                                                  <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>lookup</span><span class='hs-layout'>,</span> <span class='hs-varid'>id</span> <span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>HashTable</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span>                              <span class='hs-keyword'>as</span> <span class='hs-conid'>HT</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Exts</span>                                                 <span class='hs-layout'>(</span> <span class='hs-conid'>Ptr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Error</span>                              <span class='hs-layout'>(</span> <span class='hs-varid'>internalError</span> <span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Unique</span>                       <span class='hs-layout'>(</span> <span class='hs-conid'>UniqueArray</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>                         <span class='hs-layout'>(</span> <span class='hs-conid'>ArrayData</span><span class='hs-layout'>,</span> <span class='hs-conid'>GArrayData</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-62"></a>                                                                  <span class='hs-conid'>ArrayPtrs</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArrayElt</span><span class='hs-layout'>,</span> <span class='hs-varid'>arrayElt</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArrayEltR</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Remote</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Remote</span><span class='hs-varop'>.</span><span class='hs-conid'>Nursery</span>               <span class='hs-layout'>(</span> <span class='hs-conid'>Nursery</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Lifetime</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Remote</span><span class='hs-varop'>.</span><span class='hs-conid'>Nursery</span>     <span class='hs-keyword'>as</span> <span class='hs-conid'>N</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>Accelerate</span><span class='hs-varop'>.</span><span class='hs-conid'>Debug</span>                    <span class='hs-keyword'>as</span> <span class='hs-conid'>D</span>
<a name="line-68"></a>
<a name="line-69"></a>
<a name="line-70"></a><a name="HashTable"></a><span class='hs-comment'>-- We use an MVar to the hash table, so that several threads may safely access</span>
<a name="line-71"></a><a name="HashTable"></a><span class='hs-comment'>-- it concurrently. This includes the finalisation threads that remove entries</span>
<a name="line-72"></a><a name="HashTable"></a><span class='hs-comment'>-- from the table.</span>
<a name="line-73"></a><a name="HashTable"></a><span class='hs-comment'>--</span>
<a name="line-74"></a><a name="HashTable"></a><span class='hs-comment'>-- It is important that we can garbage collect old entries from the table when</span>
<a name="line-75"></a><a name="HashTable"></a><span class='hs-comment'>-- the key is no longer reachable in the heap. Hence the value part of each</span>
<a name="line-76"></a><a name="HashTable"></a><span class='hs-comment'>-- table entry is a (Weak val), where the stable name 'key' is the key for the</span>
<a name="line-77"></a><a name="HashTable"></a><span class='hs-comment'>-- memo table, and the 'val' is the value of this table entry. When the key</span>
<a name="line-78"></a><a name="HashTable"></a><span class='hs-comment'>-- becomes unreachable, a finaliser will fire and remove this entry from the</span>
<a name="line-79"></a><a name="HashTable"></a><span class='hs-comment'>-- hash buckets, and further attempts to dereference the weak pointer will</span>
<a name="line-80"></a><a name="HashTable"></a><span class='hs-comment'>-- return Nothing. References from 'val' to the key are ignored (see the</span>
<a name="line-81"></a><a name="HashTable"></a><span class='hs-comment'>-- semantics of weak pointers in the documentation).</span>
<a name="line-82"></a><a name="HashTable"></a><span class='hs-comment'>--</span>
<a name="line-83"></a><a name="HashTable"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>HashTable</span> <span class='hs-varid'>key</span> <span class='hs-varid'>val</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HT</span><span class='hs-varop'>.</span><span class='hs-conid'>BasicHashTable</span> <span class='hs-varid'>key</span> <span class='hs-varid'>val</span>
<a name="line-84"></a><a name="MT"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MT</span> <span class='hs-varid'>p</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MVar</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HashTable</span> <span class='hs-conid'>StableArray</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemoteArray</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-85"></a><a name="MemoryTable"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-varid'>p</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>MT</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-86"></a>                                      <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Weak</span> <span class='hs-layout'>(</span><span class='hs-conid'>MT</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-87"></a>                                      <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Nursery</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-88"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>RemoteArray</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>where</span>
<a name="line-91"></a>  <span class='hs-conid'>RemoteArray</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>e</span>
<a name="line-92"></a>              <span class='hs-keyglyph'>=&gt;</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Weak</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Keep track of host array liveness.</span>
<a name="line-93"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-varid'>e</span>                       <span class='hs-comment'>-- The actual remote pointer</span>
<a name="line-94"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>                       <span class='hs-comment'>-- The array size in bytes</span>
<a name="line-95"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RemoteArray</span> <span class='hs-varid'>p</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="StableArray"></a><span class='hs-comment'>-- | An untyped reference to an array, similar to a StableName.</span>
<a name="line-98"></a><a name="StableArray"></a><span class='hs-comment'>--</span>
<a name="line-99"></a><a name="StableArray"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>StableArray</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StableArray</span> <span class='hs-conid'>Unique</span>
<a name="line-100"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Hashable</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="instance%20Show%20StableArray"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>StableArray</span> <span class='hs-keyword'>where</span>
<a name="line-103"></a>  <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>StableArray</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>hash</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="new"></a><span class='hs-comment'>-- |Create a new memory table from host to remote arrays.</span>
<a name="line-106"></a><span class='hs-comment'>--</span>
<a name="line-107"></a><span class='hs-comment'>-- The function supplied should be the `free` for the remote pointers being</span>
<a name="line-108"></a><span class='hs-comment'>-- stored. This function will be called by the GC, which typically runs on a</span>
<a name="line-109"></a><span class='hs-comment'>-- different thread. Unlike the `free` in `RemoteMemory`, this function cannot</span>
<a name="line-110"></a><span class='hs-comment'>-- depend on any state.</span>
<a name="line-111"></a><span class='hs-comment'>--</span>
<a name="line-112"></a><span class='hs-definition'>new</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-varid'>ptr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>MemoryTable</span> <span class='hs-varid'>ptr</span><span class='hs-layout'>)</span>
<a name="line-113"></a><span class='hs-definition'>new</span> <span class='hs-varid'>release</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-114"></a>  <span class='hs-varid'>message</span> <span class='hs-str'>"initialise memory table"</span>
<a name="line-115"></a>  <span class='hs-varid'>tbl</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>HT</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span>
<a name="line-116"></a>  <span class='hs-varid'>ref</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMVar</span> <span class='hs-varid'>tbl</span>
<a name="line-117"></a>  <span class='hs-varid'>nrs</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>N</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span> <span class='hs-varid'>release</span>
<a name="line-118"></a>  <span class='hs-varid'>weak</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkWeakMVar</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-119"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>weak</span> <span class='hs-varid'>nrs</span> <span class='hs-varid'>release</span>
<a name="line-120"></a>
<a name="line-121"></a>
<a name="line-122"></a><a name="lookup"></a><span class='hs-comment'>-- | Look for the remote pointer corresponding to a given host-side array.</span>
<a name="line-123"></a><span class='hs-comment'>--</span>
<a name="line-124"></a><span class='hs-definition'>lookup</span>
<a name="line-125"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimElt</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-126"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-varid'>p</span>
<a name="line-127"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArrayData</span> <span class='hs-varid'>a</span>
<a name="line-128"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-129"></a><span class='hs-definition'>lookup</span> <span class='hs-layout'>(</span><span class='hs-conid'>MemoryTable</span> <span class='hs-varop'>!</span><span class='hs-varid'>ref</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span><span class='hs-varid'>arr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-130"></a>  <span class='hs-varid'>sa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeStableArray</span> <span class='hs-varid'>arr</span>
<a name="line-131"></a>  <span class='hs-varid'>mw</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withMVar</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varop'>`</span><span class='hs-conid'>HT</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span><span class='hs-varop'>`</span> <span class='hs-varid'>sa</span><span class='hs-layout'>)</span>
<a name="line-132"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>mw</span> <span class='hs-keyword'>of</span>
<a name="line-133"></a>    <span class='hs-conid'>Nothing</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>trace</span> <span class='hs-layout'>(</span><span class='hs-str'>"lookup/not found: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>sa</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-134"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemoteArray</span> <span class='hs-varid'>w</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-135"></a>      <span class='hs-varid'>mv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deRefWeak</span> <span class='hs-varid'>w</span>
<a name="line-136"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>mv</span> <span class='hs-keyword'>of</span>
<a name="line-137"></a>        <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gcast</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>trace</span> <span class='hs-layout'>(</span><span class='hs-str'>"lookup/found: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>sa</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>p'</span><span class='hs-layout'>)</span>
<a name="line-138"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varop'>$</span><span class='hs-varid'>internalError</span> <span class='hs-str'>"lookup"</span> <span class='hs-varop'>$</span> <span class='hs-str'>"type mismatch"</span>
<a name="line-139"></a>
<a name="line-140"></a>        <span class='hs-comment'>-- Note: [Weak pointer weirdness]</span>
<a name="line-141"></a>        <span class='hs-comment'>--</span>
<a name="line-142"></a>        <span class='hs-comment'>-- After the lookup is successful, there might conceivably be no further</span>
<a name="line-143"></a>        <span class='hs-comment'>-- references to 'arr'. If that is so, and a garbage collection</span>
<a name="line-144"></a>        <span class='hs-comment'>-- intervenes, the weak pointer might get tombstoned before 'deRefWeak'</span>
<a name="line-145"></a>        <span class='hs-comment'>-- gets to it. In that case we throw an error (below). However, because</span>
<a name="line-146"></a>        <span class='hs-comment'>-- we have used 'arr' in the continuation, this ensures that 'arr' is</span>
<a name="line-147"></a>        <span class='hs-comment'>-- reachable in the continuation of 'deRefWeak' and thus 'deRefWeak'</span>
<a name="line-148"></a>        <span class='hs-comment'>-- always succeeds. This sort of weirdness, typical of the world of weak</span>
<a name="line-149"></a>        <span class='hs-comment'>-- pointers, is why we can not reuse the stable name 'sa' computed</span>
<a name="line-150"></a>        <span class='hs-comment'>-- above in the error message.</span>
<a name="line-151"></a>        <span class='hs-comment'>--</span>
<a name="line-152"></a>        <span class='hs-conid'>Nothing</span>                     <span class='hs-keyglyph'>-&gt;</span>
<a name="line-153"></a>          <span class='hs-varid'>makeStableArray</span> <span class='hs-varid'>arr</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varop'>$</span><span class='hs-varid'>internalError</span> <span class='hs-str'>"lookup"</span> <span class='hs-varop'>$</span> <span class='hs-str'>"dead weak pair: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>x</span>
<a name="line-154"></a>
<a name="line-155"></a>
<a name="line-156"></a><a name="malloc"></a><span class='hs-comment'>-- | Allocate a new device array to be associated with the given host-side array.</span>
<a name="line-157"></a><span class='hs-comment'>-- This may not always use the `malloc` provided by the `RemoteMemory` instance.</span>
<a name="line-158"></a><span class='hs-comment'>-- In order to reduce the number of raw allocations, previously allocated remote</span>
<a name="line-159"></a><span class='hs-comment'>-- arrays will be re-used. In the event that the remote memory is exhausted,</span>
<a name="line-160"></a><span class='hs-comment'>-- 'Nothing' is returned.</span>
<a name="line-161"></a><span class='hs-comment'>--</span>
<a name="line-162"></a><span class='hs-definition'>malloc</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>m</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimElt</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>RemoteMemory</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-163"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemotePtr</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-164"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArrayData</span> <span class='hs-varid'>a</span>
<a name="line-165"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-166"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemotePtr</span> <span class='hs-varid'>m</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-167"></a><span class='hs-definition'>malloc</span> <span class='hs-varid'>mt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MemoryTable</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varop'>!</span><span class='hs-varid'>nursery</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span><span class='hs-varid'>ad</span> <span class='hs-varop'>!</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-168"></a>  <span class='hs-comment'>-- Note: [Allocation sizes]</span>
<a name="line-169"></a>  <span class='hs-comment'>--</span>
<a name="line-170"></a>  <span class='hs-comment'>-- Instead of allocating the exact number of elements requested, we round up to</span>
<a name="line-171"></a>  <span class='hs-comment'>-- a fixed chunk size as specified by RemoteMemory.remoteAllocationSize. This</span>
<a name="line-172"></a>  <span class='hs-comment'>-- means there is a greater chance the nursery will get a hit, and moreover</span>
<a name="line-173"></a>  <span class='hs-comment'>-- that we can search the nursery for an exact size.</span>
<a name="line-174"></a>  <span class='hs-comment'>--</span>
<a name="line-175"></a>  <span class='hs-varid'>chunk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>remoteAllocationSize</span>
<a name="line-176"></a>  <span class='hs-keyword'>let</span> <span class='hs-comment'>-- next highest multiple of f from x</span>
<a name="line-177"></a>      <span class='hs-varid'>multiple</span> <span class='hs-varid'>x</span> <span class='hs-varid'>f</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>`div`</span> <span class='hs-varid'>f</span>
<a name="line-178"></a>      <span class='hs-varid'>bytes</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chunk</span> <span class='hs-varop'>*</span> <span class='hs-varid'>multiple</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>*</span> <span class='hs-varid'>sizeOf</span> <span class='hs-layout'>(</span><span class='hs-varid'>undefined</span><span class='hs-keyglyph'>::</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>chunk</span>
<a name="line-179"></a>  <span class='hs-comment'>--</span>
<a name="line-180"></a>  <span class='hs-varid'>message</span> <span class='hs-layout'>(</span><span class='hs-str'>"malloc: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showBytes</span> <span class='hs-varid'>bytes</span><span class='hs-layout'>)</span>
<a name="line-181"></a>  <span class='hs-varid'>mp</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-182"></a>    <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>castRemotePtr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-183"></a>    <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>attempt</span> <span class='hs-str'>"malloc/nursery"</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>N</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>bytes</span> <span class='hs-varid'>nursery</span><span class='hs-layout'>)</span>
<a name="line-184"></a>        <span class='hs-varop'>`orElse`</span>
<a name="line-185"></a>        <span class='hs-varid'>attempt</span> <span class='hs-str'>"malloc/new"</span> <span class='hs-layout'>(</span><span class='hs-varid'>mallocRemote</span> <span class='hs-varid'>bytes</span><span class='hs-layout'>)</span>
<a name="line-186"></a>        <span class='hs-varop'>`orElse`</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>message</span> <span class='hs-str'>"malloc/remote-malloc-failed (cleaning)"</span>
<a name="line-187"></a>                    <span class='hs-varid'>clean</span> <span class='hs-varid'>mt</span>
<a name="line-188"></a>                    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>N</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>bytes</span> <span class='hs-varid'>nursery</span>
<a name="line-189"></a>        <span class='hs-varop'>`orElse`</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>message</span> <span class='hs-str'>"malloc/remote-malloc-failed (purging)"</span>
<a name="line-190"></a>                    <span class='hs-varid'>purge</span> <span class='hs-varid'>mt</span>
<a name="line-191"></a>                    <span class='hs-varid'>mallocRemote</span> <span class='hs-varid'>bytes</span>
<a name="line-192"></a>        <span class='hs-varop'>`orElse`</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>message</span> <span class='hs-str'>"malloc/remote-malloc-failed (non-recoverable)"</span>
<a name="line-193"></a>                    <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-194"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>mp</span> <span class='hs-keyword'>of</span>
<a name="line-195"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-196"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-197"></a>      <span class='hs-varid'>insert</span> <span class='hs-varid'>mt</span> <span class='hs-varid'>ad</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>bytes</span>
<a name="line-198"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>p'</span><span class='hs-layout'>)</span>
<a name="line-199"></a>
<a name="line-200"></a>  <span class='hs-keyword'>where</span>
<a name="line-201"></a>    <span class='hs-varid'>orElse</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-202"></a>    <span class='hs-varid'>orElse</span> <span class='hs-varid'>ra</span> <span class='hs-varid'>rb</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-203"></a>      <span class='hs-varid'>ma</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ra</span>
<a name="line-204"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>ma</span> <span class='hs-keyword'>of</span>
<a name="line-205"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rb</span>
<a name="line-206"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>a</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-207"></a>
<a name="line-208"></a>    <span class='hs-varid'>attempt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-209"></a>    <span class='hs-varid'>attempt</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>next</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-210"></a>      <span class='hs-varid'>ma</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>next</span>
<a name="line-211"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>ma</span> <span class='hs-keyword'>of</span>
<a name="line-212"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-213"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>a</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>trace</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-214"></a>
<a name="line-215"></a>
<a name="line-216"></a>
<a name="line-217"></a><a name="free"></a><span class='hs-comment'>-- | Deallocate the device array associated with the given host-side array.</span>
<a name="line-218"></a><span class='hs-comment'>-- Typically this should only be called in very specific circumstances.</span>
<a name="line-219"></a><span class='hs-comment'>--</span>
<a name="line-220"></a><span class='hs-definition'>free</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemoteMemory</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrimElt</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-221"></a>     <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>proxy</span> <span class='hs-varid'>m</span>
<a name="line-222"></a>     <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>MemoryTable</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemotePtr</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-223"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArrayData</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-224"></a><span class='hs-definition'>free</span> <span class='hs-varid'>proxy</span> <span class='hs-varid'>mt</span> <span class='hs-varop'>!</span><span class='hs-varid'>arr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-225"></a>  <span class='hs-varid'>sa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeStableArray</span> <span class='hs-varid'>arr</span>
<a name="line-226"></a>  <span class='hs-varid'>freeStable</span> <span class='hs-varid'>proxy</span> <span class='hs-varid'>mt</span> <span class='hs-varid'>sa</span>
<a name="line-227"></a>
<a name="line-228"></a>
<a name="line-229"></a><a name="freeStable"></a><span class='hs-comment'>-- | Deallocate the device array associated with the given StableArray. This</span>
<a name="line-230"></a><span class='hs-comment'>-- is useful for other memory managers built on top of the memory table.</span>
<a name="line-231"></a><span class='hs-comment'>--</span>
<a name="line-232"></a><span class='hs-definition'>freeStable</span>
<a name="line-233"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RemoteMemory</span> <span class='hs-varid'>m</span>
<a name="line-234"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>proxy</span> <span class='hs-varid'>m</span>
<a name="line-235"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemotePtr</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-236"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StableArray</span>
<a name="line-237"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-238"></a><span class='hs-definition'>freeStable</span> <span class='hs-varid'>proxy</span> <span class='hs-layout'>(</span><span class='hs-conid'>MemoryTable</span> <span class='hs-varop'>!</span><span class='hs-varid'>ref</span> <span class='hs-keyword'>_</span> <span class='hs-varop'>!</span><span class='hs-varid'>nrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span><span class='hs-varid'>sa</span> <span class='hs-keyglyph'>=</span>
<a name="line-239"></a>  <span class='hs-varid'>withMVar</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>mt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-240"></a>    <span class='hs-varid'>mw</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mt</span> <span class='hs-varop'>`</span><span class='hs-conid'>HT</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span><span class='hs-varop'>`</span> <span class='hs-varid'>sa</span>
<a name="line-241"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>mw</span> <span class='hs-keyword'>of</span>
<a name="line-242"></a>      <span class='hs-conid'>Nothing</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>message</span> <span class='hs-layout'>(</span><span class='hs-str'>"free/already-removed: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>sa</span><span class='hs-layout'>)</span>
<a name="line-243"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemoteArray</span> <span class='hs-keyword'>_</span> <span class='hs-varop'>!</span><span class='hs-varid'>p</span> <span class='hs-varop'>!</span><span class='hs-varid'>bytes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-244"></a>        <span class='hs-varid'>message</span> <span class='hs-layout'>(</span><span class='hs-str'>"free/evict: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>sa</span> <span class='hs-varop'>++</span> <span class='hs-str'>" of "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showBytes</span> <span class='hs-varid'>bytes</span><span class='hs-layout'>)</span>
<a name="line-245"></a>        <span class='hs-conid'>N</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>bytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>castRemotePtr</span> <span class='hs-varid'>proxy</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>nrs</span>
<a name="line-246"></a>        <span class='hs-varid'>mt</span> <span class='hs-varop'>`</span><span class='hs-conid'>HT</span><span class='hs-varop'>.</span><span class='hs-varid'>delete</span><span class='hs-varop'>`</span> <span class='hs-varid'>sa</span>
<a name="line-247"></a>
<a name="line-248"></a>
<a name="line-249"></a><a name="insert"></a><span class='hs-comment'>-- Record an association between a host-side array and a new device memory area.</span>
<a name="line-250"></a><span class='hs-comment'>-- The device memory will be freed when the host array is garbage collected.</span>
<a name="line-251"></a><span class='hs-comment'>--</span>
<a name="line-252"></a><span class='hs-definition'>insert</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimElt</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>RemoteMemory</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-253"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemotePtr</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-254"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArrayData</span> <span class='hs-varid'>a</span>
<a name="line-255"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RemotePtr</span> <span class='hs-varid'>m</span> <span class='hs-varid'>b</span>
<a name="line-256"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-257"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-258"></a><span class='hs-definition'>insert</span> <span class='hs-varid'>mt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MemoryTable</span> <span class='hs-varop'>!</span><span class='hs-varid'>ref</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span><span class='hs-varid'>arr</span> <span class='hs-varop'>!</span><span class='hs-varid'>ptr</span> <span class='hs-varop'>!</span><span class='hs-varid'>bytes</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-259"></a>  <span class='hs-varid'>key</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeStableArray</span>  <span class='hs-varid'>arr</span>
<a name="line-260"></a>  <span class='hs-varid'>weak</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>makeWeakArrayData</span> <span class='hs-varid'>arr</span> <span class='hs-conid'>()</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>freeStable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>mt</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span>
<a name="line-261"></a>  <span class='hs-varid'>message</span> <span class='hs-varop'>$</span> <span class='hs-str'>"insert: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span>
<a name="line-262"></a>  <span class='hs-varid'>liftIO</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>withMVar</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>tbl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HT</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>tbl</span> <span class='hs-varid'>key</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemoteArray</span> <span class='hs-varid'>weak</span> <span class='hs-varid'>ptr</span> <span class='hs-varid'>bytes</span><span class='hs-layout'>)</span>
<a name="line-263"></a>
<a name="line-264"></a>
<a name="line-265"></a><a name="insertUnmanaged"></a><span class='hs-comment'>-- |Record an association between a host-side array and a remote memory area</span>
<a name="line-266"></a><span class='hs-comment'>-- that was not allocated by accelerate. The remote memory will NOT be re-used</span>
<a name="line-267"></a><span class='hs-comment'>-- once the host-side array is garbage collected.</span>
<a name="line-268"></a><span class='hs-comment'>--</span>
<a name="line-269"></a><span class='hs-comment'>-- This typically only has use for backends that provide an FFI.</span>
<a name="line-270"></a><span class='hs-comment'>--</span>
<a name="line-271"></a><span class='hs-definition'>insertUnmanaged</span>
<a name="line-272"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimElt</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-273"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-varid'>p</span>
<a name="line-274"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArrayData</span> <span class='hs-varid'>a</span>
<a name="line-275"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-varid'>b</span>
<a name="line-276"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-277"></a><span class='hs-definition'>insertUnmanaged</span> <span class='hs-layout'>(</span><span class='hs-conid'>MemoryTable</span> <span class='hs-varop'>!</span><span class='hs-varid'>ref</span> <span class='hs-varop'>!</span><span class='hs-varid'>weak_ref</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span><span class='hs-varid'>arr</span> <span class='hs-varop'>!</span><span class='hs-varid'>ptr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-278"></a>  <span class='hs-varid'>key</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeStableArray</span>  <span class='hs-varid'>arr</span>
<a name="line-279"></a>  <span class='hs-varid'>weak</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>makeWeakArrayData</span> <span class='hs-varid'>arr</span> <span class='hs-conid'>()</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>remoteFinalizer</span> <span class='hs-varid'>weak_ref</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span>
<a name="line-280"></a>  <span class='hs-varid'>message</span> <span class='hs-varop'>$</span> <span class='hs-str'>"insertUnmanaged: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span>
<a name="line-281"></a>  <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withMVar</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>tbl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HT</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>tbl</span> <span class='hs-varid'>key</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemoteArray</span> <span class='hs-varid'>weak</span> <span class='hs-varid'>ptr</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-282"></a>
<a name="line-283"></a>
<a name="line-284"></a><span class='hs-comment'>-- Removing entries</span>
<a name="line-285"></a><span class='hs-comment'>-- ----------------</span>
<a name="line-286"></a>
<a name="line-287"></a><a name="clean"></a><span class='hs-comment'>-- |Initiate garbage collection and mark any arrays that no longer have host-side</span>
<a name="line-288"></a><span class='hs-comment'>-- equivalents as reusable.</span>
<a name="line-289"></a><span class='hs-comment'>--</span>
<a name="line-290"></a><span class='hs-definition'>clean</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>m</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemoteMemory</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemotePtr</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-291"></a><span class='hs-definition'>clean</span> <span class='hs-varid'>mt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MemoryTable</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>weak_ref</span> <span class='hs-varid'>nrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>management</span> <span class='hs-str'>"clean"</span> <span class='hs-varid'>nrs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-292"></a>  <span class='hs-comment'>-- Unfortunately there is no real way to force a GC then wait for it to</span>
<a name="line-293"></a>  <span class='hs-comment'>-- finish. Calling performGC then yielding works moderately well in</span>
<a name="line-294"></a>  <span class='hs-comment'>-- single-threaded cases, but tends to fall down otherwise. Either way, given</span>
<a name="line-295"></a>  <span class='hs-comment'>-- that finalizers are often significantly delayed, it is worth our while</span>
<a name="line-296"></a>  <span class='hs-comment'>-- traversing the table and explicitly freeing any dead entires.</span>
<a name="line-297"></a>  <span class='hs-comment'>--</span>
<a name="line-298"></a>  <span class='hs-varid'>performGC</span>
<a name="line-299"></a>  <span class='hs-varid'>yield</span>
<a name="line-300"></a>  <span class='hs-varid'>mr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deRefWeak</span> <span class='hs-varid'>weak_ref</span>
<a name="line-301"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>mr</span> <span class='hs-keyword'>of</span>
<a name="line-302"></a>    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-303"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-304"></a>      <span class='hs-varid'>rs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withMVar</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HT</span><span class='hs-varop'>.</span><span class='hs-varid'>foldM</span> <span class='hs-varid'>removable</span> <span class='hs-conid'>[]</span>  <span class='hs-comment'>-- collect arrays that can be removed</span>
<a name="line-305"></a>      <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>freeStable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>mt</span><span class='hs-layout'>)</span> <span class='hs-varid'>rs</span> <span class='hs-comment'>-- remove them all</span>
<a name="line-306"></a>  <span class='hs-keyword'>where</span>
<a name="line-307"></a>    <span class='hs-varid'>removable</span> <span class='hs-varid'>rs</span> <span class='hs-layout'>(</span><span class='hs-varid'>sa</span><span class='hs-layout'>,</span> <span class='hs-conid'>RemoteArray</span> <span class='hs-varid'>w</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-308"></a>      <span class='hs-varid'>alive</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isJust</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>deRefWeak</span> <span class='hs-varid'>w</span>
<a name="line-309"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>alive</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>rs</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sa</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span>
<a name="line-310"></a>
<a name="line-311"></a>
<a name="line-312"></a><a name="purge"></a><span class='hs-comment'>-- | Call `free` on all arrays that are not currently associated with host-side</span>
<a name="line-313"></a><span class='hs-comment'>-- arrays.</span>
<a name="line-314"></a><span class='hs-comment'>--</span>
<a name="line-315"></a><span class='hs-definition'>purge</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemoteMemory</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemotePtr</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-316"></a><span class='hs-definition'>purge</span> <span class='hs-layout'>(</span><span class='hs-conid'>MemoryTable</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>nursery</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Nursery</span> <span class='hs-varid'>nrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>release</span><span class='hs-layout'>)</span>
<a name="line-317"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>management</span> <span class='hs-str'>"purge"</span> <span class='hs-varid'>nursery</span>
<a name="line-318"></a>  <span class='hs-varop'>$</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>N</span><span class='hs-varop'>.</span><span class='hs-varid'>cleanup</span> <span class='hs-varid'>release</span> <span class='hs-varid'>nrs</span><span class='hs-layout'>)</span>
<a name="line-319"></a>
<a name="line-320"></a>
<a name="line-321"></a><a name="reclaim"></a><span class='hs-comment'>-- |Initiate garbage collection and `free` any remote arrays that no longer</span>
<a name="line-322"></a><span class='hs-comment'>-- have matching host-side equivalents.</span>
<a name="line-323"></a><span class='hs-comment'>--</span>
<a name="line-324"></a><span class='hs-definition'>reclaim</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>m</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemoteMemory</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MemoryTable</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemotePtr</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-325"></a><span class='hs-definition'>reclaim</span> <span class='hs-varid'>mt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>clean</span> <span class='hs-varid'>mt</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>purge</span> <span class='hs-varid'>mt</span>
<a name="line-326"></a>
<a name="line-327"></a><a name="remoteFinalizer"></a><span class='hs-definition'>remoteFinalizer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Weak</span> <span class='hs-layout'>(</span><span class='hs-conid'>MT</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StableArray</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-328"></a><a name="!"></a><span class='hs-definition'>remoteFinalizer</span> <span class='hs-varop'>!</span><span class='hs-varid'>weak_ref</span> <span class='hs-varop'>!</span><span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-329"></a>  <span class='hs-varid'>mr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deRefWeak</span> <span class='hs-varid'>weak_ref</span>
<a name="line-330"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>mr</span> <span class='hs-keyword'>of</span>
<a name="line-331"></a>    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>message</span> <span class='hs-layout'>(</span><span class='hs-str'>"finalise/dead table: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span>
<a name="line-332"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>trace</span>   <span class='hs-layout'>(</span><span class='hs-str'>"finalise: "</span>            <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withMVar</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varop'>`</span><span class='hs-conid'>HT</span><span class='hs-varop'>.</span><span class='hs-varid'>delete</span><span class='hs-varop'>`</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span>
<a name="line-333"></a>
<a name="line-334"></a>
<a name="line-335"></a><span class='hs-comment'>-- Miscellaneous</span>
<a name="line-336"></a><span class='hs-comment'>-- -------------</span>
<a name="line-337"></a>
<a name="line-338"></a><a name="makeStableArray"></a><span class='hs-comment'>-- | Make a new 'StableArray'.</span>
<a name="line-339"></a><span class='hs-comment'>--</span>
<a name="line-340"></a><span class='hs-comment'>{-# INLINE makeStableArray #-}</span>
<a name="line-341"></a><span class='hs-definition'>makeStableArray</span>
<a name="line-342"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArrayPtrs</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArrayElt</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-343"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ArrayData</span> <span class='hs-varid'>a</span>
<a name="line-344"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>StableArray</span>
<a name="line-345"></a><span class='hs-definition'>makeStableArray</span> <span class='hs-varop'>!</span><span class='hs-varid'>ad</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-conid'>StableArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span> <span class='hs-varid'>arrayElt</span> <span class='hs-varid'>ad</span><span class='hs-layout'>)</span>
<a name="line-346"></a>  <span class='hs-keyword'>where</span>
<a name="line-347"></a>    <span class='hs-varid'>id</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArrayEltR</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArrayData</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span>
<a name="line-348"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRint</span>     <span class='hs-layout'>(</span><span class='hs-conid'>AD_Int</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-349"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRint8</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AD_Int8</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-350"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRint16</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_Int16</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-351"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRint32</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_Int32</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-352"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRint64</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_Int64</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-353"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRword</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AD_Word</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-354"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRword8</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_Word8</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-355"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRword16</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_Word16</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-356"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRword32</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_Word32</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-357"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRword64</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_Word64</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-358"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcshort</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CShort</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-359"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcushort</span> <span class='hs-layout'>(</span><span class='hs-conid'>AD_CUShort</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-360"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcint</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AD_CInt</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-361"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcuint</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_CUInt</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-362"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRclong</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_CLong</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-363"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRculong</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CULong</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-364"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcllong</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CLLong</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-365"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcullong</span> <span class='hs-layout'>(</span><span class='hs-conid'>AD_CULLong</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-366"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRfloat</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_Float</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-367"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRdouble</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_Double</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-368"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcfloat</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CFloat</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-369"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcdouble</span> <span class='hs-layout'>(</span><span class='hs-conid'>AD_CDouble</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-370"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRbool</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AD_Bool</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-371"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRchar</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AD_Char</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-372"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcchar</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_CChar</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-373"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcschar</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CSChar</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-374"></a>    <span class='hs-varid'>id</span> <span class='hs-conid'>ArrayEltRcuchar</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CUChar</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqueArrayId</span> <span class='hs-varid'>ua</span>
<a name="line-375"></a>    <span class='hs-varid'>id</span> <span class='hs-keyword'>_</span>                <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"I do have a cause, though. It is obscenity. I'm for it."</span>
<a name="line-376"></a>
<a name="line-377"></a><span class='hs-comment'>-- Weak arrays</span>
<a name="line-378"></a><span class='hs-comment'>-- ----------------------</span>
<a name="line-379"></a>
<a name="line-380"></a><a name="makeWeakArrayData"></a><span class='hs-comment'>-- |Make a weak pointer using an array as a key. Unlike the standard `mkWeak`,</span>
<a name="line-381"></a><span class='hs-comment'>-- this guarantees finalisers won't fire early.</span>
<a name="line-382"></a><span class='hs-comment'>--</span>
<a name="line-383"></a><span class='hs-definition'>makeWeakArrayData</span>
<a name="line-384"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span> <span class='hs-varid'>e</span> <span class='hs-varid'>c</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArrayElt</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArrayPtrs</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-385"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ArrayData</span> <span class='hs-varid'>e</span>
<a name="line-386"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>c</span>
<a name="line-387"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-388"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Weak</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-389"></a><span class='hs-definition'>makeWeakArrayData</span> <span class='hs-varid'>ad</span> <span class='hs-varid'>c</span> <span class='hs-varid'>mf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mw</span> <span class='hs-varid'>arrayElt</span> <span class='hs-varid'>ad</span>
<a name="line-390"></a>  <span class='hs-keyword'>where</span>
<a name="line-391"></a>    <span class='hs-varid'>mw</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArrayEltR</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArrayData</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Weak</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-392"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRint</span>     <span class='hs-layout'>(</span><span class='hs-conid'>AD_Int</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-393"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRint8</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AD_Int8</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-394"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRint16</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_Int16</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-395"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRint32</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_Int32</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-396"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRint64</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_Int64</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-397"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRword</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AD_Word</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-398"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRword8</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_Word8</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-399"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRword16</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_Word16</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-400"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRword32</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_Word32</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-401"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRword64</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_Word64</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-402"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcshort</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CShort</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-403"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcushort</span> <span class='hs-layout'>(</span><span class='hs-conid'>AD_CUShort</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-404"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcint</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AD_CInt</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-405"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcuint</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_CUInt</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-406"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRclong</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_CLong</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-407"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRculong</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CULong</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-408"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcllong</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CLLong</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-409"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcullong</span> <span class='hs-layout'>(</span><span class='hs-conid'>AD_CULLong</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-410"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRfloat</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_Float</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-411"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRdouble</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_Double</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-412"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcfloat</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CFloat</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-413"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcdouble</span> <span class='hs-layout'>(</span><span class='hs-conid'>AD_CDouble</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-414"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRbool</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AD_Bool</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-415"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRchar</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AD_Char</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-416"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcchar</span>   <span class='hs-layout'>(</span><span class='hs-conid'>AD_CChar</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-417"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcschar</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CSChar</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-418"></a>    <span class='hs-varid'>mw</span> <span class='hs-conid'>ArrayEltRcuchar</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AD_CUChar</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-varid'>mf</span>
<a name="line-419"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &lt; 800</span>
<a name="line-420"></a>    <span class='hs-varid'>mw</span> <span class='hs-keyword'>_</span>                <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Base eight is just like base ten really - if you're missing two fingers."</span>
<a name="line-421"></a><span class='hs-cpp'>#endif</span>
<a name="line-422"></a>
<a name="line-423"></a>    <span class='hs-varid'>mkWeak'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqueArray</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Weak</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-424"></a>    <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqueArrayData</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span>
<a name="line-425"></a>    <span class='hs-varid'>mkWeak'</span> <span class='hs-varid'>ua</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-426"></a>      <span class='hs-varid'>addFinalizer</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqueArrayData</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span>
<a name="line-427"></a>      <span class='hs-varid'>mkWeak</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqueArrayData</span> <span class='hs-varid'>ua</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span>
<a name="line-428"></a>
<a name="line-429"></a>
<a name="line-430"></a><span class='hs-comment'>-- Debug</span>
<a name="line-431"></a><span class='hs-comment'>-- -----</span>
<a name="line-432"></a>
<a name="line-433"></a><a name="showBytes"></a><span class='hs-comment'>{-# INLINE showBytes #-}</span>
<a name="line-434"></a><span class='hs-definition'>showBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Integral</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-435"></a><span class='hs-definition'>showBytes</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>D</span><span class='hs-varop'>.</span><span class='hs-varid'>showFFloatSIBase</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-num'>1024</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Double</span><span class='hs-layout'>)</span> <span class='hs-str'>"B"</span>
<a name="line-436"></a>
<a name="line-437"></a><a name="trace"></a><span class='hs-comment'>{-# INLINE trace #-}</span>
<a name="line-438"></a><span class='hs-definition'>trace</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-439"></a><span class='hs-definition'>trace</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>next</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>message</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>next</span>
<a name="line-440"></a>
<a name="line-441"></a><a name="message"></a><span class='hs-comment'>{-# INLINE message #-}</span>
<a name="line-442"></a><span class='hs-definition'>message</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-443"></a><span class='hs-definition'>message</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>D</span><span class='hs-varop'>.</span><span class='hs-varid'>traceIO</span> <span class='hs-conid'>D</span><span class='hs-varop'>.</span><span class='hs-varid'>dump_gc</span> <span class='hs-layout'>(</span><span class='hs-str'>"gc: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-444"></a>
<a name="line-445"></a><a name="management"></a><span class='hs-comment'>{-# INLINE management #-}</span>
<a name="line-446"></a><span class='hs-definition'>management</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>RemoteMemory</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nursery</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-447"></a><span class='hs-definition'>management</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>nrs</span> <span class='hs-varid'>next</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-448"></a>  <span class='hs-varid'>before</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>availableRemoteMem</span>
<a name="line-449"></a>  <span class='hs-varid'>before_nrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>N</span><span class='hs-varop'>.</span><span class='hs-varid'>size</span> <span class='hs-varid'>nrs</span>
<a name="line-450"></a>  <span class='hs-varid'>total</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>totalRemoteMem</span>
<a name="line-451"></a>  <span class='hs-varid'>r</span>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>next</span>
<a name="line-452"></a>  <span class='hs-conid'>D</span><span class='hs-varop'>.</span><span class='hs-varid'>when</span> <span class='hs-conid'>D</span><span class='hs-varop'>.</span><span class='hs-varid'>dump_gc</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-453"></a>    <span class='hs-varid'>after</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>availableRemoteMem</span>
<a name="line-454"></a>    <span class='hs-varid'>after_nrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>N</span><span class='hs-varop'>.</span><span class='hs-varid'>size</span> <span class='hs-varid'>nrs</span>
<a name="line-455"></a>    <span class='hs-varid'>message</span> <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>++</span> <span class='hs-str'>" (freed: "</span>     <span class='hs-varop'>++</span> <span class='hs-varid'>showBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>after</span> <span class='hs-comment'>-</span> <span class='hs-varid'>before</span><span class='hs-layout'>)</span>
<a name="line-456"></a>                  <span class='hs-varop'>++</span> <span class='hs-str'>", stashed: "</span>   <span class='hs-varop'>++</span> <span class='hs-varid'>showBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>before_nrs</span> <span class='hs-comment'>-</span> <span class='hs-varid'>after_nrs</span><span class='hs-layout'>)</span>
<a name="line-457"></a>                  <span class='hs-varop'>++</span> <span class='hs-str'>", remaining: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showBytes</span> <span class='hs-varid'>after</span>
<a name="line-458"></a>                  <span class='hs-varop'>++</span> <span class='hs-str'>" of "</span>          <span class='hs-varop'>++</span> <span class='hs-varid'>showBytes</span> <span class='hs-varid'>total</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span>
<a name="line-459"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-460"></a>
</pre></body>
</html>
